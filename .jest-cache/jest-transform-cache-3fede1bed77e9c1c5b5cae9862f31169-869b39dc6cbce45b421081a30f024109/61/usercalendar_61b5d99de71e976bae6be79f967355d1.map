{"file":"/home/runner/workspace/client/src/components/common-spaces/user-calendar.tsx","mappings":"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","names":[],"sources":["/home/runner/workspace/client/src/components/common-spaces/user-calendar.tsx"],"sourcesContent":["import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { format, addDays, parseISO } from 'date-fns';\nimport { fr } from 'date-fns/locale';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport { Calendar as CalendarIcon, Clock, MapPin, Download, Building2, User } from 'lucide-react';\nimport { CalendarView } from './calendar-view';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useLanguage } from '@/hooks/use-language';\nimport { useAuth } from '@/hooks/use-auth';\n\n/**\n *\n */\ninterface UserBooking {\n  id: string;\n  startTime: string;\n  endTime: string;\n  status: 'confirmed' | 'cancelled';\n  spaceName: string;\n  spaceId: string;\n  buildingName: string;\n  buildingId: string;\n}\n\n/**\n *\n */\ninterface UserCalendarData {\n  user: {\n    id: string;\n    name: string;\n    role: string;\n  };\n  calendar: {\n    view: string;\n    startDate: string;\n    endDate: string;\n    bookings: UserBooking[];\n  };\n  summary: {\n    totalBookings: number;\n    totalHours: number;\n  };\n}\n\n/**\n *\n */\nexport function UserCalendar() {\n  const { t, language } = useLanguage();\n  const { user } = useAuth();\n  const [selectedBooking, setSelectedBooking] = useState<UserBooking | null>(null);\n\n  const handleEventClick = (event: any) => {\n    // Find the full booking details\n    const booking = event as UserBooking;\n    setSelectedBooking(booking);\n  };\n\n  const generateICSContent = (bookings: UserBooking[]) => {\n    const icsEvents = bookings\n      .map((booking) => {\n        const start = parseISO(booking.startTime);\n        const end = parseISO(booking.endTime);\n        const formatDate = (date: Date) => format(date, \"yyyyMMdd'T'HHmmss'Z'\");\n\n        return [\n          'BEGIN:VEVENT',\n          `UID:${booking.id}@koveo-gestion.com`,\n          `DTSTART:${formatDate(start)}`,\n          `DTEND:${formatDate(end)}`,\n          `SUMMARY:${booking.spaceName} - ${booking.buildingName}`,\n          `LOCATION:${booking.buildingName}`,\n          `DESCRIPTION:Réservation d'espace commun`,\n          'STATUS:CONFIRMED',\n          'END:VEVENT',\n        ].join('\\n');\n      })\n      .join('\\n');\n\n    return [\n      'BEGIN:VCALENDAR',\n      'VERSION:2.0',\n      'PRODID:-//Koveo Gestion//Common Spaces Calendar//FR',\n      'CALSCALE:GREGORIAN',\n      icsEvents,\n      'END:VCALENDAR',\n    ].join('\\n');\n  };\n\n  const downloadCalendar = async () => {\n    try {\n      const startDate = new Date();\n      startDate.setMonth(startDate.getMonth() - 1);\n      const endDate = new Date();\n      endDate.setMonth(endDate.getMonth() + 3);\n\n      const params = new URLSearchParams({\n        start_date: startDate.toISOString(),\n        end_date: endDate.toISOString(),\n        view: 'month',\n      });\n\n      const response = await apiRequest('GET', `/api/common-spaces/user-calendar?${params}`);\n      const data: UserCalendarData = await response.json();\n      const icsContent = generateICSContent(data.calendar.bookings);\n\n      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `mes-reservations-${format(new Date(), 'yyyy-MM-dd')}.ics`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      // Error downloading calendar\n    }\n  };\n\n  if (!user) {\n    return (\n      <Card>\n        <CardContent className='p-6'>\n          <div className='text-center text-muted-foreground'>\n            {language === 'fr' ? 'Connexion requise' : 'Login required'}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className='space-y-6' data-testid='user-calendar-container'>\n      {/* Header with user info and actions */}\n      <div className='flex items-center justify-between'>\n        <div>\n          <h1 className='text-2xl font-bold flex items-center gap-2'>\n            <CalendarIcon className='h-6 w-6' />\n            {language === 'fr' ? 'Mon Calendrier' : 'My Calendar'}\n          </h1>\n          <p className='text-muted-foreground'>\n            {language === 'fr'\n              ? \"Consultez et gérez vos réservations d'espaces communs\"\n              : 'View and manage your common space bookings'}\n          </p>\n        </div>\n\n        <div className='flex items-center gap-2'>\n          <Button\n            variant='outline'\n            onClick={downloadCalendar}\n            className='flex items-center gap-2'\n            data-testid='download-calendar-btn'\n          >\n            <Download className='h-4 w-4' />\n            {language === 'fr' ? 'Télécharger (.ics)' : 'Download (.ics)'}\n          </Button>\n        </div>\n      </div>\n\n      {/* Main Calendar View */}\n      <CalendarView\n        mode='user'\n        onEventClick={handleEventClick}\n        showControls={true}\n        className='col-span-2'\n      />\n\n      {/* Selected Booking Details */}\n      {selectedBooking && (\n        <Card data-testid='selected-booking-details'>\n          <CardHeader>\n            <CardTitle className='flex items-center gap-2'>\n              <User className='h-5 w-5' />\n              {language === 'fr' ? 'Détails de la Réservation' : 'Booking Details'}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className='space-y-4'>\n            <div className='grid grid-cols-1 md:grid-cols-2 gap-4'>\n              <div className='space-y-2'>\n                <div className='flex items-center gap-2'>\n                  <Building2 className='h-4 w-4 text-muted-foreground' />\n                  <span className='font-medium'>{selectedBooking.spaceName}</span>\n                </div>\n                <div className='flex items-center gap-2'>\n                  <MapPin className='h-4 w-4 text-muted-foreground' />\n                  <span className='text-sm text-muted-foreground'>\n                    {selectedBooking.buildingName}\n                  </span>\n                </div>\n              </div>\n\n              <div className='space-y-2'>\n                <div className='flex items-center gap-2'>\n                  <Clock className='h-4 w-4 text-muted-foreground' />\n                  <span className='text-sm'>\n                    {format(parseISO(selectedBooking.startTime), 'dd/MM/yyyy', {\n                      locale: language === 'fr' ? fr : undefined,\n                    })}\n                  </span>\n                </div>\n                <div className='flex items-center gap-2 text-sm text-muted-foreground'>\n                  <span>\n                    {format(parseISO(selectedBooking.startTime), 'HH:mm', {\n                      locale: language === 'fr' ? fr : undefined,\n                    })}{' '}\n                    -\n                    {format(parseISO(selectedBooking.endTime), 'HH:mm', {\n                      locale: language === 'fr' ? fr : undefined,\n                    })}\n                  </span>\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            <div className='flex items-center justify-between'>\n              <Badge\n                variant={selectedBooking.status === 'confirmed' ? 'default' : 'secondary'}\n                data-testid='booking-status-badge'\n              >\n                {selectedBooking.status === 'confirmed'\n                  ? language === 'fr'\n                    ? 'Confirmé'\n                    : 'Confirmed'\n                  : language === 'fr'\n                    ? 'Annulé'\n                    : 'Cancelled'}\n              </Badge>\n\n              <Button\n                variant='outline'\n                size='sm'\n                onClick={() => setSelectedBooking(null)}\n                data-testid='close-details-btn'\n              >\n                {language === 'fr' ? 'Fermer' : 'Close'}\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n"],"version":3}