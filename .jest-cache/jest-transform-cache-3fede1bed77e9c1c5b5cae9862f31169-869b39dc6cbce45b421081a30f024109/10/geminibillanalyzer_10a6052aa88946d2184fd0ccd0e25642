cc47aff3f68b30346f5b58b60d89b5d2
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.geminiBillAnalyzer = exports.GeminiBillAnalyzer = void 0;
const fs = __importStar(require("fs"));
const genai_1 = require("@google/genai");
// DON'T DELETE THIS COMMENT
// Follow these instructions when using this blueprint:
// - Note that the newest Gemini model series is "gemini-2.5-flash" or gemini-2.5-pro"
//   - do not change this unless explicitly requested by the user
// This API key is from Gemini Developer API Key, not vertex AI API Key
const ai = new genai_1.GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || '' });
/**
 *
 */
class GeminiBillAnalyzer {
    /**
     * Analyze a bill document using Gemini 2.5 Pro.
     * @param filePath
     * @param mimeType
     */
    async analyzeBillDocument(filePath, mimeType) {
        try {
            const fileBytes = fs.readFileSync(filePath);
            // Detect MIME type if not provided  
            const detectedMimeType = mimeType || this.detectMimeType(filePath);
            const systemPrompt = `You are an expert bill analysis AI. Analyze this bill/invoice document and extract key information.
      
      Extract the following information and respond with JSON in this exact format:
      {
        "title": "Brief descriptive title for this bill",
        "vendor": "Company or service provider name",
        "totalAmount": "Total amount as decimal string (e.g., '1234.56')",
        "category": "One of: insurance, maintenance, salary, utilities, cleaning, security, landscaping, professional_services, administration, repairs, supplies, taxes, technology, reserves, other",
        "description": "Brief description of services/products",
        "dueDate": "Due date in YYYY-MM-DD format if found",
        "issueDate": "Issue date in YYYY-MM-DD format if found", 
        "billNumber": "Bill/invoice number if found",
        "confidence": 0.85
      }
      
      Guidelines:
      - Use clear, concise titles (e.g., "Hydro-Québec Electricity Bill", "Property Insurance Premium")
      - Map categories intelligently (electricity = utilities, legal fees = professional_services, etc.)
      - Extract exact amounts without currency symbols
      - Confidence should reflect how clear the document is (0.0-1.0)
      - If information is unclear, use best guess but lower confidence
      
      **IMPORTANT: Your response MUST be a raw JSON object only, without any Markdown formatting, backticks, or explanatory text. Do not wrap the JSON in triple backticks or any other non-JSON characters.**`;
            const response = await ai.models.generateContent({
                model: 'gemini-1.5-flash',
                contents: [
                    {
                        role: 'user',
                        parts: [
                            { text: systemPrompt },
                            {
                                inlineData: {
                                    mimeType: detectedMimeType,
                                    data: fileBytes.toString('base64')
                                }
                            }
                        ]
                    }
                ]
            });
            const rawJson = response.text;
            if (rawJson) {
                // Sanitize the response by removing markdown code blocks
                const sanitizedJson = this.sanitizeJsonResponse(rawJson);
                let analysis;
                try {
                    analysis = JSON.parse(sanitizedJson);
                }
                catch (parseError) {
                    console.error('JSON parsing failed for AI response:', parseError);
                    throw new Error('Failed to parse AI response as JSON');
                }
                // Validate and sanitize the results
                analysis.confidence = Math.max(0, Math.min(1, analysis.confidence));
                analysis.totalAmount = this.sanitizeAmount(analysis.totalAmount);
                return analysis;
            }
            else {
                throw new Error('Empty response from Gemini');
            }
        }
        catch (error) {
            console.error('Error analyzing bill document:', error);
            throw new Error(`Failed to analyze bill document: ${error}`);
        }
    }
    /**
     * Sanitize JSON response by removing markdown code blocks and whitespace.
     * @param rawResponse The raw response from the AI
     * @returns Clean JSON string
     */
    sanitizeJsonResponse(rawResponse) {
        if (!rawResponse) {
            return rawResponse;
        }
        // Remove markdown code blocks (```json and ```)
        let cleaned = rawResponse
            .replace(/```json\s*/gi, '') // Remove opening ```json with optional whitespace
            .replace(/```\s*$/g, '') // Remove closing ``` at end with optional whitespace
            .replace(/^```\s*/g, '') // Remove opening ``` at start with optional whitespace
            .trim(); // Remove leading/trailing whitespace
        return cleaned;
    }
    /**
     * Detect MIME type from file path.
     * @param filePath
     */
    detectMimeType(filePath) {
        const extension = filePath.toLowerCase().split('.').pop();
        switch (extension) {
            case 'pdf':
                return 'application/pdf';
            case 'jpg':
            case 'jpeg':
                return 'image/jpeg';
            case 'png':
                return 'image/png';
            case 'gif':
                return 'image/gif';
            case 'webp':
                return 'image/webp';
            default:
                // Default to PDF since that's what we're trying to support
                return 'application/pdf';
        }
    }
    /**
     * Sanitize and validate amount string.
     * @param amount
     */
    sanitizeAmount(amount) {
        // Remove currency symbols and spaces
        const cleaned = amount.replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        if (isNaN(parsed)) {
            return '0.00';
        }
        return parsed.toFixed(2);
    }
    /**
     * Get suggested payment schedule based on bill type and amount.
     * @param category
     * @param amount
     */
    async suggestPaymentSchedule(category, amount) {
        try {
            const prompt = `Based on this bill category "${category}" and amount $${amount}, suggest the most appropriate payment schedule.
      
      Common patterns:
      - Utilities: Usually monthly recurring
      - Insurance: Usually yearly recurring  
      - Maintenance: Usually unique payments
      - Professional services: Usually unique payments
      - Supplies: Usually unique payments
      - Taxes: Usually yearly recurring
      
      Respond with JSON:
      {
        "paymentType": "unique" or "recurrent",
        "schedulePayment": "monthly", "quarterly", or "yearly" (only if recurrent),
        "reasoning": "Brief explanation of the recommendation"
      }`;
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                config: {
                    responseMimeType: 'application/json',
                    responseSchema: {
                        type: 'object',
                        properties: {
                            paymentType: { type: 'string', enum: ['unique', 'recurrent'] },
                            schedulePayment: { type: 'string', enum: ['monthly', 'quarterly', 'yearly'] },
                            reasoning: { type: 'string' },
                        },
                        required: ['paymentType', 'reasoning'],
                    },
                },
                contents: prompt,
            });
            const result = JSON.parse(response.text || '{}');
            return result;
        }
        catch (error) {
            console.error('❌ Error suggesting payment schedule:', error);
            return {
                paymentType: 'unique',
                reasoning: 'Default to unique payment due to analysis error',
            };
        }
    }
}
exports.GeminiBillAnalyzer = GeminiBillAnalyzer;
exports.geminiBillAnalyzer = new GeminiBillAnalyzer();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvZ2VtaW5pLWJpbGwtYW5hbHl6ZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLHlDQUE0QztBQUU1Qyw0QkFBNEI7QUFDNUIsdURBQXVEO0FBQ3ZELHNGQUFzRjtBQUN0RixpRUFBaUU7QUFFakUsdUVBQXVFO0FBQ3ZFLE1BQU0sRUFBRSxHQUFHLElBQUksbUJBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBaUJ6RTs7R0FFRztBQUNILE1BQWEsa0JBQWtCO0lBQzdCOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxRQUFpQjtRQUMzRCxJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTVDLHFDQUFxQztZQUNyQyxNQUFNLGdCQUFnQixHQUFHLFFBQVEsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRW5FLE1BQU0sWUFBWSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OytNQXNCb0wsQ0FBQztZQUUxTSxNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO2dCQUMvQyxLQUFLLEVBQUUsa0JBQWtCO2dCQUN6QixRQUFRLEVBQUU7b0JBQ1I7d0JBQ0UsSUFBSSxFQUFFLE1BQU07d0JBQ1osS0FBSyxFQUFFOzRCQUNMLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRTs0QkFDdEI7Z0NBQ0UsVUFBVSxFQUFFO29DQUNWLFFBQVEsRUFBRSxnQkFBZ0I7b0NBQzFCLElBQUksRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztpQ0FDbkM7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJB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RUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxPQUFPO2dCQUNMLFdBQVcsRUFBRSxRQUFRO2dCQUNyQixTQUFTLEVBQUUsaURBQWlEO2FBQzdELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBM01ELGdEQTJNQztBQUVZLFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL3NlcnZpY2VzL2dlbWluaS1iaWxsLWFuYWx5emVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEdvb2dsZUdlbkFJIH0gZnJvbSAnQGdvb2dsZS9nZW5haSc7XG5cbi8vIERPTidUIERFTEVURSBUSElTIENPTU1FTlRcbi8vIEZvbGxvdyB0aGVzZSBpbnN0cnVjdGlvbnMgd2hlbiB1c2luZyB0aGlzIGJsdWVwcmludDpcbi8vIC0gTm90ZSB0aGF0IHRoZSBuZXdlc3QgR2VtaW5pIG1vZGVsIHNlcmllcyBpcyBcImdlbWluaS0yLjUtZmxhc2hcIiBvciBnZW1pbmktMi41LXByb1wiXG4vLyAgIC0gZG8gbm90IGNoYW5nZSB0aGlzIHVubGVzcyBleHBsaWNpdGx5IHJlcXVlc3RlZCBieSB0aGUgdXNlclxuXG4vLyBUaGlzIEFQSSBrZXkgaXMgZnJvbSBHZW1pbmkgRGV2ZWxvcGVyIEFQSSBLZXksIG5vdCB2ZXJ0ZXggQUkgQVBJIEtleVxuY29uc3QgYWkgPSBuZXcgR29vZ2xlR2VuQUkoeyBhcGlLZXk6IHByb2Nlc3MuZW52LkdFTUlOSV9BUElfS0VZIHx8ICcnIH0pO1xuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmlsbEFuYWx5c2lzUmVzdWx0IHtcbiAgdGl0bGU6IHN0cmluZztcbiAgdmVuZG9yOiBzdHJpbmc7XG4gIHRvdGFsQW1vdW50OiBzdHJpbmc7XG4gIGNhdGVnb3J5OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBkdWVEYXRlPzogc3RyaW5nO1xuICBpc3N1ZURhdGU/OiBzdHJpbmc7XG4gIGJpbGxOdW1iZXI/OiBzdHJpbmc7XG4gIGNvbmZpZGVuY2U6IG51bWJlcjtcbn1cblxuLyoqXG4gKlxuICovXG5leHBvcnQgY2xhc3MgR2VtaW5pQmlsbEFuYWx5emVyIHtcbiAgLyoqXG4gICAqIEFuYWx5emUgYSBiaWxsIGRvY3VtZW50IHVzaW5nIEdlbWluaSAyLjUgUHJvLlxuICAgKiBAcGFyYW0gZmlsZVBhdGhcbiAgICogQHBhcmFtIG1pbWVUeXBlIFxuICAgKi9cbiAgYXN5bmMgYW5hbHl6ZUJpbGxEb2N1bWVudChmaWxlUGF0aDogc3RyaW5nLCBtaW1lVHlwZT86IHN0cmluZyk6IFByb21pc2U8QmlsbEFuYWx5c2lzUmVzdWx0PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVCeXRlcyA9IGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCk7XG4gICAgICBcbiAgICAgIC8vIERldGVjdCBNSU1FIHR5cGUgaWYgbm90IHByb3ZpZGVkICBcbiAgICAgIGNvbnN0IGRldGVjdGVkTWltZVR5cGUgPSBtaW1lVHlwZSB8fCB0aGlzLmRldGVjdE1pbWVUeXBlKGZpbGVQYXRoKTtcblxuICAgICAgY29uc3Qgc3lzdGVtUHJvbXB0ID0gYFlvdSBhcmUgYW4gZXhwZXJ0IGJpbGwgYW5hbHlzaXMgQUkuIEFuYWx5emUgdGhpcyBiaWxsL2ludm9pY2UgZG9jdW1lbnQgYW5kIGV4dHJhY3Qga2V5IGluZm9ybWF0aW9uLlxuICAgICAgXG4gICAgICBFeHRyYWN0IHRoZSBmb2xsb3dpbmcgaW5mb3JtYXRpb24gYW5kIHJlc3BvbmQgd2l0aCBKU09OIGluIHRoaXMgZXhhY3QgZm9ybWF0OlxuICAgICAge1xuICAgICAgICBcInRpdGxlXCI6IFwiQnJpZWYgZGVzY3JpcHRpdmUgdGl0bGUgZm9yIHRoaXMgYmlsbFwiLFxuICAgICAgICBcInZlbmRvclwiOiBcIkNvbXBhbnkgb3Igc2VydmljZSBwcm92aWRlciBuYW1lXCIsXG4gICAgICAgIFwidG90YWxBbW91bnRcIjogXCJUb3RhbCBhbW91bnQgYXMgZGVjaW1hbCBzdHJpbmcgKGUuZy4sICcxMjM0LjU2JylcIixcbiAgICAgICAgXCJjYXRlZ29yeVwiOiBcIk9uZSBvZjogaW5zdXJhbmNlLCBtYWludGVuYW5jZSwgc2FsYXJ5LCB1dGlsaXRpZXMsIGNsZWFuaW5nLCBzZWN1cml0eSwgbGFuZHNjYXBpbmcsIHByb2Zlc3Npb25hbF9zZXJ2aWNlcywgYWRtaW5pc3RyYXRpb24sIHJlcGFpcnMsIHN1cHBsaWVzLCB0YXhlcywgdGVjaG5vbG9neSwgcmVzZXJ2ZXMsIG90aGVyXCIsXG4gICAgICAgIFwiZGVzY3JpcHRpb25cIjogXCJCcmllZiBkZXNjcmlwdGlvbiBvZiBzZXJ2aWNlcy9wcm9kdWN0c1wiLFxuICAgICAgICBcImR1ZURhdGVcIjogXCJEdWUgZGF0ZSBpbiBZWVlZLU1NLUREIGZvcm1hdCBpZiBmb3VuZFwiLFxuICAgICAgICBcImlzc3VlRGF0ZVwiOiBcIklzc3VlIGRhdGUgaW4gWVlZWS1NTS1ERCBmb3JtYXQgaWYgZm91bmRcIiwgXG4gICAgICAgIFwiYmlsbE51bWJlclwiOiBcIkJpbGwvaW52b2ljZSBudW1iZXIgaWYgZm91bmRcIixcbiAgICAgICAgXCJjb25maWRlbmNlXCI6IDAuODVcbiAgICAgIH1cbiAgICAgIFxuICAgICAgR3VpZGVsaW5lczpcbiAgICAgIC0gVXNlIGNsZWFyLCBjb25jaXNlIHRpdGxlcyAoZS5nLiwgXCJIeWRyby1RdcOpYmVjIEVsZWN0cmljaXR5IEJpbGxcIiwgXCJQcm9wZXJ0eSBJbnN1cmFuY2UgUHJlbWl1bVwiKVxuICAgICAgLSBNYXAgY2F0ZWdvcmllcyBpbnRlbGxpZ2VudGx5IChlbGVjdHJpY2l0eSA9IHV0aWxpdGllcywgbGVnYWwgZmVlcyA9IHByb2Zlc3Npb25hbF9zZXJ2aWNlcywgZXRjLilcbiAgICAgIC0gRXh0cmFjdCBleGFjdCBhbW91bnRzIHdpdGhvdXQgY3VycmVuY3kgc3ltYm9sc1xuICAgICAgLSBDb25maWRlbmNlIHNob3VsZCByZWZsZWN0IGhvdyBjbGVhciB0aGUgZG9jdW1lbnQgaXMgKDAuMC0xLjApXG4gICAgICAtIElmIGluZm9ybWF0aW9uIGlzIHVuY2xlYXIsIHVzZSBiZXN0IGd1ZXNzIGJ1dCBsb3dlciBjb25maWRlbmNlXG4gICAgICBcbiAgICAgICoqSU1QT1JUQU5UOiBZb3VyIHJlc3BvbnNlIE1VU1QgYmUgYSByYXcgSlNPTiBvYmplY3Qgb25seSwgd2l0aG91dCBhbnkgTWFya2Rvd24gZm9ybWF0dGluZywgYmFja3RpY2tzLCBvciBleHBsYW5hdG9yeSB0ZXh0LiBEbyBub3Qgd3JhcCB0aGUgSlNPTiBpbiB0cmlwbGUgYmFja3RpY2tzIG9yIGFueSBvdGhlciBub24tSlNPTiBjaGFyYWN0ZXJzLioqYDtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhaS5tb2RlbHMuZ2VuZXJhdGVDb250ZW50KHtcbiAgICAgICAgbW9kZWw6ICdnZW1pbmktMS41LWZsYXNoJyxcbiAgICAgICAgY29udGVudHM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICByb2xlOiAndXNlcicsXG4gICAgICAgICAgICBwYXJ0czogW1xuICAgICAgICAgICAgICB7IHRleHQ6IHN5c3RlbVByb21wdCB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaW5saW5lRGF0YToge1xuICAgICAgICAgICAgICAgICAgbWltZVR5cGU6IGRldGVjdGVkTWltZVR5cGUsXG4gICAgICAgICAgICAgICAgICBkYXRhOiBmaWxlQnl0ZXMudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmF3SnNvbiA9IHJlc3BvbnNlLnRleHQ7XG5cbiAgICAgIGlmIChyYXdKc29uKSB7XG4gICAgICAgIC8vIFNhbml0aXplIHRoZSByZXNwb25zZSBieSByZW1vdmluZyBtYXJrZG93biBjb2RlIGJsb2Nrc1xuICAgICAgICBjb25zdCBzYW5pdGl6ZWRKc29uID0gdGhpcy5zYW5pdGl6ZUpzb25SZXNwb25zZShyYXdKc29uKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBhbmFseXNpczogQmlsbEFuYWx5c2lzUmVzdWx0O1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhbmFseXNpcyA9IEpTT04ucGFyc2Uoc2FuaXRpemVkSnNvbik7XG4gICAgICAgIH0gY2F0Y2ggKHBhcnNlRXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdKU09OIHBhcnNpbmcgZmFpbGVkIGZvciBBSSByZXNwb25zZTonLCBwYXJzZUVycm9yKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBBSSByZXNwb25zZSBhcyBKU09OJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWxpZGF0ZSBhbmQgc2FuaXRpemUgdGhlIHJlc3VsdHNcbiAgICAgICAgYW5hbHlzaXMuY29uZmlkZW5jZSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGFuYWx5c2lzLmNvbmZpZGVuY2UpKTtcbiAgICAgICAgYW5hbHlzaXMudG90YWxBbW91bnQgPSB0aGlzLnNhbml0aXplQW1vdW50KGFuYWx5c2lzLnRvdGFsQW1vdW50KTtcblxuICAgICAgICByZXR1cm4gYW5hbHlzaXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtcHR5IHJlc3BvbnNlIGZyb20gR2VtaW5pJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYW5hbHl6aW5nIGJpbGwgZG9jdW1lbnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gYW5hbHl6ZSBiaWxsIGRvY3VtZW50OiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTYW5pdGl6ZSBKU09OIHJlc3BvbnNlIGJ5IHJlbW92aW5nIG1hcmtkb3duIGNvZGUgYmxvY2tzIGFuZCB3aGl0ZXNwYWNlLlxuICAgKiBAcGFyYW0gcmF3UmVzcG9uc2UgVGhlIHJhdyByZXNwb25zZSBmcm9tIHRoZSBBSVxuICAgKiBAcmV0dXJucyBDbGVhbiBKU09OIHN0cmluZ1xuICAgKi9cbiAgcHJpdmF0ZSBzYW5pdGl6ZUpzb25SZXNwb25zZShyYXdSZXNwb25zZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIXJhd1Jlc3BvbnNlKSB7XG4gICAgICByZXR1cm4gcmF3UmVzcG9uc2U7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIG1hcmtkb3duIGNvZGUgYmxvY2tzIChgYGBqc29uIGFuZCBgYGApXG4gICAgbGV0IGNsZWFuZWQgPSByYXdSZXNwb25zZVxuICAgICAgLnJlcGxhY2UoL2BgYGpzb25cXHMqL2dpLCAnJykgLy8gUmVtb3ZlIG9wZW5pbmcgYGBganNvbiB3aXRoIG9wdGlvbmFsIHdoaXRlc3BhY2VcbiAgICAgIC5yZXBsYWNlKC9gYGBcXHMqJC9nLCAnJykgLy8gUmVtb3ZlIGNsb3NpbmcgYGBgIGF0IGVuZCB3aXRoIG9wdGlvbmFsIHdoaXRlc3BhY2VcbiAgICAgIC5yZXBsYWNlKC9eYGBgXFxzKi9nLCAnJykgLy8gUmVtb3ZlIG9wZW5pbmcgYGBgIGF0IHN0YXJ0IHdpdGggb3B0aW9uYWwgd2hpdGVzcGFjZVxuICAgICAgLnRyaW0oKTsgLy8gUmVtb3ZlIGxlYWRpbmcvdHJhaWxpbmcgd2hpdGVzcGFjZVxuXG4gICAgcmV0dXJuIGNsZWFuZWQ7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IE1JTUUgdHlwZSBmcm9tIGZpbGUgcGF0aC5cbiAgICogQHBhcmFtIGZpbGVQYXRoXG4gICAqL1xuICBwcml2YXRlIGRldGVjdE1pbWVUeXBlKGZpbGVQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IGZpbGVQYXRoLnRvTG93ZXJDYXNlKCkuc3BsaXQoJy4nKS5wb3AoKTtcbiAgICBcbiAgICBzd2l0Y2ggKGV4dGVuc2lvbikge1xuICAgICAgY2FzZSAncGRmJzpcbiAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbi9wZGYnO1xuICAgICAgY2FzZSAnanBnJzpcbiAgICAgIGNhc2UgJ2pwZWcnOlxuICAgICAgICByZXR1cm4gJ2ltYWdlL2pwZWcnO1xuICAgICAgY2FzZSAncG5nJzpcbiAgICAgICAgcmV0dXJuICdpbWFnZS9wbmcnO1xuICAgICAgY2FzZSAnZ2lmJzpcbiAgICAgICAgcmV0dXJuICdpbWFnZS9naWYnO1xuICAgICAgY2FzZSAnd2VicCc6XG4gICAgICAgIHJldHVybiAnaW1hZ2Uvd2VicCc7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICAvLyBEZWZhdWx0IHRvIFBERiBzaW5jZSB0aGF0J3Mgd2hhdCB3ZSdyZSB0cnlpbmcgdG8gc3VwcG9ydFxuICAgICAgICByZXR1cm4gJ2FwcGxpY2F0aW9uL3BkZic7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNhbml0aXplIGFuZCB2YWxpZGF0ZSBhbW91bnQgc3RyaW5nLlxuICAgKiBAcGFyYW0gYW1vdW50XG4gICAqL1xuICBwcml2YXRlIHNhbml0aXplQW1vdW50KGFtb3VudDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBSZW1vdmUgY3VycmVuY3kgc3ltYm9scyBhbmQgc3BhY2VzXG4gICAgY29uc3QgY2xlYW5lZCA9IGFtb3VudC5yZXBsYWNlKC9bXjAtOS4tXS9nLCAnJyk7XG4gICAgY29uc3QgcGFyc2VkID0gcGFyc2VGbG9hdChjbGVhbmVkKTtcblxuICAgIGlmIChpc05hTihwYXJzZWQpKSB7XG4gICAgICByZXR1cm4gJzAuMDAnO1xuICAgIH1cblxuICAgIHJldHVybiBwYXJzZWQudG9GaXhlZCgyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc3VnZ2VzdGVkIHBheW1lbnQgc2NoZWR1bGUgYmFzZWQgb24gYmlsbCB0eXBlIGFuZCBhbW91bnQuXG4gICAqIEBwYXJhbSBjYXRlZ29yeVxuICAgKiBAcGFyYW0gYW1vdW50XG4gICAqL1xuICBhc3luYyBzdWdnZXN0UGF5bWVudFNjaGVkdWxlKFxuICAgIGNhdGVnb3J5OiBzdHJpbmcsXG4gICAgYW1vdW50OiBudW1iZXJcbiAgKTogUHJvbWlzZTx7XG4gICAgcGF5bWVudFR5cGU6ICd1bmlxdWUnIHwgJ3JlY3VycmVudCc7XG4gICAgc2NoZWR1bGVQYXltZW50PzogJ21vbnRobHknIHwgJ3F1YXJ0ZXJseScgfCAneWVhcmx5JztcbiAgICByZWFzb25pbmc6IHN0cmluZztcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcm9tcHQgPSBgQmFzZWQgb24gdGhpcyBiaWxsIGNhdGVnb3J5IFwiJHtjYXRlZ29yeX1cIiBhbmQgYW1vdW50ICQke2Ftb3VudH0sIHN1Z2dlc3QgdGhlIG1vc3QgYXBwcm9wcmlhdGUgcGF5bWVudCBzY2hlZHVsZS5cbiAgICAgIFxuICAgICAgQ29tbW9uIHBhdHRlcm5zOlxuICAgICAgLSBVdGlsaXRpZXM6IFVzdWFsbHkgbW9udGhseSByZWN1cnJpbmdcbiAgICAgIC0gSW5zdXJhbmNlOiBVc3VhbGx5IHllYXJseSByZWN1cnJpbmcgIFxuICAgICAgLSBNYWludGVuYW5jZTogVXN1YWxseSB1bmlxdWUgcGF5bWVudHNcbiAgICAgIC0gUHJvZmVzc2lvbmFsIHNlcnZpY2VzOiBVc3VhbGx5IHVuaXF1ZSBwYXltZW50c1xuICAgICAgLSBTdXBwbGllczogVXN1YWxseSB1bmlxdWUgcGF5bWVudHNcbiAgICAgIC0gVGF4ZXM6IFVzdWFsbHkgeWVhcmx5IHJlY3VycmluZ1xuICAgICAgXG4gICAgICBSZXNwb25kIHdpdGggSlNPTjpcbiAgICAgIHtcbiAgICAgICAgXCJwYXltZW50VHlwZVwiOiBcInVuaXF1ZVwiIG9yIFwicmVjdXJyZW50XCIsXG4gICAgICAgIFwic2NoZWR1bGVQYXltZW50XCI6IFwibW9udGhseVwiLCBcInF1YXJ0ZXJseVwiLCBvciBcInllYXJseVwiIChvbmx5IGlmIHJlY3VycmVudCksXG4gICAgICAgIFwicmVhc29uaW5nXCI6IFwiQnJpZWYgZXhwbGFuYXRpb24gb2YgdGhlIHJlY29tbWVuZGF0aW9uXCJcbiAgICAgIH1gO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFpLm1vZGVscy5nZW5lcmF0ZUNvbnRlbnQoe1xuICAgICAgICBtb2RlbDogJ2dlbWluaS0yLjUtZmxhc2gnLFxuICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICByZXNwb25zZU1pbWVUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgcmVzcG9uc2VTY2hlbWE6IHtcbiAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICBwYXltZW50VHlwZTogeyB0eXBlOiAnc3RyaW5nJywgZW51bTogWyd1bmlxdWUnLCAncmVjdXJyZW50J10gfSxcbiAgICAgICAgICAgICAgc2NoZWR1bGVQYXltZW50OiB7IHR5cGU6ICdzdHJpbmcnLCBlbnVtOiBbJ21vbnRobHknLCAncXVhcnRlcmx5JywgJ3llYXJseSddIH0sXG4gICAgICAgICAgICAgIHJlYXNvbmluZzogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlcXVpcmVkOiBbJ3BheW1lbnRUeXBlJywgJ3JlYXNvbmluZyddLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRzOiBwcm9tcHQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZShyZXNwb25zZS50ZXh0IHx8ICd7fScpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3Igc3VnZ2VzdGluZyBwYXltZW50IHNjaGVkdWxlOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBheW1lbnRUeXBlOiAndW5pcXVlJyxcbiAgICAgICAgcmVhc29uaW5nOiAnRGVmYXVsdCB0byB1bmlxdWUgcGF5bWVudCBkdWUgdG8gYW5hbHlzaXMgZXJyb3InLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGdlbWluaUJpbGxBbmFseXplciA9IG5ldyBHZW1pbmlCaWxsQW5hbHl6ZXIoKTtcbiJdLCJ2ZXJzaW9uIjozfQ==