010de587a63dc8e5022ea0437201aa74
"use strict";
/**
 * Fast in-memory database mock for unit tests
 * Provides instant responses without network calls
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.mockSql = exports.mockSchemaObject = exports.mockDb = exports.createMockDatabase = void 0;
const createMockDatabase = () => {
    const mockData = new Map();
    return {
        // Mock query function that returns immediately
        query: jest.fn().mockImplementation(async (sql) => {
            // Return empty results for test queries
            if (sql.includes('SELECT version()')) {
                return [{ version: 'PostgreSQL 15.0 (Mock)' }];
            }
            return [];
        }),
        // Mock insert operations - proper Drizzle ORM structure
        insert: jest.fn().mockImplementation((table) => {
            const insertChain = {
                values: jest.fn().mockImplementation(async (data) => {
                    const id = Math.random().toString(36).substr(2, 9);
                    const result = Array.isArray(data)
                        ? data.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9) }))
                        : [{ ...data, id }];
                    mockData.set(id, data);
                    return result;
                }),
                returning: jest.fn().mockImplementation(async () => {
                    const id = Math.random().toString(36).substr(2, 9);
                    return [{ id }];
                })
            };
            // Create chainable methods that return properly structured objects
            const createValuesChain = (data) => {
                const id = Math.random().toString(36).substr(2, 9);
                const result = Array.isArray(data)
                    ? data.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9) }))
                    : [{ ...data, id }];
                mockData.set(id, data);
                return {
                    returning: jest.fn().mockImplementation(async () => result)
                };
            };
            insertChain.values = jest.fn().mockImplementation((data) => createValuesChain(data));
            insertChain.returning = jest.fn().mockImplementation(() => insertChain);
            return insertChain;
        }),
        // Mock select operations
        select: jest.fn().mockImplementation(() => ({
            from: jest.fn().mockImplementation(() => ({
                where: jest.fn().mockImplementation(() => ({
                    limit: jest.fn().mockImplementation(async () => []),
                    orderBy: jest.fn().mockImplementation(async () => []),
                })),
                leftJoin: jest.fn().mockImplementation(() => ({
                    where: jest.fn().mockImplementation(() => ({
                        limit: jest.fn().mockImplementation(async () => []),
                    })),
                })),
                innerJoin: jest.fn().mockImplementation(() => ({
                    where: jest.fn().mockImplementation(() => ({
                        limit: jest.fn().mockImplementation(async () => []),
                    })),
                })),
                limit: jest.fn().mockImplementation(async () => []),
                orderBy: jest.fn().mockImplementation(async () => []),
            })),
        })),
        // Mock delete operations - proper Drizzle ORM structure
        delete: jest.fn().mockImplementation((table) => ({
            where: jest.fn().mockImplementation(async () => {
                return Promise.resolve({ affectedRows: 0 });
            }),
        })),
        // Mock update operations
        update: jest.fn().mockImplementation((table) => ({
            set: jest.fn().mockImplementation(() => ({
                where: jest.fn().mockImplementation(async () => {
                    return Promise.resolve({ affectedRows: 0 });
                }),
            })),
        })),
    };
};
exports.createMockDatabase = createMockDatabase;
// Global mock instance
// Create the complete mock database with all Drizzle operations
exports.mockDb = (0, exports.createMockDatabase)();
// Create a mock table that looks like a Drizzle table with all necessary properties
const createMockTable = (tableName) => {
    return {
        // Table properties that Drizzle uses
        _: {
            name: tableName,
            schema: undefined,
            columns: {},
            baseName: tableName
        },
        // Mock column properties for common fields
        id: { name: 'id' },
        email: { name: 'email' },
        name: { name: 'name' },
        role: { name: 'role' },
        userId: { name: 'userId' },
        organizationId: { name: 'organizationId' },
        buildingId: { name: 'buildingId' },
        // Add any other commonly accessed column properties
    };
};
// Mock all the individual schema tables that tests import
exports.mockSchemaObject = {
    // Core tables
    users: createMockTable('users'),
    organizations: createMockTable('organizations'),
    userOrganizations: createMockTable('userOrganizations'),
    invitations: createMockTable('invitations'),
    passwordResetTokens: createMockTable('passwordResetTokens'),
    // Property tables  
    buildings: createMockTable('buildings'),
    residences: createMockTable('residences'),
    userResidences: createMockTable('userResidences'),
    // Document and financial tables
    documents: createMockTable('documents'),
    bills: createMockTable('bills'),
    budgets: createMockTable('budgets'),
    monthlyBudgets: createMockTable('monthlyBudgets'),
    // Operations tables
    maintenanceRequests: createMockTable('maintenanceRequests'),
    commonSpaces: createMockTable('commonSpaces'),
    // System tables
    permissions: createMockTable('permissions'),
    userPermissions: createMockTable('userPermissions'),
    rolePermissions: createMockTable('rolePermissions'),
    demands: createMockTable('demands')
};
// Mock SQL template function
exports.mockSql = jest.fn().mockImplementation(async (strings, ...values) => {
    const query = strings.join('?');
    if (query.includes('SELECT version()')) {
        return [{ version: 'PostgreSQL 15.0 (Mock)' }];
    }
    return [];
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q3BDLENBQUM7QUFFRiw2QkFBNkI7QUFDaEIsUUFBQSxPQUFPLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxPQUE2QixFQUFFLEdBQUcsTUFBYSxFQUFFLEVBQUU7SUFDNUcsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNELE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9tb2Nrcy9kYXRhYmFzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZhc3QgaW4tbWVtb3J5IGRhdGFiYXNlIG1vY2sgZm9yIHVuaXQgdGVzdHNcbiAqIFByb3ZpZGVzIGluc3RhbnQgcmVzcG9uc2VzIHdpdGhvdXQgbmV0d29yayBjYWxsc1xuICovXG5cbmV4cG9ydCBjb25zdCBjcmVhdGVNb2NrRGF0YWJhc2UgPSAoKSA9PiB7XG4gIGNvbnN0IG1vY2tEYXRhID0gbmV3IE1hcCgpO1xuICBcbiAgcmV0dXJuIHtcbiAgICAvLyBNb2NrIHF1ZXJ5IGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpbW1lZGlhdGVseVxuICAgIHF1ZXJ5OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChzcWw6IHN0cmluZykgPT4ge1xuICAgICAgLy8gUmV0dXJuIGVtcHR5IHJlc3VsdHMgZm9yIHRlc3QgcXVlcmllc1xuICAgICAgaWYgKHNxbC5pbmNsdWRlcygnU0VMRUNUIHZlcnNpb24oKScpKSB7XG4gICAgICAgIHJldHVybiBbeyB2ZXJzaW9uOiAnUG9zdGdyZVNRTCAxNS4wIChNb2NrKScgfV07XG4gICAgICB9XG4gICAgICByZXR1cm4gW107XG4gICAgfSksXG4gICAgXG4gICAgLy8gTW9jayBpbnNlcnQgb3BlcmF0aW9ucyAtIHByb3BlciBEcml6emxlIE9STSBzdHJ1Y3R1cmVcbiAgICBpbnNlcnQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRhYmxlOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGluc2VydENoYWluID0ge1xuICAgICAgICB2YWx1ZXM6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGlkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IEFycmF5LmlzQXJyYXkoZGF0YSkgXG4gICAgICAgICAgICA/IGRhdGEubWFwKGl0ZW0gPT4gKHsgLi4uaXRlbSwgaWQ6IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KSB9KSlcbiAgICAgICAgICAgIDogW3sgLi4uZGF0YSwgaWQgfV07XG4gICAgICAgICAgbW9ja0RhdGEuc2V0KGlkLCBkYXRhKTtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KSxcbiAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCBpZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTtcbiAgICAgICAgICByZXR1cm4gW3sgaWQgfV07XG4gICAgICAgIH0pXG4gICAgICB9O1xuICAgICAgXG4gICAgICAvLyBDcmVhdGUgY2hhaW5hYmxlIG1ldGhvZHMgdGhhdCByZXR1cm4gcHJvcGVybHkgc3RydWN0dXJlZCBvYmplY3RzXG4gICAgICBjb25zdCBjcmVhdGVWYWx1ZXNDaGFpbiA9IChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgaWQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEFycmF5LmlzQXJyYXkoZGF0YSkgXG4gICAgICAgICAgPyBkYXRhLm1hcChpdGVtID0+ICh7IC4uLml0ZW0sIGlkOiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSkgfSkpXG4gICAgICAgICAgOiBbeyAuLi5kYXRhLCBpZCB9XTtcbiAgICAgICAgbW9ja0RhdGEuc2V0KGlkLCBkYXRhKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHJlc3VsdClcbiAgICAgICAgfTtcbiAgICAgIH07XG4gICAgICBcbiAgICAgIGluc2VydENoYWluLnZhbHVlcyA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGRhdGE6IGFueSkgPT4gY3JlYXRlVmFsdWVzQ2hhaW4oZGF0YSkpO1xuICAgICAgaW5zZXJ0Q2hhaW4ucmV0dXJuaW5nID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBpbnNlcnRDaGFpbik7XG4gICAgICBcbiAgICAgIHJldHVybiBpbnNlcnRDaGFpbjtcbiAgICB9KSxcbiAgICBcbiAgICAvLyBNb2NrIHNlbGVjdCBvcGVyYXRpb25zXG4gICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICBmcm9tOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICAgIG9yZGVyQnk6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICB9KSksXG4gICAgICAgIGxlZnRKb2luOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgICAgICAgIGxpbWl0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pKSxcbiAgICAgICAgaW5uZXJKb2luOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgICAgICAgIGxpbWl0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pKSxcbiAgICAgICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICBvcmRlckJ5OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgIH0pKSxcbiAgICB9KSksXG4gICAgXG4gICAgLy8gTW9jayBkZWxldGUgb3BlcmF0aW9ucyAtIHByb3BlciBEcml6emxlIE9STSBzdHJ1Y3R1cmVcbiAgICBkZWxldGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRhYmxlOiBhbnkpID0+ICh7XG4gICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBhZmZlY3RlZFJvd3M6IDAgfSk7XG4gICAgICB9KSxcbiAgICB9KSksXG4gICAgXG4gICAgLy8gTW9jayB1cGRhdGUgb3BlcmF0aW9uc1xuICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigodGFibGU6IGFueSkgPT4gKHtcbiAgICAgIHNldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGFmZmVjdGVkUm93czogMCB9KTtcbiAgICAgICAgfSksXG4gICAgICB9KSksXG4gICAgfSkpLFxuICB9O1xufTtcblxuLy8gR2xvYmFsIG1vY2sgaW5zdGFuY2Vcbi8vIENyZWF0ZSB0aGUgY29tcGxldGUgbW9jayBkYXRhYmFzZSB3aXRoIGFsbCBEcml6emxlIG9wZXJhdGlvbnNcbmV4cG9ydCBjb25zdCBtb2NrRGIgPSBjcmVhdGVNb2NrRGF0YWJhc2UoKTtcblxuLy8gQ3JlYXRlIGEgbW9jayB0YWJsZSB0aGF0IGxvb2tzIGxpa2UgYSBEcml6emxlIHRhYmxlIHdpdGggYWxsIG5lY2Vzc2FyeSBwcm9wZXJ0aWVzXG5jb25zdCBjcmVhdGVNb2NrVGFibGUgPSAodGFibGVOYW1lOiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIHtcbiAgICAvLyBUYWJsZSBwcm9wZXJ0aWVzIHRoYXQgRHJpenpsZSB1c2VzXG4gICAgXzoge1xuICAgICAgbmFtZTogdGFibGVOYW1lLFxuICAgICAgc2NoZW1hOiB1bmRlZmluZWQsXG4gICAgICBjb2x1bW5zOiB7fSxcbiAgICAgIGJhc2VOYW1lOiB0YWJsZU5hbWVcbiAgICB9LFxuICAgIC8vIE1vY2sgY29sdW1uIHByb3BlcnRpZXMgZm9yIGNvbW1vbiBmaWVsZHNcbiAgICBpZDogeyBuYW1lOiAnaWQnIH0sXG4gICAgZW1haWw6IHsgbmFtZTogJ2VtYWlsJyB9LFxuICAgIG5hbWU6IHsgbmFtZTogJ25hbWUnIH0sXG4gICAgcm9sZTogeyBuYW1lOiAncm9sZScgfSxcbiAgICB1c2VySWQ6IHsgbmFtZTogJ3VzZXJJZCcgfSxcbiAgICBvcmdhbml6YXRpb25JZDogeyBuYW1lOiAnb3JnYW5pemF0aW9uSWQnIH0sXG4gICAgYnVpbGRpbmdJZDogeyBuYW1lOiAnYnVpbGRpbmdJZCcgfSxcbiAgICAvLyBBZGQgYW55IG90aGVyIGNvbW1vbmx5IGFjY2Vzc2VkIGNvbHVtbiBwcm9wZXJ0aWVzXG4gIH07XG59O1xuXG4vLyBNb2NrIGFsbCB0aGUgaW5kaXZpZHVhbCBzY2hlbWEgdGFibGVzIHRoYXQgdGVzdHMgaW1wb3J0XG5leHBvcnQgY29uc3QgbW9ja1NjaGVtYU9iamVjdCA9IHtcbiAgLy8gQ29yZSB0YWJsZXNcbiAgdXNlcnM6IGNyZWF0ZU1vY2tUYWJsZSgndXNlcnMnKSxcbiAgb3JnYW5pemF0aW9uczogY3JlYXRlTW9ja1RhYmxlKCdvcmdhbml6YXRpb25zJyksXG4gIHVzZXJPcmdhbml6YXRpb25zOiBjcmVhdGVNb2NrVGFibGUoJ3VzZXJPcmdhbml6YXRpb25zJyksXG4gIGludml0YXRpb25zOiBjcmVhdGVNb2NrVGFibGUoJ2ludml0YXRpb25zJyksXG4gIHBhc3N3b3JkUmVzZXRUb2tlbnM6IGNyZWF0ZU1vY2tUYWJsZSgncGFzc3dvcmRSZXNldFRva2VucycpLFxuICBcbiAgLy8gUHJvcGVydHkgdGFibGVzICBcbiAgYnVpbGRpbmdzOiBjcmVhdGVNb2NrVGFibGUoJ2J1aWxkaW5ncycpLFxuICByZXNpZGVuY2VzOiBjcmVhdGVNb2NrVGFibGUoJ3Jlc2lkZW5jZXMnKSxcbiAgdXNlclJlc2lkZW5jZXM6IGNyZWF0ZU1vY2tUYWJsZSgndXNlclJlc2lkZW5jZXMnKSxcbiAgXG4gIC8vIERvY3VtZW50IGFuZCBmaW5hbmNpYWwgdGFibGVzXG4gIGRvY3VtZW50czogY3JlYXRlTW9ja1RhYmxlKCdkb2N1bWVudHMnKSxcbiAgYmlsbHM6IGNyZWF0ZU1vY2tUYWJsZSgnYmlsbHMnKSxcbiAgYnVkZ2V0czogY3JlYXRlTW9ja1RhYmxlKCdidWRnZXRzJyksXG4gIG1vbnRobHlCdWRnZXRzOiBjcmVhdGVNb2NrVGFibGUoJ21vbnRobHlCdWRnZXRzJyksXG4gIFxuICAvLyBPcGVyYXRpb25zIHRhYmxlc1xuICBtYWludGVuYW5jZVJlcXVlc3RzOiBjcmVhdGVNb2NrVGFibGUoJ21haW50ZW5hbmNlUmVxdWVzdHMnKSxcbiAgY29tbW9uU3BhY2VzOiBjcmVhdGVNb2NrVGFibGUoJ2NvbW1vblNwYWNlcycpLFxuICBcbiAgLy8gU3lzdGVtIHRhYmxlc1xuICBwZXJtaXNzaW9uczogY3JlYXRlTW9ja1RhYmxlKCdwZXJtaXNzaW9ucycpLFxuICB1c2VyUGVybWlzc2lvbnM6IGNyZWF0ZU1vY2tUYWJsZSgndXNlclBlcm1pc3Npb25zJyksXG4gIHJvbGVQZXJtaXNzaW9uczogY3JlYXRlTW9ja1RhYmxlKCdyb2xlUGVybWlzc2lvbnMnKSxcbiAgZGVtYW5kczogY3JlYXRlTW9ja1RhYmxlKCdkZW1hbmRzJylcbn07XG5cbi8vIE1vY2sgU1FMIHRlbXBsYXRlIGZ1bmN0aW9uXG5leHBvcnQgY29uc3QgbW9ja1NxbCA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKHN0cmluZ3M6IFRlbXBsYXRlU3RyaW5nc0FycmF5LCAuLi52YWx1ZXM6IGFueVtdKSA9PiB7XG4gIGNvbnN0IHF1ZXJ5ID0gc3RyaW5ncy5qb2luKCc/Jyk7XG4gIGlmIChxdWVyeS5pbmNsdWRlcygnU0VMRUNUIHZlcnNpb24oKScpKSB7XG4gICAgcmV0dXJuIFt7IHZlcnNpb246ICdQb3N0Z3JlU1FMIDE1LjAgKE1vY2spJyB9XTtcbiAgfVxuICByZXR1cm4gW107XG59KTsiXSwidmVyc2lvbiI6M30=