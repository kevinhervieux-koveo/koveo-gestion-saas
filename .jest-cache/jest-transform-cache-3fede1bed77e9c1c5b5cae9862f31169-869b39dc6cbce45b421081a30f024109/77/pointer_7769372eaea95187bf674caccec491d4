ad5b5a31776a62c8e432f6da7baca88e
'use strict';
require('../../utils/dataTransfer/Clipboard.js');
var getTreeDiff = require('../../utils/misc/getTreeDiff.js');
var cssPointerEvents = require('../../utils/pointer/cssPointerEvents.js');
var shared = require('./shared.js');
var buttons = require('./buttons.js');
function _define_property(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    }
    else {
        obj[key] = value;
    }
    return obj;
}
class Pointer {
    init(instance) {
        const target = this.getTarget(instance);
        const [, enter] = getTreeDiff.getTreeDiff(null, target);
        const init = this.getEventInit();
        cssPointerEvents.assertPointerEvents(instance, target);
        instance.dispatchUIEvent(target, 'pointerover', init);
        enter.forEach((el) => instance.dispatchUIEvent(el, 'pointerenter', init));
        return this;
    }
    move(instance, position) {
        const prevPosition = this.position;
        const prevTarget = this.getTarget(instance);
        this.position = position;
        if (!shared.isDifferentPointerPosition(prevPosition, position)) {
            return;
        }
        const nextTarget = this.getTarget(instance);
        const init = this.getEventInit(-1);
        const [leave, enter] = getTreeDiff.getTreeDiff(prevTarget, nextTarget);
        return {
            leave: () => {
                if (cssPointerEvents.hasPointerEvents(instance, prevTarget)) {
                    if (prevTarget !== nextTarget) {
                        instance.dispatchUIEvent(prevTarget, 'pointerout', init);
                        leave.forEach((el) => instance.dispatchUIEvent(el, 'pointerleave', init));
                    }
                }
            },
            enter: () => {
                cssPointerEvents.assertPointerEvents(instance, nextTarget);
                if (prevTarget !== nextTarget) {
                    instance.dispatchUIEvent(nextTarget, 'pointerover', init);
                    enter.forEach((el) => instance.dispatchUIEvent(el, 'pointerenter', init));
                }
            },
            move: () => {
                instance.dispatchUIEvent(nextTarget, 'pointermove', init);
            }
        };
    }
    down(instance, button = 0) {
        if (this.isDown) {
            return;
        }
        const target = this.getTarget(instance);
        cssPointerEvents.assertPointerEvents(instance, target);
        this.isDown = true;
        this.isPrevented = !instance.dispatchUIEvent(target, 'pointerdown', this.getEventInit(button));
    }
    up(instance, button = 0) {
        if (!this.isDown) {
            return;
        }
        const target = this.getTarget(instance);
        cssPointerEvents.assertPointerEvents(instance, target);
        this.isPrevented = false;
        this.isDown = false;
        instance.dispatchUIEvent(target, 'pointerup', this.getEventInit(button));
    }
    release(instance) {
        const target = this.getTarget(instance);
        const [leave] = getTreeDiff.getTreeDiff(target, null);
        const init = this.getEventInit();
        // Currently there is no PointerEventsCheckLevel that would
        // make this check not use the *asserted* cached value from `up`.
        /* istanbul ignore else */ if (cssPointerEvents.hasPointerEvents(instance, target)) {
            instance.dispatchUIEvent(target, 'pointerout', init);
            leave.forEach((el) => instance.dispatchUIEvent(el, 'pointerleave', init));
        }
        this.isCancelled = true;
    }
    getTarget(instance) {
        var _this_position_target;
        return (_this_position_target = this.position.target) !== null && _this_position_target !== undefined ? _this_position_target : instance.config.document.body;
    }
    getEventInit(/**
     * The `button` that caused the event.
     *
     * This should be `-1` if the event is not caused by a button or touch/pen contact,
     * e.g. a moving pointer.
     */ button) {
        return {
            ...this.position.coords,
            pointerId: this.pointerId,
            pointerType: this.pointerType,
            isPrimary: this.isPrimary,
            button: buttons.getMouseEventButton(button),
            buttons: this.buttons.getButtons()
        };
    }
    constructor({ pointerId, pointerType, isPrimary }, buttons) {
        _define_property(this, "pointerId", undefined);
        _define_property(this, "pointerType", undefined);
        _define_property(this, "isPrimary", undefined);
        _define_property(this, "buttons", undefined);
        _define_property(this, "isMultitouch", false);
        _define_property(this, "isCancelled", false);
        _define_property(this, "isDown", false);
        _define_property(this, "isPrevented", false);
        _define_property(this, "position", {});
        this.pointerId = pointerId;
        this.pointerType = pointerType;
        this.isPrimary = isPrimary;
        this.isMultitouch = !isPrimary;
        this.buttons = buttons;
    }
}
exports.Pointer = Pointer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9wb2ludGVyL3BvaW50ZXIuanMiLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7QUFDakQsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7QUFDN0QsSUFBSSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMseUNBQXlDLENBQUMsQ0FBQztBQUMxRSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDcEMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRXRDLFNBQVMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLO0lBQ3JDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO1lBQzVCLEtBQUssRUFBRSxLQUFLO1lBQ1osVUFBVSxFQUFFLElBQUk7WUFDaEIsWUFBWSxFQUFFLElBQUk7WUFDbEIsUUFBUSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztTQUFNLENBQUM7UUFDSixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUFDRCxNQUFNLE9BQU87SUFDVCxJQUFJLENBQUMsUUFBUTtRQUNULE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEMsTUFBTSxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxD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QUFnQixDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0MsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdDLGdCQUFnQixDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0NBQ0o7QUFFRCxPQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL25vZGVfbW9kdWxlcy9AdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQvZGlzdC9janMvc3lzdGVtL3BvaW50ZXIvcG9pbnRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnJlcXVpcmUoJy4uLy4uL3V0aWxzL2RhdGFUcmFuc2Zlci9DbGlwYm9hcmQuanMnKTtcbnZhciBnZXRUcmVlRGlmZiA9IHJlcXVpcmUoJy4uLy4uL3V0aWxzL21pc2MvZ2V0VHJlZURpZmYuanMnKTtcbnZhciBjc3NQb2ludGVyRXZlbnRzID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvcG9pbnRlci9jc3NQb2ludGVyRXZlbnRzLmpzJyk7XG52YXIgc2hhcmVkID0gcmVxdWlyZSgnLi9zaGFyZWQuanMnKTtcbnZhciBidXR0b25zID0gcmVxdWlyZSgnLi9idXR0b25zLmpzJyk7XG5cbmZ1bmN0aW9uIF9kZWZpbmVfcHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7XG4gICAgaWYgKGtleSBpbiBvYmopIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgd3JpdGFibGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIG9iajtcbn1cbmNsYXNzIFBvaW50ZXIge1xuICAgIGluaXQoaW5zdGFuY2UpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoaW5zdGFuY2UpO1xuICAgICAgICBjb25zdCBbLCBlbnRlcl0gPSBnZXRUcmVlRGlmZi5nZXRUcmVlRGlmZihudWxsLCB0YXJnZXQpO1xuICAgICAgICBjb25zdCBpbml0ID0gdGhpcy5nZXRFdmVudEluaXQoKTtcbiAgICAgICAgY3NzUG9pbnRlckV2ZW50cy5hc3NlcnRQb2ludGVyRXZlbnRzKGluc3RhbmNlLCB0YXJnZXQpO1xuICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQodGFyZ2V0LCAncG9pbnRlcm92ZXInLCBpbml0KTtcbiAgICAgICAgZW50ZXIuZm9yRWFjaCgoZWwpPT5pbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQoZWwsICdwb2ludGVyZW50ZXInLCBpbml0KSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBtb3ZlKGluc3RhbmNlLCBwb3NpdGlvbikge1xuICAgICAgICBjb25zdCBwcmV2UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uO1xuICAgICAgICBjb25zdCBwcmV2VGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoaW5zdGFuY2UpO1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgIGlmICghc2hhcmVkLmlzRGlmZmVyZW50UG9pbnRlclBvc2l0aW9uKHByZXZQb3NpdGlvbiwgcG9zaXRpb24pKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbmV4dFRhcmdldCA9IHRoaXMuZ2V0VGFyZ2V0KGluc3RhbmNlKTtcbiAgICAgICAgY29uc3QgaW5pdCA9IHRoaXMuZ2V0RXZlbnRJbml0KC0xKTtcbiAgICAgICAgY29uc3QgW2xlYXZlLCBlbnRlcl0gPSBnZXRUcmVlRGlmZi5nZXRUcmVlRGlmZihwcmV2VGFyZ2V0LCBuZXh0VGFyZ2V0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGxlYXZlOiAoKT0+e1xuICAgICAgICAgICAgICAgIGlmIChjc3NQb2ludGVyRXZlbnRzLmhhc1BvaW50ZXJFdmVudHMoaW5zdGFuY2UsIHByZXZUYXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmV2VGFyZ2V0ICE9PSBuZXh0VGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQocHJldlRhcmdldCwgJ3BvaW50ZXJvdXQnLCBpbml0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlYXZlLmZvckVhY2goKGVsKT0+aW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGVsLCAncG9pbnRlcmxlYXZlJywgaW5pdCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVudGVyOiAoKT0+e1xuICAgICAgICAgICAgICAgIGNzc1BvaW50ZXJFdmVudHMuYXNzZXJ0UG9pbnRlckV2ZW50cyhpbnN0YW5jZSwgbmV4dFRhcmdldCk7XG4gICAgICAgICAgICAgICAgaWYgKHByZXZUYXJnZXQgIT09IG5leHRUYXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KG5leHRUYXJnZXQsICdwb2ludGVyb3ZlcicsIGluaXQpO1xuICAgICAgICAgICAgICAgICAgICBlbnRlci5mb3JFYWNoKChlbCk9Pmluc3RhbmNlLmRpc3BhdGNoVUlFdmVudChlbCwgJ3BvaW50ZXJlbnRlcicsIGluaXQpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbW92ZTogKCk9PntcbiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQobmV4dFRhcmdldCwgJ3BvaW50ZXJtb3ZlJywgaW5pdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuICAgIGRvd24oaW5zdGFuY2UsIGJ1dHRvbiA9IDApIHtcbiAgICAgICAgaWYgKHRoaXMuaXNEb3duKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoaW5zdGFuY2UpO1xuICAgICAgICBjc3NQb2ludGVyRXZlbnRzLmFzc2VydFBvaW50ZXJFdmVudHMoaW5zdGFuY2UsIHRhcmdldCk7XG4gICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5pc1ByZXZlbnRlZCA9ICFpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQodGFyZ2V0LCAncG9pbnRlcmRvd24nLCB0aGlzLmdldEV2ZW50SW5pdChidXR0b24pKTtcbiAgICB9XG4gICAgdXAoaW5zdGFuY2UsIGJ1dHRvbiA9IDApIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzRG93bikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZ2V0VGFyZ2V0KGluc3RhbmNlKTtcbiAgICAgICAgY3NzUG9pbnRlckV2ZW50cy5hc3NlcnRQb2ludGVyRXZlbnRzKGluc3RhbmNlLCB0YXJnZXQpO1xuICAgICAgICB0aGlzLmlzUHJldmVudGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaXNEb3duID0gZmFsc2U7XG4gICAgICAgIGluc3RhbmNlLmRpc3BhdGNoVUlFdmVudCh0YXJnZXQsICdwb2ludGVydXAnLCB0aGlzLmdldEV2ZW50SW5pdChidXR0b24pKTtcbiAgICB9XG4gICAgcmVsZWFzZShpbnN0YW5jZSkge1xuICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdldFRhcmdldChpbnN0YW5jZSk7XG4gICAgICAgIGNvbnN0IFtsZWF2ZV0gPSBnZXRUcmVlRGlmZi5nZXRUcmVlRGlmZih0YXJnZXQsIG51bGwpO1xuICAgICAgICBjb25zdCBpbml0ID0gdGhpcy5nZXRFdmVudEluaXQoKTtcbiAgICAgICAgLy8gQ3VycmVudGx5IHRoZXJlIGlzIG5vIFBvaW50ZXJFdmVudHNDaGVja0xldmVsIHRoYXQgd291bGRcbiAgICAgICAgLy8gbWFrZSB0aGlzIGNoZWNrIG5vdCB1c2UgdGhlICphc3NlcnRlZCogY2FjaGVkIHZhbHVlIGZyb20gYHVwYC5cbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8gaWYgKGNzc1BvaW50ZXJFdmVudHMuaGFzUG9pbnRlckV2ZW50cyhpbnN0YW5jZSwgdGFyZ2V0KSkge1xuICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KHRhcmdldCwgJ3BvaW50ZXJvdXQnLCBpbml0KTtcbiAgICAgICAgICAgIGxlYXZlLmZvckVhY2goKGVsKT0+aW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGVsLCAncG9pbnRlcmxlYXZlJywgaW5pdCkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaXNDYW5jZWxsZWQgPSB0cnVlO1xuICAgIH1cbiAgICBnZXRUYXJnZXQoaW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIF90aGlzX3Bvc2l0aW9uX3RhcmdldDtcbiAgICAgICAgcmV0dXJuIChfdGhpc19wb3NpdGlvbl90YXJnZXQgPSB0aGlzLnBvc2l0aW9uLnRhcmdldCkgIT09IG51bGwgJiYgX3RoaXNfcG9zaXRpb25fdGFyZ2V0ICE9PSB1bmRlZmluZWQgPyBfdGhpc19wb3NpdGlvbl90YXJnZXQgOiBpbnN0YW5jZS5jb25maWcuZG9jdW1lbnQuYm9keTtcbiAgICB9XG4gICAgZ2V0RXZlbnRJbml0KC8qKlxuICAgICAqIFRoZSBgYnV0dG9uYCB0aGF0IGNhdXNlZCB0aGUgZXZlbnQuXG4gICAgICpcbiAgICAgKiBUaGlzIHNob3VsZCBiZSBgLTFgIGlmIHRoZSBldmVudCBpcyBub3QgY2F1c2VkIGJ5IGEgYnV0dG9uIG9yIHRvdWNoL3BlbiBjb250YWN0LFxuICAgICAqIGUuZy4gYSBtb3ZpbmcgcG9pbnRlci5cbiAgICAgKi8gYnV0dG9uKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi50aGlzLnBvc2l0aW9uLmNvb3JkcyxcbiAgICAgICAgICAgIHBvaW50ZXJJZDogdGhpcy5wb2ludGVySWQsXG4gICAgICAgICAgICBwb2ludGVyVHlwZTogdGhpcy5wb2ludGVyVHlwZSxcbiAgICAgICAgICAgIGlzUHJpbWFyeTogdGhpcy5pc1ByaW1hcnksXG4gICAgICAgICAgICBidXR0b246IGJ1dHRvbnMuZ2V0TW91c2VFdmVudEJ1dHRvbihidXR0b24pLFxuICAgICAgICAgICAgYnV0dG9uczogdGhpcy5idXR0b25zLmdldEJ1dHRvbnMoKVxuICAgICAgICB9O1xuICAgIH1cbiAgICBjb25zdHJ1Y3Rvcih7IHBvaW50ZXJJZCwgcG9pbnRlclR5cGUsIGlzUHJpbWFyeSB9LCBidXR0b25zKXtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcInBvaW50ZXJJZFwiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwicG9pbnRlclR5cGVcIiwgdW5kZWZpbmVkKTtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImlzUHJpbWFyeVwiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiYnV0dG9uc1wiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiaXNNdWx0aXRvdWNoXCIsIGZhbHNlKTtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImlzQ2FuY2VsbGVkXCIsIGZhbHNlKTtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImlzRG93blwiLCBmYWxzZSk7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJpc1ByZXZlbnRlZFwiLCBmYWxzZSk7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJwb3NpdGlvblwiLCB7fSk7XG4gICAgICAgIHRoaXMucG9pbnRlcklkID0gcG9pbnRlcklkO1xuICAgICAgICB0aGlzLnBvaW50ZXJUeXBlID0gcG9pbnRlclR5cGU7XG4gICAgICAgIHRoaXMuaXNQcmltYXJ5ID0gaXNQcmltYXJ5O1xuICAgICAgICB0aGlzLmlzTXVsdGl0b3VjaCA9ICFpc1ByaW1hcnk7XG4gICAgICAgIHRoaXMuYnV0dG9ucyA9IGJ1dHRvbnM7XG4gICAgfVxufVxuXG5leHBvcnRzLlBvaW50ZXIgPSBQb2ludGVyO1xuIl0sInZlcnNpb24iOjN9