daa9dd73b3cf0603748ae7cb50fcbc7e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.billGenerationService = exports.BillGenerationService = void 0;
const db_1 = require("../db");
const financial_1 = require("../../shared/schemas/financial");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const uuid_1 = require("uuid");
/**
 * Advanced Bill Generation Service.
 *
 * Handles the sophisticated bill management system including:
 * - Creating future bill instances (not just money flow entries)
 * - Multiple payment plans (60% now, 40% later, etc.)
 * - Recurrence patterns with auto-generated bill chains
 * - 3-year projection of future bills
 * - Parent-child bill relationships.
 */
class BillGenerationService {
    /**
     * Get bills by reference (auto-generated bills linked to a parent).
     * @param parentBillId
     */
    async getBillsByReference(parentBillId) {
        try {
            const existingBills = await db_1.db.select().from(financial_1.bills).where((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId));
            return existingBills;
        }
        catch (error) {
            console.error('‚ùå Error getting bills by reference:', error);
            return [];
        }
    }
    /**
     * Set end date for a recurrent bill (stops future auto-generation).
     * @param billId
     * @param endDate
     */
    async setRecurrenceEndDate(billId, endDate) {
        try {
            await db_1.db
                .update(financial_1.bills)
                .set({
                endDate: endDate.toISOString().split('T')[0],
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(financial_1.bills.id, billId));
        }
        catch (error) {
            console.error('‚ùå Error setting recurrence end date:', error);
            throw error;
        }
    }
    /**
     * Generate future bill instances for a recurrent bill up to 3 years.
     * Creates actual bill records that users can interact with individually.
     * @param parentBill
     */
    async generateFutureBillInstances(parentBill) {
        if (parentBill.paymentType !== 'recurrent') {
            throw new Error('Only recurrent bills can generate future instances');
        }
        // Calculate projection period - respect endDate if set
        const startDate = new Date(parentBill.startDate);
        startDate.setFullYear(startDate.getFullYear() + 1); // Start from next year
        let endDate;
        if (parentBill.endDate) {
            endDate = new Date(parentBill.endDate);
        }
        else {
            endDate = new Date();
            endDate.setFullYear(endDate.getFullYear() + 3); // 3 years from now
        }
        // Check if there are already auto-generated bills to avoid duplicates
        const existingBills = await this.getBillsByReference(parentBill.id);
        if (existingBills.length > 0) {
            console.log(`‚ö†Ô∏è Found ${existingBills.length} existing auto-generated bills, skipping generation`);
            return {
                billsCreated: 0,
                generatedUntil: endDate.toISOString().split('T')[0],
            };
        }
        const generatedBills = [];
        const currentDate = new Date(startDate);
        let billsCreated = 0;
        // Calculate occurrences based on schedule (auto-detect from parent bill)
        const scheduleType = this.detectScheduleType(parentBill);
        const occurrences = this.calculateOccurrences(currentDate, endDate, scheduleType);
        for (const occurrenceDate of occurrences) {
            // Handle multiple payment plans
            const paymentParts = this.calculatePaymentParts(parentBill, occurrenceDate);
            for (let partIndex = 0; partIndex < paymentParts.length; partIndex++) {
                const paymentPart = paymentParts[partIndex];
                const generatedBill = {
                    id: (0, uuid_1.v4)(),
                    buildingId: parentBill.buildingId,
                    billNumber: this.generateBillNumber(parentBill, occurrenceDate, partIndex),
                    title: this.generateBillTitle(parentBill, occurrenceDate, partIndex, paymentParts.length),
                    description: `Auto-generated from: ${parentBill.title}`,
                    category: parentBill.category,
                    vendor: parentBill.vendor || 'Auto-Generated',
                    paymentType: 'unique', // Generated bills are unique payments
                    schedulePayment: 'unique',
                    costs: [paymentPart.amount.toString()],
                    totalAmount: paymentPart.amount.toString(),
                    startDate: paymentPart.dueDate.toISOString().split('T')[0],
                    endDate: null,
                    status: 'draft',
                    documentPath: null,
                    documentName: null,
                    isAiAnalyzed: false,
                    aiAnalysisData: null,
                    notes: `Auto-generated from: ${parentBill.title} (Bill #${parentBill.billNumber}). Generated as part ${partIndex + 1}/${paymentParts.length} for ${occurrenceDate.toLocaleDateString()}.`,
                    autoGenerated: true,
                    reference: parentBill.id,
                    createdBy: parentBill.createdBy,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                };
                generatedBills.push(generatedBill);
                billsCreated++;
                // Batch insert every 100 bills for performance
                if (generatedBills.length >= 100) {
                    await this.insertBillsBatch(generatedBills);
                    generatedBills.length = 0;
                }
            }
        }
        // Insert remaining bills
        if (generatedBills.length > 0) {
            await this.insertBillsBatch(generatedBills);
        }
        return {
            billsCreated,
            generatedUntil: endDate.toISOString().split('T')[0],
        };
    }
    /**
     * Handle multiple payment logic for bills.
     * Examples:
     * - 60% now, 40% in 2 months
     * - 12 monthly payments of equal amounts
     * - Quarterly payments with varying amounts.
     * @param parentBill
     * @param occurrenceDate
     */
    calculatePaymentParts(parentBill, occurrenceDate) {
        const costs = parentBill.costs.map((cost) => parseFloat(cost));
        const paymentParts = [];
        if (costs.length === 1) {
            // Single payment
            paymentParts.push({
                amount: costs[0],
                dueDate: new Date(occurrenceDate),
                partNumber: 1,
            });
        }
        else {
            // Multiple payments - create payment schedule
            costs.forEach((amount, _index) => {
                const dueDate = new Date(occurrenceDate);
                // For multiple costs, spread payments over time
                // First payment on occurrence date, subsequent payments monthly
                dueDate.setMonth(dueDate.getMonth() + _index);
                paymentParts.push({
                    amount,
                    dueDate,
                    partNumber: _index + 1,
                });
            });
        }
        return paymentParts;
    }
    /**
     * Detect schedule type from parent bill characteristics.
     * @param parentBill
     */
    detectScheduleType(parentBill) {
        const costs = parentBill.costs || [];
        // Auto-detect based on cost array length and bill patterns
        if (costs.length === 12) {
            return 'monthly'; // 12 payments = monthly
        }
        else if (costs.length === 4) {
            return 'quarterly'; // 4 payments = quarterly
        }
        else if (costs.length === 2) {
            return 'yearly'; // 2 payments = bi-annual, treat as yearly with split
        }
        else if (costs.length === 1) {
            // Single payment - determine frequency from title/description
            const title = parentBill.title.toLowerCase();
            if (title.includes('annual') || title.includes('yearly')) {
                return 'yearly';
            }
            else if (title.includes('quarterly')) {
                return 'quarterly';
            }
            else if (title.includes('monthly')) {
                return 'monthly';
            }
            else {
                return 'yearly'; // Default to yearly
            }
        }
        return 'yearly'; // Default fallback
    }
    /**
     * Calculate all occurrence dates based on schedule type.
     * @param startDate
     * @param endDate
     * @param scheduleType
     */
    calculateOccurrences(startDate, endDate, scheduleType) {
        const occurrences = [];
        const currentDate = new Date(startDate);
        // Standard schedule types
        while (currentDate <= endDate) {
            occurrences.push(new Date(currentDate));
            switch (scheduleType) {
                case 'weekly':
                    currentDate.setDate(currentDate.getDate() + 7);
                    break;
                case 'monthly':
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    currentDate.setMonth(currentDate.getMonth() + 3);
                    break;
                case 'yearly':
                    currentDate.setFullYear(currentDate.getFullYear() + 1);
                    break;
                default:
                    throw new Error(`Unknown schedule type: ${scheduleType}`);
            }
            // Safety check to prevent infinite loops
            if (occurrences.length > 10000) {
                break;
            }
        }
        return occurrences;
    }
    /**
     * Handle custom recurring dates (yearly repetition).
     * @param startDate
     * @param endDate
     * @param customDates
     */
    calculateCustomOccurrences(startDate, endDate, customDates) {
        const occurrences = [];
        const startYear = startDate.getFullYear();
        const endYear = endDate.getFullYear();
        for (let year = startYear; year <= endYear; year++) {
            for (const dateStr of customDates) {
                const customDate = new Date(dateStr);
                customDate.setFullYear(year);
                if (customDate >= startDate && customDate <= endDate) {
                    occurrences.push(new Date(customDate));
                }
            }
        }
        return occurrences.sort((a, b) => a.getTime() - b.getTime());
    }
    /**
     * Generate unique bill number for auto-generated bills.
     * @param parentBill
     * @param occurrenceDate
     * @param partIndex
     */
    generateBillNumber(parentBill, occurrenceDate, partIndex) {
        const dateStr = occurrenceDate.toISOString().slice(0, 7); // YYYY-MM
        const partSuffix = partIndex > 0 ? `-P${partIndex + 1}` : '';
        return `${parentBill.billNumber}-${dateStr}${partSuffix}`;
    }
    /**
     * Generate descriptive title for auto-generated bills.
     * @param parentBill
     * @param occurrenceDate
     * @param partIndex
     * @param totalParts
     */
    generateBillTitle(parentBill, occurrenceDate, partIndex, totalParts) {
        const monthYear = occurrenceDate.toLocaleDateString('en-US', {
            month: 'long',
            year: 'numeric',
        });
        if (totalParts > 1) {
            return `${parentBill.title} ${monthYear} (Auto-Generated)`;
        }
        else {
            return `${parentBill.title} ${monthYear} (Auto-Generated)`;
        }
    }
    /**
     * Clean up existing auto-generated bills for a parent bill.
     * @param parentBillId
     */
    async cleanupExistingGeneratedBills(parentBillId) {
        try {
            const result = await db_1.db
                .delete(financial_1.bills)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId), (0, drizzle_orm_1.eq)(financial_1.bills.autoGenerated, true), (0, drizzle_orm_1.or)((0, drizzle_orm_1.eq)(financial_1.bills.status, 'draft'), (0, drizzle_orm_1.eq)(financial_1.bills.status, 'sent'))));
            console.log(`üóëÔ∏è Cleaned up auto-generated bills for parent bill ${parentBillId}`);
        }
        catch (error) {
            console.error('‚ùå Error cleaning up generated bills:', error);
            throw error;
        }
    }
    /**
     * Batch insert bills for performance.
     * @param billBatch
     */
    async insertBillsBatch(billBatch) {
        try {
            await db_1.db.insert(financial_1.bills).values(billBatch);
            console.log(`‚úÖ Batch inserted ${billBatch.length} bills`);
        }
        catch (error) {
            console.error('‚ùå Error inserting bill batch:', error);
            throw error;
        }
    }
    /**
     * Update all future auto-generated bills when the parent bill is modified.
     * @param parentBillId
     * @param updates
     */
    async updateGeneratedBillsFromParent(parentBillId, updates) {
        // Find all auto-generated bills for this parent
        const generatedBills = await db_1.db
            .select()
            .from(financial_1.bills)
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId), (0, drizzle_orm_1.eq)(financial_1.bills.autoGenerated, true)));
        let billsUpdated = 0;
        for (const generatedBill of generatedBills) {
            const updatedFields = {};
            // Update fields that should propagate to generated bills
            if (updates.title) {
                // Preserve the date and part information in the title
                const titleParts = generatedBill.title.split(' - ');
                if (titleParts.length >= 2) {
                    updatedFields.title = `${updates.title} - ${titleParts.slice(1).join(' - ')}`;
                }
            }
            if (updates.category) {
                updatedFields.category = updates.category;
            }
            if (updates.vendor) {
                updatedFields.vendor = updates.vendor;
            }
            if (updates.notes) {
                updatedFields.notes = `Auto-generated bill - ${updates.notes}`;
            }
            if (Object.keys(updatedFields).length > 0) {
                updatedFields.updatedAt = new Date();
                await db_1.db.update(financial_1.bills).set(updatedFields).where((0, drizzle_orm_1.eq)(financial_1.bills.id, generatedBill.id));
                billsUpdated++;
            }
        }
        return { billsUpdated };
    }
    /**
     * Delete future auto-generated bills with cascade options.
     * @param parentBillId
     * @param deleteAllFuture
     */
    async deleteGeneratedBills(parentBillId, deleteAllFuture = false) {
        console.log(`üóëÔ∏è Deleting generated bills for parent ${parentBillId}, deleteAllFuture: ${deleteAllFuture}`);
        let whereCondition;
        if (deleteAllFuture) {
            // Delete all future auto-generated bills
            whereCondition = (0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId), (0, drizzle_orm_1.eq)(financial_1.bills.autoGenerated, true), (0, drizzle_orm_1.gte)(financial_1.bills.startDate, new Date().toISOString().split('T')[0]));
        }
        else {
            // Delete only unpaid bills (draft/sent status)
            whereCondition = (0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId), (0, drizzle_orm_1.eq)(financial_1.bills.autoGenerated, true), (0, drizzle_orm_1.or)((0, drizzle_orm_1.eq)(financial_1.bills.status, 'draft'), (0, drizzle_orm_1.eq)(financial_1.bills.status, 'sent')));
        }
        const result = await db_1.db.delete(financial_1.bills).where(whereCondition);
        const billsDeleted = result.rowCount || 0;
        return { billsDeleted };
    }
    /**
     * Get statistics about generated bills for a parent bill.
     * @param parentBillId
     */
    async getGeneratedBillsStats(parentBillId) {
        const generatedBills = await db_1.db
            .select()
            .from(financial_1.bills)
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(financial_1.bills.reference, parentBillId), (0, drizzle_orm_1.eq)(financial_1.bills.autoGenerated, true)));
        const today = new Date().toISOString().split('T')[0];
        const stats = {
            totalGenerated: generatedBills.length,
            paidBills: 0,
            pendingBills: 0,
            futureBills: 0,
            totalAmount: 0,
            paidAmount: 0,
        };
        for (const bill of generatedBills) {
            const billAmount = parseFloat(bill.totalAmount);
            stats.totalAmount += billAmount;
            if (bill.status === 'paid') {
                stats.paidBills++;
                stats.paidAmount += billAmount;
            }
            else if (bill.startDate > today) {
                stats.futureBills++;
            }
            else {
                stats.pendingBills++;
            }
        }
        return stats;
    }
    /**
     * Mark a bill as paid and update related tracking.
     * @param billId
     * @param paymentDate
     */
    async markBillAsPaid(billId, paymentDate) {
        const paymentReceivedDate = paymentDate || new Date();
        await db_1.db
            .update(financial_1.bills)
            .set({
            status: 'paid',
            notes: `Payment confirmed on ${paymentReceivedDate.toLocaleDateString()}`,
            updatedAt: new Date(),
        })
            .where((0, drizzle_orm_1.eq)(financial_1.bills.id, billId));
    }
    /**
     * Get a system user for automated operations.
     */
    async getSystemUser() {
        const systemUsers = await db_1.db
            .select({ id: schema_1.users.id })
            .from(schema_1.users)
            .where((0, drizzle_orm_1.eq)(schema_1.users.role, 'admin'))
            .limit(1);
        if (systemUsers.length === 0) {
            throw new Error('No active users found for system operations');
        }
        return systemUsers[0];
    }
}
exports.BillGenerationService = BillGenerationService;
// Export singleton instance
exports.billGenerationService = new BillGenerationService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvYmlsbC1nZW5lcmF0aW9uLXNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBQTJCO0FBQzNCLDhEQUF1RDtBQUN2RCxnREFBNEM7QUFDNUMsNkNBQXVEO0FBQ3ZELCtCQUFvQztBQUdwQzs7Ozs7Ozs7O0dBU0c7QUFDSCxNQUFhLHFCQUFxQjtJQUNoQzs7O09BR0c7SUFDSyxLQUFLLENBQUMsbUJBQW1CLENBQUMsWUFBb0I7UUFDcEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxhQUFhLEdBQUcsTUFBTSxPQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGlCQUFLLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFFN0YsT0FBTyxhQUF1QixDQUFDO1FBQ2pDLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDNUQsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsb0JBQW9CLENBQUMsTUFBYyxFQUFFLE9BQWE7UUFDdEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxPQUFFO2lCQUNMLE1BQU0sQ0FBQyxpQkFBSyxDQUFDO2lCQUNiLEdBQUcsQ0FBQztnQkFDSCxPQUFPLEVBQUUsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzVDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDO2lCQUNELEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsaUJBQUssQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUs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QUMsNkNBQTZDLENBQUMsQ0FBQztRQUNqRSxDQUFDO1FBRUQsT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEIsQ0FBQztDQUNGO0FBdGhCRCxzREFzaEJDO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxxQkFBcUIsR0FBRyxJQUFJLHFCQUFxQixFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvYmlsbC1nZW5lcmF0aW9uLXNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGIgfSBmcm9tICcuLi9kYic7XG5pbXBvcnQgeyBiaWxscyB9IGZyb20gJy4uLy4uL3NoYXJlZC9zY2hlbWFzL2ZpbmFuY2lhbCc7XG5pbXBvcnQgeyB1c2VycyB9IGZyb20gJy4uLy4uL3NoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgZXEsIGFuZCwgZ3RlLCBpc051bGwsIG9yIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgdHlwZSB7IEJpbGwgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZW1hJztcblxuLyoqXG4gKiBBZHZhbmNlZCBCaWxsIEdlbmVyYXRpb24gU2VydmljZS5cbiAqXG4gKiBIYW5kbGVzIHRoZSBzb3BoaXN0aWNhdGVkIGJpbGwgbWFuYWdlbWVudCBzeXN0ZW0gaW5jbHVkaW5nOlxuICogLSBDcmVhdGluZyBmdXR1cmUgYmlsbCBpbnN0YW5jZXMgKG5vdCBqdXN0IG1vbmV5IGZsb3cgZW50cmllcylcbiAqIC0gTXVsdGlwbGUgcGF5bWVudCBwbGFucyAoNjAlIG5vdywgNDAlIGxhdGVyLCBldGMuKVxuICogLSBSZWN1cnJlbmNlIHBhdHRlcm5zIHdpdGggYXV0by1nZW5lcmF0ZWQgYmlsbCBjaGFpbnNcbiAqIC0gMy15ZWFyIHByb2plY3Rpb24gb2YgZnV0dXJlIGJpbGxzXG4gKiAtIFBhcmVudC1jaGlsZCBiaWxsIHJlbGF0aW9uc2hpcHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBCaWxsR2VuZXJhdGlvblNlcnZpY2Uge1xuICAvKipcbiAgICogR2V0IGJpbGxzIGJ5IHJlZmVyZW5jZSAoYXV0by1nZW5lcmF0ZWQgYmlsbHMgbGlua2VkIHRvIGEgcGFyZW50KS5cbiAgICogQHBhcmFtIHBhcmVudEJpbGxJZFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXRCaWxsc0J5UmVmZXJlbmNlKHBhcmVudEJpbGxJZDogc3RyaW5nKTogUHJvbWlzZTxCaWxsW10+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXhpc3RpbmdCaWxscyA9IGF3YWl0IGRiLnNlbGVjdCgpLmZyb20oYmlsbHMpLndoZXJlKGVxKGJpbGxzLnJlZmVyZW5jZSwgcGFyZW50QmlsbElkKSk7XG5cbiAgICAgIHJldHVybiBleGlzdGluZ0JpbGxzIGFzIEJpbGxbXTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZ2V0dGluZyBiaWxscyBieSByZWZlcmVuY2U6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgZW5kIGRhdGUgZm9yIGEgcmVjdXJyZW50IGJpbGwgKHN0b3BzIGZ1dHVyZSBhdXRvLWdlbmVyYXRpb24pLlxuICAgKiBAcGFyYW0gYmlsbElkXG4gICAqIEBwYXJhbSBlbmREYXRlXG4gICAqL1xuICBhc3luYyBzZXRSZWN1cnJlbmNlRW5kRGF0ZShiaWxsSWQ6IHN0cmluZywgZW5kRGF0ZTogRGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkYlxuICAgICAgICAudXBkYXRlKGJpbGxzKVxuICAgICAgICAuc2V0KHtcbiAgICAgICAgICBlbmREYXRlOiBlbmREYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0pXG4gICAgICAgIC53aGVyZShlcShiaWxscy5pZCwgYmlsbElkKSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHNldHRpbmcgcmVjdXJyZW5jZSBlbmQgZGF0ZTonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgZnV0dXJlIGJpbGwgaW5zdGFuY2VzIGZvciBhIHJlY3VycmVudCBiaWxsIHVwIHRvIDMgeWVhcnMuXG4gICAqIENyZWF0ZXMgYWN0dWFsIGJpbGwgcmVjb3JkcyB0aGF0IHVzZXJzIGNhbiBpbnRlcmFjdCB3aXRoIGluZGl2aWR1YWxseS5cbiAgICogQHBhcmFtIHBhcmVudEJpbGxcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlRnV0dXJlQmlsbEluc3RhbmNlcyhwYXJlbnRCaWxsOiBCaWxsKTogUHJvbWlzZTx7XG4gICAgYmlsbHNDcmVhdGVkOiBudW1iZXI7XG4gICAgZ2VuZXJhdGVkVW50aWw6IHN0cmluZztcbiAgfT4ge1xuICAgIGlmIChwYXJlbnRCaWxsLnBheW1lbnRUeXBlICE9PSAncmVjdXJyZW50Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IHJlY3VycmVudCBiaWxscyBjYW4gZ2VuZXJhdGUgZnV0dXJlIGluc3RhbmNlcycpO1xuICAgIH1cblxuXG4gICAgLy8gQ2FsY3VsYXRlIHByb2plY3Rpb24gcGVyaW9kIC0gcmVzcGVjdCBlbmREYXRlIGlmIHNldFxuICAgIGNvbnN0IHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKHBhcmVudEJpbGwuc3RhcnREYXRlKTtcbiAgICBzdGFydERhdGUuc2V0RnVsbFllYXIoc3RhcnREYXRlLmdldEZ1bGxZZWFyKCkgKyAxKTsgLy8gU3RhcnQgZnJvbSBuZXh0IHllYXJcblxuICAgIGxldCBlbmREYXRlOiBEYXRlO1xuICAgIGlmIChwYXJlbnRCaWxsLmVuZERhdGUpIHtcbiAgICAgIGVuZERhdGUgPSBuZXcgRGF0ZShwYXJlbnRCaWxsLmVuZERhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbmREYXRlID0gbmV3IERhdGUoKTtcbiAgICAgIGVuZERhdGUuc2V0RnVsbFllYXIoZW5kRGF0ZS5nZXRGdWxsWWVhcigpICsgMyk7IC8vIDMgeWVhcnMgZnJvbSBub3dcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSBhcmUgYWxyZWFkeSBhdXRvLWdlbmVyYXRlZCBiaWxscyB0byBhdm9pZCBkdXBsaWNhdGVzXG4gICAgY29uc3QgZXhpc3RpbmdCaWxscyA9IGF3YWl0IHRoaXMuZ2V0QmlsbHNCeVJlZmVyZW5jZShwYXJlbnRCaWxsLmlkKTtcbiAgICBpZiAoZXhpc3RpbmdCaWxscy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYOKaoO+4jyBGb3VuZCAke2V4aXN0aW5nQmlsbHMubGVuZ3RofSBleGlzdGluZyBhdXRvLWdlbmVyYXRlZCBiaWxscywgc2tpcHBpbmcgZ2VuZXJhdGlvbmBcbiAgICAgICk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBiaWxsc0NyZWF0ZWQ6IDAsXG4gICAgICAgIGdlbmVyYXRlZFVudGlsOiBlbmREYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgZ2VuZXJhdGVkQmlsbHM6IHVua25vd25bXSA9IFtdO1xuICAgIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoc3RhcnREYXRlKTtcbiAgICBsZXQgYmlsbHNDcmVhdGVkID0gMDtcblxuICAgIC8vIENhbGN1bGF0ZSBvY2N1cnJlbmNlcyBiYXNlZCBvbiBzY2hlZHVsZSAoYXV0by1kZXRlY3QgZnJvbSBwYXJlbnQgYmlsbClcbiAgICBjb25zdCBzY2hlZHVsZVR5cGUgPSB0aGlzLmRldGVjdFNjaGVkdWxlVHlwZShwYXJlbnRCaWxsKTtcbiAgICBjb25zdCBvY2N1cnJlbmNlcyA9IHRoaXMuY2FsY3VsYXRlT2NjdXJyZW5jZXMoY3VycmVudERhdGUsIGVuZERhdGUsIHNjaGVkdWxlVHlwZSk7XG5cbiAgICBmb3IgKGNvbnN0IG9jY3VycmVuY2VEYXRlIG9mIG9jY3VycmVuY2VzKSB7XG4gICAgICAvLyBIYW5kbGUgbXVsdGlwbGUgcGF5bWVudCBwbGFuc1xuICAgICAgY29uc3QgcGF5bWVudFBhcnRzID0gdGhpcy5jYWxjdWxhdGVQYXltZW50UGFydHMocGFyZW50QmlsbCwgb2NjdXJyZW5jZURhdGUpO1xuXG4gICAgICBmb3IgKGxldCBwYXJ0SW5kZXggPSAwOyBwYXJ0SW5kZXggPCBwYXltZW50UGFydHMubGVuZ3RoOyBwYXJ0SW5kZXgrKykge1xuICAgICAgICBjb25zdCBwYXltZW50UGFydCA9IHBheW1lbnRQYXJ0c1twYXJ0SW5kZXhdO1xuXG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZEJpbGwgPSB7XG4gICAgICAgICAgaWQ6IHV1aWR2NCgpLFxuICAgICAgICAgIGJ1aWxkaW5nSWQ6IHBhcmVudEJpbGwuYnVpbGRpbmdJZCxcbiAgICAgICAgICBiaWxsTnVtYmVyOiB0aGlzLmdlbmVyYXRlQmlsbE51bWJlcihwYXJlbnRCaWxsLCBvY2N1cnJlbmNlRGF0ZSwgcGFydEluZGV4KSxcbiAgICAgICAgICB0aXRsZTogdGhpcy5nZW5lcmF0ZUJpbGxUaXRsZShwYXJlbnRCaWxsLCBvY2N1cnJlbmNlRGF0ZSwgcGFydEluZGV4LCBwYXltZW50UGFydHMubGVuZ3RoKSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYEF1dG8tZ2VuZXJhdGVkIGZyb206ICR7cGFyZW50QmlsbC50aXRsZX1gLFxuICAgICAgICAgIGNhdGVnb3J5OiBwYXJlbnRCaWxsLmNhdGVnb3J5LFxuICAgICAgICAgIHZlbmRvcjogcGFyZW50QmlsbC52ZW5kb3IgfHwgJ0F1dG8tR2VuZXJhdGVkJyxcbiAgICAgICAgICBwYXltZW50VHlwZTogJ3VuaXF1ZScgYXMgY29uc3QsIC8vIEdlbmVyYXRlZCBiaWxscyBhcmUgdW5pcXVlIHBheW1lbnRzXG4gICAgICAgICAgc2NoZWR1bGVQYXltZW50OiAndW5pcXVlJyBhcyBjb25zdCxcbiAgICAgICAgICBjb3N0czogW3BheW1lbnRQYXJ0LmFtb3VudC50b1N0cmluZygpXSxcbiAgICAgICAgICB0b3RhbEFtb3VudDogcGF5bWVudFBhcnQuYW1vdW50LnRvU3RyaW5nKCksXG4gICAgICAgICAgc3RhcnREYXRlOiBwYXltZW50UGFydC5kdWVEYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgICBlbmREYXRlOiBudWxsLFxuICAgICAgICAgIHN0YXR1czogJ2RyYWZ0JyBhcyBjb25zdCxcbiAgICAgICAgICBkb2N1bWVudFBhdGg6IG51bGwsXG4gICAgICAgICAgZG9jdW1lbnROYW1lOiBudWxsLFxuICAgICAgICAgIGlzQWlBbmFseXplZDogZmFsc2UsXG4gICAgICAgICAgYWlBbmFseXNpc0RhdGE6IG51bGwsXG4gICAgICAgICAgbm90ZXM6IGBBdXRvLWdlbmVyYXRlZCBmcm9tOiAke3BhcmVudEJpbGwudGl0bGV9IChCaWxsICMke3BhcmVudEJpbGwuYmlsbE51bWJlcn0pLiBHZW5lcmF0ZWQgYXMgcGFydCAke3BhcnRJbmRleCArIDF9LyR7cGF5bWVudFBhcnRzLmxlbmd0aH0gZm9yICR7b2NjdXJyZW5jZURhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKCl9LmAsXG4gICAgICAgICAgYXV0b0dlbmVyYXRlZDogdHJ1ZSxcbiAgICAgICAgICByZWZlcmVuY2U6IHBhcmVudEJpbGwuaWQsXG4gICAgICAgICAgY3JlYXRlZEJ5OiBwYXJlbnRCaWxsLmNyZWF0ZWRCeSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGdlbmVyYXRlZEJpbGxzLnB1c2goZ2VuZXJhdGVkQmlsbCk7XG4gICAgICAgIGJpbGxzQ3JlYXRlZCsrO1xuXG4gICAgICAgIC8vIEJhdGNoIGluc2VydCBldmVyeSAxMDAgYmlsbHMgZm9yIHBlcmZvcm1hbmNlXG4gICAgICAgIGlmIChnZW5lcmF0ZWRCaWxscy5sZW5ndGggPj0gMTAwKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5pbnNlcnRCaWxsc0JhdGNoKGdlbmVyYXRlZEJpbGxzKTtcbiAgICAgICAgICBnZW5lcmF0ZWRCaWxscy5sZW5ndGggPSAwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSW5zZXJ0IHJlbWFpbmluZyBiaWxsc1xuICAgIGlmIChnZW5lcmF0ZWRCaWxscy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmluc2VydEJpbGxzQmF0Y2goZ2VuZXJhdGVkQmlsbHMpO1xuICAgIH1cblxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGJpbGxzQ3JlYXRlZCxcbiAgICAgIGdlbmVyYXRlZFVudGlsOiBlbmREYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBtdWx0aXBsZSBwYXltZW50IGxvZ2ljIGZvciBiaWxscy5cbiAgICogRXhhbXBsZXM6XG4gICAqIC0gNjAlIG5vdywgNDAlIGluIDIgbW9udGhzXG4gICAqIC0gMTIgbW9udGhseSBwYXltZW50cyBvZiBlcXVhbCBhbW91bnRzXG4gICAqIC0gUXVhcnRlcmx5IHBheW1lbnRzIHdpdGggdmFyeWluZyBhbW91bnRzLlxuICAgKiBAcGFyYW0gcGFyZW50QmlsbFxuICAgKiBAcGFyYW0gb2NjdXJyZW5jZURhdGVcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlUGF5bWVudFBhcnRzKFxuICAgIHBhcmVudEJpbGw6IEJpbGwsXG4gICAgb2NjdXJyZW5jZURhdGU6IERhdGVcbiAgKTogQXJyYXk8e1xuICAgIGFtb3VudDogbnVtYmVyO1xuICAgIGR1ZURhdGU6IERhdGU7XG4gICAgcGFydE51bWJlcjogbnVtYmVyO1xuICB9PiB7XG4gICAgY29uc3QgY29zdHMgPSBwYXJlbnRCaWxsLmNvc3RzLm1hcCgoY29zdCkgPT4gcGFyc2VGbG9hdChjb3N0KSk7XG4gICAgY29uc3QgcGF5bWVudFBhcnRzOiBBcnJheTx7IGFtb3VudDogbnVtYmVyOyBkdWVEYXRlOiBEYXRlOyBwYXJ0TnVtYmVyOiBudW1iZXIgfT4gPSBbXTtcblxuICAgIGlmIChjb3N0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIC8vIFNpbmdsZSBwYXltZW50XG4gICAgICBwYXltZW50UGFydHMucHVzaCh7XG4gICAgICAgIGFtb3VudDogY29zdHNbMF0sXG4gICAgICAgIGR1ZURhdGU6IG5ldyBEYXRlKG9jY3VycmVuY2VEYXRlKSxcbiAgICAgICAgcGFydE51bWJlcjogMSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBNdWx0aXBsZSBwYXltZW50cyAtIGNyZWF0ZSBwYXltZW50IHNjaGVkdWxlXG4gICAgICBjb3N0cy5mb3JFYWNoKChhbW91bnQsIF9pbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBkdWVEYXRlID0gbmV3IERhdGUob2NjdXJyZW5jZURhdGUpO1xuXG4gICAgICAgIC8vIEZvciBtdWx0aXBsZSBjb3N0cywgc3ByZWFkIHBheW1lbnRzIG92ZXIgdGltZVxuICAgICAgICAvLyBGaXJzdCBwYXltZW50IG9uIG9jY3VycmVuY2UgZGF0ZSwgc3Vic2VxdWVudCBwYXltZW50cyBtb250aGx5XG4gICAgICAgIGR1ZURhdGUuc2V0TW9udGgoZHVlRGF0ZS5nZXRNb250aCgpICsgX2luZGV4KTtcblxuICAgICAgICBwYXltZW50UGFydHMucHVzaCh7XG4gICAgICAgICAgYW1vdW50LFxuICAgICAgICAgIGR1ZURhdGUsXG4gICAgICAgICAgcGFydE51bWJlcjogX2luZGV4ICsgMSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF5bWVudFBhcnRzO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBzY2hlZHVsZSB0eXBlIGZyb20gcGFyZW50IGJpbGwgY2hhcmFjdGVyaXN0aWNzLlxuICAgKiBAcGFyYW0gcGFyZW50QmlsbFxuICAgKi9cbiAgcHJpdmF0ZSBkZXRlY3RTY2hlZHVsZVR5cGUocGFyZW50QmlsbDogQmlsbCk6IHN0cmluZyB7XG4gICAgY29uc3QgY29zdHMgPSBwYXJlbnRCaWxsLmNvc3RzIHx8IFtdO1xuXG4gICAgLy8gQXV0by1kZXRlY3QgYmFzZWQgb24gY29zdCBhcnJheSBsZW5ndGggYW5kIGJpbGwgcGF0dGVybnNcbiAgICBpZiAoY29zdHMubGVuZ3RoID09PSAxMikge1xuICAgICAgcmV0dXJuICdtb250aGx5JzsgLy8gMTIgcGF5bWVudHMgPSBtb250aGx5XG4gICAgfSBlbHNlIGlmIChjb3N0cy5sZW5ndGggPT09IDQpIHtcbiAgICAgIHJldHVybiAncXVhcnRlcmx5JzsgLy8gNCBwYXltZW50cyA9IHF1YXJ0ZXJseVxuICAgIH0gZWxzZSBpZiAoY29zdHMubGVuZ3RoID09PSAyKSB7XG4gICAgICByZXR1cm4gJ3llYXJseSc7IC8vIDIgcGF5bWVudHMgPSBiaS1hbm51YWwsIHRyZWF0IGFzIHllYXJseSB3aXRoIHNwbGl0XG4gICAgfSBlbHNlIGlmIChjb3N0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIC8vIFNpbmdsZSBwYXltZW50IC0gZGV0ZXJtaW5lIGZyZXF1ZW5jeSBmcm9tIHRpdGxlL2Rlc2NyaXB0aW9uXG4gICAgICBjb25zdCB0aXRsZSA9IHBhcmVudEJpbGwudGl0bGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmICh0aXRsZS5pbmNsdWRlcygnYW5udWFsJykgfHwgdGl0bGUuaW5jbHVkZXMoJ3llYXJseScpKSB7XG4gICAgICAgIHJldHVybiAneWVhcmx5JztcbiAgICAgIH0gZWxzZSBpZiAodGl0bGUuaW5jbHVkZXMoJ3F1YXJ0ZXJseScpKSB7XG4gICAgICAgIHJldHVybiAncXVhcnRlcmx5JztcbiAgICAgIH0gZWxzZSBpZiAodGl0bGUuaW5jbHVkZXMoJ21vbnRobHknKSkge1xuICAgICAgICByZXR1cm4gJ21vbnRobHknO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuICd5ZWFybHknOyAvLyBEZWZhdWx0IHRvIHllYXJseVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAneWVhcmx5JzsgLy8gRGVmYXVsdCBmYWxsYmFja1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBhbGwgb2NjdXJyZW5jZSBkYXRlcyBiYXNlZCBvbiBzY2hlZHVsZSB0eXBlLlxuICAgKiBAcGFyYW0gc3RhcnREYXRlXG4gICAqIEBwYXJhbSBlbmREYXRlXG4gICAqIEBwYXJhbSBzY2hlZHVsZVR5cGVcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlT2NjdXJyZW5jZXMoc3RhcnREYXRlOiBEYXRlLCBlbmREYXRlOiBEYXRlLCBzY2hlZHVsZVR5cGU6IHN0cmluZyk6IERhdGVbXSB7XG4gICAgY29uc3Qgb2NjdXJyZW5jZXM6IERhdGVbXSA9IFtdO1xuICAgIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoc3RhcnREYXRlKTtcblxuICAgIC8vIFN0YW5kYXJkIHNjaGVkdWxlIHR5cGVzXG4gICAgd2hpbGUgKGN1cnJlbnREYXRlIDw9IGVuZERhdGUpIHtcbiAgICAgIG9jY3VycmVuY2VzLnB1c2gobmV3IERhdGUoY3VycmVudERhdGUpKTtcblxuICAgICAgc3dpdGNoIChzY2hlZHVsZVR5cGUpIHtcbiAgICAgICAgY2FzZSAnd2Vla2x5JzpcbiAgICAgICAgICBjdXJyZW50RGF0ZS5zZXREYXRlKGN1cnJlbnREYXRlLmdldERhdGUoKSArIDcpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdtb250aGx5JzpcbiAgICAgICAgICBjdXJyZW50RGF0ZS5zZXRNb250aChjdXJyZW50RGF0ZS5nZXRNb250aCgpICsgMSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3F1YXJ0ZXJseSc6XG4gICAgICAgICAgY3VycmVudERhdGUuc2V0TW9udGgoY3VycmVudERhdGUuZ2V0TW9udGgoKSArIDMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICd5ZWFybHknOlxuICAgICAgICAgIGN1cnJlbnREYXRlLnNldEZ1bGxZZWFyKGN1cnJlbnREYXRlLmdldEZ1bGxZZWFyKCkgKyAxKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gc2NoZWR1bGUgdHlwZTogJHtzY2hlZHVsZVR5cGV9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNhZmV0eSBjaGVjayB0byBwcmV2ZW50IGluZmluaXRlIGxvb3BzXG4gICAgICBpZiAob2NjdXJyZW5jZXMubGVuZ3RoID4gMTAwMDApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9jY3VycmVuY2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBjdXN0b20gcmVjdXJyaW5nIGRhdGVzICh5ZWFybHkgcmVwZXRpdGlvbikuXG4gICAqIEBwYXJhbSBzdGFydERhdGVcbiAgICogQHBhcmFtIGVuZERhdGVcbiAgICogQHBhcmFtIGN1c3RvbURhdGVzXG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZUN1c3RvbU9jY3VycmVuY2VzKFxuICAgIHN0YXJ0RGF0ZTogRGF0ZSxcbiAgICBlbmREYXRlOiBEYXRlLFxuICAgIGN1c3RvbURhdGVzOiBzdHJpbmdbXVxuICApOiBEYXRlW10ge1xuICAgIGNvbnN0IG9jY3VycmVuY2VzOiBEYXRlW10gPSBbXTtcbiAgICBjb25zdCBzdGFydFllYXIgPSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBjb25zdCBlbmRZZWFyID0gZW5kRGF0ZS5nZXRGdWxsWWVhcigpO1xuXG4gICAgZm9yIChsZXQgeWVhciA9IHN0YXJ0WWVhcjsgeWVhciA8PSBlbmRZZWFyOyB5ZWFyKyspIHtcbiAgICAgIGZvciAoY29uc3QgZGF0ZVN0ciBvZiBjdXN0b21EYXRlcykge1xuICAgICAgICBjb25zdCBjdXN0b21EYXRlID0gbmV3IERhdGUoZGF0ZVN0cik7XG4gICAgICAgIGN1c3RvbURhdGUuc2V0RnVsbFllYXIoeWVhcik7XG5cbiAgICAgICAgaWYgKGN1c3RvbURhdGUgPj0gc3RhcnREYXRlICYmIGN1c3RvbURhdGUgPD0gZW5kRGF0ZSkge1xuICAgICAgICAgIG9jY3VycmVuY2VzLnB1c2gobmV3IERhdGUoY3VzdG9tRGF0ZSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9jY3VycmVuY2VzLnNvcnQoKGEsIGIpID0+IGEuZ2V0VGltZSgpIC0gYi5nZXRUaW1lKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIHVuaXF1ZSBiaWxsIG51bWJlciBmb3IgYXV0by1nZW5lcmF0ZWQgYmlsbHMuXG4gICAqIEBwYXJhbSBwYXJlbnRCaWxsXG4gICAqIEBwYXJhbSBvY2N1cnJlbmNlRGF0ZVxuICAgKiBAcGFyYW0gcGFydEluZGV4XG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlQmlsbE51bWJlcihwYXJlbnRCaWxsOiBCaWxsLCBvY2N1cnJlbmNlRGF0ZTogRGF0ZSwgcGFydEluZGV4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IGRhdGVTdHIgPSBvY2N1cnJlbmNlRGF0ZS50b0lTT1N0cmluZygpLnNsaWNlKDAsIDcpOyAvLyBZWVlZLU1NXG4gICAgY29uc3QgcGFydFN1ZmZpeCA9IHBhcnRJbmRleCA+IDAgPyBgLVAke3BhcnRJbmRleCArIDF9YCA6ICcnO1xuICAgIHJldHVybiBgJHtwYXJlbnRCaWxsLmJpbGxOdW1iZXJ9LSR7ZGF0ZVN0cn0ke3BhcnRTdWZmaXh9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBkZXNjcmlwdGl2ZSB0aXRsZSBmb3IgYXV0by1nZW5lcmF0ZWQgYmlsbHMuXG4gICAqIEBwYXJhbSBwYXJlbnRCaWxsXG4gICAqIEBwYXJhbSBvY2N1cnJlbmNlRGF0ZVxuICAgKiBAcGFyYW0gcGFydEluZGV4XG4gICAqIEBwYXJhbSB0b3RhbFBhcnRzXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlQmlsbFRpdGxlKFxuICAgIHBhcmVudEJpbGw6IEJpbGwsXG4gICAgb2NjdXJyZW5jZURhdGU6IERhdGUsXG4gICAgcGFydEluZGV4OiBudW1iZXIsXG4gICAgdG90YWxQYXJ0czogbnVtYmVyXG4gICk6IHN0cmluZyB7XG4gICAgY29uc3QgbW9udGhZZWFyID0gb2NjdXJyZW5jZURhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKCdlbi1VUycsIHtcbiAgICAgIG1vbnRoOiAnbG9uZycsXG4gICAgICB5ZWFyOiAnbnVtZXJpYycsXG4gICAgfSk7XG5cbiAgICBpZiAodG90YWxQYXJ0cyA+IDEpIHtcbiAgICAgIHJldHVybiBgJHtwYXJlbnRCaWxsLnRpdGxlfSAke21vbnRoWWVhcn0gKEF1dG8tR2VuZXJhdGVkKWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgJHtwYXJlbnRCaWxsLnRpdGxlfSAke21vbnRoWWVhcn0gKEF1dG8tR2VuZXJhdGVkKWA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIGV4aXN0aW5nIGF1dG8tZ2VuZXJhdGVkIGJpbGxzIGZvciBhIHBhcmVudCBiaWxsLlxuICAgKiBAcGFyYW0gcGFyZW50QmlsbElkXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNsZWFudXBFeGlzdGluZ0dlbmVyYXRlZEJpbGxzKHBhcmVudEJpbGxJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiXG4gICAgICAgIC5kZWxldGUoYmlsbHMpXG4gICAgICAgIC53aGVyZShcbiAgICAgICAgICBhbmQoXG4gICAgICAgICAgICBlcShiaWxscy5yZWZlcmVuY2UsIHBhcmVudEJpbGxJZCksXG4gICAgICAgICAgICBlcShiaWxscy5hdXRvR2VuZXJhdGVkLCB0cnVlKSxcbiAgICAgICAgICAgIG9yKGVxKGJpbGxzLnN0YXR1cywgJ2RyYWZ0JyksIGVxKGJpbGxzLnN0YXR1cywgJ3NlbnQnKSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICBjb25zb2xlLmxvZyhg8J+Xke+4jyBDbGVhbmVkIHVwIGF1dG8tZ2VuZXJhdGVkIGJpbGxzIGZvciBwYXJlbnQgYmlsbCAke3BhcmVudEJpbGxJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgY2xlYW5pbmcgdXAgZ2VuZXJhdGVkIGJpbGxzOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCYXRjaCBpbnNlcnQgYmlsbHMgZm9yIHBlcmZvcm1hbmNlLlxuICAgKiBAcGFyYW0gYmlsbEJhdGNoXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGluc2VydEJpbGxzQmF0Y2goYmlsbEJhdGNoOiBhbnlbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkYi5pbnNlcnQoYmlsbHMpLnZhbHVlcyhiaWxsQmF0Y2gpO1xuICAgICAgY29uc29sZS5sb2coYOKchSBCYXRjaCBpbnNlcnRlZCAke2JpbGxCYXRjaC5sZW5ndGh9IGJpbGxzYCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGluc2VydGluZyBiaWxsIGJhdGNoOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgYWxsIGZ1dHVyZSBhdXRvLWdlbmVyYXRlZCBiaWxscyB3aGVuIHRoZSBwYXJlbnQgYmlsbCBpcyBtb2RpZmllZC5cbiAgICogQHBhcmFtIHBhcmVudEJpbGxJZFxuICAgKiBAcGFyYW0gdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlR2VuZXJhdGVkQmlsbHNGcm9tUGFyZW50KFxuICAgIHBhcmVudEJpbGxJZDogc3RyaW5nLFxuICAgIHVwZGF0ZXM6IFBhcnRpYWw8QmlsbD5cbiAgKTogUHJvbWlzZTx7XG4gICAgYmlsbHNVcGRhdGVkOiBudW1iZXI7XG4gIH0+IHtcblxuICAgIC8vIEZpbmQgYWxsIGF1dG8tZ2VuZXJhdGVkIGJpbGxzIGZvciB0aGlzIHBhcmVudFxuICAgIGNvbnN0IGdlbmVyYXRlZEJpbGxzID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oYmlsbHMpXG4gICAgICAud2hlcmUoYW5kKGVxKGJpbGxzLnJlZmVyZW5jZSwgcGFyZW50QmlsbElkKSwgZXEoYmlsbHMuYXV0b0dlbmVyYXRlZCwgdHJ1ZSkpKTtcblxuICAgIGxldCBiaWxsc1VwZGF0ZWQgPSAwO1xuXG4gICAgZm9yIChjb25zdCBnZW5lcmF0ZWRCaWxsIG9mIGdlbmVyYXRlZEJpbGxzKSB7XG4gICAgICBjb25zdCB1cGRhdGVkRmllbGRzOiBQYXJ0aWFsPEJpbGw+ID0ge307XG5cbiAgICAgIC8vIFVwZGF0ZSBmaWVsZHMgdGhhdCBzaG91bGQgcHJvcGFnYXRlIHRvIGdlbmVyYXRlZCBiaWxsc1xuICAgICAgaWYgKHVwZGF0ZXMudGl0bGUpIHtcbiAgICAgICAgLy8gUHJlc2VydmUgdGhlIGRhdGUgYW5kIHBhcnQgaW5mb3JtYXRpb24gaW4gdGhlIHRpdGxlXG4gICAgICAgIGNvbnN0IHRpdGxlUGFydHMgPSBnZW5lcmF0ZWRCaWxsLnRpdGxlLnNwbGl0KCcgLSAnKTtcbiAgICAgICAgaWYgKHRpdGxlUGFydHMubGVuZ3RoID49IDIpIHtcbiAgICAgICAgICB1cGRhdGVkRmllbGRzLnRpdGxlID0gYCR7dXBkYXRlcy50aXRsZX0gLSAke3RpdGxlUGFydHMuc2xpY2UoMSkuam9pbignIC0gJyl9YDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodXBkYXRlcy5jYXRlZ29yeSkge1xuICAgICAgICB1cGRhdGVkRmllbGRzLmNhdGVnb3J5ID0gdXBkYXRlcy5jYXRlZ29yeTtcbiAgICAgIH1cbiAgICAgIGlmICh1cGRhdGVzLnZlbmRvcikge1xuICAgICAgICB1cGRhdGVkRmllbGRzLnZlbmRvciA9IHVwZGF0ZXMudmVuZG9yO1xuICAgICAgfVxuICAgICAgaWYgKHVwZGF0ZXMubm90ZXMpIHtcbiAgICAgICAgdXBkYXRlZEZpZWxkcy5ub3RlcyA9IGBBdXRvLWdlbmVyYXRlZCBiaWxsIC0gJHt1cGRhdGVzLm5vdGVzfWA7XG4gICAgICB9XG5cbiAgICAgIGlmIChPYmplY3Qua2V5cyh1cGRhdGVkRmllbGRzKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIHVwZGF0ZWRGaWVsZHMudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcblxuICAgICAgICBhd2FpdCBkYi51cGRhdGUoYmlsbHMpLnNldCh1cGRhdGVkRmllbGRzKS53aGVyZShlcShiaWxscy5pZCwgZ2VuZXJhdGVkQmlsbC5pZCkpO1xuXG4gICAgICAgIGJpbGxzVXBkYXRlZCsrO1xuICAgICAgfVxuICAgIH1cblxuXG4gICAgcmV0dXJuIHsgYmlsbHNVcGRhdGVkIH07XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGZ1dHVyZSBhdXRvLWdlbmVyYXRlZCBiaWxscyB3aXRoIGNhc2NhZGUgb3B0aW9ucy5cbiAgICogQHBhcmFtIHBhcmVudEJpbGxJZFxuICAgKiBAcGFyYW0gZGVsZXRlQWxsRnV0dXJlXG4gICAqL1xuICBhc3luYyBkZWxldGVHZW5lcmF0ZWRCaWxscyhcbiAgICBwYXJlbnRCaWxsSWQ6IHN0cmluZyxcbiAgICBkZWxldGVBbGxGdXR1cmU6IGJvb2xlYW4gPSBmYWxzZVxuICApOiBQcm9taXNlPHtcbiAgICBiaWxsc0RlbGV0ZWQ6IG51bWJlcjtcbiAgfT4ge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYPCfl5HvuI8gRGVsZXRpbmcgZ2VuZXJhdGVkIGJpbGxzIGZvciBwYXJlbnQgJHtwYXJlbnRCaWxsSWR9LCBkZWxldGVBbGxGdXR1cmU6ICR7ZGVsZXRlQWxsRnV0dXJlfWBcbiAgICApO1xuXG4gICAgbGV0IHdoZXJlQ29uZGl0aW9uO1xuXG4gICAgaWYgKGRlbGV0ZUFsbEZ1dHVyZSkge1xuICAgICAgLy8gRGVsZXRlIGFsbCBmdXR1cmUgYXV0by1nZW5lcmF0ZWQgYmlsbHNcbiAgICAgIHdoZXJlQ29uZGl0aW9uID0gYW5kKFxuICAgICAgICBlcShiaWxscy5yZWZlcmVuY2UsIHBhcmVudEJpbGxJZCksXG4gICAgICAgIGVxKGJpbGxzLmF1dG9HZW5lcmF0ZWQsIHRydWUpLFxuICAgICAgICBndGUoYmlsbHMuc3RhcnREYXRlLCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERlbGV0ZSBvbmx5IHVucGFpZCBiaWxscyAoZHJhZnQvc2VudCBzdGF0dXMpXG4gICAgICB3aGVyZUNvbmRpdGlvbiA9IGFuZChcbiAgICAgICAgZXEoYmlsbHMucmVmZXJlbmNlLCBwYXJlbnRCaWxsSWQpLFxuICAgICAgICBlcShiaWxscy5hdXRvR2VuZXJhdGVkLCB0cnVlKSxcbiAgICAgICAgb3IoZXEoYmlsbHMuc3RhdHVzLCAnZHJhZnQnKSwgZXEoYmlsbHMuc3RhdHVzLCAnc2VudCcpKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5kZWxldGUoYmlsbHMpLndoZXJlKHdoZXJlQ29uZGl0aW9uKTtcblxuICAgIGNvbnN0IGJpbGxzRGVsZXRlZCA9IHJlc3VsdC5yb3dDb3VudCB8fCAwO1xuXG4gICAgcmV0dXJuIHsgYmlsbHNEZWxldGVkIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0YXRpc3RpY3MgYWJvdXQgZ2VuZXJhdGVkIGJpbGxzIGZvciBhIHBhcmVudCBiaWxsLlxuICAgKiBAcGFyYW0gcGFyZW50QmlsbElkXG4gICAqL1xuICBhc3luYyBnZXRHZW5lcmF0ZWRCaWxsc1N0YXRzKHBhcmVudEJpbGxJZDogc3RyaW5nKTogUHJvbWlzZTx7XG4gICAgdG90YWxHZW5lcmF0ZWQ6IG51bWJlcjtcbiAgICBwYWlkQmlsbHM6IG51bWJlcjtcbiAgICBwZW5kaW5nQmlsbHM6IG51bWJlcjtcbiAgICBmdXR1cmVCaWxsczogbnVtYmVyO1xuICAgIHRvdGFsQW1vdW50OiBudW1iZXI7XG4gICAgcGFpZEFtb3VudDogbnVtYmVyO1xuICB9PiB7XG4gICAgY29uc3QgZ2VuZXJhdGVkQmlsbHMgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShiaWxscylcbiAgICAgIC53aGVyZShhbmQoZXEoYmlsbHMucmVmZXJlbmNlLCBwYXJlbnRCaWxsSWQpLCBlcShiaWxscy5hdXRvR2VuZXJhdGVkLCB0cnVlKSkpO1xuXG4gICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcblxuICAgIGNvbnN0IHN0YXRzID0ge1xuICAgICAgdG90YWxHZW5lcmF0ZWQ6IGdlbmVyYXRlZEJpbGxzLmxlbmd0aCxcbiAgICAgIHBhaWRCaWxsczogMCxcbiAgICAgIHBlbmRpbmdCaWxsczogMCxcbiAgICAgIGZ1dHVyZUJpbGxzOiAwLFxuICAgICAgdG90YWxBbW91bnQ6IDAsXG4gICAgICBwYWlkQW1vdW50OiAwLFxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IGJpbGwgb2YgZ2VuZXJhdGVkQmlsbHMpIHtcbiAgICAgIGNvbnN0IGJpbGxBbW91bnQgPSBwYXJzZUZsb2F0KGJpbGwudG90YWxBbW91bnQpO1xuICAgICAgc3RhdHMudG90YWxBbW91bnQgKz0gYmlsbEFtb3VudDtcblxuICAgICAgaWYgKGJpbGwuc3RhdHVzID09PSAncGFpZCcpIHtcbiAgICAgICAgc3RhdHMucGFpZEJpbGxzKys7XG4gICAgICAgIHN0YXRzLnBhaWRBbW91bnQgKz0gYmlsbEFtb3VudDtcbiAgICAgIH0gZWxzZSBpZiAoYmlsbC5zdGFydERhdGUgPiB0b2RheSkge1xuICAgICAgICBzdGF0cy5mdXR1cmVCaWxscysrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdHMucGVuZGluZ0JpbGxzKys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0YXRzO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hcmsgYSBiaWxsIGFzIHBhaWQgYW5kIHVwZGF0ZSByZWxhdGVkIHRyYWNraW5nLlxuICAgKiBAcGFyYW0gYmlsbElkXG4gICAqIEBwYXJhbSBwYXltZW50RGF0ZVxuICAgKi9cbiAgYXN5bmMgbWFya0JpbGxBc1BhaWQoYmlsbElkOiBzdHJpbmcsIHBheW1lbnREYXRlPzogRGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBheW1lbnRSZWNlaXZlZERhdGUgPSBwYXltZW50RGF0ZSB8fCBuZXcgRGF0ZSgpO1xuXG4gICAgYXdhaXQgZGJcbiAgICAgIC51cGRhdGUoYmlsbHMpXG4gICAgICAuc2V0KHtcbiAgICAgICAgc3RhdHVzOiAncGFpZCcsXG4gICAgICAgIG5vdGVzOiBgUGF5bWVudCBjb25maXJtZWQgb24gJHtwYXltZW50UmVjZWl2ZWREYXRlLnRvTG9jYWxlRGF0ZVN0cmluZygpfWAsXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0pXG4gICAgICAud2hlcmUoZXEoYmlsbHMuaWQsIGJpbGxJZCkpO1xuXG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgc3lzdGVtIHVzZXIgZm9yIGF1dG9tYXRlZCBvcGVyYXRpb25zLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXRTeXN0ZW1Vc2VyKCk6IFByb21pc2U8eyBpZDogc3RyaW5nIH0+IHtcbiAgICBjb25zdCBzeXN0ZW1Vc2VycyA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KHsgaWQ6IHVzZXJzLmlkIH0pXG4gICAgICAuZnJvbSh1c2VycylcbiAgICAgIC53aGVyZShlcSh1c2Vycy5yb2xlLCAnYWRtaW4nKSlcbiAgICAgIC5saW1pdCgxKTtcblxuICAgIGlmIChzeXN0ZW1Vc2Vycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gYWN0aXZlIHVzZXJzIGZvdW5kIGZvciBzeXN0ZW0gb3BlcmF0aW9ucycpO1xuICAgIH1cblxuICAgIHJldHVybiBzeXN0ZW1Vc2Vyc1swXTtcbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5leHBvcnQgY29uc3QgYmlsbEdlbmVyYXRpb25TZXJ2aWNlID0gbmV3IEJpbGxHZW5lcmF0aW9uU2VydmljZSgpO1xuIl0sInZlcnNpb24iOjN9