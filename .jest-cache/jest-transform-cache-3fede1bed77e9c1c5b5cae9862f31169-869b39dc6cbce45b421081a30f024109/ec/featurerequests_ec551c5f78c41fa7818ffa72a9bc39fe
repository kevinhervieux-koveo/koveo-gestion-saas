079e6c76c2cc1e143961a5ca88c03552
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerFeatureRequestRoutes = registerFeatureRequestRoutes;
const storage_1 = require("../storage");
const schema_1 = require("@shared/schema");
const zod_1 = require("zod");
const auth_1 = require("../auth");
const multer_1 = __importDefault(require("multer"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const uuid_1 = require("uuid");
// Configure multer for file uploads
const storage_config = multer_1.default.diskStorage({
    destination: (req, file, cb) => {
        const uploadDir = path_1.default.join(process.cwd(), 'uploads', 'feature-requests');
        if (!fs_1.default.existsSync(uploadDir)) {
            fs_1.default.mkdirSync(uploadDir, { recursive: true });
        }
        cb(null, uploadDir);
    },
    filename: (req, file, cb) => {
        const uniqueId = (0, uuid_1.v4)();
        const originalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
        const fileName = `${uniqueId}-${originalName}`;
        cb(null, fileName);
    },
});
const upload = (0, multer_1.default)({ storage: storage_config });
/**
 * Registers all feature request related API endpoints.
 *
 * @param app - Express application instance.
 */
function registerFeatureRequestRoutes(app) {
    /**
     * GET /api/feature-requests - Retrieves feature requests based on current user's role and access.
     */
    app.get('/api/feature-requests', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            console.log(`📋 Fetching feature requests for user ${currentUser.id} with role ${currentUser.role}`);
            const featureRequests = await storage_1.storage.getFeatureRequestsForUser(currentUser.id, currentUser.role, currentUser.organizationId);
            console.log(`✅ Found ${featureRequests.length} feature requests for user ${currentUser.id}`);
            res.json(featureRequests);
        }
        catch (error) {
            console.error('❌ Error fetching feature requests:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch feature requests',
            });
        }
    });
    /**
     * GET /api/feature-requests/:id - Retrieves a specific feature request by ID.
     */
    app.get('/api/feature-requests/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const featureRequest = await storage_1.storage.getFeatureRequest(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!featureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            res.json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error fetching feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch feature request',
            });
        }
    });
    /**
     * POST /api/feature-requests - Creates a new feature request with optional file upload.
     */
    app.post('/api/feature-requests', auth_1.requireAuth, upload.single('file'), async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Validate the request body
            const validation = schema_1.insertFeatureRequestSchema.safeParse({
                ...req.body,
                createdBy: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid feature request data',
                    details: validation.error.issues,
                });
            }
            const featureRequestData = validation.data;
            // Handle file upload if present
            if (req.file) {
                featureRequestData.filePath = req.file.path;
                featureRequestData.fileName = req.file.originalname;
                featureRequestData.fileSize = req.file.size;
            }
            const featureRequest = await storage_1.storage.createFeatureRequest(featureRequestData);
            console.log(`💡 Created new feature request ${featureRequest.id} by user ${currentUser.id}`);
            res.status(201).json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error creating feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to create feature request',
            });
        }
    });
    /**
     * PATCH /api/feature-requests/:id - Updates an existing feature request with optional file upload.
     * Users can edit their own feature requests, managers can edit within their org, admins can edit all.
     */
    app.patch('/api/feature-requests/:id', auth_1.requireAuth, upload.single('file'), async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Get the feature request first to check permissions
            const existingFeatureRequest = await storage_1.storage.getFeatureRequest(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!existingFeatureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            // Check permissions: users can edit their own, managers can edit within org, admins can edit all
            const canEdit = currentUser.role === 'admin' ||
                (currentUser.role === 'manager' && existingFeatureRequest.createdBy === currentUser.id) ||
                existingFeatureRequest.createdBy === currentUser.id;
            if (!canEdit) {
                return res.status(403).json({
                    error: 'Forbidden',
                    message: 'You can only edit your own feature requests',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            // Validate the request body
            const updateSchema = zod_1.z.object({
                title: zod_1.z
                    .string()
                    .min(1, 'Title is required')
                    .max(200, 'Title must not exceed 200 characters')
                    .optional(),
                description: zod_1.z
                    .string()
                    .min(10, 'Description must be at least 10 characters')
                    .max(2000, 'Description must not exceed 2000 characters')
                    .optional(),
                need: zod_1.z
                    .string()
                    .min(5, 'Need must be at least 5 characters')
                    .max(500, 'Need must not exceed 500 characters')
                    .optional(),
                category: zod_1.z
                    .enum([
                    'dashboard',
                    'property_management',
                    'resident_management',
                    'financial_management',
                    'maintenance',
                    'document_management',
                    'communication',
                    'reports',
                    'mobile_app',
                    'integrations',
                    'security',
                    'performance',
                    'other',
                ])
                    .optional(),
                page: zod_1.z.string().min(1, 'Page is required').optional(),
                status: zod_1.z
                    .enum(['submitted', 'under_review', 'planned', 'in_progress', 'completed', 'rejected'])
                    .optional(),
                assignedTo: zod_1.z.string().uuid().nullable().optional(),
                adminNotes: zod_1.z.string().optional(),
                mergedIntoId: zod_1.z.string().uuid().nullable().optional(),
            });
            const validation = updateSchema.safeParse(req.body);
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid update data',
                    details: validation.error.issues,
                });
            }
            const updates = validation.data;
            // Handle file upload if present
            if (req.file) {
                updates.filePath = req.file.path;
                updates.fileName = req.file.originalname;
                updates.fileSize = req.file.size;
            }
            const featureRequest = await storage_1.storage.updateFeatureRequest(id, updates, currentUser.id, currentUser.role);
            if (!featureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            console.log(`📝 Updated feature request ${id} by user ${currentUser.id}`);
            res.json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error updating feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to update feature request',
            });
        }
    });
    /**
     * DELETE /api/feature-requests/:id - Deletes a feature request.
     * Only admins can delete feature requests.
     */
    app.delete('/api/feature-requests/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Only admins can delete feature requests
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    error: 'Forbidden',
                    message: 'Only administrators can delete feature requests',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const deleted = await storage_1.storage.deleteFeatureRequest(id, currentUser.id, currentUser.role);
            if (!deleted) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            console.log(`🗑️ Deleted feature request ${id} by user ${currentUser.id}`);
            res.status(204).send();
        }
        catch (error) {
            console.error('❌ Error deleting feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to delete feature request',
            });
        }
    });
    /**
     * GET /api/feature-requests/:id/file - Serves the file attachment for a feature request.
     */
    app.get('/api/feature-requests/:id/file', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const { download } = req.query;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            // Get the feature request to check file attachment
            const featureRequest = await storage_1.storage.getFeatureRequest(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!featureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            // Check if feature request has a file attachment
            if (!featureRequest.filePath || !featureRequest.fileName) {
                return res.status(404).json({
                    error: 'No file attachment',
                    message: 'This feature request does not have a file attachment',
                });
            }
            const filePath = featureRequest.filePath;
            const fileName = featureRequest.fileName;
            // Handle different path formats (absolute vs relative)
            const fullFilePath = path_1.default.isAbsolute(filePath)
                ? filePath
                : path_1.default.join(process.cwd(), 'uploads', filePath);
            // Check if file exists on disk
            if (!fs_1.default.existsSync(fullFilePath)) {
                console.error(`❌ File not found on disk: ${fullFilePath}`);
                return res.status(404).json({
                    error: 'File not found',
                    message: 'The file attachment could not be found',
                });
            }
            console.log(`📎 Serving file for feature request ${id}: ${fileName}`);
            // Detect MIME type based on file extension
            const getContentType = (filename) => {
                const ext = filename.toLowerCase().split('.').pop();
                switch (ext) {
                    case 'pdf': return 'application/pdf';
                    case 'jpg':
                    case 'jpeg': return 'image/jpeg';
                    case 'png': return 'image/png';
                    case 'gif': return 'image/gif';
                    case 'doc': return 'application/msword';
                    case 'docx': return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                    case 'txt': return 'text/plain';
                    default: return 'application/octet-stream';
                }
            };
            // Set proper content type for viewing
            const contentType = getContentType(fileName);
            res.setHeader('Content-Type', contentType);
            // Properly encode filename for French characters and other special characters
            const encodedFilename = Buffer.from(fileName, 'utf8').toString('binary');
            if (download === 'true') {
                res.setHeader('Content-Disposition', `attachment; filename="${encodedFilename}"; filename*=UTF-8''${encodeURIComponent(fileName)}`);
            }
            else {
                res.setHeader('Content-Disposition', `inline; filename="${encodedFilename}"; filename*=UTF-8''${encodeURIComponent(fileName)}`);
            }
            // Stream the file
            const fileStream = fs_1.default.createReadStream(fullFilePath);
            fileStream.pipe(res);
            fileStream.on('error', (error) => {
                console.error(`❌ Error streaming file for feature request ${id}:`, error);
                if (!res.headersSent) {
                    res.status(500).json({ error: 'Failed to stream file' });
                }
            });
        }
        catch (error) {
            console.error('❌ Error serving feature request file:', error);
            if (!res.headersSent) {
                res.status(500).json({
                    error: 'Internal server error',
                    message: 'Failed to serve file',
                });
            }
        }
    });
    /**
     * POST /api/feature-requests/:id/upvote - Upvotes a feature request.
     * Users can upvote any feature request (only once per user).
     */
    app.post('/api/feature-requests/:id/upvote', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            // Validate the upvote data
            const validation = schema_1.insertFeatureRequestUpvoteSchema.safeParse({
                featureRequestId: id,
                userId: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid upvote data',
                    details: validation.error.issues,
                });
            }
            const upvoteData = validation.data;
            const result = await storage_1.storage.upvoteFeatureRequest(upvoteData);
            if (!result.success) {
                return res.status(400).json({
                    error: 'Upvote failed',
                    message: result.message,
                });
            }
            console.log(`👍 User ${currentUser.id} upvoted feature request ${id}`);
            res.json(result.data);
        }
        catch (error) {
            console.error('❌ Error upvoting feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to upvote feature request',
            });
        }
    });
    /**
     * DELETE /api/feature-requests/:id/upvote - Removes an upvote from a feature request.
     * Users can remove their own upvote.
     */
    app.delete('/api/feature-requests/:id/upvote', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const result = await storage_1.storage.removeFeatureRequestUpvote(id, currentUser.id);
            if (!result.success) {
                return res.status(400).json({
                    error: 'Remove upvote failed',
                    message: result.message,
                });
            }
            console.log(`👎 User ${currentUser.id} removed upvote from feature request ${id}`);
            res.json(result.data);
        }
        catch (error) {
            console.error('❌ Error removing upvote from feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to remove upvote from feature request',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXBpL2ZlYXR1cmUtcmVxdWVzdHMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUF5Q0Esb0VBbWhCQztBQTNqQkQsd0NBQXFDO0FBQ3JDLDJDQU93QjtBQUN4Qiw2QkFBd0I7QUFDeEIsa0NBQXNDO0FBQ3RDLG9EQUE0QjtBQUM1QixnREFBd0I7QUFDeEIsNENBQW9CO0FBQ3BCLCtCQUFvQztBQUVwQyxvQ0FBb0M7QUFDcEMsTUFBTSxjQUFjLEdBQUcsZ0JBQU0sQ0FBQyxXQUFXLENBQUM7SUFDeEMsV0FBVyxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRTtRQUM3QixNQUFNLFNBQVMsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxTQUFTLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsWUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1lBQzlCLFlBQUUsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUNELEVBQUUsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUNELFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUU7UUFDMUIsTUFBTSxRQUFRLEdBQUcsSUFBQSxTQUFNLEdBQUUsQ0FBQztRQUMxQixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN2RSxNQUFNLFFBQVEsR0FBRyxHQUFHLFFBQVEsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUMvQyxFQUFFLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7Q0FDRixDQUFDLENBQUM7QUFFSCxNQUFNLE1BQU0s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QUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLEtBQUssRUFBRSx1QkFBdUI7Z0JBQzlCLE9BQU8sRUFBRSw4Q0FBOEM7YUFDeEQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hcGkvZmVhdHVyZS1yZXF1ZXN0cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEV4cHJlc3MgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tICcuLi9zdG9yYWdlJztcbmltcG9ydCB7XG4gIGluc2VydEZlYXR1cmVSZXF1ZXN0U2NoZW1hLFxuICBpbnNlcnRGZWF0dXJlUmVxdWVzdFVwdm90ZVNjaGVtYSxcbiAgdHlwZSBGZWF0dXJlUmVxdWVzdCxcbiAgdHlwZSBJbnNlcnRGZWF0dXJlUmVxdWVzdCxcbiAgdHlwZSBGZWF0dXJlUmVxdWVzdFVwdm90ZSxcbiAgdHlwZSBJbnNlcnRGZWF0dXJlUmVxdWVzdFVwdm90ZSxcbn0gZnJvbSAnQHNoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IG11bHRlciBmcm9tICdtdWx0ZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbi8vIENvbmZpZ3VyZSBtdWx0ZXIgZm9yIGZpbGUgdXBsb2Fkc1xuY29uc3Qgc3RvcmFnZV9jb25maWcgPSBtdWx0ZXIuZGlza1N0b3JhZ2Uoe1xuICBkZXN0aW5hdGlvbjogKHJlcSwgZmlsZSwgY2IpID0+IHtcbiAgICBjb25zdCB1cGxvYWREaXIgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3VwbG9hZHMnLCAnZmVhdHVyZS1yZXF1ZXN0cycpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyh1cGxvYWREaXIpKSB7XG4gICAgICBmcy5ta2RpclN5bmModXBsb2FkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG4gICAgY2IobnVsbCwgdXBsb2FkRGlyKTtcbiAgfSxcbiAgZmlsZW5hbWU6IChyZXEsIGZpbGUsIGNiKSA9PiB7XG4gICAgY29uc3QgdW5pcXVlSWQgPSB1dWlkdjQoKTtcbiAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSBmaWxlLm9yaWdpbmFsbmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOS4tXS9nLCAnXycpO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7dW5pcXVlSWR9LSR7b3JpZ2luYWxOYW1lfWA7XG4gICAgY2IobnVsbCwgZmlsZU5hbWUpO1xuICB9LFxufSk7XG5cbmNvbnN0IHVwbG9hZCA9IG11bHRlcih7IHN0b3JhZ2U6IHN0b3JhZ2VfY29uZmlnIH0pO1xuXG4vKipcbiAqIFJlZ2lzdGVycyBhbGwgZmVhdHVyZSByZXF1ZXN0IHJlbGF0ZWQgQVBJIGVuZHBvaW50cy5cbiAqXG4gKiBAcGFyYW0gYXBwIC0gRXhwcmVzcyBhcHBsaWNhdGlvbiBpbnN0YW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVyRmVhdHVyZVJlcXVlc3RSb3V0ZXMoYXBwOiBFeHByZXNzKTogdm9pZCB7XG4gIC8qKlxuICAgKiBHRVQgL2FwaS9mZWF0dXJlLXJlcXVlc3RzIC0gUmV0cmlldmVzIGZlYXR1cmUgcmVxdWVzdHMgYmFzZWQgb24gY3VycmVudCB1c2VyJ3Mgcm9sZSBhbmQgYWNjZXNzLlxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9mZWF0dXJlLXJlcXVlc3RzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYPCfk4sgRmV0Y2hpbmcgZmVhdHVyZSByZXF1ZXN0cyBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfSB3aXRoIHJvbGUgJHtjdXJyZW50VXNlci5yb2xlfWBcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGZlYXR1cmVSZXF1ZXN0cyA9IGF3YWl0IHN0b3JhZ2UuZ2V0RmVhdHVyZVJlcXVlc3RzRm9yVXNlcihcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUsXG4gICAgICAgIGN1cnJlbnRVc2VyLm9yZ2FuaXphdGlvbklkXG4gICAgICApO1xuXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIEZvdW5kICR7ZmVhdHVyZVJlcXVlc3RzLmxlbmd0aH0gZmVhdHVyZSByZXF1ZXN0cyBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLmpzb24oZmVhdHVyZVJlcXVlc3RzKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgZmVhdHVyZSByZXF1ZXN0czonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBmZWF0dXJlIHJlcXVlc3RzJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEdFVCAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkIC0gUmV0cmlldmVzIGEgc3BlY2lmaWMgZmVhdHVyZSByZXF1ZXN0IGJ5IElELlxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmVhdHVyZVJlcXVlc3QgPSBhd2FpdCBzdG9yYWdlLmdldEZlYXR1cmVSZXF1ZXN0KFxuICAgICAgICBpZCxcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUsXG4gICAgICAgIGN1cnJlbnRVc2VyLm9yZ2FuaXphdGlvbklkXG4gICAgICApO1xuXG4gICAgICBpZiAoIWZlYXR1cmVSZXF1ZXN0KSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3Qgbm90IGZvdW5kIG9yIGFjY2VzcyBkZW5pZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oZmVhdHVyZVJlcXVlc3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBmZWF0dXJlIHJlcXVlc3Q6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBPU1QgL2FwaS9mZWF0dXJlLXJlcXVlc3RzIC0gQ3JlYXRlcyBhIG5ldyBmZWF0dXJlIHJlcXVlc3Qgd2l0aCBvcHRpb25hbCBmaWxlIHVwbG9hZC5cbiAgICovXG4gIGFwcC5wb3N0KCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMnLCByZXF1aXJlQXV0aCwgdXBsb2FkLnNpbmdsZSgnZmlsZScpLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHJlcXVlc3QgYm9keVxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGluc2VydEZlYXR1cmVSZXF1ZXN0U2NoZW1hLnNhZmVQYXJzZSh7XG4gICAgICAgIC4uLnJlcS5ib2R5LFxuICAgICAgICBjcmVhdGVkQnk6IGN1cnJlbnRVc2VyLmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgZmVhdHVyZSByZXF1ZXN0IGRhdGEnLFxuICAgICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3IuaXNzdWVzLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmVhdHVyZVJlcXVlc3REYXRhID0gdmFsaWRhdGlvbi5kYXRhO1xuICAgICAgXG4gICAgICAvLyBIYW5kbGUgZmlsZSB1cGxvYWQgaWYgcHJlc2VudFxuICAgICAgaWYgKHJlcS5maWxlKSB7XG4gICAgICAgIGZlYXR1cmVSZXF1ZXN0RGF0YS5maWxlUGF0aCA9IHJlcS5maWxlLnBhdGg7XG4gICAgICAgIGZlYXR1cmVSZXF1ZXN0RGF0YS5maWxlTmFtZSA9IHJlcS5maWxlLm9yaWdpbmFsbmFtZTtcbiAgICAgICAgZmVhdHVyZVJlcXVlc3REYXRhLmZpbGVTaXplID0gcmVxLmZpbGUuc2l6ZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgZmVhdHVyZVJlcXVlc3QgPSBhd2FpdCBzdG9yYWdlLmNyZWF0ZUZlYXR1cmVSZXF1ZXN0KGZlYXR1cmVSZXF1ZXN0RGF0YSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5KhIENyZWF0ZWQgbmV3IGZlYXR1cmUgcmVxdWVzdCAke2ZlYXR1cmVSZXF1ZXN0LmlkfSBieSB1c2VyICR7Y3VycmVudFVzZXIuaWR9YCk7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihmZWF0dXJlUmVxdWVzdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGNyZWF0aW5nIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBBVENIIC9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQgLSBVcGRhdGVzIGFuIGV4aXN0aW5nIGZlYXR1cmUgcmVxdWVzdCB3aXRoIG9wdGlvbmFsIGZpbGUgdXBsb2FkLlxuICAgKiBVc2VycyBjYW4gZWRpdCB0aGVpciBvd24gZmVhdHVyZSByZXF1ZXN0cywgbWFuYWdlcnMgY2FuIGVkaXQgd2l0aGluIHRoZWlyIG9yZywgYWRtaW5zIGNhbiBlZGl0IGFsbC5cbiAgICovXG4gIGFwcC5wYXRjaCgnL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZCcsIHJlcXVpcmVBdXRoLCB1cGxvYWQuc2luZ2xlKCdmaWxlJyksIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuXG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdGhlIGZlYXR1cmUgcmVxdWVzdCBmaXJzdCB0byBjaGVjayBwZXJtaXNzaW9uc1xuICAgICAgY29uc3QgZXhpc3RpbmdGZWF0dXJlUmVxdWVzdCA9IGF3YWl0IHN0b3JhZ2UuZ2V0RmVhdHVyZVJlcXVlc3QoXG4gICAgICAgIGlkLFxuICAgICAgICBjdXJyZW50VXNlci5pZCxcbiAgICAgICAgY3VycmVudFVzZXIucm9sZSxcbiAgICAgICAgY3VycmVudFVzZXIub3JnYW5pemF0aW9uSWRcbiAgICAgICk7XG5cbiAgICAgIGlmICghZXhpc3RpbmdGZWF0dXJlUmVxdWVzdCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnRmVhdHVyZSByZXF1ZXN0IG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHBlcm1pc3Npb25zOiB1c2VycyBjYW4gZWRpdCB0aGVpciBvd24sIG1hbmFnZXJzIGNhbiBlZGl0IHdpdGhpbiBvcmcsIGFkbWlucyBjYW4gZWRpdCBhbGxcbiAgICAgIGNvbnN0IGNhbkVkaXQgPSBjdXJyZW50VXNlci5yb2xlID09PSAnYWRtaW4nIHx8IFxuICAgICAgICAgICAgICAgICAgICAgKGN1cnJlbnRVc2VyLnJvbGUgPT09ICdtYW5hZ2VyJyAmJiBleGlzdGluZ0ZlYXR1cmVSZXF1ZXN0LmNyZWF0ZWRCeSA9PT0gY3VycmVudFVzZXIuaWQpIHx8XG4gICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0ZlYXR1cmVSZXF1ZXN0LmNyZWF0ZWRCeSA9PT0gY3VycmVudFVzZXIuaWQ7XG5cbiAgICAgIGlmICghY2FuRWRpdCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnRm9yYmlkZGVuJyxcbiAgICAgICAgICBtZXNzYWdlOiAnWW91IGNhbiBvbmx5IGVkaXQgeW91ciBvd24gZmVhdHVyZSByZXF1ZXN0cycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdCYWQgcmVxdWVzdCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBJRCBpcyByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSB0aGUgcmVxdWVzdCBib2R5XG4gICAgICBjb25zdCB1cGRhdGVTY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICAgIHRpdGxlOiB6XG4gICAgICAgICAgLnN0cmluZygpXG4gICAgICAgICAgLm1pbigxLCAnVGl0bGUgaXMgcmVxdWlyZWQnKVxuICAgICAgICAgIC5tYXgoMjAwLCAnVGl0bGUgbXVzdCBub3QgZXhjZWVkIDIwMCBjaGFyYWN0ZXJzJylcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgZGVzY3JpcHRpb246IHpcbiAgICAgICAgICAuc3RyaW5nKClcbiAgICAgICAgICAubWluKDEwLCAnRGVzY3JpcHRpb24gbXVzdCBiZSBhdCBsZWFzdCAxMCBjaGFyYWN0ZXJzJylcbiAgICAgICAgICAubWF4KDIwMDAsICdEZXNjcmlwdGlvbiBtdXN0IG5vdCBleGNlZWQgMjAwMCBjaGFyYWN0ZXJzJylcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgbmVlZDogelxuICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgIC5taW4oNSwgJ05lZWQgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJhY3RlcnMnKVxuICAgICAgICAgIC5tYXgoNTAwLCAnTmVlZCBtdXN0IG5vdCBleGNlZWQgNTAwIGNoYXJhY3RlcnMnKVxuICAgICAgICAgIC5vcHRpb25hbCgpLFxuICAgICAgICBjYXRlZ29yeTogelxuICAgICAgICAgIC5lbnVtKFtcbiAgICAgICAgICAgICdkYXNoYm9hcmQnLFxuICAgICAgICAgICAgJ3Byb3BlcnR5X21hbmFnZW1lbnQnLFxuICAgICAgICAgICAgJ3Jlc2lkZW50X21hbmFnZW1lbnQnLFxuICAgICAgICAgICAgJ2ZpbmFuY2lhbF9tYW5hZ2VtZW50JyxcbiAgICAgICAgICAgICdtYWludGVuYW5jZScsXG4gICAgICAgICAgICAnZG9jdW1lbnRfbWFuYWdlbWVudCcsXG4gICAgICAgICAgICAnY29tbXVuaWNhdGlvbicsXG4gICAgICAgICAgICAncmVwb3J0cycsXG4gICAgICAgICAgICAnbW9iaWxlX2FwcCcsXG4gICAgICAgICAgICAnaW50ZWdyYXRpb25zJyxcbiAgICAgICAgICAgICdzZWN1cml0eScsXG4gICAgICAgICAgICAncGVyZm9ybWFuY2UnLFxuICAgICAgICAgICAgJ290aGVyJyxcbiAgICAgICAgICBdKVxuICAgICAgICAgIC5vcHRpb25hbCgpLFxuICAgICAgICBwYWdlOiB6LnN0cmluZygpLm1pbigxLCAnUGFnZSBpcyByZXF1aXJlZCcpLm9wdGlvbmFsKCksXG4gICAgICAgIHN0YXR1czogelxuICAgICAgICAgIC5lbnVtKFsnc3VibWl0dGVkJywgJ3VuZGVyX3JldmlldycsICdwbGFubmVkJywgJ2luX3Byb2dyZXNzJywgJ2NvbXBsZXRlZCcsICdyZWplY3RlZCddKVxuICAgICAgICAgIC5vcHRpb25hbCgpLFxuICAgICAgICBhc3NpZ25lZFRvOiB6LnN0cmluZygpLnV1aWQoKS5udWxsYWJsZSgpLm9wdGlvbmFsKCksXG4gICAgICAgIGFkbWluTm90ZXM6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgICAgICAgbWVyZ2VkSW50b0lkOiB6LnN0cmluZygpLnV1aWQoKS5udWxsYWJsZSgpLm9wdGlvbmFsKCksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IHVwZGF0ZVNjaGVtYS5zYWZlUGFyc2UocmVxLmJvZHkpO1xuICAgICAgaWYgKCF2YWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCB1cGRhdGUgZGF0YScsXG4gICAgICAgICAgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvci5pc3N1ZXMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1cGRhdGVzID0gdmFsaWRhdGlvbi5kYXRhO1xuICAgICAgXG4gICAgICAvLyBIYW5kbGUgZmlsZSB1cGxvYWQgaWYgcHJlc2VudFxuICAgICAgaWYgKHJlcS5maWxlKSB7XG4gICAgICAgIHVwZGF0ZXMuZmlsZVBhdGggPSByZXEuZmlsZS5wYXRoO1xuICAgICAgICB1cGRhdGVzLmZpbGVOYW1lID0gcmVxLmZpbGUub3JpZ2luYWxuYW1lO1xuICAgICAgICB1cGRhdGVzLmZpbGVTaXplID0gcmVxLmZpbGUuc2l6ZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgZmVhdHVyZVJlcXVlc3QgPSBhd2FpdCBzdG9yYWdlLnVwZGF0ZUZlYXR1cmVSZXF1ZXN0KFxuICAgICAgICBpZCxcbiAgICAgICAgdXBkYXRlcyxcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGVcbiAgICAgICk7XG5cbiAgICAgIGlmICghZmVhdHVyZVJlcXVlc3QpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBub3QgZm91bmQgb3IgYWNjZXNzIGRlbmllZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+TnSBVcGRhdGVkIGZlYXR1cmUgcmVxdWVzdCAke2lkfSBieSB1c2VyICR7Y3VycmVudFVzZXIuaWR9YCk7XG4gICAgICByZXMuanNvbihmZWF0dXJlUmVxdWVzdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwZGF0aW5nIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIERFTEVURSAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkIC0gRGVsZXRlcyBhIGZlYXR1cmUgcmVxdWVzdC5cbiAgICogT25seSBhZG1pbnMgY2FuIGRlbGV0ZSBmZWF0dXJlIHJlcXVlc3RzLlxuICAgKi9cbiAgYXBwLmRlbGV0ZSgnL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gT25seSBhZG1pbnMgY2FuIGRlbGV0ZSBmZWF0dXJlIHJlcXVlc3RzXG4gICAgICBpZiAoY3VycmVudFVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnRm9yYmlkZGVuJyxcbiAgICAgICAgICBtZXNzYWdlOiAnT25seSBhZG1pbmlzdHJhdG9ycyBjYW4gZGVsZXRlIGZlYXR1cmUgcmVxdWVzdHMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IHN0b3JhZ2UuZGVsZXRlRmVhdHVyZVJlcXVlc3QoaWQsIGN1cnJlbnRVc2VyLmlkLCBjdXJyZW50VXNlci5yb2xlKTtcblxuICAgICAgaWYgKCFkZWxldGVkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3Qgbm90IGZvdW5kIG9yIGFjY2VzcyBkZW5pZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfl5HvuI8gRGVsZXRlZCBmZWF0dXJlIHJlcXVlc3QgJHtpZH0gYnkgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZGVsZXRpbmcgZmVhdHVyZSByZXF1ZXN0OicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGRlbGV0ZSBmZWF0dXJlIHJlcXVlc3QnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogR0VUIC9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQvZmlsZSAtIFNlcnZlcyB0aGUgZmlsZSBhdHRhY2htZW50IGZvciBhIGZlYXR1cmUgcmVxdWVzdC5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQvZmlsZScsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgeyBkb3dubG9hZCB9ID0gcmVxLnF1ZXJ5O1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IHRoZSBmZWF0dXJlIHJlcXVlc3QgdG8gY2hlY2sgZmlsZSBhdHRhY2htZW50XG4gICAgICBjb25zdCBmZWF0dXJlUmVxdWVzdCA9IGF3YWl0IHN0b3JhZ2UuZ2V0RmVhdHVyZVJlcXVlc3QoXG4gICAgICAgIGlkLFxuICAgICAgICBjdXJyZW50VXNlci5pZCxcbiAgICAgICAgY3VycmVudFVzZXIucm9sZSxcbiAgICAgICAgY3VycmVudFVzZXIub3JnYW5pemF0aW9uSWRcbiAgICAgICk7XG5cbiAgICAgIGlmICghZmVhdHVyZVJlcXVlc3QpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBub3QgZm91bmQgb3IgYWNjZXNzIGRlbmllZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBmZWF0dXJlIHJlcXVlc3QgaGFzIGEgZmlsZSBhdHRhY2htZW50XG4gICAgICBpZiAoIWZlYXR1cmVSZXF1ZXN0LmZpbGVQYXRoIHx8ICFmZWF0dXJlUmVxdWVzdC5maWxlTmFtZSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm8gZmlsZSBhdHRhY2htZW50JyxcbiAgICAgICAgICBtZXNzYWdlOiAnVGhpcyBmZWF0dXJlIHJlcXVlc3QgZG9lcyBub3QgaGF2ZSBhIGZpbGUgYXR0YWNobWVudCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmaWxlUGF0aCA9IGZlYXR1cmVSZXF1ZXN0LmZpbGVQYXRoO1xuICAgICAgY29uc3QgZmlsZU5hbWUgPSBmZWF0dXJlUmVxdWVzdC5maWxlTmFtZTtcbiAgICAgIFxuICAgICAgLy8gSGFuZGxlIGRpZmZlcmVudCBwYXRoIGZvcm1hdHMgKGFic29sdXRlIHZzIHJlbGF0aXZlKVxuICAgICAgY29uc3QgZnVsbEZpbGVQYXRoID0gcGF0aC5pc0Fic29sdXRlKGZpbGVQYXRoKSBcbiAgICAgICAgPyBmaWxlUGF0aCBcbiAgICAgICAgOiBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3VwbG9hZHMnLCBmaWxlUGF0aCk7XG5cbiAgICAgIC8vIENoZWNrIGlmIGZpbGUgZXhpc3RzIG9uIGRpc2tcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmdWxsRmlsZVBhdGgpKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBGaWxlIG5vdCBmb3VuZCBvbiBkaXNrOiAke2Z1bGxGaWxlUGF0aH1gKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0ZpbGUgbm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnVGhlIGZpbGUgYXR0YWNobWVudCBjb3VsZCBub3QgYmUgZm91bmQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfk44gU2VydmluZyBmaWxlIGZvciBmZWF0dXJlIHJlcXVlc3QgJHtpZH06ICR7ZmlsZU5hbWV9YCk7XG5cbiAgICAgIC8vIERldGVjdCBNSU1FIHR5cGUgYmFzZWQgb24gZmlsZSBleHRlbnNpb25cbiAgICAgIGNvbnN0IGdldENvbnRlbnRUeXBlID0gKGZpbGVuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgZXh0ID0gZmlsZW5hbWUudG9Mb3dlckNhc2UoKS5zcGxpdCgnLicpLnBvcCgpO1xuICAgICAgICBzd2l0Y2ggKGV4dCkge1xuICAgICAgICAgIGNhc2UgJ3BkZic6IHJldHVybiAnYXBwbGljYXRpb24vcGRmJztcbiAgICAgICAgICBjYXNlICdqcGcnOiBjYXNlICdqcGVnJzogcmV0dXJuICdpbWFnZS9qcGVnJztcbiAgICAgICAgICBjYXNlICdwbmcnOiByZXR1cm4gJ2ltYWdlL3BuZyc7XG4gICAgICAgICAgY2FzZSAnZ2lmJzogcmV0dXJuICdpbWFnZS9naWYnO1xuICAgICAgICAgIGNhc2UgJ2RvYyc6IHJldHVybiAnYXBwbGljYXRpb24vbXN3b3JkJztcbiAgICAgICAgICBjYXNlICdkb2N4JzogcmV0dXJuICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQud29yZHByb2Nlc3NpbmdtbC5kb2N1bWVudCc7XG4gICAgICAgICAgY2FzZSAndHh0JzogcmV0dXJuICd0ZXh0L3BsYWluJztcbiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIC8vIFNldCBwcm9wZXIgY29udGVudCB0eXBlIGZvciB2aWV3aW5nXG4gICAgICBjb25zdCBjb250ZW50VHlwZSA9IGdldENvbnRlbnRUeXBlKGZpbGVOYW1lKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGNvbnRlbnRUeXBlKTtcbiAgICAgIFxuICAgICAgLy8gUHJvcGVybHkgZW5jb2RlIGZpbGVuYW1lIGZvciBGcmVuY2ggY2hhcmFjdGVycyBhbmQgb3RoZXIgc3BlY2lhbCBjaGFyYWN0ZXJzXG4gICAgICBjb25zdCBlbmNvZGVkRmlsZW5hbWUgPSBCdWZmZXIuZnJvbShmaWxlTmFtZSwgJ3V0ZjgnKS50b1N0cmluZygnYmluYXJ5Jyk7XG4gICAgICBcbiAgICAgIGlmIChkb3dubG9hZCA9PT0gJ3RydWUnKSB7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCBgYXR0YWNobWVudDsgZmlsZW5hbWU9XCIke2VuY29kZWRGaWxlbmFtZX1cIjsgZmlsZW5hbWUqPVVURi04Jycke2VuY29kZVVSSUNvbXBvbmVudChmaWxlTmFtZSl9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgYGlubGluZTsgZmlsZW5hbWU9XCIke2VuY29kZWRGaWxlbmFtZX1cIjsgZmlsZW5hbWUqPVVURi04Jycke2VuY29kZVVSSUNvbXBvbmVudChmaWxlTmFtZSl9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFN0cmVhbSB0aGUgZmlsZVxuICAgICAgY29uc3QgZmlsZVN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oZnVsbEZpbGVQYXRoKTtcbiAgICAgIGZpbGVTdHJlYW0ucGlwZShyZXMpO1xuXG4gICAgICBmaWxlU3RyZWFtLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJyb3Igc3RyZWFtaW5nIGZpbGUgZm9yIGZlYXR1cmUgcmVxdWVzdCAke2lkfTpgLCBlcnJvcik7XG4gICAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBzdHJlYW0gZmlsZScgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBzZXJ2aW5nIGZlYXR1cmUgcmVxdWVzdCBmaWxlOicsIGVycm9yKTtcbiAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBzZXJ2ZSBmaWxlJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogUE9TVCAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkL3Vwdm90ZSAtIFVwdm90ZXMgYSBmZWF0dXJlIHJlcXVlc3QuXG4gICAqIFVzZXJzIGNhbiB1cHZvdGUgYW55IGZlYXR1cmUgcmVxdWVzdCAob25seSBvbmNlIHBlciB1c2VyKS5cbiAgICovXG4gIGFwcC5wb3N0KCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkL3Vwdm90ZScsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHVwdm90ZSBkYXRhXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gaW5zZXJ0RmVhdHVyZVJlcXVlc3RVcHZvdGVTY2hlbWEuc2FmZVBhcnNlKHtcbiAgICAgICAgZmVhdHVyZVJlcXVlc3RJZDogaWQsXG4gICAgICAgIHVzZXJJZDogY3VycmVudFVzZXIuaWQsXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF2YWxpZGF0aW9uLnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCB1cHZvdGUgZGF0YScsXG4gICAgICAgICAgZGV0YWlsczogdmFsaWRhdGlvbi5lcnJvci5pc3N1ZXMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1cHZvdGVEYXRhID0gdmFsaWRhdGlvbi5kYXRhO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3RvcmFnZS51cHZvdGVGZWF0dXJlUmVxdWVzdCh1cHZvdGVEYXRhKTtcblxuICAgICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnVXB2b3RlIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogcmVzdWx0Lm1lc3NhZ2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+RjSBVc2VyICR7Y3VycmVudFVzZXIuaWR9IHVwdm90ZWQgZmVhdHVyZSByZXF1ZXN0ICR7aWR9YCk7XG4gICAgICByZXMuanNvbihyZXN1bHQuZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwdm90aW5nIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cHZvdGUgZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIERFTEVURSAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkL3Vwdm90ZSAtIFJlbW92ZXMgYW4gdXB2b3RlIGZyb20gYSBmZWF0dXJlIHJlcXVlc3QuXG4gICAqIFVzZXJzIGNhbiByZW1vdmUgdGhlaXIgb3duIHVwdm90ZS5cbiAgICovXG4gIGFwcC5kZWxldGUoJy9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQvdXB2b3RlJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuXG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdCYWQgcmVxdWVzdCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBJRCBpcyByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdG9yYWdlLnJlbW92ZUZlYXR1cmVSZXF1ZXN0VXB2b3RlKGlkLCBjdXJyZW50VXNlci5pZCk7XG5cbiAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ1JlbW92ZSB1cHZvdGUgZmFpbGVkJyxcbiAgICAgICAgICBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5GOIFVzZXIgJHtjdXJyZW50VXNlci5pZH0gcmVtb3ZlZCB1cHZvdGUgZnJvbSBmZWF0dXJlIHJlcXVlc3QgJHtpZH1gKTtcbiAgICAgIHJlcy5qc29uKHJlc3VsdC5kYXRhKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgcmVtb3ZpbmcgdXB2b3RlIGZyb20gZmVhdHVyZSByZXF1ZXN0OicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHJlbW92ZSB1cHZvdGUgZnJvbSBmZWF0dXJlIHJlcXVlc3QnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==