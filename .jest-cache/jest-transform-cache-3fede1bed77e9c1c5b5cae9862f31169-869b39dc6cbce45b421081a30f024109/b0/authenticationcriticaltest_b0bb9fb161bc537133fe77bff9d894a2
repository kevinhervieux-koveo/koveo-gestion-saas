bd1051926ca908541a375549ac0700b6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const db_1 = require("../../server/db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
/**
 * Critical Authentication Test Suite
 *
 * This test MUST catch critical authentication failures that prevent users
 * from accessing the application. It validates:
 * - Essential user accounts exist
 * - Login endpoints are functional
 * - Database connectivity is working
 * - Authentication flow is complete
 */
(0, globals_1.describe)('CRITICAL Authentication System', () => {
    (0, globals_1.describe)('Database User Existence', () => {
        (0, globals_1.it)('CRITICAL: should have at least one active user in the system', async () => {
            const userCount = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)::int` })
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.isActive, true))
                .then(result => result[0]?.count || 0);
            // CRITICAL FAILURE if no users exist
            if (userCount === 0) {
                throw new Error(`
ðŸš¨ CRITICAL AUTHENTICATION FAILURE ðŸš¨
No active users found in database!

This means:
- Nobody can login to the application
- The system is completely inaccessible
- All authentication will fail with 401 errors

Required Action: Create at least one user account immediately
        `);
            }
            (0, globals_1.expect)(userCount).toBeGreaterThan(0);
        });
        (0, globals_1.it)('CRITICAL: should verify admin or manager users exist', async () => {
            // Check for any admin or manager user account (more flexible than specific email)
            const adminUsers = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.sql) `role IN ('admin', 'manager') AND is_active = true`)
                .then(results => results);
            if (adminUsers.length === 0) {
                throw new Error(`
ðŸš¨ NO ADMIN/MANAGER ACCOUNTS FOUND ðŸš¨
No active admin or manager accounts found in the database!

This prevents administrative access to the application.
Required Action: Create at least one admin or manager account immediately
        `);
            }
            (0, globals_1.expect)(adminUsers.length).toBeGreaterThan(0);
            (0, globals_1.expect)(adminUsers.some(user => user.isActive)).toBe(true);
            (0, globals_1.expect)(adminUsers.some(user => ['admin', 'manager'].includes(user.role))).toBe(true);
        });
        (0, globals_1.it)('CRITICAL: should have working user table structure', async () => {
            // Verify the users table exists and has correct structure
            const tableExists = await db_1.db
                .select()
                .from(schema_1.users)
                .limit(1)
                .catch(() => null);
            if (tableExists === null) {
                throw new Error(`
ðŸš¨ DATABASE STRUCTURE FAILURE ðŸš¨
Users table is inaccessible or corrupted!

This means the authentication system cannot function.
Required Action: Fix database schema immediately
        `);
            }
            // Should not throw error
            (0, globals_1.expect)(tableExists).not.toBeNull();
        });
    });
    (0, globals_1.describe)('Authentication Endpoint Functionality', () => {
        (0, globals_1.it)('CRITICAL: login endpoint should be accessible and functional', async () => {
            // Test that the login endpoint exists and responds
            let response;
            let error = null;
            try {
                response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'wrongpassword'
                    })
                });
            }
            catch (e) {
                error = e;
            }
            if (error || !response) {
                throw new Error(`
ðŸš¨ LOGIN ENDPOINT FAILURE ðŸš¨
Login endpoint is not accessible or server is down!

Error: ${error instanceof Error ? error.message : 'No response received'}
Required Action: Fix server startup or routing immediately
        `);
            }
            // Should return proper HTTP response (even if 401 for wrong credentials)
            (0, globals_1.expect)(response.status).toBeGreaterThan(0);
            (0, globals_1.expect)(response.status).not.toBe(404); // Endpoint should exist
        });
        (0, globals_1.it)('CRITICAL: user endpoint should be accessible', async () => {
            let response;
            let error = null;
            try {
                response = await fetch('http://localhost:5000/api/auth/user');
            }
            catch (e) {
                error = e;
            }
            if (error || !response) {
                throw new Error(`
ðŸš¨ USER ENDPOINT FAILURE ðŸš¨
User authentication endpoint is not accessible!

Error: ${error instanceof Error ? error.message : 'No response received'}
Required Action: Fix authentication routes immediately
        `);
            }
            (0, globals_1.expect)(response.status).toBeGreaterThan(0);
            (0, globals_1.expect)(response.status).not.toBe(404); // Endpoint should exist
        });
    });
    (0, globals_1.describe)('Authentication Flow Validation', () => {
        let testUserEmail = 'critical-test@koveo.com';
        let testUserId;
        (0, globals_1.beforeAll)(async () => {
            // Create a test user for authentication flow testing
            const testUser = await db_1.db.insert(schema_1.users).values({
                username: 'criticaltest',
                email: testUserEmail,
                password: '$2b$10$MmG3jXpKuT44AMynBAe9JutoL6eSvKvlJ/za/lSY9AFp/J7sB5HYG', // test123
                firstName: 'Critical',
                lastName: 'Test',
                role: 'manager',
                language: 'en',
                isActive: true
            }).returning({ id: schema_1.users.id });
            testUserId = testUser[0].id;
        });
        (0, globals_1.afterAll)(async () => {
            // Clean up test user
            await db_1.db.delete(schema_1.users).where((0, drizzle_orm_1.eq)(schema_1.users.id, testUserId));
        });
        (0, globals_1.it)('CRITICAL: complete login flow should work end-to-end', async () => {
            // Test complete authentication flow
            const loginResponse = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: testUserEmail,
                    password: 'test123'
                })
            });
            if (!loginResponse.ok) {
                const errorData = await loginResponse.json().catch(() => ({}));
                throw new Error(`
ðŸš¨ LOGIN FLOW FAILURE ðŸš¨
Authentication login failed for valid user!

Status: ${loginResponse.status}
Error: ${JSON.stringify(errorData)}
User: ${testUserEmail}

This means users cannot login even with correct credentials.
Required Action: Fix authentication logic immediately
        `);
            }
            const loginData = await loginResponse.json();
            (0, globals_1.expect)(loginData.message).toBe('Login successful');
            (0, globals_1.expect)(loginData.user).toBeDefined();
            (0, globals_1.expect)(loginData.user.email).toBe(testUserEmail);
            // Get session cookie for next request
            const cookies = loginResponse.headers.get('set-cookie');
            (0, globals_1.expect)(cookies).toBeDefined();
            // Test that user endpoint works with session
            const userResponse = await fetch('http://localhost:5000/api/auth/user', {
                headers: {
                    'Cookie': cookies || ''
                }
            });
            if (!userResponse.ok) {
                throw new Error(`
ðŸš¨ SESSION PERSISTENCE FAILURE ðŸš¨
User cannot stay logged in - session not working!

Login succeeds but user endpoint fails with session.
Status: ${userResponse.status}
Required Action: Fix session management immediately
        `);
            }
            const userData = await userResponse.json();
            (0, globals_1.expect)(userData.id).toBeDefined();
            (0, globals_1.expect)(userData.email).toBe(testUserEmail);
        });
        (0, globals_1.it)('CRITICAL: should validate password hashing is working', async () => {
            const testUser = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.email, testUserEmail))
                .then(results => results[0]);
            (0, globals_1.expect)(testUser).toBeDefined();
            (0, globals_1.expect)(testUser.password).toBeDefined();
            (0, globals_1.expect)(testUser.password.startsWith('$2')).toBe(true); // bcrypt format
            // Verify password is not stored in plain text
            (0, globals_1.expect)(testUser.password).not.toBe('test123');
            (0, globals_1.expect)(testUser.password.length).toBeGreaterThan(10);
        });
    });
    (0, globals_1.describe)('Production Readiness Checks', () => {
        (0, globals_1.it)('CRITICAL: should ensure application is accessible', async () => {
            // Test that the main application responds
            let healthResponse;
            try {
                healthResponse = await fetch('http://localhost:5000/api/health');
            }
            catch (error) {
                throw new Error(`
ðŸš¨ APPLICATION INACCESSIBLE ðŸš¨
Application server is not responding!

Error: ${error.message}
Required Action: Fix server startup immediately
        `);
            }
            (0, globals_1.expect)(healthResponse.ok).toBe(true);
            const healthData = await healthResponse.json();
            (0, globals_1.expect)(healthData.status).toBe('ok');
        });
        (0, globals_1.it)('CRITICAL: database connection should be working', async () => {
            try {
                const dbTest = await db_1.db.select({ version: (0, drizzle_orm_1.sql) `version()` }).from(schema_1.users).limit(1);
                (0, globals_1.expect)(dbTest).toBeDefined();
                (0, globals_1.expect)(Array.isArray(dbTest)).toBe(true);
            }
            catch (error) {
                throw new Error(`
ðŸš¨ DATABASE CONNECTION FAILURE ðŸš¨
Cannot connect to database!

Error: ${error instanceof Error ? error.message : 'Unknown error'}
Required Action: Fix database connection immediately
        `);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9jcml0aWNhbC9hdXRoZW50aWNhdGlvbi1jcml0aWNhbC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTBFO0FBQzFFLHdDQUFxQztBQUNyQyxnREFBNEM7QUFDNUMsNkNBQXNDO0FBRXRDOzs7Ozs7Ozs7R0FTRztBQUVILElBQUEsa0JBQVEsRUFBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7SUFDOUMsSUFBQSxrQkFBUSxFQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtRQUN2QyxJQUFBLFlBQUUsRUFBQyw4REFBOEQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1RSxNQUFNLFNBQVMsR0FBRyxNQUFNLE9BQUU7aUJBQ3ZCLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFBLGlCQUFHLEVBQVEsZUFBZSxFQUFFLENBQUM7aUJBQzdDLElBQUksQ0FBQyxjQUFLLENBQUM7aUJBQ1gsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxjQUFLLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRXpDLHFDQUFxQztZQUNyQyxJQUFJLFNBQVMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQzs7Ozs7Ozs7OztTQVVmLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxZQUFFLEVBQUMsc0RBQXNELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDcEUsa0ZBQWtGO1lBQ2xGLE1BQU0sVUFBVSxHQUFHLE1BQU0sT0FBRTtpQkFDeEIsTUFBTSxFQUFFO2lCQUNSLElBQUksQ0FBQyxjQUFLLENBQUM7aUJBQ1gsS0FBSyxDQUFDLElBQUEsaUJBQUcsRUFBQSxtREFBbUQsQ0FBQztpQkFDN0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFNUIsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUM1QixNQUFNLElBQUksS0FBSyxDQUFDOzs7Ozs7U0FNZixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBQSxnQkFBTSxFQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsSUFBQSxnQkFBTSxFQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUQsSUFBQSxnQkFBTSxFQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkYsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyxvREFBb0QsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRSwwREFBMEQ7WUFDMUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFFO2lCQUN6QixNQUFNLEVBQUU7aUJBQ1IsSUFBSSxDQUFDLGNBQUssQ0FBQztpQkFDWCxLQUFLLENBQUMsQ0FBQyxDQUFDO2lCQUNSLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVyQixJQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQzs7Ozs7O1NBTWYsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELHlCQUF5QjtZQUN6QixJQUFBLGdCQUFNLEVBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLGtCQUFRLEVBQUMsdUNBQXVDLEVBQUUsR0FBRyxFQUFFO1FBQ3JELElBQUEsWUFBRSxFQUFDLDhEQUE4RCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVFLG1EQUFtRDtZQUNuRCxJQUFJLFFBQVEsQ0FBQztZQUNiLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztZQUVqQixJQUFJLENBQUM7Z0JBQ0gsUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLHNDQUFzQyxFQUFFO29CQUM3RCxNQUFNLEVBQUUsTUFBTTtvQkFDZCxPQUFPLEVBQUU7d0JBQ1AsY0FBYyxFQUFFLGtCQUFrQjtxQkFDbkM7b0JBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7d0JBQ25CLEtBQUssRUFBRSxrQkFBa0I7d0JBQ3pCLFFBQVEsRUFBRSxlQUFlO3FCQUMxQixDQUFDO2lCQUNILENBQUMsQ0FBQztZQUNMLENBQUM7WUFBQyxPQUFPLENBQVUsRUFBRSxDQUFDO2dCQUNwQixLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ1osQ0FBQztZQUVELElBQUksS0FBSyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUM7Ozs7U0FJZixLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxzQkFBc0I7O1NBRS9ELENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCx5RUFBeUU7WUFDekUsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsd0JBQXdCO1FBQ2pFLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxZQUFFLEVBQUMsOENBQThDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUQsSUFBSSxRQUFRLENBQUM7WUFDYixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7WUFFakIsSUFBSSxDQUFDO2dCQUNILFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1lBQ2hFLENBQUM7WUFBQyxPQUFPLENBQVUsRUFBRSxDQUFDO2dCQUNwQixLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ1osQ0FBQztZQUVELElBQUksS0FBSyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUM7Ozs7U0FJZixLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxzQkFBc0I7O1NBRS9ELENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyx3QkFBd0I7UUFDakUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsa0JBQVEsRUFBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7UUFDOUMsSUFBSSxhQUFhLEdBQUcseUJBQXlCLENBQUM7UUFDOUMsSUFBSSxVQUFrQixDQUFDO1FBRXZCLElBQUEsbUJBQVMsRUFBQyxLQUFLLElBQUksRUFBRTtZQUNuQixxREFBcUQ7WUFDckQsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFLENBQUMsTUFBTSxDQUFDLGNBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQztnQkFDN0MsUUFBUSxFQUFFLGNBQWM7Z0JBQ3hCLEtBQUssRUFBRSxhQUFhO2dCQUNwQixRQUFRLEVBQUUsOERBQThELEVBQUUsVUFBVTtnQkFDcEYsU0FBUyxFQUFFLFVBQVU7Z0JBQ3JCLFFBQVEsRUFBRSxNQUFNO2dCQUNoQixJQUFJLEVBQUUsU0FBUztnQkFDZixRQUFRLEVBQUUsSUFBSTtnQkFDZCxRQUFRLEVBQUUsSUFBSTthQUNmLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsY0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFL0IsVUFBVSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLGtCQUFRLEVBQUMsS0FBSyxJQUFJLEVBQUU7WUFDbEIscUJBQXFCO1lBQ3JCLE1BQU0sT0FBRSxDQUFDLE1BQU0sQ0FBQyxjQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGNBQUssQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsWUFBRSxFQUFDLHNEQUFzRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3BFLG9DQUFvQztZQUNwQyxNQUFNLGFBQWEsR0FBRyxNQUFNLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRTtnQkFDeEUsTUFBTSxFQUFFLE1BQU07Z0JBQ2QsT0FBTyxFQUFFO29CQUNQLGNBQWMsRUFBRSxrQkFBa0I7aUJBQ25DO2dCQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUNuQixLQUFLLEVBQUUsYUFBYTtvQkFDcEIsUUFBUSxFQUFFLFNBQVM7aUJBQ3BCLENBQUM7YUFDSCxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN0QixNQUFNLFNBQVMsR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLElBQUksS0FBSyxDQUFDOzs7O1VBSWQsYUFBYSxDQUFDLE1BQU07U0FDckIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7UUFDMUIsYUFBYTs7OztTQUlaLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLFNBQVMsR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM3QyxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ25ELElBQUEsZ0JBQU0sRUFBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckMsSUFBQSxnQkFBTSxFQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRWpELHNDQUFzQztZQUN0QyxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN4RCxJQUFBLGdCQUFNLEVBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFOUIsNkNBQTZDO1lBQzdDLE1BQU0sWUFBWSxHQUFHLE1BQU0sS0FBSyxDQUFDLHFDQUFxQyxFQUFFO2dCQUN0RSxPQUFPLEVBQUU7b0JBQ1AsUUFBUSxFQUFFLE9BQU8sSUFBSSxFQUFFO2lCQUN4QjthQUNGLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUM7Ozs7O1VBS2QsWUFBWSxDQUFDLE1BQU07O1NBRXBCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMzQyxJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2xDLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBQSxZQUFFLEVBQUMsdURBQXVELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckUsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFO2lCQUN0QixNQUFNLEVBQUU7aUJBQ1IsSUFBSSxDQUFDLGNBQUssQ0FBQztpQkFDWCxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGNBQUssQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7aUJBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRS9CLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMvQixJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3hDLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGdCQUFnQjtZQUV2RSw4Q0FBOEM7WUFDOUMsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlDLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRTtRQUMzQyxJQUFBLFlBQUUsRUFBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRSwwQ0FBMEM7WUFDMUMsSUFBSSxjQUFjLENBQUM7WUFFbkIsSUFBSSxDQUFDO2dCQUNILGNBQWMsR0FBRyxNQUFNLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ25FLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLE1BQU0sSUFBSSxLQUFLLENBQUM7Ozs7U0FJZixLQUFLLENBQUMsT0FBTzs7U0FFYixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFckMsTUFBTSxVQUFVLEdBQUcsTUFBTSxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDL0MsSUFBQSxnQkFBTSxFQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyxpREFBaUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMvRCxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUEsaUJBQUcsRUFBUSxXQUFXLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pGLElBQUEsZ0JBQU0sRUFBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDN0IsSUFBQSxnQkFBTSxFQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQzs7OztTQUlmLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7O1NBRXhELENBQUMsQ0FBQztZQUNMLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9jcml0aWNhbC9hdXRoZW50aWNhdGlvbi1jcml0aWNhbC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVBbGwsIGFmdGVyQWxsIH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uLy4uL3NlcnZlci9kYic7XG5pbXBvcnQgeyB1c2VycyB9IGZyb20gJy4uLy4uL3NoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgZXEsIHNxbCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcblxuLyoqXG4gKiBDcml0aWNhbCBBdXRoZW50aWNhdGlvbiBUZXN0IFN1aXRlXG4gKiBcbiAqIFRoaXMgdGVzdCBNVVNUIGNhdGNoIGNyaXRpY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWx1cmVzIHRoYXQgcHJldmVudCB1c2Vyc1xuICogZnJvbSBhY2Nlc3NpbmcgdGhlIGFwcGxpY2F0aW9uLiBJdCB2YWxpZGF0ZXM6XG4gKiAtIEVzc2VudGlhbCB1c2VyIGFjY291bnRzIGV4aXN0XG4gKiAtIExvZ2luIGVuZHBvaW50cyBhcmUgZnVuY3Rpb25hbFxuICogLSBEYXRhYmFzZSBjb25uZWN0aXZpdHkgaXMgd29ya2luZ1xuICogLSBBdXRoZW50aWNhdGlvbiBmbG93IGlzIGNvbXBsZXRlXG4gKi9cblxuZGVzY3JpYmUoJ0NSSVRJQ0FMIEF1dGhlbnRpY2F0aW9uIFN5c3RlbScsICgpID0+IHtcbiAgZGVzY3JpYmUoJ0RhdGFiYXNlIFVzZXIgRXhpc3RlbmNlJywgKCkgPT4ge1xuICAgIGl0KCdDUklUSUNBTDogc2hvdWxkIGhhdmUgYXQgbGVhc3Qgb25lIGFjdGl2ZSB1c2VyIGluIHRoZSBzeXN0ZW0nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyQ291bnQgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHsgY291bnQ6IHNxbDxudW1iZXI+YGNvdW50KCopOjppbnRgIH0pXG4gICAgICAgIC5mcm9tKHVzZXJzKVxuICAgICAgICAud2hlcmUoZXEodXNlcnMuaXNBY3RpdmUsIHRydWUpKVxuICAgICAgICAudGhlbihyZXN1bHQgPT4gcmVzdWx0WzBdPy5jb3VudCB8fCAwKTtcblxuICAgICAgLy8gQ1JJVElDQUwgRkFJTFVSRSBpZiBubyB1c2VycyBleGlzdFxuICAgICAgaWYgKHVzZXJDb3VudCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFxu8J+aqCBDUklUSUNBTCBBVVRIRU5USUNBVElPTiBGQUlMVVJFIPCfmqhcbk5vIGFjdGl2ZSB1c2VycyBmb3VuZCBpbiBkYXRhYmFzZSFcblxuVGhpcyBtZWFuczpcbi0gTm9ib2R5IGNhbiBsb2dpbiB0byB0aGUgYXBwbGljYXRpb25cbi0gVGhlIHN5c3RlbSBpcyBjb21wbGV0ZWx5IGluYWNjZXNzaWJsZVxuLSBBbGwgYXV0aGVudGljYXRpb24gd2lsbCBmYWlsIHdpdGggNDAxIGVycm9yc1xuXG5SZXF1aXJlZCBBY3Rpb246IENyZWF0ZSBhdCBsZWFzdCBvbmUgdXNlciBhY2NvdW50IGltbWVkaWF0ZWx5XG4gICAgICAgIGApO1xuICAgICAgfVxuXG4gICAgICBleHBlY3QodXNlckNvdW50KS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnQ1JJVElDQUw6IHNob3VsZCB2ZXJpZnkgYWRtaW4gb3IgbWFuYWdlciB1c2VycyBleGlzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENoZWNrIGZvciBhbnkgYWRtaW4gb3IgbWFuYWdlciB1c2VyIGFjY291bnQgKG1vcmUgZmxleGlibGUgdGhhbiBzcGVjaWZpYyBlbWFpbClcbiAgICAgIGNvbnN0IGFkbWluVXNlcnMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgLmZyb20odXNlcnMpXG4gICAgICAgIC53aGVyZShzcWxgcm9sZSBJTiAoJ2FkbWluJywgJ21hbmFnZXInKSBBTkQgaXNfYWN0aXZlID0gdHJ1ZWApXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4gcmVzdWx0cyk7XG5cbiAgICAgIGlmIChhZG1pblVzZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFxu8J+aqCBOTyBBRE1JTi9NQU5BR0VSIEFDQ09VTlRTIEZPVU5EIPCfmqhcbk5vIGFjdGl2ZSBhZG1pbiBvciBtYW5hZ2VyIGFjY291bnRzIGZvdW5kIGluIHRoZSBkYXRhYmFzZSFcblxuVGhpcyBwcmV2ZW50cyBhZG1pbmlzdHJhdGl2ZSBhY2Nlc3MgdG8gdGhlIGFwcGxpY2F0aW9uLlxuUmVxdWlyZWQgQWN0aW9uOiBDcmVhdGUgYXQgbGVhc3Qgb25lIGFkbWluIG9yIG1hbmFnZXIgYWNjb3VudCBpbW1lZGlhdGVseVxuICAgICAgICBgKTtcbiAgICAgIH1cblxuICAgICAgZXhwZWN0KGFkbWluVXNlcnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3QoYWRtaW5Vc2Vycy5zb21lKHVzZXIgPT4gdXNlci5pc0FjdGl2ZSkpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYWRtaW5Vc2Vycy5zb21lKHVzZXIgPT4gWydhZG1pbicsICdtYW5hZ2VyJ10uaW5jbHVkZXModXNlci5yb2xlKSkpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnQ1JJVElDQUw6IHNob3VsZCBoYXZlIHdvcmtpbmcgdXNlciB0YWJsZSBzdHJ1Y3R1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBWZXJpZnkgdGhlIHVzZXJzIHRhYmxlIGV4aXN0cyBhbmQgaGFzIGNvcnJlY3Qgc3RydWN0dXJlXG4gICAgICBjb25zdCB0YWJsZUV4aXN0cyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbSh1c2VycylcbiAgICAgICAgLmxpbWl0KDEpXG4gICAgICAgIC5jYXRjaCgoKSA9PiBudWxsKTtcblxuICAgICAgaWYgKHRhYmxlRXhpc3RzID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgXG7wn5qoIERBVEFCQVNFIFNUUlVDVFVSRSBGQUlMVVJFIPCfmqhcblVzZXJzIHRhYmxlIGlzIGluYWNjZXNzaWJsZSBvciBjb3JydXB0ZWQhXG5cblRoaXMgbWVhbnMgdGhlIGF1dGhlbnRpY2F0aW9uIHN5c3RlbSBjYW5ub3QgZnVuY3Rpb24uXG5SZXF1aXJlZCBBY3Rpb246IEZpeCBkYXRhYmFzZSBzY2hlbWEgaW1tZWRpYXRlbHlcbiAgICAgICAgYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNob3VsZCBub3QgdGhyb3cgZXJyb3JcbiAgICAgIGV4cGVjdCh0YWJsZUV4aXN0cykubm90LnRvQmVOdWxsKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBdXRoZW50aWNhdGlvbiBFbmRwb2ludCBGdW5jdGlvbmFsaXR5JywgKCkgPT4ge1xuICAgIGl0KCdDUklUSUNBTDogbG9naW4gZW5kcG9pbnQgc2hvdWxkIGJlIGFjY2Vzc2libGUgYW5kIGZ1bmN0aW9uYWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUZXN0IHRoYXQgdGhlIGxvZ2luIGVuZHBvaW50IGV4aXN0cyBhbmQgcmVzcG9uZHNcbiAgICAgIGxldCByZXNwb25zZTtcbiAgICAgIGxldCBlcnJvciA9IG51bGw7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHA6Ly9sb2NhbGhvc3Q6NTAwMC9hcGkvYXV0aC9sb2dpbicsIHtcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgICAgIHBhc3N3b3JkOiAnd3JvbmdwYXNzd29yZCdcbiAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGU6IHVua25vd24pIHtcbiAgICAgICAgZXJyb3IgPSBlO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXJyb3IgfHwgIXJlc3BvbnNlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgXG7wn5qoIExPR0lOIEVORFBPSU5UIEZBSUxVUkUg8J+aqFxuTG9naW4gZW5kcG9pbnQgaXMgbm90IGFjY2Vzc2libGUgb3Igc2VydmVyIGlzIGRvd24hXG5cbkVycm9yOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ05vIHJlc3BvbnNlIHJlY2VpdmVkJ31cblJlcXVpcmVkIEFjdGlvbjogRml4IHNlcnZlciBzdGFydHVwIG9yIHJvdXRpbmcgaW1tZWRpYXRlbHlcbiAgICAgICAgYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNob3VsZCByZXR1cm4gcHJvcGVyIEhUVFAgcmVzcG9uc2UgKGV2ZW4gaWYgNDAxIGZvciB3cm9uZyBjcmVkZW50aWFscylcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLm5vdC50b0JlKDQwNCk7IC8vIEVuZHBvaW50IHNob3VsZCBleGlzdFxuICAgIH0pO1xuXG4gICAgaXQoJ0NSSVRJQ0FMOiB1c2VyIGVuZHBvaW50IHNob3VsZCBiZSBhY2Nlc3NpYmxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgbGV0IGVycm9yID0gbnVsbDtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS9hdXRoL3VzZXInKTtcbiAgICAgIH0gY2F0Y2ggKGU6IHVua25vd24pIHtcbiAgICAgICAgZXJyb3IgPSBlO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXJyb3IgfHwgIXJlc3BvbnNlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgXG7wn5qoIFVTRVIgRU5EUE9JTlQgRkFJTFVSRSDwn5qoXG5Vc2VyIGF1dGhlbnRpY2F0aW9uIGVuZHBvaW50IGlzIG5vdCBhY2Nlc3NpYmxlIVxuXG5FcnJvcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdObyByZXNwb25zZSByZWNlaXZlZCd9XG5SZXF1aXJlZCBBY3Rpb246IEZpeCBhdXRoZW50aWNhdGlvbiByb3V0ZXMgaW1tZWRpYXRlbHlcbiAgICAgICAgYCk7XG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLm5vdC50b0JlKDQwNCk7IC8vIEVuZHBvaW50IHNob3VsZCBleGlzdFxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQXV0aGVudGljYXRpb24gRmxvdyBWYWxpZGF0aW9uJywgKCkgPT4ge1xuICAgIGxldCB0ZXN0VXNlckVtYWlsID0gJ2NyaXRpY2FsLXRlc3RAa292ZW8uY29tJztcbiAgICBsZXQgdGVzdFVzZXJJZDogc3RyaW5nO1xuXG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBhIHRlc3QgdXNlciBmb3IgYXV0aGVudGljYXRpb24gZmxvdyB0ZXN0aW5nXG4gICAgICBjb25zdCB0ZXN0VXNlciA9IGF3YWl0IGRiLmluc2VydCh1c2VycykudmFsdWVzKHtcbiAgICAgICAgdXNlcm5hbWU6ICdjcml0aWNhbHRlc3QnLFxuICAgICAgICBlbWFpbDogdGVzdFVzZXJFbWFpbCxcbiAgICAgICAgcGFzc3dvcmQ6ICckMmIkMTAkTW1HM2pYcEt1VDQ0QU15bkJBZTlKdXRvTDZlU3ZLdmxKL3phL2xTWTlBRnAvSjdzQjVIWUcnLCAvLyB0ZXN0MTIzXG4gICAgICAgIGZpcnN0TmFtZTogJ0NyaXRpY2FsJyxcbiAgICAgICAgbGFzdE5hbWU6ICdUZXN0JyxcbiAgICAgICAgcm9sZTogJ21hbmFnZXInLFxuICAgICAgICBsYW5ndWFnZTogJ2VuJyxcbiAgICAgICAgaXNBY3RpdmU6IHRydWVcbiAgICAgIH0pLnJldHVybmluZyh7IGlkOiB1c2Vycy5pZCB9KTtcblxuICAgICAgdGVzdFVzZXJJZCA9IHRlc3RVc2VyWzBdLmlkO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ2xlYW4gdXAgdGVzdCB1c2VyXG4gICAgICBhd2FpdCBkYi5kZWxldGUodXNlcnMpLndoZXJlKGVxKHVzZXJzLmlkLCB0ZXN0VXNlcklkKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnQ1JJVElDQUw6IGNvbXBsZXRlIGxvZ2luIGZsb3cgc2hvdWxkIHdvcmsgZW5kLXRvLWVuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFRlc3QgY29tcGxldGUgYXV0aGVudGljYXRpb24gZmxvd1xuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL2F1dGgvbG9naW4nLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlckVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAndGVzdDEyMydcbiAgICAgICAgfSlcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWxvZ2luUmVzcG9uc2Uub2spIHtcbiAgICAgICAgY29uc3QgZXJyb3JEYXRhID0gYXdhaXQgbG9naW5SZXNwb25zZS5qc29uKCkuY2F0Y2goKCkgPT4gKHt9KSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgXG7wn5qoIExPR0lOIEZMT1cgRkFJTFVSRSDwn5qoXG5BdXRoZW50aWNhdGlvbiBsb2dpbiBmYWlsZWQgZm9yIHZhbGlkIHVzZXIhXG5cblN0YXR1czogJHtsb2dpblJlc3BvbnNlLnN0YXR1c31cbkVycm9yOiAke0pTT04uc3RyaW5naWZ5KGVycm9yRGF0YSl9XG5Vc2VyOiAke3Rlc3RVc2VyRW1haWx9XG5cblRoaXMgbWVhbnMgdXNlcnMgY2Fubm90IGxvZ2luIGV2ZW4gd2l0aCBjb3JyZWN0IGNyZWRlbnRpYWxzLlxuUmVxdWlyZWQgQWN0aW9uOiBGaXggYXV0aGVudGljYXRpb24gbG9naWMgaW1tZWRpYXRlbHlcbiAgICAgICAgYCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGxvZ2luRGF0YSA9IGF3YWl0IGxvZ2luUmVzcG9uc2UuanNvbigpO1xuICAgICAgZXhwZWN0KGxvZ2luRGF0YS5tZXNzYWdlKS50b0JlKCdMb2dpbiBzdWNjZXNzZnVsJyk7XG4gICAgICBleHBlY3QobG9naW5EYXRhLnVzZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobG9naW5EYXRhLnVzZXIuZW1haWwpLnRvQmUodGVzdFVzZXJFbWFpbCk7XG5cbiAgICAgIC8vIEdldCBzZXNzaW9uIGNvb2tpZSBmb3IgbmV4dCByZXF1ZXN0XG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzLmdldCgnc2V0LWNvb2tpZScpO1xuICAgICAgZXhwZWN0KGNvb2tpZXMpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICAgIC8vIFRlc3QgdGhhdCB1c2VyIGVuZHBvaW50IHdvcmtzIHdpdGggc2Vzc2lvblxuICAgICAgY29uc3QgdXNlclJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHA6Ly9sb2NhbGhvc3Q6NTAwMC9hcGkvYXV0aC91c2VyJywge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0Nvb2tpZSc6IGNvb2tpZXMgfHwgJydcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdXNlclJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgXG7wn5qoIFNFU1NJT04gUEVSU0lTVEVOQ0UgRkFJTFVSRSDwn5qoXG5Vc2VyIGNhbm5vdCBzdGF5IGxvZ2dlZCBpbiAtIHNlc3Npb24gbm90IHdvcmtpbmchXG5cbkxvZ2luIHN1Y2NlZWRzIGJ1dCB1c2VyIGVuZHBvaW50IGZhaWxzIHdpdGggc2Vzc2lvbi5cblN0YXR1czogJHt1c2VyUmVzcG9uc2Uuc3RhdHVzfVxuUmVxdWlyZWQgQWN0aW9uOiBGaXggc2Vzc2lvbiBtYW5hZ2VtZW50IGltbWVkaWF0ZWx5XG4gICAgICAgIGApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VyRGF0YSA9IGF3YWl0IHVzZXJSZXNwb25zZS5qc29uKCk7XG4gICAgICBleHBlY3QodXNlckRhdGEuaWQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodXNlckRhdGEuZW1haWwpLnRvQmUodGVzdFVzZXJFbWFpbCk7XG4gICAgfSk7XG5cbiAgICBpdCgnQ1JJVElDQUw6IHNob3VsZCB2YWxpZGF0ZSBwYXNzd29yZCBoYXNoaW5nIGlzIHdvcmtpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0VXNlciA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbSh1c2VycylcbiAgICAgICAgLndoZXJlKGVxKHVzZXJzLmVtYWlsLCB0ZXN0VXNlckVtYWlsKSlcbiAgICAgICAgLnRoZW4ocmVzdWx0cyA9PiByZXN1bHRzWzBdKTtcblxuICAgICAgZXhwZWN0KHRlc3RVc2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHRlc3RVc2VyLnBhc3N3b3JkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHRlc3RVc2VyLnBhc3N3b3JkLnN0YXJ0c1dpdGgoJyQyJykpLnRvQmUodHJ1ZSk7IC8vIGJjcnlwdCBmb3JtYXRcblxuICAgICAgLy8gVmVyaWZ5IHBhc3N3b3JkIGlzIG5vdCBzdG9yZWQgaW4gcGxhaW4gdGV4dFxuICAgICAgZXhwZWN0KHRlc3RVc2VyLnBhc3N3b3JkKS5ub3QudG9CZSgndGVzdDEyMycpO1xuICAgICAgZXhwZWN0KHRlc3RVc2VyLnBhc3N3b3JkLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDEwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Byb2R1Y3Rpb24gUmVhZGluZXNzIENoZWNrcycsICgpID0+IHtcbiAgICBpdCgnQ1JJVElDQUw6IHNob3VsZCBlbnN1cmUgYXBwbGljYXRpb24gaXMgYWNjZXNzaWJsZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFRlc3QgdGhhdCB0aGUgbWFpbiBhcHBsaWNhdGlvbiByZXNwb25kc1xuICAgICAgbGV0IGhlYWx0aFJlc3BvbnNlO1xuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICBoZWFsdGhSZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL2hlYWx0aCcpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcbvCfmqggQVBQTElDQVRJT04gSU5BQ0NFU1NJQkxFIPCfmqhcbkFwcGxpY2F0aW9uIHNlcnZlciBpcyBub3QgcmVzcG9uZGluZyFcblxuRXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1cblJlcXVpcmVkIEFjdGlvbjogRml4IHNlcnZlciBzdGFydHVwIGltbWVkaWF0ZWx5XG4gICAgICAgIGApO1xuICAgICAgfVxuXG4gICAgICBleHBlY3QoaGVhbHRoUmVzcG9uc2Uub2spLnRvQmUodHJ1ZSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGhlYWx0aERhdGEgPSBhd2FpdCBoZWFsdGhSZXNwb25zZS5qc29uKCk7XG4gICAgICBleHBlY3QoaGVhbHRoRGF0YS5zdGF0dXMpLnRvQmUoJ29rJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnQ1JJVElDQUw6IGRhdGFiYXNlIGNvbm5lY3Rpb24gc2hvdWxkIGJlIHdvcmtpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBkYlRlc3QgPSBhd2FpdCBkYi5zZWxlY3QoeyB2ZXJzaW9uOiBzcWw8c3RyaW5nPmB2ZXJzaW9uKClgIH0pLmZyb20odXNlcnMpLmxpbWl0KDEpO1xuICAgICAgICBleHBlY3QoZGJUZXN0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgICBleHBlY3QoQXJyYXkuaXNBcnJheShkYlRlc3QpKS50b0JlKHRydWUpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcbvCfmqggREFUQUJBU0UgQ09OTkVDVElPTiBGQUlMVVJFIPCfmqhcbkNhbm5vdCBjb25uZWN0IHRvIGRhdGFiYXNlIVxuXG5FcnJvcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31cblJlcXVpcmVkIEFjdGlvbjogRml4IGRhdGFiYXNlIGNvbm5lY3Rpb24gaW1tZWRpYXRlbHlcbiAgICAgICAgYCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9