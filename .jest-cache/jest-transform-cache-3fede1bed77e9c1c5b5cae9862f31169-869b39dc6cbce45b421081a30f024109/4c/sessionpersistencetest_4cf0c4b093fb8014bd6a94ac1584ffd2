220973ac9e6da732e8f496f648343829
"use strict";
/**
 * Critical Session Persistence Tests
 *
 * Tests for session loss scenarios that affect both development and production environments.
 * Detects issues with session storage, cookie management, and auth state persistence.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const supertest_1 = __importDefault(require("supertest"));
const test_app_1 = require("../setup/test-app");
const storage_1 = require("../../server/storage");
const auth_1 = require("../../server/auth");
(0, globals_1.describe)('Session Persistence Critical Tests', () => {
    let app;
    let testUser;
    let sessionCookie;
    (0, globals_1.beforeEach)(async () => {
        app = await (0, test_app_1.createTestApp)();
        // Create test user
        testUser = {
            email: 'test-session@koveo-gestion.com',
            password: await (0, auth_1.hashPassword)('TestPassword123!'),
            firstName: 'Session',
            lastName: 'Test',
            username: 'sessiontest',
            role: 'admin',
            isActive: true,
        };
        const createdUser = await storage_1.storage.createUser(testUser);
        testUser.id = createdUser.id;
    });
    (0, globals_1.afterEach)(async () => {
        // Clean up test user
        if (testUser?.id) {
            try {
                await storage_1.storage.deleteUser(testUser.id);
            }
            catch (error) {
                // User might already be deleted
            }
        }
    });
    (0, globals_1.describe)('Session Loss Detection', () => {
        (0, globals_1.it)('should maintain session after login and user check', async () => {
            // Step 1: Login and capture session cookie
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            (0, globals_1.expect)(loginResponse.body.user).toBeDefined();
            (0, globals_1.expect)(loginResponse.body.user.id).toBe(testUser.id);
            // Extract session cookie
            const cookies = loginResponse.headers['set-cookie'];
            (0, globals_1.expect)(cookies).toBeDefined();
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            (0, globals_1.expect)(sessionCookie).toBeDefined();
            // Step 2: Use session cookie to check user auth (should work)
            const userCheckResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            (0, globals_1.expect)(userCheckResponse.body.id).toBe(testUser.id);
            (0, globals_1.expect)(userCheckResponse.body.email).toBe(testUser.email);
            (0, globals_1.expect)(userCheckResponse.body.firstName).toBe('Session');
            (0, globals_1.expect)(userCheckResponse.body.lastName).toBe('Test');
            // Step 3: Make another request to ensure session persists
            const secondCheckResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            (0, globals_1.expect)(secondCheckResponse.body.id).toBe(testUser.id);
            (0, globals_1.expect)(secondCheckResponse.body.email).toBe(testUser.email);
        });
        (0, globals_1.it)('should detect session loss after multiple requests', async () => {
            // Login first
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Make multiple requests to simulate session usage
            for (let i = 0; i < 5; i++) {
                const response = await (0, supertest_1.default)(app)
                    .get('/api/auth/user')
                    .set('Cookie', sessionCookie);
                // Should maintain auth across all requests
                (0, globals_1.expect)(response.status).toBe(200);
                (0, globals_1.expect)(response.body.id).toBe(testUser.id);
                (0, globals_1.expect)(response.body.firstName).toBe('Session');
                (0, globals_1.expect)(response.body.lastName).toBe('Test');
                // Session should return defined user data, not "undefined undefined"
                (0, globals_1.expect)(response.body.firstName).not.toBe('undefined');
                (0, globals_1.expect)(response.body.lastName).not.toBe('undefined');
                (0, globals_1.expect)(response.body.email).not.toBe('undefined');
            }
        });
        (0, globals_1.it)('should handle session store connection issues gracefully', async () => {
            // Login successfully
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Verify session works
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Test session persistence under load
            const requests = Array.from({ length: 10 }, (_, i) => (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie));
            const responses = await Promise.all(requests);
            // All requests should succeed
            responses.forEach((response, index) => {
                (0, globals_1.expect)(response.status).toBe(200);
                (0, globals_1.expect)(response.body.id).toBe(testUser.id);
                (0, globals_1.expect)(response.body.firstName).toBe('Session');
                (0, globals_1.expect)(response.body.lastName).toBe('Test');
            });
        });
        (0, globals_1.it)('should properly handle session refresh and extension', async () => {
            // Login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Simulate multiple API calls that should extend session
            const initialCheck = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Wait a moment and make another request (simulates user activity)
            await new Promise(resolve => setTimeout(resolve, 100));
            const extendedCheck = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Both should return valid user data
            (0, globals_1.expect)(initialCheck.body.id).toBe(testUser.id);
            (0, globals_1.expect)(extendedCheck.body.id).toBe(testUser.id);
            (0, globals_1.expect)(extendedCheck.body.firstName).toBe('Session');
            (0, globals_1.expect)(extendedCheck.body.lastName).toBe('Test');
        });
        (0, globals_1.it)('should detect undefined user data patterns', async () => {
            // Login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Check user data structure
            const userResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            const user = userResponse.body;
            // Ensure no undefined values that cause "undefined undefined" display
            (0, globals_1.expect)(user.firstName).toBeDefined();
            (0, globals_1.expect)(user.firstName).not.toBe('undefined');
            (0, globals_1.expect)(user.firstName).not.toBe(null);
            (0, globals_1.expect)(typeof user.firstName).toBe('string');
            (0, globals_1.expect)(user.firstName.length).toBeGreaterThan(0);
            (0, globals_1.expect)(user.lastName).toBeDefined();
            (0, globals_1.expect)(user.lastName).not.toBe('undefined');
            (0, globals_1.expect)(user.lastName).not.toBe(null);
            (0, globals_1.expect)(typeof user.lastName).toBe('string');
            (0, globals_1.expect)(user.lastName.length).toBeGreaterThan(0);
            (0, globals_1.expect)(user.email).toBeDefined();
            (0, globals_1.expect)(user.email).not.toBe('undefined');
            (0, globals_1.expect)(user.email).toBe(testUser.email);
            (0, globals_1.expect)(user.role).toBeDefined();
            (0, globals_1.expect)(user.role).not.toBe('undefined');
            (0, globals_1.expect)(user.role).toBe('admin');
            // Verify the complete user object structure
            (0, globals_1.expect)(user).toMatchObject({
                id: globals_1.expect.any(String),
                firstName: globals_1.expect.any(String),
                lastName: globals_1.expect.any(String),
                email: globals_1.expect.any(String),
                role: globals_1.expect.any(String),
                isActive: globals_1.expect.any(Boolean),
            });
        });
    });
    (0, globals_1.describe)('Session Cookie Management', () => {
        (0, globals_1.it)('should set proper cookie attributes for session persistence', async () => {
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            const sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            (0, globals_1.expect)(sessionCookie).toBeDefined();
            // Check cookie attributes for proper session management
            (0, globals_1.expect)(sessionCookie).toMatch(/HttpOnly/i);
            (0, globals_1.expect)(sessionCookie).toMatch(/Path=\//);
            // Should have a reasonable max age (7 days = 604800 seconds)
            (0, globals_1.expect)(sessionCookie).toMatch(/Max-Age=\d+/);
        });
        (0, globals_1.it)('should handle logout and clear session properly', async () => {
            // Login first
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Verify session works
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Logout
            const logoutResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/logout')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Verify session is cleared
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(401);
        });
    });
    (0, globals_1.describe)('Production Environment Simulation', () => {
        (0, globals_1.it)('should work with production-like cookie settings', async () => {
            // This test simulates production environment cookie behavior
            const originalNodeEnv = process.env.NODE_ENV;
            process.env.NODE_ENV = 'production';
            try {
                const loginResponse = await (0, supertest_1.default)(app)
                    .post('/api/auth/login')
                    .send({
                    email: testUser.email,
                    password: 'TestPassword123!',
                })
                    .expect(200);
                const cookies = loginResponse.headers['set-cookie'];
                sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
                // Should still work with production cookie settings
                const userResponse = await (0, supertest_1.default)(app)
                    .get('/api/auth/user')
                    .set('Cookie', sessionCookie)
                    .expect(200);
                (0, globals_1.expect)(userResponse.body.id).toBe(testUser.id);
                (0, globals_1.expect)(userResponse.body.firstName).toBe('Session');
                (0, globals_1.expect)(userResponse.body.lastName).toBe('Test');
            }
            finally {
                process.env.NODE_ENV = originalNodeEnv;
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9jcml0aWNhbC9zZXNzaW9uLXBlcnNpc3RlbmNlLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7OztBQUVILDJDQUE0RTtBQUM1RSwwREFBZ0M7QUFDaEMsZ0RBQWtEO0FBQ2xELGtEQUErQztBQUMvQyw0Q0FBaUQ7QUFFakQsSUFBQSxrQkFBUSxFQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtJQUNsRCxJQUFJLEdBQVEsQ0FBQztJQUNiLElBQUksUUFBYSxDQUFDO0lBQ2xCLElBQUksYUFBcUIsQ0FBQztJQUUxQixJQUFBLG9CQUFVLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsR0FBRyxHQUFHLE1BQU0sSUFBQSx3QkFBYSxHQUFFLENBQUM7UUFFNUIsbUJBQW1CO1FBQ25CLFFBQVEsR0FBRztZQUNULEtBQUssRUFBRSxnQ0FBZ0M7WUFDdkMsUUFBUSxFQUFFLE1BQU0sSUFBQSxtQkFBWSxFQUFDLGtCQUFrQixDQUFDO1lBQ2hELFNBQVMsRUFBRSxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFFBQVEsRUFBRSxhQUFhO1lBQ3ZCLElBQUksRUFBRSxPQUFnQjtZQUN0QixRQUFRLEVBQUUsSUFBSTtTQUNmLENBQUM7UUFFRixNQUFNLFdBQVcsR0FBRyxNQUFNLGlCQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZELFFBQVEsQ0FBQyxFQUFFLEdBQUcsV0FBVyxDQUFDLEVBQUUsQ0FBQztJQUMvQixDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsbUJBQVMsRUFBQyxLQUFLLElBQUksRUFBRTtRQUNuQixxQkFBcUI7UUFDckIsSUFBSSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUM7WUFDakIsSUFBSSxDQUFDO2dCQUNILE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNm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QUFDO2dCQUVsRixvREFBb0Q7Z0JBQ3BELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQztxQkFDcEMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO3FCQUNyQixHQUFHLENBQUMsUUFBUSxFQUFFLGFBQWEsQ0FBQztxQkFDNUIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVmLElBQUEsZ0JBQU0sRUFBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQy9DLElBQUEsZ0JBQU0sRUFBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDcEQsSUFBQSxnQkFBTSxFQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2xELENBQUM7b0JBQVMsQ0FBQztnQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxlQUFlLENBQUM7WUFDekMsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3Rlc3RzL2NyaXRpY2FsL3Nlc3Npb24tcGVyc2lzdGVuY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyaXRpY2FsIFNlc3Npb24gUGVyc2lzdGVuY2UgVGVzdHNcbiAqIFxuICogVGVzdHMgZm9yIHNlc3Npb24gbG9zcyBzY2VuYXJpb3MgdGhhdCBhZmZlY3QgYm90aCBkZXZlbG9wbWVudCBhbmQgcHJvZHVjdGlvbiBlbnZpcm9ubWVudHMuXG4gKiBEZXRlY3RzIGlzc3VlcyB3aXRoIHNlc3Npb24gc3RvcmFnZSwgY29va2llIG1hbmFnZW1lbnQsIGFuZCBhdXRoIHN0YXRlIHBlcnNpc3RlbmNlLlxuICovXG5cbmltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBhZnRlckVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgeyBjcmVhdGVUZXN0QXBwIH0gZnJvbSAnLi4vc2V0dXAvdGVzdC1hcHAnO1xuaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gJy4uLy4uL3NlcnZlci9zdG9yYWdlJztcbmltcG9ydCB7IGhhc2hQYXNzd29yZCB9IGZyb20gJy4uLy4uL3NlcnZlci9hdXRoJztcblxuZGVzY3JpYmUoJ1Nlc3Npb24gUGVyc2lzdGVuY2UgQ3JpdGljYWwgVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBhcHA6IGFueTtcbiAgbGV0IHRlc3RVc2VyOiBhbnk7XG4gIGxldCBzZXNzaW9uQ29va2llOiBzdHJpbmc7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXBwID0gYXdhaXQgY3JlYXRlVGVzdEFwcCgpO1xuICAgIFxuICAgIC8vIENyZWF0ZSB0ZXN0IHVzZXJcbiAgICB0ZXN0VXNlciA9IHtcbiAgICAgIGVtYWlsOiAndGVzdC1zZXNzaW9uQGtvdmVvLWdlc3Rpb24uY29tJyxcbiAgICAgIHBhc3N3b3JkOiBhd2FpdCBoYXNoUGFzc3dvcmQoJ1Rlc3RQYXNzd29yZDEyMyEnKSxcbiAgICAgIGZpcnN0TmFtZTogJ1Nlc3Npb24nLFxuICAgICAgbGFzdE5hbWU6ICdUZXN0JyxcbiAgICAgIHVzZXJuYW1lOiAnc2Vzc2lvbnRlc3QnLFxuICAgICAgcm9sZTogJ2FkbWluJyBhcyBjb25zdCxcbiAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgIH07XG5cbiAgICBjb25zdCBjcmVhdGVkVXNlciA9IGF3YWl0IHN0b3JhZ2UuY3JlYXRlVXNlcih0ZXN0VXNlcik7XG4gICAgdGVzdFVzZXIuaWQgPSBjcmVhdGVkVXNlci5pZDtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhbiB1cCB0ZXN0IHVzZXJcbiAgICBpZiAodGVzdFVzZXI/LmlkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzdG9yYWdlLmRlbGV0ZVVzZXIodGVzdFVzZXIuaWQpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gVXNlciBtaWdodCBhbHJlYWR5IGJlIGRlbGV0ZWRcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTZXNzaW9uIExvc3MgRGV0ZWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbWFpbnRhaW4gc2Vzc2lvbiBhZnRlciBsb2dpbiBhbmQgdXNlciBjaGVjaycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFN0ZXAgMTogTG9naW4gYW5kIGNhcHR1cmUgc2Vzc2lvbiBjb29raWVcbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QobG9naW5SZXNwb25zZS5ib2R5LnVzZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobG9naW5SZXNwb25zZS5ib2R5LnVzZXIuaWQpLnRvQmUodGVzdFVzZXIuaWQpO1xuXG4gICAgICAvLyBFeHRyYWN0IHNlc3Npb24gY29va2llXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBleHBlY3QoY29va2llcykudG9CZURlZmluZWQoKTtcbiAgICAgIHNlc3Npb25Db29raWUgPSBjb29raWVzLmZpbmQoKGNvb2tpZTogc3RyaW5nKSA9PiBjb29raWUuc3RhcnRzV2l0aCgna292ZW8uc2lkPScpKTtcbiAgICAgIGV4cGVjdChzZXNzaW9uQ29va2llKS50b0JlRGVmaW5lZCgpO1xuXG4gICAgICAvLyBTdGVwIDI6IFVzZSBzZXNzaW9uIGNvb2tpZSB0byBjaGVjayB1c2VyIGF1dGggKHNob3VsZCB3b3JrKVxuICAgICAgY29uc3QgdXNlckNoZWNrUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdCh1c2VyQ2hlY2tSZXNwb25zZS5ib2R5LmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcbiAgICAgIGV4cGVjdCh1c2VyQ2hlY2tSZXNwb25zZS5ib2R5LmVtYWlsKS50b0JlKHRlc3RVc2VyLmVtYWlsKTtcbiAgICAgIGV4cGVjdCh1c2VyQ2hlY2tSZXNwb25zZS5ib2R5LmZpcnN0TmFtZSkudG9CZSgnU2Vzc2lvbicpO1xuICAgICAgZXhwZWN0KHVzZXJDaGVja1Jlc3BvbnNlLmJvZHkubGFzdE5hbWUpLnRvQmUoJ1Rlc3QnKTtcblxuICAgICAgLy8gU3RlcCAzOiBNYWtlIGFub3RoZXIgcmVxdWVzdCB0byBlbnN1cmUgc2Vzc2lvbiBwZXJzaXN0c1xuICAgICAgY29uc3Qgc2Vjb25kQ2hlY2tSZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgZXhwZWN0KHNlY29uZENoZWNrUmVzcG9uc2UuYm9keS5pZCkudG9CZSh0ZXN0VXNlci5pZCk7XG4gICAgICBleHBlY3Qoc2Vjb25kQ2hlY2tSZXNwb25zZS5ib2R5LmVtYWlsKS50b0JlKHRlc3RVc2VyLmVtYWlsKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGV0ZWN0IHNlc3Npb24gbG9zcyBhZnRlciBtdWx0aXBsZSByZXF1ZXN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIExvZ2luIGZpcnN0XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6IHRlc3RVc2VyLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAnVGVzdFBhc3N3b3JkMTIzIScsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgICAgc2Vzc2lvbkNvb2tpZSA9IGNvb2tpZXMuZmluZCgoY29va2llOiBzdHJpbmcpID0+IGNvb2tpZS5zdGFydHNXaXRoKCdrb3Zlby5zaWQ9JykpO1xuXG4gICAgICAvLyBNYWtlIG11bHRpcGxlIHJlcXVlc3RzIHRvIHNpbXVsYXRlIHNlc3Npb24gdXNhZ2VcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpO1xuXG4gICAgICAgIC8vIFNob3VsZCBtYWludGFpbiBhdXRoIGFjcm9zcyBhbGwgcmVxdWVzdHNcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5pZCkudG9CZSh0ZXN0VXNlci5pZCk7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmZpcnN0TmFtZSkudG9CZSgnU2Vzc2lvbicpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5sYXN0TmFtZSkudG9CZSgnVGVzdCcpO1xuICAgICAgICBcbiAgICAgICAgLy8gU2Vzc2lvbiBzaG91bGQgcmV0dXJuIGRlZmluZWQgdXNlciBkYXRhLCBub3QgXCJ1bmRlZmluZWQgdW5kZWZpbmVkXCJcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZmlyc3ROYW1lKS5ub3QudG9CZSgndW5kZWZpbmVkJyk7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lmxhc3ROYW1lKS5ub3QudG9CZSgndW5kZWZpbmVkJyk7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmVtYWlsKS5ub3QudG9CZSgndW5kZWZpbmVkJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzZXNzaW9uIHN0b3JlIGNvbm5lY3Rpb24gaXNzdWVzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBMb2dpbiBzdWNjZXNzZnVsbHlcbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG5cbiAgICAgIC8vIFZlcmlmeSBzZXNzaW9uIHdvcmtzXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIFRlc3Qgc2Vzc2lvbiBwZXJzaXN0ZW5jZSB1bmRlciBsb2FkXG4gICAgICBjb25zdCByZXF1ZXN0cyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDEwIH0sIChfLCBpKSA9PlxuICAgICAgICByZXF1ZXN0KGFwcClcbiAgICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKHJlcXVlc3RzKTtcbiAgICAgIFxuICAgICAgLy8gQWxsIHJlcXVlc3RzIHNob3VsZCBzdWNjZWVkXG4gICAgICByZXNwb25zZXMuZm9yRWFjaCgocmVzcG9uc2UsIGluZGV4KSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuaWQpLnRvQmUodGVzdFVzZXIuaWQpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5maXJzdE5hbWUpLnRvQmUoJ1Nlc3Npb24nKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubGFzdE5hbWUpLnRvQmUoJ1Rlc3QnKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm9wZXJseSBoYW5kbGUgc2Vzc2lvbiByZWZyZXNoIGFuZCBleHRlbnNpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBMb2dpblxuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgLnNlbmQoe1xuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICBwYXNzd29yZDogJ1Rlc3RQYXNzd29yZDEyMyEnLFxuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IGNvb2tpZXMgPSBsb2dpblJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICAgIHNlc3Npb25Db29raWUgPSBjb29raWVzLmZpbmQoKGNvb2tpZTogc3RyaW5nKSA9PiBjb29raWUuc3RhcnRzV2l0aCgna292ZW8uc2lkPScpKTtcblxuICAgICAgLy8gU2ltdWxhdGUgbXVsdGlwbGUgQVBJIGNhbGxzIHRoYXQgc2hvdWxkIGV4dGVuZCBzZXNzaW9uXG4gICAgICBjb25zdCBpbml0aWFsQ2hlY2sgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIFdhaXQgYSBtb21lbnQgYW5kIG1ha2UgYW5vdGhlciByZXF1ZXN0IChzaW11bGF0ZXMgdXNlciBhY3Rpdml0eSlcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICAgIFxuICAgICAgY29uc3QgZXh0ZW5kZWRDaGVjayA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gQm90aCBzaG91bGQgcmV0dXJuIHZhbGlkIHVzZXIgZGF0YVxuICAgICAgZXhwZWN0KGluaXRpYWxDaGVjay5ib2R5LmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcbiAgICAgIGV4cGVjdChleHRlbmRlZENoZWNrLmJvZHkuaWQpLnRvQmUodGVzdFVzZXIuaWQpO1xuICAgICAgZXhwZWN0KGV4dGVuZGVkQ2hlY2suYm9keS5maXJzdE5hbWUpLnRvQmUoJ1Nlc3Npb24nKTtcbiAgICAgIGV4cGVjdChleHRlbmRlZENoZWNrLmJvZHkubGFzdE5hbWUpLnRvQmUoJ1Rlc3QnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGV0ZWN0IHVuZGVmaW5lZCB1c2VyIGRhdGEgcGF0dGVybnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBMb2dpblxuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgLnNlbmQoe1xuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICBwYXNzd29yZDogJ1Rlc3RQYXNzd29yZDEyMyEnLFxuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IGNvb2tpZXMgPSBsb2dpblJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICAgIHNlc3Npb25Db29raWUgPSBjb29raWVzLmZpbmQoKGNvb2tpZTogc3RyaW5nKSA9PiBjb29raWUuc3RhcnRzV2l0aCgna292ZW8uc2lkPScpKTtcblxuICAgICAgLy8gQ2hlY2sgdXNlciBkYXRhIHN0cnVjdHVyZVxuICAgICAgY29uc3QgdXNlclJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCB1c2VyID0gdXNlclJlc3BvbnNlLmJvZHk7XG5cbiAgICAgIC8vIEVuc3VyZSBubyB1bmRlZmluZWQgdmFsdWVzIHRoYXQgY2F1c2UgXCJ1bmRlZmluZWQgdW5kZWZpbmVkXCIgZGlzcGxheVxuICAgICAgZXhwZWN0KHVzZXIuZmlyc3ROYW1lKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVzZXIuZmlyc3ROYW1lKS5ub3QudG9CZSgndW5kZWZpbmVkJyk7XG4gICAgICBleHBlY3QodXNlci5maXJzdE5hbWUpLm5vdC50b0JlKG51bGwpO1xuICAgICAgZXhwZWN0KHR5cGVvZiB1c2VyLmZpcnN0TmFtZSkudG9CZSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3QodXNlci5maXJzdE5hbWUubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAgIGV4cGVjdCh1c2VyLmxhc3ROYW1lKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVzZXIubGFzdE5hbWUpLm5vdC50b0JlKCd1bmRlZmluZWQnKTtcbiAgICAgIGV4cGVjdCh1c2VyLmxhc3ROYW1lKS5ub3QudG9CZShudWxsKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgdXNlci5sYXN0TmFtZSkudG9CZSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3QodXNlci5sYXN0TmFtZS5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcblxuICAgICAgZXhwZWN0KHVzZXIuZW1haWwpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodXNlci5lbWFpbCkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgZXhwZWN0KHVzZXIuZW1haWwpLnRvQmUodGVzdFVzZXIuZW1haWwpO1xuXG4gICAgICBleHBlY3QodXNlci5yb2xlKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVzZXIucm9sZSkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgZXhwZWN0KHVzZXIucm9sZSkudG9CZSgnYWRtaW4nKTtcblxuICAgICAgLy8gVmVyaWZ5IHRoZSBjb21wbGV0ZSB1c2VyIG9iamVjdCBzdHJ1Y3R1cmVcbiAgICAgIGV4cGVjdCh1c2VyKS50b01hdGNoT2JqZWN0KHtcbiAgICAgICAgaWQ6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgZmlyc3ROYW1lOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIGxhc3ROYW1lOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIGVtYWlsOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIHJvbGU6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgaXNBY3RpdmU6IGV4cGVjdC5hbnkoQm9vbGVhbiksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Nlc3Npb24gQ29va2llIE1hbmFnZW1lbnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZXQgcHJvcGVyIGNvb2tpZSBhdHRyaWJ1dGVzIGZvciBzZXNzaW9uIHBlcnNpc3RlbmNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgLnNlbmQoe1xuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICBwYXNzd29yZDogJ1Rlc3RQYXNzd29yZDEyMyEnLFxuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IGNvb2tpZXMgPSBsb2dpblJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICAgIGNvbnN0IHNlc3Npb25Db29raWUgPSBjb29raWVzLmZpbmQoKGNvb2tpZTogc3RyaW5nKSA9PiBjb29raWUuc3RhcnRzV2l0aCgna292ZW8uc2lkPScpKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHNlc3Npb25Db29raWUpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGNvb2tpZSBhdHRyaWJ1dGVzIGZvciBwcm9wZXIgc2Vzc2lvbiBtYW5hZ2VtZW50XG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvb2tpZSkudG9NYXRjaCgvSHR0cE9ubHkvaSk7XG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvb2tpZSkudG9NYXRjaCgvUGF0aD1cXC8vKTtcbiAgICAgIFxuICAgICAgLy8gU2hvdWxkIGhhdmUgYSByZWFzb25hYmxlIG1heCBhZ2UgKDcgZGF5cyA9IDYwNDgwMCBzZWNvbmRzKVxuICAgICAgZXhwZWN0KHNlc3Npb25Db29raWUpLnRvTWF0Y2goL01heC1BZ2U9XFxkKy8pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbG9nb3V0IGFuZCBjbGVhciBzZXNzaW9uIHByb3Blcmx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTG9naW4gZmlyc3RcbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG5cbiAgICAgIC8vIFZlcmlmeSBzZXNzaW9uIHdvcmtzXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIExvZ291dFxuICAgICAgY29uc3QgbG9nb3V0UmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dvdXQnKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIFZlcmlmeSBzZXNzaW9uIGlzIGNsZWFyZWRcbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICAgIC5leHBlY3QoNDAxKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Byb2R1Y3Rpb24gRW52aXJvbm1lbnQgU2ltdWxhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCBwcm9kdWN0aW9uLWxpa2UgY29va2llIHNldHRpbmdzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVGhpcyB0ZXN0IHNpbXVsYXRlcyBwcm9kdWN0aW9uIGVudmlyb25tZW50IGNvb2tpZSBiZWhhdmlvclxuICAgICAgY29uc3Qgb3JpZ2luYWxOb2RlRW52ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlY7XG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdwcm9kdWN0aW9uJztcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAgIC5zZW5kKHtcbiAgICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICAgIHBhc3N3b3JkOiAnVGVzdFBhc3N3b3JkMTIzIScsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG5cbiAgICAgICAgLy8gU2hvdWxkIHN0aWxsIHdvcmsgd2l0aCBwcm9kdWN0aW9uIGNvb2tpZSBzZXR0aW5nc1xuICAgICAgICBjb25zdCB1c2VyUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgICAgZXhwZWN0KHVzZXJSZXNwb25zZS5ib2R5LmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcbiAgICAgICAgZXhwZWN0KHVzZXJSZXNwb25zZS5ib2R5LmZpcnN0TmFtZSkudG9CZSgnU2Vzc2lvbicpO1xuICAgICAgICBleHBlY3QodXNlclJlc3BvbnNlLmJvZHkubGFzdE5hbWUpLnRvQmUoJ1Rlc3QnKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gb3JpZ2luYWxOb2RlRW52O1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==