104e4abcf20daf99950813ce8d4df4fa
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.aiExtractionResponseSchema = exports.invoiceFormSchema = exports.baseInvoiceInsertSchema = exports.insertInvoiceSchema = exports.invoices = exports.invoiceFrequencyEnum = exports.invoicePaymentTypeEnum = void 0;
exports.convertAiResponseToFormData = convertAiResponseToFormData;
const drizzle_orm_1 = require("drizzle-orm");
const pg_core_1 = require("drizzle-orm/pg-core");
const drizzle_zod_1 = require("drizzle-zod");
const zod_1 = require("zod");
const core_1 = require("./core");
const property_1 = require("./property");
const documents_1 = require("./documents");
// Invoice-specific enums following exact requirements
exports.invoicePaymentTypeEnum = (0, pg_core_1.pgEnum)('invoice_payment_type', [
    'one-time',
    'recurring'
]);
exports.invoiceFrequencyEnum = (0, pg_core_1.pgEnum)('invoice_frequency', [
    'monthly',
    'quarterly',
    'annually',
    'custom'
]);
/**
 * Invoices table for AI-powered invoice management.
 * Integrates with document management system and supports recurring payments
 * with standard frequencies (monthly, quarterly, annually) and custom scheduling.
 */
exports.invoices = (0, pg_core_1.pgTable)('invoices', {
    id: (0, pg_core_1.varchar)('id')
        .primaryKey()
        .default((0, drizzle_orm_1.sql) `gen_random_uuid()`),
    // Core invoice fields as specified in requirements
    vendorName: (0, pg_core_1.text)('vendor_name').notNull(),
    invoiceNumber: (0, pg_core_1.text)('invoice_number').notNull(),
    totalAmount: (0, pg_core_1.decimal)('total_amount', { precision: 12, scale: 2 }).notNull(),
    dueDate: (0, pg_core_1.date)('due_date').notNull(),
    // Payment structure fields
    paymentType: (0, exports.invoicePaymentTypeEnum)('payment_type').notNull(),
    // Recurring payment fields (conditional based on paymentType)
    frequency: (0, exports.invoiceFrequencyEnum)('frequency'), // Only for recurring payments
    startDate: (0, pg_core_1.date)('start_date'), // For standard frequencies (not custom)
    customPaymentDates: (0, pg_core_1.date)('custom_payment_dates').array(), // Only for custom frequency
    // Document integration - links to uploaded invoice file (optional for testing)
    documentId: (0, pg_core_1.varchar)('document_id')
        .references(() => documents_1.documents.id),
    // AI extraction tracking
    isAiExtracted: (0, pg_core_1.boolean)('is_ai_extracted').default(false).notNull(),
    aiExtractionData: (0, pg_core_1.jsonb)('ai_extraction_data'), // Raw AI response for debugging
    extractionConfidence: (0, pg_core_1.decimal)('extraction_confidence', { precision: 5, scale: 4 }), // AI confidence score
    // Building/residence association
    buildingId: (0, pg_core_1.varchar)('building_id').references(() => property_1.buildings.id),
    residenceId: (0, pg_core_1.varchar)('residence_id').references(() => property_1.residences.id),
    // Audit fields
    createdBy: (0, pg_core_1.varchar)('created_by')
        .notNull()
        .references(() => core_1.users.id),
    createdAt: (0, pg_core_1.timestamp)('created_at').defaultNow().notNull(),
    updatedAt: (0, pg_core_1.timestamp)('updated_at').defaultNow().notNull(),
});
// Zod validation schemas with conditional logic for recurring payments
exports.insertInvoiceSchema = (0, drizzle_zod_1.createInsertSchema)(exports.invoices, {
    // Core field validations
    vendorName: zod_1.z.string().min(1, 'Vendor name is required').max(255, 'Vendor name too long'),
    invoiceNumber: zod_1.z.string().min(1, 'Invoice number is required').max(100, 'Invoice number too long'),
    totalAmount: zod_1.z.coerce.number().positive('Total amount must be positive'),
    dueDate: zod_1.z.coerce.date(),
    // Payment type validation
    paymentType: zod_1.z.enum(['one-time', 'recurring']),
    // Frequency validation (only for recurring)
    frequency: zod_1.z.enum(['monthly', 'quarterly', 'annually', 'custom']).optional(),
    // Start date validation (for standard frequencies)
    startDate: zod_1.z.coerce.date().optional(),
    // Custom dates validation (only for custom frequency)
    customPaymentDates: zod_1.z.array(zod_1.z.coerce.date()).optional().refine((dates) => !dates || dates.length === 0 || dates.every(date => date instanceof Date && !isNaN(date.getTime())), "All custom payment dates must be valid dates"),
    // Document reference (optional for testing)
    documentId: zod_1.z.string().uuid('Invalid document ID').optional(),
    // Optional associations
    buildingId: zod_1.z.string().uuid().optional(),
    residenceId: zod_1.z.string().uuid().optional(),
    // AI fields
    isAiExtracted: zod_1.z.boolean().default(false),
    extractionConfidence: zod_1.z.coerce.number().min(0).max(1).optional(),
}).omit({
    id: true,
    createdAt: true,
    updatedAt: true
});
// Base insert schema without refinements
exports.baseInvoiceInsertSchema = exports.insertInvoiceSchema;
// Enhanced validation with conditional logic for recurring payments
exports.invoiceFormSchema = zod_1.z.object({
    title: zod_1.z.string().min(1, 'Title is required'),
    description: zod_1.z.string().optional(),
    amount: zod_1.z.string().min(1, 'Amount is required'),
    dueDate: zod_1.z.coerce.date(),
    category: zod_1.z.string().min(1, 'Category is required'),
    paymentType: zod_1.z.enum(['one-time', 'recurring']),
    frequency: zod_1.z.enum(['monthly', 'quarterly', 'annually', 'custom']).optional(),
    startDate: zod_1.z.coerce.date().optional(),
    customPaymentDates: zod_1.z.array(zod_1.z.coerce.date()).optional(),
    documentId: zod_1.z.string().uuid('Invalid document ID').optional(),
    buildingId: zod_1.z.string().uuid().optional(),
    residenceId: zod_1.z.string().uuid().optional(),
    isAiExtracted: zod_1.z.boolean().default(false),
    extractionConfidence: zod_1.z.coerce.number().min(0).max(1).optional(),
}).superRefine((data, ctx) => {
    // Recurring payment validation
    if (data.paymentType === 'recurring') {
        if (!data.frequency) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Frequency is required for recurring payments',
                path: ['frequency'],
            });
        }
        // Standard frequency validation (monthly, quarterly, annually)
        if (data.frequency && ['monthly', 'quarterly', 'annually'].includes(data.frequency)) {
            if (!data.startDate) {
                ctx.addIssue({
                    code: zod_1.z.ZodIssueCode.custom,
                    message: 'Start date is required for standard recurring frequencies',
                    path: ['startDate'],
                });
            }
            // Ensure custom dates are not set for standard frequencies
            if (data.customPaymentDates && data.customPaymentDates.length > 0) {
                ctx.addIssue({
                    code: zod_1.z.ZodIssueCode.custom,
                    message: 'Custom payment dates should not be set for standard frequencies',
                    path: ['customPaymentDates'],
                });
            }
        }
        // Custom frequency validation
        if (data.frequency === 'custom') {
            if (!data.customPaymentDates || data.customPaymentDates.length === 0) {
                ctx.addIssue({
                    code: zod_1.z.ZodIssueCode.custom,
                    message: 'At least one custom payment date is required for custom frequency',
                    path: ['customPaymentDates'],
                });
            }
            // Ensure start date is not set for custom frequency
            if (data.startDate) {
                ctx.addIssue({
                    code: zod_1.z.ZodIssueCode.custom,
                    message: 'Start date should not be set for custom frequency',
                    path: ['startDate'],
                });
            }
            // Validate custom dates are in the future and sorted
            if (data.customPaymentDates && data.customPaymentDates.length > 0) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const sortedDates = [...data.customPaymentDates].sort((a, b) => a.getTime() - b.getTime());
                // Check if dates are in chronological order
                if (JSON.stringify(data.customPaymentDates) !== JSON.stringify(sortedDates)) {
                    ctx.addIssue({
                        code: zod_1.z.ZodIssueCode.custom,
                        message: 'Custom payment dates must be in chronological order',
                        path: ['customPaymentDates'],
                    });
                }
                // Check for duplicate dates
                const uniqueDates = new Set(data.customPaymentDates.map(d => d.toISOString()));
                if (uniqueDates.size !== data.customPaymentDates.length) {
                    ctx.addIssue({
                        code: zod_1.z.ZodIssueCode.custom,
                        message: 'Custom payment dates must be unique',
                        path: ['customPaymentDates'],
                    });
                }
            }
        }
    }
    else {
        // One-time payment validation - ensure recurring fields are not set
        if (data.frequency || data.startDate || (data.customPaymentDates && data.customPaymentDates.length > 0)) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Recurring payment fields should not be set for one-time payments',
                path: ['paymentType'],
            });
        }
    }
});
// AI extraction response schema for Gemini API
exports.aiExtractionResponseSchema = zod_1.z.object({
    vendorName: zod_1.z.string().nullable(),
    invoiceNumber: zod_1.z.string().nullable(),
    totalAmount: zod_1.z.number().nullable(),
    dueDate: zod_1.z.string().nullable(), // Will be converted to Date
    paymentType: zod_1.z.enum(['one-time', 'recurring']).nullable(),
    frequency: zod_1.z.enum(['monthly', 'quarterly', 'annually', 'custom']).nullable(),
    startDate: zod_1.z.string().nullable(), // Will be converted to Date
    customPaymentDates: zod_1.z.array(zod_1.z.string()).nullable(), // Will be converted to Date[]
});
// Helper function to convert AI response to form data
function convertAiResponseToFormData(aiResponse) {
    return {
        vendorName: aiResponse.vendorName || '',
        invoiceNumber: aiResponse.invoiceNumber || '',
        totalAmount: aiResponse.totalAmount || 0,
        dueDate: aiResponse.dueDate ? new Date(aiResponse.dueDate) : new Date(),
        paymentType: aiResponse.paymentType || 'one-time',
        frequency: aiResponse.frequency || undefined,
        startDate: aiResponse.startDate ? new Date(aiResponse.startDate) : undefined,
        customPaymentDates: aiResponse.customPaymentDates
            ? aiResponse.customPaymentDates.map(date => new Date(date))
            : undefined,
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zaGFyZWQvc2NoZW1hcy9pbnZvaWNlcy50cyIsIm1hcHBpbmdzIjoiOzs7QUFrUEEsa0VBYUM7QUEvUEQsNkNBQWtDO0FBQ2xDLGlEQVU2QjtBQUM3Qiw2Q0FBaUQ7QUFDakQsNkJBQXdCO0FBQ3hCLGlDQUErQjtBQUMvQix5Q0FBbUQ7QUFDbkQsMkNBQXdDO0FBRXhDLHNEQUFzRDtBQUN6QyxRQUFBLHNCQUFzQixHQUFHLElBQUEsZ0JBQU0sRUFBQyxzQkFBc0IsRUFBRTtJQUNuRSxVQUFVO0lBQ1YsV0FBVztDQUNaLENBQUMsQ0FBQztBQUVVLFFBQUEsb0JBQW9CLEdBQUcsSUFBQSxnQkFBTSxFQUFDLG1CQUFtQixFQUFFO0lBQzlELFNBQVM7SUFDVCxXQUFXO0lBQ1gsVUFBVTtJQUNWLFFBQVE7Q0FDVCxDQUFDLENBQUM7QUFFSDs7OztHQUlHO0FBQ1UsUUFBQSxRQUFRLEdBQUcsSUFBQSxpQkFBTyxFQUFDLFVBQVUsRUFBRTtJQUMxQyxFQUFFLEVBQUUsSUFBQSxpQkFBTyxFQUFDLElBQUksQ0FBQztTQUNkLFVBQVUsRUFBRTtTQUNaLE9BQU8sQ0FBQyxJQUFBLGlCQUFHLEVBQUEsbUJBQW1CLENBQUM7SUFFbEMsbURBQW1EO0lBQ25ELFVBQVUsRUFBRSxJQUFBLGNBQUksRUFBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLEVBQUU7SUFDekMsYUFBYSxFQUFFLElBQUEsY0FBSSxFQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxFQUFFO0lBQy9DLFdBQVcsRUFBRSxJQUFBLGlCQUFPLEVBQUMsY0FBYyxFQUFFLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUU7SUFDM0UsT0FBTyxFQUFFLElBQUEsY0FBSSxFQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sRUFBRTtJQUVuQywyQkFBMkI7SUFDM0IsV0FBVyxFQUFFLElBQUEsOEJBQXNCLEVBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxFQUFFO0lBRTdELDhEQUE4RDtJQUM5RCxTQUFTLEVBQUUsSUFBQSw0QkFBb0IsRUFBQyxXQUFXLENBQUMsRUFBRSw4QkFBOEI7SUFDNUUsU0FBUyxFQUFFLElBQUEsY0FBSSxFQUFDLFlBQVksQ0FBQyxFQUFFLHdDQUF3QztJQUN2RSxrQkFBa0IsRUFBRSxJQUFBLGNBQUksRUFBQyxzQkFBc0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLDRCQUE0QjtJQUV0RiwrRUFBK0U7SUFDL0UsVUFBVSxFQUFFLElBQUEsaUJBQU8sRUFBQyxhQUFhLENBQUM7U0FDL0IsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHFCQUFTLENBQUMsRUFBRSxDQUFDO0lBRWpDLHlCQUF5QjtJQUN6QixhQUFhLEVBQUUsSUFBQSxpQkFBTyxFQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sRUFBRTtJQUNsRSxnQkFBZ0IsRUFBRSxJQUFBLGVBQUssRUFBQyxvQkFBb0IsQ0FBQyxFQUFFLGdDQUFnQztJQUMvRSxvQkFBb0IsRUFBRSxJQUFBLGlCQUFPLEVBQUMsdUJBQXVCLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLHNCQUFzQjtJQUUxRyxpQ0FBaUM7SUFDakMsVUFBVSxFQUFFLElBQUEsaUJBQU8sRUFBQyxhQUFhLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsb0JBQVMsQ0FBQyxFQUFFLENBQUM7SUFDakUsV0FBVyxFQUFFLElBQUEsaUJBQU8sRUFBQyxjQUFjLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMscUJBQVUsQ0FBQyxFQUFFLENBQUM7SUFFcEUsZUFBZTtJQUNmLFNBQVMsRUFBRSxJQUFBLGlCQUFPLEVBQUMsWUFBWSxDQUFDO1NBQzdCLE9BQU8sRUFBRTtTQUNULFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxZQUFLLENBQUMsRUFBRSxDQUFDO0lBQzdCLFNBQVMsRUFBRSxJQUFBLG1CQUFTLEVBQUMsWUFBWSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsT0FBTyxFQUFFO0lBQ3pELFNBQVMsRUFBRSxJQUFBLG1CQUFTLEVBQUMsWUFBWSxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsT0FBTyxFQUFFO0NBQzFELENBQUMsQ0FBQztBQUVILHVFQUF1RTtBQUMxRCxRQUFBLG1CQUFtQixHQUFHLElBQUEsZ0NBQWtCLEVBQUMsZ0JBQVEsRUFBRTtJQUM5RCx5QkFBeUI7SUFDekIsVUFBVSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLHlCQUF5QixDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxzQkFBc0IsQ0FBQztJQUN6RixhQUFhLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsNEJBQTRCLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLHlCQUF5QixDQUFDO0lBQ2xHLFdBQVcsRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQywrQkFBK0IsQ0FBQztJQUN4RSxPQUFPLEVBQUUsT0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7SUFFeEIsMEJBQTBCO0lBQzFCLFdBQVcsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTlDLDRDQUE0QztJQUM1QyxTQUFTLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBRTVFLG1EQUFtRDtJQUNuRCxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFFckMsc0RBQXNEO0lBQ3RELGtCQUFrQixFQUFFLE9BQUMsQ0FBQyxLQUFLLENBQUMsT0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLE1BQU0sQ0FDNUQsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLFlBQVksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQzlHLDhDQUE4QyxDQUMvQztJQUVELDRDQUE0QztJQUM1QyxVQUFVLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUU3RCx3QkFBd0I7SUFDeEIsVUFBVSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDeEMsV0FBVyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFFekMsWUFBWTtJQUNaLGFBQWEsRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUN6QyxvQkFBb0IsRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0NBQ2pFLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDTixFQUFFLEVBQUUsSUFBSTtJQUNSLFNBQVMsRUFBRSxJQUFJO0lBQ2YsU0FBUyxFQUFFLElBQUk7Q0FDaEIsQ0FBQyxDQUFDO0FBRUgseUNBQXlDO0FBQzVCLFFBQUEsdUJBQXVCLEdBQUcsMkJBQW1CLENBQUM7QUFFM0Qsb0VBQW9FO0FBQ3ZELFFBQUEsaUJBQWlCLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN4QyxLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsbUJBQW1CLENBQUM7SUFDN0MsV0FBVyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDbEMsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLG9CQUFvQixDQUFDO0lBQy9DLE9BQU8sRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtJQUN4QixRQUFRLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsc0JBQXNCLENBQUM7SUFDbkQsV0FBVyxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDOUMsU0FBUyxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtJQUM1RSxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUU7SUFDckMsa0JBQWtCLEVBQUUsT0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFDLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3ZELFVBQVUsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsUUFBUSxFQUFFO0lBQzdELFVBQVUsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3hDLFdBQVcsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3pDLGFBQWEsRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUN6QyxvQkFBb0IsRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0NBQ2pFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDM0IsK0JBQStCO0lBQy9CLElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3BCLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ1gsSUFBSSxFQUFFLE9BQUMsQ0FBQyxZQUFZLENBQUMsTUFBTTtnQkFDM0IsT0FBTyxFQUFFLDhDQUE4QztnQkFDdkQsSUFBSSxFQUFFLENBQUMsV0FBVyxDQUFDO2FBQ3BCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCwrREFBK0Q7UUFDL0QsSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDcEYsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDcEIsR0FBRyxDQUFDLFFBQVEsQ0FBQztvQkFDWCxJQUFJLEVBQUUsT0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNO29CQUMzQixPQUFPLEVBQUUsMkRBQTJEO29CQUNwRSxJQUFJLEVBQUUsQ0FBQyxXQUFXLENBQUM7aUJBQ3BCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCwyREFBMkQ7WUFDM0QsSUFBSSxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDbEUsR0FBRyxDQUFDLFFBQVEsQ0FBQztvQkFDWCxJQUFJLEVBQUUsT0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNO29CQUMzQixPQUFPLEVBQUUsaUVBQWlFO29CQUMxRSxJQUFJLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztpQkFDN0IsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztRQUNILENBQUM7UUFFRCw4QkFBOEI7UUFDOUIsSUFBSSxJQUFJLENBQUMsU0FBUyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDckUsR0FBRyxDQUFDLFFBQVEsQ0FBQztvQkFDWCxJQUFJLEVBQUUsT0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNO29CQUMzQixPQUFPLEVBQUUsbUVBQW1FO29CQUM1RSxJQUFJLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztpQkFDN0IsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELG9EQUFvRDtZQUNwRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDbkIsR0FBRyxDQUFDLFFBQVEsQ0FBQztvQkFDWCxJQUFJLEVBQUUsT0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNO29CQUMzQixPQUFPLEVBQUUsbURBQW1EO29CQUM1RCxJQUFJLEVBQUUsQ0FBQyxXQUFXLENBQUM7aUJBQ3BCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxxREFBcUQ7WUFDckQsSUFBSSxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDbEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDekIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFFM0IsTUFBTSxXQUFXLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFFM0YsNENBQTRDO2dCQUM1QyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO29CQUM1RSxHQUFHLENBQUMsUUFBUSxDQUFDO3dCQUNYLElBQUksRUFBRSxPQUFDLENBQUMsWUFBWSxDQUFDLE1BQU07d0JBQzNCLE9BQU8sRUFBRSxxREFBcUQ7d0JBQzlELElBQUksRUFBRSxDQUFDLG9CQUFvQixDQUFDO3FCQUM3QixDQUFDLENBQUM7Z0JBQ0wsQ0FBQztnQkFFRCw0QkFBNEI7Z0JBQzVCLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUMvRSxJQUFJLFdBQVcsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUN4RCxHQUFHLENBQUMsUUFBUSxDQUFDO3dCQUNYLElBQUksRUFBRSxPQUFDLENBQUMsWUFBWSxDQUFDLE1BQU07d0JBQzNCLE9BQU8sRUFBRSxxQ0FBcUM7d0JBQzlDLElBQUksRUFBRSxDQUFDLG9CQUFvQixDQUFDO3FCQUM3QixDQUFDLENBQUM7Z0JBQ0wsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztTQUFNLENBQUM7UUFDTixvRUFBb0U7UUFDcEUsSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3hHLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ1gsSUFBSSxFQUFFLE9BQUMsQ0FBQyxZQUFZLENBQUMsTUFBTTtnQkFDM0IsT0FBTyxFQUFFLGtFQUFrRTtnQkFDM0UsSUFBSSxFQUFFLENBQUMsYUFBYSxDQUFDO2FBQ3RCLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFSCwrQ0FBK0M7QUFDbEMsUUFBQSwwQkFBMEIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2pELFVBQVUsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2pDLGFBQWEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ3BDLFdBQVcsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2xDLE9BQU8sRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUUsNEJBQTRCO0lBQzVELFdBQVcsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3pELFNBQVMsRUFBRSxPQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDNUUsU0FBUyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRSw0QkFBNEI7SUFDOUQsa0JBQWtCLEVBQUUsT0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSw4QkFBOEI7Q0FDbkYsQ0FBQyxDQUFDO0FBUUgsc0RBQXNEO0FBQ3RELFNBQWdCLDJCQUEyQixDQUFDLFVBQWdDO0lBQzFFLE9BQU87UUFDTCxVQUFVLEVBQUUsVUFBVSxDQUFDLFVBQVUsSUFBSSxFQUFFO1FBQ3ZDLGFBQWEsRUFBRSxVQUFVLENBQUMsYUFBYSxJQUFJLEVBQUU7UUFDN0MsV0FBVyxFQUFFLFVBQVUsQ0FBQyxXQUFXLElBQUksQ0FBQztRQUN4QyxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtRQUN2RSxXQUFXLEVBQUUsVUFBVSxDQUFDLFdBQVcsSUFBSSxVQUFVO1FBQ2pELFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUyxJQUFJLFNBQVM7UUFDNUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM1RSxrQkFBa0IsRUFBRSxVQUFVLENBQUMsa0JBQWtCO1lBQy9DLENBQUMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0QsQ0FBQyxDQUFDLFNBQVM7S0FDZCxDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NoYXJlZC9zY2hlbWFzL2ludm9pY2VzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNxbCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCB7XG4gIHBnVGFibGUsXG4gIHRleHQsXG4gIHRpbWVzdGFtcCxcbiAgdmFyY2hhcixcbiAgZGVjaW1hbCxcbiAgZGF0ZSxcbiAganNvbmIsXG4gIGJvb2xlYW4sXG4gIHBnRW51bSxcbn0gZnJvbSAnZHJpenpsZS1vcm0vcGctY29yZSc7XG5pbXBvcnQgeyBjcmVhdGVJbnNlcnRTY2hlbWEgfSBmcm9tICdkcml6emxlLXpvZCc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHVzZXJzIH0gZnJvbSAnLi9jb3JlJztcbmltcG9ydCB7IGJ1aWxkaW5ncywgcmVzaWRlbmNlcyB9IGZyb20gJy4vcHJvcGVydHknO1xuaW1wb3J0IHsgZG9jdW1lbnRzIH0gZnJvbSAnLi9kb2N1bWVudHMnO1xuXG4vLyBJbnZvaWNlLXNwZWNpZmljIGVudW1zIGZvbGxvd2luZyBleGFjdCByZXF1aXJlbWVudHNcbmV4cG9ydCBjb25zdCBpbnZvaWNlUGF5bWVudFR5cGVFbnVtID0gcGdFbnVtKCdpbnZvaWNlX3BheW1lbnRfdHlwZScsIFtcbiAgJ29uZS10aW1lJyxcbiAgJ3JlY3VycmluZydcbl0pO1xuXG5leHBvcnQgY29uc3QgaW52b2ljZUZyZXF1ZW5jeUVudW0gPSBwZ0VudW0oJ2ludm9pY2VfZnJlcXVlbmN5JywgW1xuICAnbW9udGhseScsXG4gICdxdWFydGVybHknLCBcbiAgJ2FubnVhbGx5JyxcbiAgJ2N1c3RvbSdcbl0pO1xuXG4vKipcbiAqIEludm9pY2VzIHRhYmxlIGZvciBBSS1wb3dlcmVkIGludm9pY2UgbWFuYWdlbWVudC5cbiAqIEludGVncmF0ZXMgd2l0aCBkb2N1bWVudCBtYW5hZ2VtZW50IHN5c3RlbSBhbmQgc3VwcG9ydHMgcmVjdXJyaW5nIHBheW1lbnRzXG4gKiB3aXRoIHN0YW5kYXJkIGZyZXF1ZW5jaWVzIChtb250aGx5LCBxdWFydGVybHksIGFubnVhbGx5KSBhbmQgY3VzdG9tIHNjaGVkdWxpbmcuXG4gKi9cbmV4cG9ydCBjb25zdCBpbnZvaWNlcyA9IHBnVGFibGUoJ2ludm9pY2VzJywge1xuICBpZDogdmFyY2hhcignaWQnKVxuICAgIC5wcmltYXJ5S2V5KClcbiAgICAuZGVmYXVsdChzcWxgZ2VuX3JhbmRvbV91dWlkKClgKSxcbiAgXG4gIC8vIENvcmUgaW52b2ljZSBmaWVsZHMgYXMgc3BlY2lmaWVkIGluIHJlcXVpcmVtZW50c1xuICB2ZW5kb3JOYW1lOiB0ZXh0KCd2ZW5kb3JfbmFtZScpLm5vdE51bGwoKSxcbiAgaW52b2ljZU51bWJlcjogdGV4dCgnaW52b2ljZV9udW1iZXInKS5ub3ROdWxsKCksXG4gIHRvdGFsQW1vdW50OiBkZWNpbWFsKCd0b3RhbF9hbW91bnQnLCB7IHByZWNpc2lvbjogMTIsIHNjYWxlOiAyIH0pLm5vdE51bGwoKSxcbiAgZHVlRGF0ZTogZGF0ZSgnZHVlX2RhdGUnKS5ub3ROdWxsKCksXG4gIFxuICAvLyBQYXltZW50IHN0cnVjdHVyZSBmaWVsZHNcbiAgcGF5bWVudFR5cGU6IGludm9pY2VQYXltZW50VHlwZUVudW0oJ3BheW1lbnRfdHlwZScpLm5vdE51bGwoKSxcbiAgXG4gIC8vIFJlY3VycmluZyBwYXltZW50IGZpZWxkcyAoY29uZGl0aW9uYWwgYmFzZWQgb24gcGF5bWVudFR5cGUpXG4gIGZyZXF1ZW5jeTogaW52b2ljZUZyZXF1ZW5jeUVudW0oJ2ZyZXF1ZW5jeScpLCAvLyBPbmx5IGZvciByZWN1cnJpbmcgcGF5bWVudHNcbiAgc3RhcnREYXRlOiBkYXRlKCdzdGFydF9kYXRlJyksIC8vIEZvciBzdGFuZGFyZCBmcmVxdWVuY2llcyAobm90IGN1c3RvbSlcbiAgY3VzdG9tUGF5bWVudERhdGVzOiBkYXRlKCdjdXN0b21fcGF5bWVudF9kYXRlcycpLmFycmF5KCksIC8vIE9ubHkgZm9yIGN1c3RvbSBmcmVxdWVuY3lcbiAgXG4gIC8vIERvY3VtZW50IGludGVncmF0aW9uIC0gbGlua3MgdG8gdXBsb2FkZWQgaW52b2ljZSBmaWxlIChvcHRpb25hbCBmb3IgdGVzdGluZylcbiAgZG9jdW1lbnRJZDogdmFyY2hhcignZG9jdW1lbnRfaWQnKVxuICAgIC5yZWZlcmVuY2VzKCgpID0+IGRvY3VtZW50cy5pZCksXG4gIFxuICAvLyBBSSBleHRyYWN0aW9uIHRyYWNraW5nXG4gIGlzQWlFeHRyYWN0ZWQ6IGJvb2xlYW4oJ2lzX2FpX2V4dHJhY3RlZCcpLmRlZmF1bHQoZmFsc2UpLm5vdE51bGwoKSxcbiAgYWlFeHRyYWN0aW9uRGF0YToganNvbmIoJ2FpX2V4dHJhY3Rpb25fZGF0YScpLCAvLyBSYXcgQUkgcmVzcG9uc2UgZm9yIGRlYnVnZ2luZ1xuICBleHRyYWN0aW9uQ29uZmlkZW5jZTogZGVjaW1hbCgnZXh0cmFjdGlvbl9jb25maWRlbmNlJywgeyBwcmVjaXNpb246IDUsIHNjYWxlOiA0IH0pLCAvLyBBSSBjb25maWRlbmNlIHNjb3JlXG4gIFxuICAvLyBCdWlsZGluZy9yZXNpZGVuY2UgYXNzb2NpYXRpb25cbiAgYnVpbGRpbmdJZDogdmFyY2hhcignYnVpbGRpbmdfaWQnKS5yZWZlcmVuY2VzKCgpID0+IGJ1aWxkaW5ncy5pZCksXG4gIHJlc2lkZW5jZUlkOiB2YXJjaGFyKCdyZXNpZGVuY2VfaWQnKS5yZWZlcmVuY2VzKCgpID0+IHJlc2lkZW5jZXMuaWQpLFxuICBcbiAgLy8gQXVkaXQgZmllbGRzXG4gIGNyZWF0ZWRCeTogdmFyY2hhcignY3JlYXRlZF9ieScpXG4gICAgLm5vdE51bGwoKVxuICAgIC5yZWZlcmVuY2VzKCgpID0+IHVzZXJzLmlkKSxcbiAgY3JlYXRlZEF0OiB0aW1lc3RhbXAoJ2NyZWF0ZWRfYXQnKS5kZWZhdWx0Tm93KCkubm90TnVsbCgpLFxuICB1cGRhdGVkQXQ6IHRpbWVzdGFtcCgndXBkYXRlZF9hdCcpLmRlZmF1bHROb3coKS5ub3ROdWxsKCksXG59KTtcblxuLy8gWm9kIHZhbGlkYXRpb24gc2NoZW1hcyB3aXRoIGNvbmRpdGlvbmFsIGxvZ2ljIGZvciByZWN1cnJpbmcgcGF5bWVudHNcbmV4cG9ydCBjb25zdCBpbnNlcnRJbnZvaWNlU2NoZW1hID0gY3JlYXRlSW5zZXJ0U2NoZW1hKGludm9pY2VzLCB7XG4gIC8vIENvcmUgZmllbGQgdmFsaWRhdGlvbnNcbiAgdmVuZG9yTmFtZTogei5zdHJpbmcoKS5taW4oMSwgJ1ZlbmRvciBuYW1lIGlzIHJlcXVpcmVkJykubWF4KDI1NSwgJ1ZlbmRvciBuYW1lIHRvbyBsb25nJyksXG4gIGludm9pY2VOdW1iZXI6IHouc3RyaW5nKCkubWluKDEsICdJbnZvaWNlIG51bWJlciBpcyByZXF1aXJlZCcpLm1heCgxMDAsICdJbnZvaWNlIG51bWJlciB0b28gbG9uZycpLFxuICB0b3RhbEFtb3VudDogei5jb2VyY2UubnVtYmVyKCkucG9zaXRpdmUoJ1RvdGFsIGFtb3VudCBtdXN0IGJlIHBvc2l0aXZlJyksXG4gIGR1ZURhdGU6IHouY29lcmNlLmRhdGUoKSxcbiAgXG4gIC8vIFBheW1lbnQgdHlwZSB2YWxpZGF0aW9uXG4gIHBheW1lbnRUeXBlOiB6LmVudW0oWydvbmUtdGltZScsICdyZWN1cnJpbmcnXSksXG4gIFxuICAvLyBGcmVxdWVuY3kgdmFsaWRhdGlvbiAob25seSBmb3IgcmVjdXJyaW5nKVxuICBmcmVxdWVuY3k6IHouZW51bShbJ21vbnRobHknLCAncXVhcnRlcmx5JywgJ2FubnVhbGx5JywgJ2N1c3RvbSddKS5vcHRpb25hbCgpLFxuICBcbiAgLy8gU3RhcnQgZGF0ZSB2YWxpZGF0aW9uIChmb3Igc3RhbmRhcmQgZnJlcXVlbmNpZXMpXG4gIHN0YXJ0RGF0ZTogei5jb2VyY2UuZGF0ZSgpLm9wdGlvbmFsKCksXG4gIFxuICAvLyBDdXN0b20gZGF0ZXMgdmFsaWRhdGlvbiAob25seSBmb3IgY3VzdG9tIGZyZXF1ZW5jeSlcbiAgY3VzdG9tUGF5bWVudERhdGVzOiB6LmFycmF5KHouY29lcmNlLmRhdGUoKSkub3B0aW9uYWwoKS5yZWZpbmUoXG4gICAgKGRhdGVzKSA9PiAhZGF0ZXMgfHwgZGF0ZXMubGVuZ3RoID09PSAwIHx8IGRhdGVzLmV2ZXJ5KGRhdGUgPT4gZGF0ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKGRhdGUuZ2V0VGltZSgpKSksXG4gICAgXCJBbGwgY3VzdG9tIHBheW1lbnQgZGF0ZXMgbXVzdCBiZSB2YWxpZCBkYXRlc1wiXG4gICksXG4gIFxuICAvLyBEb2N1bWVudCByZWZlcmVuY2UgKG9wdGlvbmFsIGZvciB0ZXN0aW5nKVxuICBkb2N1bWVudElkOiB6LnN0cmluZygpLnV1aWQoJ0ludmFsaWQgZG9jdW1lbnQgSUQnKS5vcHRpb25hbCgpLFxuICBcbiAgLy8gT3B0aW9uYWwgYXNzb2NpYXRpb25zXG4gIGJ1aWxkaW5nSWQ6IHouc3RyaW5nKCkudXVpZCgpLm9wdGlvbmFsKCksXG4gIHJlc2lkZW5jZUlkOiB6LnN0cmluZygpLnV1aWQoKS5vcHRpb25hbCgpLFxuICBcbiAgLy8gQUkgZmllbGRzXG4gIGlzQWlFeHRyYWN0ZWQ6IHouYm9vbGVhbigpLmRlZmF1bHQoZmFsc2UpLFxuICBleHRyYWN0aW9uQ29uZmlkZW5jZTogei5jb2VyY2UubnVtYmVyKCkubWluKDApLm1heCgxKS5vcHRpb25hbCgpLFxufSkub21pdCh7IFxuICBpZDogdHJ1ZSwgXG4gIGNyZWF0ZWRBdDogdHJ1ZSwgXG4gIHVwZGF0ZWRBdDogdHJ1ZSBcbn0pO1xuXG4vLyBCYXNlIGluc2VydCBzY2hlbWEgd2l0aG91dCByZWZpbmVtZW50c1xuZXhwb3J0IGNvbnN0IGJhc2VJbnZvaWNlSW5zZXJ0U2NoZW1hID0gaW5zZXJ0SW52b2ljZVNjaGVtYTtcblxuLy8gRW5oYW5jZWQgdmFsaWRhdGlvbiB3aXRoIGNvbmRpdGlvbmFsIGxvZ2ljIGZvciByZWN1cnJpbmcgcGF5bWVudHNcbmV4cG9ydCBjb25zdCBpbnZvaWNlRm9ybVNjaGVtYSA9IHoub2JqZWN0KHtcbiAgdGl0bGU6IHouc3RyaW5nKCkubWluKDEsICdUaXRsZSBpcyByZXF1aXJlZCcpLFxuICBkZXNjcmlwdGlvbjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBhbW91bnQ6IHouc3RyaW5nKCkubWluKDEsICdBbW91bnQgaXMgcmVxdWlyZWQnKSxcbiAgZHVlRGF0ZTogei5jb2VyY2UuZGF0ZSgpLFxuICBjYXRlZ29yeTogei5zdHJpbmcoKS5taW4oMSwgJ0NhdGVnb3J5IGlzIHJlcXVpcmVkJyksXG4gIHBheW1lbnRUeXBlOiB6LmVudW0oWydvbmUtdGltZScsICdyZWN1cnJpbmcnXSksXG4gIGZyZXF1ZW5jeTogei5lbnVtKFsnbW9udGhseScsICdxdWFydGVybHknLCAnYW5udWFsbHknLCAnY3VzdG9tJ10pLm9wdGlvbmFsKCksXG4gIHN0YXJ0RGF0ZTogei5jb2VyY2UuZGF0ZSgpLm9wdGlvbmFsKCksXG4gIGN1c3RvbVBheW1lbnREYXRlczogei5hcnJheSh6LmNvZXJjZS5kYXRlKCkpLm9wdGlvbmFsKCksXG4gIGRvY3VtZW50SWQ6IHouc3RyaW5nKCkudXVpZCgnSW52YWxpZCBkb2N1bWVudCBJRCcpLm9wdGlvbmFsKCksXG4gIGJ1aWxkaW5nSWQ6IHouc3RyaW5nKCkudXVpZCgpLm9wdGlvbmFsKCksXG4gIHJlc2lkZW5jZUlkOiB6LnN0cmluZygpLnV1aWQoKS5vcHRpb25hbCgpLFxuICBpc0FpRXh0cmFjdGVkOiB6LmJvb2xlYW4oKS5kZWZhdWx0KGZhbHNlKSxcbiAgZXh0cmFjdGlvbkNvbmZpZGVuY2U6IHouY29lcmNlLm51bWJlcigpLm1pbigwKS5tYXgoMSkub3B0aW9uYWwoKSxcbn0pLnN1cGVyUmVmaW5lKChkYXRhLCBjdHgpID0+IHtcbiAgLy8gUmVjdXJyaW5nIHBheW1lbnQgdmFsaWRhdGlvblxuICBpZiAoZGF0YS5wYXltZW50VHlwZSA9PT0gJ3JlY3VycmluZycpIHtcbiAgICBpZiAoIWRhdGEuZnJlcXVlbmN5KSB7XG4gICAgICBjdHguYWRkSXNzdWUoe1xuICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgIG1lc3NhZ2U6ICdGcmVxdWVuY3kgaXMgcmVxdWlyZWQgZm9yIHJlY3VycmluZyBwYXltZW50cycsXG4gICAgICAgIHBhdGg6IFsnZnJlcXVlbmN5J10sXG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLy8gU3RhbmRhcmQgZnJlcXVlbmN5IHZhbGlkYXRpb24gKG1vbnRobHksIHF1YXJ0ZXJseSwgYW5udWFsbHkpXG4gICAgaWYgKGRhdGEuZnJlcXVlbmN5ICYmIFsnbW9udGhseScsICdxdWFydGVybHknLCAnYW5udWFsbHknXS5pbmNsdWRlcyhkYXRhLmZyZXF1ZW5jeSkpIHtcbiAgICAgIGlmICghZGF0YS5zdGFydERhdGUpIHtcbiAgICAgICAgY3R4LmFkZElzc3VlKHtcbiAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgbWVzc2FnZTogJ1N0YXJ0IGRhdGUgaXMgcmVxdWlyZWQgZm9yIHN0YW5kYXJkIHJlY3VycmluZyBmcmVxdWVuY2llcycsXG4gICAgICAgICAgcGF0aDogWydzdGFydERhdGUnXSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEVuc3VyZSBjdXN0b20gZGF0ZXMgYXJlIG5vdCBzZXQgZm9yIHN0YW5kYXJkIGZyZXF1ZW5jaWVzXG4gICAgICBpZiAoZGF0YS5jdXN0b21QYXltZW50RGF0ZXMgJiYgZGF0YS5jdXN0b21QYXltZW50RGF0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBjdHguYWRkSXNzdWUoe1xuICAgICAgICAgIGNvZGU6IHouWm9kSXNzdWVDb2RlLmN1c3RvbSxcbiAgICAgICAgICBtZXNzYWdlOiAnQ3VzdG9tIHBheW1lbnQgZGF0ZXMgc2hvdWxkIG5vdCBiZSBzZXQgZm9yIHN0YW5kYXJkIGZyZXF1ZW5jaWVzJyxcbiAgICAgICAgICBwYXRoOiBbJ2N1c3RvbVBheW1lbnREYXRlcyddLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLy8gQ3VzdG9tIGZyZXF1ZW5jeSB2YWxpZGF0aW9uXG4gICAgaWYgKGRhdGEuZnJlcXVlbmN5ID09PSAnY3VzdG9tJykge1xuICAgICAgaWYgKCFkYXRhLmN1c3RvbVBheW1lbnREYXRlcyB8fCBkYXRhLmN1c3RvbVBheW1lbnREYXRlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgY3R4LmFkZElzc3VlKHtcbiAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgbWVzc2FnZTogJ0F0IGxlYXN0IG9uZSBjdXN0b20gcGF5bWVudCBkYXRlIGlzIHJlcXVpcmVkIGZvciBjdXN0b20gZnJlcXVlbmN5JyxcbiAgICAgICAgICBwYXRoOiBbJ2N1c3RvbVBheW1lbnREYXRlcyddLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gRW5zdXJlIHN0YXJ0IGRhdGUgaXMgbm90IHNldCBmb3IgY3VzdG9tIGZyZXF1ZW5jeVxuICAgICAgaWYgKGRhdGEuc3RhcnREYXRlKSB7XG4gICAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgICAgY29kZTogei5ab2RJc3N1ZUNvZGUuY3VzdG9tLFxuICAgICAgICAgIG1lc3NhZ2U6ICdTdGFydCBkYXRlIHNob3VsZCBub3QgYmUgc2V0IGZvciBjdXN0b20gZnJlcXVlbmN5JyxcbiAgICAgICAgICBwYXRoOiBbJ3N0YXJ0RGF0ZSddLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gVmFsaWRhdGUgY3VzdG9tIGRhdGVzIGFyZSBpbiB0aGUgZnV0dXJlIGFuZCBzb3J0ZWRcbiAgICAgIGlmIChkYXRhLmN1c3RvbVBheW1lbnREYXRlcyAmJiBkYXRhLmN1c3RvbVBheW1lbnREYXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgdG9kYXkuc2V0SG91cnMoMCwgMCwgMCwgMCk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzb3J0ZWREYXRlcyA9IFsuLi5kYXRhLmN1c3RvbVBheW1lbnREYXRlc10uc29ydCgoYSwgYikgPT4gYS5nZXRUaW1lKCkgLSBiLmdldFRpbWUoKSk7XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBpZiBkYXRlcyBhcmUgaW4gY2hyb25vbG9naWNhbCBvcmRlclxuICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkoZGF0YS5jdXN0b21QYXltZW50RGF0ZXMpICE9PSBKU09OLnN0cmluZ2lmeShzb3J0ZWREYXRlcykpIHtcbiAgICAgICAgICBjdHguYWRkSXNzdWUoe1xuICAgICAgICAgICAgY29kZTogei5ab2RJc3N1ZUNvZGUuY3VzdG9tLFxuICAgICAgICAgICAgbWVzc2FnZTogJ0N1c3RvbSBwYXltZW50IGRhdGVzIG11c3QgYmUgaW4gY2hyb25vbG9naWNhbCBvcmRlcicsXG4gICAgICAgICAgICBwYXRoOiBbJ2N1c3RvbVBheW1lbnREYXRlcyddLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBmb3IgZHVwbGljYXRlIGRhdGVzXG4gICAgICAgIGNvbnN0IHVuaXF1ZURhdGVzID0gbmV3IFNldChkYXRhLmN1c3RvbVBheW1lbnREYXRlcy5tYXAoZCA9PiBkLnRvSVNPU3RyaW5nKCkpKTtcbiAgICAgICAgaWYgKHVuaXF1ZURhdGVzLnNpemUgIT09IGRhdGEuY3VzdG9tUGF5bWVudERhdGVzLmxlbmd0aCkge1xuICAgICAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgICBtZXNzYWdlOiAnQ3VzdG9tIHBheW1lbnQgZGF0ZXMgbXVzdCBiZSB1bmlxdWUnLFxuICAgICAgICAgICAgcGF0aDogWydjdXN0b21QYXltZW50RGF0ZXMnXSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyBPbmUtdGltZSBwYXltZW50IHZhbGlkYXRpb24gLSBlbnN1cmUgcmVjdXJyaW5nIGZpZWxkcyBhcmUgbm90IHNldFxuICAgIGlmIChkYXRhLmZyZXF1ZW5jeSB8fCBkYXRhLnN0YXJ0RGF0ZSB8fCAoZGF0YS5jdXN0b21QYXltZW50RGF0ZXMgJiYgZGF0YS5jdXN0b21QYXltZW50RGF0ZXMubGVuZ3RoID4gMCkpIHtcbiAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgIGNvZGU6IHouWm9kSXNzdWVDb2RlLmN1c3RvbSxcbiAgICAgICAgbWVzc2FnZTogJ1JlY3VycmluZyBwYXltZW50IGZpZWxkcyBzaG91bGQgbm90IGJlIHNldCBmb3Igb25lLXRpbWUgcGF5bWVudHMnLFxuICAgICAgICBwYXRoOiBbJ3BheW1lbnRUeXBlJ10sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn0pO1xuXG4vLyBBSSBleHRyYWN0aW9uIHJlc3BvbnNlIHNjaGVtYSBmb3IgR2VtaW5pIEFQSVxuZXhwb3J0IGNvbnN0IGFpRXh0cmFjdGlvblJlc3BvbnNlU2NoZW1hID0gei5vYmplY3Qoe1xuICB2ZW5kb3JOYW1lOiB6LnN0cmluZygpLm51bGxhYmxlKCksXG4gIGludm9pY2VOdW1iZXI6IHouc3RyaW5nKCkubnVsbGFibGUoKSxcbiAgdG90YWxBbW91bnQ6IHoubnVtYmVyKCkubnVsbGFibGUoKSxcbiAgZHVlRGF0ZTogei5zdHJpbmcoKS5udWxsYWJsZSgpLCAvLyBXaWxsIGJlIGNvbnZlcnRlZCB0byBEYXRlXG4gIHBheW1lbnRUeXBlOiB6LmVudW0oWydvbmUtdGltZScsICdyZWN1cnJpbmcnXSkubnVsbGFibGUoKSxcbiAgZnJlcXVlbmN5OiB6LmVudW0oWydtb250aGx5JywgJ3F1YXJ0ZXJseScsICdhbm51YWxseScsICdjdXN0b20nXSkubnVsbGFibGUoKSxcbiAgc3RhcnREYXRlOiB6LnN0cmluZygpLm51bGxhYmxlKCksIC8vIFdpbGwgYmUgY29udmVydGVkIHRvIERhdGVcbiAgY3VzdG9tUGF5bWVudERhdGVzOiB6LmFycmF5KHouc3RyaW5nKCkpLm51bGxhYmxlKCksIC8vIFdpbGwgYmUgY29udmVydGVkIHRvIERhdGVbXVxufSk7XG5cbi8vIFR5cGVzXG5leHBvcnQgdHlwZSBJbnZvaWNlID0gdHlwZW9mIGludm9pY2VzLiRpbmZlclNlbGVjdDtcbmV4cG9ydCB0eXBlIEluc2VydEludm9pY2UgPSB6LmluZmVyPHR5cGVvZiBpbnNlcnRJbnZvaWNlU2NoZW1hPjtcbmV4cG9ydCB0eXBlIEludm9pY2VGb3JtRGF0YSA9IHouaW5mZXI8dHlwZW9mIGludm9pY2VGb3JtU2NoZW1hPjtcbmV4cG9ydCB0eXBlIEFpRXh0cmFjdGlvblJlc3BvbnNlID0gei5pbmZlcjx0eXBlb2YgYWlFeHRyYWN0aW9uUmVzcG9uc2VTY2hlbWE+O1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29udmVydCBBSSByZXNwb25zZSB0byBmb3JtIGRhdGFcbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0QWlSZXNwb25zZVRvRm9ybURhdGEoYWlSZXNwb25zZTogQWlFeHRyYWN0aW9uUmVzcG9uc2UpOiBQYXJ0aWFsPEludm9pY2VGb3JtRGF0YT4ge1xuICByZXR1cm4ge1xuICAgIHZlbmRvck5hbWU6IGFpUmVzcG9uc2UudmVuZG9yTmFtZSB8fCAnJyxcbiAgICBpbnZvaWNlTnVtYmVyOiBhaVJlc3BvbnNlLmludm9pY2VOdW1iZXIgfHwgJycsXG4gICAgdG90YWxBbW91bnQ6IGFpUmVzcG9uc2UudG90YWxBbW91bnQgfHwgMCxcbiAgICBkdWVEYXRlOiBhaVJlc3BvbnNlLmR1ZURhdGUgPyBuZXcgRGF0ZShhaVJlc3BvbnNlLmR1ZURhdGUpIDogbmV3IERhdGUoKSxcbiAgICBwYXltZW50VHlwZTogYWlSZXNwb25zZS5wYXltZW50VHlwZSB8fCAnb25lLXRpbWUnLFxuICAgIGZyZXF1ZW5jeTogYWlSZXNwb25zZS5mcmVxdWVuY3kgfHwgdW5kZWZpbmVkLFxuICAgIHN0YXJ0RGF0ZTogYWlSZXNwb25zZS5zdGFydERhdGUgPyBuZXcgRGF0ZShhaVJlc3BvbnNlLnN0YXJ0RGF0ZSkgOiB1bmRlZmluZWQsXG4gICAgY3VzdG9tUGF5bWVudERhdGVzOiBhaVJlc3BvbnNlLmN1c3RvbVBheW1lbnREYXRlcyBcbiAgICAgID8gYWlSZXNwb25zZS5jdXN0b21QYXltZW50RGF0ZXMubWFwKGRhdGUgPT4gbmV3IERhdGUoZGF0ZSkpXG4gICAgICA6IHVuZGVmaW5lZCxcbiAgfTtcbn0iXSwidmVyc2lvbiI6M30=