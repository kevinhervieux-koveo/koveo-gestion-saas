da0804594e7014ff0c94db647f16c9c2
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const supertest_1 = __importDefault(require("supertest"));
const express_1 = __importDefault(require("express"));
const routes_1 = require("../../server/routes");
const db_1 = require("../../server/db");
const schema = __importStar(require("../../shared/schema"));
const drizzle_orm_1 = require("drizzle-orm");
// Create test app similar to existing tests
const createTestApp = () => {
    const app = (0, express_1.default)();
    app.use(express_1.default.json());
    app.use(express_1.default.urlencoded({ extended: true }));
    // Add test authentication middleware that bypasses real auth
    app.use(async (req, res, next) => {
        const testUserId = req.headers['x-test-user-id'];
        if (testUserId) {
            const [user] = await db_1.db.select().from(schema.users).where((0, drizzle_orm_1.eq)(schema.users.id, testUserId)).limit(1);
            if (user) {
                req.session = {
                    userId: testUserId,
                    isAuthenticated: true,
                    role: user.role
                };
                req.user = user;
            }
        }
        next();
    });
    (0, routes_1.registerRoutes)(app);
    return app;
};
(0, globals_1.describe)('User Management Permissions', () => {
    let app;
    let adminUser;
    let demoManager;
    let regularManager;
    let testOrg;
    (0, globals_1.beforeEach)(async () => {
        app = createTestApp();
        // Clean test data
        await db_1.db.delete(schema.userOrganizations);
        await db_1.db.delete(schema.users);
        await db_1.db.delete(schema.organizations);
        // Create test organization
        const [org] = await db_1.db
            .insert(schema.organizations)
            .values({
            name: 'Test Organization',
            type: 'Standard',
            address: '123 Test St',
            city: 'Test City',
            province: 'QC',
            postalCode: 'H1H 1H1',
            phone: '514-555-0123',
            email: 'test@org.com',
        })
            .returning();
        testOrg = org;
        // Create test users
        const users = await db_1.db
            .insert(schema.users)
            .values([
            {
                email: 'admin@test.com',
                username: 'admin',
                password: 'hashedpass',
                firstName: 'Admin',
                lastName: 'User',
                role: 'admin',
                isActive: true,
                phone: '514-555-0001',
            },
            {
                email: 'demo.manager@test.com',
                username: 'demo_manager',
                password: 'hashedpass',
                firstName: 'Demo',
                lastName: 'Manager',
                role: 'demo_manager',
                isActive: true,
                phone: '514-555-0002',
            },
            {
                email: 'regular.manager@test.com',
                username: 'regular_manager',
                password: 'hashedpass',
                firstName: 'Regular',
                lastName: 'Manager',
                role: 'manager',
                isActive: true,
                phone: '514-555-0003',
            },
            {
                email: 'demo.tenant@test.com',
                username: 'demo_tenant',
                password: 'hashedpass',
                firstName: 'Demo',
                lastName: 'Tenant',
                role: 'demo_tenant',
                isActive: true,
                phone: '514-555-0004',
            },
            {
                email: 'regular.tenant@test.com',
                username: 'regular_tenant',
                password: 'hashedpass',
                firstName: 'Regular',
                lastName: 'Tenant',
                role: 'tenant',
                isActive: true,
                phone: '514-555-0005',
            }
        ])
            .returning();
        adminUser = users.find(u => u.email === 'admin@test.com');
        demoManager = users.find(u => u.email === 'demo.manager@test.com');
        regularManager = users.find(u => u.email === 'regular.manager@test.com');
        const regularTenant = users.find(u => u.email === 'regular.tenant@test.com');
        // Assign regular manager and tenant to organization
        await db_1.db
            .insert(schema.userOrganizations)
            .values([
            {
                userId: regularManager.id,
                organizationId: testOrg.id,
                organizationRole: 'manager',
                isActive: true,
            },
            {
                userId: regularTenant.id,
                organizationId: testOrg.id,
                organizationRole: 'tenant',
                isActive: true,
            }
        ]);
    });
    (0, globals_1.afterEach)(async () => {
        await db_1.db.delete(schema.userOrganizations);
        await db_1.db.delete(schema.users);
        await db_1.db.delete(schema.organizations);
    });
    (0, globals_1.describe)('Demo User Visibility', () => {
        (0, globals_1.it)('should show only demo users to demo manager', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/users')
                .set('x-test-user-id', demoManager.id)
                .expect(200);
            const users = response.body;
            const visibleRoles = users.map((user) => user.role);
            // Demo manager should only see demo users
            (0, globals_1.expect)(visibleRoles).toContain('demo_manager');
            (0, globals_1.expect)(visibleRoles).toContain('demo_tenant');
            // Should NOT see regular roles
            (0, globals_1.expect)(visibleRoles).not.toContain('admin');
            (0, globals_1.expect)(visibleRoles).not.toContain('manager');
            (0, globals_1.expect)(visibleRoles).not.toContain('tenant');
        });
        (0, globals_1.it)('should allow regular manager to see non-demo users in their organization', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/users')
                .set('x-test-user-id', regularManager.id)
                .expect(200);
            const users = response.body;
            const visibleEmails = users.map((user) => user.email);
            // Should see users in their organization
            (0, globals_1.expect)(visibleEmails).toContain('regular.tenant@test.com');
            (0, globals_1.expect)(visibleEmails).toContain('regular.manager@test.com');
            // Should NOT see demo users
            (0, globals_1.expect)(visibleEmails).not.toContain('demo.tenant@test.com');
            (0, globals_1.expect)(visibleEmails).not.toContain('demo.manager@test.com');
        });
        (0, globals_1.it)('should allow admin to see all users', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/users')
                .set('x-test-user-id', adminUser.id)
                .expect(200);
            const users = response.body;
            const visibleEmails = users.map((user) => user.email);
            // Admin should see all users
            (0, globals_1.expect)(visibleEmails).toContain('admin@test.com');
            (0, globals_1.expect)(visibleEmails).toContain('regular.manager@test.com');
            (0, globals_1.expect)(visibleEmails).toContain('demo.manager@test.com');
            (0, globals_1.expect)(visibleEmails).toContain('demo.tenant@test.com');
            (0, globals_1.expect)(visibleEmails).toContain('regular.tenant@test.com');
        });
    });
    (0, globals_1.describe)('Organization Assignment Restrictions', () => {
        (0, globals_1.it)('should prevent regular manager from modifying organization assignments', async () => {
            const [user] = await db_1.db
                .insert(schema.users)
                .values({
                email: 'testuser@test.com',
                username: 'testuser',
                password: 'hashedpass',
                firstName: 'Test',
                lastName: 'User',
                role: 'tenant',
                isActive: true,
                phone: '514-555-0006',
            })
                .returning();
            // Manager tries to assign organization (should fail)
            const response = await (0, supertest_1.default)(app)
                .put(`/api/users/${user.id}/organizations`)
                .set('x-test-user-id', regularManager.id)
                .send({ organizationIds: [testOrg.id] })
                .expect(403);
            (0, globals_1.expect)(response.body.message).toContain('Only administrators can modify organization assignments');
        });
        (0, globals_1.it)('should allow admin to modify organization assignments', async () => {
            const [user] = await db_1.db
                .insert(schema.users)
                .values({
                email: 'testuser2@test.com',
                username: 'testuser2',
                password: 'hashedpass',
                firstName: 'Test2',
                lastName: 'User2',
                role: 'tenant',
                isActive: true,
                phone: '514-555-0007',
            })
                .returning();
            // Admin assigns organization (should succeed)
            const response = await (0, supertest_1.default)(app)
                .put(`/api/users/${user.id}/organizations`)
                .set('x-test-user-id', adminUser.id)
                .send({ organizationIds: [testOrg.id] })
                .expect(200);
            (0, globals_1.expect)(response.body.message).toBe('Organization assignments updated successfully');
            // Verify assignment was created
            const assignments = await db_1.db
                .select()
                .from(schema.userOrganizations)
                .where((0, drizzle_orm_1.eq)(schema.userOrganizations.userId, user.id));
            (0, globals_1.expect)(assignments).toHaveLength(1);
            (0, globals_1.expect)(assignments[0].organizationId).toBe(testOrg.id);
        });
    });
    (0, globals_1.describe)('Residence Assignment Permissions', () => {
        (0, globals_1.it)('should prevent managers from assigning residences outside their organization', async () => {
            // This test validates that the existing permission checks work
            // The implementation is already in place in the residence assignment endpoint
            const [user] = await db_1.db
                .insert(schema.users)
                .values({
                email: 'testresuser@test.com',
                username: 'testresuser',
                password: 'hashedpass',
                firstName: 'TestRes',
                lastName: 'User',
                role: 'tenant',
                isActive: true,
                phone: '514-555-0008',
            })
                .returning();
            // Try to assign non-existent residence (should fail gracefully)
            const response = await (0, supertest_1.default)(app)
                .put(`/api/users/${user.id}/residences`)
                .set('x-test-user-id', regularManager.id)
                .send({
                residenceAssignments: [
                    {
                        residenceId: 'non-existent-residence-id',
                        relationshipType: 'tenant',
                        startDate: new Date().toISOString().split('T')[0],
                    }
                ]
            });
            // Should fail with 404 for non-existent residence
            (0, globals_1.expect)(response.status).toBeGreaterThanOrEqual(400);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9pbnRlZ3JhdGlvbi91c2VyLW1hbmFnZW1lbnQtcGVybWlzc2lvbnMudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0RTtBQUM1RSwwREFBZ0M7QUFDaEMsc0RBQThCO0FBQzlCLGdEQUFxRDtBQUNyRCx3Q0FBcUM7QUFDckMsNERBQThDO0FBQzlDLDZDQUFzQztBQUV0Qyw0Q0FBNEM7QUFDNUMsTUFBTSxhQUFhLEdBQUcsR0FBRyxFQUFFO0lBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0lBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRWhELDZEQUE2RDtJQUM3RCxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNqRCxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sT0FBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRyxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUNULEdBQUcsQ0FBQyxPQUFPLEdBQUc7b0JBQ1osTUFBTSxFQUFFLFVBQVU7b0JBQ2xCLGVBQWUsRUFBRSxJQUFJO29CQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7aUJBQ2hCLENBQUM7Z0JBQ0YsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFDbEIsQ0FBQztRQUNILENBQUM7UUFDRCxJQUFJLEVBQUUsQ0FBQztJQUNULENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSx1QkFBYyxFQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBRUYsSUFBQSxrQkFBUSxFQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRTtJQUMzQyxJQUFJLEdBQXdCLENBQUM7SUFDN0IsSUFBSSxTQUFjLENBQUM7SUFDbkIsSUFBSSxXQUFnQixDQUFDO0lBQ3JCLElBQUksY0FBbUIsQ0FBQztJQUN4QixJQUFJLE9BQVksQ0FBQztJQUVqQixJQUFBLG9CQUFVLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsR0FBRyxHQUFHLGFBQWEsRUFBRSxDQUFDO1FBRXRCLGtCQUFrQjtRQUNsQixNQUFNLE9BQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDMUMsTUFBTSxPQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixNQUFNLE9BQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXRDLDJCQUEyQjtRQUMzQixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxPQUFFO2FBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDO2FBQzVCLE1BQU0sQ0FBQztZQUNOLElBQUksRUFBRSxtQkFBbUI7WUFDekIsSUFBSSxFQUFFLFVBQVU7WUFDaEIsT0FBTyxFQUFFLGFBQWE7WUFDdEIsSUFBSSxFQUFFLFdBQVc7WUFDakIsUUFBUSxFQUFFLElBQUk7WUFDZCxVQUFVLEVBQUUsU0FBUztZQUNyQixLQUFLLEVBQUUsY0FBYztZQUNyQixLQUFLLEVBQUUsY0FBYztTQUN0QixDQUFDO2FBQ0QsU0FBUyxFQUFFLENBQUM7UUFDZixPQUFPLEdBQUcsR0FBRyxDQUFDO1FBRWQsb0JBQW9CO1FBQ3BCLE1BQU0sS0FBSyxHQUFHLE1BQU0sT0FBRTthQUNuQixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQzthQUNwQixNQUFNLENBQUM7WUFDTjtnQkFDRSxLQUFLLEVBQUUsZ0JBQWdCO2dCQUN2QixRQUFRLEVBQUUsT0FBTztnQkFDakIsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFNBQVMsRUFBRSxPQUFPO2dCQUNsQixRQUFRLEVBQUUsTUFBTTtnQkFDaEIsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsUUFBUSxFQUFFLElBQUk7Z0JBQ2QsS0FBSyxFQUFFLGNBQWM7YUFDdEI7WUFDRDtnQkFDRSxLQUFLLEVBQUUsdUJBQXVCO2dCQUM5QixRQUFRLEVBQUUsY0FBYztnQkFDeEIsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFNBQVMsRUFBRSxNQUFNO2dCQUNqQixRQUFRLEVBQUUsU0FBUztnQkFDbkIsSUFBSSxFQUFFLGNBQWM7Z0JBQ3BCLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxjQUFjO2FBQ3RCO1lBQ0Q7Z0JBQ0UsS0FBSyxFQUFFLDBCQUEwQjtnQkFDakMsUUFBUSxFQUFFLGlCQUFpQjtnQkFDM0IsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFNBQVMsRUFBRSxTQUFTO2dCQUNwQixRQUFRLEVBQUUsU0FBUztnQkFDbkIsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsUUFBUSxFQUFFLElBQUk7Z0JBQ2QsS0FBSyxFQUFFLGNBQWM7YUFDdEI7WUFDRDtnQkFDRSxLQUFLLEVBQUUsc0JBQXNCO2dCQUM3QixRQUFRLEVBQUUsYUFBYTtnQkFDdkIsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFNBQVMsRUFBRSxNQUFNO2dCQUNqQixRQUFRLEVBQUUsUUFBUTtnQkFDbEIsSUFBSSxFQUFFLGFBQWE7Z0JBQ25CLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxjQUFjO2FBQ3RCO1lBQ0Q7Z0JBQ0UsS0FBSyxFQUFFLHlCQUF5QjtnQkFDaEMsUUFBUSxFQUFFLGdCQUFnQjtnQkFDMUIsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFNBQVMsRUFBRSxTQUFTO2dCQUNwQixRQUFRLEVBQUUsUUFBUTtnQkFDbEIsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsUUFBUSxFQUFFLElBQUk7Z0JBQ2QsS0FBSyxFQUFFLGNBQWM7YUFDdEI7U0FDRixDQUFDO2FBQ0QsU0FBUyxFQUFFLENBQUM7UUFFZixTQUFTLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssZ0JBQWdCLENBQUMsQ0FBQztRQUMxRCxXQUFXLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssdUJBQXVCLENBQUMsQ0FBQztRQUNuRSxjQUFjLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssMEJBQTBCLENBQUMsQ0FBQztRQUN6RSxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSyx5QkFBeUIsQ0FBQyxDQUFDO1FBRTdFLG9EQUFvRDtRQUNwRCxNQUFNLE9BQUU7YUFDTCxNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDO2FBQ2hDLE1BQU0sQ0FBQztZQUNOO2dCQUNFLE1BQU0sRUFBRSxjQUFjLENBQUMsRUFBRTtnQkFDekIsY0FBYyxFQUFFLE9BQU8sQ0FBQyxFQUFFO2dCQUMxQixnQkFBZ0IsRUFBRSxTQUFTO2dCQUMzQixRQUFRLEVBQUUsSUFBSTthQUNmO1lBQ0Q7Z0JBQ0UsTUFBTSxFQUFFLGFBQWEsQ0FBQyxFQUFFO2dCQUN4QixjQUFjLEVBQUUsT0FBTyxDQUFDLEVBQUU7Z0JBQzFCLGdCQUFnQixFQUFFLFFBQVE7Z0JBQzFCLFFBQVEsRUFBRSxJQUFJO2FBQ2Y7U0FDRixDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsbUJBQVMsRUFBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLE9BQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDMUMsTUFBTSxPQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixNQUFNLE9BQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtRQUNwQyxJQUFBLFlBQUUsRUFBQyw2Q0FBNkMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMzRCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUM7aUJBQ2hDLEdBQUcsQ0FBQyxZQUFZLENBQUM7aUJBQ2pCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDO2lCQUNyQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFZixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQzVCLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV6RCwwQ0FBMEM7WUFDMUMsSUFBQSxnQkFBTSxFQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUMvQyxJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRTlDLCtCQUErQjtZQUMvQixJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM1QyxJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5QyxJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsWUFBRSxFQUFDLDBFQUEwRSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3hGLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQztpQkFDaEMsR0FBRyxDQUFDLFlBQVksQ0FBQztpQkFDakIsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxFQUFFLENBQUM7aUJBQ3hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVmLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDNUIsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTNELHlDQUF5QztZQUN6QyxJQUFBLGdCQUFNLEVBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLENBQUM7WUFDM0QsSUFBQSxnQkFBTSxFQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1lBRTVELDRCQUE0QjtZQUM1QixJQUFBLGdCQUFNLEVBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQzVELElBQUEsZ0JBQU0sRUFBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyxxQ0FBcUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNuRCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUM7aUJBQ2hDLEdBQUcsQ0FBQyxZQUFZLENBQUM7aUJBQ2pCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLENBQUMsRUFBRSxDQUFDO2lCQUNuQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFZixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQzVCLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUzRCw2QkFBNkI7WUFDN0IsSUFBQSxnQkFBTSxFQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2xELElBQUEsZ0JBQU0sRUFBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMsMEJBQTBCLENBQUMsQ0FBQztZQUM1RCxJQUFBLGdCQUFNLEVBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDekQsSUFBQSxnQkFBTSxFQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3hELElBQUEsZ0JBQU0sRUFBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtRQUNwRCxJQUFBLFlBQUUsRUFBQyx3RUFBd0UsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN0RixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxPQUFFO2lCQUNwQixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztpQkFDcEIsTUFBTSxDQUFDO2dCQUNOLEtBQUssRUFBRSxtQkFBbUI7Z0JBQzFCLFFBQVEsRUFBRSxVQUFVO2dCQUNwQixRQUFRLEVBQUUsWUFBWTtnQkFDdEIsU0FBUyxFQUFFLE1BQU07Z0JBQ2pCLFFBQVEsRUFBRSxNQUFNO2dCQUNoQixJQUFJLEVBQUUsUUFBUTtnQkFDZCxRQUFRLEVBQUUsSUFBSTtnQkFDZCxLQUFLLEVBQUUsY0FBYzthQUN0QixDQUFDO2lCQUNELFNBQVMsRUFBRSxDQUFDO1lBRWYscURBQXFEO1lBQ3JELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQztpQkFDaEMsR0FBRyxDQUFDLGNBQWMsSUFBSSxDQUFDLEVBQUUsZ0JBQWdCLENBQUM7aUJBQzFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsRUFBRSxDQUFDO2lCQUN4QyxJQUFJLENBQUMsRUFBRSxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztpQkFDdkMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRWYsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLHlEQUF5RCxDQUFDLENBQUM7UUFDckcsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyx1REFBdUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxPQUFFO2lCQUNwQixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztpQkFDcEIsTUFBTSxDQUFDO2dCQUNOLEtBQUssRUFBRSxvQkFBb0I7Z0JBQzNCLFFBQVEsRUFBRSxXQUFXO2dCQUNyQixRQUFRLEVBQUUsWUFBWTtnQkFDdEIsU0FBUyxFQUFFLE9BQU87Z0JBQ2xCLFFBQVEsRUFBRSxPQUFPO2dCQUNqQixJQUFJLEVBQUUsUUFBUTtnQkFDZCxRQUFRLEVBQUUsSUFBSTtnQkFDZCxLQUFLLEVBQUUsY0FBYzthQUN0QixDQUFDO2lCQUNELFNBQVMsRUFBRSxDQUFDO1lBRWYsOENBQThDO1lBQzlDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQztpQkFDaEMsR0FBRyxDQUFDLGNBQWMsSUFBSSxDQUFDLEVBQUUsZ0JBQWdCLENBQUM7aUJBQzFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxTQUFTLENBQUMsRUFBRSxDQUFDO2lCQUNuQyxJQUFJLENBQUMsRUFBRSxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztpQkFDdkMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRWYsSUFBQSxnQkFBTSxFQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLCtDQUErQyxDQUFDLENBQUM7WUFFcEYsZ0NBQWdDO1lBQ2hDLE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBRTtpQkFDekIsTUFBTSxFQUFFO2lCQUNSLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUM7aUJBQzlCLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV2RCxJQUFBLGdCQUFNLEVBQUMsV0FBVyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLElBQUEsZ0JBQU0sRUFBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxrQkFBUSxFQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRTtRQUNoRCxJQUFBLFlBQUUsRUFBQyw4RUFBOEUsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1RiwrREFBK0Q7WUFDL0QsOEVBQThFO1lBRTlFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLE9BQUU7aUJBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2lCQUNwQixNQUFNLENBQUM7Z0JBQ04sS0FBSyxFQUFFLHNCQUFzQjtnQkFDN0IsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLFFBQVEsRUFBRSxZQUFZO2dCQUN0QixTQUFTLEVBQUUsU0FBUztnQkFDcEIsUUFBUSxFQUFFLE1BQU07Z0JBQ2hCLElBQUksRUFBRSxRQUFRO2dCQUNkLFFBQVEsRUFBRSxJQUFJO2dCQUNkLEtBQUssRUFBRSxjQUFjO2FBQ3RCLENBQUM7aUJBQ0QsU0FBUyxFQUFFLENBQUM7WUFFZixnRUFBZ0U7WUFDaEUsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLG1CQUFPLEVBQUMsR0FBRyxDQUFDO2lCQUNoQyxHQUFHLENBQUMsY0FBYyxJQUFJLENBQUMsRUFBRSxhQUFhLENBQUM7aUJBQ3ZDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxjQUFjLENBQUMsRUFBRSxDQUFDO2lCQUN4QyxJQUFJLENBQUM7Z0JBQ0osb0JBQW9CLEVBQUU7b0JBQ3BCO3dCQUNFLFdBQVcsRUFBRSwyQkFBMkI7d0JBQ3hDLGdCQUFnQixFQUFFLFFBQVE7d0JBQzFCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQ2xEO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1lBRUwsa0RBQWtEO1lBQ2xELElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2UvdGVzdHMvaW50ZWdyYXRpb24vdXNlci1tYW5hZ2VtZW50LXBlcm1pc3Npb25zLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2gsIGFmdGVyRWFjaCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgcmVnaXN0ZXJSb3V0ZXMgfSBmcm9tICcuLi8uLi9zZXJ2ZXIvcm91dGVzJztcbmltcG9ydCB7IGRiIH0gZnJvbSAnLi4vLi4vc2VydmVyL2RiJztcbmltcG9ydCAqIGFzIHNjaGVtYSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZW1hJztcbmltcG9ydCB7IGVxLCBhbmQgfSBmcm9tICdkcml6emxlLW9ybSc7XG5cbi8vIENyZWF0ZSB0ZXN0IGFwcCBzaW1pbGFyIHRvIGV4aXN0aW5nIHRlc3RzXG5jb25zdCBjcmVhdGVUZXN0QXBwID0gKCkgPT4ge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuICBhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKTtcbiAgXG4gIC8vIEFkZCB0ZXN0IGF1dGhlbnRpY2F0aW9uIG1pZGRsZXdhcmUgdGhhdCBieXBhc3NlcyByZWFsIGF1dGhcbiAgYXBwLnVzZShhc3luYyAocmVxOiBhbnksIHJlcywgbmV4dCkgPT4ge1xuICAgIGNvbnN0IHRlc3RVc2VySWQgPSByZXEuaGVhZGVyc1sneC10ZXN0LXVzZXItaWQnXTtcbiAgICBpZiAodGVzdFVzZXJJZCkge1xuICAgICAgY29uc3QgW3VzZXJdID0gYXdhaXQgZGIuc2VsZWN0KCkuZnJvbShzY2hlbWEudXNlcnMpLndoZXJlKGVxKHNjaGVtYS51c2Vycy5pZCwgdGVzdFVzZXJJZCkpLmxpbWl0KDEpO1xuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgcmVxLnNlc3Npb24gPSB7IFxuICAgICAgICAgIHVzZXJJZDogdGVzdFVzZXJJZCxcbiAgICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IHRydWUsXG4gICAgICAgICAgcm9sZTogdXNlci5yb2xlXG4gICAgICAgIH07XG4gICAgICAgIHJlcS51c2VyID0gdXNlcjtcbiAgICAgIH1cbiAgICB9XG4gICAgbmV4dCgpO1xuICB9KTtcbiAgXG4gIHJlZ2lzdGVyUm91dGVzKGFwcCk7XG4gIHJldHVybiBhcHA7XG59O1xuXG5kZXNjcmliZSgnVXNlciBNYW5hZ2VtZW50IFBlcm1pc3Npb25zJywgKCkgPT4ge1xuICBsZXQgYXBwOiBleHByZXNzLkFwcGxpY2F0aW9uO1xuICBsZXQgYWRtaW5Vc2VyOiBhbnk7XG4gIGxldCBkZW1vTWFuYWdlcjogYW55O1xuICBsZXQgcmVndWxhck1hbmFnZXI6IGFueTtcbiAgbGV0IHRlc3RPcmc6IGFueTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBhcHAgPSBjcmVhdGVUZXN0QXBwKCk7XG4gICAgXG4gICAgLy8gQ2xlYW4gdGVzdCBkYXRhXG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucyk7XG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS51c2Vycyk7XG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS5vcmdhbml6YXRpb25zKTtcblxuICAgIC8vIENyZWF0ZSB0ZXN0IG9yZ2FuaXphdGlvblxuICAgIGNvbnN0IFtvcmddID0gYXdhaXQgZGJcbiAgICAgIC5pbnNlcnQoc2NoZW1hLm9yZ2FuaXphdGlvbnMpXG4gICAgICAudmFsdWVzKHtcbiAgICAgICAgbmFtZTogJ1Rlc3QgT3JnYW5pemF0aW9uJyxcbiAgICAgICAgdHlwZTogJ1N0YW5kYXJkJyxcbiAgICAgICAgYWRkcmVzczogJzEyMyBUZXN0IFN0JyxcbiAgICAgICAgY2l0eTogJ1Rlc3QgQ2l0eScsXG4gICAgICAgIHByb3ZpbmNlOiAnUUMnLFxuICAgICAgICBwb3N0YWxDb2RlOiAnSDFIIDFIMScsXG4gICAgICAgIHBob25lOiAnNTE0LTU1NS0wMTIzJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QG9yZy5jb20nLFxuICAgICAgfSlcbiAgICAgIC5yZXR1cm5pbmcoKTtcbiAgICB0ZXN0T3JnID0gb3JnO1xuXG4gICAgLy8gQ3JlYXRlIHRlc3QgdXNlcnNcbiAgICBjb25zdCB1c2VycyA9IGF3YWl0IGRiXG4gICAgICAuaW5zZXJ0KHNjaGVtYS51c2VycylcbiAgICAgIC52YWx1ZXMoW1xuICAgICAgICB7XG4gICAgICAgICAgZW1haWw6ICdhZG1pbkB0ZXN0LmNvbScsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhZG1pbicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRwYXNzJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdBZG1pbicsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgICByb2xlOiAnYWRtaW4nLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHBob25lOiAnNTE0LTU1NS0wMDAxJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGVtYWlsOiAnZGVtby5tYW5hZ2VyQHRlc3QuY29tJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2RlbW9fbWFuYWdlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRwYXNzJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdEZW1vJyxcbiAgICAgICAgICBsYXN0TmFtZTogJ01hbmFnZXInLFxuICAgICAgICAgIHJvbGU6ICdkZW1vX21hbmFnZXInLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHBob25lOiAnNTE0LTU1NS0wMDAyJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGVtYWlsOiAncmVndWxhci5tYW5hZ2VyQHRlc3QuY29tJyxcbiAgICAgICAgICB1c2VybmFtZTogJ3JlZ3VsYXJfbWFuYWdlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRwYXNzJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdSZWd1bGFyJyxcbiAgICAgICAgICBsYXN0TmFtZTogJ01hbmFnZXInLFxuICAgICAgICAgIHJvbGU6ICdtYW5hZ2VyJyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBwaG9uZTogJzUxNC01NTUtMDAwMycsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBlbWFpbDogJ2RlbW8udGVuYW50QHRlc3QuY29tJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2RlbW9fdGVuYW50JyxcbiAgICAgICAgICBwYXNzd29yZDogJ2hhc2hlZHBhc3MnLFxuICAgICAgICAgIGZpcnN0TmFtZTogJ0RlbW8nLFxuICAgICAgICAgIGxhc3ROYW1lOiAnVGVuYW50JyxcbiAgICAgICAgICByb2xlOiAnZGVtb190ZW5hbnQnLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHBob25lOiAnNTE0LTU1NS0wMDA0JyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGVtYWlsOiAncmVndWxhci50ZW5hbnRAdGVzdC5jb20nLFxuICAgICAgICAgIHVzZXJuYW1lOiAncmVndWxhcl90ZW5hbnQnLFxuICAgICAgICAgIHBhc3N3b3JkOiAnaGFzaGVkcGFzcycsXG4gICAgICAgICAgZmlyc3ROYW1lOiAnUmVndWxhcicsXG4gICAgICAgICAgbGFzdE5hbWU6ICdUZW5hbnQnLFxuICAgICAgICAgIHJvbGU6ICd0ZW5hbnQnLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHBob25lOiAnNTE0LTU1NS0wMDA1JyxcbiAgICAgICAgfVxuICAgICAgXSlcbiAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgIGFkbWluVXNlciA9IHVzZXJzLmZpbmQodSA9PiB1LmVtYWlsID09PSAnYWRtaW5AdGVzdC5jb20nKTtcbiAgICBkZW1vTWFuYWdlciA9IHVzZXJzLmZpbmQodSA9PiB1LmVtYWlsID09PSAnZGVtby5tYW5hZ2VyQHRlc3QuY29tJyk7XG4gICAgcmVndWxhck1hbmFnZXIgPSB1c2Vycy5maW5kKHUgPT4gdS5lbWFpbCA9PT0gJ3JlZ3VsYXIubWFuYWdlckB0ZXN0LmNvbScpO1xuICAgIGNvbnN0IHJlZ3VsYXJUZW5hbnQgPSB1c2Vycy5maW5kKHUgPT4gdS5lbWFpbCA9PT0gJ3JlZ3VsYXIudGVuYW50QHRlc3QuY29tJyk7XG5cbiAgICAvLyBBc3NpZ24gcmVndWxhciBtYW5hZ2VyIGFuZCB0ZW5hbnQgdG8gb3JnYW5pemF0aW9uXG4gICAgYXdhaXQgZGJcbiAgICAgIC5pbnNlcnQoc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zKVxuICAgICAgLnZhbHVlcyhbXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VySWQ6IHJlZ3VsYXJNYW5hZ2VyLmlkLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiB0ZXN0T3JnLmlkLFxuICAgICAgICAgIG9yZ2FuaXphdGlvblJvbGU6ICdtYW5hZ2VyJyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJJZDogcmVndWxhclRlbmFudC5pZCxcbiAgICAgICAgICBvcmdhbml6YXRpb25JZDogdGVzdE9yZy5pZCxcbiAgICAgICAgICBvcmdhbml6YXRpb25Sb2xlOiAndGVuYW50JyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgfVxuICAgICAgXSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucyk7XG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS51c2Vycyk7XG4gICAgYXdhaXQgZGIuZGVsZXRlKHNjaGVtYS5vcmdhbml6YXRpb25zKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0RlbW8gVXNlciBWaXNpYmlsaXR5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2hvdyBvbmx5IGRlbW8gdXNlcnMgdG8gZGVtbyBtYW5hZ2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS91c2VycycpXG4gICAgICAgIC5zZXQoJ3gtdGVzdC11c2VyLWlkJywgZGVtb01hbmFnZXIuaWQpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgdXNlcnMgPSByZXNwb25zZS5ib2R5O1xuICAgICAgY29uc3QgdmlzaWJsZVJvbGVzID0gdXNlcnMubWFwKCh1c2VyOiBhbnkpID0+IHVzZXIucm9sZSk7XG4gICAgICBcbiAgICAgIC8vIERlbW8gbWFuYWdlciBzaG91bGQgb25seSBzZWUgZGVtbyB1c2Vyc1xuICAgICAgZXhwZWN0KHZpc2libGVSb2xlcykudG9Db250YWluKCdkZW1vX21hbmFnZXInKTtcbiAgICAgIGV4cGVjdCh2aXNpYmxlUm9sZXMpLnRvQ29udGFpbignZGVtb190ZW5hbnQnKTtcbiAgICAgIFxuICAgICAgLy8gU2hvdWxkIE5PVCBzZWUgcmVndWxhciByb2xlc1xuICAgICAgZXhwZWN0KHZpc2libGVSb2xlcykubm90LnRvQ29udGFpbignYWRtaW4nKTtcbiAgICAgIGV4cGVjdCh2aXNpYmxlUm9sZXMpLm5vdC50b0NvbnRhaW4oJ21hbmFnZXInKTtcbiAgICAgIGV4cGVjdCh2aXNpYmxlUm9sZXMpLm5vdC50b0NvbnRhaW4oJ3RlbmFudCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyByZWd1bGFyIG1hbmFnZXIgdG8gc2VlIG5vbi1kZW1vIHVzZXJzIGluIHRoZWlyIG9yZ2FuaXphdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvdXNlcnMnKVxuICAgICAgICAuc2V0KCd4LXRlc3QtdXNlci1pZCcsIHJlZ3VsYXJNYW5hZ2VyLmlkKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IHVzZXJzID0gcmVzcG9uc2UuYm9keTtcbiAgICAgIGNvbnN0IHZpc2libGVFbWFpbHMgPSB1c2Vycy5tYXAoKHVzZXI6IGFueSkgPT4gdXNlci5lbWFpbCk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBzZWUgdXNlcnMgaW4gdGhlaXIgb3JnYW5pemF0aW9uXG4gICAgICBleHBlY3QodmlzaWJsZUVtYWlscykudG9Db250YWluKCdyZWd1bGFyLnRlbmFudEB0ZXN0LmNvbScpO1xuICAgICAgZXhwZWN0KHZpc2libGVFbWFpbHMpLnRvQ29udGFpbigncmVndWxhci5tYW5hZ2VyQHRlc3QuY29tJyk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBOT1Qgc2VlIGRlbW8gdXNlcnNcbiAgICAgIGV4cGVjdCh2aXNpYmxlRW1haWxzKS5ub3QudG9Db250YWluKCdkZW1vLnRlbmFudEB0ZXN0LmNvbScpO1xuICAgICAgZXhwZWN0KHZpc2libGVFbWFpbHMpLm5vdC50b0NvbnRhaW4oJ2RlbW8ubWFuYWdlckB0ZXN0LmNvbScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyBhZG1pbiB0byBzZWUgYWxsIHVzZXJzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS91c2VycycpXG4gICAgICAgIC5zZXQoJ3gtdGVzdC11c2VyLWlkJywgYWRtaW5Vc2VyLmlkKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IHVzZXJzID0gcmVzcG9uc2UuYm9keTtcbiAgICAgIGNvbnN0IHZpc2libGVFbWFpbHMgPSB1c2Vycy5tYXAoKHVzZXI6IGFueSkgPT4gdXNlci5lbWFpbCk7XG4gICAgICBcbiAgICAgIC8vIEFkbWluIHNob3VsZCBzZWUgYWxsIHVzZXJzXG4gICAgICBleHBlY3QodmlzaWJsZUVtYWlscykudG9Db250YWluKCdhZG1pbkB0ZXN0LmNvbScpO1xuICAgICAgZXhwZWN0KHZpc2libGVFbWFpbHMpLnRvQ29udGFpbigncmVndWxhci5tYW5hZ2VyQHRlc3QuY29tJyk7XG4gICAgICBleHBlY3QodmlzaWJsZUVtYWlscykudG9Db250YWluKCdkZW1vLm1hbmFnZXJAdGVzdC5jb20nKTtcbiAgICAgIGV4cGVjdCh2aXNpYmxlRW1haWxzKS50b0NvbnRhaW4oJ2RlbW8udGVuYW50QHRlc3QuY29tJyk7XG4gICAgICBleHBlY3QodmlzaWJsZUVtYWlscykudG9Db250YWluKCdyZWd1bGFyLnRlbmFudEB0ZXN0LmNvbScpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnT3JnYW5pemF0aW9uIEFzc2lnbm1lbnQgUmVzdHJpY3Rpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcHJldmVudCByZWd1bGFyIG1hbmFnZXIgZnJvbSBtb2RpZnlpbmcgb3JnYW5pemF0aW9uIGFzc2lnbm1lbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgW3VzZXJdID0gYXdhaXQgZGJcbiAgICAgICAgLmluc2VydChzY2hlbWEudXNlcnMpXG4gICAgICAgIC52YWx1ZXMoe1xuICAgICAgICAgIGVtYWlsOiAndGVzdHVzZXJAdGVzdC5jb20nLFxuICAgICAgICAgIHVzZXJuYW1lOiAndGVzdHVzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnaGFzaGVkcGFzcycsXG4gICAgICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgICByb2xlOiAndGVuYW50JyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBwaG9uZTogJzUxNC01NTUtMDAwNicsXG4gICAgICAgIH0pXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgICAgLy8gTWFuYWdlciB0cmllcyB0byBhc3NpZ24gb3JnYW5pemF0aW9uIChzaG91bGQgZmFpbClcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHt1c2VyLmlkfS9vcmdhbml6YXRpb25zYClcbiAgICAgICAgLnNldCgneC10ZXN0LXVzZXItaWQnLCByZWd1bGFyTWFuYWdlci5pZClcbiAgICAgICAgLnNlbmQoeyBvcmdhbml6YXRpb25JZHM6IFt0ZXN0T3JnLmlkXSB9KVxuICAgICAgICAuZXhwZWN0KDQwMyk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lm1lc3NhZ2UpLnRvQ29udGFpbignT25seSBhZG1pbmlzdHJhdG9ycyBjYW4gbW9kaWZ5IG9yZ2FuaXphdGlvbiBhc3NpZ25tZW50cycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyBhZG1pbiB0byBtb2RpZnkgb3JnYW5pemF0aW9uIGFzc2lnbm1lbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgW3VzZXJdID0gYXdhaXQgZGJcbiAgICAgICAgLmluc2VydChzY2hlbWEudXNlcnMpXG4gICAgICAgIC52YWx1ZXMoe1xuICAgICAgICAgIGVtYWlsOiAndGVzdHVzZXIyQHRlc3QuY29tJyxcbiAgICAgICAgICB1c2VybmFtZTogJ3Rlc3R1c2VyMicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRwYXNzJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdUZXN0MicsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyMicsXG4gICAgICAgICAgcm9sZTogJ3RlbmFudCcsXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgcGhvbmU6ICc1MTQtNTU1LTAwMDcnLFxuICAgICAgICB9KVxuICAgICAgICAucmV0dXJuaW5nKCk7XG5cbiAgICAgIC8vIEFkbWluIGFzc2lnbnMgb3JnYW5pemF0aW9uIChzaG91bGQgc3VjY2VlZClcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHt1c2VyLmlkfS9vcmdhbml6YXRpb25zYClcbiAgICAgICAgLnNldCgneC10ZXN0LXVzZXItaWQnLCBhZG1pblVzZXIuaWQpXG4gICAgICAgIC5zZW5kKHsgb3JnYW5pemF0aW9uSWRzOiBbdGVzdE9yZy5pZF0gfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5tZXNzYWdlKS50b0JlKCdPcmdhbml6YXRpb24gYXNzaWdubWVudHMgdXBkYXRlZCBzdWNjZXNzZnVsbHknKTtcblxuICAgICAgLy8gVmVyaWZ5IGFzc2lnbm1lbnQgd2FzIGNyZWF0ZWRcbiAgICAgIGNvbnN0IGFzc2lnbm1lbnRzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgIC5mcm9tKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucylcbiAgICAgICAgLndoZXJlKGVxKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucy51c2VySWQsIHVzZXIuaWQpKTtcblxuICAgICAgZXhwZWN0KGFzc2lnbm1lbnRzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QoYXNzaWdubWVudHNbMF0ub3JnYW5pemF0aW9uSWQpLnRvQmUodGVzdE9yZy5pZCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZXNpZGVuY2UgQXNzaWdubWVudCBQZXJtaXNzaW9ucycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHByZXZlbnQgbWFuYWdlcnMgZnJvbSBhc3NpZ25pbmcgcmVzaWRlbmNlcyBvdXRzaWRlIHRoZWlyIG9yZ2FuaXphdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFRoaXMgdGVzdCB2YWxpZGF0ZXMgdGhhdCB0aGUgZXhpc3RpbmcgcGVybWlzc2lvbiBjaGVja3Mgd29ya1xuICAgICAgLy8gVGhlIGltcGxlbWVudGF0aW9uIGlzIGFscmVhZHkgaW4gcGxhY2UgaW4gdGhlIHJlc2lkZW5jZSBhc3NpZ25tZW50IGVuZHBvaW50XG4gICAgICBcbiAgICAgIGNvbnN0IFt1c2VyXSA9IGF3YWl0IGRiXG4gICAgICAgIC5pbnNlcnQoc2NoZW1hLnVzZXJzKVxuICAgICAgICAudmFsdWVzKHtcbiAgICAgICAgICBlbWFpbDogJ3Rlc3RyZXN1c2VyQHRlc3QuY29tJyxcbiAgICAgICAgICB1c2VybmFtZTogJ3Rlc3RyZXN1c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2hhc2hlZHBhc3MnLFxuICAgICAgICAgIGZpcnN0TmFtZTogJ1Rlc3RSZXMnLFxuICAgICAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgICAgICAgcm9sZTogJ3RlbmFudCcsXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgcGhvbmU6ICc1MTQtNTU1LTAwMDgnLFxuICAgICAgICB9KVxuICAgICAgICAucmV0dXJuaW5nKCk7XG5cbiAgICAgIC8vIFRyeSB0byBhc3NpZ24gbm9uLWV4aXN0ZW50IHJlc2lkZW5jZSAoc2hvdWxkIGZhaWwgZ3JhY2VmdWxseSlcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHt1c2VyLmlkfS9yZXNpZGVuY2VzYClcbiAgICAgICAgLnNldCgneC10ZXN0LXVzZXItaWQnLCByZWd1bGFyTWFuYWdlci5pZClcbiAgICAgICAgLnNlbmQoeyBcbiAgICAgICAgICByZXNpZGVuY2VBc3NpZ25tZW50czogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICByZXNpZGVuY2VJZDogJ25vbi1leGlzdGVudC1yZXNpZGVuY2UtaWQnLFxuICAgICAgICAgICAgICByZWxhdGlvbnNoaXBUeXBlOiAndGVuYW50JyxcbiAgICAgICAgICAgICAgc3RhcnREYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH0pO1xuXG4gICAgICAvLyBTaG91bGQgZmFpbCB3aXRoIDQwNCBmb3Igbm9uLWV4aXN0ZW50IHJlc2lkZW5jZVxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg0MDApO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==