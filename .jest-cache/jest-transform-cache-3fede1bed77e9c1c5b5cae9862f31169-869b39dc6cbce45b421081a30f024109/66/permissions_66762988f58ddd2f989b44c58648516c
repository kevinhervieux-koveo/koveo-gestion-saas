d8a734967afb0f5dccd16ac7fe2d1905
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerPermissionsRoutes = registerPermissionsRoutes;
// Database-based permissions system - no config files needed
const auth_1 = require("../auth");
const storage_1 = require("../storage");
/**
 * Transform a permission string into a structured permission object.
 * @param permission - Permission string in format "action:resource".
 * @returns Structured permission object with metadata.
 */
/**
 * TransformPermission function.
 * @param permission
 * @returns Function result.
 */
function transformPermission(permission) {
    const [action, resource] = permission.split(':');
    const resourceType = resource.replace(/_/g, ' ');
    // Determine category based on resource type
    let category = 'Other';
    const categoryMap = {
        users: 'User Management',
        organizations: 'Organization Management',
        buildings: 'Building Management',
        residences: 'Residence Management',
        bills: 'Financial Management',
        budgets: 'Financial Management',
        maintenance_requests: 'Maintenance Management',
        documents: 'Document Management',
        notifications: 'Communication',
        features: 'System Features',
        reports: 'Reports & Analytics',
    };
    category = categoryMap[resource] || 'Other';
    return {
        id: permission,
        name: permission,
        displayName: `${action.charAt(0).toUpperCase() + action.slice(1).replace(/_/g, ' ')} ${resourceType.charAt(0).toUpperCase() + resourceType.slice(1)}`,
        description: `Permission to ${action.replace(/_/g, ' ')} ${resourceType} resources`,
        resourceType: resource,
        action: action,
        category: category,
        isActive: true,
        createdAt: new Date().toISOString(),
    };
}
/**
 * Register all RBAC permissions management API routes.
 * @param app - Express application instance.
 */
/**
 * RegisterPermissionsRoutes function.
 * @param app
 * @returns Function result.
 */
function registerPermissionsRoutes(app) {
    // Get all system permissions from database
    app.get('/api/permissions', auth_1.requireAuth, (0, auth_1.authorize)('read:users'), async (req, res) => {
        try {
            const permissions = await storage_1.storage.getPermissions();
            res.json(permissions);
        }
        catch (error) {
            console.error('❌ Error fetching permissions:', error);
            res.status(500).json({ message: 'Failed to fetch permissions' });
        }
    });
    // Get role-based permissions from database
    app.get('/api/role-permissions', auth_1.requireAuth, (0, auth_1.authorize)('read:users'), async (req, res) => {
        try {
            const rolePermissions = await storage_1.storage.getRolePermissions();
            res.json(rolePermissions);
        }
        catch (error) {
            console.error('❌ Error fetching role permissions:', error);
            res.status(500).json({ message: 'Failed to fetch role permissions' });
        }
    });
    // Get permissions matrix for admin dashboard
    app.get('/api/permissions-matrix', auth_1.requireAuth, (0, auth_1.authorize)('read:users'), async (req, res) => {
        try {
            const permissions = await storage_1.storage.getPermissions();
            const rolePermissions = await storage_1.storage.getRolePermissions();
            // Group permissions by resource type
            const permissionsByResource = permissions.reduce((acc, permission) => {
                if (!acc[permission.resourceType]) {
                    acc[permission.resourceType] = [];
                }
                acc[permission.resourceType].push(permission);
                return acc;
            }, {});
            // Create role matrix (correct hierarchy: admin-manager-resident-tenant)
            const roleMatrix = ['admin', 'manager', 'resident', 'tenant'].reduce((acc, role) => {
                acc[role] = rolePermissions
                    .filter((rp) => rp.role === role)
                    .map((rp) => rp.permissionId);
                return acc;
            }, {});
            res.json({
                permissionsByResource,
                roleMatrix,
                permissions,
                rolePermissions,
            });
        }
        catch (error) {
            console.error('❌ Error fetching permissions matrix:', error);
            res.status(500).json({ message: 'Failed to fetch permissions matrix' });
        }
    });
    // Get user-specific permissions (overrides)
    app.get('/api/user-permissions', auth_1.requireAuth, (0, auth_1.authorize)('read:users'), async (req, res) => {
        try {
            const userPermissions = await storage_1.storage.getUserPermissions();
            res.json(userPermissions);
        }
        catch (error) {
            console.error('❌ Error fetching user permissions:', error);
            res.status(500).json({ message: 'Failed to fetch user permissions' });
        }
    });
    // Grant permission to user
    app.post('/api/user-permissions', auth_1.requireAuth, (0, auth_1.authorize)('manage_permissions:users'), async (req, res) => {
        try {
            const { userId, permissionId, reason } = req.body;
            if (!userId || !permissionId) {
                return res.status(400).json({
                    message: 'userId and permissionId are required',
                });
            }
            // Validate that the permission exists in database
            const permission = await storage_1.storage
                .getPermissions()
                .then((perms) => perms.find((p) => p.id === permissionId || p.name === permissionId));
            if (!permission) {
                return res.status(400).json({
                    message: 'Invalid permission',
                });
            }
            // TODO: Implement user permission override in database
            // For now, return success but note that this would need database schema changes
            res.status(501).json({
                message: 'User permission overrides not yet implemented',
                note: 'This feature requires additional database schema for user_permission_overrides table',
            });
        }
        catch (error) {
            console.error('❌ Error granting user permission:', error);
            res.status(500).json({ message: 'Failed to grant user permission' });
        }
    });
    // Revoke permission from user
    app.delete('/api/user-permissions/:userId/:permissionId', auth_1.requireAuth, (0, auth_1.authorize)('manage:user_roles'), async (req, res) => {
        try {
            const { userId, permissionId } = req.params;
            // TODO: Implement user permission revocation in database
            res.status(501).json({
                message: 'User permission overrides not yet implemented',
                note: 'This feature requires additional database schema for user_permission_overrides table',
            });
        }
        catch (error) {
            console.error('❌ Error revoking user permission:', error);
            res.status(500).json({ message: 'Failed to revoke user permission' });
        }
    });
    // Update role permissions (admin only)
    app.patch('/api/role-permissions/:role', auth_1.requireAuth, (0, auth_1.authorize)('manage:user_roles'), async (req, res) => {
        try {
            const { role } = req.params;
            const { permissions } = req.body;
            if (!['admin', 'manager', 'tenant', 'resident'].includes(role)) {
                return res.status(400).json({ message: 'Invalid role' });
            }
            if (!Array.isArray(permissions)) {
                return res.status(400).json({ message: 'Permissions must be an array' });
            }
            // TODO: Implement role permission updates
            // This would require updating the permissions.json file or moving to database
            res.status(501).json({
                message: 'Role permission updates not yet implemented',
                note: 'This feature requires implementing a mechanism to update permissions.json or move permissions to database',
            });
        }
        catch (error) {
            console.error('❌ Error updating role permissions:', error);
            res.status(500).json({ message: 'Failed to update role permissions' });
        }
    });
    // Get permission categories for organization
    app.get('/api/permission-categories', auth_1.requireAuth, (0, auth_1.authorize)('read:users'), async (req, res) => {
        try {
            // Generate categories based on database permissions
            const permissions = await storage_1.storage.getPermissions();
            const categoryMap = {};
            permissions.forEach((permission) => {
                const categoryName = {
                    users: 'User Management',
                    organizations: 'Organization Management',
                    buildings: 'Building Management',
                    residences: 'Residence Management',
                    bills: 'Financial Management',
                    budgets: 'Financial Management',
                    maintenance_requests: 'Maintenance Management',
                    documents: 'Document Management',
                    notifications: 'Communication',
                    features: 'System Features',
                    reports: 'Reports & Analytics',
                }[permission.resourceType] || 'Other';
                if (!categoryMap[categoryName]) {
                    categoryMap[categoryName] = [];
                }
                categoryMap[categoryName].push(permission);
            });
            const categories = Object.entries(categoryMap).map(([name, perms]) => ({
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name,
                permissions: perms,
                count: perms.length,
            }));
            res.json(categories);
        }
        catch (error) {
            console.error('❌ Error fetching permission categories:', error);
            res.status(500).json({ message: 'Failed to fetch permission categories' });
        }
    });
    // Validate user has specific permission
    app.post('/api/permissions/validate', auth_1.requireAuth, async (req, res) => {
        try {
            const { permission } = req.body;
            if (!permission) {
                return res.status(400).json({ message: 'Permission is required' });
            }
            // Check permission via database
            const rolePermissions = await storage_1.storage.getRolePermissions();
            const hasPermission = rolePermissions.some((rp) => rp.role === req.user.role && rp.permission && rp.permission.name === permission);
            res.json({
                hasPermission,
                role: req.user.role,
                permission,
                message: hasPermission ? 'Permission granted' : 'Permission denied',
            });
        }
        catch (error) {
            console.error('❌ Error validating permission:', error);
            res.status(500).json({ message: 'Failed to validate permission' });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0FDeEMsQ0FBQyxFQUFPLEVBQUUsRUFBRSxDQUNWLEVBQUUsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxVQUFVLENBQ25GLENBQUM7WUFFRixHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLGFBQWE7Z0JBQ2IsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFLLENBQUMsSUFBSTtnQkFDcEIsVUFBVTtnQkFDVixPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsbUJBQW1CO2FBQ3BFLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXBpL3Blcm1pc3Npb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgRXhwcmVzcyB9IGZyb20gJ2V4cHJlc3MnO1xuLy8gRGF0YWJhc2UtYmFzZWQgcGVybWlzc2lvbnMgc3lzdGVtIC0gbm8gY29uZmlnIGZpbGVzIG5lZWRlZFxuaW1wb3J0IHsgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gJy4uL3N0b3JhZ2UnO1xuXG4vKipcbiAqIFRyYW5zZm9ybSBhIHBlcm1pc3Npb24gc3RyaW5nIGludG8gYSBzdHJ1Y3R1cmVkIHBlcm1pc3Npb24gb2JqZWN0LlxuICogQHBhcmFtIHBlcm1pc3Npb24gLSBQZXJtaXNzaW9uIHN0cmluZyBpbiBmb3JtYXQgXCJhY3Rpb246cmVzb3VyY2VcIi5cbiAqIEByZXR1cm5zIFN0cnVjdHVyZWQgcGVybWlzc2lvbiBvYmplY3Qgd2l0aCBtZXRhZGF0YS5cbiAqL1xuLyoqXG4gKiBUcmFuc2Zvcm1QZXJtaXNzaW9uIGZ1bmN0aW9uLlxuICogQHBhcmFtIHBlcm1pc3Npb25cbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZnVuY3Rpb24gdHJhbnNmb3JtUGVybWlzc2lvbihwZXJtaXNzaW9uOiBzdHJpbmcpIHtcbiAgY29uc3QgW2FjdGlvbiwgcmVzb3VyY2VdID0gcGVybWlzc2lvbi5zcGxpdCgnOicpO1xuICBjb25zdCByZXNvdXJjZVR5cGUgPSByZXNvdXJjZS5yZXBsYWNlKC9fL2csICcgJyk7XG5cbiAgLy8gRGV0ZXJtaW5lIGNhdGVnb3J5IGJhc2VkIG9uIHJlc291cmNlIHR5cGVcbiAgbGV0IGNhdGVnb3J5ID0gJ090aGVyJztcbiAgY29uc3QgY2F0ZWdvcnlNYXA6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gICAgdXNlcnM6ICdVc2VyIE1hbmFnZW1lbnQnLFxuICAgIG9yZ2FuaXphdGlvbnM6ICdPcmdhbml6YXRpb24gTWFuYWdlbWVudCcsXG4gICAgYnVpbGRpbmdzOiAnQnVpbGRpbmcgTWFuYWdlbWVudCcsXG4gICAgcmVzaWRlbmNlczogJ1Jlc2lkZW5jZSBNYW5hZ2VtZW50JyxcbiAgICBiaWxsczogJ0ZpbmFuY2lhbCBNYW5hZ2VtZW50JyxcbiAgICBidWRnZXRzOiAnRmluYW5jaWFsIE1hbmFnZW1lbnQnLFxuICAgIG1haW50ZW5hbmNlX3JlcXVlc3RzOiAnTWFpbnRlbmFuY2UgTWFuYWdlbWVudCcsXG4gICAgZG9jdW1lbnRzOiAnRG9jdW1lbnQgTWFuYWdlbWVudCcsXG4gICAgbm90aWZpY2F0aW9uczogJ0NvbW11bmljYXRpb24nLFxuICAgIGZlYXR1cmVzOiAnU3lzdGVtIEZlYXR1cmVzJyxcbiAgICByZXBvcnRzOiAnUmVwb3J0cyAmIEFuYWx5dGljcycsXG4gIH07XG4gIGNhdGVnb3J5ID0gY2F0ZWdvcnlNYXBbcmVzb3VyY2VdIHx8ICdPdGhlcic7XG5cbiAgcmV0dXJuIHtcbiAgICBpZDogcGVybWlzc2lvbixcbiAgICBuYW1lOiBwZXJtaXNzaW9uLFxuICAgIGRpc3BsYXlOYW1lOiBgJHthY3Rpb24uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBhY3Rpb24uc2xpY2UoMSkucmVwbGFjZSgvXy9nLCAnICcpfSAke3Jlc291cmNlVHlwZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHJlc291cmNlVHlwZS5zbGljZSgxKX1gLFxuICAgIGRlc2NyaXB0aW9uOiBgUGVybWlzc2lvbiB0byAke2FjdGlvbi5yZXBsYWNlKC9fL2csICcgJyl9ICR7cmVzb3VyY2VUeXBlfSByZXNvdXJjZXNgLFxuICAgIHJlc291cmNlVHlwZTogcmVzb3VyY2UsXG4gICAgYWN0aW9uOiBhY3Rpb24sXG4gICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICB9O1xufVxuXG4vKipcbiAqIFJlZ2lzdGVyIGFsbCBSQkFDIHBlcm1pc3Npb25zIG1hbmFnZW1lbnQgQVBJIHJvdXRlcy5cbiAqIEBwYXJhbSBhcHAgLSBFeHByZXNzIGFwcGxpY2F0aW9uIGluc3RhbmNlLlxuICovXG4vKipcbiAqIFJlZ2lzdGVyUGVybWlzc2lvbnNSb3V0ZXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYXBwXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlclBlcm1pc3Npb25zUm91dGVzKGFwcDogRXhwcmVzcykge1xuICAvLyBHZXQgYWxsIHN5c3RlbSBwZXJtaXNzaW9ucyBmcm9tIGRhdGFiYXNlXG4gIGFwcC5nZXQoJy9hcGkvcGVybWlzc2lvbnMnLCByZXF1aXJlQXV0aCwgYXV0aG9yaXplKCdyZWFkOnVzZXJzJyksIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IGF3YWl0IHN0b3JhZ2UuZ2V0UGVybWlzc2lvbnMoKTtcbiAgICAgIHJlcy5qc29uKHBlcm1pc3Npb25zKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgcGVybWlzc2lvbnM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIHBlcm1pc3Npb25zJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCByb2xlLWJhc2VkIHBlcm1pc3Npb25zIGZyb20gZGF0YWJhc2VcbiAgYXBwLmdldCgnL2FwaS9yb2xlLXBlcm1pc3Npb25zJywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgncmVhZDp1c2VycycpLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgcm9sZVBlcm1pc3Npb25zID0gYXdhaXQgc3RvcmFnZS5nZXRSb2xlUGVybWlzc2lvbnMoKTtcbiAgICAgIHJlcy5qc29uKHJvbGVQZXJtaXNzaW9ucyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIHJvbGUgcGVybWlzc2lvbnM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIHJvbGUgcGVybWlzc2lvbnMnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gR2V0IHBlcm1pc3Npb25zIG1hdHJpeCBmb3IgYWRtaW4gZGFzaGJvYXJkXG4gIGFwcC5nZXQoJy9hcGkvcGVybWlzc2lvbnMtbWF0cml4JywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgncmVhZDp1c2VycycpLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSBhd2FpdCBzdG9yYWdlLmdldFBlcm1pc3Npb25zKCk7XG4gICAgICBjb25zdCByb2xlUGVybWlzc2lvbnMgPSBhd2FpdCBzdG9yYWdlLmdldFJvbGVQZXJtaXNzaW9ucygpO1xuXG4gICAgICAvLyBHcm91cCBwZXJtaXNzaW9ucyBieSByZXNvdXJjZSB0eXBlXG4gICAgICBjb25zdCBwZXJtaXNzaW9uc0J5UmVzb3VyY2UgPSBwZXJtaXNzaW9ucy5yZWR1Y2UoKGFjYzogYW55LCBwZXJtaXNzaW9uOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKCFhY2NbcGVybWlzc2lvbi5yZXNvdXJjZVR5cGVdKSB7XG4gICAgICAgICAgYWNjW3Blcm1pc3Npb24ucmVzb3VyY2VUeXBlXSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIGFjY1twZXJtaXNzaW9uLnJlc291cmNlVHlwZV0ucHVzaChwZXJtaXNzaW9uKTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIHt9KTtcblxuICAgICAgLy8gQ3JlYXRlIHJvbGUgbWF0cml4IChjb3JyZWN0IGhpZXJhcmNoeTogYWRtaW4tbWFuYWdlci1yZXNpZGVudC10ZW5hbnQpXG4gICAgICBjb25zdCByb2xlTWF0cml4ID0gWydhZG1pbicsICdtYW5hZ2VyJywgJ3Jlc2lkZW50JywgJ3RlbmFudCddLnJlZHVjZSgoYWNjOiBhbnksIHJvbGUpID0+IHtcbiAgICAgICAgYWNjW3JvbGVdID0gcm9sZVBlcm1pc3Npb25zXG4gICAgICAgICAgLmZpbHRlcigocnA6IGFueSkgPT4gcnAucm9sZSA9PT0gcm9sZSlcbiAgICAgICAgICAubWFwKChycDogYW55KSA9PiBycC5wZXJtaXNzaW9uSWQpO1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwge30pO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHBlcm1pc3Npb25zQnlSZXNvdXJjZSxcbiAgICAgICAgcm9sZU1hdHJpeCxcbiAgICAgICAgcGVybWlzc2lvbnMsXG4gICAgICAgIHJvbGVQZXJtaXNzaW9ucyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBwZXJtaXNzaW9ucyBtYXRyaXg6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIHBlcm1pc3Npb25zIG1hdHJpeCcgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBHZXQgdXNlci1zcGVjaWZpYyBwZXJtaXNzaW9ucyAob3ZlcnJpZGVzKVxuICBhcHAuZ2V0KCcvYXBpL3VzZXItcGVybWlzc2lvbnMnLCByZXF1aXJlQXV0aCwgYXV0aG9yaXplKCdyZWFkOnVzZXJzJyksIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyUGVybWlzc2lvbnMgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXJQZXJtaXNzaW9ucygpO1xuICAgICAgcmVzLmpzb24odXNlclBlcm1pc3Npb25zKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgdXNlciBwZXJtaXNzaW9uczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggdXNlciBwZXJtaXNzaW9ucycgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBHcmFudCBwZXJtaXNzaW9uIHRvIHVzZXJcbiAgYXBwLnBvc3QoXG4gICAgJy9hcGkvdXNlci1wZXJtaXNzaW9ucycsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXV0aG9yaXplKCdtYW5hZ2VfcGVybWlzc2lvbnM6dXNlcnMnKSxcbiAgICBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkLCBwZXJtaXNzaW9uSWQsIHJlYXNvbiB9ID0gcmVxLmJvZHk7XG5cbiAgICAgICAgaWYgKCF1c2VySWQgfHwgIXBlcm1pc3Npb25JZCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAndXNlcklkIGFuZCBwZXJtaXNzaW9uSWQgYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgdGhlIHBlcm1pc3Npb24gZXhpc3RzIGluIGRhdGFiYXNlXG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb24gPSBhd2FpdCBzdG9yYWdlXG4gICAgICAgICAgLmdldFBlcm1pc3Npb25zKClcbiAgICAgICAgICAudGhlbigocGVybXMpID0+IHBlcm1zLmZpbmQoKHApID0+IHAuaWQgPT09IHBlcm1pc3Npb25JZCB8fCBwLm5hbWUgPT09IHBlcm1pc3Npb25JZCkpO1xuXG4gICAgICAgIGlmICghcGVybWlzc2lvbikge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBwZXJtaXNzaW9uJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IEltcGxlbWVudCB1c2VyIHBlcm1pc3Npb24gb3ZlcnJpZGUgaW4gZGF0YWJhc2VcbiAgICAgICAgLy8gRm9yIG5vdywgcmV0dXJuIHN1Y2Nlc3MgYnV0IG5vdGUgdGhhdCB0aGlzIHdvdWxkIG5lZWQgZGF0YWJhc2Ugc2NoZW1hIGNoYW5nZXNcbiAgICAgICAgcmVzLnN0YXR1cyg1MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIHBlcm1pc3Npb24gb3ZlcnJpZGVzIG5vdCB5ZXQgaW1wbGVtZW50ZWQnLFxuICAgICAgICAgIG5vdGU6ICdUaGlzIGZlYXR1cmUgcmVxdWlyZXMgYWRkaXRpb25hbCBkYXRhYmFzZSBzY2hlbWEgZm9yIHVzZXJfcGVybWlzc2lvbl9vdmVycmlkZXMgdGFibGUnLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGdyYW50aW5nIHVzZXIgcGVybWlzc2lvbjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBncmFudCB1c2VyIHBlcm1pc3Npb24nIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBSZXZva2UgcGVybWlzc2lvbiBmcm9tIHVzZXJcbiAgYXBwLmRlbGV0ZShcbiAgICAnL2FwaS91c2VyLXBlcm1pc3Npb25zLzp1c2VySWQvOnBlcm1pc3Npb25JZCcsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXV0aG9yaXplKCdtYW5hZ2U6dXNlcl9yb2xlcycpLFxuICAgIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyB1c2VySWQsIHBlcm1pc3Npb25JZCB9ID0gcmVxLnBhcmFtcztcblxuICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgdXNlciBwZXJtaXNzaW9uIHJldm9jYXRpb24gaW4gZGF0YWJhc2VcbiAgICAgICAgcmVzLnN0YXR1cyg1MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIHBlcm1pc3Npb24gb3ZlcnJpZGVzIG5vdCB5ZXQgaW1wbGVtZW50ZWQnLFxuICAgICAgICAgIG5vdGU6ICdUaGlzIGZlYXR1cmUgcmVxdWlyZXMgYWRkaXRpb25hbCBkYXRhYmFzZSBzY2hlbWEgZm9yIHVzZXJfcGVybWlzc2lvbl9vdmVycmlkZXMgdGFibGUnLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHJldm9raW5nIHVzZXIgcGVybWlzc2lvbjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byByZXZva2UgdXNlciBwZXJtaXNzaW9uJyB9KTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgLy8gVXBkYXRlIHJvbGUgcGVybWlzc2lvbnMgKGFkbWluIG9ubHkpXG4gIGFwcC5wYXRjaChcbiAgICAnL2FwaS9yb2xlLXBlcm1pc3Npb25zLzpyb2xlJyxcbiAgICByZXF1aXJlQXV0aCxcbiAgICBhdXRob3JpemUoJ21hbmFnZTp1c2VyX3JvbGVzJyksXG4gICAgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IHJvbGUgfSA9IHJlcS5wYXJhbXM7XG4gICAgICAgIGNvbnN0IHsgcGVybWlzc2lvbnMgfSA9IHJlcS5ib2R5O1xuXG4gICAgICAgIGlmICghWydhZG1pbicsICdtYW5hZ2VyJywgJ3RlbmFudCcsICdyZXNpZGVudCddLmluY2x1ZGVzKHJvbGUpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ0ludmFsaWQgcm9sZScgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocGVybWlzc2lvbnMpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ1Blcm1pc3Npb25zIG11c3QgYmUgYW4gYXJyYXknIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETzogSW1wbGVtZW50IHJvbGUgcGVybWlzc2lvbiB1cGRhdGVzXG4gICAgICAgIC8vIFRoaXMgd291bGQgcmVxdWlyZSB1cGRhdGluZyB0aGUgcGVybWlzc2lvbnMuanNvbiBmaWxlIG9yIG1vdmluZyB0byBkYXRhYmFzZVxuICAgICAgICByZXMuc3RhdHVzKDUwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1JvbGUgcGVybWlzc2lvbiB1cGRhdGVzIG5vdCB5ZXQgaW1wbGVtZW50ZWQnLFxuICAgICAgICAgIG5vdGU6ICdUaGlzIGZlYXR1cmUgcmVxdWlyZXMgaW1wbGVtZW50aW5nIGEgbWVjaGFuaXNtIHRvIHVwZGF0ZSBwZXJtaXNzaW9ucy5qc29uIG9yIG1vdmUgcGVybWlzc2lvbnMgdG8gZGF0YWJhc2UnLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwZGF0aW5nIHJvbGUgcGVybWlzc2lvbnM6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gdXBkYXRlIHJvbGUgcGVybWlzc2lvbnMnIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBHZXQgcGVybWlzc2lvbiBjYXRlZ29yaWVzIGZvciBvcmdhbml6YXRpb25cbiAgYXBwLmdldCgnL2FwaS9wZXJtaXNzaW9uLWNhdGVnb3JpZXMnLCByZXF1aXJlQXV0aCwgYXV0aG9yaXplKCdyZWFkOnVzZXJzJyksIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZW5lcmF0ZSBjYXRlZ29yaWVzIGJhc2VkIG9uIGRhdGFiYXNlIHBlcm1pc3Npb25zXG4gICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IGF3YWl0IHN0b3JhZ2UuZ2V0UGVybWlzc2lvbnMoKTtcbiAgICAgIGNvbnN0IGNhdGVnb3J5TWFwOiB7IFtrZXk6IHN0cmluZ106IGFueVtdIH0gPSB7fTtcblxuICAgICAgcGVybWlzc2lvbnMuZm9yRWFjaCgocGVybWlzc2lvbikgPT4ge1xuICAgICAgICBjb25zdCBjYXRlZ29yeU5hbWUgPVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXJzOiAnVXNlciBNYW5hZ2VtZW50JyxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvbnM6ICdPcmdhbml6YXRpb24gTWFuYWdlbWVudCcsXG4gICAgICAgICAgICBidWlsZGluZ3M6ICdCdWlsZGluZyBNYW5hZ2VtZW50JyxcbiAgICAgICAgICAgIHJlc2lkZW5jZXM6ICdSZXNpZGVuY2UgTWFuYWdlbWVudCcsXG4gICAgICAgICAgICBiaWxsczogJ0ZpbmFuY2lhbCBNYW5hZ2VtZW50JyxcbiAgICAgICAgICAgIGJ1ZGdldHM6ICdGaW5hbmNpYWwgTWFuYWdlbWVudCcsXG4gICAgICAgICAgICBtYWludGVuYW5jZV9yZXF1ZXN0czogJ01haW50ZW5hbmNlIE1hbmFnZW1lbnQnLFxuICAgICAgICAgICAgZG9jdW1lbnRzOiAnRG9jdW1lbnQgTWFuYWdlbWVudCcsXG4gICAgICAgICAgICBub3RpZmljYXRpb25zOiAnQ29tbXVuaWNhdGlvbicsXG4gICAgICAgICAgICBmZWF0dXJlczogJ1N5c3RlbSBGZWF0dXJlcycsXG4gICAgICAgICAgICByZXBvcnRzOiAnUmVwb3J0cyAmIEFuYWx5dGljcycsXG4gICAgICAgICAgfVtwZXJtaXNzaW9uLnJlc291cmNlVHlwZV0gfHwgJ090aGVyJztcblxuICAgICAgICBpZiAoIWNhdGVnb3J5TWFwW2NhdGVnb3J5TmFtZV0pIHtcbiAgICAgICAgICBjYXRlZ29yeU1hcFtjYXRlZ29yeU5hbWVdID0gW107XG4gICAgICAgIH1cbiAgICAgICAgY2F0ZWdvcnlNYXBbY2F0ZWdvcnlOYW1lXS5wdXNoKHBlcm1pc3Npb24pO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNhdGVnb3JpZXMgPSBPYmplY3QuZW50cmllcyhjYXRlZ29yeU1hcCkubWFwKChbbmFtZSwgcGVybXNdKSA9PiAoe1xuICAgICAgICBpZDogbmFtZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1xccysvZywgJy0nKSxcbiAgICAgICAgbmFtZSxcbiAgICAgICAgcGVybWlzc2lvbnM6IHBlcm1zLFxuICAgICAgICBjb3VudDogcGVybXMubGVuZ3RoLFxuICAgICAgfSkpO1xuXG4gICAgICByZXMuanNvbihjYXRlZ29yaWVzKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgcGVybWlzc2lvbiBjYXRlZ29yaWVzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBwZXJtaXNzaW9uIGNhdGVnb3JpZXMnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gVmFsaWRhdGUgdXNlciBoYXMgc3BlY2lmaWMgcGVybWlzc2lvblxuICBhcHAucG9zdCgnL2FwaS9wZXJtaXNzaW9ucy92YWxpZGF0ZScsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBwZXJtaXNzaW9uIH0gPSByZXEuYm9keTtcblxuICAgICAgaWYgKCFwZXJtaXNzaW9uKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdQZXJtaXNzaW9uIGlzIHJlcXVpcmVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgcGVybWlzc2lvbiB2aWEgZGF0YWJhc2VcbiAgICAgIGNvbnN0IHJvbGVQZXJtaXNzaW9ucyA9IGF3YWl0IHN0b3JhZ2UuZ2V0Um9sZVBlcm1pc3Npb25zKCk7XG4gICAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gcm9sZVBlcm1pc3Npb25zLnNvbWUoXG4gICAgICAgIChycDogYW55KSA9PlxuICAgICAgICAgIHJwLnJvbGUgPT09IHJlcS51c2VyIS5yb2xlICYmIHJwLnBlcm1pc3Npb24gJiYgcnAucGVybWlzc2lvbi5uYW1lID09PSBwZXJtaXNzaW9uXG4gICAgICApO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIGhhc1Blcm1pc3Npb24sXG4gICAgICAgIHJvbGU6IHJlcS51c2VyIS5yb2xlLFxuICAgICAgICBwZXJtaXNzaW9uLFxuICAgICAgICBtZXNzYWdlOiBoYXNQZXJtaXNzaW9uID8gJ1Blcm1pc3Npb24gZ3JhbnRlZCcgOiAnUGVybWlzc2lvbiBkZW5pZWQnLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHZhbGlkYXRpbmcgcGVybWlzc2lvbjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gdmFsaWRhdGUgcGVybWlzc2lvbicgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==