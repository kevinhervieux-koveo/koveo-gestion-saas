d5e863326bf1462ac5fc7b4ea5740270
"use strict";
/**
 * Fast in-memory database mock for unit tests
 * Provides instant responses without network calls
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.mockSql = exports.mockSchemaObject = exports.mockDb = exports.createMockDatabase = void 0;
const createMockDatabase = () => {
    const mockData = new Map();
    return {
        // Mock query function that returns immediately
        query: jest.fn().mockImplementation(async (sql) => {
            // Return empty results for test queries
            if (sql.includes('SELECT version()')) {
                return [{ version: 'PostgreSQL 15.0 (Mock)' }];
            }
            return [];
        }),
        // Mock insert operations - proper Drizzle ORM structure
        insert: jest.fn().mockImplementation((table) => {
            const insertChain = {
                values: jest.fn().mockImplementation(async (data) => {
                    const id = Math.random().toString(36).substr(2, 9);
                    const result = Array.isArray(data)
                        ? data.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9) }))
                        : [{ ...data, id }];
                    mockData.set(id, data);
                    return result;
                }),
                returning: jest.fn().mockImplementation(async () => {
                    const id = Math.random().toString(36).substr(2, 9);
                    return [{ id }];
                })
            };
            // Create chainable methods that return properly structured objects
            const createValuesChain = (data) => {
                const id = Math.random().toString(36).substr(2, 9);
                const result = Array.isArray(data)
                    ? data.map(item => ({ ...item, id: Math.random().toString(36).substr(2, 9) }))
                    : [{ ...data, id }];
                mockData.set(id, data);
                return {
                    returning: jest.fn().mockImplementation(async () => result)
                };
            };
            insertChain.values = jest.fn().mockImplementation((data) => createValuesChain(data));
            insertChain.returning = jest.fn().mockImplementation(() => insertChain);
            return insertChain;
        }),
        // Mock select operations
        select: jest.fn().mockImplementation(() => ({
            from: jest.fn().mockImplementation(() => ({
                where: jest.fn().mockImplementation(() => ({
                    limit: jest.fn().mockImplementation(async () => []),
                    orderBy: jest.fn().mockImplementation(async () => []),
                })),
                leftJoin: jest.fn().mockImplementation(() => ({
                    where: jest.fn().mockImplementation(() => ({
                        limit: jest.fn().mockImplementation(async () => []),
                    })),
                })),
                innerJoin: jest.fn().mockImplementation(() => ({
                    where: jest.fn().mockImplementation(() => ({
                        limit: jest.fn().mockImplementation(async () => []),
                    })),
                })),
                limit: jest.fn().mockImplementation(async () => []),
                orderBy: jest.fn().mockImplementation(async () => []),
            })),
        })),
        // Mock delete operations - proper Drizzle ORM structure
        delete: jest.fn().mockImplementation((table) => ({
            where: jest.fn().mockImplementation(async () => {
                return Promise.resolve({ affectedRows: 0 });
            }),
        })),
        // Mock update operations
        update: jest.fn().mockImplementation((table) => ({
            set: jest.fn().mockImplementation(() => ({
                where: jest.fn().mockImplementation(async () => {
                    return Promise.resolve({ affectedRows: 0 });
                }),
            })),
        })),
    };
};
exports.createMockDatabase = createMockDatabase;
// Global mock instance
// Create the complete mock database with all Drizzle operations
exports.mockDb = (0, exports.createMockDatabase)();
// Mock all the individual schema tables that tests import
exports.mockSchemaObject = {
    // Core tables
    users: { where: jest.fn() },
    organizations: { where: jest.fn() },
    userOrganizations: { where: jest.fn() },
    invitations: { where: jest.fn() },
    passwordResetTokens: { where: jest.fn() },
    // Property tables  
    buildings: { where: jest.fn() },
    residences: { where: jest.fn() },
    userResidences: { where: jest.fn() },
    // Document and financial tables
    documents: { where: jest.fn() },
    bills: { where: jest.fn() },
    budgets: { where: jest.fn() },
    monthlyBudgets: { where: jest.fn() },
    // Operations tables
    maintenanceRequests: { where: jest.fn() },
    commonSpaces: { where: jest.fn() },
    // System tables
    permissions: { where: jest.fn() },
    userPermissions: { where: jest.fn() },
    rolePermissions: { where: jest.fn() },
    demands: { where: jest.fn() }
};
// Mock SQL template function
exports.mockSql = jest.fn().mockImplementation(async (strings, ...values) => {
    const query = strings.join('?');
    if (query.includes('SELECT version()')) {
        return [{ version: 'PostgreSQL 15.0 (Mock)' }];
    }
    return [];
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QztJQUNoQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNELE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9tb2Nrcy9kYXRhYmFzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZhc3QgaW4tbWVtb3J5IGRhdGFiYXNlIG1vY2sgZm9yIHVuaXQgdGVzdHNcbiAqIFByb3ZpZGVzIGluc3RhbnQgcmVzcG9uc2VzIHdpdGhvdXQgbmV0d29yayBjYWxsc1xuICovXG5cbmV4cG9ydCBjb25zdCBjcmVhdGVNb2NrRGF0YWJhc2UgPSAoKSA9PiB7XG4gIGNvbnN0IG1vY2tEYXRhID0gbmV3IE1hcCgpO1xuICBcbiAgcmV0dXJuIHtcbiAgICAvLyBNb2NrIHF1ZXJ5IGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpbW1lZGlhdGVseVxuICAgIHF1ZXJ5OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChzcWw6IHN0cmluZykgPT4ge1xuICAgICAgLy8gUmV0dXJuIGVtcHR5IHJlc3VsdHMgZm9yIHRlc3QgcXVlcmllc1xuICAgICAgaWYgKHNxbC5pbmNsdWRlcygnU0VMRUNUIHZlcnNpb24oKScpKSB7XG4gICAgICAgIHJldHVybiBbeyB2ZXJzaW9uOiAnUG9zdGdyZVNRTCAxNS4wIChNb2NrKScgfV07XG4gICAgICB9XG4gICAgICByZXR1cm4gW107XG4gICAgfSksXG4gICAgXG4gICAgLy8gTW9jayBpbnNlcnQgb3BlcmF0aW9ucyAtIHByb3BlciBEcml6emxlIE9STSBzdHJ1Y3R1cmVcbiAgICBpbnNlcnQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRhYmxlOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGluc2VydENoYWluID0ge1xuICAgICAgICB2YWx1ZXM6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGlkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IEFycmF5LmlzQXJyYXkoZGF0YSkgXG4gICAgICAgICAgICA/IGRhdGEubWFwKGl0ZW0gPT4gKHsgLi4uaXRlbSwgaWQ6IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KSB9KSlcbiAgICAgICAgICAgIDogW3sgLi4uZGF0YSwgaWQgfV07XG4gICAgICAgICAgbW9ja0RhdGEuc2V0KGlkLCBkYXRhKTtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KSxcbiAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCBpZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTtcbiAgICAgICAgICByZXR1cm4gW3sgaWQgfV07XG4gICAgICAgIH0pXG4gICAgICB9O1xuICAgICAgXG4gICAgICAvLyBDcmVhdGUgY2hhaW5hYmxlIG1ldGhvZHMgdGhhdCByZXR1cm4gcHJvcGVybHkgc3RydWN0dXJlZCBvYmplY3RzXG4gICAgICBjb25zdCBjcmVhdGVWYWx1ZXNDaGFpbiA9IChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgaWQgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEFycmF5LmlzQXJyYXkoZGF0YSkgXG4gICAgICAgICAgPyBkYXRhLm1hcChpdGVtID0+ICh7IC4uLml0ZW0sIGlkOiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSkgfSkpXG4gICAgICAgICAgOiBbeyAuLi5kYXRhLCBpZCB9XTtcbiAgICAgICAgbW9ja0RhdGEuc2V0KGlkLCBkYXRhKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IHJlc3VsdClcbiAgICAgICAgfTtcbiAgICAgIH07XG4gICAgICBcbiAgICAgIGluc2VydENoYWluLnZhbHVlcyA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGRhdGE6IGFueSkgPT4gY3JlYXRlVmFsdWVzQ2hhaW4oZGF0YSkpO1xuICAgICAgaW5zZXJ0Q2hhaW4ucmV0dXJuaW5nID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBpbnNlcnRDaGFpbik7XG4gICAgICBcbiAgICAgIHJldHVybiBpbnNlcnRDaGFpbjtcbiAgICB9KSxcbiAgICBcbiAgICAvLyBNb2NrIHNlbGVjdCBvcGVyYXRpb25zXG4gICAgc2VsZWN0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICBmcm9tOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICAgIG9yZGVyQnk6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICB9KSksXG4gICAgICAgIGxlZnRKb2luOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgICAgICAgIGxpbWl0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pKSxcbiAgICAgICAgaW5uZXJKb2luOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgICAgICAgIGxpbWl0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0pKSxcbiAgICAgICAgbGltaXQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gW10pLFxuICAgICAgICBvcmRlckJ5OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICgpID0+IFtdKSxcbiAgICAgIH0pKSxcbiAgICB9KSksXG4gICAgXG4gICAgLy8gTW9jayBkZWxldGUgb3BlcmF0aW9ucyAtIHByb3BlciBEcml6emxlIE9STSBzdHJ1Y3R1cmVcbiAgICBkZWxldGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRhYmxlOiBhbnkpID0+ICh7XG4gICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBhZmZlY3RlZFJvd3M6IDAgfSk7XG4gICAgICB9KSxcbiAgICB9KSksXG4gICAgXG4gICAgLy8gTW9jayB1cGRhdGUgb3BlcmF0aW9uc1xuICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigodGFibGU6IGFueSkgPT4gKHtcbiAgICAgIHNldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe1xuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGFmZmVjdGVkUm93czogMCB9KTtcbiAgICAgICAgfSksXG4gICAgICB9KSksXG4gICAgfSkpLFxuICB9O1xufTtcblxuLy8gR2xvYmFsIG1vY2sgaW5zdGFuY2Vcbi8vIENyZWF0ZSB0aGUgY29tcGxldGUgbW9jayBkYXRhYmFzZSB3aXRoIGFsbCBEcml6emxlIG9wZXJhdGlvbnNcbmV4cG9ydCBjb25zdCBtb2NrRGIgPSBjcmVhdGVNb2NrRGF0YWJhc2UoKTtcblxuLy8gTW9jayBhbGwgdGhlIGluZGl2aWR1YWwgc2NoZW1hIHRhYmxlcyB0aGF0IHRlc3RzIGltcG9ydFxuZXhwb3J0IGNvbnN0IG1vY2tTY2hlbWFPYmplY3QgPSB7XG4gIC8vIENvcmUgdGFibGVzXG4gIHVzZXJzOiB7IHdoZXJlOiBqZXN0LmZuKCkgfSxcbiAgb3JnYW5pemF0aW9uczogeyB3aGVyZTogamVzdC5mbigpIH0sXG4gIHVzZXJPcmdhbml6YXRpb25zOiB7IHdoZXJlOiBqZXN0LmZuKCkgfSxcbiAgaW52aXRhdGlvbnM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICBwYXNzd29yZFJlc2V0VG9rZW5zOiB7IHdoZXJlOiBqZXN0LmZuKCkgfSxcbiAgXG4gIC8vIFByb3BlcnR5IHRhYmxlcyAgXG4gIGJ1aWxkaW5nczogeyB3aGVyZTogamVzdC5mbigpIH0sXG4gIHJlc2lkZW5jZXM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICB1c2VyUmVzaWRlbmNlczogeyB3aGVyZTogamVzdC5mbigpIH0sXG4gIFxuICAvLyBEb2N1bWVudCBhbmQgZmluYW5jaWFsIHRhYmxlc1xuICBkb2N1bWVudHM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICBiaWxsczogeyB3aGVyZTogamVzdC5mbigpIH0sXG4gIGJ1ZGdldHM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICBtb250aGx5QnVkZ2V0czogeyB3aGVyZTogamVzdC5mbigpIH0sXG4gIFxuICAvLyBPcGVyYXRpb25zIHRhYmxlc1xuICBtYWludGVuYW5jZVJlcXVlc3RzOiB7IHdoZXJlOiBqZXN0LmZuKCkgfSxcbiAgY29tbW9uU3BhY2VzOiB7IHdoZXJlOiBqZXN0LmZuKCkgfSxcbiAgXG4gIC8vIFN5c3RlbSB0YWJsZXNcbiAgcGVybWlzc2lvbnM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICB1c2VyUGVybWlzc2lvbnM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICByb2xlUGVybWlzc2lvbnM6IHsgd2hlcmU6IGplc3QuZm4oKSB9LFxuICBkZW1hbmRzOiB7IHdoZXJlOiBqZXN0LmZuKCkgfVxufTtcblxuLy8gTW9jayBTUUwgdGVtcGxhdGUgZnVuY3Rpb25cbmV4cG9ydCBjb25zdCBtb2NrU3FsID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoc3RyaW5nczogVGVtcGxhdGVTdHJpbmdzQXJyYXksIC4uLnZhbHVlczogYW55W10pID0+IHtcbiAgY29uc3QgcXVlcnkgPSBzdHJpbmdzLmpvaW4oJz8nKTtcbiAgaWYgKHF1ZXJ5LmluY2x1ZGVzKCdTRUxFQ1QgdmVyc2lvbigpJykpIHtcbiAgICByZXR1cm4gW3sgdmVyc2lvbjogJ1Bvc3RncmVTUUwgMTUuMCAoTW9jayknIH1dO1xuICB9XG4gIHJldHVybiBbXTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==