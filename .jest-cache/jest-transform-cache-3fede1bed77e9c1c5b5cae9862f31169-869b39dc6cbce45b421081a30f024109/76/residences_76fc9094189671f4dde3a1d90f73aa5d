ed0fb8bc15a5a447b754f791a95ec208
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerResidenceRoutes = registerResidenceRoutes;
const db_1 = require("../db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const index_1 = require("../auth/index");
const delayed_update_service_1 = require("../services/delayed-update-service");
/**
 *
 * @param app
 */
/**
 * RegisterResidenceRoutes function.
 * @param app
 * @returns Function result.
 */
function registerResidenceRoutes(app) {
    // Get user's residences
    app.get('/api/user/residences', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const userResidencesList = await db_1.db
                .select({
                residenceId: schema_1.userResidences.residenceId,
            })
                .from(schema_1.userResidences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json(userResidencesList);
        }
        catch (error) {
            console.error('âŒ Error fetching user residences:', error);
            res.status(500).json({ message: 'Failed to fetch user residences' });
        }
    });
    // Get assigned users for a specific residence
    app.get('/api/residences/:residenceId/assigned-users', index_1.requireAuth, async (req, res) => {
        try {
            const { residenceId } = req.params;
            const currentUser = req.user;
            // Get assigned users with their details
            const assignedUsers = await db_1.db
                .select({
                id: schema_1.users.id,
                username: schema_1.users.username,
                email: schema_1.users.email,
                firstName: schema_1.users.firstName,
                lastName: schema_1.users.lastName,
                phone: schema_1.users.phone,
                relationshipType: schema_1.userResidences.relationshipType,
                startDate: schema_1.userResidences.startDate,
                endDate: schema_1.userResidences.endDate,
                isActive: schema_1.userResidences.isActive,
            })
                .from(schema_1.userResidences)
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, residenceId), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json(assignedUsers);
        }
        catch (error) {
            console.error('âŒ Error fetching assigned users:', error);
            res.status(500).json({ message: 'Failed to fetch assigned users' });
        }
    });
    // Update assigned user information
    app.put('/api/residences/:residenceId/assigned-users/:userId', index_1.requireAuth, async (req, res) => {
        try {
            const { userId } = req.params;
            const { firstName, lastName, email, phone } = req.body;
            const currentUser = req.user;
            // Update user information
            await db_1.db
                .update(schema_1.users)
                .set({
                firstName,
                lastName,
                email,
                phone,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.users.id, userId));
            res.json({ message: 'User updated successfully' });
        }
        catch (error) {
            console.error('âŒ Error updating assigned user:', error);
            res.status(500).json({ message: 'Failed to update assigned user' });
        }
    });
    // Get all residences with filtering and search
    app.get('/api/residences', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const { search, buildingId, floor } = req.query;
            // Start with base conditions
            const conditions = [(0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)];
            // Apply filters
            if (buildingId) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId));
            }
            if (floor) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.residences.floor, parseInt(floor)));
            }
            // Use the same access control logic as /api/manager/buildings
            const accessibleBuildingIds = new Set();
            // Check if user belongs to Koveo organization (special global access)
            const userOrgs = await db_1.db
                .select({
                organizationId: schema_1.organizations.id,
                organizationName: schema_1.organizations.name,
                canAccessAllOrganizations: schema_1.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema_1.organizations)
                .innerJoin(schema_1.userOrganizations, (0, drizzle_orm_1.eq)(schema_1.userOrganizations.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userOrganizations.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userOrganizations.isActive, true)));
            const hasGlobalAccess = user.role === 'admin' ||
                userOrgs.some((org) => org.organizationName === 'Koveo' || org.canAccessAllOrganizations);
            if (hasGlobalAccess) {
                console.log(`ðŸŒŸ Admin user or user with global access detected - granting access to ALL residences`);
                // Koveo users can see ALL residences from ALL buildings
                const allBuildings = await db_1.db
                    .select({ id: schema_1.buildings.id })
                    .from(schema_1.buildings)
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true));
                allBuildings.forEach((building) => {
                    accessibleBuildingIds.add(building.id);
                });
            }
            else {
                // Regular users: Get buildings from their organizations
                if (user.role === 'admin' || user.role === 'manager' || user.role === 'demo_manager') {
                    if (userOrgs.length > 0) {
                        const orgIds = userOrgs.map((uo) => uo.organizationId);
                        // Get all buildings from these organizations
                        const orgBuildings = await db_1.db
                            .select({ id: schema_1.buildings.id })
                            .from(schema_1.buildings)
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.buildings.organizationId, orgIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                        orgBuildings.forEach((building) => {
                            accessibleBuildingIds.add(building.id);
                        });
                    }
                }
                // For ALL roles (Admin, Manager, Resident, Tenant): Get buildings from their residences
                console.log(`ðŸ” [ACCESS DEBUG] Checking residence access for user ${user.id} with role ${user.role}`);
                const userResidenceRecords = await db_1.db
                    .select({
                    residenceId: schema_1.userResidences.residenceId,
                })
                    .from(schema_1.userResidences)
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
                console.log(`ðŸ” [ACCESS DEBUG] Found ${userResidenceRecords.length} residence records for user ${user.id}`);
                if (userResidenceRecords.length > 0) {
                    const residenceIds = userResidenceRecords.map((ur) => ur.residenceId);
                    // Get buildings through residences
                    const residenceBuildings = await db_1.db
                        .select({ id: schema_1.buildings.id })
                        .from(schema_1.residences)
                        .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                        .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.residences.id, residenceIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                    residenceBuildings.forEach((building) => {
                        accessibleBuildingIds.add(building.id);
                    });
                }
            }
            // Add building access filter to conditions
            console.log(`ðŸ” [ACCESS DEBUG] User ${user.id} has access to ${accessibleBuildingIds.size} buildings:`, Array.from(accessibleBuildingIds));
            if (accessibleBuildingIds.size > 0) {
                conditions.push((0, drizzle_orm_1.inArray)(schema_1.residences.buildingId, Array.from(accessibleBuildingIds)));
            }
            else {
                // User has no access to any buildings, return empty result
                return res.json([]);
            }
            // Get residences with building and organization info
            const baseQuery = db_1.db
                .select({
                residence: schema_1.residences,
                building: schema_1.buildings,
                organization: schema_1.organizations,
            })
                .from(schema_1.residences)
                .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                .leftJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)(...conditions));
            let results = await baseQuery;
            // Apply search filter
            if (search) {
                const searchLower = search.toLowerCase();
                results = results.filter((result) => result.residence.unitNumber.toLowerCase().includes(searchLower) ||
                    result.building?.name.toLowerCase().includes(searchLower));
            }
            // Get tenants for each residence
            const residenceIds = results.map((r) => r.residence.id);
            const tenants = residenceIds.length > 0
                ? await db_1.db
                    .select({
                    residenceId: schema_1.userResidences.residenceId,
                    tenant: schema_1.users,
                })
                    .from(schema_1.userResidences)
                    .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.userResidences.residenceId, residenceIds), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)))
                : [];
            // Group tenants by residence
            const tenantsByResidence = tenants.reduce((acc, { residenceId, tenant }) => {
                if (!acc[residenceId]) {
                    acc[residenceId] = [];
                }
                acc[residenceId].push({
                    id: tenant.id,
                    firstName: tenant.firstName,
                    lastName: tenant.lastName,
                    email: tenant.email,
                });
                return acc;
            }, {});
            // Combine results
            const residencesList = results.map((result) => ({
                ...result.residence,
                building: result.building,
                organization: result.organization,
                tenants: tenantsByResidence[result.residence.id] || [],
            }));
            res.json(residencesList);
        }
        catch (error) {
            console.error('âŒ Error fetching residences:', error);
            res.status(500).json({ message: 'Failed to fetch residences' });
        }
    });
    // Get a specific residence by ID
    app.get('/api/residences/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const result = await db_1.db
                .select({
                residence: schema_1.residences,
                building: schema_1.buildings,
                organization: schema_1.organizations,
            })
                .from(schema_1.residences)
                .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                .leftJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.id, id), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
            if (result.length === 0) {
                return res.status(404).json({ message: 'Residence not found' });
            }
            const residence = result[0];
            // Apply RBAC check
            if (user.role !== 'admin' && !user.canAccessAllOrganizations) {
                // Check if user has access to this residence's organization
                const userHasAccess = await db_1.db
                    .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                    .from(schema_1.userResidences)
                    .leftJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                    .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, residence.organization.id)));
                if (userHasAccess[0].count === 0) {
                    return res.status(403).json({ message: 'Access denied' });
                }
            }
            // Get tenants for this residence
            const tenants = await db_1.db
                .select({
                id: schema_1.users.id,
                firstName: schema_1.users.firstName,
                lastName: schema_1.users.lastName,
                email: schema_1.users.email,
                relationshipType: schema_1.userResidences.relationshipType,
                startDate: schema_1.userResidences.startDate,
                endDate: schema_1.userResidences.endDate,
            })
                .from(schema_1.userResidences)
                .leftJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json({
                ...residence.residence,
                building: residence.building,
                organization: residence.organization,
                tenants,
            });
        }
        catch (error) {
            console.error('âŒ Error fetching residence:', error);
            res.status(500).json({ message: 'Failed to fetch residence' });
        }
    });
    // Update a residence
    app.put('/api/residences/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const updateData = req.body;
            console.log(`ðŸ  Updating residence ${id} with data:`, updateData);
            // Remove readonly fields
            delete updateData.id;
            delete updateData.createdAt;
            delete updateData.buildingId; // Don't allow changing building
            // Validate and sanitize numeric fields
            const processedData = {
                ...updateData,
                updatedAt: new Date(),
            };
            // Convert null/empty values to null for optional fields
            if (processedData.squareFootage === null || processedData.squareFootage === '') {
                processedData.squareFootage = null;
            }
            if (processedData.bathrooms === null || processedData.bathrooms === '') {
                processedData.bathrooms = null;
            }
            if (processedData.ownershipPercentage === null || processedData.ownershipPercentage === '') {
                processedData.ownershipPercentage = null;
            }
            if (processedData.monthlyFees === null || processedData.monthlyFees === '') {
                processedData.monthlyFees = null;
            }
            console.log(`ðŸ  Processed data for residence ${id}:`, processedData);
            const updated = await db_1.db
                .update(schema_1.residences)
                .set(processedData)
                .where((0, drizzle_orm_1.eq)(schema_1.residences.id, id))
                .returning();
            if (updated.length === 0) {
                return res.status(404).json({ message: 'Residence not found' });
            }
            console.log(`âœ… Successfully updated residence ${id}`);
            // Schedule delayed money flow and budget update for the updated residence
            try {
                delayed_update_service_1.delayedUpdateService.scheduleResidenceUpdate(id);
                // Don't fail the residence update if scheduling fails
            }
            catch (e) {
                console.warn('âš ï¸ Failed to schedule residence update:', e);
            }
            res.json(updated[0]);
        }
        catch (error) {
            console.error('âŒ Error updating residence:', error);
            console.error('âŒ Error details:', error.message);
            console.error('âŒ Error stack:', error.stack);
            res.status(500).json({
                message: 'Failed to update residence',
                error: error.message,
                details: process.env.NODE_ENV === 'development' ? error.stack : undefined
            });
        }
    });
    // Create residences when a building is created (called internally)
    app.post('/api/buildings/:buildingId/generate-residences', index_1.requireAuth, async (req, res) => {
        try {
            const { buildingId } = req.params;
            // Get building details
            const building = await db_1.db
                .select()
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .limit(1);
            if (building.length === 0) {
                return res.status(404).json({ message: 'Building not found' });
            }
            const buildingData = building[0];
            const totalUnits = buildingData.totalUnits;
            const totalFloors = buildingData.totalFloors || 1;
            if (totalUnits > 300) {
                return res
                    .status(400)
                    .json({ message: 'Cannot create more than 300 residences per building' });
            }
            // Check if residences already exist for this building
            const existingResidences = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId));
            if (existingResidences[0].count > 0) {
                return res.status(400).json({ message: 'Residences already exist for this building' });
            }
            // Generate residences
            const residencesToCreate = [];
            const unitsPerFloor = Math.ceil(totalUnits / totalFloors);
            for (let unit = 1; unit <= totalUnits; unit++) {
                const floor = Math.ceil(unit / unitsPerFloor);
                const unitOnFloor = ((unit - 1) % unitsPerFloor) + 1;
                const unitNumber = `${floor}${unitOnFloor.toString().padStart(2, '0')}`;
                residencesToCreate.push({
                    buildingId,
                    unitNumber,
                    floor,
                    isActive: true,
                });
            }
            // Insert all residences at once
            const createdResidences = await db_1.db
                .insert(schema_1.residences)
                .values(residencesToCreate)
                .returning();
            res.json({
                message: `Successfully created ${createdResidences.length} residences`,
                residences: createdResidences,
            });
        }
        catch (error) {
            console.error('âŒ Error generating residences:', error);
            res.status(500).json({ message: 'Failed to generate residences' });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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WUFDTCxDQUFDO1lBRUQsZ0NBQWdDO1lBQ2hDLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxPQUFFO2lCQUMvQixNQUFNLENBQUMsbUJBQVUsQ0FBQztpQkFDbEIsTUFBTSxDQUFDLGtCQUFrQixDQUFDO2lCQUMxQixTQUFTLEVBQUUsQ0FBQztZQUVmLEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLHdCQUF3QixpQkFBaUIsQ0FBQyxNQUFNLGFBQWE7Z0JBQ3RFLFVBQVUsRUFBRSxpQkFBaUI7YUFDOUIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN2RCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxDQUFDLENBQUM7UUFDckUsQ0FBQztJQUNILENBQUMsQ0FDRixDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hcGkvcmVzaWRlbmNlcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeHByZXNzIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uL2RiJztcbmltcG9ydCB7XG4gIHJlc2lkZW5jZXMsXG4gIGJ1aWxkaW5ncyxcbiAgb3JnYW5pemF0aW9ucyxcbiAgdXNlclJlc2lkZW5jZXMsXG4gIHVzZXJzLFxuICB1c2VyT3JnYW5pemF0aW9ucyxcbn0gZnJvbSAnLi4vLi4vc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyBlcSwgYW5kLCBvciwgaWxpa2UsIGluQXJyYXksIHNxbCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vYXV0aC9pbmRleCc7XG5pbXBvcnQgeyBkZWxheWVkVXBkYXRlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2RlbGF5ZWQtdXBkYXRlLXNlcnZpY2UnO1xuXG4vKipcbiAqXG4gKiBAcGFyYW0gYXBwXG4gKi9cbi8qKlxuICogUmVnaXN0ZXJSZXNpZGVuY2VSb3V0ZXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYXBwXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlclJlc2lkZW5jZVJvdXRlcyhhcHA6IEV4cHJlc3MpIHtcbiAgLy8gR2V0IHVzZXIncyByZXNpZGVuY2VzXG4gIGFwcC5nZXQoJy9hcGkvdXNlci9yZXNpZGVuY2VzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgdXNlclJlc2lkZW5jZXNMaXN0ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgcmVzaWRlbmNlSWQ6IHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbSh1c2VyUmVzaWRlbmNlcylcbiAgICAgICAgLndoZXJlKGFuZChlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXIuaWQpLCBlcSh1c2VyUmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcbiAgICAgIHJlcy5qc29uKHVzZXJSZXNpZGVuY2VzTGlzdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIHVzZXIgcmVzaWRlbmNlczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggdXNlciByZXNpZGVuY2VzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCBhc3NpZ25lZCB1c2VycyBmb3IgYSBzcGVjaWZpYyByZXNpZGVuY2VcbiAgYXBwLmdldChcbiAgICAnL2FwaS9yZXNpZGVuY2VzLzpyZXNpZGVuY2VJZC9hc3NpZ25lZC11c2VycycsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyByZXNpZGVuY2VJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlcjtcblxuICAgICAgICAvLyBHZXQgYXNzaWduZWQgdXNlcnMgd2l0aCB0aGVpciBkZXRhaWxzXG4gICAgICAgIGNvbnN0IGFzc2lnbmVkVXNlcnMgPSBhd2FpdCBkYlxuICAgICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgICAgaWQ6IHVzZXJzLmlkLFxuICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJzLnVzZXJuYW1lLFxuICAgICAgICAgICAgZW1haWw6IHVzZXJzLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB1c2Vycy5maXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdXNlcnMubGFzdE5hbWUsXG4gICAgICAgICAgICBwaG9uZTogdXNlcnMucGhvbmUsXG4gICAgICAgICAgICByZWxhdGlvbnNoaXBUeXBlOiB1c2VyUmVzaWRlbmNlcy5yZWxhdGlvbnNoaXBUeXBlLFxuICAgICAgICAgICAgc3RhcnREYXRlOiB1c2VyUmVzaWRlbmNlcy5zdGFydERhdGUsXG4gICAgICAgICAgICBlbmREYXRlOiB1c2VyUmVzaWRlbmNlcy5lbmREYXRlLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgICAgLmlubmVySm9pbih1c2VycywgZXEodXNlclJlc2lkZW5jZXMudXNlcklkLCB1c2Vycy5pZCkpXG4gICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgYW5kKGVxKHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLCByZXNpZGVuY2VJZCksIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgICAgICApO1xuXG4gICAgICAgIHJlcy5qc29uKGFzc2lnbmVkVXNlcnMpO1xuICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgYXNzaWduZWQgdXNlcnM6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggYXNzaWduZWQgdXNlcnMnIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBVcGRhdGUgYXNzaWduZWQgdXNlciBpbmZvcm1hdGlvblxuICBhcHAucHV0KFxuICAgICcvYXBpL3Jlc2lkZW5jZXMvOnJlc2lkZW5jZUlkL2Fzc2lnbmVkLXVzZXJzLzp1c2VySWQnLFxuICAgIHJlcXVpcmVBdXRoLFxuICAgIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEucGFyYW1zO1xuICAgICAgICBjb25zdCB7IGZpcnN0TmFtZSwgbGFzdE5hbWUsIGVtYWlsLCBwaG9uZSB9ID0gcmVxLmJvZHk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXI7XG5cbiAgICAgICAgLy8gVXBkYXRlIHVzZXIgaW5mb3JtYXRpb25cbiAgICAgICAgYXdhaXQgZGJcbiAgICAgICAgICAudXBkYXRlKHVzZXJzKVxuICAgICAgICAgIC5zZXQoe1xuICAgICAgICAgICAgZmlyc3ROYW1lLFxuICAgICAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgICAgICBlbWFpbCxcbiAgICAgICAgICAgIHBob25lLFxuICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLndoZXJlKGVxKHVzZXJzLmlkLCB1c2VySWQpKTtcblxuICAgICAgICByZXMuanNvbih7IG1lc3NhZ2U6ICdVc2VyIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5JyB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwZGF0aW5nIGFzc2lnbmVkIHVzZXI6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gdXBkYXRlIGFzc2lnbmVkIHVzZXInIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBHZXQgYWxsIHJlc2lkZW5jZXMgd2l0aCBmaWx0ZXJpbmcgYW5kIHNlYXJjaFxuICBhcHAuZ2V0KCcvYXBpL3Jlc2lkZW5jZXMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG4gICAgICBjb25zdCB7IHNlYXJjaCwgYnVpbGRpbmdJZCwgZmxvb3IgfSA9IHJlcS5xdWVyeTtcblxuXG4gICAgICAvLyBTdGFydCB3aXRoIGJhc2UgY29uZGl0aW9uc1xuICAgICAgY29uc3QgY29uZGl0aW9ucyA9IFtlcShyZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKV07XG5cbiAgICAgIC8vIEFwcGx5IGZpbHRlcnNcbiAgICAgIGlmIChidWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbmRpdGlvbnMucHVzaChlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5nSWQpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZsb29yKSB7XG4gICAgICAgIGNvbmRpdGlvbnMucHVzaChlcShyZXNpZGVuY2VzLmZsb29yLCBwYXJzZUludChmbG9vcikpKTtcbiAgICAgIH1cblxuICAgICAgLy8gVXNlIHRoZSBzYW1lIGFjY2VzcyBjb250cm9sIGxvZ2ljIGFzIC9hcGkvbWFuYWdlci9idWlsZGluZ3NcbiAgICAgIGNvbnN0IGFjY2Vzc2libGVCdWlsZGluZ0lkcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGJlbG9uZ3MgdG8gS292ZW8gb3JnYW5pemF0aW9uIChzcGVjaWFsIGdsb2JhbCBhY2Nlc3MpXG4gICAgICBjb25zdCB1c2VyT3JncyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb25zLmlkLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zOiB1c2VyT3JnYW5pemF0aW9ucy5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbShvcmdhbml6YXRpb25zKVxuICAgICAgICAuaW5uZXJKb2luKHVzZXJPcmdhbml6YXRpb25zLCBlcSh1c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgIC53aGVyZShhbmQoZXEodXNlck9yZ2FuaXphdGlvbnMudXNlcklkLCB1c2VyLmlkKSwgZXEodXNlck9yZ2FuaXphdGlvbnMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgIGNvbnN0IGhhc0dsb2JhbEFjY2VzcyA9XG4gICAgICAgIHVzZXIucm9sZSA9PT0gJ2FkbWluJyB8fFxuICAgICAgICB1c2VyT3Jncy5zb21lKChvcmcpID0+IG9yZy5vcmdhbml6YXRpb25OYW1lID09PSAnS292ZW8nIHx8IG9yZy5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zKTtcblxuICAgICAgaWYgKGhhc0dsb2JhbEFjY2Vzcykge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBg8J+MnyBBZG1pbiB1c2VyIG9yIHVzZXIgd2l0aCBnbG9iYWwgYWNjZXNzIGRldGVjdGVkIC0gZ3JhbnRpbmcgYWNjZXNzIHRvIEFMTCByZXNpZGVuY2VzYFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIEtvdmVvIHVzZXJzIGNhbiBzZWUgQUxMIHJlc2lkZW5jZXMgZnJvbSBBTEwgYnVpbGRpbmdzXG4gICAgICAgIGNvbnN0IGFsbEJ1aWxkaW5ncyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7IGlkOiBidWlsZGluZ3MuaWQgfSlcbiAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSkpO1xuXG4gICAgICAgIGFsbEJ1aWxkaW5ncy5mb3JFYWNoKChidWlsZGluZykgPT4ge1xuICAgICAgICAgIGFjY2Vzc2libGVCdWlsZGluZ0lkcy5hZGQoYnVpbGRpbmcuaWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFJlZ3VsYXIgdXNlcnM6IEdldCBidWlsZGluZ3MgZnJvbSB0aGVpciBvcmdhbml6YXRpb25zXG4gICAgICAgIGlmICh1c2VyLnJvbGUgPT09ICdhZG1pbicgfHwgdXNlci5yb2xlID09PSAnbWFuYWdlcicgfHwgdXNlci5yb2xlID09PSAnZGVtb19tYW5hZ2VyJykge1xuICAgICAgICAgIGlmICh1c2VyT3Jncy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBvcmdJZHMgPSB1c2VyT3Jncy5tYXAoKHVvKSA9PiB1by5vcmdhbml6YXRpb25JZCk7XG5cbiAgICAgICAgICAgIC8vIEdldCBhbGwgYnVpbGRpbmdzIGZyb20gdGhlc2Ugb3JnYW5pemF0aW9uc1xuICAgICAgICAgICAgY29uc3Qgb3JnQnVpbGRpbmdzID0gYXdhaXQgZGJcbiAgICAgICAgICAgICAgLnNlbGVjdCh7IGlkOiBidWlsZGluZ3MuaWQgfSlcbiAgICAgICAgICAgICAgLmZyb20oYnVpbGRpbmdzKVxuICAgICAgICAgICAgICAud2hlcmUoYW5kKGluQXJyYXkoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdJZHMpLCBlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgICAgIG9yZ0J1aWxkaW5ncy5mb3JFYWNoKChidWlsZGluZykgPT4ge1xuICAgICAgICAgICAgICBhY2Nlc3NpYmxlQnVpbGRpbmdJZHMuYWRkKGJ1aWxkaW5nLmlkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZvciBBTEwgcm9sZXMgKEFkbWluLCBNYW5hZ2VyLCBSZXNpZGVudCwgVGVuYW50KTogR2V0IGJ1aWxkaW5ncyBmcm9tIHRoZWlyIHJlc2lkZW5jZXNcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYPCflI0gW0FDQ0VTUyBERUJVR10gQ2hlY2tpbmcgcmVzaWRlbmNlIGFjY2VzcyBmb3IgdXNlciAke3VzZXIuaWR9IHdpdGggcm9sZSAke3VzZXIucm9sZX1gXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHVzZXJSZXNpZGVuY2VSZWNvcmRzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgIHJlc2lkZW5jZUlkOiB1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAgIC53aGVyZShhbmQoZXEodXNlclJlc2lkZW5jZXMudXNlcklkLCB1c2VyLmlkKSwgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYPCflI0gW0FDQ0VTUyBERUJVR10gRm91bmQgJHt1c2VyUmVzaWRlbmNlUmVjb3Jkcy5sZW5ndGh9IHJlc2lkZW5jZSByZWNvcmRzIGZvciB1c2VyICR7dXNlci5pZH1gXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHVzZXJSZXNpZGVuY2VSZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCByZXNpZGVuY2VJZHMgPSB1c2VyUmVzaWRlbmNlUmVjb3Jkcy5tYXAoKHVyKSA9PiB1ci5yZXNpZGVuY2VJZCk7XG5cbiAgICAgICAgICAvLyBHZXQgYnVpbGRpbmdzIHRocm91Z2ggcmVzaWRlbmNlc1xuICAgICAgICAgIGNvbnN0IHJlc2lkZW5jZUJ1aWxkaW5ncyA9IGF3YWl0IGRiXG4gICAgICAgICAgICAuc2VsZWN0KHsgaWQ6IGJ1aWxkaW5ncy5pZCB9KVxuICAgICAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgICAgIC5pbm5lckpvaW4oYnVpbGRpbmdzLCBlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5ncy5pZCkpXG4gICAgICAgICAgICAud2hlcmUoYW5kKGluQXJyYXkocmVzaWRlbmNlcy5pZCwgcmVzaWRlbmNlSWRzKSwgZXEoYnVpbGRpbmdzLmlzQWN0aXZlLCB0cnVlKSkpO1xuXG4gICAgICAgICAgcmVzaWRlbmNlQnVpbGRpbmdzLmZvckVhY2goKGJ1aWxkaW5nKSA9PiB7XG4gICAgICAgICAgICBhY2Nlc3NpYmxlQnVpbGRpbmdJZHMuYWRkKGJ1aWxkaW5nLmlkKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBBZGQgYnVpbGRpbmcgYWNjZXNzIGZpbHRlciB0byBjb25kaXRpb25zXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYPCflI0gW0FDQ0VTUyBERUJVR10gVXNlciAke3VzZXIuaWR9IGhhcyBhY2Nlc3MgdG8gJHthY2Nlc3NpYmxlQnVpbGRpbmdJZHMuc2l6ZX0gYnVpbGRpbmdzOmAsXG4gICAgICAgIEFycmF5LmZyb20oYWNjZXNzaWJsZUJ1aWxkaW5nSWRzKVxuICAgICAgKTtcbiAgICAgIGlmIChhY2Nlc3NpYmxlQnVpbGRpbmdJZHMuc2l6ZSA+IDApIHtcbiAgICAgICAgY29uZGl0aW9ucy5wdXNoKGluQXJyYXkocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBBcnJheS5mcm9tKGFjY2Vzc2libGVCdWlsZGluZ0lkcykpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFVzZXIgaGFzIG5vIGFjY2VzcyB0byBhbnkgYnVpbGRpbmdzLCByZXR1cm4gZW1wdHkgcmVzdWx0XG4gICAgICAgIHJldHVybiByZXMuanNvbihbXSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCByZXNpZGVuY2VzIHdpdGggYnVpbGRpbmcgYW5kIG9yZ2FuaXphdGlvbiBpbmZvXG4gICAgICBjb25zdCBiYXNlUXVlcnkgPSBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICByZXNpZGVuY2U6IHJlc2lkZW5jZXMsXG4gICAgICAgICAgYnVpbGRpbmc6IGJ1aWxkaW5ncyxcbiAgICAgICAgICBvcmdhbml6YXRpb246IG9yZ2FuaXphdGlvbnMsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgIC5sZWZ0Sm9pbihidWlsZGluZ3MsIGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdzLmlkKSlcbiAgICAgICAgLmxlZnRKb2luKG9yZ2FuaXphdGlvbnMsIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgIC53aGVyZShhbmQoLi4uY29uZGl0aW9ucykpO1xuXG4gICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IGJhc2VRdWVyeTtcblxuICAgICAgLy8gQXBwbHkgc2VhcmNoIGZpbHRlclxuICAgICAgaWYgKHNlYXJjaCkge1xuICAgICAgICBjb25zdCBzZWFyY2hMb3dlciA9IHNlYXJjaC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoXG4gICAgICAgICAgKHJlc3VsdCkgPT5cbiAgICAgICAgICAgIHJlc3VsdC5yZXNpZGVuY2UudW5pdE51bWJlci50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHNlYXJjaExvd2VyKSB8fFxuICAgICAgICAgICAgcmVzdWx0LmJ1aWxkaW5nPy5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2VhcmNoTG93ZXIpXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCB0ZW5hbnRzIGZvciBlYWNoIHJlc2lkZW5jZVxuICAgICAgY29uc3QgcmVzaWRlbmNlSWRzID0gcmVzdWx0cy5tYXAoKHIpID0+IHIucmVzaWRlbmNlLmlkKTtcbiAgICAgIGNvbnN0IHRlbmFudHMgPVxuICAgICAgICByZXNpZGVuY2VJZHMubGVuZ3RoID4gMFxuICAgICAgICAgID8gYXdhaXQgZGJcbiAgICAgICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICAgICAgcmVzaWRlbmNlSWQ6IHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLFxuICAgICAgICAgICAgICAgIHRlbmFudDogdXNlcnMsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAgICAgICAuaW5uZXJKb2luKHVzZXJzLCBlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXJzLmlkKSlcbiAgICAgICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgICAgIGFuZChcbiAgICAgICAgICAgICAgICAgIGluQXJyYXkodXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZUlkcyksXG4gICAgICAgICAgICAgICAgICBlcSh1c2VyUmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICA6IFtdO1xuXG4gICAgICAvLyBHcm91cCB0ZW5hbnRzIGJ5IHJlc2lkZW5jZVxuICAgICAgY29uc3QgdGVuYW50c0J5UmVzaWRlbmNlID0gdGVuYW50cy5yZWR1Y2UoXG4gICAgICAgIChhY2MsIHsgcmVzaWRlbmNlSWQsIHRlbmFudCB9KSA9PiB7XG4gICAgICAgICAgaWYgKCFhY2NbcmVzaWRlbmNlSWRdKSB7XG4gICAgICAgICAgICBhY2NbcmVzaWRlbmNlSWRdID0gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGFjY1tyZXNpZGVuY2VJZF0ucHVzaCh7XG4gICAgICAgICAgICBpZDogdGVuYW50LmlkLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0ZW5hbnQuZmlyc3ROYW1lLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRlbmFudC5sYXN0TmFtZSxcbiAgICAgICAgICAgIGVtYWlsOiB0ZW5hbnQuZW1haWwsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSxcbiAgICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgYW55W10+XG4gICAgICApO1xuXG4gICAgICAvLyBDb21iaW5lIHJlc3VsdHNcbiAgICAgIGNvbnN0IHJlc2lkZW5jZXNMaXN0ID0gcmVzdWx0cy5tYXAoKHJlc3VsdCkgPT4gKHtcbiAgICAgICAgLi4ucmVzdWx0LnJlc2lkZW5jZSxcbiAgICAgICAgYnVpbGRpbmc6IHJlc3VsdC5idWlsZGluZyxcbiAgICAgICAgb3JnYW5pemF0aW9uOiByZXN1bHQub3JnYW5pemF0aW9uLFxuICAgICAgICB0ZW5hbnRzOiB0ZW5hbnRzQnlSZXNpZGVuY2VbcmVzdWx0LnJlc2lkZW5jZS5pZF0gfHwgW10sXG4gICAgICB9KSk7XG5cbiAgICAgIHJlcy5qc29uKHJlc2lkZW5jZXNMaXN0KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgcmVzaWRlbmNlczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggcmVzaWRlbmNlcycgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBHZXQgYSBzcGVjaWZpYyByZXNpZGVuY2UgYnkgSURcbiAgYXBwLmdldCgnL2FwaS9yZXNpZGVuY2VzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIHJlc2lkZW5jZTogcmVzaWRlbmNlcyxcbiAgICAgICAgICBidWlsZGluZzogYnVpbGRpbmdzLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbjogb3JnYW5pemF0aW9ucyxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgLmxlZnRKb2luKGJ1aWxkaW5ncywgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ3MuaWQpKVxuICAgICAgICAubGVmdEpvaW4ob3JnYW5pemF0aW9ucywgZXEoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgLndoZXJlKGFuZChlcShyZXNpZGVuY2VzLmlkLCBpZCksIGVxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdSZXNpZGVuY2Ugbm90IGZvdW5kJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzaWRlbmNlID0gcmVzdWx0WzBdO1xuXG4gICAgICAvLyBBcHBseSBSQkFDIGNoZWNrXG4gICAgICBpZiAodXNlci5yb2xlICE9PSAnYWRtaW4nICYmICF1c2VyLmNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnMpIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgYWNjZXNzIHRvIHRoaXMgcmVzaWRlbmNlJ3Mgb3JnYW5pemF0aW9uXG4gICAgICAgIGNvbnN0IHVzZXJIYXNBY2Nlc3MgPSBhd2FpdCBkYlxuICAgICAgICAgIC5zZWxlY3QoeyBjb3VudDogc3FsPG51bWJlcj5gY291bnQoKilgIH0pXG4gICAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgICAgLmxlZnRKb2luKHJlc2lkZW5jZXMsIGVxKHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLCByZXNpZGVuY2VzLmlkKSlcbiAgICAgICAgICAubGVmdEpvaW4oYnVpbGRpbmdzLCBlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5ncy5pZCkpXG4gICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgYW5kKFxuICAgICAgICAgICAgICBlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXIuaWQpLFxuICAgICAgICAgICAgICBlcShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIHJlc2lkZW5jZS5vcmdhbml6YXRpb24uaWQpXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcblxuICAgICAgICBpZiAodXNlckhhc0FjY2Vzc1swXS5jb3VudCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdGVuYW50cyBmb3IgdGhpcyByZXNpZGVuY2VcbiAgICAgIGNvbnN0IHRlbmFudHMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICBpZDogdXNlcnMuaWQsXG4gICAgICAgICAgZmlyc3ROYW1lOiB1c2Vycy5maXJzdE5hbWUsXG4gICAgICAgICAgbGFzdE5hbWU6IHVzZXJzLmxhc3ROYW1lLFxuICAgICAgICAgIGVtYWlsOiB1c2Vycy5lbWFpbCxcbiAgICAgICAgICByZWxhdGlvbnNoaXBUeXBlOiB1c2VyUmVzaWRlbmNlcy5yZWxhdGlvbnNoaXBUeXBlLFxuICAgICAgICAgIHN0YXJ0RGF0ZTogdXNlclJlc2lkZW5jZXMuc3RhcnREYXRlLFxuICAgICAgICAgIGVuZERhdGU6IHVzZXJSZXNpZGVuY2VzLmVuZERhdGUsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAubGVmdEpvaW4odXNlcnMsIGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgdXNlcnMuaWQpKVxuICAgICAgICAud2hlcmUoYW5kKGVxKHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLCBpZCksIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSkpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIC4uLnJlc2lkZW5jZS5yZXNpZGVuY2UsXG4gICAgICAgIGJ1aWxkaW5nOiByZXNpZGVuY2UuYnVpbGRpbmcsXG4gICAgICAgIG9yZ2FuaXphdGlvbjogcmVzaWRlbmNlLm9yZ2FuaXphdGlvbixcbiAgICAgICAgdGVuYW50cyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyByZXNpZGVuY2U6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIHJlc2lkZW5jZScgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBVcGRhdGUgYSByZXNpZGVuY2VcbiAgYXBwLnB1dCgnL2FwaS9yZXNpZGVuY2VzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB1cGRhdGVEYXRhID0gcmVxLmJvZHk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn4+gIFVwZGF0aW5nIHJlc2lkZW5jZSAke2lkfSB3aXRoIGRhdGE6YCwgdXBkYXRlRGF0YSk7XG5cbiAgICAgIC8vIFJlbW92ZSByZWFkb25seSBmaWVsZHNcbiAgICAgIGRlbGV0ZSB1cGRhdGVEYXRhLmlkO1xuICAgICAgZGVsZXRlIHVwZGF0ZURhdGEuY3JlYXRlZEF0O1xuICAgICAgZGVsZXRlIHVwZGF0ZURhdGEuYnVpbGRpbmdJZDsgLy8gRG9uJ3QgYWxsb3cgY2hhbmdpbmcgYnVpbGRpbmdcblxuICAgICAgLy8gVmFsaWRhdGUgYW5kIHNhbml0aXplIG51bWVyaWMgZmllbGRzXG4gICAgICBjb25zdCBwcm9jZXNzZWREYXRhID0ge1xuICAgICAgICAuLi51cGRhdGVEYXRhLFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9O1xuXG4gICAgICAvLyBDb252ZXJ0IG51bGwvZW1wdHkgdmFsdWVzIHRvIG51bGwgZm9yIG9wdGlvbmFsIGZpZWxkc1xuICAgICAgaWYgKHByb2Nlc3NlZERhdGEuc3F1YXJlRm9vdGFnZSA9PT0gbnVsbCB8fCBwcm9jZXNzZWREYXRhLnNxdWFyZUZvb3RhZ2UgPT09ICcnKSB7XG4gICAgICAgIHByb2Nlc3NlZERhdGEuc3F1YXJlRm9vdGFnZSA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAocHJvY2Vzc2VkRGF0YS5iYXRocm9vbXMgPT09IG51bGwgfHwgcHJvY2Vzc2VkRGF0YS5iYXRocm9vbXMgPT09ICcnKSB7XG4gICAgICAgIHByb2Nlc3NlZERhdGEuYmF0aHJvb21zID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIGlmIChwcm9jZXNzZWREYXRhLm93bmVyc2hpcFBlcmNlbnRhZ2UgPT09IG51bGwgfHwgcHJvY2Vzc2VkRGF0YS5vd25lcnNoaXBQZXJjZW50YWdlID09PSAnJykge1xuICAgICAgICBwcm9jZXNzZWREYXRhLm93bmVyc2hpcFBlcmNlbnRhZ2UgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKHByb2Nlc3NlZERhdGEubW9udGhseUZlZXMgPT09IG51bGwgfHwgcHJvY2Vzc2VkRGF0YS5tb250aGx5RmVlcyA9PT0gJycpIHtcbiAgICAgICAgcHJvY2Vzc2VkRGF0YS5tb250aGx5RmVlcyA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn4+gIFByb2Nlc3NlZCBkYXRhIGZvciByZXNpZGVuY2UgJHtpZH06YCwgcHJvY2Vzc2VkRGF0YSk7XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCBkYlxuICAgICAgICAudXBkYXRlKHJlc2lkZW5jZXMpXG4gICAgICAgIC5zZXQocHJvY2Vzc2VkRGF0YSlcbiAgICAgICAgLndoZXJlKGVxKHJlc2lkZW5jZXMuaWQsIGlkKSlcbiAgICAgICAgLnJldHVybmluZygpO1xuXG4gICAgICBpZiAodXBkYXRlZC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZSBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIFN1Y2Nlc3NmdWxseSB1cGRhdGVkIHJlc2lkZW5jZSAke2lkfWApO1xuXG4gICAgICAvLyBTY2hlZHVsZSBkZWxheWVkIG1vbmV5IGZsb3cgYW5kIGJ1ZGdldCB1cGRhdGUgZm9yIHRoZSB1cGRhdGVkIHJlc2lkZW5jZVxuICAgICAgdHJ5IHtcbiAgICAgICAgZGVsYXllZFVwZGF0ZVNlcnZpY2Uuc2NoZWR1bGVSZXNpZGVuY2VVcGRhdGUoaWQpO1xuICAgICAgICAvLyBEb24ndCBmYWlsIHRoZSByZXNpZGVuY2UgdXBkYXRlIGlmIHNjaGVkdWxpbmcgZmFpbHNcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCfimqDvuI8gRmFpbGVkIHRvIHNjaGVkdWxlIHJlc2lkZW5jZSB1cGRhdGU6JywgZSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHVwZGF0ZWRbMF0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyByZXNpZGVuY2U6JywgZXJyb3IpO1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGRldGFpbHM6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3Igc3RhY2s6JywgZXJyb3Iuc3RhY2spO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgcmVzaWRlbmNlJyxcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGRldGFpbHM6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWRcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gQ3JlYXRlIHJlc2lkZW5jZXMgd2hlbiBhIGJ1aWxkaW5nIGlzIGNyZWF0ZWQgKGNhbGxlZCBpbnRlcm5hbGx5KVxuICBhcHAucG9zdChcbiAgICAnL2FwaS9idWlsZGluZ3MvOmJ1aWxkaW5nSWQvZ2VuZXJhdGUtcmVzaWRlbmNlcycsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBidWlsZGluZ0lkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICAgIC8vIEdldCBidWlsZGluZyBkZXRhaWxzXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCkpXG4gICAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICAgIGlmIChidWlsZGluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnQnVpbGRpbmcgbm90IGZvdW5kJyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nRGF0YSA9IGJ1aWxkaW5nWzBdO1xuICAgICAgICBjb25zdCB0b3RhbFVuaXRzID0gYnVpbGRpbmdEYXRhLnRvdGFsVW5pdHM7XG4gICAgICAgIGNvbnN0IHRvdGFsRmxvb3JzID0gYnVpbGRpbmdEYXRhLnRvdGFsRmxvb3JzIHx8IDE7XG5cbiAgICAgICAgaWYgKHRvdGFsVW5pdHMgPiAzMDApIHtcbiAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAuc3RhdHVzKDQwMClcbiAgICAgICAgICAgIC5qc29uKHsgbWVzc2FnZTogJ0Nhbm5vdCBjcmVhdGUgbW9yZSB0aGFuIDMwMCByZXNpZGVuY2VzIHBlciBidWlsZGluZycgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiByZXNpZGVuY2VzIGFscmVhZHkgZXhpc3QgZm9yIHRoaXMgYnVpbGRpbmdcbiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXNpZGVuY2VzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgY291bnQ6IHNxbDxudW1iZXI+YGNvdW50KCopYCB9KVxuICAgICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgICAgLndoZXJlKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCkpO1xuXG4gICAgICAgIGlmIChleGlzdGluZ1Jlc2lkZW5jZXNbMF0uY291bnQgPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZXMgYWxyZWFkeSBleGlzdCBmb3IgdGhpcyBidWlsZGluZycgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZW5lcmF0ZSByZXNpZGVuY2VzXG4gICAgICAgIGNvbnN0IHJlc2lkZW5jZXNUb0NyZWF0ZSA9IFtdO1xuICAgICAgICBjb25zdCB1bml0c1BlckZsb29yID0gTWF0aC5jZWlsKHRvdGFsVW5pdHMgLyB0b3RhbEZsb29ycyk7XG5cbiAgICAgICAgZm9yIChsZXQgdW5pdCA9IDE7IHVuaXQgPD0gdG90YWxVbml0czsgdW5pdCsrKSB7XG4gICAgICAgICAgY29uc3QgZmxvb3IgPSBNYXRoLmNlaWwodW5pdCAvIHVuaXRzUGVyRmxvb3IpO1xuICAgICAgICAgIGNvbnN0IHVuaXRPbkZsb29yID0gKCh1bml0IC0gMSkgJSB1bml0c1BlckZsb29yKSArIDE7XG4gICAgICAgICAgY29uc3QgdW5pdE51bWJlciA9IGAke2Zsb29yfSR7dW5pdE9uRmxvb3IudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7XG5cbiAgICAgICAgICByZXNpZGVuY2VzVG9DcmVhdGUucHVzaCh7XG4gICAgICAgICAgICBidWlsZGluZ0lkLFxuICAgICAgICAgICAgdW5pdE51bWJlcixcbiAgICAgICAgICAgIGZsb29yLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJbnNlcnQgYWxsIHJlc2lkZW5jZXMgYXQgb25jZVxuICAgICAgICBjb25zdCBjcmVhdGVkUmVzaWRlbmNlcyA9IGF3YWl0IGRiXG4gICAgICAgICAgLmluc2VydChyZXNpZGVuY2VzKVxuICAgICAgICAgIC52YWx1ZXMocmVzaWRlbmNlc1RvQ3JlYXRlKVxuICAgICAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgICAgICByZXMuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogYFN1Y2Nlc3NmdWxseSBjcmVhdGVkICR7Y3JlYXRlZFJlc2lkZW5jZXMubGVuZ3RofSByZXNpZGVuY2VzYCxcbiAgICAgICAgICByZXNpZGVuY2VzOiBjcmVhdGVkUmVzaWRlbmNlcyxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBnZW5lcmF0aW5nIHJlc2lkZW5jZXM6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgcmVzaWRlbmNlcycgfSk7XG4gICAgICB9XG4gICAgfVxuICApO1xufVxuIl0sInZlcnNpb24iOjN9