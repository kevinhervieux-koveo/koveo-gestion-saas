040af3c2c402b46fb4114c73c438d412
'use strict';
var dispatchEvent = require('../event/dispatchEvent.js');
require('../utils/dataTransfer/Clipboard.js');
var getActiveElement = require('../utils/focus/getActiveElement.js');
require('@testing-library/dom');
const patched = Symbol('patched focus/blur methods');
function patchFocus(HTMLElement) {
    if (HTMLElement.prototype[patched]) {
        return;
    }
    // eslint-disable-next-line @typescript-eslint/unbound-method
    const { focus, blur } = HTMLElement.prototype;
    Object.defineProperties(HTMLElement.prototype, {
        focus: {
            configurable: true,
            get: () => patchedFocus
        },
        blur: {
            configurable: true,
            get: () => patchedBlur
        },
        [patched]: {
            configurable: true,
            get: () => ({
                focus,
                blur
            })
        }
    });
    let activeCall;
    function patchedFocus(options) {
        if (this.ownerDocument.visibilityState !== 'hidden') {
            return focus.call(this, options);
        }
        const blurred = getActiveTarget(this.ownerDocument);
        if (blurred === this) {
            return;
        }
        const thisCall = Symbol('focus call');
        activeCall = thisCall;
        if (blurred) {
            blur.call(blurred);
            dispatchEvent.dispatchDOMEvent(blurred, 'blur', {
                relatedTarget: this
            });
            dispatchEvent.dispatchDOMEvent(blurred, 'focusout', {
                relatedTarget: activeCall === thisCall ? this : null
            });
        }
        if (activeCall === thisCall) {
            focus.call(this, options);
            dispatchEvent.dispatchDOMEvent(this, 'focus', {
                relatedTarget: blurred
            });
        }
        if (activeCall === thisCall) {
            dispatchEvent.dispatchDOMEvent(this, 'focusin', {
                relatedTarget: blurred
            });
        }
    }
    function patchedBlur() {
        if (this.ownerDocument.visibilityState !== 'hidden') {
            return blur.call(this);
        }
        const blurred = getActiveTarget(this.ownerDocument);
        if (blurred !== this) {
            return;
        }
        const thisCall = Symbol('blur call');
        activeCall = thisCall;
        blur.call(this);
        dispatchEvent.dispatchDOMEvent(blurred, 'blur', {
            relatedTarget: null
        });
        dispatchEvent.dispatchDOMEvent(blurred, 'focusout', {
            relatedTarget: null
        });
    }
}
function getActiveTarget(document) {
    const active = getActiveElement.getActiveElement(document);
    return (active === null || active === undefined ? undefined : active.tagName) === 'BODY' ? null : active;
}
function restoreFocus(HTMLElement) {
    if (HTMLElement.prototype[patched]) {
        const { focus, blur } = HTMLElement.prototype[patched];
        Object.defineProperties(HTMLElement.prototype, {
            focus: {
                configurable: true,
                get: () => focus
            },
            blur: {
                configurable: true,
                get: () => blur
            }
        });
    }
}
exports.patchFocus = patchFocus;
exports.restoreFocus = restoreFocus;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL2RvY3VtZW50L3BhdGNoRm9jdXMuanMiLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDekQsT0FBTyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFDOUMsSUFBSSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsb0NBQW9DLENBQUMsQ0FBQztBQUNyRSxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUVoQyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsNEJBQTRCLENBQUMsQ0FBQztBQUNyRCxTQUFTLFVBQVUsQ0FBQyxXQUFXO0lBQzNCLElBQUksV0FBVyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ2pDLE9BQU87SUFDWCxDQUFDO0lBQ0QsNkRBQTZEO0lBQzdELE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQztJQUM5QyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRTtRQUMzQyxLQUFLLEVBQUU7WUFDSCxZQUFZLEVBQUUsSUFBSTtZQUNsQixHQUFHLEVBQUUsR0FBRSxFQUFFLENBQUEsWUFBWTtTQUN4QjtRQUNELElBQUksRUFBRTtZQUNGLFlBQVksRUFBRSxJQUFJO1lBQ2xCLEdBQUcsRUFBRSxHQUFFLEVBQUUsQ0FBQSxXQUFXO1NBQ3ZCO1FBQ0QsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNQLFlBQVksRUFBRSxJQUFJO1lBQ2xCLEdBQUcsRUFBRSxHQUFFLEVBQUUsQ0FBQSxDQUFDO2dCQUNGLEtBQUs7Z0JBQ0wsSUFBSTthQUNQLENBQUM7U0FDVDtLQUNKLENBQUMsQ0FBQztJQUNILElBQUksVUFBVSxDQUFDO0lBQ2YsU0FBUyxZQUFZLENBQUMsT0FBTztRQUN6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QyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUU7WUFDM0MsS0FBSyxFQUFFO2dCQUNILFlBQVksRUFBRSxJQUFJO2dCQUNsQixHQUFHLEVBQUUsR0FBRSxFQUFFLENBQUEsS0FBSzthQUNqQjtZQUNELElBQUksRUFBRTtnQkFDRixZQUFZLEVBQUUsSUFBSTtnQkFDbEIsR0FBRyxFQUFFLEdBQUUsRUFBRSxDQUFBLElBQUk7YUFDaEI7U0FDSixDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQztBQUVELE9BQU8sQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0FBQ2hDLE9BQU8sQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvbm9kZV9tb2R1bGVzL0B0ZXN0aW5nLWxpYnJhcnkvdXNlci1ldmVudC9kaXN0L2Nqcy9kb2N1bWVudC9wYXRjaEZvY3VzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGRpc3BhdGNoRXZlbnQgPSByZXF1aXJlKCcuLi9ldmVudC9kaXNwYXRjaEV2ZW50LmpzJyk7XG5yZXF1aXJlKCcuLi91dGlscy9kYXRhVHJhbnNmZXIvQ2xpcGJvYXJkLmpzJyk7XG52YXIgZ2V0QWN0aXZlRWxlbWVudCA9IHJlcXVpcmUoJy4uL3V0aWxzL2ZvY3VzL2dldEFjdGl2ZUVsZW1lbnQuanMnKTtcbnJlcXVpcmUoJ0B0ZXN0aW5nLWxpYnJhcnkvZG9tJyk7XG5cbmNvbnN0IHBhdGNoZWQgPSBTeW1ib2woJ3BhdGNoZWQgZm9jdXMvYmx1ciBtZXRob2RzJyk7XG5mdW5jdGlvbiBwYXRjaEZvY3VzKEhUTUxFbGVtZW50KSB7XG4gICAgaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZVtwYXRjaGVkXSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvdW5ib3VuZC1tZXRob2RcbiAgICBjb25zdCB7IGZvY3VzLCBibHVyIH0gPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoSFRNTEVsZW1lbnQucHJvdG90eXBlLCB7XG4gICAgICAgIGZvY3VzOiB7XG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICBnZXQ6ICgpPT5wYXRjaGVkRm9jdXNcbiAgICAgICAgfSxcbiAgICAgICAgYmx1cjoge1xuICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgZ2V0OiAoKT0+cGF0Y2hlZEJsdXJcbiAgICAgICAgfSxcbiAgICAgICAgW3BhdGNoZWRdOiB7XG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICBnZXQ6ICgpPT4oe1xuICAgICAgICAgICAgICAgICAgICBmb2N1cyxcbiAgICAgICAgICAgICAgICAgICAgYmx1clxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBsZXQgYWN0aXZlQ2FsbDtcbiAgICBmdW5jdGlvbiBwYXRjaGVkRm9jdXMob3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5vd25lckRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSAhPT0gJ2hpZGRlbicpIHtcbiAgICAgICAgICAgIHJldHVybiBmb2N1cy5jYWxsKHRoaXMsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJsdXJyZWQgPSBnZXRBY3RpdmVUYXJnZXQodGhpcy5vd25lckRvY3VtZW50KTtcbiAgICAgICAgaWYgKGJsdXJyZWQgPT09IHRoaXMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0aGlzQ2FsbCA9IFN5bWJvbCgnZm9jdXMgY2FsbCcpO1xuICAgICAgICBhY3RpdmVDYWxsID0gdGhpc0NhbGw7XG4gICAgICAgIGlmIChibHVycmVkKSB7XG4gICAgICAgICAgICBibHVyLmNhbGwoYmx1cnJlZCk7XG4gICAgICAgICAgICBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoRE9NRXZlbnQoYmx1cnJlZCwgJ2JsdXInLCB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogdGhpc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoRE9NRXZlbnQoYmx1cnJlZCwgJ2ZvY3Vzb3V0Jywge1xuICAgICAgICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IGFjdGl2ZUNhbGwgPT09IHRoaXNDYWxsID8gdGhpcyA6IG51bGxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhY3RpdmVDYWxsID09PSB0aGlzQ2FsbCkge1xuICAgICAgICAgICAgZm9jdXMuY2FsbCh0aGlzLCBvcHRpb25zKTtcbiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQuZGlzcGF0Y2hET01FdmVudCh0aGlzLCAnZm9jdXMnLCB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogYmx1cnJlZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFjdGl2ZUNhbGwgPT09IHRoaXNDYWxsKSB7XG4gICAgICAgICAgICBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoRE9NRXZlbnQodGhpcywgJ2ZvY3VzaW4nLCB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogYmx1cnJlZFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gcGF0Y2hlZEJsdXIoKSB7XG4gICAgICAgIGlmICh0aGlzLm93bmVyRG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlICE9PSAnaGlkZGVuJykge1xuICAgICAgICAgICAgcmV0dXJuIGJsdXIuY2FsbCh0aGlzKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBibHVycmVkID0gZ2V0QWN0aXZlVGFyZ2V0KHRoaXMub3duZXJEb2N1bWVudCk7XG4gICAgICAgIGlmIChibHVycmVkICE9PSB0aGlzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGhpc0NhbGwgPSBTeW1ib2woJ2JsdXIgY2FsbCcpO1xuICAgICAgICBhY3RpdmVDYWxsID0gdGhpc0NhbGw7XG4gICAgICAgIGJsdXIuY2FsbCh0aGlzKTtcbiAgICAgICAgZGlzcGF0Y2hFdmVudC5kaXNwYXRjaERPTUV2ZW50KGJsdXJyZWQsICdibHVyJywge1xuICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogbnVsbFxuICAgICAgICB9KTtcbiAgICAgICAgZGlzcGF0Y2hFdmVudC5kaXNwYXRjaERPTUV2ZW50KGJsdXJyZWQsICdmb2N1c291dCcsIHtcbiAgICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IG51bGxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuZnVuY3Rpb24gZ2V0QWN0aXZlVGFyZ2V0KGRvY3VtZW50KSB7XG4gICAgY29uc3QgYWN0aXZlID0gZ2V0QWN0aXZlRWxlbWVudC5nZXRBY3RpdmVFbGVtZW50KGRvY3VtZW50KTtcbiAgICByZXR1cm4gKGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGFjdGl2ZS50YWdOYW1lKSA9PT0gJ0JPRFknID8gbnVsbCA6IGFjdGl2ZTtcbn1cbmZ1bmN0aW9uIHJlc3RvcmVGb2N1cyhIVE1MRWxlbWVudCkge1xuICAgIGlmIChIVE1MRWxlbWVudC5wcm90b3R5cGVbcGF0Y2hlZF0pIHtcbiAgICAgICAgY29uc3QgeyBmb2N1cywgYmx1ciB9ID0gSFRNTEVsZW1lbnQucHJvdG90eXBlW3BhdGNoZWRdO1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhIVE1MRWxlbWVudC5wcm90b3R5cGUsIHtcbiAgICAgICAgICAgIGZvY3VzOiB7XG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGdldDogKCk9PmZvY3VzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYmx1cjoge1xuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBnZXQ6ICgpPT5ibHVyXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0cy5wYXRjaEZvY3VzID0gcGF0Y2hGb2N1cztcbmV4cG9ydHMucmVzdG9yZUZvY3VzID0gcmVzdG9yZUZvY3VzO1xuIl0sInZlcnNpb24iOjN9