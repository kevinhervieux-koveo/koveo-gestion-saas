40685da39d4443f251a4881d7bb22f87
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryClient = exports.getQueryFn = void 0;
exports.apiRequest = apiRequest;
const react_query_1 = require("@tanstack/react-query");
// Enhanced query client with aggressive memory management for Quebec property management
const MAX_CACHE_SIZE = 50; // Limit cache to 50 queries
const MEMORY_CLEANUP_INTERVAL = 3 * 60 * 1000; // 3 minutes
// Track query cache size and clean up when needed
let queryCount = 0;
const cleanupOldQueries = () => {
    if (queryCount > MAX_CACHE_SIZE) {
        exports.queryClient.getQueryCache().clear();
        queryCount = 0;
    }
};
/**
 * Throws an error if the HTTP response is not successful (status not ok).
 * Extracts error message from response body or uses status text as fallback.
 * @param res - Fetch API Response object to check.
 * @throws Error with status code and message if response is not ok.
 */
async function throwIfResNotOk(res) {
    if (!res.ok) {
        const text = (await res.text()) || res.statusText;
        throw new Error(`${res.status}: ${text}`);
    }
}
/**
 * Makes an HTTP API request with proper error handling and JSON serialization.
 * Automatically includes credentials and sets Content-Type header for JSON data.
 * @param method - HTTP method (GET, POST, PUT, DELETE, etc.).
 * @param url - API endpoint URL.
 * @param data - Optional data to send in request body (will be JSON stringified).
 * @returns Fetch API Response object.
 * @throws Error if response status is not ok.
 */
async function apiRequest(method, url, data) {
    const headers = {};
    // Handle FormData vs JSON data
    if (data instanceof FormData) {
        // Don't set Content-Type for FormData - let browser set it with boundary
    }
    else if (data) {
        headers['Content-Type'] = 'application/json';
    }
    const res = await fetch(url, {
        method,
        headers,
        body: data instanceof FormData ? data : data ? JSON.stringify(data) : undefined,
        credentials: 'include',
    });
    await throwIfResNotOk(res);
    return res;
}
/**
 * Creates a query function for React Query with configurable 401 handling.
 * Used as default query function for all React Query queries in the application.
 * @param options - Configuration options.
 * @param options.on401 - How to handle 401 responses.
 * @returns Configured query function for React Query.
 */
const getQueryFn = ({ on401: unauthorizedBehavior }) => async ({ queryKey }) => {
    const res = await fetch(queryKey.join('/'), {
        credentials: 'include',
    });
    if (unauthorizedBehavior === 'returnNull' && res.status === 401) {
        return null;
    }
    await throwIfResNotOk(res);
    // Check if response is JSON before parsing
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
        const text = await res.text();
        throw new Error(`Expected JSON response but received ${contentType || 'unknown content type'}. Response: ${text.substring(0, 100)}...`);
    }
    return await res.json();
};
exports.getQueryFn = getQueryFn;
/**
 * Global React Query client instance with configured defaults.
 * Provides centralized data fetching, caching, and synchronization for the application.
 * Configured with custom error handling and optimized memory management.
 */
exports.queryClient = new react_query_1.QueryClient({
    defaultOptions: {
        queries: {
            queryFn: (0, exports.getQueryFn)({ on401: 'throw' }),
            refetchInterval: false,
            refetchOnWindowFocus: false,
            // Allow data to become stale after 2 minutes for better performance
            staleTime: 2 * 60 * 1000, // 2 minutes
            // Cache data for 5 minutes before removal to prevent memory bloat
            gcTime: 5 * 60 * 1000, // 5 minutes (formerly cacheTime)
            retry: (failureCount, error) => {
                // Retry authentication and common timing errors
                if ((error?.message?.includes('401') ||
                    error?.message?.includes('404') ||
                    error?.message?.includes('Authentication required')) &&
                    failureCount < 2) {
                    return true;
                }
                // Don't retry other client errors (4xx)
                if (error?.message?.includes('4')) {
                    return false;
                }
                return failureCount < 2;
            },
        },
        mutations: {
            retry: false,
            // Don't cache mutation results indefinitely
            gcTime: 2 * 60 * 1000, // 2 minutes
        },
    },
    // Limit query cache size to prevent memory bloat
    queryCache: new react_query_1.QueryCache({
        onError: (error) => {
            // Handle session expiry globally - redirect to login
            if (error.message.includes('401') || error.message.includes('Authentication required')) {
                // Check if we're not already on login or public pages
                const currentPath = window.location.pathname;
                const isPublicPath = [
                    '/',
                    '/auth/login',
                    '/auth/register',
                    '/features',
                    '/pricing',
                    '/security',
                    '/story',
                ].includes(currentPath);
                if (!isPublicPath) {
                    window.location.href = '/auth/login';
                    return;
                }
            }
            // Only log query errors in development
            if (process.env.NODE_ENV === 'development') {
                // Skip logging authentication timing errors and common API errors to reduce console noise
                if (error.message.includes('401') ||
                    error.message.includes('Authentication required') ||
                    error.message.includes('404') ||
                    error.message.includes('API endpoint not found')) {
                    return; // Authentication timing issues and 404s will be retried automatically
                }
                // Provide more helpful error messages for common issues
                if (error.message.includes('DOCTYPE') || error.message.includes('Unexpected token')) {
                    console.error('❌ API returned HTML instead of JSON. This usually means:', error.message);
                    console.error('• API endpoint not found (404)');
                    console.error('• Server error returning error page');
                    console.error('• Route mismatch between frontend and backend');
                }
                else {
                    console.error('❌ Query failed:', error.message);
                }
            }
        },
        onSuccess: () => {
            queryCount++;
            if (queryCount % 10 === 0) {
                // Check memory usage every 10 queries
                cleanupOldQueries();
            }
        },
    }),
    // Limit mutation cache size
    mutationCache: new react_query_1.MutationCache({
        onError: (error) => {
            // Handle session expiry globally for mutations - redirect to login
            if (error.message.includes('401') || error.message.includes('Authentication required')) {
                // Check if we're not already on login or public pages
                const currentPath = window.location.pathname;
                const isPublicPath = [
                    '/',
                    '/auth/login',
                    '/auth/register',
                    '/features',
                    '/pricing',
                    '/security',
                    '/story',
                ].includes(currentPath);
                if (!isPublicPath) {
                    window.location.href = '/auth/login';
                    return;
                }
            }
            // Only log mutation errors in development
            if (process.env.NODE_ENV === 'development') {
                console.error('❌ Mutation failed:', error.message);
            }
        },
    }),
});
// Set up automatic memory cleanup
setInterval(() => {
    cleanupOldQueries();
}, MEMORY_CLEANUP_INTERVAL);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9jbGllbnQvc3JjL2xpYi9xdWVyeUNsaWVudC50cyIsIm1hcHBpbmdzIjoiOzs7QUFxQ0EsZ0NBbUJDO0FBeERELHVEQUE4RjtBQUU5Rix5RkFBeUY7QUFDekYsTUFBTSxjQUFjLEdBQUcsRUFBRSxDQUFDLENBQUMsNEJBQTRCO0FBQ3ZELE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxZQUFZO0FBRTNELGtEQUFrRDtBQUNsRCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7QUFDbkIsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLEVBQUU7SUFDN0IsSUFBSSxVQUFVLEdBQUcsY0FBYyxFQUFFLENBQUM7UUFDaEMsbUJBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRjs7Ozs7R0FLRztBQUNILEtBQUssVUFBVSxlQUFlLENBQUMsR0FBYTtJQUMxQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ1osTUFBTSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDbEQsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7Ozs7OztHQVFHO0FBQ0ksS0FBSyxVQUFVLFVBQVUsQ0FBQyxNQUFjLEVBQUUsR0FBVyxFQUFFLElBQWM7SUFDMUUsTUFBTSxPQUFPLEdBQTJCLEVBQUUsQ0FBQztJQUUzQywrQkFBK0I7SUFDL0IsSUFBSSxJQUFJLFlBQVksUUFBUSxFQUFFLENBQUM7UUFDN0IseUVBQXlFO0lBQzNFLENBQUM7U0FBTSxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2hCLE9BQU8s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LEVBQUUsQ0FBQztnQkFDdkYsc0RBQXNEO2dCQUN0RCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztnQkFDN0MsTUFBTSxZQUFZLEdBQUc7b0JBQ25CLEdBQUc7b0JBQ0gsYUFBYTtvQkFDYixnQkFBZ0I7b0JBQ2hCLFdBQVc7b0JBQ1gsVUFBVTtvQkFDVixXQUFXO29CQUNYLFFBQVE7aUJBQ1QsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBRXhCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFDbEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsYUFBYSxDQUFDO29CQUNyQyxPQUFPO2dCQUNULENBQUM7WUFDSCxDQUFDO1lBRUQsMENBQTBDO1lBQzFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxFQUFFLENBQUM7Z0JBQzNDLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JELENBQUM7UUFDSCxDQUFDO0tBQ0YsQ0FBQztDQUNILENBQUMsQ0FBQztBQUVILGtDQUFrQztBQUNsQyxXQUFXLENBQUMsR0FBRyxFQUFFO0lBQ2YsaUJBQWlCLEVBQUUsQ0FBQztBQUN0QixDQUFDLEVBQUUsdUJBQXVCLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL2NsaWVudC9zcmMvbGliL3F1ZXJ5Q2xpZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5Q2xpZW50LCBRdWVyeUZ1bmN0aW9uLCBRdWVyeUNhY2hlLCBNdXRhdGlvbkNhY2hlIH0gZnJvbSAnQHRhbnN0YWNrL3JlYWN0LXF1ZXJ5JztcblxuLy8gRW5oYW5jZWQgcXVlcnkgY2xpZW50IHdpdGggYWdncmVzc2l2ZSBtZW1vcnkgbWFuYWdlbWVudCBmb3IgUXVlYmVjIHByb3BlcnR5IG1hbmFnZW1lbnRcbmNvbnN0IE1BWF9DQUNIRV9TSVpFID0gNTA7IC8vIExpbWl0IGNhY2hlIHRvIDUwIHF1ZXJpZXNcbmNvbnN0IE1FTU9SWV9DTEVBTlVQX0lOVEVSVkFMID0gMyAqIDYwICogMTAwMDsgLy8gMyBtaW51dGVzXG5cbi8vIFRyYWNrIHF1ZXJ5IGNhY2hlIHNpemUgYW5kIGNsZWFuIHVwIHdoZW4gbmVlZGVkXG5sZXQgcXVlcnlDb3VudCA9IDA7XG5jb25zdCBjbGVhbnVwT2xkUXVlcmllcyA9ICgpID0+IHtcbiAgaWYgKHF1ZXJ5Q291bnQgPiBNQVhfQ0FDSEVfU0laRSkge1xuICAgIHF1ZXJ5Q2xpZW50LmdldFF1ZXJ5Q2FjaGUoKS5jbGVhcigpO1xuICAgIHF1ZXJ5Q291bnQgPSAwO1xuICB9XG59O1xuXG4vKipcbiAqIFRocm93cyBhbiBlcnJvciBpZiB0aGUgSFRUUCByZXNwb25zZSBpcyBub3Qgc3VjY2Vzc2Z1bCAoc3RhdHVzIG5vdCBvaykuXG4gKiBFeHRyYWN0cyBlcnJvciBtZXNzYWdlIGZyb20gcmVzcG9uc2UgYm9keSBvciB1c2VzIHN0YXR1cyB0ZXh0IGFzIGZhbGxiYWNrLlxuICogQHBhcmFtIHJlcyAtIEZldGNoIEFQSSBSZXNwb25zZSBvYmplY3QgdG8gY2hlY2suXG4gKiBAdGhyb3dzIEVycm9yIHdpdGggc3RhdHVzIGNvZGUgYW5kIG1lc3NhZ2UgaWYgcmVzcG9uc2UgaXMgbm90IG9rLlxuICovXG5hc3luYyBmdW5jdGlvbiB0aHJvd0lmUmVzTm90T2socmVzOiBSZXNwb25zZSkge1xuICBpZiAoIXJlcy5vaykge1xuICAgIGNvbnN0IHRleHQgPSAoYXdhaXQgcmVzLnRleHQoKSkgfHwgcmVzLnN0YXR1c1RleHQ7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke3Jlcy5zdGF0dXN9OiAke3RleHR9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBNYWtlcyBhbiBIVFRQIEFQSSByZXF1ZXN0IHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nIGFuZCBKU09OIHNlcmlhbGl6YXRpb24uXG4gKiBBdXRvbWF0aWNhbGx5IGluY2x1ZGVzIGNyZWRlbnRpYWxzIGFuZCBzZXRzIENvbnRlbnQtVHlwZSBoZWFkZXIgZm9yIEpTT04gZGF0YS5cbiAqIEBwYXJhbSBtZXRob2QgLSBIVFRQIG1ldGhvZCAoR0VULCBQT1NULCBQVVQsIERFTEVURSwgZXRjLikuXG4gKiBAcGFyYW0gdXJsIC0gQVBJIGVuZHBvaW50IFVSTC5cbiAqIEBwYXJhbSBkYXRhIC0gT3B0aW9uYWwgZGF0YSB0byBzZW5kIGluIHJlcXVlc3QgYm9keSAod2lsbCBiZSBKU09OIHN0cmluZ2lmaWVkKS5cbiAqIEByZXR1cm5zIEZldGNoIEFQSSBSZXNwb25zZSBvYmplY3QuXG4gKiBAdGhyb3dzIEVycm9yIGlmIHJlc3BvbnNlIHN0YXR1cyBpcyBub3Qgb2suXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcGlSZXF1ZXN0KG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgZGF0YT86IHVua25vd24pOiBQcm9taXNlPFJlc3BvbnNlPiB7XG4gIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAvLyBIYW5kbGUgRm9ybURhdGEgdnMgSlNPTiBkYXRhXG4gIGlmIChkYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcbiAgICAvLyBEb24ndCBzZXQgQ29udGVudC1UeXBlIGZvciBGb3JtRGF0YSAtIGxldCBicm93c2VyIHNldCBpdCB3aXRoIGJvdW5kYXJ5XG4gIH0gZWxzZSBpZiAoZGF0YSkge1xuICAgIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICB9XG5cbiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgbWV0aG9kLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogZGF0YSBpbnN0YW5jZW9mIEZvcm1EYXRhID8gZGF0YSA6IGRhdGEgPyBKU09OLnN0cmluZ2lmeShkYXRhKSA6IHVuZGVmaW5lZCxcbiAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLFxuICB9KTtcblxuICBhd2FpdCB0aHJvd0lmUmVzTm90T2socmVzKTtcbiAgcmV0dXJuIHJlcztcbn1cblxuLyoqXG4gKiBEZWZpbmVzIGJlaGF2aW9yIHdoZW4gZW5jb3VudGVyaW5nIDQwMSBVbmF1dGhvcml6ZWQgcmVzcG9uc2VzLlxuICogLSAncmV0dXJuTnVsbCc6IFJldHVybnMgbnVsbCBmb3IgNDAxIHJlc3BvbnNlcyAodXNlZnVsIGZvciBvcHRpb25hbCBhdXRoZW50aWNhdGlvbilcbiAqIC0gJ3Rocm93JzogVGhyb3dzIGVycm9yIGZvciA0MDEgcmVzcG9uc2VzIChkZWZhdWx0IGJlaGF2aW9yKS5cbiAqL1xudHlwZSBVbmF1dGhvcml6ZWRCZWhhdmlvciA9ICdyZXR1cm5OdWxsJyB8ICd0aHJvdyc7XG5cbi8qKlxuICogQ3JlYXRlcyBhIHF1ZXJ5IGZ1bmN0aW9uIGZvciBSZWFjdCBRdWVyeSB3aXRoIGNvbmZpZ3VyYWJsZSA0MDEgaGFuZGxpbmcuXG4gKiBVc2VkIGFzIGRlZmF1bHQgcXVlcnkgZnVuY3Rpb24gZm9yIGFsbCBSZWFjdCBRdWVyeSBxdWVyaWVzIGluIHRoZSBhcHBsaWNhdGlvbi5cbiAqIEBwYXJhbSBvcHRpb25zIC0gQ29uZmlndXJhdGlvbiBvcHRpb25zLlxuICogQHBhcmFtIG9wdGlvbnMub240MDEgLSBIb3cgdG8gaGFuZGxlIDQwMSByZXNwb25zZXMuXG4gKiBAcmV0dXJucyBDb25maWd1cmVkIHF1ZXJ5IGZ1bmN0aW9uIGZvciBSZWFjdCBRdWVyeS5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldFF1ZXJ5Rm46IDxUPihfb3B0aW9uczogeyBvbjQwMTogVW5hdXRob3JpemVkQmVoYXZpb3IgfSkgPT4gUXVlcnlGdW5jdGlvbjxUPiA9XG4gICh7IG9uNDAxOiB1bmF1dGhvcml6ZWRCZWhhdmlvciB9KSA9PlxuICBhc3luYyAoeyBxdWVyeUtleSB9KSA9PiB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2gocXVlcnlLZXkuam9pbignLycpIGFzIHN0cmluZywge1xuICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJyxcbiAgICB9KTtcblxuICAgIGlmICh1bmF1dGhvcml6ZWRCZWhhdmlvciA9PT0gJ3JldHVybk51bGwnICYmIHJlcy5zdGF0dXMgPT09IDQwMSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhyb3dJZlJlc05vdE9rKHJlcyk7XG5cbiAgICAvLyBDaGVjayBpZiByZXNwb25zZSBpcyBKU09OIGJlZm9yZSBwYXJzaW5nXG4gICAgY29uc3QgY29udGVudFR5cGUgPSByZXMuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpO1xuICAgIGlmICghY29udGVudFR5cGUgfHwgIWNvbnRlbnRUeXBlLmluY2x1ZGVzKCdhcHBsaWNhdGlvbi9qc29uJykpIHtcbiAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXMudGV4dCgpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRXhwZWN0ZWQgSlNPTiByZXNwb25zZSBidXQgcmVjZWl2ZWQgJHtjb250ZW50VHlwZSB8fCAndW5rbm93biBjb250ZW50IHR5cGUnfS4gUmVzcG9uc2U6ICR7dGV4dC5zdWJzdHJpbmcoMCwgMTAwKX0uLi5gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCByZXMuanNvbigpO1xuICB9O1xuXG4vKipcbiAqIEdsb2JhbCBSZWFjdCBRdWVyeSBjbGllbnQgaW5zdGFuY2Ugd2l0aCBjb25maWd1cmVkIGRlZmF1bHRzLlxuICogUHJvdmlkZXMgY2VudHJhbGl6ZWQgZGF0YSBmZXRjaGluZywgY2FjaGluZywgYW5kIHN5bmNocm9uaXphdGlvbiBmb3IgdGhlIGFwcGxpY2F0aW9uLlxuICogQ29uZmlndXJlZCB3aXRoIGN1c3RvbSBlcnJvciBoYW5kbGluZyBhbmQgb3B0aW1pemVkIG1lbW9yeSBtYW5hZ2VtZW50LlxuICovXG5leHBvcnQgY29uc3QgcXVlcnlDbGllbnQgPSBuZXcgUXVlcnlDbGllbnQoe1xuICBkZWZhdWx0T3B0aW9uczoge1xuICAgIHF1ZXJpZXM6IHtcbiAgICAgIHF1ZXJ5Rm46IGdldFF1ZXJ5Rm4oeyBvbjQwMTogJ3Rocm93JyB9KSxcbiAgICAgIHJlZmV0Y2hJbnRlcnZhbDogZmFsc2UsXG4gICAgICByZWZldGNoT25XaW5kb3dGb2N1czogZmFsc2UsXG4gICAgICAvLyBBbGxvdyBkYXRhIHRvIGJlY29tZSBzdGFsZSBhZnRlciAyIG1pbnV0ZXMgZm9yIGJldHRlciBwZXJmb3JtYW5jZVxuICAgICAgc3RhbGVUaW1lOiAyICogNjAgKiAxMDAwLCAvLyAyIG1pbnV0ZXNcbiAgICAgIC8vIENhY2hlIGRhdGEgZm9yIDUgbWludXRlcyBiZWZvcmUgcmVtb3ZhbCB0byBwcmV2ZW50IG1lbW9yeSBibG9hdFxuICAgICAgZ2NUaW1lOiA1ICogNjAgKiAxMDAwLCAvLyA1IG1pbnV0ZXMgKGZvcm1lcmx5IGNhY2hlVGltZSlcbiAgICAgIHJldHJ5OiAoZmFpbHVyZUNvdW50LCBlcnJvcjogYW55KSA9PiB7XG4gICAgICAgIC8vIFJldHJ5IGF1dGhlbnRpY2F0aW9uIGFuZCBjb21tb24gdGltaW5nIGVycm9yc1xuICAgICAgICBpZiAoXG4gICAgICAgICAgKGVycm9yPy5tZXNzYWdlPy5pbmNsdWRlcygnNDAxJykgfHxcbiAgICAgICAgICAgIGVycm9yPy5tZXNzYWdlPy5pbmNsdWRlcygnNDA0JykgfHxcbiAgICAgICAgICAgIGVycm9yPy5tZXNzYWdlPy5pbmNsdWRlcygnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnKSkgJiZcbiAgICAgICAgICBmYWlsdXJlQ291bnQgPCAyXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIERvbid0IHJldHJ5IG90aGVyIGNsaWVudCBlcnJvcnMgKDR4eClcbiAgICAgICAgaWYgKGVycm9yPy5tZXNzYWdlPy5pbmNsdWRlcygnNCcpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWlsdXJlQ291bnQgPCAyO1xuICAgICAgfSxcbiAgICB9LFxuICAgIG11dGF0aW9uczoge1xuICAgICAgcmV0cnk6IGZhbHNlLFxuICAgICAgLy8gRG9uJ3QgY2FjaGUgbXV0YXRpb24gcmVzdWx0cyBpbmRlZmluaXRlbHlcbiAgICAgIGdjVGltZTogMiAqIDYwICogMTAwMCwgLy8gMiBtaW51dGVzXG4gICAgfSxcbiAgfSxcbiAgLy8gTGltaXQgcXVlcnkgY2FjaGUgc2l6ZSB0byBwcmV2ZW50IG1lbW9yeSBibG9hdFxuICBxdWVyeUNhY2hlOiBuZXcgUXVlcnlDYWNoZSh7XG4gICAgb25FcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAvLyBIYW5kbGUgc2Vzc2lvbiBleHBpcnkgZ2xvYmFsbHkgLSByZWRpcmVjdCB0byBsb2dpblxuICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJzQwMScpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJykpIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgbm90IGFscmVhZHkgb24gbG9naW4gb3IgcHVibGljIHBhZ2VzXG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lO1xuICAgICAgICBjb25zdCBpc1B1YmxpY1BhdGggPSBbXG4gICAgICAgICAgJy8nLFxuICAgICAgICAgICcvYXV0aC9sb2dpbicsXG4gICAgICAgICAgJy9hdXRoL3JlZ2lzdGVyJyxcbiAgICAgICAgICAnL2ZlYXR1cmVzJyxcbiAgICAgICAgICAnL3ByaWNpbmcnLFxuICAgICAgICAgICcvc2VjdXJpdHknLFxuICAgICAgICAgICcvc3RvcnknLFxuICAgICAgICBdLmluY2x1ZGVzKGN1cnJlbnRQYXRoKTtcblxuICAgICAgICBpZiAoIWlzUHVibGljUGF0aCkge1xuICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gJy9hdXRoL2xvZ2luJztcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gT25seSBsb2cgcXVlcnkgZXJyb3JzIGluIGRldmVsb3BtZW50XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgLy8gU2tpcCBsb2dnaW5nIGF1dGhlbnRpY2F0aW9uIHRpbWluZyBlcnJvcnMgYW5kIGNvbW1vbiBBUEkgZXJyb3JzIHRvIHJlZHVjZSBjb25zb2xlIG5vaXNlXG4gICAgICAgIGlmIChcbiAgICAgICAgICBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCc0MDEnKSB8fFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJykgfHxcbiAgICAgICAgICBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCc0MDQnKSB8fFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0FQSSBlbmRwb2ludCBub3QgZm91bmQnKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm47IC8vIEF1dGhlbnRpY2F0aW9uIHRpbWluZyBpc3N1ZXMgYW5kIDQwNHMgd2lsbCBiZSByZXRyaWVkIGF1dG9tYXRpY2FsbHlcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFByb3ZpZGUgbW9yZSBoZWxwZnVsIGVycm9yIG1lc3NhZ2VzIGZvciBjb21tb24gaXNzdWVzXG4gICAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdET0NUWVBFJykgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVW5leHBlY3RlZCB0b2tlbicpKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEFQSSByZXR1cm5lZCBIVE1MIGluc3RlYWQgb2YgSlNPTi4gVGhpcyB1c3VhbGx5IG1lYW5zOicsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KAoiBBUEkgZW5kcG9pbnQgbm90IGZvdW5kICg0MDQpJyk7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4oCiIFNlcnZlciBlcnJvciByZXR1cm5pbmcgZXJyb3IgcGFnZScpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KAoiBSb3V0ZSBtaXNtYXRjaCBiZXR3ZWVuIGZyb250ZW5kIGFuZCBiYWNrZW5kJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFF1ZXJ5IGZhaWxlZDonLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgb25TdWNjZXNzOiAoKSA9PiB7XG4gICAgICBxdWVyeUNvdW50Kys7XG4gICAgICBpZiAocXVlcnlDb3VudCAlIDEwID09PSAwKSB7XG4gICAgICAgIC8vIENoZWNrIG1lbW9yeSB1c2FnZSBldmVyeSAxMCBxdWVyaWVzXG4gICAgICAgIGNsZWFudXBPbGRRdWVyaWVzKCk7XG4gICAgICB9XG4gICAgfSxcbiAgfSksXG4gIC8vIExpbWl0IG11dGF0aW9uIGNhY2hlIHNpemVcbiAgbXV0YXRpb25DYWNoZTogbmV3IE11dGF0aW9uQ2FjaGUoe1xuICAgIG9uRXJyb3I6IChlcnJvcikgPT4ge1xuICAgICAgLy8gSGFuZGxlIHNlc3Npb24gZXhwaXJ5IGdsb2JhbGx5IGZvciBtdXRhdGlvbnMgLSByZWRpcmVjdCB0byBsb2dpblxuICAgICAgaWYgKGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJzQwMScpIHx8IGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJykpIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgbm90IGFscmVhZHkgb24gbG9naW4gb3IgcHVibGljIHBhZ2VzXG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lO1xuICAgICAgICBjb25zdCBpc1B1YmxpY1BhdGggPSBbXG4gICAgICAgICAgJy8nLFxuICAgICAgICAgICcvYXV0aC9sb2dpbicsXG4gICAgICAgICAgJy9hdXRoL3JlZ2lzdGVyJyxcbiAgICAgICAgICAnL2ZlYXR1cmVzJyxcbiAgICAgICAgICAnL3ByaWNpbmcnLFxuICAgICAgICAgICcvc2VjdXJpdHknLFxuICAgICAgICAgICcvc3RvcnknLFxuICAgICAgICBdLmluY2x1ZGVzKGN1cnJlbnRQYXRoKTtcblxuICAgICAgICBpZiAoIWlzUHVibGljUGF0aCkge1xuICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gJy9hdXRoL2xvZ2luJztcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gT25seSBsb2cgbXV0YXRpb24gZXJyb3JzIGluIGRldmVsb3BtZW50XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIE11dGF0aW9uIGZhaWxlZDonLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9LFxuICB9KSxcbn0pO1xuXG4vLyBTZXQgdXAgYXV0b21hdGljIG1lbW9yeSBjbGVhbnVwXG5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gIGNsZWFudXBPbGRRdWVyaWVzKCk7XG59LCBNRU1PUllfQ0xFQU5VUF9JTlRFUlZBTCk7XG4iXSwidmVyc2lvbiI6M30=