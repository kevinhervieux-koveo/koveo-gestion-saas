f1bd932e75e91202daad1d95056452e2
'use strict';
var buttons = require('./buttons.js');
var device = require('./device.js');
var mouse = require('./mouse.js');
var pointer = require('./pointer.js');
function _define_property(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    }
    else {
        obj[key] = value;
    }
    return obj;
}
class PointerHost {
    isKeyPressed(keyDef) {
        return this.devices.get(keyDef.pointerType).isPressed(keyDef);
    }
    async press(instance, keyDef, position) {
        this.devices.get(keyDef.pointerType).addPressed(keyDef);
        this.buttons.down(keyDef);
        const pointerName = this.getPointerName(keyDef);
        const pointer = keyDef.pointerType === 'touch' ? this.pointers.new(pointerName, keyDef.pointerType, this.buttons) : this.pointers.get(pointerName);
        // TODO: deprecate the following implicit setting of position
        pointer.position = position;
        if (pointer.pointerType !== 'touch') {
            this.mouse.position = position;
        }
        if (pointer.pointerType === 'touch') {
            pointer.init(instance);
        }
        pointer.down(instance, keyDef.button);
        if (pointer.pointerType !== 'touch') {
            this.mouse.down(instance, keyDef, pointer.isPrevented);
        }
    }
    async move(instance, pointerName, position) {
        const pointer = this.pointers.get(pointerName);
        // In (some?) browsers this order of events can be observed.
        // This interweaving of events is probably unnecessary.
        // While the order of mouse (or pointer) events is defined per spec,
        // the order in which they interweave/follow on a user interaction depends on the implementation.
        const pointermove = pointer.move(instance, position);
        const mousemove = pointer.pointerType === 'touch' ? undefined : this.mouse.move(instance, position, pointer.isPrevented);
        pointermove === null || pointermove === undefined ? undefined : pointermove.leave();
        mousemove === null || mousemove === undefined ? undefined : mousemove.leave();
        pointermove === null || pointermove === undefined ? undefined : pointermove.enter();
        mousemove === null || mousemove === undefined ? undefined : mousemove.enter();
        pointermove === null || pointermove === undefined ? undefined : pointermove.move();
        mousemove === null || mousemove === undefined ? undefined : mousemove.move();
    }
    async release(instance, keyDef, position) {
        const device = this.devices.get(keyDef.pointerType);
        device.removePressed(keyDef);
        this.buttons.up(keyDef);
        const pointer = this.pointers.get(this.getPointerName(keyDef));
        const isPrevented = pointer.isPrevented;
        // TODO: deprecate the following implicit setting of position
        pointer.position = position;
        if (pointer.pointerType !== 'touch') {
            this.mouse.position = position;
        }
        if (device.countPressed === 0) {
            pointer.up(instance, keyDef.button);
        }
        if (pointer.pointerType === 'touch') {
            pointer.release(instance);
        }
        if (pointer.pointerType === 'touch' && !pointer.isMultitouch) {
            const mousemove = this.mouse.move(instance, position, isPrevented);
            mousemove === null || mousemove === undefined ? undefined : mousemove.leave();
            mousemove === null || mousemove === undefined ? undefined : mousemove.enter();
            mousemove === null || mousemove === undefined ? undefined : mousemove.move();
            this.mouse.down(instance, keyDef, isPrevented);
        }
        if (!pointer.isMultitouch) {
            const mousemove = this.mouse.move(instance, position, isPrevented);
            mousemove === null || mousemove === undefined ? undefined : mousemove.leave();
            mousemove === null || mousemove === undefined ? undefined : mousemove.enter();
            mousemove === null || mousemove === undefined ? undefined : mousemove.move();
            this.mouse.up(instance, keyDef, isPrevented);
        }
    }
    getPointerName(keyDef) {
        return keyDef.pointerType === 'touch' ? keyDef.name : keyDef.pointerType;
    }
    getPreviousPosition(pointerName) {
        return this.pointers.has(pointerName) ? this.pointers.get(pointerName).position : undefined;
    }
    resetClickCount() {
        this.mouse.resetClickCount();
    }
    getMouseTarget(instance) {
        var _this_mouse_position_target;
        return (_this_mouse_position_target = this.mouse.position.target) !== null && _this_mouse_position_target !== undefined ? _this_mouse_position_target : instance.config.document.body;
    }
    setMousePosition(position) {
        this.mouse.position = position;
        this.pointers.get('mouse').position = position;
    }
    constructor(system) {
        _define_property(this, "system", undefined);
        _define_property(this, "mouse", undefined);
        _define_property(this, "buttons", undefined);
        _define_property(this, "devices", new class {
            get(k) {
                var _this_registry, _k;
                var _;
                return (_ = (_this_registry = this.registry)[_k = k]) !== null && _ !== undefined ? _ : _this_registry[_k] = new device.Device();
            }
            constructor() {
                _define_property(this, "registry", {});
            }
        }());
        _define_property(this, "pointers", new class {
            new(pointerName, pointerType, buttons) {
                const isPrimary = pointerType !== 'touch' || !Object.values(this.registry).some((p) => p.pointerType === 'touch' && !p.isCancelled);
                if (!isPrimary) {
                    Object.values(this.registry).forEach((p) => {
                        if (p.pointerType === pointerType && !p.isCancelled) {
                            p.isMultitouch = true;
                        }
                    });
                }
                this.registry[pointerName] = new pointer.Pointer({
                    pointerId: this.nextId++,
                    pointerType,
                    isPrimary
                }, buttons);
                return this.registry[pointerName];
            }
            get(pointerName) {
                if (!this.has(pointerName)) {
                    throw new Error(`Trying to access pointer "${pointerName}" which does not exist.`);
                }
                return this.registry[pointerName];
            }
            has(pointerName) {
                return pointerName in this.registry;
            }
            constructor() {
                _define_property(this, "registry", {});
                _define_property(this, "nextId", 1);
            }
        }());
        this.system = system;
        this.buttons = new buttons.Buttons();
        this.mouse = new mouse.Mouse();
        this.pointers.new('mouse', 'mouse', this.buttons);
    }
}
exports.PointerHost = PointerHost;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9wb2ludGVyL2luZGV4LmpzIiwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN0QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDcEMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ2xDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV0QyxTQUFTLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSztJQUNyQyxJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNiLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUM1QixLQUFLLEVBQUUsS0FBSztZQUNaLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLFFBQVEsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztJQUNQLENBQUM7U0FBTSxDQUFDO1FBQ0osR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDO0FBQ0QsTUFBTSxXQUFXO0lBQ2IsWUFBWSxDQUFDLE1BQU07UUFDZixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUNELEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRO1FBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsV0FBVyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNuSiw2REFBNkQ7UUFDN0QsT0FBTyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDNUIsSUFBSSxPQUFPLENBQUMsV0FBVyxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUNuQyxDQUFDO1FBQ0QsSUFBSSxPQUFPLENBQUMsV0FBVyxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQ2xDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0IsQ0FBQztRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QyxJQUFJLE9BQU8sQ0FBQyxXQUFXLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0QsQ0FBQztJQUNMLENBQUM7SUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsUUFBUTtRQUN0QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMvQyw0REFBNEQ7UUFDNUQsdURBQXVEO1FBQ3ZELG9FQUFvRTtRQUNwRSxpR0FBaUc7UUFDakcsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDckQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFdBQVcsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekgsV0FBVyxLQUFLLElBQUksSUFBSSxXQUFXLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwRixTQUFTLEtBQUssSUFBSSxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlFLFdBQVcsS0FBSyxJQUFJLElBQUksV0FBVyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDcEYsU0FBUyxLQUFLLElBQUksSUFBSSxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5RSxXQUFXLEtBQUssSUFBSSxJQUFJLFdBQVcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25GLFNBQVMsS0FBSyxJQUFJLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDakYsQ0FBQztJQUNELEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUMvRCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBQ3hDLDZEQUE2RDtRQUM3RCxPQUFPLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUM1QixJQUFJLE9BQU8sQ0FBQyxXQUFXLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ25DLENBQUM7UUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDNUIsT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLENBQUM7UUFDRCxJQUFJLE9BQU8sQ0FBQyxXQUFXLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDbEMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBQ0QsSUFBSSxPQUFPLENBQUMsV0FBVyxLQUFLLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMzRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ25FLFNBQVMsS0FBSyxJQUFJLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUUsU0FBUyxLQUFLLElBQUksSUFBSSxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM5RSxTQUFTLEtBQUssSUFBSSxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzdFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDbkQsQ0FBQztRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDeEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNuRSxTQUFTLEtBQUssSUFBSSxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzlFLFNBQVMsS0FBSyxJQUFJLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUUsU0FBUyxLQUFLLElBQUksSUFBSSxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM3RSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDTCxDQUFDO0lBQ0QsY0FBYyxDQUFDLE1BQU07UUFDakIsT0FBTyxNQUFNLENBQUMsV0FBVyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztJQUM3RSxDQUFDO0lBQ0QsbUJBQW1CLENBQUMsV0FBVztRQUMzQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoRyxDQUFDO0lBQ0QsZUFBZTtRQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUNELGNBQWMsQ0FBQyxRQUFRO1FBQ25CLElBQUksMkJBQTJCLENBQUM7UUFDaEMsT0FBTyxDQUFDLDJCQUEyQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSwyQkFBMkIsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLDJCQUEyQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7SUFDMUwsQ0FBQztJQUNELGdCQUFnQixDQUFDLFFBQVE7UUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDbkQsQ0FBQztJQUNELFlBQVksTUFBTTtRQUNkLGdCQUFnQixDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDNUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMzQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLGdCQUFnQixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSTtZQUNsQyxHQUFHLENBQUMsQ0FBQztnQkFDRCxJQUFJLGNBQWMsRUFBRSxFQUFFLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxDQUFDO2dCQUNOLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNySSxDQUFDO1lBQ0Q7Z0JBQ0ksZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzQyxDQUFDO1NBQ0osRUFBRSxDQUFDLENBQUM7UUFDTCxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLElBQUk7WUFDbkMsR0FBRyxDQUFDLFdBQVcsRUFBRSxXQUFXLEVBQUUsT0FBTztnQkFDakMsTUFBTSxTQUFTLEdBQUcsV0FBVyxLQUFLLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLENBQUEsQ0FBQyxDQUFDLFdBQVcsS0FBSyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ2xJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztvQkFDYixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUMsRUFBRTt3QkFDdEMsSUFBSSxDQUFDLENBQUMsV0FBVyxLQUFLLFdBQVcsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQzs0QkFDbEQsQ0FBQyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7d0JBQzFCLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQztnQkFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQztvQkFDN0MsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQ3hCLFdBQVc7b0JBQ1gsU0FBUztpQkFDWixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUNaLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN0QyxDQUFDO1lBQ0QsR0FBRyxDQUFDLFdBQVc7Z0JBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztvQkFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsV0FBVyx5QkFBeUIsQ0FBQyxDQUFDO2dCQUN2RixDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN0QyxDQUFDO1lBQ0QsR0FBRyxDQUFDLFdBQVc7Z0JBQ1gsT0FBTyxXQUFXLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUN4QyxDQUFDO1lBQ0Q7Z0JBQ0ksZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDdkMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN4QyxDQUFDO1NBQ0osRUFBRSxDQUFDLENBQUM7UUFDTCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEQsQ0FBQztDQUNKO0FBRUQsT0FBTyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9wb2ludGVyL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGJ1dHRvbnMgPSByZXF1aXJlKCcuL2J1dHRvbnMuanMnKTtcbnZhciBkZXZpY2UgPSByZXF1aXJlKCcuL2RldmljZS5qcycpO1xudmFyIG1vdXNlID0gcmVxdWlyZSgnLi9tb3VzZS5qcycpO1xudmFyIHBvaW50ZXIgPSByZXF1aXJlKCcuL3BvaW50ZXIuanMnKTtcblxuZnVuY3Rpb24gX2RlZmluZV9wcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5IGluIG9iaikge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHtcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBvYmpba2V5XSA9IHZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuY2xhc3MgUG9pbnRlckhvc3Qge1xuICAgIGlzS2V5UHJlc3NlZChrZXlEZWYpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV2aWNlcy5nZXQoa2V5RGVmLnBvaW50ZXJUeXBlKS5pc1ByZXNzZWQoa2V5RGVmKTtcbiAgICB9XG4gICAgYXN5bmMgcHJlc3MoaW5zdGFuY2UsIGtleURlZiwgcG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5kZXZpY2VzLmdldChrZXlEZWYucG9pbnRlclR5cGUpLmFkZFByZXNzZWQoa2V5RGVmKTtcbiAgICAgICAgdGhpcy5idXR0b25zLmRvd24oa2V5RGVmKTtcbiAgICAgICAgY29uc3QgcG9pbnRlck5hbWUgPSB0aGlzLmdldFBvaW50ZXJOYW1lKGtleURlZik7XG4gICAgICAgIGNvbnN0IHBvaW50ZXIgPSBrZXlEZWYucG9pbnRlclR5cGUgPT09ICd0b3VjaCcgPyB0aGlzLnBvaW50ZXJzLm5ldyhwb2ludGVyTmFtZSwga2V5RGVmLnBvaW50ZXJUeXBlLCB0aGlzLmJ1dHRvbnMpIDogdGhpcy5wb2ludGVycy5nZXQocG9pbnRlck5hbWUpO1xuICAgICAgICAvLyBUT0RPOiBkZXByZWNhdGUgdGhlIGZvbGxvd2luZyBpbXBsaWNpdCBzZXR0aW5nIG9mIHBvc2l0aW9uXG4gICAgICAgIHBvaW50ZXIucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICAgICAgaWYgKHBvaW50ZXIucG9pbnRlclR5cGUgIT09ICd0b3VjaCcpIHtcbiAgICAgICAgICAgIHRoaXMubW91c2UucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocG9pbnRlci5wb2ludGVyVHlwZSA9PT0gJ3RvdWNoJykge1xuICAgICAgICAgICAgcG9pbnRlci5pbml0KGluc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgICBwb2ludGVyLmRvd24oaW5zdGFuY2UsIGtleURlZi5idXR0b24pO1xuICAgICAgICBpZiAocG9pbnRlci5wb2ludGVyVHlwZSAhPT0gJ3RvdWNoJykge1xuICAgICAgICAgICAgdGhpcy5tb3VzZS5kb3duKGluc3RhbmNlLCBrZXlEZWYsIHBvaW50ZXIuaXNQcmV2ZW50ZWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGFzeW5jIG1vdmUoaW5zdGFuY2UsIHBvaW50ZXJOYW1lLCBwb3NpdGlvbikge1xuICAgICAgICBjb25zdCBwb2ludGVyID0gdGhpcy5wb2ludGVycy5nZXQocG9pbnRlck5hbWUpO1xuICAgICAgICAvLyBJbiAoc29tZT8pIGJyb3dzZXJzIHRoaXMgb3JkZXIgb2YgZXZlbnRzIGNhbiBiZSBvYnNlcnZlZC5cbiAgICAgICAgLy8gVGhpcyBpbnRlcndlYXZpbmcgb2YgZXZlbnRzIGlzIHByb2JhYmx5IHVubmVjZXNzYXJ5LlxuICAgICAgICAvLyBXaGlsZSB0aGUgb3JkZXIgb2YgbW91c2UgKG9yIHBvaW50ZXIpIGV2ZW50cyBpcyBkZWZpbmVkIHBlciBzcGVjLFxuICAgICAgICAvLyB0aGUgb3JkZXIgaW4gd2hpY2ggdGhleSBpbnRlcndlYXZlL2ZvbGxvdyBvbiBhIHVzZXIgaW50ZXJhY3Rpb24gZGVwZW5kcyBvbiB0aGUgaW1wbGVtZW50YXRpb24uXG4gICAgICAgIGNvbnN0IHBvaW50ZXJtb3ZlID0gcG9pbnRlci5tb3ZlKGluc3RhbmNlLCBwb3NpdGlvbik7XG4gICAgICAgIGNvbnN0IG1vdXNlbW92ZSA9IHBvaW50ZXIucG9pbnRlclR5cGUgPT09ICd0b3VjaCcgPyB1bmRlZmluZWQgOiB0aGlzLm1vdXNlLm1vdmUoaW5zdGFuY2UsIHBvc2l0aW9uLCBwb2ludGVyLmlzUHJldmVudGVkKTtcbiAgICAgICAgcG9pbnRlcm1vdmUgPT09IG51bGwgfHwgcG9pbnRlcm1vdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHBvaW50ZXJtb3ZlLmxlYXZlKCk7XG4gICAgICAgIG1vdXNlbW92ZSA9PT0gbnVsbCB8fCBtb3VzZW1vdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG1vdXNlbW92ZS5sZWF2ZSgpO1xuICAgICAgICBwb2ludGVybW92ZSA9PT0gbnVsbCB8fCBwb2ludGVybW92ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogcG9pbnRlcm1vdmUuZW50ZXIoKTtcbiAgICAgICAgbW91c2Vtb3ZlID09PSBudWxsIHx8IG1vdXNlbW92ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogbW91c2Vtb3ZlLmVudGVyKCk7XG4gICAgICAgIHBvaW50ZXJtb3ZlID09PSBudWxsIHx8IHBvaW50ZXJtb3ZlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBwb2ludGVybW92ZS5tb3ZlKCk7XG4gICAgICAgIG1vdXNlbW92ZSA9PT0gbnVsbCB8fCBtb3VzZW1vdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG1vdXNlbW92ZS5tb3ZlKCk7XG4gICAgfVxuICAgIGFzeW5jIHJlbGVhc2UoaW5zdGFuY2UsIGtleURlZiwgcG9zaXRpb24pIHtcbiAgICAgICAgY29uc3QgZGV2aWNlID0gdGhpcy5kZXZpY2VzLmdldChrZXlEZWYucG9pbnRlclR5cGUpO1xuICAgICAgICBkZXZpY2UucmVtb3ZlUHJlc3NlZChrZXlEZWYpO1xuICAgICAgICB0aGlzLmJ1dHRvbnMudXAoa2V5RGVmKTtcbiAgICAgICAgY29uc3QgcG9pbnRlciA9IHRoaXMucG9pbnRlcnMuZ2V0KHRoaXMuZ2V0UG9pbnRlck5hbWUoa2V5RGVmKSk7XG4gICAgICAgIGNvbnN0IGlzUHJldmVudGVkID0gcG9pbnRlci5pc1ByZXZlbnRlZDtcbiAgICAgICAgLy8gVE9ETzogZGVwcmVjYXRlIHRoZSBmb2xsb3dpbmcgaW1wbGljaXQgc2V0dGluZyBvZiBwb3NpdGlvblxuICAgICAgICBwb2ludGVyLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgIGlmIChwb2ludGVyLnBvaW50ZXJUeXBlICE9PSAndG91Y2gnKSB7XG4gICAgICAgICAgICB0aGlzLm1vdXNlLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRldmljZS5jb3VudFByZXNzZWQgPT09IDApIHtcbiAgICAgICAgICAgIHBvaW50ZXIudXAoaW5zdGFuY2UsIGtleURlZi5idXR0b24pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb2ludGVyLnBvaW50ZXJUeXBlID09PSAndG91Y2gnKSB7XG4gICAgICAgICAgICBwb2ludGVyLnJlbGVhc2UoaW5zdGFuY2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb2ludGVyLnBvaW50ZXJUeXBlID09PSAndG91Y2gnICYmICFwb2ludGVyLmlzTXVsdGl0b3VjaCkge1xuICAgICAgICAgICAgY29uc3QgbW91c2Vtb3ZlID0gdGhpcy5tb3VzZS5tb3ZlKGluc3RhbmNlLCBwb3NpdGlvbiwgaXNQcmV2ZW50ZWQpO1xuICAgICAgICAgICAgbW91c2Vtb3ZlID09PSBudWxsIHx8IG1vdXNlbW92ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogbW91c2Vtb3ZlLmxlYXZlKCk7XG4gICAgICAgICAgICBtb3VzZW1vdmUgPT09IG51bGwgfHwgbW91c2Vtb3ZlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBtb3VzZW1vdmUuZW50ZXIoKTtcbiAgICAgICAgICAgIG1vdXNlbW92ZSA9PT0gbnVsbCB8fCBtb3VzZW1vdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG1vdXNlbW92ZS5tb3ZlKCk7XG4gICAgICAgICAgICB0aGlzLm1vdXNlLmRvd24oaW5zdGFuY2UsIGtleURlZiwgaXNQcmV2ZW50ZWQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghcG9pbnRlci5pc011bHRpdG91Y2gpIHtcbiAgICAgICAgICAgIGNvbnN0IG1vdXNlbW92ZSA9IHRoaXMubW91c2UubW92ZShpbnN0YW5jZSwgcG9zaXRpb24sIGlzUHJldmVudGVkKTtcbiAgICAgICAgICAgIG1vdXNlbW92ZSA9PT0gbnVsbCB8fCBtb3VzZW1vdmUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG1vdXNlbW92ZS5sZWF2ZSgpO1xuICAgICAgICAgICAgbW91c2Vtb3ZlID09PSBudWxsIHx8IG1vdXNlbW92ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogbW91c2Vtb3ZlLmVudGVyKCk7XG4gICAgICAgICAgICBtb3VzZW1vdmUgPT09IG51bGwgfHwgbW91c2Vtb3ZlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBtb3VzZW1vdmUubW92ZSgpO1xuICAgICAgICAgICAgdGhpcy5tb3VzZS51cChpbnN0YW5jZSwga2V5RGVmLCBpc1ByZXZlbnRlZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0UG9pbnRlck5hbWUoa2V5RGVmKSB7XG4gICAgICAgIHJldHVybiBrZXlEZWYucG9pbnRlclR5cGUgPT09ICd0b3VjaCcgPyBrZXlEZWYubmFtZSA6IGtleURlZi5wb2ludGVyVHlwZTtcbiAgICB9XG4gICAgZ2V0UHJldmlvdXNQb3NpdGlvbihwb2ludGVyTmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVycy5oYXMocG9pbnRlck5hbWUpID8gdGhpcy5wb2ludGVycy5nZXQocG9pbnRlck5hbWUpLnBvc2l0aW9uIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXNldENsaWNrQ291bnQoKSB7XG4gICAgICAgIHRoaXMubW91c2UucmVzZXRDbGlja0NvdW50KCk7XG4gICAgfVxuICAgIGdldE1vdXNlVGFyZ2V0KGluc3RhbmNlKSB7XG4gICAgICAgIHZhciBfdGhpc19tb3VzZV9wb3NpdGlvbl90YXJnZXQ7XG4gICAgICAgIHJldHVybiAoX3RoaXNfbW91c2VfcG9zaXRpb25fdGFyZ2V0ID0gdGhpcy5tb3VzZS5wb3NpdGlvbi50YXJnZXQpICE9PSBudWxsICYmIF90aGlzX21vdXNlX3Bvc2l0aW9uX3RhcmdldCAhPT0gdW5kZWZpbmVkID8gX3RoaXNfbW91c2VfcG9zaXRpb25fdGFyZ2V0IDogaW5zdGFuY2UuY29uZmlnLmRvY3VtZW50LmJvZHk7XG4gICAgfVxuICAgIHNldE1vdXNlUG9zaXRpb24ocG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy5tb3VzZS5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICB0aGlzLnBvaW50ZXJzLmdldCgnbW91c2UnKS5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgIH1cbiAgICBjb25zdHJ1Y3RvcihzeXN0ZW0pe1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwic3lzdGVtXCIsIHVuZGVmaW5lZCk7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJtb3VzZVwiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiYnV0dG9uc1wiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiZGV2aWNlc1wiLCBuZXcgY2xhc3Mge1xuICAgICAgICAgICAgZ2V0KGspIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXNfcmVnaXN0cnksIF9rO1xuICAgICAgICAgICAgICAgIHZhciBfO1xuICAgICAgICAgICAgICAgIHJldHVybiAoXyA9IChfdGhpc19yZWdpc3RyeSA9IHRoaXMucmVnaXN0cnkpW19rID0ga10pICE9PSBudWxsICYmIF8gIT09IHVuZGVmaW5lZCA/IF8gOiBfdGhpc19yZWdpc3RyeVtfa10gPSBuZXcgZGV2aWNlLkRldmljZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3RydWN0b3IoKXtcbiAgICAgICAgICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwicmVnaXN0cnlcIiwge30pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KCkpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwicG9pbnRlcnNcIiwgbmV3IGNsYXNzIHtcbiAgICAgICAgICAgIG5ldyhwb2ludGVyTmFtZSwgcG9pbnRlclR5cGUsIGJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc1ByaW1hcnkgPSBwb2ludGVyVHlwZSAhPT0gJ3RvdWNoJyB8fCAhT2JqZWN0LnZhbHVlcyh0aGlzLnJlZ2lzdHJ5KS5zb21lKChwKT0+cC5wb2ludGVyVHlwZSA9PT0gJ3RvdWNoJyAmJiAhcC5pc0NhbmNlbGxlZCk7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1ByaW1hcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLnJlZ2lzdHJ5KS5mb3JFYWNoKChwKT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucG9pbnRlclR5cGUgPT09IHBvaW50ZXJUeXBlICYmICFwLmlzQ2FuY2VsbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5pc011bHRpdG91Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtwb2ludGVyTmFtZV0gPSBuZXcgcG9pbnRlci5Qb2ludGVyKHtcbiAgICAgICAgICAgICAgICAgICAgcG9pbnRlcklkOiB0aGlzLm5leHRJZCsrLFxuICAgICAgICAgICAgICAgICAgICBwb2ludGVyVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgaXNQcmltYXJ5XG4gICAgICAgICAgICAgICAgfSwgYnV0dG9ucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVnaXN0cnlbcG9pbnRlck5hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZ2V0KHBvaW50ZXJOYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhcyhwb2ludGVyTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gYWNjZXNzIHBvaW50ZXIgXCIke3BvaW50ZXJOYW1lfVwiIHdoaWNoIGRvZXMgbm90IGV4aXN0LmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZWdpc3RyeVtwb2ludGVyTmFtZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBoYXMocG9pbnRlck5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcG9pbnRlck5hbWUgaW4gdGhpcy5yZWdpc3RyeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0cnVjdG9yKCl7XG4gICAgICAgICAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcInJlZ2lzdHJ5XCIsIHt9KTtcbiAgICAgICAgICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwibmV4dElkXCIsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KCkpO1xuICAgICAgICB0aGlzLnN5c3RlbSA9IHN5c3RlbTtcbiAgICAgICAgdGhpcy5idXR0b25zID0gbmV3IGJ1dHRvbnMuQnV0dG9ucygpO1xuICAgICAgICB0aGlzLm1vdXNlID0gbmV3IG1vdXNlLk1vdXNlKCk7XG4gICAgICAgIHRoaXMucG9pbnRlcnMubmV3KCdtb3VzZScsICdtb3VzZScsIHRoaXMuYnV0dG9ucyk7XG4gICAgfVxufVxuXG5leHBvcnRzLlBvaW50ZXJIb3N0ID0gUG9pbnRlckhvc3Q7XG4iXSwidmVyc2lvbiI6M30=