6de068bd634aaed4343c7cefb22a3c8f
"use strict";
/**
 * Login Functionality Test with Real User Credentials
 * Tests login system with actual user account
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const express_1 = __importDefault(require("express"));
const supertest_1 = __importDefault(require("supertest"));
const routes_1 = require("../../server/routes");
const db_1 = require("../../server/db");
const schema = __importStar(require("../../shared/schema"));
const drizzle_orm_1 = require("drizzle-orm");
const bcryptjs_1 = __importDefault(require("bcryptjs"));
// Create test server
const createTestApp = () => {
    const app = (0, express_1.default)();
    app.use(express_1.default.json());
    app.use(express_1.default.urlencoded({ extended: true }));
    (0, routes_1.registerRoutes)(app);
    return app;
};
(0, globals_1.describe)('Login Functionality with Real User', () => {
    let app;
    let testUser;
    (0, globals_1.beforeAll)(async () => {
        app = createTestApp();
        // Find existing user or create if needed
        try {
            const [existingUser] = await db_1.db
                .select()
                .from(schema.users)
                .where((0, drizzle_orm_1.eq)(schema.users.email, 'kevin.hervieux@koveo-gestion.com'))
                .limit(1);
            if (existingUser) {
                testUser = existingUser;
                console.log('âœ… Using existing test user:', { id: existingUser.id, email: existingUser.email, role: existingUser.role });
            }
            else {
                // Create new user only if it doesn't exist
                const hashedPassword = await bcryptjs_1.default.hash('admin123', 12);
                const [user] = await db_1.db
                    .insert(schema.users)
                    .values({
                    email: 'kevin.hervieux@koveo-gestion.com',
                    username: 'kevin.hervieux',
                    firstName: 'Kevin',
                    lastName: 'Hervieux',
                    role: 'admin',
                    password: hashedPassword,
                    language: 'fr',
                    isActive: true,
                })
                    .returning();
                testUser = user;
                console.log('âœ… New test user created:', { id: user.id, email: user.email, role: user.role });
            }
        }
        catch (error) {
            console.error('âŒ Error handling test user:', error);
            throw error;
        }
    });
    (0, globals_1.afterAll)(async () => {
        // Keep the user in database for actual login testing
        console.log('ðŸ“ Test user kept in database for real login functionality');
    });
    (0, globals_1.describe)('Real User Login Tests', () => {
        (0, globals_1.it)('should successfully login with valid credentials', async () => {
            const loginData = {
                email: 'kevin.hervieux@koveo-gestion.com',
                password: 'admin123',
            };
            const response = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData)
                .expect(200);
            (0, globals_1.expect)(response.body.message).toBe('Login successful');
            (0, globals_1.expect)(response.body.user).toBeDefined();
            (0, globals_1.expect)(response.body.user.email).toBe('kevin.hervieux@koveo-gestion.com');
            (0, globals_1.expect)(response.body.user.role).toBe('admin');
            // Verify session cookie is set
            (0, globals_1.expect)(response.headers['set-cookie']).toBeDefined();
            const cookie = response.headers['set-cookie'][0];
            (0, globals_1.expect)(cookie).toMatch(/koveo\.sid/);
        });
        (0, globals_1.it)('should fail login with wrong password', async () => {
            const loginData = {
                email: 'kevin.hervieux@koveo-gestion.com',
                password: 'wrongpassword',
            };
            const response = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData)
                .expect(401);
            (0, globals_1.expect)(response.body.message).toMatch(/invalid.*credentials/i);
        });
        (0, globals_1.it)('should fail login with wrong email', async () => {
            const loginData = {
                email: 'wrong@email.com',
                password: 'admin123',
            };
            const response = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData)
                .expect(401);
            (0, globals_1.expect)(response.body.message).toMatch(/invalid.*credentials/i);
        });
        (0, globals_1.it)('should check user session after login', async () => {
            // First login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: 'kevin.hervieux@koveo-gestion.com',
                password: 'admin123',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            // Check auth status with session
            const authResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', cookies)
                .expect(200);
            (0, globals_1.expect)(authResponse.body.email).toBe('kevin.hervieux@koveo-gestion.com');
            (0, globals_1.expect)(authResponse.body.role).toBe('admin');
        });
        (0, globals_1.it)('should logout and clear session', async () => {
            // First login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: 'kevin.hervieux@koveo-gestion.com',
                password: 'admin123',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            // Logout
            const logoutResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/logout')
                .set('Cookie', cookies)
                .expect(200);
            (0, globals_1.expect)(logoutResponse.body.message).toMatch(/logout.*success/i);
            // Try to access protected endpoint after logout
            const protectedResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', cookies);
            (0, globals_1.expect)(protectedResponse.status).toBe(401);
        });
    });
    (0, globals_1.describe)('Session Management', () => {
        (0, globals_1.it)('should handle multiple concurrent login attempts', async () => {
            const loginData = {
                email: 'kevin.hervieux@koveo-gestion.com',
                password: 'admin123',
            };
            // Create multiple simultaneous login requests
            const loginPromises = Array(3).fill(null).map(() => (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData));
            const responses = await Promise.all(loginPromises);
            // All should succeed and get unique sessions
            responses.forEach(response => {
                (0, globals_1.expect)(response.status).toBe(200);
                (0, globals_1.expect)(response.headers['set-cookie']).toBeDefined();
            });
            // Verify each got a different session
            const sessionIds = responses.map(r => r.headers['set-cookie'][0]);
            const uniqueSessions = new Set(sessionIds);
            (0, globals_1.expect)(uniqueSessions.size).toBe(3);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9pbnRlZ3JhdGlvbi9sb2dpbi1mdW5jdGlvbmFsaXR5LnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSCwyQ0FBMEU7QUFDMUUsc0RBQThCO0FBQzlCLDBEQUFnQztBQUNoQyxnREFBcUQ7QUFDckQsd0NBQXFDO0FBQ3JDLDREQUE4QztBQUM5Qyw2Q0FBaUM7QUFDakMsd0RBQThCO0FBRTlCLHFCQUFxQjtBQUNyQixNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUU7SUFDekIsTUFBTSxHQUFHLEdBQUcsSUFBQSxpQkFBTyxHQUFFLENBQUM7SUFDdEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDeEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEQsSUFBQSx1QkFBYyxFQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBRUYsSUFBQSxrQkFBUSxFQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtJQUNsRCxJQUFJLEdBQXdCLENBQUM7SUFDN0IsSUFBSSxRQUFhLENBQUM7SUFFbEIsSUFBQSxtQkFBUyxFQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLEdBQUcsR0FBRyxhQUFhLEVBQUUsQ0FBQztRQUV0Qix5Q0FBeUM7UUFDekMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sT0FBRTtpQkFDNUIsTUFBTSxFQUFFO2lCQUNSLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2lCQUNsQixLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLGtDQUFrQyxDQUFDLENB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LENBQ25CLENBQUM7WUFFRixNQUFNLFNBQVMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFbkQsNkNBQTZDO1lBQzdDLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzNCLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQyxJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3ZELENBQUMsQ0FBQyxDQUFDO1lBRUgsc0NBQXNDO1lBQ3RDLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDM0MsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2UvdGVzdHMvaW50ZWdyYXRpb24vbG9naW4tZnVuY3Rpb25hbGl0eS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTG9naW4gRnVuY3Rpb25hbGl0eSBUZXN0IHdpdGggUmVhbCBVc2VyIENyZWRlbnRpYWxzXG4gKiBUZXN0cyBsb2dpbiBzeXN0ZW0gd2l0aCBhY3R1YWwgdXNlciBhY2NvdW50XG4gKi9cblxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUFsbCwgYWZ0ZXJBbGwgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcbmltcG9ydCB7IHJlZ2lzdGVyUm91dGVzIH0gZnJvbSAnLi4vLi4vc2VydmVyL3JvdXRlcyc7XG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uLy4uL3NlcnZlci9kYic7XG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnLi4vLi4vc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyBlcSB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuXG4vLyBDcmVhdGUgdGVzdCBzZXJ2ZXJcbmNvbnN0IGNyZWF0ZVRlc3RBcHAgPSAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbiAgYXBwLnVzZShleHByZXNzLmpzb24oKSk7XG4gIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xuICByZWdpc3RlclJvdXRlcyhhcHApO1xuICByZXR1cm4gYXBwO1xufTtcblxuZGVzY3JpYmUoJ0xvZ2luIEZ1bmN0aW9uYWxpdHkgd2l0aCBSZWFsIFVzZXInLCAoKSA9PiB7XG4gIGxldCBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XG4gIGxldCB0ZXN0VXNlcjogYW55O1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgYXBwID0gY3JlYXRlVGVzdEFwcCgpO1xuXG4gICAgLy8gRmluZCBleGlzdGluZyB1c2VyIG9yIGNyZWF0ZSBpZiBuZWVkZWRcbiAgICB0cnkge1xuICAgICAgY29uc3QgW2V4aXN0aW5nVXNlcl0gPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgLmZyb20oc2NoZW1hLnVzZXJzKVxuICAgICAgICAud2hlcmUoZXEoc2NoZW1hLnVzZXJzLmVtYWlsLCAna2V2aW4uaGVydmlldXhAa292ZW8tZ2VzdGlvbi5jb20nKSlcbiAgICAgICAgLmxpbWl0KDEpO1xuICAgICAgXG4gICAgICBpZiAoZXhpc3RpbmdVc2VyKSB7XG4gICAgICAgIHRlc3RVc2VyID0gZXhpc3RpbmdVc2VyO1xuICAgICAgICBjb25zb2xlLmxvZygn4pyFIFVzaW5nIGV4aXN0aW5nIHRlc3QgdXNlcjonLCB7IGlkOiBleGlzdGluZ1VzZXIuaWQsIGVtYWlsOiBleGlzdGluZ1VzZXIuZW1haWwsIHJvbGU6IGV4aXN0aW5nVXNlci5yb2xlIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQ3JlYXRlIG5ldyB1c2VyIG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKCdhZG1pbjEyMycsIDEyKTtcbiAgICAgICAgY29uc3QgW3VzZXJdID0gYXdhaXQgZGJcbiAgICAgICAgICAuaW5zZXJ0KHNjaGVtYS51c2VycylcbiAgICAgICAgICAudmFsdWVzKHtcbiAgICAgICAgICAgIGVtYWlsOiAna2V2aW4uaGVydmlldXhAa292ZW8tZ2VzdGlvbi5jb20nLFxuICAgICAgICAgICAgdXNlcm5hbWU6ICdrZXZpbi5oZXJ2aWV1eCcsXG4gICAgICAgICAgICBmaXJzdE5hbWU6ICdLZXZpbicsXG4gICAgICAgICAgICBsYXN0TmFtZTogJ0hlcnZpZXV4JyxcbiAgICAgICAgICAgIHJvbGU6ICdhZG1pbicsXG4gICAgICAgICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICAgICAgICBsYW5ndWFnZTogJ2ZyJyxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLnJldHVybmluZygpO1xuICAgICAgICB0ZXN0VXNlciA9IHVzZXI7XG4gICAgICAgIGNvbnNvbGUubG9nKCfinIUgTmV3IHRlc3QgdXNlciBjcmVhdGVkOicsIHsgaWQ6IHVzZXIuaWQsIGVtYWlsOiB1c2VyLmVtYWlsLCByb2xlOiB1c2VyLnJvbGUgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGhhbmRsaW5nIHRlc3QgdXNlcjonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICAvLyBLZWVwIHRoZSB1c2VyIGluIGRhdGFiYXNlIGZvciBhY3R1YWwgbG9naW4gdGVzdGluZ1xuICAgIGNvbnNvbGUubG9nKCfwn5OdIFRlc3QgdXNlciBrZXB0IGluIGRhdGFiYXNlIGZvciByZWFsIGxvZ2luIGZ1bmN0aW9uYWxpdHknKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1JlYWwgVXNlciBMb2dpbiBUZXN0cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBsb2dpbiB3aXRoIHZhbGlkIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbG9naW5EYXRhID0ge1xuICAgICAgICBlbWFpbDogJ2tldmluLmhlcnZpZXV4QGtvdmVvLWdlc3Rpb24uY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdhZG1pbjEyMycsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgLnNlbmQobG9naW5EYXRhKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lm1lc3NhZ2UpLnRvQmUoJ0xvZ2luIHN1Y2Nlc3NmdWwnKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnVzZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS51c2VyLmVtYWlsKS50b0JlKCdrZXZpbi5oZXJ2aWV1eEBrb3Zlby1nZXN0aW9uLmNvbScpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkudXNlci5yb2xlKS50b0JlKCdhZG1pbicpO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgc2Vzc2lvbiBjb29raWUgaXMgc2V0XG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddKS50b0JlRGVmaW5lZCgpO1xuICAgICAgY29uc3QgY29va2llID0gcmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddWzBdO1xuICAgICAgZXhwZWN0KGNvb2tpZSkudG9NYXRjaCgva292ZW9cXC5zaWQvKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmFpbCBsb2dpbiB3aXRoIHdyb25nIHBhc3N3b3JkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbG9naW5EYXRhID0ge1xuICAgICAgICBlbWFpbDogJ2tldmluLmhlcnZpZXV4QGtvdmVvLWdlc3Rpb24uY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICd3cm9uZ3Bhc3N3b3JkJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZChsb2dpbkRhdGEpXG4gICAgICAgIC5leHBlY3QoNDAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubWVzc2FnZSkudG9NYXRjaCgvaW52YWxpZC4qY3JlZGVudGlhbHMvaSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZhaWwgbG9naW4gd2l0aCB3cm9uZyBlbWFpbCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ2luRGF0YSA9IHtcbiAgICAgICAgZW1haWw6ICd3cm9uZ0BlbWFpbC5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ2FkbWluMTIzJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZChsb2dpbkRhdGEpXG4gICAgICAgIC5leHBlY3QoNDAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubWVzc2FnZSkudG9NYXRjaCgvaW52YWxpZC4qY3JlZGVudGlhbHMvaSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNoZWNrIHVzZXIgc2Vzc2lvbiBhZnRlciBsb2dpbicsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEZpcnN0IGxvZ2luXG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6ICdrZXZpbi5oZXJ2aWV1eEBrb3Zlby1nZXN0aW9uLmNvbScsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhZG1pbjEyMycsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuXG4gICAgICAvLyBDaGVjayBhdXRoIHN0YXR1cyB3aXRoIHNlc3Npb25cbiAgICAgIGNvbnN0IGF1dGhSZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIGNvb2tpZXMpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgZXhwZWN0KGF1dGhSZXNwb25zZS5ib2R5LmVtYWlsKS50b0JlKCdrZXZpbi5oZXJ2aWV1eEBrb3Zlby1nZXN0aW9uLmNvbScpO1xuICAgICAgZXhwZWN0KGF1dGhSZXNwb25zZS5ib2R5LnJvbGUpLnRvQmUoJ2FkbWluJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxvZ291dCBhbmQgY2xlYXIgc2Vzc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEZpcnN0IGxvZ2luXG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6ICdrZXZpbi5oZXJ2aWV1eEBrb3Zlby1nZXN0aW9uLmNvbScsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhZG1pbjEyMycsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuXG4gICAgICAvLyBMb2dvdXRcbiAgICAgIGNvbnN0IGxvZ291dFJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9nb3V0JylcbiAgICAgICAgLnNldCgnQ29va2llJywgY29va2llcylcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QobG9nb3V0UmVzcG9uc2UuYm9keS5tZXNzYWdlKS50b01hdGNoKC9sb2dvdXQuKnN1Y2Nlc3MvaSk7XG5cbiAgICAgIC8vIFRyeSB0byBhY2Nlc3MgcHJvdGVjdGVkIGVuZHBvaW50IGFmdGVyIGxvZ291dFxuICAgICAgY29uc3QgcHJvdGVjdGVkUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBjb29raWVzKTtcblxuICAgICAgZXhwZWN0KHByb3RlY3RlZFJlc3BvbnNlLnN0YXR1cykudG9CZSg0MDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2Vzc2lvbiBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIG11bHRpcGxlIGNvbmN1cnJlbnQgbG9naW4gYXR0ZW1wdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dpbkRhdGEgPSB7XG4gICAgICAgIGVtYWlsOiAna2V2aW4uaGVydmlldXhAa292ZW8tZ2VzdGlvbi5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ2FkbWluMTIzJyxcbiAgICAgIH07XG5cbiAgICAgIC8vIENyZWF0ZSBtdWx0aXBsZSBzaW11bHRhbmVvdXMgbG9naW4gcmVxdWVzdHNcbiAgICAgIGNvbnN0IGxvZ2luUHJvbWlzZXMgPSBBcnJheSgzKS5maWxsKG51bGwpLm1hcCgoKSA9PlxuICAgICAgICByZXF1ZXN0KGFwcClcbiAgICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgICAuc2VuZChsb2dpbkRhdGEpXG4gICAgICApO1xuXG4gICAgICBjb25zdCByZXNwb25zZXMgPSBhd2FpdCBQcm9taXNlLmFsbChsb2dpblByb21pc2VzKTtcbiAgICAgIFxuICAgICAgLy8gQWxsIHNob3VsZCBzdWNjZWVkIGFuZCBnZXQgdW5pcXVlIHNlc3Npb25zXG4gICAgICByZXNwb25zZXMuZm9yRWFjaChyZXNwb25zZSA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXSkudG9CZURlZmluZWQoKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBWZXJpZnkgZWFjaCBnb3QgYSBkaWZmZXJlbnQgc2Vzc2lvblxuICAgICAgY29uc3Qgc2Vzc2lvbklkcyA9IHJlc3BvbnNlcy5tYXAociA9PiByLmhlYWRlcnNbJ3NldC1jb29raWUnXVswXSk7XG4gICAgICBjb25zdCB1bmlxdWVTZXNzaW9ucyA9IG5ldyBTZXQoc2Vzc2lvbklkcyk7XG4gICAgICBleHBlY3QodW5pcXVlU2Vzc2lvbnMuc2l6ZSkudG9CZSgzKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=