e225d08bea98bc78da7e80375fcab7f3
'use strict';
var dom = require('@testing-library/dom');
var isElementType = require('../utils/misc/isElementType.js');
require('../utils/dataTransfer/Clipboard.js');
var isDisabled = require('../utils/misc/isDisabled.js');
var wait = require('../utils/misc/wait.js');
var cssPointerEvents = require('../utils/pointer/cssPointerEvents.js');
require('../event/behavior/click.js');
require('../event/behavior/cut.js');
require('../event/behavior/keydown.js');
require('../event/behavior/keypress.js');
require('../event/behavior/keyup.js');
require('../event/behavior/paste.js');
var focus = require('../event/focus.js');
async function selectOptions(select, values) {
    return selectOptionsBase.call(this, true, select, values);
}
async function deselectOptions(select, values) {
    return selectOptionsBase.call(this, false, select, values);
}
async function selectOptionsBase(newValue, select, values) {
    if (!newValue && !select.multiple) {
        throw dom.getConfig().getElementError(`Unable to deselect an option in a non-multiple select. Use selectOptions to change the selection instead.`, select);
    }
    const valArray = Array.isArray(values) ? values : [
        values
    ];
    const allOptions = Array.from(select.querySelectorAll('option, [role="option"]'));
    const selectedOptions = valArray.map((val) => {
        if (typeof val !== 'string' && allOptions.includes(val)) {
            return val;
        }
        else {
            const matchingOption = allOptions.find((o) => o.value === val || o.innerHTML === val);
            if (matchingOption) {
                return matchingOption;
            }
            else {
                throw dom.getConfig().getElementError(`Value "${String(val)}" not found in options`, select);
            }
        }
    }).filter((option) => !isDisabled.isDisabled(option));
    if (isDisabled.isDisabled(select) || !selectedOptions.length)
        return;
    const selectOption = (option) => {
        option.selected = newValue;
        this.dispatchUIEvent(select, 'input', {
            bubbles: true,
            cancelable: false,
            composed: true
        });
        this.dispatchUIEvent(select, 'change');
    };
    if (isElementType.isElementType(select, 'select')) {
        if (select.multiple) {
            for (const option of selectedOptions) {
                const withPointerEvents = this.config.pointerEventsCheck === 0 ? true : cssPointerEvents.hasPointerEvents(this, option);
                // events fired for multiple select are weird. Can't use hover...
                if (withPointerEvents) {
                    this.dispatchUIEvent(option, 'pointerover');
                    this.dispatchUIEvent(select, 'pointerenter');
                    this.dispatchUIEvent(option, 'mouseover');
                    this.dispatchUIEvent(select, 'mouseenter');
                    this.dispatchUIEvent(option, 'pointermove');
                    this.dispatchUIEvent(option, 'mousemove');
                    this.dispatchUIEvent(option, 'pointerdown');
                    this.dispatchUIEvent(option, 'mousedown');
                }
                focus.focusElement(select);
                if (withPointerEvents) {
                    this.dispatchUIEvent(option, 'pointerup');
                    this.dispatchUIEvent(option, 'mouseup');
                }
                selectOption(option);
                if (withPointerEvents) {
                    this.dispatchUIEvent(option, 'click');
                }
                await wait.wait(this.config);
            }
        }
        else if (selectedOptions.length === 1) {
            const withPointerEvents = this.config.pointerEventsCheck === 0 ? true : cssPointerEvents.hasPointerEvents(this, select);
            // the click to open the select options
            if (withPointerEvents) {
                await this.click(select);
            }
            else {
                focus.focusElement(select);
            }
            selectOption(selectedOptions[0]);
            if (withPointerEvents) {
                // the browser triggers another click event on the select for the click on the option
                // this second click has no 'down' phase
                this.dispatchUIEvent(select, 'pointerover');
                this.dispatchUIEvent(select, 'pointerenter');
                this.dispatchUIEvent(select, 'mouseover');
                this.dispatchUIEvent(select, 'mouseenter');
                this.dispatchUIEvent(select, 'pointerup');
                this.dispatchUIEvent(select, 'mouseup');
                this.dispatchUIEvent(select, 'click');
            }
            await wait.wait(this.config);
        }
        else {
            throw dom.getConfig().getElementError(`Cannot select multiple options on a non-multiple select`, select);
        }
    }
    else if (select.getAttribute('role') === 'listbox') {
        for (const option of selectedOptions) {
            await this.click(option);
            await this.unhover(option);
        }
    }
    else {
        throw dom.getConfig().getElementError(`Cannot select options on elements that are neither select nor listbox elements`, select);
    }
}
exports.deselectOptions = deselectOptions;
exports.selectOptions = selectOptions;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3V0aWxpdHkvc2VsZWN0T3B0aW9ucy5qcyIsIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUM5RCxPQUFPLENBQUMsb0NBQW9DLENBQUMsQ0FBQztBQUM5QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsNkJBQTZCLENBQUMsQ0FBQztBQUN4RCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUM1QyxJQUFJLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3ZFLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3BDLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQ3hDLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ3pDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RDLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRXpDLEtBQUssVUFBVSxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU07SUFDdkMsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDOUQsQ0FBQztBQUNELEtBQUssVUFBVSxlQUFlLENBQUMsTUFBTSxFQUFFLE1BQU07SUFDekMsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENB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QUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixDQUFDO0lBQ0wsQ0FBQztTQUFNLENBQUM7UUFDSixNQUFNLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxlQUFlLENBQUMsZ0ZBQWdGLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDcEksQ0FBQztBQUNMLENBQUM7QUFFRCxPQUFPLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztBQUMxQyxPQUFPLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL25vZGVfbW9kdWxlcy9AdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQvZGlzdC9janMvdXRpbGl0eS9zZWxlY3RPcHRpb25zLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGRvbSA9IHJlcXVpcmUoJ0B0ZXN0aW5nLWxpYnJhcnkvZG9tJyk7XG52YXIgaXNFbGVtZW50VHlwZSA9IHJlcXVpcmUoJy4uL3V0aWxzL21pc2MvaXNFbGVtZW50VHlwZS5qcycpO1xucmVxdWlyZSgnLi4vdXRpbHMvZGF0YVRyYW5zZmVyL0NsaXBib2FyZC5qcycpO1xudmFyIGlzRGlzYWJsZWQgPSByZXF1aXJlKCcuLi91dGlscy9taXNjL2lzRGlzYWJsZWQuanMnKTtcbnZhciB3YWl0ID0gcmVxdWlyZSgnLi4vdXRpbHMvbWlzYy93YWl0LmpzJyk7XG52YXIgY3NzUG9pbnRlckV2ZW50cyA9IHJlcXVpcmUoJy4uL3V0aWxzL3BvaW50ZXIvY3NzUG9pbnRlckV2ZW50cy5qcycpO1xucmVxdWlyZSgnLi4vZXZlbnQvYmVoYXZpb3IvY2xpY2suanMnKTtcbnJlcXVpcmUoJy4uL2V2ZW50L2JlaGF2aW9yL2N1dC5qcycpO1xucmVxdWlyZSgnLi4vZXZlbnQvYmVoYXZpb3Iva2V5ZG93bi5qcycpO1xucmVxdWlyZSgnLi4vZXZlbnQvYmVoYXZpb3Iva2V5cHJlc3MuanMnKTtcbnJlcXVpcmUoJy4uL2V2ZW50L2JlaGF2aW9yL2tleXVwLmpzJyk7XG5yZXF1aXJlKCcuLi9ldmVudC9iZWhhdmlvci9wYXN0ZS5qcycpO1xudmFyIGZvY3VzID0gcmVxdWlyZSgnLi4vZXZlbnQvZm9jdXMuanMnKTtcblxuYXN5bmMgZnVuY3Rpb24gc2VsZWN0T3B0aW9ucyhzZWxlY3QsIHZhbHVlcykge1xuICAgIHJldHVybiBzZWxlY3RPcHRpb25zQmFzZS5jYWxsKHRoaXMsIHRydWUsIHNlbGVjdCwgdmFsdWVzKTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGRlc2VsZWN0T3B0aW9ucyhzZWxlY3QsIHZhbHVlcykge1xuICAgIHJldHVybiBzZWxlY3RPcHRpb25zQmFzZS5jYWxsKHRoaXMsIGZhbHNlLCBzZWxlY3QsIHZhbHVlcyk7XG59XG5hc3luYyBmdW5jdGlvbiBzZWxlY3RPcHRpb25zQmFzZShuZXdWYWx1ZSwgc2VsZWN0LCB2YWx1ZXMpIHtcbiAgICBpZiAoIW5ld1ZhbHVlICYmICFzZWxlY3QubXVsdGlwbGUpIHtcbiAgICAgICAgdGhyb3cgZG9tLmdldENvbmZpZygpLmdldEVsZW1lbnRFcnJvcihgVW5hYmxlIHRvIGRlc2VsZWN0IGFuIG9wdGlvbiBpbiBhIG5vbi1tdWx0aXBsZSBzZWxlY3QuIFVzZSBzZWxlY3RPcHRpb25zIHRvIGNoYW5nZSB0aGUgc2VsZWN0aW9uIGluc3RlYWQuYCwgc2VsZWN0KTtcbiAgICB9XG4gICAgY29uc3QgdmFsQXJyYXkgPSBBcnJheS5pc0FycmF5KHZhbHVlcykgPyB2YWx1ZXMgOiBbXG4gICAgICAgIHZhbHVlc1xuICAgIF07XG4gICAgY29uc3QgYWxsT3B0aW9ucyA9IEFycmF5LmZyb20oc2VsZWN0LnF1ZXJ5U2VsZWN0b3JBbGwoJ29wdGlvbiwgW3JvbGU9XCJvcHRpb25cIl0nKSk7XG4gICAgY29uc3Qgc2VsZWN0ZWRPcHRpb25zID0gdmFsQXJyYXkubWFwKCh2YWwpPT57XG4gICAgICAgIGlmICh0eXBlb2YgdmFsICE9PSAnc3RyaW5nJyAmJiBhbGxPcHRpb25zLmluY2x1ZGVzKHZhbCkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBtYXRjaGluZ09wdGlvbiA9IGFsbE9wdGlvbnMuZmluZCgobyk9Pm8udmFsdWUgPT09IHZhbCB8fCBvLmlubmVySFRNTCA9PT0gdmFsKTtcbiAgICAgICAgICAgIGlmIChtYXRjaGluZ09wdGlvbikge1xuICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaGluZ09wdGlvbjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZG9tLmdldENvbmZpZygpLmdldEVsZW1lbnRFcnJvcihgVmFsdWUgXCIke1N0cmluZyh2YWwpfVwiIG5vdCBmb3VuZCBpbiBvcHRpb25zYCwgc2VsZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pLmZpbHRlcigob3B0aW9uKT0+IWlzRGlzYWJsZWQuaXNEaXNhYmxlZChvcHRpb24pKTtcbiAgICBpZiAoaXNEaXNhYmxlZC5pc0Rpc2FibGVkKHNlbGVjdCkgfHwgIXNlbGVjdGVkT3B0aW9ucy5sZW5ndGgpIHJldHVybjtcbiAgICBjb25zdCBzZWxlY3RPcHRpb24gPSAob3B0aW9uKT0+e1xuICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBuZXdWYWx1ZTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAnaW5wdXQnLCB7XG4gICAgICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgICAgICAgY2FuY2VsYWJsZTogZmFsc2UsXG4gICAgICAgICAgICBjb21wb3NlZDogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAnY2hhbmdlJyk7XG4gICAgfTtcbiAgICBpZiAoaXNFbGVtZW50VHlwZS5pc0VsZW1lbnRUeXBlKHNlbGVjdCwgJ3NlbGVjdCcpKSB7XG4gICAgICAgIGlmIChzZWxlY3QubXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIHNlbGVjdGVkT3B0aW9ucyl7XG4gICAgICAgICAgICAgICAgY29uc3Qgd2l0aFBvaW50ZXJFdmVudHMgPSB0aGlzLmNvbmZpZy5wb2ludGVyRXZlbnRzQ2hlY2sgPT09IDAgPyB0cnVlIDogY3NzUG9pbnRlckV2ZW50cy5oYXNQb2ludGVyRXZlbnRzKHRoaXMsIG9wdGlvbik7XG4gICAgICAgICAgICAgICAgLy8gZXZlbnRzIGZpcmVkIGZvciBtdWx0aXBsZSBzZWxlY3QgYXJlIHdlaXJkLiBDYW4ndCB1c2UgaG92ZXIuLi5cbiAgICAgICAgICAgICAgICBpZiAod2l0aFBvaW50ZXJFdmVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQob3B0aW9uLCAncG9pbnRlcm92ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAncG9pbnRlcmVudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KG9wdGlvbiwgJ21vdXNlb3ZlcicpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChzZWxlY3QsICdtb3VzZWVudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KG9wdGlvbiwgJ3BvaW50ZXJtb3ZlJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KG9wdGlvbiwgJ21vdXNlbW92ZScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChvcHRpb24sICdwb2ludGVyZG93bicpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChvcHRpb24sICdtb3VzZWRvd24nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9jdXMuZm9jdXNFbGVtZW50KHNlbGVjdCk7XG4gICAgICAgICAgICAgICAgaWYgKHdpdGhQb2ludGVyRXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KG9wdGlvbiwgJ3BvaW50ZXJ1cCcpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChvcHRpb24sICdtb3VzZXVwJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNlbGVjdE9wdGlvbihvcHRpb24pO1xuICAgICAgICAgICAgICAgIGlmICh3aXRoUG9pbnRlckV2ZW50cykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChvcHRpb24sICdjbGljaycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhd2FpdCB3YWl0LndhaXQodGhpcy5jb25maWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdGVkT3B0aW9ucy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IHdpdGhQb2ludGVyRXZlbnRzID0gdGhpcy5jb25maWcucG9pbnRlckV2ZW50c0NoZWNrID09PSAwID8gdHJ1ZSA6IGNzc1BvaW50ZXJFdmVudHMuaGFzUG9pbnRlckV2ZW50cyh0aGlzLCBzZWxlY3QpO1xuICAgICAgICAgICAgLy8gdGhlIGNsaWNrIHRvIG9wZW4gdGhlIHNlbGVjdCBvcHRpb25zXG4gICAgICAgICAgICBpZiAod2l0aFBvaW50ZXJFdmVudHMpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWNrKHNlbGVjdCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvY3VzLmZvY3VzRWxlbWVudChzZWxlY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZWN0T3B0aW9uKHNlbGVjdGVkT3B0aW9uc1swXSk7XG4gICAgICAgICAgICBpZiAod2l0aFBvaW50ZXJFdmVudHMpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGUgYnJvd3NlciB0cmlnZ2VycyBhbm90aGVyIGNsaWNrIGV2ZW50IG9uIHRoZSBzZWxlY3QgZm9yIHRoZSBjbGljayBvbiB0aGUgb3B0aW9uXG4gICAgICAgICAgICAgICAgLy8gdGhpcyBzZWNvbmQgY2xpY2sgaGFzIG5vICdkb3duJyBwaGFzZVxuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KHNlbGVjdCwgJ3BvaW50ZXJvdmVyJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAncG9pbnRlcmVudGVyJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAnbW91c2VvdmVyJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFVJRXZlbnQoc2VsZWN0LCAnbW91c2VlbnRlcicpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KHNlbGVjdCwgJ3BvaW50ZXJ1cCcpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hVSUV2ZW50KHNlbGVjdCwgJ21vdXNldXAnKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoVUlFdmVudChzZWxlY3QsICdjbGljaycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgd2FpdC53YWl0KHRoaXMuY29uZmlnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGRvbS5nZXRDb25maWcoKS5nZXRFbGVtZW50RXJyb3IoYENhbm5vdCBzZWxlY3QgbXVsdGlwbGUgb3B0aW9ucyBvbiBhIG5vbi1tdWx0aXBsZSBzZWxlY3RgLCBzZWxlY3QpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmIChzZWxlY3QuZ2V0QXR0cmlidXRlKCdyb2xlJykgPT09ICdsaXN0Ym94Jykge1xuICAgICAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiBzZWxlY3RlZE9wdGlvbnMpe1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGljayhvcHRpb24pO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51bmhvdmVyKG9wdGlvbik7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBkb20uZ2V0Q29uZmlnKCkuZ2V0RWxlbWVudEVycm9yKGBDYW5ub3Qgc2VsZWN0IG9wdGlvbnMgb24gZWxlbWVudHMgdGhhdCBhcmUgbmVpdGhlciBzZWxlY3Qgbm9yIGxpc3Rib3ggZWxlbWVudHNgLCBzZWxlY3QpO1xuICAgIH1cbn1cblxuZXhwb3J0cy5kZXNlbGVjdE9wdGlvbnMgPSBkZXNlbGVjdE9wdGlvbnM7XG5leHBvcnRzLnNlbGVjdE9wdGlvbnMgPSBzZWxlY3RPcHRpb25zO1xuIl0sInZlcnNpb24iOjN9