3ea453801b1665c0f2302d6f1d42c729
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerRoutes = registerRoutes;
// Main routes file that loads route definitions
const express_1 = __importDefault(require("express"));
const auth_1 = require("./auth");
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
// Import API route registration functions
const organizations_1 = require("./api/organizations");
const users_1 = require("./api/users");
const buildings_1 = require("./api/buildings");
const documents_1 = require("./api/documents");
const bugs_1 = require("./api/bugs");
const bills_1 = require("./api/bills");
const residences_1 = require("./api/residences");
const demands_1 = require("./api/demands");
const feature_requests_1 = require("./api/feature-requests");
const contacts_1 = require("./api/contacts");
const common_spaces_1 = require("./api/common-spaces");
const permissions_1 = require("./api/permissions");
const demo_management_1 = require("./api/demo-management");
const trial_request_1 = require("./api/trial-request");
async function registerRoutes(app) {
    console.log('ðŸ”„ Setting up session middleware...');
    // CRITICAL: Apply session middleware BEFORE authentication routes
    app.use(auth_1.sessionConfig);
    console.log('âœ… Session middleware configured');
    console.log('ðŸ”„ Loading authentication routes...');
    // Setup authentication routes - session middleware must be applied first
    (0, auth_1.setupAuthRoutes)(app);
    console.log('âœ… Authentication routes loaded on /api/auth/');
    // Register all API routes
    console.log('ðŸ”„ Loading API routes...');
    (0, organizations_1.registerOrganizationRoutes)(app);
    (0, users_1.registerUserRoutes)(app);
    (0, buildings_1.registerBuildingRoutes)(app);
    (0, documents_1.registerDocumentRoutes)(app);
    (0, bugs_1.registerBugRoutes)(app);
    (0, bills_1.registerBillRoutes)(app);
    (0, residences_1.registerResidenceRoutes)(app);
    (0, demands_1.registerDemandRoutes)(app);
    (0, feature_requests_1.registerFeatureRequestRoutes)(app);
    (0, contacts_1.registerContactRoutes)(app);
    (0, common_spaces_1.registerCommonSpacesRoutes)(app);
    (0, permissions_1.registerPermissionsRoutes)(app);
    (0, demo_management_1.registerDemoManagementRoutes)(app);
    (0, trial_request_1.registerTrialRequestRoutes)(app);
    console.log('âœ… All API routes registered');
    // Basic API routes
    app.get('/api/health', (req, res) => {
        res.json({ status: 'ok', timestamp: new Date().toISOString() });
    });
    app.post('/api/test', (req, res) => {
        res.json({ message: 'API working', body: req.body });
    });
    // Simple production diagnostic endpoint
    app.get('/api/debug/simple', (req, res) => {
        console.log('ðŸ” Simple debug endpoint called');
        res.json({
            status: 'working',
            timestamp: new Date().toISOString(),
            environment: process.env.NODE_ENV || 'unknown',
            databaseUrl: process.env.DATABASE_URL ? 'present' : 'missing'
        });
    });
    // Complex storage test endpoint  
    app.get('/api/debug/storage', async (req, res) => {
        const timestamp = new Date().toISOString();
        console.log(`[${timestamp}] ðŸ” Storage debug endpoint called`);
        try {
            console.log(`[${timestamp}] ðŸ“¦ Testing storage import...`);
            const { storage } = await Promise.resolve().then(() => __importStar(require('./storage')));
            console.log(`[${timestamp}] âœ… Storage imported successfully`);
            console.log(`[${timestamp}] ðŸ§ª Testing basic storage method...`);
            const testResult = await storage.getDocuments({ residenceId: 'e27ac924-8120-4904-a791-d1e9db544d58' });
            console.log(`[${timestamp}] âœ… Storage test successful`);
            res.json({
                success: true,
                timestamp,
                documentsCount: testResult.length,
                storageType: storage.constructor.name
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                timestamp,
                error: error.message,
                stack: error.stack
            });
        }
    });
    // User info debug endpoint
    app.get('/api/debug/user-info', async (req, res) => {
        try {
            if (!req.session?.userId && !req.session?.user) {
                return res.status(401).json({
                    message: 'No session found',
                    session: req.session
                });
            }
            const user = req.user || req.session?.user;
            const userId = req.session?.userId;
            // Get user from database directly
            const { db } = await Promise.resolve().then(() => __importStar(require('./db')));
            const { users, userOrganizations, organizations } = await Promise.resolve().then(() => __importStar(require('../shared/schema')));
            const { eq } = await Promise.resolve().then(() => __importStar(require('drizzle-orm')));
            const userFromDb = await db
                .select()
                .from(users)
                .where(eq(users.id, userId));
            const userOrgs = await db
                .select({
                organizationId: userOrganizations.organizationId,
                organizationName: organizations.name,
                canAccessAllOrganizations: userOrganizations.canAccessAllOrganizations,
                isActive: userOrganizations.isActive,
            })
                .from(userOrganizations)
                .innerJoin(organizations, eq(userOrganizations.organizationId, organizations.id))
                .where(eq(userOrganizations.userId, userId));
            res.json({
                session: {
                    userId: req.session?.userId,
                    hasUser: !!user,
                    userRole: req.session?.userRole,
                },
                userFromMiddleware: user,
                userFromDatabase: userFromDb[0],
                userOrganizations: userOrgs,
                rawSession: req.session
            });
        }
        catch (error) {
            res.status(500).json({
                error: error.message,
                stack: error.stack
            });
        }
    });
    // Static file serving - MUST come after API routes to prevent conflicts
    const distPath = path_1.default.resolve(process.cwd(), 'dist', 'public');
    if (fs_1.default.existsSync(distPath)) {
        console.log('âœ… Setting up static file serving from', distPath);
        // Serve static assets with appropriate cache headers
        app.use(express_1.default.static(distPath, {
            // Disable caching for development to ensure fresh files
            setHeaders: (res, path) => {
                if (process.env.NODE_ENV === 'development') {
                    // Development: disable all caching for immediate updates
                    res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
                    res.setHeader('Pragma', 'no-cache');
                    res.setHeader('Expires', '0');
                }
                else {
                    // Production: cache assets but allow revalidation
                    if (path.endsWith('.html')) {
                        // HTML files should not be cached to ensure routing works
                        res.setHeader('Cache-Control', 'no-cache, must-revalidate');
                    }
                    else {
                        // Other assets can be cached with revalidation
                        res.setHeader('Cache-Control', 'public, max-age=300, must-revalidate');
                    }
                }
            }
        }));
        // SPA fallback - serve index.html for non-API routes
        app.get('*', (req, res) => {
            // Don't serve index.html for API routes
            if (req.path.startsWith('/api/')) {
                return res.status(404).json({ message: 'API endpoint not found', error: 'API endpoint not found' });
            }
            const indexPath = path_1.default.join(distPath, 'index.html');
            if (fs_1.default.existsSync(indexPath)) {
                // Ensure index.html is never cached
                res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
                res.setHeader('Pragma', 'no-cache');
                res.setHeader('Expires', '0');
                res.sendFile(indexPath);
            }
            else {
                res.status(404).send('Application not found - build missing');
            }
        });
    }
    else {
        console.log('âš ï¸ Static files not found, only API routes available');
        // Fallback for missing static files
        app.get('*', (req, res) => {
            if (req.path.startsWith('/api/')) {
                return res.status(404).json({ message: 'API endpoint not found', error: 'API endpoint not found' });
            }
            res.status(503).send('Application is starting up...');
        });
    }
    console.log('âœ… All routes registered successfully');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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c0RBQXNELENBQUMsQ0FBQztRQUVwRSxvQ0FBb0M7UUFDcEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDeEIsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUNqQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLEtBQUssRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUM7WUFDdEcsQ0FBQztZQUNELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDeEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3RELENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvcm91dGVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIE1haW4gcm91dGVzIGZpbGUgdGhhdCBsb2FkcyByb3V0ZSBkZWZpbml0aW9uc1xuaW1wb3J0IGV4cHJlc3MsIHsgRXhwcmVzcyB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgc2V0dXBBdXRoUm91dGVzLCBzZXNzaW9uQ29uZmlnIH0gZnJvbSAnLi9hdXRoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcblxuLy8gSW1wb3J0IEFQSSByb3V0ZSByZWdpc3RyYXRpb24gZnVuY3Rpb25zXG5pbXBvcnQgeyByZWdpc3Rlck9yZ2FuaXphdGlvblJvdXRlcyB9IGZyb20gJy4vYXBpL29yZ2FuaXphdGlvbnMnO1xuaW1wb3J0IHsgcmVnaXN0ZXJVc2VyUm91dGVzIH0gZnJvbSAnLi9hcGkvdXNlcnMnO1xuaW1wb3J0IHsgcmVnaXN0ZXJCdWlsZGluZ1JvdXRlcyB9IGZyb20gJy4vYXBpL2J1aWxkaW5ncyc7XG5pbXBvcnQgeyByZWdpc3RlckRvY3VtZW50Um91dGVzIH0gZnJvbSAnLi9hcGkvZG9jdW1lbnRzJztcbmltcG9ydCB7IHJlZ2lzdGVyQnVnUm91dGVzIH0gZnJvbSAnLi9hcGkvYnVncyc7XG5pbXBvcnQgeyByZWdpc3RlckJpbGxSb3V0ZXMgfSBmcm9tICcuL2FwaS9iaWxscyc7XG5pbXBvcnQgeyByZWdpc3RlclJlc2lkZW5jZVJvdXRlcyB9IGZyb20gJy4vYXBpL3Jlc2lkZW5jZXMnO1xuaW1wb3J0IHsgcmVnaXN0ZXJEZW1hbmRSb3V0ZXMgfSBmcm9tICcuL2FwaS9kZW1hbmRzJztcbmltcG9ydCB7IHJlZ2lzdGVyRmVhdHVyZVJlcXVlc3RSb3V0ZXMgfSBmcm9tICcuL2FwaS9mZWF0dXJlLXJlcXVlc3RzJztcbmltcG9ydCB7IHJlZ2lzdGVyQ29udGFjdFJvdXRlcyB9IGZyb20gJy4vYXBpL2NvbnRhY3RzJztcbmltcG9ydCB7IHJlZ2lzdGVyQ29tbW9uU3BhY2VzUm91dGVzIH0gZnJvbSAnLi9hcGkvY29tbW9uLXNwYWNlcyc7XG5pbXBvcnQgeyByZWdpc3RlclBlcm1pc3Npb25zUm91dGVzIH0gZnJvbSAnLi9hcGkvcGVybWlzc2lvbnMnO1xuaW1wb3J0IHsgcmVnaXN0ZXJEZW1vTWFuYWdlbWVudFJvdXRlcyB9IGZyb20gJy4vYXBpL2RlbW8tbWFuYWdlbWVudCc7XG5pbXBvcnQgeyByZWdpc3RlclRyaWFsUmVxdWVzdFJvdXRlcyB9IGZyb20gJy4vYXBpL3RyaWFsLXJlcXVlc3QnO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJSb3V0ZXMoYXBwOiBFeHByZXNzKSB7XG4gIGNvbnNvbGUubG9nKCfwn5SEIFNldHRpbmcgdXAgc2Vzc2lvbiBtaWRkbGV3YXJlLi4uJyk7XG4gIFxuICAvLyBDUklUSUNBTDogQXBwbHkgc2Vzc2lvbiBtaWRkbGV3YXJlIEJFRk9SRSBhdXRoZW50aWNhdGlvbiByb3V0ZXNcbiAgYXBwLnVzZShzZXNzaW9uQ29uZmlnKTtcbiAgY29uc29sZS5sb2coJ+KchSBTZXNzaW9uIG1pZGRsZXdhcmUgY29uZmlndXJlZCcpO1xuICBcbiAgY29uc29sZS5sb2coJ/CflIQgTG9hZGluZyBhdXRoZW50aWNhdGlvbiByb3V0ZXMuLi4nKTtcbiAgXG4gIC8vIFNldHVwIGF1dGhlbnRpY2F0aW9uIHJvdXRlcyAtIHNlc3Npb24gbWlkZGxld2FyZSBtdXN0IGJlIGFwcGxpZWQgZmlyc3RcbiAgc2V0dXBBdXRoUm91dGVzKGFwcCk7XG4gIGNvbnNvbGUubG9nKCfinIUgQXV0aGVudGljYXRpb24gcm91dGVzIGxvYWRlZCBvbiAvYXBpL2F1dGgvJyk7XG4gIFxuICAvLyBSZWdpc3RlciBhbGwgQVBJIHJvdXRlc1xuICBjb25zb2xlLmxvZygn8J+UhCBMb2FkaW5nIEFQSSByb3V0ZXMuLi4nKTtcbiAgcmVnaXN0ZXJPcmdhbml6YXRpb25Sb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJVc2VyUm91dGVzKGFwcCk7XG4gIHJlZ2lzdGVyQnVpbGRpbmdSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJEb2N1bWVudFJvdXRlcyhhcHApO1xuICByZWdpc3RlckJ1Z1JvdXRlcyhhcHApO1xuICByZWdpc3RlckJpbGxSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJSZXNpZGVuY2VSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJEZW1hbmRSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJGZWF0dXJlUmVxdWVzdFJvdXRlcyhhcHApO1xuICByZWdpc3RlckNvbnRhY3RSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJDb21tb25TcGFjZXNSb3V0ZXMoYXBwKTtcbiAgcmVnaXN0ZXJQZXJtaXNzaW9uc1JvdXRlcyhhcHApO1xuICByZWdpc3RlckRlbW9NYW5hZ2VtZW50Um91dGVzKGFwcCk7XG4gIHJlZ2lzdGVyVHJpYWxSZXF1ZXN0Um91dGVzKGFwcCk7XG4gIGNvbnNvbGUubG9nKCfinIUgQWxsIEFQSSByb3V0ZXMgcmVnaXN0ZXJlZCcpO1xuICBcbiAgLy8gQmFzaWMgQVBJIHJvdXRlc1xuICBhcHAuZ2V0KCcvYXBpL2hlYWx0aCcsIChyZXEsIHJlcykgPT4ge1xuICAgIHJlcy5qc29uKHsgc3RhdHVzOiAnb2snLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9KTtcbiAgfSk7XG4gIFxuICBhcHAucG9zdCgnL2FwaS90ZXN0JywgKHJlcSwgcmVzKSA9PiB7XG4gICAgcmVzLmpzb24oeyBtZXNzYWdlOiAnQVBJIHdvcmtpbmcnLCBib2R5OiByZXEuYm9keSB9KTtcbiAgfSk7XG5cbiAgLy8gU2ltcGxlIHByb2R1Y3Rpb24gZGlhZ25vc3RpYyBlbmRwb2ludFxuICBhcHAuZ2V0KCcvYXBpL2RlYnVnL3NpbXBsZScsIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnNvbGUubG9nKCfwn5SNIFNpbXBsZSBkZWJ1ZyBlbmRwb2ludCBjYWxsZWQnKTtcbiAgICByZXMuanNvbih7IFxuICAgICAgc3RhdHVzOiAnd29ya2luZycsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGVudmlyb25tZW50OiBwcm9jZXNzLmVudi5OT0RFX0VOViB8fCAndW5rbm93bicsXG4gICAgICBkYXRhYmFzZVVybDogcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID8gJ3ByZXNlbnQnIDogJ21pc3NpbmcnXG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIENvbXBsZXggc3RvcmFnZSB0ZXN0IGVuZHBvaW50ICBcbiAgYXBwLmdldCgnL2FwaS9kZWJ1Zy9zdG9yYWdlJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIGNvbnNvbGUubG9nKGBbJHt0aW1lc3RhbXB9XSDwn5SNIFN0b3JhZ2UgZGVidWcgZW5kcG9pbnQgY2FsbGVkYCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKGBbJHt0aW1lc3RhbXB9XSDwn5OmIFRlc3Rpbmcgc3RvcmFnZSBpbXBvcnQuLi5gKTtcbiAgICAgIGNvbnN0IHsgc3RvcmFnZSB9ID0gYXdhaXQgaW1wb3J0KCcuL3N0b3JhZ2UnKTtcbiAgICAgIGNvbnNvbGUubG9nKGBbJHt0aW1lc3RhbXB9XSDinIUgU3RvcmFnZSBpbXBvcnRlZCBzdWNjZXNzZnVsbHlgKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYFske3RpbWVzdGFtcH1dIPCfp6ogVGVzdGluZyBiYXNpYyBzdG9yYWdlIG1ldGhvZC4uLmApO1xuICAgICAgY29uc3QgdGVzdFJlc3VsdCA9IGF3YWl0IHN0b3JhZ2UuZ2V0RG9jdW1lbnRzKHsgcmVzaWRlbmNlSWQ6ICdlMjdhYzkyNC04MTIwLTQ5MDQtYTc5MS1kMWU5ZGI1NDRkNTgnIH0pO1xuICAgICAgY29uc29sZS5sb2coYFske3RpbWVzdGFtcH1dIOKchSBTdG9yYWdlIHRlc3Qgc3VjY2Vzc2Z1bGApO1xuICAgICAgXG4gICAgICByZXMuanNvbih7IFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgIGRvY3VtZW50c0NvdW50OiB0ZXN0UmVzdWx0Lmxlbmd0aCxcbiAgICAgICAgc3RvcmFnZVR5cGU6IHN0b3JhZ2UuY29uc3RydWN0b3IubmFtZVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIHN0YWNrOiBlcnJvci5zdGFja1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBVc2VyIGluZm8gZGVidWcgZW5kcG9pbnRcbiAgYXBwLmdldCgnL2FwaS9kZWJ1Zy91c2VyLWluZm8nLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXJlcS5zZXNzaW9uPy51c2VySWQgJiYgIXJlcS5zZXNzaW9uPy51c2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ05vIHNlc3Npb24gZm91bmQnLFxuICAgICAgICAgIHNlc3Npb246IHJlcS5zZXNzaW9uXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEuc2Vzc2lvbj8udXNlcklkO1xuXG4gICAgICAvLyBHZXQgdXNlciBmcm9tIGRhdGFiYXNlIGRpcmVjdGx5XG4gICAgICBjb25zdCB7IGRiIH0gPSBhd2FpdCBpbXBvcnQoJy4vZGInKTtcbiAgICAgIGNvbnN0IHsgdXNlcnMsIHVzZXJPcmdhbml6YXRpb25zLCBvcmdhbml6YXRpb25zIH0gPSBhd2FpdCBpbXBvcnQoJy4uL3NoYXJlZC9zY2hlbWEnKTtcbiAgICAgIGNvbnN0IHsgZXEgfSA9IGF3YWl0IGltcG9ydCgnZHJpenpsZS1vcm0nKTtcblxuICAgICAgY29uc3QgdXNlckZyb21EYiA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbSh1c2VycylcbiAgICAgICAgLndoZXJlKGVxKHVzZXJzLmlkLCB1c2VySWQpKTtcblxuICAgICAgY29uc3QgdXNlck9yZ3MgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICBvcmdhbml6YXRpb25JZDogdXNlck9yZ2FuaXphdGlvbnMub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogb3JnYW5pemF0aW9ucy5uYW1lLFxuICAgICAgICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLmNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnMsXG4gICAgICAgICAgaXNBY3RpdmU6IHVzZXJPcmdhbml6YXRpb25zLmlzQWN0aXZlLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbSh1c2VyT3JnYW5pemF0aW9ucylcbiAgICAgICAgLmlubmVySm9pbihvcmdhbml6YXRpb25zLCBlcSh1c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgIC53aGVyZShlcSh1c2VyT3JnYW5pemF0aW9ucy51c2VySWQsIHVzZXJJZCkpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHNlc3Npb246IHtcbiAgICAgICAgICB1c2VySWQ6IHJlcS5zZXNzaW9uPy51c2VySWQsXG4gICAgICAgICAgaGFzVXNlcjogISF1c2VyLFxuICAgICAgICAgIHVzZXJSb2xlOiByZXEuc2Vzc2lvbj8udXNlclJvbGUsXG4gICAgICAgIH0sXG4gICAgICAgIHVzZXJGcm9tTWlkZGxld2FyZTogdXNlcixcbiAgICAgICAgdXNlckZyb21EYXRhYmFzZTogdXNlckZyb21EYlswXSxcbiAgICAgICAgdXNlck9yZ2FuaXphdGlvbnM6IHVzZXJPcmdzLFxuICAgICAgICByYXdTZXNzaW9uOiByZXEuc2Vzc2lvblxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBcbiAgLy8gU3RhdGljIGZpbGUgc2VydmluZyAtIE1VU1QgY29tZSBhZnRlciBBUEkgcm91dGVzIHRvIHByZXZlbnQgY29uZmxpY3RzXG4gIGNvbnN0IGRpc3RQYXRoID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICdkaXN0JywgJ3B1YmxpYycpO1xuICBcbiAgaWYgKGZzLmV4aXN0c1N5bmMoZGlzdFBhdGgpKSB7XG4gICAgY29uc29sZS5sb2coJ+KchSBTZXR0aW5nIHVwIHN0YXRpYyBmaWxlIHNlcnZpbmcgZnJvbScsIGRpc3RQYXRoKTtcbiAgICBcbiAgICAvLyBTZXJ2ZSBzdGF0aWMgYXNzZXRzIHdpdGggYXBwcm9wcmlhdGUgY2FjaGUgaGVhZGVyc1xuICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoZGlzdFBhdGgsIHtcbiAgICAgIC8vIERpc2FibGUgY2FjaGluZyBmb3IgZGV2ZWxvcG1lbnQgdG8gZW5zdXJlIGZyZXNoIGZpbGVzXG4gICAgICBzZXRIZWFkZXJzOiAocmVzLCBwYXRoKSA9PiB7XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICAgIC8vIERldmVsb3BtZW50OiBkaXNhYmxlIGFsbCBjYWNoaW5nIGZvciBpbW1lZGlhdGUgdXBkYXRlc1xuICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tY2FjaGUsIG5vLXN0b3JlLCBtdXN0LXJldmFsaWRhdGUnKTtcbiAgICAgICAgICByZXMuc2V0SGVhZGVyKCdQcmFnbWEnLCAnbm8tY2FjaGUnKTtcbiAgICAgICAgICByZXMuc2V0SGVhZGVyKCdFeHBpcmVzJywgJzAnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBQcm9kdWN0aW9uOiBjYWNoZSBhc3NldHMgYnV0IGFsbG93IHJldmFsaWRhdGlvblxuICAgICAgICAgIGlmIChwYXRoLmVuZHNXaXRoKCcuaHRtbCcpKSB7XG4gICAgICAgICAgICAvLyBIVE1MIGZpbGVzIHNob3VsZCBub3QgYmUgY2FjaGVkIHRvIGVuc3VyZSByb3V0aW5nIHdvcmtzXG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ25vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGUnKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gT3RoZXIgYXNzZXRzIGNhbiBiZSBjYWNoZWQgd2l0aCByZXZhbGlkYXRpb25cbiAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NhY2hlLUNvbnRyb2wnLCAncHVibGljLCBtYXgtYWdlPTMwMCwgbXVzdC1yZXZhbGlkYXRlJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSkpO1xuICAgIFxuICAgIC8vIFNQQSBmYWxsYmFjayAtIHNlcnZlIGluZGV4Lmh0bWwgZm9yIG5vbi1BUEkgcm91dGVzXG4gICAgYXBwLmdldCgnKicsIChyZXEsIHJlcykgPT4ge1xuICAgICAgLy8gRG9uJ3Qgc2VydmUgaW5kZXguaHRtbCBmb3IgQVBJIHJvdXRlc1xuICAgICAgaWYgKHJlcS5wYXRoLnN0YXJ0c1dpdGgoJy9hcGkvJykpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0FQSSBlbmRwb2ludCBub3QgZm91bmQnLCBlcnJvcjogJ0FQSSBlbmRwb2ludCBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zdCBpbmRleFBhdGggPSBwYXRoLmpvaW4oZGlzdFBhdGgsICdpbmRleC5odG1sJyk7XG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhpbmRleFBhdGgpKSB7XG4gICAgICAgIC8vIEVuc3VyZSBpbmRleC5odG1sIGlzIG5ldmVyIGNhY2hlZFxuICAgICAgICByZXMuc2V0SGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ25vLWNhY2hlLCBuby1zdG9yZSwgbXVzdC1yZXZhbGlkYXRlJyk7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ1ByYWdtYScsICduby1jYWNoZScpO1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdFeHBpcmVzJywgJzAnKTtcbiAgICAgICAgcmVzLnNlbmRGaWxlKGluZGV4UGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDQwNCkuc2VuZCgnQXBwbGljYXRpb24gbm90IGZvdW5kIC0gYnVpbGQgbWlzc2luZycpO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKCfimqDvuI8gU3RhdGljIGZpbGVzIG5vdCBmb3VuZCwgb25seSBBUEkgcm91dGVzIGF2YWlsYWJsZScpO1xuICAgIFxuICAgIC8vIEZhbGxiYWNrIGZvciBtaXNzaW5nIHN0YXRpYyBmaWxlc1xuICAgIGFwcC5nZXQoJyonLCAocmVxLCByZXMpID0+IHtcbiAgICAgIGlmIChyZXEucGF0aC5zdGFydHNXaXRoKCcvYXBpLycpKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdBUEkgZW5kcG9pbnQgbm90IGZvdW5kJywgZXJyb3I6ICdBUEkgZW5kcG9pbnQgbm90IGZvdW5kJyB9KTtcbiAgICAgIH1cbiAgICAgIHJlcy5zdGF0dXMoNTAzKS5zZW5kKCdBcHBsaWNhdGlvbiBpcyBzdGFydGluZyB1cC4uLicpO1xuICAgIH0pO1xuICB9XG4gIFxuICBjb25zb2xlLmxvZygn4pyFIEFsbCByb3V0ZXMgcmVnaXN0ZXJlZCBzdWNjZXNzZnVsbHknKTtcbn0iXSwidmVyc2lvbiI6M30=