ccf5b70dc8de81b4096c98c219f51d29
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InvitationPermissionValidator = exports.InvitationSecurityMonitor = exports.SecurityAlertLevel = void 0;
exports.rateLimitInvitations = rateLimitInvitations;
exports.requireInvitationPermission = requireInvitationPermission;
exports.createEnhancedInvitationAuditLog = createEnhancedInvitationAuditLog;
exports.withPermissionInheritance = withPermissionInheritance;
const drizzle_orm_1 = require("drizzle-orm");
const serverless_1 = require("@neondatabase/serverless");
const schema = __importStar(require("@shared/schema"));
const config_1 = require("../../config");
// Database-based permission checking - no config permissions needed
// Note: createInvitationAuditLog will be defined locally or imported when needed
const ws_1 = __importDefault(require("ws"));
serverless_1.neonConfig.webSocketConstructor = ws_1.default;
if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL must be set. Did you forget to provision a database?');
}
// Use shared database connection to avoid multiple pools
const db_1 = require("../db");
/**
 * Security alert levels for invitation system monitoring.
 */
var SecurityAlertLevel;
(function (SecurityAlertLevel) {
    SecurityAlertLevel["LOW"] = "low";
    SecurityAlertLevel["MEDIUM"] = "medium";
    SecurityAlertLevel["HIGH"] = "high";
    SecurityAlertLevel["CRITICAL"] = "critical";
})(SecurityAlertLevel || (exports.SecurityAlertLevel = SecurityAlertLevel = {}));
/**
 * Rate limiting configuration for invitation operations.
 */
const RATE_LIMITS = {
    CREATE_INVITATION: { count: 10, window: 3600000 }, // 10 per hour
    BULK_INVITATION: { count: 3, window: 3600000 }, // 3 per hour
    VALIDATION_ATTEMPTS: { count: 20, window: 300000 }, // 20 per 5 minutes
    ACCEPT_ATTEMPTS: { count: 5, window: 3600000 }, // 5 per hour
};
/**
 * In-memory rate limiting store (in production, use Redis).
 */
const rateLimitStore = new Map();
/**
 * Enhanced security monitoring for invitation operations.
 * Tracks suspicious activities and generates alerts.
 */
class InvitationSecurityMonitor {
    static alertCallbacks = [];
    /**
     * Register callback for security alerts.
     * @param callback
     */
    static onAlert(callback) {
        this.alertCallbacks.push(callback);
    }
    /**
     * Trigger a security alert.
     * @param alert
     */
    static async triggerAlert(alert) {
        console.log('ðŸš¨ Security Alert:', {
            description: alert.description,
            userId: alert.userId,
            ipAddress: alert.ipAddress,
            metadata: alert.metadata,
        });
        // Execute alert callbacks
        this.alertCallbacks.forEach((callback) => {
            try {
                callback(alert);
            }
            catch (error) {
                console.error('âŒ Error in security alert callback:', error);
            }
        });
        // Log security alert to database
        try {
            await db_1.db.insert(schema.invitationAuditLog).values({
                invitationId: alert.metadata?.invitationId || null,
                action: 'security_alert',
                performedBy: alert.userId || null,
                ipAddress: alert.ipAddress,
                userAgent: alert.metadata?.userAgent,
                details: {
                    alertLevel: alert.level,
                    alertType: alert.type,
                    description: alert.description,
                    metadata: alert.metadata,
                },
                previousStatus: null,
                newStatus: null,
            });
        }
        catch (error) {
            console.error('âŒ Error logging security alert to database:', error);
        }
    }
    /**
     * Monitor invitation access patterns for suspicious activity.
     * @param userId
     * @param action
     * @param ipAddress
     * @param userAgent
     * @param metadata
     */
    static async monitorInvitationAccess(userId, action, ipAddress, userAgent, metadata) {
        const key = `${userId}:${action}`;
        const now = Date.now();
        const windowStart = now - 5 * 60 * 1000; // 5 minutes
        // Count recent actions
        const recentActions = await db_1.db
            .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
            .from(schema.invitationAuditLog)
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.invitationAuditLog.performedBy, userId), (0, drizzle_orm_1.eq)(schema.invitationAuditLog.action, action), (0, drizzle_orm_1.gte)(schema.invitationAuditLog.createdAt, new Date(windowStart))));
        const actionCount = recentActions[0]?.count || 0;
        // Check for suspicious patterns
        if (actionCount > 10) {
            await this.triggerAlert({
                level: SecurityAlertLevel.HIGH,
                type: 'excessive_invitation_actions',
                description: `User ${userId} performed ${actionCount} ${action} actions in 5 minutes`,
                userId,
                ipAddress,
                metadata: { action, count: actionCount, userAgent, ...metadata },
            });
        }
        // Check for failed invitation validations
        if (action === 'validation_failed' && actionCount > 5) {
            await this.triggerAlert({
                level: SecurityAlertLevel.MEDIUM,
                type: 'multiple_validation_failures',
                description: `User ${userId} had ${actionCount} failed token validations`,
                userId,
                ipAddress,
                metadata: { action, count: actionCount, userAgent, ...metadata },
            });
        }
        // Monitor IP-based patterns
        if (ipAddress) {
            const ipActions = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                .from(schema.invitationAuditLog)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.invitationAuditLog.ipAddress, ipAddress), (0, drizzle_orm_1.eq)(schema.invitationAuditLog.action, action), (0, drizzle_orm_1.gte)(schema.invitationAuditLog.createdAt, new Date(windowStart))));
            const ipActionCount = ipActions[0]?.count || 0;
            if (ipActionCount > 20) {
                await this.triggerAlert({
                    level: SecurityAlertLevel.CRITICAL,
                    type: 'ip_based_attack',
                    description: `IP ${ipAddress} performed ${ipActionCount} ${action} actions in 5 minutes`,
                    ipAddress,
                    metadata: { action, count: ipActionCount, userAgent, ...metadata },
                });
            }
        }
    }
}
exports.InvitationSecurityMonitor = InvitationSecurityMonitor;
/**
 * Rate limiting middleware for invitation operations.
 * @param maxRequests
 * @param windowMs
 */
/**
 * RateLimitInvitations function.
 * @param maxRequests
 * @param windowMs
 * @returns Function result.
 */
function rateLimitInvitations(maxRequests, windowMs = 3600000) {
    return (req, res, next) => {
        const key = `${req.user?.id || req.ip}:${req.method}:${req.path}`;
        const now = Date.now();
        const current = rateLimitStore.get(key);
        if (!current || now > current.resetTime) {
            rateLimitStore.set(key, { count: 1, resetTime: now + windowMs });
            return next();
        }
        if (current.count >= maxRequests) {
            // Log rate limit exceeded
            InvitationSecurityMonitor.monitorInvitationAccess(req.user?.id || 'anonymous', 'rate_limit_exceeded', req.ip, req.get('User-Agent'), { path: req.path, method: req.method });
            return res.status(429).json({
                message: 'Rate limit exceeded',
                code: 'RATE_LIMIT_EXCEEDED',
                retryAfter: Math.ceil((current.resetTime - now) / 1000),
            });
        }
        current.count++;
        next();
    };
}
/**
 * Database-level permission validation for invitation operations.
 */
class InvitationPermissionValidator {
    /**
     * Validate if user can invite based on role hierarchy and organization context.
     * @param inviterId
     * @param inviterRole
     * @param targetRole
     * @param organizationId
     * @param buildingId
     */
    static async validateInvitePermission(inviterId, inviterRole, targetRole, organizationId, buildingId) {
        // Admin can invite anyone
        if (inviterRole === 'admin') {
            return { valid: true };
        }
        // Check role hierarchy
        if (!(0, config_1.hasRoleOrHigher)(inviterRole, 'manager')) {
            return { valid: false, reason: 'Insufficient role privileges to invite users' };
        }
        // Manager restrictions: can invite resident, manager, tenant within their organization
        if (inviterRole === 'manager') {
            // Managers can invite resident, manager, tenant (but not admin)
            if (!['resident', 'manager', 'tenant'].includes(targetRole)) {
                return {
                    valid: false,
                    reason: 'Managers can only invite resident, manager, and tenant roles',
                };
            }
            // Organization validation - managers can only invite within their organization
            if (organizationId) {
                // Check if the inviter belongs to the specified organization
                const inviterOrganization = await db_1.db
                    .select()
                    .from(schema.users)
                    .leftJoin(schema.buildings, (0, drizzle_orm_1.eq)(schema.buildings.organizationId, organizationId))
                    .leftJoin(schema.residences, (0, drizzle_orm_1.eq)(schema.residences.buildingId, schema.buildings.id))
                    .leftJoin(schema.userResidences, (0, drizzle_orm_1.eq)(schema.userResidences.residenceId, schema.residences.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.users.id, inviterId), (0, drizzle_orm_1.eq)(schema.userResidences.userId, inviterId)))
                    .limit(1);
                if (inviterOrganization.length === 0) {
                    return {
                        valid: false,
                        reason: 'Managers can only invite users to their own organization',
                    };
                }
            }
            else {
                return { valid: false, reason: 'Organization ID is required for manager invitations' };
            }
        }
        return { valid: true };
    }
    /**
     * Validate if user can manage specific invitation.
     * @param userId
     * @param userRole
     * @param invitationId
     */
    static async validateInvitationManagement(userId, userRole, invitationId) {
        // Admin can manage any invitation
        if (userRole === 'admin') {
            return { valid: true };
        }
        // Get invitation details
        const [invitation] = await db_1.db
            .select()
            .from(schema.invitations)
            .where((0, drizzle_orm_1.eq)(schema.invitations.id, invitationId))
            .limit(1);
        if (!invitation) {
            return { valid: false, reason: 'Invitation not found' };
        }
        // Users can only manage their own invitations
        if (invitation.invitedBy !== userId) {
            return { valid: false, reason: 'Can only manage own invitations' };
        }
        return { valid: true };
    }
    /**
     * Validate bulk invitation operation.
     * @param inviterId
     * @param inviterRole
     * @param invitations
     */
    static async validateBulkInvitation(inviterId, inviterRole, invitations) {
        const invalidInvitations = [];
        for (let i = 0; i < invitations.length; i++) {
            const invitation = invitations[i];
            const validation = await this.validateInvitePermission(inviterId, inviterRole, invitation.role, invitation.organizationId, invitation.buildingId);
            if (!validation.valid) {
                invalidInvitations.push(i);
            }
        }
        if (invalidInvitations.length > 0) {
            return {
                valid: false,
                reason: `${invalidInvitations.length} invitations violate permission rules`,
                invalidInvitations,
            };
        }
        return { valid: true };
    }
}
exports.InvitationPermissionValidator = InvitationPermissionValidator;
/**
 * Enhanced RBAC middleware specifically for invitation operations.
 * Combines role-based permissions with context-aware validation.
 * @param action
 * @param _options
 * @param _options.validateContext
 * @param _options.requireOwnership
 * @param _options.allowSelfAccess
 * @param _options.auditAction
 */
/**
 * RequireInvitationPermission function.
 * @param action
 * @param _options
 * @param _options.validateContext
 * @param _options.requireOwnership
 * @param _options.allowSelfAccess
 * @param _options.auditAction
 * @param __options
 * @param __options.validateContext
 * @param __options.requireOwnership
 * @param __options.allowSelfAccess
 * @param __options.auditAction
 * @returns Function result.
 */
function requireInvitationPermission(action, __options = {}) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Check basic permission based on role hierarchy
            const hasPermission = (0, config_1.hasRoleOrHigher)(req.user.role, 'manager');
            if (!hasPermission) {
                await InvitationSecurityMonitor.triggerAlert({
                    level: SecurityAlertLevel.MEDIUM,
                    type: 'permission_denied',
                    description: `User ${req.user.id} (${req.user.role}) attempted unauthorized action: ${action}`,
                    userId: req.user.id,
                    ipAddress: req.ip,
                    metadata: { action, path: req.path, method: req.method },
                });
                return res.status(403).json({
                    message: 'Insufficient permissions',
                    code: 'PERMISSION_DENIED',
                    required: action,
                    userRole: req.user.role,
                });
            }
            // Context-aware validation for specific operations
            if (_options.validateContext && req.body) {
                if (action === 'create:invitation') {
                    const { role, organizationId, buildingId } = req.body;
                    const validation = await InvitationPermissionValidator.validateInvitePermission(req.user.id, req.user.role, role, organizationId, buildingId);
                    if (!validation.valid) {
                        await InvitationSecurityMonitor.triggerAlert({
                            level: SecurityAlertLevel.HIGH,
                            type: 'context_permission_violation',
                            description: `User ${req.user.id} violated context permission: ${validation.reason}`,
                            userId: req.user.id,
                            ipAddress: req.ip,
                            metadata: { action, reason: validation.reason, targetRole: role },
                        });
                        return res.status(403).json({
                            message: validation.reason || 'Context permission denied',
                            code: 'CONTEXT_PERMISSION_DENIED',
                        });
                    }
                }
                if (action === 'bulk:invitation') {
                    const { invitations } = req.body;
                    const validation = await InvitationPermissionValidator.validateBulkInvitation(req.user.id, req.user.role, invitations);
                    if (!validation.valid) {
                        return res.status(403).json({
                            message: validation.reason || 'Bulk invitation permission denied',
                            code: 'BULK_PERMISSION_DENIED',
                            invalidInvitations: validation.invalidInvitations,
                        });
                    }
                }
            }
            // Ownership validation for management operations
            if (_options.requireOwnership && req.params.id) {
                const validation = await InvitationPermissionValidator.validateInvitationManagement(req.user.id, req.user.role, req.params.id);
                if (!validation.valid) {
                    return res.status(403).json({
                        message: validation.reason || 'Not authorized to manage this invitation',
                        code: 'OWNERSHIP_REQUIRED',
                    });
                }
            }
            // Monitor invitation access
            await InvitationSecurityMonitor.monitorInvitationAccess(req.user.id, _options.auditAction || action, req.ip, req.get('User-Agent'), { path: req.path, method: req.method });
            next();
        }
        catch (error) {
            console.error('âŒ Permission validation failed:', error);
            return res.status(500).json({
                message: 'Permission validation failed',
                code: 'RBAC_ERROR',
            });
        }
    };
}
/**
 * Enhanced audit logging for invitation operations.
 * @param invitationId
 * @param action
 * @param performedBy
 * @param req
 * @param previousStatus
 * @param newStatus
 * @param details
 */
/**
 * CreateEnhancedInvitationAuditLog function.
 * @param invitationId
 * @param action
 * @param performedBy
 * @param req
 * @param previousStatus
 * @param newStatus
 * @param details
 * @returns Function result.
 */
async function createEnhancedInvitationAuditLog(invitationId, action, performedBy, req, previousStatus, newStatus, details) {
    try {
        // Get additional context
        const ipAddress = req.ip || req.connection.remoteAddress || 'unknown';
        const userAgent = req.get('User-Agent') || 'unknown';
        const referrer = req.get('Referer');
        const forwardedFor = req.get('X-Forwarded-For');
        // Enhanced details with security context
        const enhancedDetails = {
            ...details,
            security: {
                ipAddress,
                userAgent,
                referrer,
                forwardedFor,
                timestamp: new Date().toISOString(),
                sessionId: req.sessionID,
            },
        };
        // Create audit log entry
        await db_1.db.insert(schema.invitationAuditLog).values([
            {
                invitationId,
                action,
                performedBy,
                ipAddress,
                userAgent,
                details: enhancedDetails,
                previousStatus: previousStatus,
                newStatus: newStatus,
            },
        ]);
        // Log to console for immediate visibility
        console.log('ðŸ“ Enhanced invitation audit log created:', {
            invitationId,
            performedBy,
            ipAddress,
            action,
            previousStatus,
            newStatus,
        });
    }
    catch (error) {
        console.error('âŒ Error creating enhanced invitation audit log:', error);
    }
}
/**
 * Delegation and inheritance middleware for invitation permissions.
 * Allows temporary permission elevation based on organizational hierarchy.
 * @param baseAction
 */
/**
 * WithPermissionInheritance function.
 * @param baseAction
 * @returns Function result.
 */
function withPermissionInheritance(baseAction) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Check if user has direct permission based on role hierarchy
            const hasDirectPermission = (0, config_1.hasRoleOrHigher)(req.user.role, 'manager');
            if (hasDirectPermission) {
                return next();
            }
            // Check for delegated permissions based on organizational context
            if (req.body?.organizationId || req.params.organizationId) {
                const orgId = req.body?.organizationId || req.params.organizationId;
                // Check if user has elevated permissions in this organization
                const userOrgRole = await db_1.db
                    .select()
                    .from(schema.users)
                    .leftJoin(schema.buildings, (0, drizzle_orm_1.eq)(schema.buildings.organizationId, orgId))
                    .leftJoin(schema.residences, (0, drizzle_orm_1.eq)(schema.residences.buildingId, schema.buildings.id))
                    .leftJoin(schema.userResidences, (0, drizzle_orm_1.eq)(schema.userResidences.residenceId, schema.residences.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.users.id, req.user.id), (0, drizzle_orm_1.eq)(schema.userResidences.relationshipType, 'owner')))
                    .limit(1);
                // Owners in an organization get elevated permissions for tenant management
                if (userOrgRole.length > 0 && baseAction === 'create:invitation') {
                    const validation = await InvitationPermissionValidator.validateInvitePermission(req.user.id, 'manager', // Temporarily elevate to manager permissions
                    req.body?.role, orgId, req.body?.buildingId);
                    if (validation.valid) {
                        // Log permission inheritance
                        await createEnhancedInvitationAuditLog(req.body?.invitationId || 'unknown', 'permission_inherited', req.user.id, req, undefined, undefined, { baseAction, inheritedLevel: 'manager', reason: 'organizational_owner' });
                        return next();
                    }
                }
            }
            return res.status(403).json({
                message: 'Insufficient permissions',
                code: 'PERMISSION_DENIED',
                required: baseAction,
                userRole: req.user.role,
            });
        }
        catch (error) {
            console.error('âŒ Permission inheritance check failed:', error);
            return res.status(500).json({
                message: 'Permission validation failed',
                code: 'INHERITANCE_ERROR',
            });
        }
    };
}
// Initialize security monitoring
InvitationSecurityMonitor.onAlert((alert) => {
    // In production, you might want to:
    // - Send alerts to security team
    // - Log to external monitoring service
    // - Trigger automated responses
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXV0aC9pbnZpdGF0aW9uLXJiYWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBa05BLG9EQWdDQztBQTBLRCxrRUF3SEM7QUF1QkQsNEVBdURDO0FBWUQsOERBZ0ZDO0FBN3JCRCw2Q0FBd0U7QUFDeEUseURBQTREO0FBRTVELHVEQUF5QztBQUN6Qyx5Q0FBK0M7QUFDL0Msb0VBQW9FO0FBQ3BFLGlGQUFpRjtBQUNqRiw0Q0FBb0I7QUFFcEIsdUJBQVUsQ0FBQyxvQkFBb0IsR0FBRyxZQUFFLENBQUM7QUFFckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxtRUFBbUUsQ0FBQyxDQUFDO0FBQ3ZGLENBQUM7QUFFRCx5REFBeUQ7QUFDekQsOEJBQTJCO0FBRTNCOztHQUVHO0FBQ0gsSUFBWSxrQkFLWDtBQUxELFdBQVksa0JBQWtCO0lBQzVCLGlDQUFXLENBQUE7SUFDWCx1Q0FBaUIsQ0FBQTtJQUNqQixtQ0FBYSxDQUFBO0lBQ2IsMkNBQXFCLENBQUE7QUFDdkIsQ0FBQyxFQUxXLGtCQUFrQixrQ0FBbEIsa0JBQWtCLFFBSzdCO0FBY0Q7O0dBRUc7QUFDSCxNQUFNLFdBQVcsR0FBRztJQUNsQixpQkFBaUIsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxFQUFFLGNBQWM7SUFDakUsZUFBZSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsYUFBYTtJQUM3RCxtQkFBbUIsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFLG1CQUFtQjtJQUN2RSxlQUFlLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRSxh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bWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXV0aC9pbnZpdGF0aW9uLXJiYWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgZXEsIGFuZCwgb3IsIGRlc2MsIGd0ZSwgbHRlLCBzcWwsIGluQXJyYXkgfSBmcm9tICdkcml6emxlLW9ybSc7XG5pbXBvcnQgeyBQb29sLCBuZW9uQ29uZmlnIH0gZnJvbSAnQG5lb25kYXRhYmFzZS9zZXJ2ZXJsZXNzJztcbmltcG9ydCB7IGRyaXp6bGUgfSBmcm9tICdkcml6emxlLW9ybS9uZW9uLXNlcnZlcmxlc3MnO1xuaW1wb3J0ICogYXMgc2NoZW1hIGZyb20gJ0BzaGFyZWQvc2NoZW1hJztcbmltcG9ydCB7IGhhc1JvbGVPckhpZ2hlciB9IGZyb20gJy4uLy4uL2NvbmZpZyc7XG4vLyBEYXRhYmFzZS1iYXNlZCBwZXJtaXNzaW9uIGNoZWNraW5nIC0gbm8gY29uZmlnIHBlcm1pc3Npb25zIG5lZWRlZFxuLy8gTm90ZTogY3JlYXRlSW52aXRhdGlvbkF1ZGl0TG9nIHdpbGwgYmUgZGVmaW5lZCBsb2NhbGx5IG9yIGltcG9ydGVkIHdoZW4gbmVlZGVkXG5pbXBvcnQgd3MgZnJvbSAnd3MnO1xuXG5uZW9uQ29uZmlnLndlYlNvY2tldENvbnN0cnVjdG9yID0gd3M7XG5cbmlmICghcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMKSB7XG4gIHRocm93IG5ldyBFcnJvcignREFUQUJBU0VfVVJMIG11c3QgYmUgc2V0LiBEaWQgeW91IGZvcmdldCB0byBwcm92aXNpb24gYSBkYXRhYmFzZT8nKTtcbn1cblxuLy8gVXNlIHNoYXJlZCBkYXRhYmFzZSBjb25uZWN0aW9uIHRvIGF2b2lkIG11bHRpcGxlIHBvb2xzXG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uL2RiJztcblxuLyoqXG4gKiBTZWN1cml0eSBhbGVydCBsZXZlbHMgZm9yIGludml0YXRpb24gc3lzdGVtIG1vbml0b3JpbmcuXG4gKi9cbmV4cG9ydCBlbnVtIFNlY3VyaXR5QWxlcnRMZXZlbCB7XG4gIExPVyA9ICdsb3cnLFxuICBNRURJVU0gPSAnbWVkaXVtJyxcbiAgSElHSCA9ICdoaWdoJyxcbiAgQ1JJVElDQUwgPSAnY3JpdGljYWwnLFxufVxuXG4vKipcbiAqIEludGVyZmFjZSBmb3Igc2VjdXJpdHkgYWxlcnQgZGF0YS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWN1cml0eUFsZXJ0IHtcbiAgbGV2ZWw6IFNlY3VyaXR5QWxlcnRMZXZlbDtcbiAgdHlwZTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICB1c2VySWQ/OiBzdHJpbmc7XG4gIGlwQWRkcmVzcz86IHN0cmluZztcbiAgbWV0YWRhdGE/OiBhbnk7XG59XG5cbi8qKlxuICogUmF0ZSBsaW1pdGluZyBjb25maWd1cmF0aW9uIGZvciBpbnZpdGF0aW9uIG9wZXJhdGlvbnMuXG4gKi9cbmNvbnN0IFJBVEVfTElNSVRTID0ge1xuICBDUkVBVEVfSU5WSVRBVElPTjogeyBjb3VudDogMTAsIHdpbmRvdzogMzYwMDAwMCB9LCAvLyAxMCBwZXIgaG91clxuICBCVUxLX0lOVklUQVRJT046IHsgY291bnQ6IDMsIHdpbmRvdzogMzYwMDAwMCB9LCAvLyAzIHBlciBob3VyXG4gIFZBTElEQVRJT05fQVRURU1QVFM6IHsgY291bnQ6IDIwLCB3aW5kb3c6IDMwMDAwMCB9LCAvLyAyMCBwZXIgNSBtaW51dGVzXG4gIEFDQ0VQVF9BVFRFTVBUUzogeyBjb3VudDogNSwgd2luZG93OiAzNjAwMDAwIH0sIC8vIDUgcGVyIGhvdXJcbn07XG5cbi8qKlxuICogSW4tbWVtb3J5IHJhdGUgbGltaXRpbmcgc3RvcmUgKGluIHByb2R1Y3Rpb24sIHVzZSBSZWRpcykuXG4gKi9cbmNvbnN0IHJhdGVMaW1pdFN0b3JlID0gbmV3IE1hcDxzdHJpbmcsIHsgY291bnQ6IG51bWJlcjsgcmVzZXRUaW1lOiBudW1iZXIgfT4oKTtcblxuLyoqXG4gKiBFbmhhbmNlZCBzZWN1cml0eSBtb25pdG9yaW5nIGZvciBpbnZpdGF0aW9uIG9wZXJhdGlvbnMuXG4gKiBUcmFja3Mgc3VzcGljaW91cyBhY3Rpdml0aWVzIGFuZCBnZW5lcmF0ZXMgYWxlcnRzLlxuICovXG5leHBvcnQgY2xhc3MgSW52aXRhdGlvblNlY3VyaXR5TW9uaXRvciB7XG4gIHByaXZhdGUgc3RhdGljIGFsZXJ0Q2FsbGJhY2tzOiAoKGFsZXJ0OiBTZWN1cml0eUFsZXJ0KSA9PiB2b2lkKVtdID0gW107XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZvciBzZWN1cml0eSBhbGVydHMuXG4gICAqIEBwYXJhbSBjYWxsYmFja1xuICAgKi9cbiAgc3RhdGljIG9uQWxlcnQoY2FsbGJhY2s6IChhbGVydDogU2VjdXJpdHlBbGVydCkgPT4gdm9pZCkge1xuICAgIHRoaXMuYWxlcnRDYWxsYmFja3MucHVzaChjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogVHJpZ2dlciBhIHNlY3VyaXR5IGFsZXJ0LlxuICAgKiBAcGFyYW0gYWxlcnRcbiAgICovXG4gIHN0YXRpYyBhc3luYyB0cmlnZ2VyQWxlcnQoYWxlcnQ6IFNlY3VyaXR5QWxlcnQpIHtcbiAgICBjb25zb2xlLmxvZygn8J+aqCBTZWN1cml0eSBBbGVydDonLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYWxlcnQuZGVzY3JpcHRpb24sXG4gICAgICB1c2VySWQ6IGFsZXJ0LnVzZXJJZCxcbiAgICAgIGlwQWRkcmVzczogYWxlcnQuaXBBZGRyZXNzLFxuICAgICAgbWV0YWRhdGE6IGFsZXJ0Lm1ldGFkYXRhLFxuICAgIH0pO1xuXG4gICAgLy8gRXhlY3V0ZSBhbGVydCBjYWxsYmFja3NcbiAgICB0aGlzLmFsZXJ0Q2FsbGJhY2tzLmZvckVhY2goKGNhbGxiYWNrKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjYWxsYmFjayhhbGVydCk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBpbiBzZWN1cml0eSBhbGVydCBjYWxsYmFjazonLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBMb2cgc2VjdXJpdHkgYWxlcnQgdG8gZGF0YWJhc2VcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZGIuaW5zZXJ0KHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cpLnZhbHVlcyh7XG4gICAgICAgIGludml0YXRpb25JZDogYWxlcnQubWV0YWRhdGE/Lmludml0YXRpb25JZCB8fCBudWxsLFxuICAgICAgICBhY3Rpb246ICdzZWN1cml0eV9hbGVydCcsXG4gICAgICAgIHBlcmZvcm1lZEJ5OiBhbGVydC51c2VySWQgfHwgbnVsbCxcbiAgICAgICAgaXBBZGRyZXNzOiBhbGVydC5pcEFkZHJlc3MsXG4gICAgICAgIHVzZXJBZ2VudDogYWxlcnQubWV0YWRhdGE/LnVzZXJBZ2VudCxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIGFsZXJ0TGV2ZWw6IGFsZXJ0LmxldmVsLFxuICAgICAgICAgIGFsZXJ0VHlwZTogYWxlcnQudHlwZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYWxlcnQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgbWV0YWRhdGE6IGFsZXJ0Lm1ldGFkYXRhLFxuICAgICAgICB9LFxuICAgICAgICBwcmV2aW91c1N0YXR1czogbnVsbCxcbiAgICAgICAgbmV3U3RhdHVzOiBudWxsLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGxvZ2dpbmcgc2VjdXJpdHkgYWxlcnQgdG8gZGF0YWJhc2U6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNb25pdG9yIGludml0YXRpb24gYWNjZXNzIHBhdHRlcm5zIGZvciBzdXNwaWNpb3VzIGFjdGl2aXR5LlxuICAgKiBAcGFyYW0gdXNlcklkXG4gICAqIEBwYXJhbSBhY3Rpb25cbiAgICogQHBhcmFtIGlwQWRkcmVzc1xuICAgKiBAcGFyYW0gdXNlckFnZW50XG4gICAqIEBwYXJhbSBtZXRhZGF0YVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIG1vbml0b3JJbnZpdGF0aW9uQWNjZXNzKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGFjdGlvbjogc3RyaW5nLFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICAgbWV0YWRhdGE/OiBhbnlcbiAgKSB7XG4gICAgY29uc3Qga2V5ID0gYCR7dXNlcklkfToke2FjdGlvbn1gO1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3Qgd2luZG93U3RhcnQgPSBub3cgLSA1ICogNjAgKiAxMDAwOyAvLyA1IG1pbnV0ZXNcblxuICAgIC8vIENvdW50IHJlY2VudCBhY3Rpb25zXG4gICAgY29uc3QgcmVjZW50QWN0aW9ucyA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KHsgY291bnQ6IHNxbDxudW1iZXI+YGNvdW50KCopYCB9KVxuICAgICAgLmZyb20oc2NoZW1hLmludml0YXRpb25BdWRpdExvZylcbiAgICAgIC53aGVyZShcbiAgICAgICAgYW5kKFxuICAgICAgICAgIGVxKHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cucGVyZm9ybWVkQnksIHVzZXJJZCksXG4gICAgICAgICAgZXEoc2NoZW1hLmludml0YXRpb25BdWRpdExvZy5hY3Rpb24sIGFjdGlvbiksXG4gICAgICAgICAgZ3RlKHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cuY3JlYXRlZEF0LCBuZXcgRGF0ZSh3aW5kb3dTdGFydCkpXG4gICAgICAgIClcbiAgICAgICk7XG5cbiAgICBjb25zdCBhY3Rpb25Db3VudCA9IHJlY2VudEFjdGlvbnNbMF0/LmNvdW50IHx8IDA7XG5cbiAgICAvLyBDaGVjayBmb3Igc3VzcGljaW91cyBwYXR0ZXJuc1xuICAgIGlmIChhY3Rpb25Db3VudCA+IDEwKSB7XG4gICAgICBhd2FpdCB0aGlzLnRyaWdnZXJBbGVydCh7XG4gICAgICAgIGxldmVsOiBTZWN1cml0eUFsZXJ0TGV2ZWwuSElHSCxcbiAgICAgICAgdHlwZTogJ2V4Y2Vzc2l2ZV9pbnZpdGF0aW9uX2FjdGlvbnMnLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFVzZXIgJHt1c2VySWR9IHBlcmZvcm1lZCAke2FjdGlvbkNvdW50fSAke2FjdGlvbn0gYWN0aW9ucyBpbiA1IG1pbnV0ZXNgLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGlwQWRkcmVzcyxcbiAgICAgICAgbWV0YWRhdGE6IHsgYWN0aW9uLCBjb3VudDogYWN0aW9uQ291bnQsIHVzZXJBZ2VudCwgLi4ubWV0YWRhdGEgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBmYWlsZWQgaW52aXRhdGlvbiB2YWxpZGF0aW9uc1xuICAgIGlmIChhY3Rpb24gPT09ICd2YWxpZGF0aW9uX2ZhaWxlZCcgJiYgYWN0aW9uQ291bnQgPiA1KSB7XG4gICAgICBhd2FpdCB0aGlzLnRyaWdnZXJBbGVydCh7XG4gICAgICAgIGxldmVsOiBTZWN1cml0eUFsZXJ0TGV2ZWwuTUVESVVNLFxuICAgICAgICB0eXBlOiAnbXVsdGlwbGVfdmFsaWRhdGlvbl9mYWlsdXJlcycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgVXNlciAke3VzZXJJZH0gaGFkICR7YWN0aW9uQ291bnR9IGZhaWxlZCB0b2tlbiB2YWxpZGF0aW9uc2AsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgaXBBZGRyZXNzLFxuICAgICAgICBtZXRhZGF0YTogeyBhY3Rpb24sIGNvdW50OiBhY3Rpb25Db3VudCwgdXNlckFnZW50LCAuLi5tZXRhZGF0YSB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gTW9uaXRvciBJUC1iYXNlZCBwYXR0ZXJuc1xuICAgIGlmIChpcEFkZHJlc3MpIHtcbiAgICAgIGNvbnN0IGlwQWN0aW9ucyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoeyBjb3VudDogc3FsPG51bWJlcj5gY291bnQoKilgIH0pXG4gICAgICAgIC5mcm9tKHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cpXG4gICAgICAgIC53aGVyZShcbiAgICAgICAgICBhbmQoXG4gICAgICAgICAgICBlcShzY2hlbWEuaW52aXRhdGlvbkF1ZGl0TG9nLmlwQWRkcmVzcywgaXBBZGRyZXNzKSxcbiAgICAgICAgICAgIGVxKHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cuYWN0aW9uLCBhY3Rpb24pLFxuICAgICAgICAgICAgZ3RlKHNjaGVtYS5pbnZpdGF0aW9uQXVkaXRMb2cuY3JlYXRlZEF0LCBuZXcgRGF0ZSh3aW5kb3dTdGFydCkpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICBjb25zdCBpcEFjdGlvbkNvdW50ID0gaXBBY3Rpb25zWzBdPy5jb3VudCB8fCAwO1xuXG4gICAgICBpZiAoaXBBY3Rpb25Db3VudCA+IDIwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudHJpZ2dlckFsZXJ0KHtcbiAgICAgICAgICBsZXZlbDogU2VjdXJpdHlBbGVydExldmVsLkNSSVRJQ0FMLFxuICAgICAgICAgIHR5cGU6ICdpcF9iYXNlZF9hdHRhY2snLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgSVAgJHtpcEFkZHJlc3N9IHBlcmZvcm1lZCAke2lwQWN0aW9uQ291bnR9ICR7YWN0aW9ufSBhY3Rpb25zIGluIDUgbWludXRlc2AsXG4gICAgICAgICAgaXBBZGRyZXNzLFxuICAgICAgICAgIG1ldGFkYXRhOiB7IGFjdGlvbiwgY291bnQ6IGlwQWN0aW9uQ291bnQsIHVzZXJBZ2VudCwgLi4ubWV0YWRhdGEgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogUmF0ZSBsaW1pdGluZyBtaWRkbGV3YXJlIGZvciBpbnZpdGF0aW9uIG9wZXJhdGlvbnMuXG4gKiBAcGFyYW0gbWF4UmVxdWVzdHNcbiAqIEBwYXJhbSB3aW5kb3dNc1xuICovXG4vKipcbiAqIFJhdGVMaW1pdEludml0YXRpb25zIGZ1bmN0aW9uLlxuICogQHBhcmFtIG1heFJlcXVlc3RzXG4gKiBAcGFyYW0gd2luZG93TXNcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJhdGVMaW1pdEludml0YXRpb25zKG1heFJlcXVlc3RzOiBudW1iZXIsIHdpbmRvd01zOiBudW1iZXIgPSAzNjAwMDAwKSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBjb25zdCBrZXkgPSBgJHtyZXEudXNlcj8uaWQgfHwgcmVxLmlwfToke3JlcS5tZXRob2R9OiR7cmVxLnBhdGh9YDtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgY29uc3QgY3VycmVudCA9IHJhdGVMaW1pdFN0b3JlLmdldChrZXkpO1xuXG4gICAgaWYgKCFjdXJyZW50IHx8IG5vdyA+IGN1cnJlbnQucmVzZXRUaW1lKSB7XG4gICAgICByYXRlTGltaXRTdG9yZS5zZXQoa2V5LCB7IGNvdW50OiAxLCByZXNldFRpbWU6IG5vdyArIHdpbmRvd01zIH0pO1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudC5jb3VudCA+PSBtYXhSZXF1ZXN0cykge1xuICAgICAgLy8gTG9nIHJhdGUgbGltaXQgZXhjZWVkZWRcbiAgICAgIEludml0YXRpb25TZWN1cml0eU1vbml0b3IubW9uaXRvckludml0YXRpb25BY2Nlc3MoXG4gICAgICAgIHJlcS51c2VyPy5pZCB8fCAnYW5vbnltb3VzJyxcbiAgICAgICAgJ3JhdGVfbGltaXRfZXhjZWVkZWQnLFxuICAgICAgICByZXEuaXAsXG4gICAgICAgIHJlcS5nZXQoJ1VzZXItQWdlbnQnKSxcbiAgICAgICAgeyBwYXRoOiByZXEucGF0aCwgbWV0aG9kOiByZXEubWV0aG9kIH1cbiAgICAgICk7XG5cbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQyOSkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdSYXRlIGxpbWl0IGV4Y2VlZGVkJyxcbiAgICAgICAgY29kZTogJ1JBVEVfTElNSVRfRVhDRUVERUQnLFxuICAgICAgICByZXRyeUFmdGVyOiBNYXRoLmNlaWwoKGN1cnJlbnQucmVzZXRUaW1lIC0gbm93KSAvIDEwMDApLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY3VycmVudC5jb3VudCsrO1xuICAgIG5leHQoKTtcbiAgfTtcbn1cblxuLyoqXG4gKiBEYXRhYmFzZS1sZXZlbCBwZXJtaXNzaW9uIHZhbGlkYXRpb24gZm9yIGludml0YXRpb24gb3BlcmF0aW9ucy5cbiAqL1xuZXhwb3J0IGNsYXNzIEludml0YXRpb25QZXJtaXNzaW9uVmFsaWRhdG9yIHtcbiAgLyoqXG4gICAqIFZhbGlkYXRlIGlmIHVzZXIgY2FuIGludml0ZSBiYXNlZCBvbiByb2xlIGhpZXJhcmNoeSBhbmQgb3JnYW5pemF0aW9uIGNvbnRleHQuXG4gICAqIEBwYXJhbSBpbnZpdGVySWRcbiAgICogQHBhcmFtIGludml0ZXJSb2xlXG4gICAqIEBwYXJhbSB0YXJnZXRSb2xlXG4gICAqIEBwYXJhbSBvcmdhbml6YXRpb25JZFxuICAgKiBAcGFyYW0gYnVpbGRpbmdJZFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHZhbGlkYXRlSW52aXRlUGVybWlzc2lvbihcbiAgICBpbnZpdGVySWQ6IHN0cmluZyxcbiAgICBpbnZpdGVyUm9sZTogc3RyaW5nLFxuICAgIHRhcmdldFJvbGU6IHN0cmluZyxcbiAgICBvcmdhbml6YXRpb25JZD86IHN0cmluZyxcbiAgICBidWlsZGluZ0lkPzogc3RyaW5nXG4gICk6IFByb21pc2U8eyB2YWxpZDogYm9vbGVhbjsgcmVhc29uPzogc3RyaW5nIH0+IHtcbiAgICAvLyBBZG1pbiBjYW4gaW52aXRlIGFueW9uZVxuICAgIGlmIChpbnZpdGVyUm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUgfTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayByb2xlIGhpZXJhcmNoeVxuICAgIGlmICghaGFzUm9sZU9ySGlnaGVyKGludml0ZXJSb2xlIGFzIGFueSwgJ21hbmFnZXInKSkge1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICdJbnN1ZmZpY2llbnQgcm9sZSBwcml2aWxlZ2VzIHRvIGludml0ZSB1c2VycycgfTtcbiAgICB9XG5cbiAgICAvLyBNYW5hZ2VyIHJlc3RyaWN0aW9uczogY2FuIGludml0ZSByZXNpZGVudCwgbWFuYWdlciwgdGVuYW50IHdpdGhpbiB0aGVpciBvcmdhbml6YXRpb25cbiAgICBpZiAoaW52aXRlclJvbGUgPT09ICdtYW5hZ2VyJykge1xuICAgICAgLy8gTWFuYWdlcnMgY2FuIGludml0ZSByZXNpZGVudCwgbWFuYWdlciwgdGVuYW50IChidXQgbm90IGFkbWluKVxuICAgICAgaWYgKCFbJ3Jlc2lkZW50JywgJ21hbmFnZXInLCAndGVuYW50J10uaW5jbHVkZXModGFyZ2V0Um9sZSkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgcmVhc29uOiAnTWFuYWdlcnMgY2FuIG9ubHkgaW52aXRlIHJlc2lkZW50LCBtYW5hZ2VyLCBhbmQgdGVuYW50IHJvbGVzJyxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gT3JnYW5pemF0aW9uIHZhbGlkYXRpb24gLSBtYW5hZ2VycyBjYW4gb25seSBpbnZpdGUgd2l0aGluIHRoZWlyIG9yZ2FuaXphdGlvblxuICAgICAgaWYgKG9yZ2FuaXphdGlvbklkKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSBpbnZpdGVyIGJlbG9uZ3MgdG8gdGhlIHNwZWNpZmllZCBvcmdhbml6YXRpb25cbiAgICAgICAgY29uc3QgaW52aXRlck9yZ2FuaXphdGlvbiA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgICAgLmZyb20oc2NoZW1hLnVzZXJzKVxuICAgICAgICAgIC5sZWZ0Sm9pbihzY2hlbWEuYnVpbGRpbmdzLCBlcShzY2hlbWEuYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25JZCkpXG4gICAgICAgICAgLmxlZnRKb2luKHNjaGVtYS5yZXNpZGVuY2VzLCBlcShzY2hlbWEucmVzaWRlbmNlcy5idWlsZGluZ0lkLCBzY2hlbWEuYnVpbGRpbmdzLmlkKSlcbiAgICAgICAgICAubGVmdEpvaW4oXG4gICAgICAgICAgICBzY2hlbWEudXNlclJlc2lkZW5jZXMsXG4gICAgICAgICAgICBlcShzY2hlbWEudXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIHNjaGVtYS5yZXNpZGVuY2VzLmlkKVxuICAgICAgICAgIClcbiAgICAgICAgICAud2hlcmUoYW5kKGVxKHNjaGVtYS51c2Vycy5pZCwgaW52aXRlcklkKSwgZXEoc2NoZW1hLnVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgaW52aXRlcklkKSkpXG4gICAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICAgIGlmIChpbnZpdGVyT3JnYW5pemF0aW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgICByZWFzb246ICdNYW5hZ2VycyBjYW4gb25seSBpbnZpdGUgdXNlcnMgdG8gdGhlaXIgb3duIG9yZ2FuaXphdGlvbicsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICdPcmdhbml6YXRpb24gSUQgaXMgcmVxdWlyZWQgZm9yIG1hbmFnZXIgaW52aXRhdGlvbnMnIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBpZiB1c2VyIGNhbiBtYW5hZ2Ugc3BlY2lmaWMgaW52aXRhdGlvbi5cbiAgICogQHBhcmFtIHVzZXJJZFxuICAgKiBAcGFyYW0gdXNlclJvbGVcbiAgICogQHBhcmFtIGludml0YXRpb25JZFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHZhbGlkYXRlSW52aXRhdGlvbk1hbmFnZW1lbnQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgdXNlclJvbGU6IHN0cmluZyxcbiAgICBpbnZpdGF0aW9uSWQ6IHN0cmluZ1xuICApOiBQcm9taXNlPHsgdmFsaWQ6IGJvb2xlYW47IHJlYXNvbj86IHN0cmluZyB9PiB7XG4gICAgLy8gQWRtaW4gY2FuIG1hbmFnZSBhbnkgaW52aXRhdGlvblxuICAgIGlmICh1c2VyUm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUgfTtcbiAgICB9XG5cbiAgICAvLyBHZXQgaW52aXRhdGlvbiBkZXRhaWxzXG4gICAgY29uc3QgW2ludml0YXRpb25dID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oc2NoZW1hLmludml0YXRpb25zKVxuICAgICAgLndoZXJlKGVxKHNjaGVtYS5pbnZpdGF0aW9ucy5pZCwgaW52aXRhdGlvbklkKSlcbiAgICAgIC5saW1pdCgxKTtcblxuICAgIGlmICghaW52aXRhdGlvbikge1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCByZWFzb246ICdJbnZpdGF0aW9uIG5vdCBmb3VuZCcgfTtcbiAgICB9XG5cbiAgICAvLyBVc2VycyBjYW4gb25seSBtYW5hZ2UgdGhlaXIgb3duIGludml0YXRpb25zXG4gICAgaWYgKGludml0YXRpb24uaW52aXRlZEJ5ICE9PSB1c2VySWQpIHtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgcmVhc29uOiAnQ2FuIG9ubHkgbWFuYWdlIG93biBpbnZpdGF0aW9ucycgfTtcbiAgICB9XG5cbiAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGJ1bGsgaW52aXRhdGlvbiBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBpbnZpdGVySWRcbiAgICogQHBhcmFtIGludml0ZXJSb2xlXG4gICAqIEBwYXJhbSBpbnZpdGF0aW9uc1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIHZhbGlkYXRlQnVsa0ludml0YXRpb24oXG4gICAgaW52aXRlcklkOiBzdHJpbmcsXG4gICAgaW52aXRlclJvbGU6IHN0cmluZyxcbiAgICBpbnZpdGF0aW9uczogeyByb2xlOiBzdHJpbmc7IG9yZ2FuaXphdGlvbklkPzogc3RyaW5nOyBidWlsZGluZ0lkPzogc3RyaW5nIH1bXVxuICApOiBQcm9taXNlPHsgdmFsaWQ6IGJvb2xlYW47IHJlYXNvbj86IHN0cmluZzsgaW52YWxpZEludml0YXRpb25zPzogbnVtYmVyW10gfT4ge1xuICAgIGNvbnN0IGludmFsaWRJbnZpdGF0aW9uczogbnVtYmVyW10gPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW52aXRhdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGludml0YXRpb24gPSBpbnZpdGF0aW9uc1tpXTtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnZhbGlkYXRlSW52aXRlUGVybWlzc2lvbihcbiAgICAgICAgaW52aXRlcklkLFxuICAgICAgICBpbnZpdGVyUm9sZSxcbiAgICAgICAgaW52aXRhdGlvbi5yb2xlLFxuICAgICAgICBpbnZpdGF0aW9uLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICBpbnZpdGF0aW9uLmJ1aWxkaW5nSWRcbiAgICAgICk7XG5cbiAgICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgICBpbnZhbGlkSW52aXRhdGlvbnMucHVzaChpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaW52YWxpZEludml0YXRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgcmVhc29uOiBgJHtpbnZhbGlkSW52aXRhdGlvbnMubGVuZ3RofSBpbnZpdGF0aW9ucyB2aW9sYXRlIHBlcm1pc3Npb24gcnVsZXNgLFxuICAgICAgICBpbnZhbGlkSW52aXRhdGlvbnMsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IHZhbGlkOiB0cnVlIH07XG4gIH1cbn1cblxuLyoqXG4gKiBFbmhhbmNlZCBSQkFDIG1pZGRsZXdhcmUgc3BlY2lmaWNhbGx5IGZvciBpbnZpdGF0aW9uIG9wZXJhdGlvbnMuXG4gKiBDb21iaW5lcyByb2xlLWJhc2VkIHBlcm1pc3Npb25zIHdpdGggY29udGV4dC1hd2FyZSB2YWxpZGF0aW9uLlxuICogQHBhcmFtIGFjdGlvblxuICogQHBhcmFtIF9vcHRpb25zXG4gKiBAcGFyYW0gX29wdGlvbnMudmFsaWRhdGVDb250ZXh0XG4gKiBAcGFyYW0gX29wdGlvbnMucmVxdWlyZU93bmVyc2hpcFxuICogQHBhcmFtIF9vcHRpb25zLmFsbG93U2VsZkFjY2Vzc1xuICogQHBhcmFtIF9vcHRpb25zLmF1ZGl0QWN0aW9uXG4gKi9cbi8qKlxuICogUmVxdWlyZUludml0YXRpb25QZXJtaXNzaW9uIGZ1bmN0aW9uLlxuICogQHBhcmFtIGFjdGlvblxuICogQHBhcmFtIF9vcHRpb25zXG4gKiBAcGFyYW0gX29wdGlvbnMudmFsaWRhdGVDb250ZXh0XG4gKiBAcGFyYW0gX29wdGlvbnMucmVxdWlyZU93bmVyc2hpcFxuICogQHBhcmFtIF9vcHRpb25zLmFsbG93U2VsZkFjY2Vzc1xuICogQHBhcmFtIF9vcHRpb25zLmF1ZGl0QWN0aW9uXG4gKiBAcGFyYW0gX19vcHRpb25zXG4gKiBAcGFyYW0gX19vcHRpb25zLnZhbGlkYXRlQ29udGV4dFxuICogQHBhcmFtIF9fb3B0aW9ucy5yZXF1aXJlT3duZXJzaGlwXG4gKiBAcGFyYW0gX19vcHRpb25zLmFsbG93U2VsZkFjY2Vzc1xuICogQHBhcmFtIF9fb3B0aW9ucy5hdWRpdEFjdGlvblxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZUludml0YXRpb25QZXJtaXNzaW9uKFxuICBhY3Rpb246IHN0cmluZyxcbiAgX19vcHRpb25zOiB7XG4gICAgdmFsaWRhdGVDb250ZXh0PzogYm9vbGVhbjtcbiAgICByZXF1aXJlT3duZXJzaGlwPzogYm9vbGVhbjtcbiAgICBhbGxvd1NlbGZBY2Nlc3M/OiBib29sZWFuO1xuICAgIGF1ZGl0QWN0aW9uPzogc3RyaW5nO1xuICB9ID0ge31cbikge1xuICByZXR1cm4gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgaWYgKCFyZXEudXNlcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGJhc2ljIHBlcm1pc3Npb24gYmFzZWQgb24gcm9sZSBoaWVyYXJjaHlcbiAgICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBoYXNSb2xlT3JIaWdoZXIocmVxLnVzZXIucm9sZSBhcyBhbnksICdtYW5hZ2VyJyBhcyBhbnkpO1xuXG4gICAgICBpZiAoIWhhc1Blcm1pc3Npb24pIHtcbiAgICAgICAgYXdhaXQgSW52aXRhdGlvblNlY3VyaXR5TW9uaXRvci50cmlnZ2VyQWxlcnQoe1xuICAgICAgICAgIGxldmVsOiBTZWN1cml0eUFsZXJ0TGV2ZWwuTUVESVVNLFxuICAgICAgICAgIHR5cGU6ICdwZXJtaXNzaW9uX2RlbmllZCcsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGBVc2VyICR7cmVxLnVzZXIuaWR9ICgke3JlcS51c2VyLnJvbGV9KSBhdHRlbXB0ZWQgdW5hdXRob3JpemVkIGFjdGlvbjogJHthY3Rpb259YCxcbiAgICAgICAgICB1c2VySWQ6IHJlcS51c2VyLmlkLFxuICAgICAgICAgIGlwQWRkcmVzczogcmVxLmlwLFxuICAgICAgICAgIG1ldGFkYXRhOiB7IGFjdGlvbiwgcGF0aDogcmVxLnBhdGgsIG1ldGhvZDogcmVxLm1ldGhvZCB9LFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMnLFxuICAgICAgICAgIGNvZGU6ICdQRVJNSVNTSU9OX0RFTklFRCcsXG4gICAgICAgICAgcmVxdWlyZWQ6IGFjdGlvbixcbiAgICAgICAgICB1c2VyUm9sZTogcmVxLnVzZXIucm9sZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbnRleHQtYXdhcmUgdmFsaWRhdGlvbiBmb3Igc3BlY2lmaWMgb3BlcmF0aW9uc1xuICAgICAgaWYgKF9vcHRpb25zLnZhbGlkYXRlQ29udGV4dCAmJiByZXEuYm9keSkge1xuICAgICAgICBpZiAoYWN0aW9uID09PSAnY3JlYXRlOmludml0YXRpb24nKSB7XG4gICAgICAgICAgY29uc3QgeyByb2xlLCBvcmdhbml6YXRpb25JZCwgYnVpbGRpbmdJZCB9ID0gcmVxLmJvZHk7XG4gICAgICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGF3YWl0IEludml0YXRpb25QZXJtaXNzaW9uVmFsaWRhdG9yLnZhbGlkYXRlSW52aXRlUGVybWlzc2lvbihcbiAgICAgICAgICAgIHJlcS51c2VyLmlkLFxuICAgICAgICAgICAgcmVxLnVzZXIucm9sZSxcbiAgICAgICAgICAgIHJvbGUsXG4gICAgICAgICAgICBvcmdhbml6YXRpb25JZCxcbiAgICAgICAgICAgIGJ1aWxkaW5nSWRcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKCF2YWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICAgICAgICBhd2FpdCBJbnZpdGF0aW9uU2VjdXJpdHlNb25pdG9yLnRyaWdnZXJBbGVydCh7XG4gICAgICAgICAgICAgIGxldmVsOiBTZWN1cml0eUFsZXJ0TGV2ZWwuSElHSCxcbiAgICAgICAgICAgICAgdHlwZTogJ2NvbnRleHRfcGVybWlzc2lvbl92aW9sYXRpb24nLFxuICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYFVzZXIgJHtyZXEudXNlci5pZH0gdmlvbGF0ZWQgY29udGV4dCBwZXJtaXNzaW9uOiAke3ZhbGlkYXRpb24ucmVhc29ufWAsXG4gICAgICAgICAgICAgIHVzZXJJZDogcmVxLnVzZXIuaWQsXG4gICAgICAgICAgICAgIGlwQWRkcmVzczogcmVxLmlwLFxuICAgICAgICAgICAgICBtZXRhZGF0YTogeyBhY3Rpb24sIHJlYXNvbjogdmFsaWRhdGlvbi5yZWFzb24sIHRhcmdldFJvbGU6IHJvbGUgfSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgICAgICBtZXNzYWdlOiB2YWxpZGF0aW9uLnJlYXNvbiB8fCAnQ29udGV4dCBwZXJtaXNzaW9uIGRlbmllZCcsXG4gICAgICAgICAgICAgIGNvZGU6ICdDT05URVhUX1BFUk1JU1NJT05fREVOSUVEJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhY3Rpb24gPT09ICdidWxrOmludml0YXRpb24nKSB7XG4gICAgICAgICAgY29uc3QgeyBpbnZpdGF0aW9ucyB9ID0gcmVxLmJvZHk7XG4gICAgICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGF3YWl0IEludml0YXRpb25QZXJtaXNzaW9uVmFsaWRhdG9yLnZhbGlkYXRlQnVsa0ludml0YXRpb24oXG4gICAgICAgICAgICByZXEudXNlci5pZCxcbiAgICAgICAgICAgIHJlcS51c2VyLnJvbGUsXG4gICAgICAgICAgICBpbnZpdGF0aW9uc1xuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAoIXZhbGlkYXRpb24udmFsaWQpIHtcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IHZhbGlkYXRpb24ucmVhc29uIHx8ICdCdWxrIGludml0YXRpb24gcGVybWlzc2lvbiBkZW5pZWQnLFxuICAgICAgICAgICAgICBjb2RlOiAnQlVMS19QRVJNSVNTSU9OX0RFTklFRCcsXG4gICAgICAgICAgICAgIGludmFsaWRJbnZpdGF0aW9uczogdmFsaWRhdGlvbi5pbnZhbGlkSW52aXRhdGlvbnMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gT3duZXJzaGlwIHZhbGlkYXRpb24gZm9yIG1hbmFnZW1lbnQgb3BlcmF0aW9uc1xuICAgICAgaWYgKF9vcHRpb25zLnJlcXVpcmVPd25lcnNoaXAgJiYgcmVxLnBhcmFtcy5pZCkge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgSW52aXRhdGlvblBlcm1pc3Npb25WYWxpZGF0b3IudmFsaWRhdGVJbnZpdGF0aW9uTWFuYWdlbWVudChcbiAgICAgICAgICByZXEudXNlci5pZCxcbiAgICAgICAgICByZXEudXNlci5yb2xlLFxuICAgICAgICAgIHJlcS5wYXJhbXMuaWRcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoIXZhbGlkYXRpb24udmFsaWQpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogdmFsaWRhdGlvbi5yZWFzb24gfHwgJ05vdCBhdXRob3JpemVkIHRvIG1hbmFnZSB0aGlzIGludml0YXRpb24nLFxuICAgICAgICAgICAgY29kZTogJ09XTkVSU0hJUF9SRVFVSVJFRCcsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gTW9uaXRvciBpbnZpdGF0aW9uIGFjY2Vzc1xuICAgICAgYXdhaXQgSW52aXRhdGlvblNlY3VyaXR5TW9uaXRvci5tb25pdG9ySW52aXRhdGlvbkFjY2VzcyhcbiAgICAgICAgcmVxLnVzZXIuaWQsXG4gICAgICAgIF9vcHRpb25zLmF1ZGl0QWN0aW9uIHx8IGFjdGlvbixcbiAgICAgICAgcmVxLmlwLFxuICAgICAgICByZXEuZ2V0KCdVc2VyLUFnZW50JyksXG4gICAgICAgIHsgcGF0aDogcmVxLnBhdGgsIG1ldGhvZDogcmVxLm1ldGhvZCB9XG4gICAgICApO1xuXG4gICAgICBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIFBlcm1pc3Npb24gdmFsaWRhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1Blcm1pc3Npb24gdmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICBjb2RlOiAnUkJBQ19FUlJPUicsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogRW5oYW5jZWQgYXVkaXQgbG9nZ2luZyBmb3IgaW52aXRhdGlvbiBvcGVyYXRpb25zLlxuICogQHBhcmFtIGludml0YXRpb25JZFxuICogQHBhcmFtIGFjdGlvblxuICogQHBhcmFtIHBlcmZvcm1lZEJ5XG4gKiBAcGFyYW0gcmVxXG4gKiBAcGFyYW0gcHJldmlvdXNTdGF0dXNcbiAqIEBwYXJhbSBuZXdTdGF0dXNcbiAqIEBwYXJhbSBkZXRhaWxzXG4gKi9cbi8qKlxuICogQ3JlYXRlRW5oYW5jZWRJbnZpdGF0aW9uQXVkaXRMb2cgZnVuY3Rpb24uXG4gKiBAcGFyYW0gaW52aXRhdGlvbklkXG4gKiBAcGFyYW0gYWN0aW9uXG4gKiBAcGFyYW0gcGVyZm9ybWVkQnlcbiAqIEBwYXJhbSByZXFcbiAqIEBwYXJhbSBwcmV2aW91c1N0YXR1c1xuICogQHBhcmFtIG5ld1N0YXR1c1xuICogQHBhcmFtIGRldGFpbHNcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUVuaGFuY2VkSW52aXRhdGlvbkF1ZGl0TG9nKFxuICBpbnZpdGF0aW9uSWQ6IHN0cmluZyxcbiAgYWN0aW9uOiBzdHJpbmcsXG4gIHBlcmZvcm1lZEJ5OiBzdHJpbmcgfCBudWxsLFxuICByZXE6IFJlcXVlc3QsXG4gIHByZXZpb3VzU3RhdHVzPzogc3RyaW5nLFxuICBuZXdTdGF0dXM/OiBzdHJpbmcsXG4gIGRldGFpbHM/OiBhbnlcbikge1xuICB0cnkge1xuICAgIC8vIEdldCBhZGRpdGlvbmFsIGNvbnRleHRcbiAgICBjb25zdCBpcEFkZHJlc3MgPSByZXEuaXAgfHwgcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyB8fCAndW5rbm93bic7XG4gICAgY29uc3QgdXNlckFnZW50ID0gcmVxLmdldCgnVXNlci1BZ2VudCcpIHx8ICd1bmtub3duJztcbiAgICBjb25zdCByZWZlcnJlciA9IHJlcS5nZXQoJ1JlZmVyZXInKTtcbiAgICBjb25zdCBmb3J3YXJkZWRGb3IgPSByZXEuZ2V0KCdYLUZvcndhcmRlZC1Gb3InKTtcblxuICAgIC8vIEVuaGFuY2VkIGRldGFpbHMgd2l0aCBzZWN1cml0eSBjb250ZXh0XG4gICAgY29uc3QgZW5oYW5jZWREZXRhaWxzID0ge1xuICAgICAgLi4uZGV0YWlscyxcbiAgICAgIHNlY3VyaXR5OiB7XG4gICAgICAgIGlwQWRkcmVzcyxcbiAgICAgICAgdXNlckFnZW50LFxuICAgICAgICByZWZlcnJlcixcbiAgICAgICAgZm9yd2FyZGVkRm9yLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgc2Vzc2lvbklkOiByZXEuc2Vzc2lvbklELFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgLy8gQ3JlYXRlIGF1ZGl0IGxvZyBlbnRyeVxuICAgIGF3YWl0IGRiLmluc2VydChzY2hlbWEuaW52aXRhdGlvbkF1ZGl0TG9nKS52YWx1ZXMoW1xuICAgICAge1xuICAgICAgICBpbnZpdGF0aW9uSWQsXG4gICAgICAgIGFjdGlvbixcbiAgICAgICAgcGVyZm9ybWVkQnksXG4gICAgICAgIGlwQWRkcmVzcyxcbiAgICAgICAgdXNlckFnZW50LFxuICAgICAgICBkZXRhaWxzOiBlbmhhbmNlZERldGFpbHMsXG4gICAgICAgIHByZXZpb3VzU3RhdHVzOiBwcmV2aW91c1N0YXR1cyBhcyBhbnksXG4gICAgICAgIG5ld1N0YXR1czogbmV3U3RhdHVzIGFzIGFueSxcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICAvLyBMb2cgdG8gY29uc29sZSBmb3IgaW1tZWRpYXRlIHZpc2liaWxpdHlcbiAgICBjb25zb2xlLmxvZygn8J+TnSBFbmhhbmNlZCBpbnZpdGF0aW9uIGF1ZGl0IGxvZyBjcmVhdGVkOicsIHtcbiAgICAgIGludml0YXRpb25JZCxcbiAgICAgIHBlcmZvcm1lZEJ5LFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgYWN0aW9uLFxuICAgICAgcHJldmlvdXNTdGF0dXMsXG4gICAgICBuZXdTdGF0dXMsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgY3JlYXRpbmcgZW5oYW5jZWQgaW52aXRhdGlvbiBhdWRpdCBsb2c6JywgZXJyb3IpO1xuICB9XG59XG5cbi8qKlxuICogRGVsZWdhdGlvbiBhbmQgaW5oZXJpdGFuY2UgbWlkZGxld2FyZSBmb3IgaW52aXRhdGlvbiBwZXJtaXNzaW9ucy5cbiAqIEFsbG93cyB0ZW1wb3JhcnkgcGVybWlzc2lvbiBlbGV2YXRpb24gYmFzZWQgb24gb3JnYW5pemF0aW9uYWwgaGllcmFyY2h5LlxuICogQHBhcmFtIGJhc2VBY3Rpb25cbiAqL1xuLyoqXG4gKiBXaXRoUGVybWlzc2lvbkluaGVyaXRhbmNlIGZ1bmN0aW9uLlxuICogQHBhcmFtIGJhc2VBY3Rpb25cbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHdpdGhQZXJtaXNzaW9uSW5oZXJpdGFuY2UoYmFzZUFjdGlvbjogc3RyaW5nKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBpZiAoIXJlcS51c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgZGlyZWN0IHBlcm1pc3Npb24gYmFzZWQgb24gcm9sZSBoaWVyYXJjaHlcbiAgICAgIGNvbnN0IGhhc0RpcmVjdFBlcm1pc3Npb24gPSBoYXNSb2xlT3JIaWdoZXIocmVxLnVzZXIucm9sZSBhcyBhbnksICdtYW5hZ2VyJyBhcyBhbnkpO1xuXG4gICAgICBpZiAoaGFzRGlyZWN0UGVybWlzc2lvbikge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgZGVsZWdhdGVkIHBlcm1pc3Npb25zIGJhc2VkIG9uIG9yZ2FuaXphdGlvbmFsIGNvbnRleHRcbiAgICAgIGlmIChyZXEuYm9keT8ub3JnYW5pemF0aW9uSWQgfHwgcmVxLnBhcmFtcy5vcmdhbml6YXRpb25JZCkge1xuICAgICAgICBjb25zdCBvcmdJZCA9IHJlcS5ib2R5Py5vcmdhbml6YXRpb25JZCB8fCByZXEucGFyYW1zLm9yZ2FuaXphdGlvbklkO1xuXG4gICAgICAgIC8vIENoZWNrIGlmIHVzZXIgaGFzIGVsZXZhdGVkIHBlcm1pc3Npb25zIGluIHRoaXMgb3JnYW5pemF0aW9uXG4gICAgICAgIGNvbnN0IHVzZXJPcmdSb2xlID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgICAuZnJvbShzY2hlbWEudXNlcnMpXG4gICAgICAgICAgLmxlZnRKb2luKHNjaGVtYS5idWlsZGluZ3MsIGVxKHNjaGVtYS5idWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ0lkKSlcbiAgICAgICAgICAubGVmdEpvaW4oc2NoZW1hLnJlc2lkZW5jZXMsIGVxKHNjaGVtYS5yZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIHNjaGVtYS5idWlsZGluZ3MuaWQpKVxuICAgICAgICAgIC5sZWZ0Sm9pbihcbiAgICAgICAgICAgIHNjaGVtYS51c2VyUmVzaWRlbmNlcyxcbiAgICAgICAgICAgIGVxKHNjaGVtYS51c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgc2NoZW1hLnJlc2lkZW5jZXMuaWQpXG4gICAgICAgICAgKVxuICAgICAgICAgIC53aGVyZShcbiAgICAgICAgICAgIGFuZChcbiAgICAgICAgICAgICAgZXEoc2NoZW1hLnVzZXJzLmlkLCByZXEudXNlci5pZCksXG4gICAgICAgICAgICAgIGVxKHNjaGVtYS51c2VyUmVzaWRlbmNlcy5yZWxhdGlvbnNoaXBUeXBlLCAnb3duZXInKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgICAubGltaXQoMSk7XG5cbiAgICAgICAgLy8gT3duZXJzIGluIGFuIG9yZ2FuaXphdGlvbiBnZXQgZWxldmF0ZWQgcGVybWlzc2lvbnMgZm9yIHRlbmFudCBtYW5hZ2VtZW50XG4gICAgICAgIGlmICh1c2VyT3JnUm9sZS5sZW5ndGggPiAwICYmIGJhc2VBY3Rpb24gPT09ICdjcmVhdGU6aW52aXRhdGlvbicpIHtcbiAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgSW52aXRhdGlvblBlcm1pc3Npb25WYWxpZGF0b3IudmFsaWRhdGVJbnZpdGVQZXJtaXNzaW9uKFxuICAgICAgICAgICAgcmVxLnVzZXIuaWQsXG4gICAgICAgICAgICAnbWFuYWdlcicsIC8vIFRlbXBvcmFyaWx5IGVsZXZhdGUgdG8gbWFuYWdlciBwZXJtaXNzaW9uc1xuICAgICAgICAgICAgcmVxLmJvZHk/LnJvbGUsXG4gICAgICAgICAgICBvcmdJZCxcbiAgICAgICAgICAgIHJlcS5ib2R5Py5idWlsZGluZ0lkXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmICh2YWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICAgICAgICAvLyBMb2cgcGVybWlzc2lvbiBpbmhlcml0YW5jZVxuICAgICAgICAgICAgYXdhaXQgY3JlYXRlRW5oYW5jZWRJbnZpdGF0aW9uQXVkaXRMb2coXG4gICAgICAgICAgICAgIHJlcS5ib2R5Py5pbnZpdGF0aW9uSWQgfHwgJ3Vua25vd24nLFxuICAgICAgICAgICAgICAncGVybWlzc2lvbl9pbmhlcml0ZWQnLFxuICAgICAgICAgICAgICByZXEudXNlci5pZCxcbiAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgeyBiYXNlQWN0aW9uLCBpbmhlcml0ZWRMZXZlbDogJ21hbmFnZXInLCByZWFzb246ICdvcmdhbml6YXRpb25hbF9vd25lcicgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycsXG4gICAgICAgIGNvZGU6ICdQRVJNSVNTSU9OX0RFTklFRCcsXG4gICAgICAgIHJlcXVpcmVkOiBiYXNlQWN0aW9uLFxuICAgICAgICB1c2VyUm9sZTogcmVxLnVzZXIucm9sZSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBQZXJtaXNzaW9uIGluaGVyaXRhbmNlIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnUGVybWlzc2lvbiB2YWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdJTkhFUklUQU5DRV9FUlJPUicsXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG5cbi8vIEluaXRpYWxpemUgc2VjdXJpdHkgbW9uaXRvcmluZ1xuSW52aXRhdGlvblNlY3VyaXR5TW9uaXRvci5vbkFsZXJ0KChhbGVydCkgPT4ge1xuICAvLyBJbiBwcm9kdWN0aW9uLCB5b3UgbWlnaHQgd2FudCB0bzpcbiAgLy8gLSBTZW5kIGFsZXJ0cyB0byBzZWN1cml0eSB0ZWFtXG4gIC8vIC0gTG9nIHRvIGV4dGVybmFsIG1vbml0b3Jpbmcgc2VydmljZVxuICAvLyAtIFRyaWdnZXIgYXV0b21hdGVkIHJlc3BvbnNlc1xufSk7XG4iXSwidmVyc2lvbiI6M30=