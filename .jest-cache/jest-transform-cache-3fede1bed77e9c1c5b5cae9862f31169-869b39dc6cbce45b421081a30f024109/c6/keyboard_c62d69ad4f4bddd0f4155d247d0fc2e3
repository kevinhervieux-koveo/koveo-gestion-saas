7a17b09a9803b90cd445357bc1b1e8bd
'use strict';
require('../utils/dataTransfer/Clipboard.js');
var getActiveElement = require('../utils/focus/getActiveElement.js');
function _define_property(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    }
    else {
        obj[key] = value;
    }
    return obj;
}
var DOM_KEY_LOCATION = /*#__PURE__*/ function (DOM_KEY_LOCATION) {
    DOM_KEY_LOCATION[DOM_KEY_LOCATION["STANDARD"] = 0] = "STANDARD";
    DOM_KEY_LOCATION[DOM_KEY_LOCATION["LEFT"] = 1] = "LEFT";
    DOM_KEY_LOCATION[DOM_KEY_LOCATION["RIGHT"] = 2] = "RIGHT";
    DOM_KEY_LOCATION[DOM_KEY_LOCATION["NUMPAD"] = 3] = "NUMPAD";
    return DOM_KEY_LOCATION;
}({});
const modifierKeys = [
    'Alt',
    'AltGraph',
    'Control',
    'Fn',
    'Meta',
    'Shift',
    'Symbol'
];
function isModifierKey(key) {
    return modifierKeys.includes(key);
}
const modifierLocks = [
    'CapsLock',
    'FnLock',
    'NumLock',
    'ScrollLock',
    'SymbolLock'
];
function isModifierLock(key) {
    return modifierLocks.includes(key);
}
class KeyboardHost {
    isKeyPressed(keyDef) {
        return this.pressed.has(String(keyDef.code));
    }
    getPressedKeys() {
        return this.pressed.values().map((p) => p.keyDef);
    }
    /** Press a key */ async keydown(instance, keyDef) {
        const key = String(keyDef.key);
        const code = String(keyDef.code);
        const target = getActiveElement.getActiveElementOrBody(instance.config.document);
        this.setKeydownTarget(target);
        this.pressed.add(code, keyDef);
        if (isModifierKey(key)) {
            this.modifiers[key] = true;
        }
        const unprevented = instance.dispatchUIEvent(target, 'keydown', {
            key,
            code
        });
        if (isModifierLock(key) && !this.modifiers[key]) {
            this.modifiers[key] = true;
            this.modifierLockStart[key] = true;
        }
        if (unprevented) {
            this.pressed.setUnprevented(code);
        }
        if (unprevented && this.hasKeyPress(key)) {
            instance.dispatchUIEvent(getActiveElement.getActiveElementOrBody(instance.config.document), 'keypress', {
                key,
                code,
                charCode: keyDef.key === 'Enter' ? 13 : String(keyDef.key).charCodeAt(0)
            });
        }
    }
    /** Release a key */ async keyup(instance, keyDef) {
        const key = String(keyDef.key);
        const code = String(keyDef.code);
        const unprevented = this.pressed.isUnprevented(code);
        this.pressed.delete(code);
        if (isModifierKey(key) && !this.pressed.values().find((p) => p.keyDef.key === key)) {
            this.modifiers[key] = false;
        }
        instance.dispatchUIEvent(getActiveElement.getActiveElementOrBody(instance.config.document), 'keyup', {
            key,
            code
        }, !unprevented);
        if (isModifierLock(key) && this.modifiers[key]) {
            if (this.modifierLockStart[key]) {
                this.modifierLockStart[key] = false;
            }
            else {
                this.modifiers[key] = false;
            }
        }
    }
    setKeydownTarget(target) {
        if (target !== this.lastKeydownTarget) {
            this.carryChar = '';
        }
        this.lastKeydownTarget = target;
    }
    hasKeyPress(key) {
        return (key.length === 1 || key === 'Enter') && !this.modifiers.Control && !this.modifiers.Alt;
    }
    constructor(system) {
        _define_property(this, "system", undefined);
        _define_property(this, "modifiers", {
            Alt: false,
            AltGraph: false,
            CapsLock: false,
            Control: false,
            Fn: false,
            FnLock: false,
            Meta: false,
            NumLock: false,
            ScrollLock: false,
            Shift: false,
            Symbol: false,
            SymbolLock: false
        });
        _define_property(this, "pressed", new class {
            add(code, keyDef) {
                var _this_registry, _code;
                var _;
                (_ = (_this_registry = this.registry)[_code = code]) !== null && _ !== undefined ? _ : _this_registry[_code] = {
                    keyDef,
                    unpreventedDefault: false
                };
            }
            has(code) {
                return !!this.registry[code];
            }
            setUnprevented(code) {
                const o = this.registry[code];
                if (o) {
                    o.unpreventedDefault = true;
                }
            }
            isUnprevented(code) {
                var _this_registry_code;
                return !!((_this_registry_code = this.registry[code]) === null || _this_registry_code === undefined ? undefined : _this_registry_code.unpreventedDefault);
            }
            delete(code) {
                // eslint-disable-next-line @typescript-eslint/no-dynamic-delete
                delete this.registry[code];
            }
            values() {
                return Object.values(this.registry);
            }
            constructor() {
                _define_property(this, "registry", {});
            }
        }());
        _define_property(this, "carryChar", '');
        _define_property(this, "lastKeydownTarget", undefined);
        _define_property(this, "modifierLockStart", {});
        this.system = system;
    }
}
exports.DOM_KEY_LOCATION = DOM_KEY_LOCATION;
exports.KeyboardHost = KeyboardHost;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9rZXlib2FyZC5qcyIsIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixPQUFPLENBQUMsb0NBQW9DLENBQUMsQ0FBQztBQUM5QyxJQUFJLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBRXJFLFNBQVMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLO0lBQ3JDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO1lBQzVCLEtBQUssRUFBRSxLQUFLO1lBQ1osVUFBVSxFQUFFLElBQUk7WUFDaEIsWUFBWSxFQUFFLElBQUk7WUFDbEIsUUFBUSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztTQUFNLENBQUM7UUFDSixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFDRCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUM7QUFDRCxJQUFJLGdCQUFnQixHQUFHLGFBQWEsQ0FBQyxVQUFTLGdCQUFnQjtJQUMxRCxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUM7SUFDaEUsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDO0lBQ3hELGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztJQUMxRCxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDNUQsT0FBTyxnQkFBZ0IsQ0FBQztBQUM1QixDQUFDLENB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QUNKLEVBQUUsQ0FBQyxDQUFDO1FBQ0wsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4QyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDdkQsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLG1CQUFtQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3pCLENBQUM7Q0FDSjtBQUVELE9BQU8sQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL25vZGVfbW9kdWxlcy9AdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQvZGlzdC9janMvc3lzdGVtL2tleWJvYXJkLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxucmVxdWlyZSgnLi4vdXRpbHMvZGF0YVRyYW5zZmVyL0NsaXBib2FyZC5qcycpO1xudmFyIGdldEFjdGl2ZUVsZW1lbnQgPSByZXF1aXJlKCcuLi91dGlscy9mb2N1cy9nZXRBY3RpdmVFbGVtZW50LmpzJyk7XG5cbmZ1bmN0aW9uIF9kZWZpbmVfcHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7XG4gICAgaWYgKGtleSBpbiBvYmopIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgd3JpdGFibGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIG9iajtcbn1cbnZhciBET01fS0VZX0xPQ0FUSU9OID0gLyojX19QVVJFX18qLyBmdW5jdGlvbihET01fS0VZX0xPQ0FUSU9OKSB7XG4gICAgRE9NX0tFWV9MT0NBVElPTltET01fS0VZX0xPQ0FUSU9OW1wiU1RBTkRBUkRcIl0gPSAwXSA9IFwiU1RBTkRBUkRcIjtcbiAgICBET01fS0VZX0xPQ0FUSU9OW0RPTV9LRVlfTE9DQVRJT05bXCJMRUZUXCJdID0gMV0gPSBcIkxFRlRcIjtcbiAgICBET01fS0VZX0xPQ0FUSU9OW0RPTV9LRVlfTE9DQVRJT05bXCJSSUdIVFwiXSA9IDJdID0gXCJSSUdIVFwiO1xuICAgIERPTV9LRVlfTE9DQVRJT05bRE9NX0tFWV9MT0NBVElPTltcIk5VTVBBRFwiXSA9IDNdID0gXCJOVU1QQURcIjtcbiAgICByZXR1cm4gRE9NX0tFWV9MT0NBVElPTjtcbn0oe30pO1xuY29uc3QgbW9kaWZpZXJLZXlzID0gW1xuICAgICdBbHQnLFxuICAgICdBbHRHcmFwaCcsXG4gICAgJ0NvbnRyb2wnLFxuICAgICdGbicsXG4gICAgJ01ldGEnLFxuICAgICdTaGlmdCcsXG4gICAgJ1N5bWJvbCdcbl07XG5mdW5jdGlvbiBpc01vZGlmaWVyS2V5KGtleSkge1xuICAgIHJldHVybiBtb2RpZmllcktleXMuaW5jbHVkZXMoa2V5KTtcbn1cbmNvbnN0IG1vZGlmaWVyTG9ja3MgPSBbXG4gICAgJ0NhcHNMb2NrJyxcbiAgICAnRm5Mb2NrJyxcbiAgICAnTnVtTG9jaycsXG4gICAgJ1Njcm9sbExvY2snLFxuICAgICdTeW1ib2xMb2NrJ1xuXTtcbmZ1bmN0aW9uIGlzTW9kaWZpZXJMb2NrKGtleSkge1xuICAgIHJldHVybiBtb2RpZmllckxvY2tzLmluY2x1ZGVzKGtleSk7XG59XG5jbGFzcyBLZXlib2FyZEhvc3Qge1xuICAgIGlzS2V5UHJlc3NlZChrZXlEZWYpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlc3NlZC5oYXMoU3RyaW5nKGtleURlZi5jb2RlKSk7XG4gICAgfVxuICAgIGdldFByZXNzZWRLZXlzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVzc2VkLnZhbHVlcygpLm1hcCgocCk9PnAua2V5RGVmKTtcbiAgICB9XG4gICAgLyoqIFByZXNzIGEga2V5ICovIGFzeW5jIGtleWRvd24oaW5zdGFuY2UsIGtleURlZikge1xuICAgICAgICBjb25zdCBrZXkgPSBTdHJpbmcoa2V5RGVmLmtleSk7XG4gICAgICAgIGNvbnN0IGNvZGUgPSBTdHJpbmcoa2V5RGVmLmNvZGUpO1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBnZXRBY3RpdmVFbGVtZW50LmdldEFjdGl2ZUVsZW1lbnRPckJvZHkoaW5zdGFuY2UuY29uZmlnLmRvY3VtZW50KTtcbiAgICAgICAgdGhpcy5zZXRLZXlkb3duVGFyZ2V0KHRhcmdldCk7XG4gICAgICAgIHRoaXMucHJlc3NlZC5hZGQoY29kZSwga2V5RGVmKTtcbiAgICAgICAgaWYgKGlzTW9kaWZpZXJLZXkoa2V5KSkge1xuICAgICAgICAgICAgdGhpcy5tb2RpZmllcnNba2V5XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdW5wcmV2ZW50ZWQgPSBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQodGFyZ2V0LCAna2V5ZG93bicsIHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIGNvZGVcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChpc01vZGlmaWVyTG9jayhrZXkpICYmICF0aGlzLm1vZGlmaWVyc1trZXldKSB7XG4gICAgICAgICAgICB0aGlzLm1vZGlmaWVyc1trZXldID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubW9kaWZpZXJMb2NrU3RhcnRba2V5XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVucHJldmVudGVkKSB7XG4gICAgICAgICAgICB0aGlzLnByZXNzZWQuc2V0VW5wcmV2ZW50ZWQoY29kZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVucHJldmVudGVkICYmIHRoaXMuaGFzS2V5UHJlc3Moa2V5KSkge1xuICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGdldEFjdGl2ZUVsZW1lbnQuZ2V0QWN0aXZlRWxlbWVudE9yQm9keShpbnN0YW5jZS5jb25maWcuZG9jdW1lbnQpLCAna2V5cHJlc3MnLCB7XG4gICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgY2hhckNvZGU6IGtleURlZi5rZXkgPT09ICdFbnRlcicgPyAxMyA6IFN0cmluZyhrZXlEZWYua2V5KS5jaGFyQ29kZUF0KDApXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKiogUmVsZWFzZSBhIGtleSAqLyBhc3luYyBrZXl1cChpbnN0YW5jZSwga2V5RGVmKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IFN0cmluZyhrZXlEZWYua2V5KTtcbiAgICAgICAgY29uc3QgY29kZSA9IFN0cmluZyhrZXlEZWYuY29kZSk7XG4gICAgICAgIGNvbnN0IHVucHJldmVudGVkID0gdGhpcy5wcmVzc2VkLmlzVW5wcmV2ZW50ZWQoY29kZSk7XG4gICAgICAgIHRoaXMucHJlc3NlZC5kZWxldGUoY29kZSk7XG4gICAgICAgIGlmIChpc01vZGlmaWVyS2V5KGtleSkgJiYgIXRoaXMucHJlc3NlZC52YWx1ZXMoKS5maW5kKChwKT0+cC5rZXlEZWYua2V5ID09PSBrZXkpKSB7XG4gICAgICAgICAgICB0aGlzLm1vZGlmaWVyc1trZXldID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGdldEFjdGl2ZUVsZW1lbnQuZ2V0QWN0aXZlRWxlbWVudE9yQm9keShpbnN0YW5jZS5jb25maWcuZG9jdW1lbnQpLCAna2V5dXAnLCB7XG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICBjb2RlXG4gICAgICAgIH0sICF1bnByZXZlbnRlZCk7XG4gICAgICAgIGlmIChpc01vZGlmaWVyTG9jayhrZXkpICYmIHRoaXMubW9kaWZpZXJzW2tleV0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm1vZGlmaWVyTG9ja1N0YXJ0W2tleV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGlmaWVyTG9ja1N0YXJ0W2tleV0gPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tb2RpZmllcnNba2V5XSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHNldEtleWRvd25UYXJnZXQodGFyZ2V0KSB7XG4gICAgICAgIGlmICh0YXJnZXQgIT09IHRoaXMubGFzdEtleWRvd25UYXJnZXQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FycnlDaGFyID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sYXN0S2V5ZG93blRhcmdldCA9IHRhcmdldDtcbiAgICB9XG4gICAgaGFzS2V5UHJlc3Moa2V5KSB7XG4gICAgICAgIHJldHVybiAoa2V5Lmxlbmd0aCA9PT0gMSB8fCBrZXkgPT09ICdFbnRlcicpICYmICF0aGlzLm1vZGlmaWVycy5Db250cm9sICYmICF0aGlzLm1vZGlmaWVycy5BbHQ7XG4gICAgfVxuICAgIGNvbnN0cnVjdG9yKHN5c3RlbSl7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJzeXN0ZW1cIiwgdW5kZWZpbmVkKTtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcIm1vZGlmaWVyc1wiLCB7XG4gICAgICAgICAgICBBbHQ6IGZhbHNlLFxuICAgICAgICAgICAgQWx0R3JhcGg6IGZhbHNlLFxuICAgICAgICAgICAgQ2Fwc0xvY2s6IGZhbHNlLFxuICAgICAgICAgICAgQ29udHJvbDogZmFsc2UsXG4gICAgICAgICAgICBGbjogZmFsc2UsXG4gICAgICAgICAgICBGbkxvY2s6IGZhbHNlLFxuICAgICAgICAgICAgTWV0YTogZmFsc2UsXG4gICAgICAgICAgICBOdW1Mb2NrOiBmYWxzZSxcbiAgICAgICAgICAgIFNjcm9sbExvY2s6IGZhbHNlLFxuICAgICAgICAgICAgU2hpZnQ6IGZhbHNlLFxuICAgICAgICAgICAgU3ltYm9sOiBmYWxzZSxcbiAgICAgICAgICAgIFN5bWJvbExvY2s6IGZhbHNlXG4gICAgICAgIH0pO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwicHJlc3NlZFwiLCBuZXcgY2xhc3Mge1xuICAgICAgICAgICAgYWRkKGNvZGUsIGtleURlZikge1xuICAgICAgICAgICAgICAgIHZhciBfdGhpc19yZWdpc3RyeSwgX2NvZGU7XG4gICAgICAgICAgICAgICAgdmFyIF87XG4gICAgICAgICAgICAgICAgKF8gPSAoX3RoaXNfcmVnaXN0cnkgPSB0aGlzLnJlZ2lzdHJ5KVtfY29kZSA9IGNvZGVdKSAhPT0gbnVsbCAmJiBfICE9PSB1bmRlZmluZWQgPyBfIDogX3RoaXNfcmVnaXN0cnlbX2NvZGVdID0ge1xuICAgICAgICAgICAgICAgICAgICBrZXlEZWYsXG4gICAgICAgICAgICAgICAgICAgIHVucHJldmVudGVkRGVmYXVsdDogZmFsc2VcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaGFzKGNvZGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gISF0aGlzLnJlZ2lzdHJ5W2NvZGVdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2V0VW5wcmV2ZW50ZWQoY29kZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG8gPSB0aGlzLnJlZ2lzdHJ5W2NvZGVdO1xuICAgICAgICAgICAgICAgIGlmIChvKSB7XG4gICAgICAgICAgICAgICAgICAgIG8udW5wcmV2ZW50ZWREZWZhdWx0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpc1VucHJldmVudGVkKGNvZGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXNfcmVnaXN0cnlfY29kZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gISEoKF90aGlzX3JlZ2lzdHJ5X2NvZGUgPSB0aGlzLnJlZ2lzdHJ5W2NvZGVdKSA9PT0gbnVsbCB8fCBfdGhpc19yZWdpc3RyeV9jb2RlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfdGhpc19yZWdpc3RyeV9jb2RlLnVucHJldmVudGVkRGVmYXVsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWxldGUoY29kZSkge1xuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZHluYW1pYy1kZWxldGVcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5yZWdpc3RyeVtjb2RlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlcygpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLnJlZ2lzdHJ5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0cnVjdG9yKCl7XG4gICAgICAgICAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcInJlZ2lzdHJ5XCIsIHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSgpKTtcbiAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImNhcnJ5Q2hhclwiLCAnJyk7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJsYXN0S2V5ZG93blRhcmdldFwiLCB1bmRlZmluZWQpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwibW9kaWZpZXJMb2NrU3RhcnRcIiwge30pO1xuICAgICAgICB0aGlzLnN5c3RlbSA9IHN5c3RlbTtcbiAgICB9XG59XG5cbmV4cG9ydHMuRE9NX0tFWV9MT0NBVElPTiA9IERPTV9LRVlfTE9DQVRJT047XG5leHBvcnRzLktleWJvYXJkSG9zdCA9IEtleWJvYXJkSG9zdDtcbiJdLCJ2ZXJzaW9uIjozfQ==