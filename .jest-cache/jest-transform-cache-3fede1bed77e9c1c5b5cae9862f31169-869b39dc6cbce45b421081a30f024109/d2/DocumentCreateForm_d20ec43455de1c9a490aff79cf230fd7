c436b450dab78e233ee9da690e646779
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentCreateForm = DocumentCreateForm;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const react_hook_form_1 = require("react-hook-form");
const zod_1 = require("@hookform/resolvers/zod");
const react_query_1 = require("@tanstack/react-query");
const zod_2 = require("zod");
const button_1 = require("@/components/ui/button");
const input_1 = require("@/components/ui/input");
const textarea_1 = require("@/components/ui/textarea");
const dialog_1 = require("@/components/ui/dialog");
const form_1 = require("@/components/ui/form");
const select_1 = require("@/components/ui/select");
const card_1 = require("@/components/ui/card");
const lucide_react_1 = require("lucide-react");
const use_toast_1 = require("@/hooks/use-toast");
const SharedUploader_1 = require("./SharedUploader");
// Document categories matching the ones used in ModularDocumentPageWrapper
const DOCUMENT_CATEGORIES = [
    { value: 'bylaw', label: 'Bylaws' },
    { value: 'financial', label: 'Financial' },
    { value: 'maintenance', label: 'Maintenance' },
    { value: 'legal', label: 'Legal' },
    { value: 'meeting_minutes', label: 'Meeting Minutes' },
    { value: 'insurance', label: 'Insurance' },
    { value: 'contracts', label: 'Contracts' },
    { value: 'permits', label: 'Permits' },
    { value: 'inspection', label: 'Inspection' },
    { value: 'other', label: 'Other' },
];
// Form schema for document creation
const documentCreateSchema = zod_2.z.object({
    name: zod_2.z.string().min(1, 'Document name is required').max(255, 'Name must be less than 255 characters'),
    description: zod_2.z.string().max(1000, 'Description must be less than 1000 characters').optional(),
    category: zod_2.z.enum([
        'bylaw',
        'financial',
        'maintenance',
        'legal',
        'meeting_minutes',
        'insurance',
        'contracts',
        'permits',
        'inspection',
        'other'
    ]),
});
function DocumentCreateForm({ isOpen, onClose, onSuccess, entityType, entityId, entityName, }) {
    const { toast } = (0, use_toast_1.useToast)();
    const queryClient = (0, react_query_1.useQueryClient)();
    // State for file upload
    const [selectedFile, setSelectedFile] = (0, react_1.useState)(null);
    const [textContent, setTextContent] = (0, react_1.useState)(null);
    // Upload context for secure storage
    const uploadContext = {
        type: entityType === 'building' ? 'buildings' : 'residences',
        buildingId: entityType === 'building' ? entityId : undefined,
        residenceId: entityType === 'residence' ? entityId : undefined,
        userRole: 'admin', // This would be dynamic based on current user
        userId: 'current-user' // This would be dynamic based on current user
    };
    // Form setup
    const form = (0, react_hook_form_1.useForm)({
        resolver: (0, zod_1.zodResolver)(documentCreateSchema),
        defaultValues: {
            name: '',
            description: '',
            category: 'other',
        }
    });
    // Create document mutation
    const createDocumentMutation = (0, react_query_1.useMutation)({
        mutationFn: async (data) => {
            const formData = new FormData();
            // Add document metadata
            formData.append('name', data.name);
            formData.append('documentType', data.category);
            if (data.description) {
                formData.append('description', data.description);
            }
            // Add entity association
            if (entityType === 'building') {
                formData.append('buildingId', entityId);
            }
            else {
                formData.append('residenceId', entityId);
            }
            // Add file or text content
            if (selectedFile) {
                formData.append('file', selectedFile);
            }
            else if (textContent) {
                formData.append('textContent', textContent);
            }
            // Make the API request
            const response = await fetch('/api/documents', {
                method: 'POST',
                credentials: 'include',
                body: formData,
            });
            if (!response.ok) {
                const errorText = await response.text();
                let errorData = {};
                try {
                    errorData = JSON.parse(errorText);
                }
                catch (e) {
                    console.error('Failed to parse error response as JSON');
                }
                throw new Error(errorData.error || errorData.message || `Failed to create document: ${response.status}`);
            }
            return response.json();
        },
        onSuccess: (data) => {
            // Invalidate documents cache to refresh the list
            queryClient.invalidateQueries({ queryKey: ['/api/documents'] });
            toast({
                title: 'Document Created',
                description: `"${data.name}" has been created successfully`,
            });
            // Reset form and close dialog
            form.reset();
            setSelectedFile(null);
            setTextContent(null);
            onClose();
            onSuccess?.(data.id);
        },
        onError: (error) => {
            toast({
                title: 'Error Creating Document',
                description: error.message || 'Failed to create document',
                variant: 'destructive',
            });
        }
    });
    // Handle file/text changes from SharedUploader
    const handleDocumentChange = (file, text) => {
        setSelectedFile(file);
        setTextContent(text);
        // Auto-populate name if file was uploaded and name is empty
        if (file && !form.getValues('name')) {
            const nameWithoutExtension = file.name.replace(/\.[^/.]+$/, '');
            form.setValue('name', nameWithoutExtension);
        }
    };
    const onSubmit = (data) => {
        // Validate that we have either a file or text content
        if (!selectedFile && !textContent) {
            toast({
                title: 'Missing Content',
                description: 'Please either upload a file or enter text content for the document.',
                variant: 'destructive',
            });
            return;
        }
        createDocumentMutation.mutate(data);
    };
    const handleClose = () => {
        if (!createDocumentMutation.isPending) {
            form.reset();
            setSelectedFile(null);
            setTextContent(null);
            onClose();
        }
    };
    return ((0, jsx_runtime_1.jsx)(dialog_1.Dialog, { open: isOpen, onOpenChange: handleClose, children: (0, jsx_runtime_1.jsxs)(dialog_1.DialogContent, { className: "max-w-2xl max-h-[90vh] overflow-y-auto", children: [(0, jsx_runtime_1.jsxs)(dialog_1.DialogHeader, { children: [(0, jsx_runtime_1.jsxs)(dialog_1.DialogTitle, { className: "flex items-center gap-2", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.FileText, { className: "w-5 h-5" }), "Create New Document"] }), (0, jsx_runtime_1.jsxs)(dialog_1.DialogDescription, { children: ["Create a new document for ", entityName || `this ${entityType}`] })] }), (0, jsx_runtime_1.jsx)(form_1.Form, { ...form, children: (0, jsx_runtime_1.jsxs)("form", { onSubmit: form.handleSubmit(onSubmit), className: "space-y-6", children: [(0, jsx_runtime_1.jsxs)("div", { className: "space-y-4", children: [(0, jsx_runtime_1.jsxs)("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4", children: [(0, jsx_runtime_1.jsx)(form_1.FormField, { control: form.control, name: "name", render: ({ field }) => ((0, jsx_runtime_1.jsxs)(form_1.FormItem, { children: [(0, jsx_runtime_1.jsx)(form_1.FormLabel, { children: "Document Name *" }), (0, jsx_runtime_1.jsx)(form_1.FormControl, { children: (0, jsx_runtime_1.jsx)(input_1.Input, { placeholder: "e.g., Building Bylaws 2024", ...field, "data-testid": "input-document-name" }) }), (0, jsx_runtime_1.jsx)(form_1.FormMessage, {})] })) }), (0, jsx_runtime_1.jsx)(form_1.FormField, { control: form.control, name: "category", render: ({ field }) => ((0, jsx_runtime_1.jsxs)(form_1.FormItem, { children: [(0, jsx_runtime_1.jsx)(form_1.FormLabel, { children: "Category *" }), (0, jsx_runtime_1.jsxs)(select_1.Select, { onValueChange: field.onChange, value: field.value, children: [(0, jsx_runtime_1.jsx)(form_1.FormControl, { children: (0, jsx_runtime_1.jsx)(select_1.SelectTrigger, { "data-testid": "select-document-category", children: (0, jsx_runtime_1.jsx)(select_1.SelectValue, { placeholder: "Select category" }) }) }), (0, jsx_runtime_1.jsx)(select_1.SelectContent, { children: DOCUMENT_CATEGORIES.map((category) => ((0, jsx_runtime_1.jsx)(select_1.SelectItem, { value: category.value, children: category.label }, category.value))) })] }), (0, jsx_runtime_1.jsx)(form_1.FormMessage, {})] })) })] }), (0, jsx_runtime_1.jsx)(form_1.FormField, { control: form.control, name: "description", render: ({ field }) => ((0, jsx_runtime_1.jsxs)(form_1.FormItem, { children: [(0, jsx_runtime_1.jsx)(form_1.FormLabel, { children: "Description (Optional)" }), (0, jsx_runtime_1.jsx)(form_1.FormControl, { children: (0, jsx_runtime_1.jsx)(textarea_1.Textarea, { placeholder: "Describe the document content and purpose...", className: "min-h-[80px]", ...field, "data-testid": "textarea-document-description" }) }), (0, jsx_runtime_1.jsx)(form_1.FormMessage, {})] })) })] }), (0, jsx_runtime_1.jsxs)(card_1.Card, { children: [(0, jsx_runtime_1.jsx)(card_1.CardHeader, { children: (0, jsx_runtime_1.jsxs)(card_1.CardTitle, { className: "flex items-center gap-2", children: [(0, jsx_runtime_1.jsx)(lucide_react_1.Upload, { className: "w-5 h-5" }), "Document Content"] }) }), (0, jsx_runtime_1.jsxs)(card_1.CardContent, { children: [(0, jsx_runtime_1.jsx)(SharedUploader_1.SharedUploader, { onDocumentChange: handleDocumentChange, formType: "documents", uploadContext: uploadContext, showAiToggle: false, allowedFileTypes: [
                                                    'application/pdf',
                                                    'application/msword',
                                                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                                    'application/vnd.ms-excel',
                                                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                                    'text/plain',
                                                    'image/*'
                                                ], maxFileSize: 25, defaultTab: "file" }), (0, jsx_runtime_1.jsx)("p", { className: "text-xs text-muted-foreground mt-2", children: "Upload a file or create a text document. Maximum file size: 25MB." })] })] }), (0, jsx_runtime_1.jsxs)(dialog_1.DialogFooter, { children: [(0, jsx_runtime_1.jsx)(button_1.Button, { type: "button", variant: "outline", onClick: handleClose, disabled: createDocumentMutation.isPending, children: "Cancel" }), (0, jsx_runtime_1.jsx)(button_1.Button, { type: "submit", disabled: createDocumentMutation.isPending, "data-testid": "button-create-document", children: createDocumentMutation.isPending ? ((0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)("div", { className: "animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" }), "Creating..."] })) : ((0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(lucide_react_1.FileText, { className: "w-4 h-4 mr-2" }), "Create Document"] })) })] })] }) })] }) }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9jbGllbnQvc3JjL2NvbXBvbmVudHMvZG9jdW1lbnQtbWFuYWdlbWVudC9Eb2N1bWVudENyZWF0ZUZvcm0udHN4IiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUZBLGdEQWtTQzs7QUFuWEQsK0NBQXdDO0FBQ3hDLHFEQUEwQztBQUMxQyxpREFBc0Q7QUFDdEQsdURBQW9FO0FBQ3BFLDZCQUF3QjtBQUN4QixtREFBZ0Q7QUFDaEQsaURBQThDO0FBQzlDLHVEQUFvRDtBQUVwRCxtREFPZ0M7QUFDaEMsK0NBTzhCO0FBQzlCLG1EQU1nQztBQUNoQywrQ0FBZ0Y7QUFDaEYsK0NBQWdEO0FBQ2hELGlEQUE2QztBQUM3QyxxREFBa0Q7QUFHbEQsMkVBQTJFO0FBQzNFLE1BQU0sbUJBQW1CLEdBQUc7SUFDMUIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUU7SUFDbkMsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUU7SUFDMUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUU7SUFDOUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7SUFDbEMsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFO0lBQ3RELEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFO0lBQzFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFO0lBQzFDLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFO0lBQ3RDLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFO0lBQzVDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxF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QkFBc0IsQ0FBQyxTQUFTLGlCQUM5Qix3QkFBd0IsWUFFbkMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUNsQyw2REFDRSxnQ0FBSyxTQUFTLEVBQUMsZ0VBQWdFLEdBQU8sbUJBRXJGLENBQ0osQ0FBQyxDQUFDLENBQUMsQ0FDRiw2REFDRSx1QkFBQyx1QkFBUSxJQUFDLFNBQVMsRUFBQyxjQUFjLEdBQUcsdUJBRXBDLENBQ0osR0FDTSxJQUNJLElBQ1YsR0FDRixJQUNPLEdBQ1QsQ0FDVixDQUFDO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL2NsaWVudC9zcmMvY29tcG9uZW50cy9kb2N1bWVudC1tYW5hZ2VtZW50L0RvY3VtZW50Q3JlYXRlRm9ybS50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgdXNlRm9ybSB9IGZyb20gJ3JlYWN0LWhvb2stZm9ybSc7XG5pbXBvcnQgeyB6b2RSZXNvbHZlciB9IGZyb20gJ0Bob29rZm9ybS9yZXNvbHZlcnMvem9kJztcbmltcG9ydCB7IHVzZU11dGF0aW9uLCB1c2VRdWVyeUNsaWVudCB9IGZyb20gJ0B0YW5zdGFjay9yZWFjdC1xdWVyeSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IEJ1dHRvbiB9IGZyb20gJ0AvY29tcG9uZW50cy91aS9idXR0b24nO1xuaW1wb3J0IHsgSW5wdXQgfSBmcm9tICdAL2NvbXBvbmVudHMvdWkvaW5wdXQnO1xuaW1wb3J0IHsgVGV4dGFyZWEgfSBmcm9tICdAL2NvbXBvbmVudHMvdWkvdGV4dGFyZWEnO1xuaW1wb3J0IHsgTGFiZWwgfSBmcm9tICdAL2NvbXBvbmVudHMvdWkvbGFiZWwnO1xuaW1wb3J0IHtcbiAgRGlhbG9nLFxuICBEaWFsb2dDb250ZW50LFxuICBEaWFsb2dEZXNjcmlwdGlvbixcbiAgRGlhbG9nRm9vdGVyLFxuICBEaWFsb2dIZWFkZXIsXG4gIERpYWxvZ1RpdGxlLFxufSBmcm9tICdAL2NvbXBvbmVudHMvdWkvZGlhbG9nJztcbmltcG9ydCB7XG4gIEZvcm0sXG4gIEZvcm1Db250cm9sLFxuICBGb3JtRmllbGQsXG4gIEZvcm1JdGVtLFxuICBGb3JtTGFiZWwsXG4gIEZvcm1NZXNzYWdlLFxufSBmcm9tICdAL2NvbXBvbmVudHMvdWkvZm9ybSc7XG5pbXBvcnQge1xuICBTZWxlY3QsXG4gIFNlbGVjdENvbnRlbnQsXG4gIFNlbGVjdEl0ZW0sXG4gIFNlbGVjdFRyaWdnZXIsXG4gIFNlbGVjdFZhbHVlLFxufSBmcm9tICdAL2NvbXBvbmVudHMvdWkvc2VsZWN0JztcbmltcG9ydCB7IENhcmQsIENhcmRDb250ZW50LCBDYXJkSGVhZGVyLCBDYXJkVGl0bGUgfSBmcm9tICdAL2NvbXBvbmVudHMvdWkvY2FyZCc7XG5pbXBvcnQgeyBGaWxlVGV4dCwgVXBsb2FkIH0gZnJvbSAnbHVjaWRlLXJlYWN0JztcbmltcG9ydCB7IHVzZVRvYXN0IH0gZnJvbSAnQC9ob29rcy91c2UtdG9hc3QnO1xuaW1wb3J0IHsgU2hhcmVkVXBsb2FkZXIgfSBmcm9tICcuL1NoYXJlZFVwbG9hZGVyJztcbmltcG9ydCB0eXBlIHsgVXBsb2FkQ29udGV4dCB9IGZyb20gJ0BzaGFyZWQvY29uZmlnL3VwbG9hZC1jb25maWcnO1xuXG4vLyBEb2N1bWVudCBjYXRlZ29yaWVzIG1hdGNoaW5nIHRoZSBvbmVzIHVzZWQgaW4gTW9kdWxhckRvY3VtZW50UGFnZVdyYXBwZXJcbmNvbnN0IERPQ1VNRU5UX0NBVEVHT1JJRVMgPSBbXG4gIHsgdmFsdWU6ICdieWxhdycsIGxhYmVsOiAnQnlsYXdzJyB9LFxuICB7IHZhbHVlOiAnZmluYW5jaWFsJywgbGFiZWw6ICdGaW5hbmNpYWwnIH0sXG4gIHsgdmFsdWU6ICdtYWludGVuYW5jZScsIGxhYmVsOiAnTWFpbnRlbmFuY2UnIH0sXG4gIHsgdmFsdWU6ICdsZWdhbCcsIGxhYmVsOiAnTGVnYWwnIH0sXG4gIHsgdmFsdWU6ICdtZWV0aW5nX21pbnV0ZXMnLCBsYWJlbDogJ01lZXRpbmcgTWludXRlcycgfSxcbiAgeyB2YWx1ZTogJ2luc3VyYW5jZScsIGxhYmVsOiAnSW5zdXJhbmNlJyB9LFxuICB7IHZhbHVlOiAnY29udHJhY3RzJywgbGFiZWw6ICdDb250cmFjdHMnIH0sXG4gIHsgdmFsdWU6ICdwZXJtaXRzJywgbGFiZWw6ICdQZXJtaXRzJyB9LFxuICB7IHZhbHVlOiAnaW5zcGVjdGlvbicsIGxhYmVsOiAnSW5zcGVjdGlvbicgfSxcbiAgeyB2YWx1ZTogJ290aGVyJywgbGFiZWw6ICdPdGhlcicgfSxcbl07XG5cbi8vIEZvcm0gc2NoZW1hIGZvciBkb2N1bWVudCBjcmVhdGlvblxuY29uc3QgZG9jdW1lbnRDcmVhdGVTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIG5hbWU6IHouc3RyaW5nKCkubWluKDEsICdEb2N1bWVudCBuYW1lIGlzIHJlcXVpcmVkJykubWF4KDI1NSwgJ05hbWUgbXVzdCBiZSBsZXNzIHRoYW4gMjU1IGNoYXJhY3RlcnMnKSxcbiAgZGVzY3JpcHRpb246IHouc3RyaW5nKCkubWF4KDEwMDAsICdEZXNjcmlwdGlvbiBtdXN0IGJlIGxlc3MgdGhhbiAxMDAwIGNoYXJhY3RlcnMnKS5vcHRpb25hbCgpLFxuICBjYXRlZ29yeTogei5lbnVtKFtcbiAgICAnYnlsYXcnLFxuICAgICdmaW5hbmNpYWwnLCBcbiAgICAnbWFpbnRlbmFuY2UnLFxuICAgICdsZWdhbCcsXG4gICAgJ21lZXRpbmdfbWludXRlcycsXG4gICAgJ2luc3VyYW5jZScsXG4gICAgJ2NvbnRyYWN0cycsXG4gICAgJ3Blcm1pdHMnLFxuICAgICdpbnNwZWN0aW9uJyxcbiAgICAnb3RoZXInXG4gIF0pLFxufSk7XG5cbnR5cGUgRG9jdW1lbnRDcmVhdGVEYXRhID0gei5pbmZlcjx0eXBlb2YgZG9jdW1lbnRDcmVhdGVTY2hlbWE+O1xuXG5pbnRlcmZhY2UgRG9jdW1lbnRDcmVhdGVGb3JtUHJvcHMge1xuICBpc09wZW46IGJvb2xlYW47XG4gIG9uQ2xvc2U6ICgpID0+IHZvaWQ7XG4gIG9uU3VjY2Vzcz86IChkb2N1bWVudElkOiBzdHJpbmcpID0+IHZvaWQ7XG4gIGVudGl0eVR5cGU6ICdidWlsZGluZycgfCAncmVzaWRlbmNlJztcbiAgZW50aXR5SWQ6IHN0cmluZztcbiAgZW50aXR5TmFtZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIERvY3VtZW50Q3JlYXRlRm9ybSh7XG4gIGlzT3BlbixcbiAgb25DbG9zZSxcbiAgb25TdWNjZXNzLFxuICBlbnRpdHlUeXBlLFxuICBlbnRpdHlJZCxcbiAgZW50aXR5TmFtZSxcbn06IERvY3VtZW50Q3JlYXRlRm9ybVByb3BzKSB7XG4gIGNvbnN0IHsgdG9hc3QgfSA9IHVzZVRvYXN0KCk7XG4gIGNvbnN0IHF1ZXJ5Q2xpZW50ID0gdXNlUXVlcnlDbGllbnQoKTtcbiAgXG4gIC8vIFN0YXRlIGZvciBmaWxlIHVwbG9hZFxuICBjb25zdCBbc2VsZWN0ZWRGaWxlLCBzZXRTZWxlY3RlZEZpbGVdID0gdXNlU3RhdGU8RmlsZSB8IG51bGw+KG51bGwpO1xuICBjb25zdCBbdGV4dENvbnRlbnQsIHNldFRleHRDb250ZW50XSA9IHVzZVN0YXRlPHN0cmluZyB8IG51bGw+KG51bGwpO1xuXG4gIC8vIFVwbG9hZCBjb250ZXh0IGZvciBzZWN1cmUgc3RvcmFnZVxuICBjb25zdCB1cGxvYWRDb250ZXh0OiBVcGxvYWRDb250ZXh0ID0ge1xuICAgIHR5cGU6IGVudGl0eVR5cGUgPT09ICdidWlsZGluZycgPyAnYnVpbGRpbmdzJyA6ICdyZXNpZGVuY2VzJyxcbiAgICBidWlsZGluZ0lkOiBlbnRpdHlUeXBlID09PSAnYnVpbGRpbmcnID8gZW50aXR5SWQgOiB1bmRlZmluZWQsXG4gICAgcmVzaWRlbmNlSWQ6IGVudGl0eVR5cGUgPT09ICdyZXNpZGVuY2UnID8gZW50aXR5SWQgOiB1bmRlZmluZWQsXG4gICAgdXNlclJvbGU6ICdhZG1pbicsIC8vIFRoaXMgd291bGQgYmUgZHluYW1pYyBiYXNlZCBvbiBjdXJyZW50IHVzZXJcbiAgICB1c2VySWQ6ICdjdXJyZW50LXVzZXInIC8vIFRoaXMgd291bGQgYmUgZHluYW1pYyBiYXNlZCBvbiBjdXJyZW50IHVzZXJcbiAgfTtcblxuICAvLyBGb3JtIHNldHVwXG4gIGNvbnN0IGZvcm0gPSB1c2VGb3JtPERvY3VtZW50Q3JlYXRlRGF0YT4oe1xuICAgIHJlc29sdmVyOiB6b2RSZXNvbHZlcihkb2N1bWVudENyZWF0ZVNjaGVtYSksXG4gICAgZGVmYXVsdFZhbHVlczoge1xuICAgICAgbmFtZTogJycsXG4gICAgICBkZXNjcmlwdGlvbjogJycsXG4gICAgICBjYXRlZ29yeTogJ290aGVyJyxcbiAgICB9XG4gIH0pO1xuXG4gIC8vIENyZWF0ZSBkb2N1bWVudCBtdXRhdGlvblxuICBjb25zdCBjcmVhdGVEb2N1bWVudE11dGF0aW9uID0gdXNlTXV0YXRpb24oe1xuICAgIG11dGF0aW9uRm46IGFzeW5jIChkYXRhOiBEb2N1bWVudENyZWF0ZURhdGEpID0+IHtcbiAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICBcbiAgICAgIC8vIEFkZCBkb2N1bWVudCBtZXRhZGF0YVxuICAgICAgZm9ybURhdGEuYXBwZW5kKCduYW1lJywgZGF0YS5uYW1lKTtcbiAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZG9jdW1lbnRUeXBlJywgZGF0YS5jYXRlZ29yeSk7XG4gICAgICBpZiAoZGF0YS5kZXNjcmlwdGlvbikge1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2Rlc2NyaXB0aW9uJywgZGF0YS5kZXNjcmlwdGlvbik7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEFkZCBlbnRpdHkgYXNzb2NpYXRpb25cbiAgICAgIGlmIChlbnRpdHlUeXBlID09PSAnYnVpbGRpbmcnKSB7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYnVpbGRpbmdJZCcsIGVudGl0eUlkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzaWRlbmNlSWQnLCBlbnRpdHlJZCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBmaWxlIG9yIHRleHQgY29udGVudFxuICAgICAgaWYgKHNlbGVjdGVkRmlsZSkge1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBzZWxlY3RlZEZpbGUpO1xuICAgICAgfSBlbHNlIGlmICh0ZXh0Q29udGVudCkge1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3RleHRDb250ZW50JywgdGV4dENvbnRlbnQpO1xuICAgICAgfVxuXG4gICAgICAvLyBNYWtlIHRoZSBBUEkgcmVxdWVzdFxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnL2FwaS9kb2N1bWVudHMnLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLFxuICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgICAgbGV0IGVycm9yRGF0YSA9IHt9O1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGVycm9yRGF0YSA9IEpTT04ucGFyc2UoZXJyb3JUZXh0KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBlcnJvciByZXNwb25zZSBhcyBKU09OJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvckRhdGEuZXJyb3IgfHwgZXJyb3JEYXRhLm1lc3NhZ2UgfHwgYEZhaWxlZCB0byBjcmVhdGUgZG9jdW1lbnQ6ICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgIH0sXG4gICAgb25TdWNjZXNzOiAoZGF0YSkgPT4ge1xuICAgICAgLy8gSW52YWxpZGF0ZSBkb2N1bWVudHMgY2FjaGUgdG8gcmVmcmVzaCB0aGUgbGlzdFxuICAgICAgcXVlcnlDbGllbnQuaW52YWxpZGF0ZVF1ZXJpZXMoeyBxdWVyeUtleTogWycvYXBpL2RvY3VtZW50cyddIH0pO1xuICAgICAgXG4gICAgICB0b2FzdCh7XG4gICAgICAgIHRpdGxlOiAnRG9jdW1lbnQgQ3JlYXRlZCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgXCIke2RhdGEubmFtZX1cIiBoYXMgYmVlbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseWAsXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgLy8gUmVzZXQgZm9ybSBhbmQgY2xvc2UgZGlhbG9nXG4gICAgICBmb3JtLnJlc2V0KCk7XG4gICAgICBzZXRTZWxlY3RlZEZpbGUobnVsbCk7XG4gICAgICBzZXRUZXh0Q29udGVudChudWxsKTtcbiAgICAgIG9uQ2xvc2UoKTtcbiAgICAgIG9uU3VjY2Vzcz8uKGRhdGEuaWQpO1xuICAgIH0sXG4gICAgb25FcnJvcjogKGVycm9yOiBhbnkpID0+IHtcbiAgICAgIHRvYXN0KHtcbiAgICAgICAgdGl0bGU6ICdFcnJvciBDcmVhdGluZyBEb2N1bWVudCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBlcnJvci5tZXNzYWdlIHx8ICdGYWlsZWQgdG8gY3JlYXRlIGRvY3VtZW50JyxcbiAgICAgICAgdmFyaWFudDogJ2Rlc3RydWN0aXZlJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gSGFuZGxlIGZpbGUvdGV4dCBjaGFuZ2VzIGZyb20gU2hhcmVkVXBsb2FkZXJcbiAgY29uc3QgaGFuZGxlRG9jdW1lbnRDaGFuZ2UgPSAoZmlsZTogRmlsZSB8IG51bGwsIHRleHQ6IHN0cmluZyB8IG51bGwpID0+IHtcbiAgICBzZXRTZWxlY3RlZEZpbGUoZmlsZSk7XG4gICAgc2V0VGV4dENvbnRlbnQodGV4dCk7XG4gICAgXG4gICAgLy8gQXV0by1wb3B1bGF0ZSBuYW1lIGlmIGZpbGUgd2FzIHVwbG9hZGVkIGFuZCBuYW1lIGlzIGVtcHR5XG4gICAgaWYgKGZpbGUgJiYgIWZvcm0uZ2V0VmFsdWVzKCduYW1lJykpIHtcbiAgICAgIGNvbnN0IG5hbWVXaXRob3V0RXh0ZW5zaW9uID0gZmlsZS5uYW1lLnJlcGxhY2UoL1xcLlteLy5dKyQvLCAnJyk7XG4gICAgICBmb3JtLnNldFZhbHVlKCduYW1lJywgbmFtZVdpdGhvdXRFeHRlbnNpb24pO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCBvblN1Ym1pdCA9IChkYXRhOiBEb2N1bWVudENyZWF0ZURhdGEpID0+IHtcbiAgICAvLyBWYWxpZGF0ZSB0aGF0IHdlIGhhdmUgZWl0aGVyIGEgZmlsZSBvciB0ZXh0IGNvbnRlbnRcbiAgICBpZiAoIXNlbGVjdGVkRmlsZSAmJiAhdGV4dENvbnRlbnQpIHtcbiAgICAgIHRvYXN0KHtcbiAgICAgICAgdGl0bGU6ICdNaXNzaW5nIENvbnRlbnQnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1BsZWFzZSBlaXRoZXIgdXBsb2FkIGEgZmlsZSBvciBlbnRlciB0ZXh0IGNvbnRlbnQgZm9yIHRoZSBkb2N1bWVudC4nLFxuICAgICAgICB2YXJpYW50OiAnZGVzdHJ1Y3RpdmUnLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIGNyZWF0ZURvY3VtZW50TXV0YXRpb24ubXV0YXRlKGRhdGEpO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZUNsb3NlID0gKCkgPT4ge1xuICAgIGlmICghY3JlYXRlRG9jdW1lbnRNdXRhdGlvbi5pc1BlbmRpbmcpIHtcbiAgICAgIGZvcm0ucmVzZXQoKTtcbiAgICAgIHNldFNlbGVjdGVkRmlsZShudWxsKTtcbiAgICAgIHNldFRleHRDb250ZW50KG51bGwpO1xuICAgICAgb25DbG9zZSgpO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gKFxuICAgIDxEaWFsb2cgb3Blbj17aXNPcGVufSBvbk9wZW5DaGFuZ2U9e2hhbmRsZUNsb3NlfT5cbiAgICAgIDxEaWFsb2dDb250ZW50IGNsYXNzTmFtZT1cIm1heC13LTJ4bCBtYXgtaC1bOTB2aF0gb3ZlcmZsb3cteS1hdXRvXCI+XG4gICAgICAgIDxEaWFsb2dIZWFkZXI+XG4gICAgICAgICAgPERpYWxvZ1RpdGxlIGNsYXNzTmFtZT1cImZsZXggaXRlbXMtY2VudGVyIGdhcC0yXCI+XG4gICAgICAgICAgICA8RmlsZVRleHQgY2xhc3NOYW1lPVwidy01IGgtNVwiIC8+XG4gICAgICAgICAgICBDcmVhdGUgTmV3IERvY3VtZW50XG4gICAgICAgICAgPC9EaWFsb2dUaXRsZT5cbiAgICAgICAgICA8RGlhbG9nRGVzY3JpcHRpb24+XG4gICAgICAgICAgICBDcmVhdGUgYSBuZXcgZG9jdW1lbnQgZm9yIHtlbnRpdHlOYW1lIHx8IGB0aGlzICR7ZW50aXR5VHlwZX1gfVxuICAgICAgICAgIDwvRGlhbG9nRGVzY3JpcHRpb24+XG4gICAgICAgIDwvRGlhbG9nSGVhZGVyPlxuXG4gICAgICAgIDxGb3JtIHsuLi5mb3JtfT5cbiAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17Zm9ybS5oYW5kbGVTdWJtaXQob25TdWJtaXQpfSBjbGFzc05hbWU9XCJzcGFjZS15LTZcIj5cbiAgICAgICAgICAgIHsvKiBEb2N1bWVudCBJbmZvcm1hdGlvbiBTZWN0aW9uICovfVxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJzcGFjZS15LTRcIj5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJncmlkIGdyaWQtY29scy0xIG1kOmdyaWQtY29scy0yIGdhcC00XCI+XG4gICAgICAgICAgICAgICAgey8qIERvY3VtZW50IE5hbWUgKi99XG4gICAgICAgICAgICAgICAgPEZvcm1GaWVsZFxuICAgICAgICAgICAgICAgICAgY29udHJvbD17Zm9ybS5jb250cm9sfVxuICAgICAgICAgICAgICAgICAgbmFtZT1cIm5hbWVcIlxuICAgICAgICAgICAgICAgICAgcmVuZGVyPXsoeyBmaWVsZCB9KSA9PiAoXG4gICAgICAgICAgICAgICAgICAgIDxGb3JtSXRlbT5cbiAgICAgICAgICAgICAgICAgICAgICA8Rm9ybUxhYmVsPkRvY3VtZW50IE5hbWUgKjwvRm9ybUxhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgIDxGb3JtQ29udHJvbD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxJbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj1cImUuZy4sIEJ1aWxkaW5nIEJ5bGF3cyAyMDI0XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgey4uLmZpZWxkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLXRlc3RpZD1cImlucHV0LWRvY3VtZW50LW5hbWVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICA8L0Zvcm1Db250cm9sPlxuICAgICAgICAgICAgICAgICAgICAgIDxGb3JtTWVzc2FnZSAvPlxuICAgICAgICAgICAgICAgICAgICA8L0Zvcm1JdGVtPlxuICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICAvPlxuXG4gICAgICAgICAgICAgICAgey8qIENhdGVnb3J5ICovfVxuICAgICAgICAgICAgICAgIDxGb3JtRmllbGRcbiAgICAgICAgICAgICAgICAgIGNvbnRyb2w9e2Zvcm0uY29udHJvbH1cbiAgICAgICAgICAgICAgICAgIG5hbWU9XCJjYXRlZ29yeVwiXG4gICAgICAgICAgICAgICAgICByZW5kZXI9eyh7IGZpZWxkIH0pID0+IChcbiAgICAgICAgICAgICAgICAgICAgPEZvcm1JdGVtPlxuICAgICAgICAgICAgICAgICAgICAgIDxGb3JtTGFiZWw+Q2F0ZWdvcnkgKjwvRm9ybUxhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgIDxTZWxlY3Qgb25WYWx1ZUNoYW5nZT17ZmllbGQub25DaGFuZ2V9IHZhbHVlPXtmaWVsZC52YWx1ZX0+XG4gICAgICAgICAgICAgICAgICAgICAgICA8Rm9ybUNvbnRyb2w+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIDxTZWxlY3RUcmlnZ2VyIGRhdGEtdGVzdGlkPVwic2VsZWN0LWRvY3VtZW50LWNhdGVnb3J5XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPFNlbGVjdFZhbHVlIHBsYWNlaG9sZGVyPVwiU2VsZWN0IGNhdGVnb3J5XCIgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgPC9TZWxlY3RUcmlnZ2VyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9Gb3JtQ29udHJvbD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxTZWxlY3RDb250ZW50PlxuICAgICAgICAgICAgICAgICAgICAgICAgICB7RE9DVU1FTlRfQ0FURUdPUklFUy5tYXAoKGNhdGVnb3J5KSA9PiAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPFNlbGVjdEl0ZW0ga2V5PXtjYXRlZ29yeS52YWx1ZX0gdmFsdWU9e2NhdGVnb3J5LnZhbHVlfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtjYXRlZ29yeS5sYWJlbH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L1NlbGVjdEl0ZW0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICkpfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9TZWxlY3RDb250ZW50PlxuICAgICAgICAgICAgICAgICAgICAgIDwvU2VsZWN0PlxuICAgICAgICAgICAgICAgICAgICAgIDxGb3JtTWVzc2FnZSAvPlxuICAgICAgICAgICAgICAgICAgICA8L0Zvcm1JdGVtPlxuICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgICB7LyogRGVzY3JpcHRpb24gKi99XG4gICAgICAgICAgICAgIDxGb3JtRmllbGRcbiAgICAgICAgICAgICAgICBjb250cm9sPXtmb3JtLmNvbnRyb2x9XG4gICAgICAgICAgICAgICAgbmFtZT1cImRlc2NyaXB0aW9uXCJcbiAgICAgICAgICAgICAgICByZW5kZXI9eyh7IGZpZWxkIH0pID0+IChcbiAgICAgICAgICAgICAgICAgIDxGb3JtSXRlbT5cbiAgICAgICAgICAgICAgICAgICAgPEZvcm1MYWJlbD5EZXNjcmlwdGlvbiAoT3B0aW9uYWwpPC9Gb3JtTGFiZWw+XG4gICAgICAgICAgICAgICAgICAgIDxGb3JtQ29udHJvbD5cbiAgICAgICAgICAgICAgICAgICAgICA8VGV4dGFyZWFcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwiRGVzY3JpYmUgdGhlIGRvY3VtZW50IGNvbnRlbnQgYW5kIHB1cnBvc2UuLi5cIlxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwibWluLWgtWzgwcHhdXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIHsuLi5maWVsZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEtdGVzdGlkPVwidGV4dGFyZWEtZG9jdW1lbnQtZGVzY3JpcHRpb25cIlxuICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgIDwvRm9ybUNvbnRyb2w+XG4gICAgICAgICAgICAgICAgICAgIDxGb3JtTWVzc2FnZSAvPlxuICAgICAgICAgICAgICAgICAgPC9Gb3JtSXRlbT5cbiAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgIHsvKiBGaWxlIFVwbG9hZCBTZWN0aW9uICovfVxuICAgICAgICAgICAgPENhcmQ+XG4gICAgICAgICAgICAgIDxDYXJkSGVhZGVyPlxuICAgICAgICAgICAgICAgIDxDYXJkVGl0bGUgY2xhc3NOYW1lPVwiZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTJcIj5cbiAgICAgICAgICAgICAgICAgIDxVcGxvYWQgY2xhc3NOYW1lPVwidy01IGgtNVwiIC8+XG4gICAgICAgICAgICAgICAgICBEb2N1bWVudCBDb250ZW50XG4gICAgICAgICAgICAgICAgPC9DYXJkVGl0bGU+XG4gICAgICAgICAgICAgIDwvQ2FyZEhlYWRlcj5cbiAgICAgICAgICAgICAgPENhcmRDb250ZW50PlxuICAgICAgICAgICAgICAgIDxTaGFyZWRVcGxvYWRlclxuICAgICAgICAgICAgICAgICAgb25Eb2N1bWVudENoYW5nZT17aGFuZGxlRG9jdW1lbnRDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICBmb3JtVHlwZT1cImRvY3VtZW50c1wiXG4gICAgICAgICAgICAgICAgICB1cGxvYWRDb250ZXh0PXt1cGxvYWRDb250ZXh0fVxuICAgICAgICAgICAgICAgICAgc2hvd0FpVG9nZ2xlPXtmYWxzZX0gLy8gVXNlIGNvbmZpZy1iYXNlZCBBSSBlbmFibGVtZW50XG4gICAgICAgICAgICAgICAgICBhbGxvd2VkRmlsZVR5cGVzPXtbXG4gICAgICAgICAgICAgICAgICAgICdhcHBsaWNhdGlvbi9wZGYnLFxuICAgICAgICAgICAgICAgICAgICAnYXBwbGljYXRpb24vbXN3b3JkJyxcbiAgICAgICAgICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50JyxcbiAgICAgICAgICAgICAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5tcy1leGNlbCcsXG4gICAgICAgICAgICAgICAgICAgICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldCcsXG4gICAgICAgICAgICAgICAgICAgICd0ZXh0L3BsYWluJyxcbiAgICAgICAgICAgICAgICAgICAgJ2ltYWdlLyonXG4gICAgICAgICAgICAgICAgICBdfVxuICAgICAgICAgICAgICAgICAgbWF4RmlsZVNpemU9ezI1fVxuICAgICAgICAgICAgICAgICAgZGVmYXVsdFRhYj1cImZpbGVcIlxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPVwidGV4dC14cyB0ZXh0LW11dGVkLWZvcmVncm91bmQgbXQtMlwiPlxuICAgICAgICAgICAgICAgICAgVXBsb2FkIGEgZmlsZSBvciBjcmVhdGUgYSB0ZXh0IGRvY3VtZW50LiBNYXhpbXVtIGZpbGUgc2l6ZTogMjVNQi5cbiAgICAgICAgICAgICAgICA8L3A+XG4gICAgICAgICAgICAgIDwvQ2FyZENvbnRlbnQ+XG4gICAgICAgICAgICA8L0NhcmQ+XG5cbiAgICAgICAgICAgIDxEaWFsb2dGb290ZXI+XG4gICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgICAgICB2YXJpYW50PVwib3V0bGluZVwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xvc2V9XG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2NyZWF0ZURvY3VtZW50TXV0YXRpb24uaXNQZW5kaW5nfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgQ2FuY2VsXG4gICAgICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICAgICAgdHlwZT1cInN1Ym1pdFwiXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ9e2NyZWF0ZURvY3VtZW50TXV0YXRpb24uaXNQZW5kaW5nfVxuICAgICAgICAgICAgICAgIGRhdGEtdGVzdGlkPVwiYnV0dG9uLWNyZWF0ZS1kb2N1bWVudFwiXG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7Y3JlYXRlRG9jdW1lbnRNdXRhdGlvbi5pc1BlbmRpbmcgPyAoXG4gICAgICAgICAgICAgICAgICA8PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImFuaW1hdGUtc3BpbiByb3VuZGVkLWZ1bGwgaC00IHctNCBib3JkZXItYi0yIGJvcmRlci13aGl0ZSBtci0yXCI+PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIENyZWF0aW5nLi4uXG4gICAgICAgICAgICAgICAgICA8Lz5cbiAgICAgICAgICAgICAgICApIDogKFxuICAgICAgICAgICAgICAgICAgPD5cbiAgICAgICAgICAgICAgICAgICAgPEZpbGVUZXh0IGNsYXNzTmFtZT1cInctNCBoLTQgbXItMlwiIC8+XG4gICAgICAgICAgICAgICAgICAgIENyZWF0ZSBEb2N1bWVudFxuICAgICAgICAgICAgICAgICAgPC8+XG4gICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgICAgICA8L0RpYWxvZ0Zvb3Rlcj5cbiAgICAgICAgICA8L2Zvcm0+XG4gICAgICAgIDwvRm9ybT5cbiAgICAgIDwvRGlhbG9nQ29udGVudD5cbiAgICA8L0RpYWxvZz5cbiAgKTtcbn0iXSwidmVyc2lvbiI6M30=