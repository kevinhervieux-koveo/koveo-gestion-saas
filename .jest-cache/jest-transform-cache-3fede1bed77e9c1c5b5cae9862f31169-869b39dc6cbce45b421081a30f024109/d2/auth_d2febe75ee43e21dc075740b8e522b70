d2a1146cb305ba26f944cd40d1c4606f
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sessionConfig = void 0;
exports.hashPassword = hashPassword;
exports.verifyPassword = verifyPassword;
exports.requireAuth = requireAuth;
exports.requireRole = requireRole;
exports.authorize = authorize;
exports.setupAuthRoutes = setupAuthRoutes;
exports.canViewDocument = canViewDocument;
exports.canEditDocument = canEditDocument;
exports.canDeleteDocument = canDeleteDocument;
exports.canCreateDocument = canCreateDocument;
const express_session_1 = __importDefault(require("express-session"));
const connect_pg_simple_1 = __importDefault(require("connect-pg-simple"));
const crypto_1 = require("crypto");
const bcrypt = __importStar(require("bcryptjs"));
const storage_1 = require("./storage");
const db_1 = require("./db");
const index_1 = require("./config/index");
// Database-based permission checking - no config files needed
const serverless_1 = require("@neondatabase/serverless");
const schema = __importStar(require("../shared/schema"));
const drizzle_orm_1 = require("drizzle-orm");
const email_service_1 = require("./services/email-service");
const query_cache_1 = require("./query-cache");
/**
 * Check if a user role has a specific permission via database lookup.
 * @param userRole - The user's role (admin, manager, tenant, resident).
 * @param permissionName - The permission name (e.g., 'read:user', 'create:building').
 * @returns Promise<boolean> - True if user has permission.
 */
async function checkUserPermission(userRole, permissionName) {
    try {
        // Debug logging removed for production security
        // First check if permission exists at all
        const permissionExists = await db_1.db
            .select()
            .from(schema.permissions)
            .where((0, drizzle_orm_1.eq)(schema.permissions.name, permissionName))
            .limit(1);
        // Permission exists check complete
        // Check role permissions
        const rolePermissions = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole));
        // Role permissions checked
        const result = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole), (0, drizzle_orm_1.eq)(schema.permissions.name, permissionName)))
            .limit(1);
        // Permission check completed
        if (result.length === 0) {
            // Permission not found
            // Debug: list all admin permissions
            if (userRole === 'admin') {
                const adminPerms = await db_1.db
                    .select({ name: schema.permissions.name })
                    .from(schema.rolePermissions)
                    .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
                    .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, 'admin'));
                // Admin permissions debug removed for security
            }
        }
        return result.length > 0;
    }
    catch (error) {
        console.error('‚ùå Permission check failed:', error);
        return false;
    }
}
// Initialize email service
const emailService = new email_service_1.EmailService();
// Database connection already imported at top of file
// Configure session store with PostgreSQL
const PostgreSqlStore = (0, connect_pg_simple_1.default)(express_session_1.default);
/**
 * Get the correct database URL based on environment and request domain.
 * Uses centralized configuration to determine the appropriate database.
 */
function getDatabaseUrl(requestDomain) {
    // Use the centralized database configuration
    const selectedUrl = index_1.config.database.getRuntimeDatabaseUrl(requestDomain);
    const isKoveoRequest = requestDomain?.includes('koveo-gestion.com');
    const isProduction = index_1.config.server.isProduction || isKoveoRequest;
    console.log(`üîó Session store using ${isProduction ? 'PRODUCTION' : 'DEVELOPMENT'} database: ${selectedUrl?.substring(0, 50)}... (domain: ${requestDomain || 'unknown'})`);
    if (!selectedUrl) {
        throw new Error('No database URL available for session store');
    }
    return selectedUrl;
}
/**
 * Session configuration for Quebec-compliant user authentication.
 * Uses PostgreSQL session store for scalability and Law 25 compliance.
 * Includes fallback for database connection issues in production.
 */
function createSessionStore(requestDomain) {
    try {
        // Create a proper PostgreSQL pool for the session store
        // connect-pg-simple needs a real PostgreSQL pool, not the Neon HTTP client
        const sessionPool = new serverless_1.Pool({
            connectionString: getDatabaseUrl(requestDomain),
            max: 2, // Small pool for sessions
            min: 1,
            maxUses: 7500, // Maximum number of times a connection can be reused
            idleTimeoutMillis: 30000, // 30 seconds idle timeout
            allowExitOnIdle: true, // Allow pool to close when idle
        });
        // Use PostgreSQL session store for persistent sessions
        const store = new PostgreSqlStore({
            pool: sessionPool,
            tableName: 'session',
            createTableIfMissing: true, // Auto-create table in production if missing
            errorLog: process.env.NODE_ENV === 'test' ? () => { } : console.error, // Suppress error logging in tests
            // Add explicit configuration for session retrieval
            pruneSessionInterval: process.env.NODE_ENV === 'test' ? false : 60 * 1000, // Disable pruning in tests
            schemaName: 'public', // Explicitly set schema
        });
        console.log('‚úÖ Session store: PostgreSQL session store created with proper pool');
        // Test the store connection (skip in test environment)
        if (process.env.NODE_ENV !== 'test') {
            store.get('test-session-id', (err, session) => {
                if (err) {
                    console.error('‚ùå Session store connection test failed:', err);
                }
                else {
                    console.log('‚úÖ Session store connection test passed');
                }
            });
        }
        return store;
    }
    catch (error) {
        console.error('‚ùå Session store creation failed:', error);
        console.log('‚ö†Ô∏è Falling back to memory store (sessions will not persist)');
        return undefined; // Will use default memory store as fallback
    }
}
// Create session store with better database detection  
let sessionStore;
try {
    // Try to create session store with automatic database detection
    sessionStore = createSessionStore();
}
catch (error) {
    console.error('‚ùå Failed to create initial session store:', error);
    sessionStore = undefined; // Will fall back to memory store
}
exports.sessionConfig = (0, express_session_1.default)({
    store: sessionStore, // Use PostgreSQL session store for persistence
    secret: process.env.SESSION_SECRET || 'fallback-secret-change-in-production',
    resave: false, // Don't save unchanged sessions
    saveUninitialized: false,
    rolling: true, // Reset expiry on each request
    cookie: {
        secure: false, // Keep false for development to ensure cookies work
        httpOnly: true,
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days - longer session duration
        sameSite: 'lax',
        path: '/', // Explicitly set path
    },
    name: 'koveo.sid',
    proxy: false,
});
/**
 * Enhanced password hashing using bcrypt with salt for Quebec Law 25 compliance.
 * Provides strong security using industry-standard bcrypt algorithm
 * with configurable salt rounds (default: 12).
 *
 * @param {string} password - Plain text password to hash.
 * @returns {Promise<string>} Promise resolving to bcrypt hashed password.
 *
 * @example
 * ```typescript
 * const hashedPassword = await hashPassword('userPassword123');
 * // Store hashed password securely in database
 * await storage.createUser({ ...userData, password: hashedPassword });
 * ```
 */
/**
 * HashPassword function.
 * @param password
 * @returns Function result.
 */
async function hashPassword(password) {
    const saltRounds = 12; // Recommended for production
    return await bcrypt.hash(password, saltRounds);
}
/**
 * Verifies a password against stored bcrypt hash using constant-time comparison.
 * Uses bcrypt.compare for secure password verification.
 *
 * @param {string} password - Plain text password to verify.
 * @param {string} hashedPassword - Stored bcrypt hash from user record.
 * @returns {Promise<boolean>} Promise resolving to true if password matches, false otherwise.
 *
 * @example
 * ```typescript
 * const user = await storage.getUserByEmail(email);
 * const isValid = await verifyPassword(inputPassword, user.password);
 * if (isValid) {
 *   // Grant access
 * }
 * ```
 */
/**
 * VerifyPassword function.
 * @param password
 * @param hashedPassword
 * @returns Function result.
 */
async function verifyPassword(password, hashedPassword) {
    return await bcrypt.compare(password, hashedPassword);
}
/**
 * Authentication middleware to protect routes requiring user login.
 * Validates session existence, retrieves user data, and ensures account is active.
 * Automatically destroys invalid sessions for security.
 *
 * @param {Request} req - Express request object with session data.
 * @param {Response} res - Express response object for sending error responses.
 * @param {NextFunction} next - Express next function to continue to protected route.
 * @returns {Promise<void>} Promise that resolves when authentication is verified.
 *
 * @example
 * ```typescript
 * app.get('/api/protected-route', requireAuth, async (req, res) => {
 *   // req.user is now available and verified
 *   res.json({ userId: req.user.id });
 * });
 * ```
 */
/**
 * RequireAuth function.
 * @param req
 * @param res
 * @param next
 * @returns Function result.
 */
async function requireAuth(req, res, next) {
    if (!req.session?.userId) {
        return res.status(401).json({
            message: 'Authentication required',
            code: 'AUTH_REQUIRED',
        });
    }
    try {
        // Optimized session touch - only touch when session is close to expiring
        if (req.session && req.session.touch && req.session.cookie) {
            const now = Date.now();
            const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
            const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
            // Only touch session if more than 25% of its lifetime has passed
            if (sessionAge > sessionLifetime * 0.25) {
                req.session.touch();
            }
        }
        // Loading user session
        // Clear any cached user data for this ID to ensure fresh load
        query_cache_1.queryCache.invalidate('users', `user:${req.session.userId}`);
        query_cache_1.queryCache.invalidate('users', `user_email:*`);
        const user = await storage_1.storage.getUser(req.session.userId);
        // User loaded from session
        if (!user || !user.isActive) {
            req.session.destroy((err) => {
                if (err) {
                    // Session destruction error handled
                }
            });
            return res.status(401).json({
                message: 'User account not found or inactive',
                code: 'USER_INACTIVE',
            });
        }
        // Set session role (permissions handled via database)
        req.session.role = user.role;
        // Add organization information to the user object - with error handling for resilience
        let userOrganizations = [];
        try {
            userOrganizations = await db_1.db
                .select({
                organizationId: schema.userOrganizations.organizationId,
                canAccessAllOrganizations: schema.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema.userOrganizations)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.userOrganizations.userId, user.id), (0, drizzle_orm_1.eq)(schema.userOrganizations.isActive, true)));
        }
        catch (orgError) {
            // Organization lookup error handled gracefully
            // Continue with empty organizations - user can still authenticate
            userOrganizations = [];
        }
        // Enhanced user object with organization access information
        req.user = {
            ...user,
            organizations: userOrganizations.map((uo) => uo.organizationId),
            canAccessAllOrganizations: userOrganizations.some((uo) => uo.canAccessAllOrganizations),
        };
        // Special handling for hardcoded demo users - ensure they have proper organization access
        // Check if the user record has organization access configured
        if (user.role?.startsWith('demo_') &&
            (!req.user.organizations || req.user.organizations.length === 0)) {
            // Demo users should get access to demo organizations
            try {
                const demoOrgs = await db_1.db
                    .select({ id: schema.organizations.id })
                    .from(schema.organizations)
                    .where((0, drizzle_orm_1.eq)(schema.organizations.type, 'demo'))
                    .limit(1);
                if (demoOrgs.length > 0) {
                    // Adding organization access for demo user
                    req.user.organizations = [demoOrgs[0].id];
                    req.user.canAccessAllOrganizations = false;
                }
            }
            catch (demoOrgError) {
                // Demo organization lookup failed, continue without access
            }
        }
        next();
    }
    catch (error) {
        // Authentication error handled
        console.error('‚ùå Authentication error:', error);
        return res.status(500).json({
            message: 'Authentication error',
            code: 'AUTH_ERROR',
        });
    }
}
/**
 * Role-based authorization middleware factory for Quebec property management roles.
 * Creates middleware that restricts access based on user roles such as admin, manager, tenant.
 * Must be used after requireAuth middleware.
 *
 * @param {string[]} allowedRoles - Array of roles that can access the route (e.g., ['admin', 'manager']).
 * @returns {Function} Express middleware function for role validation.
 *
 * @example
 * ```typescript
 * // Only admins can access user management
 * app.get('/api/admin/users', requireAuth, requireRole(['admin']), getUserList);
 *
 * // Managers and admins can access building data
 * app.get('/api/buildings', requireAuth, requireRole(['admin', 'manager']), getBuildings);
 * ```
 */
/**
 * RequireRole function.
 * @param allowedRoles
 * @returns Function result.
 */
function requireRole(allowedRoles) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        if (!allowedRoles.includes(req.user.role)) {
            return res.status(403).json({
                message: 'Insufficient permissions',
                code: 'INSUFFICIENT_PERMISSIONS',
                required: allowedRoles,
                current: req.user.role,
            });
        }
        next();
    };
}
/**
 * Permission-based authorization middleware factory using the comprehensive RBAC system.
 * Validates user permissions based on the database RBAC system.
 * Must be used after requireAuth middleware.
 *
 * @param {string} permission - Specific permission required to access the route (e.g., 'read:bill', 'create:maintenance_request').
 * @returns {Function} Express middleware function for permission validation.
 *
 * @example
 * ```typescript
 * // Only users with 'read:bill' permission can access
 * app.get('/api/bills', requireAuth, authorize('read:bill'), getBills);
 *
 * // Only users with 'delete:user' permission can delete users
 * app.delete('/api/users/:id', requireAuth, authorize('delete:user'), deleteUser);
 *
 * // Multiple route protection
 * router.use(authorize('manage:building'));
 * router.post('/buildings', createBuilding);
 * router.patch('/buildings/:id', updateBuilding);
 * ```
 */
/**
 * Authorize function.
 * @param permission
 * @returns Function result.
 */
function authorize(permission) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Check if the user's role has the required permission via database
            const hasPermission = await checkUserPermission(req.user.role, permission);
            if (!hasPermission) {
                return res.status(403).json({
                    message: 'Insufficient permissions',
                    code: 'PERMISSION_DENIED',
                    required: permission,
                    userRole: req.user.role,
                    details: `User with role '${req.user.role}' does not have permission '${permission}'`,
                });
            }
            next();
        }
        catch (error) {
            // Authorization error handled
            console.error('‚ùå Authorization error:', error);
            return res.status(500).json({
                message: 'Authorization check failed',
                code: 'AUTHORIZATION_ERROR',
            });
        }
    };
}
/**
 * Sets up authentication routes for Quebec-compliant user management.
 * Implements login, logout, registration, and current user endpoints
 * with proper session management and Law 25 compliance considerations.
 *
 * @param {any} app - Express application instance to register routes on.
 * @returns {void} No return value - routes are registered directly on app.
 *
 * @example
 * ```typescript
 * const app = express();
 * app.use(sessionConfig);
 * setupAuthRoutes(app);
 * // Authentication routes are now available:
 * // POST /api/auth/login
 * // POST /api/auth/logout
 * // GET /api/auth/user
 * // POST /api/auth/register
 * ```
 */
/**
 * SetupAuthRoutes function.
 * @param app
 * @returns Function result.
 */
function setupAuthRoutes(app) {
    // Login route
    app.post('/api/auth/login', async (req, res) => {
        try {
            const { email, password } = req.body;
            // Login attempt initiated
            if (!email || !password) {
                return res.status(400).json({
                    message: 'Email and password are required',
                    code: 'MISSING_CREDENTIALS',
                });
            }
            // Retrieving user by email
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            if (!user.isActive) {
                return res.status(401).json({
                    message: 'Account is inactive',
                    code: 'ACCOUNT_INACTIVE',
                });
            }
            // Use bcrypt for password verification
            // Verifying password for user
            // Password verification initiated
            const isValidPassword = await verifyPassword(password, user.password);
            // Password verification completed
            if (!isValidPassword) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            // Update last login
            await storage_1.storage.updateUser(user.id, { lastLoginAt: new Date() });
            // Set session with user data
            req.session.userId = user.id;
            req.session.userRole = user.role;
            req.session.role = user.role;
            req.session.user = user; // Add complete user object for middleware compatibility
            // Save session explicitly to ensure it's persisted
            req.session.save((err) => {
                if (err) {
                    console.error('‚ùå Session save error:', err);
                    return res.status(500).json({
                        message: 'Session save failed',
                        code: 'SESSION_SAVE_ERROR',
                    });
                }
                // Return user data (without password)
                const { password: _, ...userData } = user;
                res.json({
                    user: userData,
                    message: 'Login successful',
                });
            });
        }
        catch (_error) {
            console.error('Login error:', {
                error: _error,
                email: req.body?.email,
                hasPassword: !!req.body?.password,
                databaseUrl: !!process.env.DATABASE_URL,
                sessionSecret: !!process.env.SESSION_SECRET,
            });
            res.status(500).json({
                message: 'Login failed',
                code: 'LOGIN_ERROR',
                ...(process.env.NODE_ENV === 'development' && { details: _error }),
            });
        }
    });
    // Logout route
    app.post('/api/auth/logout', (req, res) => {
        req.session.destroy((err) => {
            if (err) {
                console.error('Logout _error:', err);
                return res.status(500).json({
                    message: 'Logout failed',
                    code: 'LOGOUT_ERROR',
                });
            }
            // Clear cookie with same settings as when it was set
            const cookieOptions = {
                httpOnly: true,
                secure: process.env.NODE_ENV === 'production',
                sameSite: 'lax',
            };
            res.clearCookie('koveo.sid', cookieOptions);
            res.json({ message: 'Logout successful' });
        });
    });
    // Get current user route
    app.get('/api/auth/user', async (req, res) => {
        try {
            // Check user session
            console.log('üîç Auth check - Session exists:', !!req.session);
            console.log('üîç Auth check - Session ID:', req.session?.id?.substring(0, 8) + '...');
            console.log('üîç Auth check - User ID in session:', req.session?.userId);
            // Check if we have a valid session with user ID
            if (!req.session?.userId) {
                // No session found
                console.log('‚ùå No valid session found');
                return res.status(401).json({
                    message: 'Not authenticated',
                    code: 'NOT_AUTHENTICATED',
                });
            }
            // Try to get user from database
            try {
                const user = await storage_1.storage.getUser(req.session.userId);
                // User lookup completed
                if (!user || !user.isActive) {
                    // User not found or inactive, destroying session
                    req.session.destroy((err) => {
                        if (err) {
                            console.error('Session destruction error:', err);
                        }
                    });
                    return res.status(401).json({
                        message: 'User account not found or inactive',
                        code: 'USER_INACTIVE',
                    });
                }
                // Optimized session touch - only when needed
                if (req.session && req.session.touch && req.session.cookie) {
                    const now = Date.now();
                    const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
                    const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
                    // Only touch session if more than 25% of its lifetime has passed
                    if (sessionAge > sessionLifetime * 0.25) {
                        req.session.touch();
                    }
                }
                // Return user data without password
                const { password: _, ...userData } = user;
                // Successfully authenticated user
                res.json(userData);
            }
            catch (userError) {
                console.error('Database error getting user:', userError);
                return res.status(500).json({
                    message: 'Authentication check failed',
                    code: 'AUTH_CHECK_ERROR',
                });
            }
        }
        catch (error) {
            console.error('‚ùå Auth check error:', error);
            res.status(500).json({
                message: 'Authentication check failed',
                code: 'AUTH_CHECK_ERROR',
            });
        }
    });
    // Debug endpoint to check auth configuration (production only, temporary)
    app.get('/api/auth/debug', async (req, res) => {
        const debugInfo = {
            hasSession: !!req.session,
            sessionId: req.sessionID,
            userId: req.session?.userId,
            userRole: req.session?.userRole,
            nodeEnv: process.env.NODE_ENV,
            hasDatabaseUrl: !!process.env.DATABASE_URL,
            hasSessionSecret: !!process.env.SESSION_SECRET,
            cookies: req.headers.cookie ? 'present' : 'missing',
            cookieHeader: req.headers.cookie,
            sessionStore: req.session?.store?.constructor?.name || 'unknown',
            userAgent: req.headers['user-agent'],
            host: req.headers.host,
            protocol: req.protocol,
            secure: req.secure,
            trustProxy: !!req.app.get('trust proxy'),
        };
        console.log('Auth debug info:', debugInfo);
        res.json(debugInfo);
    });
    // Test cookie setting endpoint
    app.post('/api/auth/test-cookie', (req, res) => {
        // Set a test session value
        req.session.testValue = 'test-' + Date.now();
        req.session.save((err) => {
            if (err) {
                return res.status(500).json({ error: 'Failed to save session', details: err.message });
            }
            res.json({
                message: 'Test cookie set',
                sessionId: req.sessionID,
                testValue: req.session.testValue,
                cookieSettings: {
                    secure: process.env.NODE_ENV === 'production',
                    httpOnly: true,
                    sameSite: 'lax',
                },
            });
        });
    });
    // Register route (admin only for now)
    app.post('/api/auth/register', requireAuth, requireRole(['admin']), async (req, res) => {
        try {
            const { email, password, firstName, lastName, role = 'tenant', language = 'fr' } = req.body;
            if (!email || !password || !firstName || !lastName) {
                return res.status(400).json({
                    message: 'All fields are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Check if user already exists
            const existingUser = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (existingUser) {
                return res.status(409).json({
                    message: 'User already exists',
                    code: 'USER_EXISTS',
                });
            }
            // Create user with bcrypt hashed password
            const hashedPassword = await hashPassword(password);
            const newUser = await storage_1.storage.createUser({
                email: email.toLowerCase(),
                password: hashedPassword,
                firstName,
                lastName,
                username: email.toLowerCase(), // Use email as username
                role,
                language,
            });
            const { password: _, ...userData } = newUser;
            res.status(201).json({
                user: userData,
                message: 'User created successfully',
            });
        }
        catch (error) {
            console.error('‚ùå Registration error:', error);
            res.status(500).json({
                message: 'Registration failed',
                code: 'REGISTRATION_ERROR',
            });
        }
    });
    // Password Reset Request Route
    app.post('/api/auth/forgot-password', async (req, res) => {
        try {
            const { email } = req.body;
            if (!email) {
                return res.status(400).json({
                    message: 'Email is required',
                    code: 'MISSING_EMAIL',
                });
            }
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user || !user.isActive) {
                // Always respond with success for security (don't reveal if email exists)
                return res.json({
                    message: 'If this email exists, a password reset link has been sent.',
                    success: true,
                });
            }
            // Generate secure random token
            const resetToken = (0, crypto_1.randomBytes)(32).toString('hex');
            const tokenHash = (0, crypto_1.createHash)('sha256').update(resetToken).digest('hex');
            // Create password reset token (expires in 1 hour)
            const expiresAt = new Date();
            expiresAt.setHours(expiresAt.getHours() + 1);
            await storage_1.storage.createPasswordResetToken({
                userId: user.id,
                token: resetToken,
                tokenHash: tokenHash,
                expiresAt: expiresAt,
                ipAddress: req.ip || req.connection?.remoteAddress || 'unknown',
                userAgent: req.headers['user-agent'] || 'unknown',
            });
            // Send password reset email
            const host = req.get('host') || '';
            // Use development URL for Replit environments, production URL otherwise
            let frontendUrl;
            if (host.includes('replit.dev') ||
                host.includes('replit.com') ||
                host.includes('replit.co') ||
                process.env.NODE_ENV === 'development') {
                // Use the actual Replit development URL
                frontendUrl = `${req.protocol}://${host}`;
            }
            else {
                // Use production URL - prioritize koveo-gestion.com for production
                if (host.includes('koveo-gestion.com')) {
                    frontendUrl = `https://${host}`;
                }
                else {
                    frontendUrl = process.env.FRONTEND_URL || 'https://koveo-gestion.com';
                }
            }
            const cleanUrl = frontendUrl.endsWith('/') ? frontendUrl.slice(0, -1) : frontendUrl;
            const resetUrl = `${cleanUrl}/reset-password?token=${resetToken}`;
            const emailSent = await emailService.sendPasswordResetEmail(email.toLowerCase(), `${user.firstName} ${user.lastName}`, resetUrl);
            if (!emailSent) {
                console.error('Failed to send password reset email to:', email);
                return res.status(500).json({
                    message: 'Failed to send password reset email',
                    code: 'EMAIL_SEND_FAILED',
                });
            }
            res.json({
                message: 'If this email exists, a password reset link has been sent.',
                success: true,
            });
        }
        catch (error) {
            console.error('‚ùå Password reset request error:', error);
            res.status(500).json({
                message: 'Password reset request failed',
                code: 'PASSWORD_RESET_REQUEST_ERROR',
            });
        }
    });
    // Password Reset Route
    app.post('/api/auth/reset-password', async (req, res) => {
        try {
            const { token, password } = req.body;
            if (!token || !password) {
                return res.status(400).json({
                    message: 'Token and password are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Validate password strength
            if (password.length < 8) {
                return res.status(400).json({
                    message: 'Password must be at least 8 characters long',
                    code: 'PASSWORD_TOO_SHORT',
                });
            }
            // Check password complexity requirements
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
                return res.status(400).json({
                    message: 'Password must contain at least one uppercase letter, one lowercase letter, and one number',
                    code: 'PASSWORD_TOO_WEAK',
                });
            }
            // Find the password reset token
            const resetToken = await storage_1.storage.getPasswordResetToken(token);
            if (!resetToken) {
                return res.status(400).json({
                    message: 'Invalid or expired password reset token',
                    code: 'INVALID_TOKEN',
                });
            }
            // Check if token is expired
            if (new Date() > resetToken.expiresAt) {
                return res.status(400).json({
                    message: 'Password reset token has expired',
                    code: 'TOKEN_EXPIRED',
                });
            }
            // Check if token has already been used
            if (resetToken.isUsed) {
                return res.status(400).json({
                    message: 'Password reset token has already been used',
                    code: 'TOKEN_ALREADY_USED',
                });
            }
            // Verify token hash for additional security
            const tokenHash = (0, crypto_1.createHash)('sha256').update(token).digest('hex');
            if (tokenHash !== resetToken.tokenHash) {
                return res.status(400).json({
                    message: 'Invalid password reset token',
                    code: 'INVALID_TOKEN_HASH',
                });
            }
            // Get the user
            const user = await storage_1.storage.getUser(resetToken.userId);
            if (!user || !user.isActive) {
                return res.status(400).json({
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                });
            }
            // Update user password with bcrypt hashed version
            const hashedPassword = await hashPassword(password);
            await storage_1.storage.updateUser(user.id, {
                password: hashedPassword,
                updatedAt: new Date(),
            });
            // Mark token as used
            await storage_1.storage.markPasswordResetTokenAsUsed(resetToken.id);
            // Clean up expired tokens
            await storage_1.storage.cleanupExpiredPasswordResetTokens();
            res.json({
                message: 'Password has been reset successfully',
                success: true,
            });
        }
        catch (error) {
            console.error('‚ùå Password reset error:', error);
            res.status(500).json({
                message: 'Password reset failed',
                code: 'PASSWORD_RESET_ERROR',
            });
        }
    });
}
/**
 * Document RBAC Functions - Role-Based Access Control for Documents
 * Implements the four-tier permission system: Admin > Manager > Resident > Tenant
 */
/**
 * Check if user can view a specific document based on RBAC rules
 * @param user - The authenticated user
 * @param document - The document to check access for
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can view document
 */
async function canViewDocument(user, document, userResidences) {
    try {
        // Admin: Can view all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can view all documents in their organization
        if (user.role === 'manager') {
            // Check if document belongs to manager's organization
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true; // Manager can view organization-level docs
        }
        // Resident: Can view documents in their residence/building
        if (user.role === 'resident') {
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            if (document.buildingId) {
                // Can view building docs if they live in that building
                const userBuildingIds = userResidences?.map(async (ur) => {
                    const residence = await storage_1.storage.getResidence(ur.residenceId);
                    return residence?.buildingId;
                });
                const buildingIds = await Promise.all(userBuildingIds || []);
                return buildingIds.includes(document.buildingId);
            }
            return false;
        }
        // Tenant: Can only view documents marked as visible to tenants
        if (user.role === 'tenant') {
            if (!document.isVisibleToTenants) {
                return false;
            }
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            if (document.buildingId) {
                const userBuildingIds = userResidences?.map(async (ur) => {
                    const residence = await storage_1.storage.getResidence(ur.residenceId);
                    return residence?.buildingId;
                });
                const buildingIds = await Promise.all(userBuildingIds || []);
                return buildingIds.includes(document.buildingId);
            }
            return false;
        }
        return false;
    }
    catch (error) {
        console.error('Document view permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can edit a specific document
 * @param user - The authenticated user
 * @param document - The document to check
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can edit document
 */
async function canEditDocument(user, document, userResidences) {
    try {
        // Admin: Can edit all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can edit all documents in their organization
        if (user.role === 'manager') {
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can edit documents they created or in their residence
        if (user.role === 'resident') {
            // Can edit own documents
            if (document.uploadedBy === user.id) {
                return true;
            }
            // Can edit residence documents
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            return false;
        }
        // Tenant: Cannot edit documents (read-only access)
        return false;
    }
    catch (error) {
        console.error('Document edit permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can delete a specific document
 * @param user - The authenticated user
 * @param document - The document to check
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can delete document
 */
async function canDeleteDocument(user, document, userResidences) {
    try {
        // Admin: Can delete all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can delete documents in their organization
        if (user.role === 'manager') {
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can only delete documents they uploaded
        if (user.role === 'resident') {
            return document.uploadedBy === user.id;
        }
        // Tenant: Cannot delete documents
        return false;
    }
    catch (error) {
        console.error('Document delete permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can create documents in a specific context
 * @param user - The authenticated user
 * @param context - The context (buildingId, residenceId, or organization)
 * @returns Promise<boolean> - True if user can create documents
 */
async function canCreateDocument(user, context) {
    try {
        // Admin: Can create documents anywhere
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can create documents in their organization
        if (user.role === 'manager') {
            if (context.organizationId) {
                return context.organizationId === user.organizationId;
            }
            if (context.buildingId) {
                const building = await storage_1.storage.getBuilding(context.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (context.residenceId) {
                const residence = await storage_1.storage.getResidence(context.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can create documents in their residence
        if (user.role === 'resident') {
            if (context.residenceId) {
                // Check if user lives in this residence
                const userResidences = await storage_1.storage.getUserResidences(user.id);
                return userResidences.some(ur => ur.residenceId === context.residenceId);
            }
            return false;
        }
        // Tenant: Cannot create documents
        return false;
    }
    catch (error) {
        console.error('Document create permission check failed:', error);
        return false;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXV0aC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUE4TUEsb0NBR0M7QUF5QkQsd0NBRUM7QUEyQkQsa0NBeUdDO0FBd0JELGtDQW9CQztBQTZCRCw4QkFpQ0M7QUEyQkQsMENBd2RDO0FBY0QsMENBc0VDO0FBU0QsMENBK0NDO0FBU0QsOENBc0NDO0FBUUQsOENBNkNDO0FBNXJDRCxzRUFBc0M7QUFDdEMsMEVBQTBDO0FBQzFDLG1DQUFpRDtBQUNqRCxpREFBbUM7QUFDbkMsdUNBQW9DO0FBQ3BDLDZCQUFxQztBQUNyQywwQ0FBd0M7QUFFeEMsOERBQThEO0FBQzlELHlEQUFnRDtBQUVoRCx5REFBMkM7QUFDM0MsNkNBQXNDO0FBQ3RDLDREQUF3RDtBQUN4RCwrQ0FBMkM7QUFFM0M7Ozs7O0dBS0c7QUFDSCxLQUFLLFVBQVUsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxjQUFzQjtJQUN6RSxJQUFJLENBQUM7UUFDSCxnREFBZ0Q7UUFFaEQsMENBQTBDO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxPQUFFO2FBQzlCLE1BQU0sRUFBRTthQUNSLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO2FBQ3hCLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7YUFDbEQsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRVosbUNBQW1DO1FBRW5DLHlCQUF5QjtRQUN6QixNQUFNLGVBQWUsR0FBRyxNQUFNLE9BQUU7YUFDN0IsTUFBTSxFQUFFO2FBQ1IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7YUFDNUIsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxRQUFlLENBQUMsQ0FBQyxDQUFDO1FBRTNELDJCQUEyQjtRQUUzQixNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQUU7YUFDcEIsTUFBTSxFQUFFO2FBQ1IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7YUFDNUIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBQSxnQkFBRSxFQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDNUYsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsUUFBZSxDQUFDLEVBQ2hELElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FDNUMsQ0FDRjthQUNBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVaLDZCQUE2QjtRQUU3QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDeEIsdUJBQXVCO1lBQ3ZCLG9DQUFvQztZQUNwQyxJQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDekIsTUFBTSxVQUFVLEdBQUcsTUFBTSxPQUFFO3FCQUN4QixNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztxQkFDekMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7cUJBQzVCLFFBQVEsQ0FDUCxNQUFNLENBQUMsV0FBVyxFQUNsQixJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FDL0Q7cUJBQ0EsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCwrQ0FBK0M7WUFDakQsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0FBQ0gsQ0FBQztBQUVELDJCQUEyQjtBQUMzQixNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLEVBQUUsQ0FBQztBQUV4QyxzREFBc0Q7QUFFdEQsMENBQTBDO0FBQzFDLE1BQU0sZUFBZSxHQUFHLElBQUEsMkJBQVMsRUFBQyx5QkFBTyxDQUFDLENBQUM7QUFFM0M7OztHQUdHO0FBQ0gsU0FBUyxjQUFjLENBQUMsYUFBc0I7SUFDNUMsNkNBQTZDO0lBQzdDLE1BQU0sV0FBVyxHQUFHLGNBQU0sQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekUsTUFBTSxjQUFjLEdBQUcsYUFBYSxFQUFFLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLE1BQU0sWUFBWSxHQUFHLGNBQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLGNBQWMsQ0FBQztJQUVsRSxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixZQUFZLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsYUFBYSxjQUFjLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsYUFBYSxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7SUFFM0ssSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsT0FBTyxXQUFXLENBQUM7QUFDckIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLGFBQXNCO0lBQ2hELElBQUksQ0FBQztRQUNILHdEQUF3RDtRQUN4RCwyRUFBMkU7UUFDM0UsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBSSxDQUFDO1lBQzNCLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxhQUFhLENBQUM7WUFDL0MsR0FBRyxFQUFFLENBQUMsRUFBRSwwQkFBMEI7WUFDbEMsR0FBRyxFQUFFLENBQUM7WUFDTixPQUFPLEVBQUUsSUFBSSxFQUFFLHFEQUFxRDtZQUNwRSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsMEJBQTBCO1lBQ3BELGVBQWUsRUFBRSxJQUFJLEVBQUUsZ0NBQWdDO1NBQ3hELENBQUMsQ0FBQztRQUVILHVEQUF1RDtRQUN2RCxNQUFNLEtBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQztZQUNoQyxJQUFJLEVBQUUsV0FBVztZQUNqQixTQUFTLEVBQUUsU0FBUztZQUNwQixvQkFBb0IsRUFBRSxJQUFJLEVBQUUsNkNBQTZDO1lBQ3pFLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxrQ0FBa0M7WUFFeEcsbURBQW1EO1lBQ25ELG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxFQUFFLDJCQUEyQjtZQUN0RyxVQUFVLEVBQUUsUUFBUSxFQUFFLHdCQUF3QjtTQUMvQyxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsR0FBRyxDQUFDLG9FQUFvRSxDQUFDLENBQUM7UUFFbEYsdURBQXVEO1FBQ3ZELElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDcEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRTtnQkFDNUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztvQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNoRSxDQUFDO3FCQUFNLENBQUM7b0JBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO2dCQUN4RCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pELE9BQU8sQ0FBQyxHQUFHLENBQUMsNkRBQTZELENBQUMsQ0FBQztRQUMzRSxPQUFPLFNBQVMsQ0FBQyxDQUFDLDRDQUE0QztJQUNoRSxDQUFDO0FBQ0gsQ0FBQztBQUVELHdEQUF3RDtBQUN4RCxJQUFJLFlBQWlCLENBQUM7QUFDdEIsSUFBSSxDQUFDO0lBQ0gsZ0VBQWdFO0lBQ2hFLFlBQVksR0FBRyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3RDLENBQUM7QUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO0lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQ0FBMkMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNsRSxZQUFZLEdBQUcsU0FBUyxDQUFDLENBQUMsaUNBQWlDO0FBQzdELENBQUM7QUFFWSxRQUFBLGFBQWEsR0FBRyxJQUFBLHlCQUFPLEVBQUM7SUFDbkMsS0FBSyxFQUFFLFlBQVksRUFBRSwrQ0FBK0M7SUFDcEUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLHNDQUFzQztJQUM1RSxNQUFNLEVBQUUsS0FBSyxFQUFFLGdDQUFnQztJQUMvQyxpQkFBaUIsRUFBRSxLQUFLO0lBQ3hCLE9BQU8sRUFBRSxJQUFJLEVBQUUsK0JBQStCO0lBQzlDLE1BQU0sRUFBRTtRQUNOLE1BQU0sRUFBRSxLQUFLLEVBQUUsb0RBQW9EO1FBQ25FLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsbUNBQW1DO1FBQ3BFLFFBQVEsRUFBRSxLQUFLO1FBQ2YsSUFBSSxFQUFFLEdBQUcsRUFBRSxzQkFBc0I7S0FDbEM7SUFDRCxJQUFJLEVBQUUsV0FBVztJQUNqQixLQUFLLEVBQUUsS0FBSztDQUNiLENBQUMsQ0FBQztBQUVIOzs7Ozs7Ozs7Ozs7OztHQWNHO0FBQ0g7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxZQUFZLENBQUMsUUFBZ0I7SUFDakQsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDLENBQUMsNkJBQTZCO0lBQ3BELE9BQU8sTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxjQUFjLENBQUMsUUFBZ0IsRUFBRSxjQUFzQjtJQUMzRSxPQUFPLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUNIOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxXQUFXLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUMvRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQztRQUN6QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSx5QkFBeUI7WUFDbEMsSUFBSSxFQUFFLGVBQWU7U0FDdEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksQ0FBQztRQUNILHlFQUF5RTtRQUN6RSxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsTUFBTSxVQUFVLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JHLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUV2RixpRUFBaUU7WUFDakUsSUFBSSxVQUFVLEdBQUcsZUFBZSxHQUFHLElBQUksRUFBRSxDQUFDO2dCQUN4QyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RCLENBQUM7UUFDSCxDQUFDO1FBRUQsdUJBQXVCO1FBRXZCLDhEQUE4RDtRQUM5RCx3QkFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDN0Qsd0JBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2RCwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUMxQixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLG9DQUFvQztnQkFDdEMsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLG9DQUFvQztnQkFDN0MsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELHNEQUFzRDtRQUN0RCxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRTdCLHVGQUF1RjtRQUN2RixJQUFJLGlCQUFpQixHQUFVLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUM7WUFDSCxpQkFBaUIsR0FBRyxNQUFNLE9BQUU7aUJBQ3pCLE1BQU0sQ0FBQztnQkFDTixjQUFjLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGNBQWM7Z0JBQ3ZELHlCQUF5QixFQUFFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyx5QkFBeUI7YUFDOUUsQ0FBQztpQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDO2lCQUM5QixLQUFLLENBQ0osSUFBQSxpQkFBRyxFQUNELElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsRUFDNUMsSUFBQSxnQkFBRSxFQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQzVDLENBQ0YsQ0FBQztRQUNOLENBQUM7UUFBQyxPQUFPLFFBQVEsRUFBRSxDQUFDO1lBQ2xCLCtDQUErQztZQUMvQyxrRUFBa0U7WUFDbEUsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLENBQUM7UUFFRCw0REFBNEQ7UUFDNUQsR0FBRyxDQUFDLElBQUksR0FBRztZQUNULEdBQUcsSUFBSTtZQUNQLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDL0QseUJBQXlCLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMseUJBQXlCLENBQUM7U0FDakYsQ0FBQztRQUVULDBGQUEwRjtRQUMxRiw4REFBOEQ7UUFDOUQsSUFDRSxJQUFJLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUM7WUFDOUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsRUFDaEUsQ0FBQztZQUNELHFEQUFxRDtZQUNyRCxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFO3FCQUN0QixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztxQkFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7cUJBQzFCLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7cUJBQzVDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFWixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQ3hCLDJDQUEyQztvQkFDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQzFDLEdBQUcsQ0FBQyxJQUFJLENBQUMseUJBQXlCLEdBQUcsS0FBSyxDQUFDO2dCQUM3QyxDQUFDO1lBQ0gsQ0FBQztZQUFDLE9BQU8sWUFBWSxFQUFFLENBQUM7Z0JBQ3RCLDJEQUEyRDtZQUM3RCxDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksRUFBRSxDQUFDO0lBQ1QsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDcEIsK0JBQStCO1FBQy9CLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLElBQUksRUFBRSxZQUFZO1NBQ25CLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSDs7OztHQUlHO0FBQ0gsU0FBZ0IsV0FBVyxDQUFDLFlBQXNCO0lBQ2hELE9BQU8sS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQy9ELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixPQUFPLEVBQUUseUJBQXlCO2dCQUNsQyxJQUFJLEVBQUUsZUFBZTthQUN0QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzFDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSwwQkFBMEI7Z0JBQ25DLElBQUksRUFBRSwwQkFBMEI7Z0JBQ2hDLFFBQVEsRUFBRSxZQUFZO2dCQUN0QixPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJO2FBQ3ZCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLEVBQUUsQ0FBQztJQUNULENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBQ0g7Ozs7R0FJRztBQUNILFNBQWdCLFNBQVMsQ0FBQyxVQUFrQjtJQUMxQyxPQUFPLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUMvRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtnQkFDbEMsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILG9FQUFvRTtZQUNwRSxNQUFNLGFBQWEsR0FBRyxNQUFNLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBRWxGLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDbkIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDBCQUEwQjtvQkFDbkMsSUFBSSxFQUFFLG1CQUFtQjtvQkFDekIsUUFBUSxFQUFFLFVBQVU7b0JBQ3BCLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUk7b0JBQ3ZCLE9BQU8sRUFBRSxtQkFBbUIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLCtCQUErQixVQUFVLEdBQUc7aUJBQ3RGLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFJLEVBQUUsQ0FBQztRQUNULENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLDhCQUE4QjtZQUM5QixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSw0QkFBNEI7Z0JBQ3JDLElBQUksRUFBRSxxQkFBcUI7YUFDNUIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUNIOzs7O0dBSUc7QUFDSCxTQUFnQixlQUFlLENBQUMsR0FBUTtJQUN0QyxjQUFjO0lBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQ2hFLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNyQywwQkFBMEI7WUFFMUIsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUN4QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsaUNBQWlDO29CQUMxQyxJQUFJLEVBQUUscUJBQXFCO2lCQUM1QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsMkJBQTJCO1lBQzNCLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNWLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxxQkFBcUI7b0JBQzlCLElBQUksRUFBRSxxQkFBcUI7aUJBQzVCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNuQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUJBQXFCO29CQUM5QixJQUFJLEVBQUUsa0JBQWtCO2lCQUN6QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsdUNBQXVDO1lBQ3ZDLDhCQUE4QjtZQUM5QixrQ0FBa0M7WUFDbEMsTUFBTSxlQUFlLEdBQUcsTUFBTSxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0RSxrQ0FBa0M7WUFFbEMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNyQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUJBQXFCO29CQUM5QixJQUFJLEVBQUUscUJBQXFCO2lCQUM1QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsb0JBQW9CO1lBQ3BCLE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUUvRCw2QkFBNkI7WUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2pDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsd0RBQXdEO1lBRWpGLG1EQUFtRDtZQUNuRCxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUN2QixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQzVDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxxQkFBcUI7d0JBQzlCLElBQUksRUFBRSxvQkFBb0I7cUJBQzNCLENBQUMsQ0FBQztnQkFDTCxDQUFDO2dCQUdELHNDQUFzQztnQkFDdEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7Z0JBQzFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7b0JBQ1AsSUFBSSxFQUFFLFFBQVE7b0JBQ2QsT0FBTyxFQUFFLGtCQUFrQjtpQkFDNUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxNQUFXLEVBQUUsQ0FBQztZQUNyQixPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtnQkFDNUIsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSztnQkFDdEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVE7Z0JBQ2pDLFdBQVcsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO2dCQUN2QyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYzthQUM1QyxDQUFDLENBQUM7WUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLGNBQWM7Z0JBQ3ZCLElBQUksRUFBRSxhQUFhO2dCQUNuQixHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDO2FBQ25FLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILGVBQWU7SUFDZixHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQzNELEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDMUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsZUFBZTtvQkFDeEIsSUFBSSxFQUFFLGNBQWM7aUJBQ3JCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxxREFBcUQ7WUFDckQsTUFBTSxhQUFhLEdBQVE7Z0JBQ3pCLFFBQVEsRUFBRSxJQUFJO2dCQUNkLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZO2dCQUM3QyxRQUFRLEVBQUUsS0FBSzthQUNoQixDQUFDO1lBRUYsR0FBRyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILHlCQUF5QjtJQUN6QixHQUFHLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDOUQsSUFBSSxDQUFDO1lBQ0gscUJBQXFCO1lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDckYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBRXhFLGdEQUFnRDtZQUNoRCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQztnQkFDekIsbUJBQW1CO2dCQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixDQUFDLENBQUM7Z0JBQ3hDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxtQkFBbUI7b0JBQzVCLElBQUksRUFBRSxtQkFBbUI7aUJBQzFCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxnQ0FBZ0M7WUFDaEMsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdkQsd0JBQXdCO2dCQUV4QixJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUM1QixpREFBaUQ7b0JBQ2pELEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7d0JBQzFCLElBQUksR0FBRyxFQUFFLENBQUM7NEJBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxHQUFHLENBQUMsQ0FBQzt3QkFDbkQsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQztvQkFDSCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUMxQixPQUFPLEVBQUUsb0NBQW9DO3dCQUM3QyxJQUFJLEVBQUUsZUFBZTtxQkFDdEIsQ0FBQyxDQUFDO2dCQUNMLENBQUM7Z0JBRUQsNkNBQTZDO2dCQUM3QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDM0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO29CQUN2QixNQUFNLFVBQVUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3JHLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztvQkFFdkYsaUVBQWlFO29CQUNqRSxJQUFJLFVBQVUsR0FBRyxlQUFlLEdBQUcsSUFBSSxFQUFFLENBQUM7d0JBQ3hDLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ3RCLENBQUM7Z0JBQ0gsQ0FBQztnQkFFRCxvQ0FBb0M7Z0JBQ3BDLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLEdBQUcsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDO2dCQUMxQyxrQ0FBa0M7Z0JBQ2xDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFckIsQ0FBQztZQUFDLE9BQU8sU0FBUyxFQUFFLENBQUM7Z0JBQ25CLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ3pELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSw2QkFBNkI7b0JBQ3RDLElBQUksRUFBRSxrQkFBa0I7aUJBQ3pCLENBQUMsQ0FBQztZQUNMLENBQUM7UUFDSCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsNkJBQTZCO2dCQUN0QyxJQUFJLEVBQUUsa0JBQWtCO2FBQ3pCLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILDBFQUEwRTtJQUMxRSxHQUFHLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDL0QsTUFBTSxTQUFTLEdBQUc7WUFDaEIsVUFBVSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTztZQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVM7WUFDeEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTTtZQUMzQixRQUFRLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRO1lBQy9CLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVE7WUFDN0IsY0FBYyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVk7WUFDMUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztZQUM5QyxPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNuRCxZQUFZLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQ2hDLFlBQVksRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsSUFBSSxJQUFJLFNBQVM7WUFDaEUsU0FBUyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDO1lBQ3BDLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUk7WUFDdEIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtZQUNsQixVQUFVLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztTQUN6QyxDQUFDO1FBRUYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMzQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RCLENBQUMsQ0FBQyxDQUFDO0lBRUgsK0JBQStCO0lBQy9CLEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDaEUsMkJBQTJCO1FBQzNCLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFN0MsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN2QixJQUFJLEdBQUcsRUFBRSxDQUFDO2dCQUNSLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsd0JBQXdCLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ3pGLENBQUM7WUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLE9BQU8sRUFBRSxpQkFBaUI7Z0JBQzFCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUztnQkFDeEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUztnQkFDaEMsY0FBYyxFQUFFO29CQUNkLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZO29CQUM3QyxRQUFRLEVBQUUsSUFBSTtvQkFDZCxRQUFRLEVBQUUsS0FBSztpQkFDaEI7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsc0NBQXNDO0lBQ3RDLEdBQUcsQ0FBQyxJQUFJLENBQ04sb0JBQW9CLEVBQ3BCLFdBQVcsRUFDWCxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUN0QixLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQ3BDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsSUFBSSxHQUFHLFFBQVEsRUFBRSxRQUFRLEdBQUcsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUU1RixJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ25ELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSx5QkFBeUI7b0JBQ2xDLElBQUksRUFBRSxnQkFBZ0I7aUJBQ3ZCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsTUFBTSxZQUFZLEdBQUcsTUFBTSxpQkFBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUN2RSxJQUFJLFlBQVksRUFBRSxDQUFDO2dCQUNqQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUJBQXFCO29CQUM5QixJQUFJLEVBQUUsYUFBYTtpQkFDcEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELDBDQUEwQztZQUMxQyxNQUFNLGNBQWMsR0FBRyxNQUFNLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVwRCxNQUFNLE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsVUFBVSxDQUFDO2dCQUN2QyxLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRTtnQkFDMUIsUUFBUSxFQUFFLGNBQWM7Z0JBQ3hCLFNBQVM7Z0JBQ1QsUUFBUTtnQkFDUixRQUFRLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLHdCQUF3QjtnQkFDdkQsSUFBSTtnQkFDSixRQUFRO2FBQ1QsQ0FBQyxDQUFDO1lBRUgsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxPQUFPLENBQUM7WUFDN0MsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLElBQUksRUFBRSxRQUFRO2dCQUNkLE9BQU8sRUFBRSwyQkFBMkI7YUFDckMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM5QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLHFCQUFxQjtnQkFDOUIsSUFBSSxFQUFFLG9CQUFvQjthQUMzQixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUNGLENBQUM7SUFFRiwrQkFBK0I7SUFDL0IsR0FBRyxDQUFDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQzFFLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBRTNCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDWCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsbUJBQW1CO29CQUM1QixJQUFJLEVBQUUsZUFBZTtpQkFDdEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDNUIsMEVBQTBFO2dCQUMxRSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7b0JBQ2QsT0FBTyxFQUFFLDREQUE0RDtvQkFDckUsT0FBTyxFQUFFLElBQUk7aUJBQ2QsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELCtCQUErQjtZQUMvQixNQUFNLFVBQVUsR0FBRyxJQUFBLG9CQUFXLEVBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25ELE1BQU0sU0FBUyxHQUFHLElBQUEsbUJBQVUsRUFBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhFLGtEQUFrRDtZQUNsRCxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQzdCLFNBQVMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRTdDLE1BQU0saUJBQU8sQ0FBQyx3QkFBd0IsQ0FBQztnQkFDckMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNmLEtBQUssRUFBRSxVQUFVO2dCQUNqQixTQUFTLEVBQUUsU0FBUztnQkFDcEIsU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxVQUFVLEVBQUUsYUFBYSxJQUFJLFNBQVM7Z0JBQy9ELFNBQVMsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVM7YUFDM0MsQ0FBQyxDQUFDO1lBRVYsNEJBQTRCO1lBQzVCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1lBRW5DLHdFQUF3RTtZQUN4RSxJQUFJLFdBQVcsQ0FBQztZQUNoQixJQUNFLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDO2dCQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztnQkFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7Z0JBQzFCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsRUFDdEMsQ0FBQztnQkFDRCx3Q0FBd0M7Z0JBQ3hDLFdBQVcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxRQUFRLE1BQU0sSUFBSSxFQUFFLENBQUM7WUFDNUMsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLG1FQUFtRTtnQkFDbkUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQztvQkFDdkMsV0FBVyxHQUFHLFdBQVcsSUFBSSxFQUFFLENBQUM7Z0JBQ2xDLENBQUM7cUJBQU0sQ0FBQztvQkFDTixXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksMkJBQTJCLENBQUM7Z0JBQ3hFLENBQUM7WUFDSCxDQUFDO1lBRUQsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO1lBQ3BGLE1BQU0sUUFBUSxHQUFHLEdBQUcsUUFBUSx5QkFBeUIsVUFBVSxFQUFFLENBQUM7WUFHbEUsTUFBTSxTQUFTLEdBQUcsTUFBTSxZQUFZLENBQUMsc0JBQXNCLENBQ3pELEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFDbkIsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFDcEMsUUFBUSxDQUNULENBQUM7WUFFRixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHFDQUFxQztvQkFDOUMsSUFBSSxFQUFFLG1CQUFtQjtpQkFDMUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLDREQUE0RDtnQkFDckUsT0FBTyxFQUFFLElBQUk7YUFDZCxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsK0JBQStCO2dCQUN4QyxJQUFJLEVBQUUsOEJBQThCO2FBQ3JDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILHVCQUF1QjtJQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDekUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBRXJDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLGlDQUFpQztvQkFDMUMsSUFBSSxFQUFFLGdCQUFnQjtpQkFDdkIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELDZCQUE2QjtZQUM3QixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSw2Q0FBNkM7b0JBQ3RELElBQUksRUFBRSxvQkFBb0I7aUJBQzNCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCx5Q0FBeUM7WUFDekMsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1QyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFdkMsSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNsRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQ0wsMkZBQTJGO29CQUM3RixJQUFJLEVBQUUsbUJBQW1CO2lCQUMxQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsZ0NBQWdDO1lBQ2hDLE1BQU0sVUFBVSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM5RCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ2hCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSx5Q0FBeUM7b0JBQ2xELElBQUksRUFBRSxlQUFlO2lCQUN0QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsNEJBQTRCO1lBQzVCLElBQUksSUFBSSxJQUFJLEVBQUUsR0FBRyxVQUFVLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3RDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxrQ0FBa0M7b0JBQzNDLElBQUksRUFBRSxlQUFlO2lCQUN0QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsdUNBQXVDO1lBQ3ZDLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUN0QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsNENBQTRDO29CQUNyRCxJQUFJLEVBQUUsb0JBQW9CO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsNENBQTRDO1lBQzVDLE1BQU0sU0FBUyxHQUFHLElBQUEsbUJBQVUsRUFBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25FLElBQUksU0FBUyxLQUFLLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDdkMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDhCQUE4QjtvQkFDdkMsSUFBSSxFQUFFLG9CQUFvQjtpQkFDM0IsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELGVBQWU7WUFDZixNQUFNLElBQUksR0FBRyxNQUFNLGlCQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUM1QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsb0NBQW9DO29CQUM3QyxJQUFJLEVBQUUsZ0JBQWdCO2lCQUN2QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsa0RBQWtEO1lBQ2xELE1BQU0sY0FBYyxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXBELE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDaEMsUUFBUSxFQUFFLGNBQWM7Z0JBQ3hCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDLENBQUM7WUFFSCxxQkFBcUI7WUFDckIsTUFBTSxpQkFBTyxDQUFDLDRCQUE0QixDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUxRCwwQkFBMEI7WUFDMUIsTUFBTSxpQkFBTyxDQUFDLGlDQUFpQyxFQUFFLENBQUM7WUFFbEQsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsc0NBQXNDO2dCQUMvQyxPQUFPLEVBQUUsSUFBSTthQUNkLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSx1QkFBdUI7Z0JBQ2hDLElBQUksRUFBRSxzQkFBc0I7YUFDN0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVEOzs7R0FHRztBQUVIOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQ25DLElBQXVCLEVBQ3ZCLFFBQWEsRUFDYixjQUFzQjtJQUV0QixJQUFJLENBQUM7UUFDSCxnQ0FBZ0M7UUFDaEMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQzFCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELHdEQUF3RDtRQUN4RCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDNUIsc0RBQXNEO1lBQ3RELElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDMUQsQ0FBQztZQUNELElBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN6QixNQUFNLFNBQVMsR0FBRyxNQUFNLGlCQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDakUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7Z0JBQzFELENBQUM7WUFDSCxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUMsQ0FBQywyQ0FBMkM7UUFDMUQsQ0FBQztRQUVELDJEQUEyRDtRQUMzRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFLENBQUM7WUFDN0IsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3pCLE9BQU8sY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEtBQUssUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssQ0FBQztZQUN0RixDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3hCLHVEQUF1RDtnQkFDdkQsTUFBTSxlQUFlLEdBQUcsY0FBYyxFQUFFLEdBQUcsQ0FBQyxLQUFLLEVBQUMsRUFBRSxFQUFDLEVBQUU7b0JBQ3JELE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUM3RCxPQUFPLFNBQVMsRUFBRSxVQUFVLENBQUM7Z0JBQy9CLENBQUMsQ0FBQyxDQUFDO2dCQUNILE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQzdELE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELCtEQUErRDtRQUMvRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUNqQyxPQUFPLEtBQUssQ0FBQztZQUNmLENBQUM7WUFFRCxJQUFJLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDekIsT0FBTyxjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFdBQVcsS0FBSyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDO1lBQ3RGLENBQUM7WUFDRCxJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDeEIsTUFBTSxlQUFlLEdBQUcsY0FBYyxFQUFFLEdBQUcsQ0FBQyxLQUFLLEVBQUMsRUFBRSxFQUFDLEVBQUU7b0JBQ3JELE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUM3RCxPQUFPLFNBQVMsRUFBRSxVQUFVLENBQUM7Z0JBQy9CLENBQUMsQ0FBQyxDQUFDO2dCQUNILE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQzdELE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9ELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsZUFBZSxDQUNuQyxJQUF1QixFQUN2QixRQUFhLEVBQ2IsY0FBc0I7SUFFdEIsSUFBSSxDQUFDO1FBQ0gsZ0NBQWdDO1FBQ2hDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztZQUMxQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCx3REFBd0Q7UUFDeEQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzVCLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDMUQsQ0FBQztZQUNELElBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN6QixNQUFNLFNBQVMsR0FBRyxNQUFNLGlCQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDakUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7Z0JBQzFELENBQUM7WUFDSCxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsa0VBQWtFO1FBQ2xFLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUM3Qix5QkFBeUI7WUFDekIsSUFBSSxRQUFRLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDcEMsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBRUQsK0JBQStCO1lBQy9CLElBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN6QixPQUFPLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsV0FBVyxLQUFLLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLENBQUM7WUFDdEYsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELG1EQUFtRDtRQUNuRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7QUFDSCxDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLGlCQUFpQixDQUNyQyxJQUF1QixFQUN2QixRQUFhLEVBQ2IsY0FBc0I7SUFFdEIsSUFBSSxDQUFDO1FBQ0gsa0NBQWtDO1FBQ2xDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztZQUMxQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxzREFBc0Q7UUFDdEQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzVCLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDMUQsQ0FBQztZQUNELElBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN6QixNQUFNLFNBQVMsR0FBRyxNQUFNLGlCQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFPLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDakUsT0FBTyxRQUFRLEVBQUUsY0FBYyxLQUFLLElBQUksQ0FBQyxjQUFjLENBQUM7Z0JBQzFELENBQUM7WUFDSCxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUM3QixPQUFPLFFBQVEsQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN6QyxDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUM7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxpQkFBaUIsQ0FDckMsSUFBdUIsRUFDdkIsT0FBK0U7SUFFL0UsSUFBSSxDQUFDO1FBQ0gsdUNBQXVDO1FBQ3ZDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztZQUMxQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxzREFBc0Q7UUFDdEQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzVCLElBQUksT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUMzQixPQUFPLE9BQU8sQ0FBQyxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUN4RCxDQUFDO1lBQ0QsSUFBSSxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUMvRCxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUMxRCxDQUFDO1lBQ0QsSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNsRSxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNqRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztnQkFDMUQsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxvREFBb0Q7UUFDcEQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQzdCLElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN4Qix3Q0FBd0M7Z0JBQ3hDLE1BQU0sY0FBYyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2hFLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEtBQUssT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzNFLENBQUM7WUFDRCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxrQ0FBa0M7UUFDbEMsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsMENBQTBDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakUsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hdXRoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgY29ubmVjdFBnIGZyb20gJ2Nvbm5lY3QtcGctc2ltcGxlJztcbmltcG9ydCB7IGNyZWF0ZUhhc2gsIHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XG5pbXBvcnQgeyBzdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlJztcbmltcG9ydCB7IHNxbCwgZGIsIHBvb2wgfSBmcm9tICcuL2RiJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJy4vY29uZmlnL2luZGV4JztcbmltcG9ydCB0eXBlIHsgVXNlciB9IGZyb20gJ0BzaGFyZWQvc2NoZW1hJztcbi8vIERhdGFiYXNlLWJhc2VkIHBlcm1pc3Npb24gY2hlY2tpbmcgLSBubyBjb25maWcgZmlsZXMgbmVlZGVkXG5pbXBvcnQgeyBQb29sIH0gZnJvbSAnQG5lb25kYXRhYmFzZS9zZXJ2ZXJsZXNzJztcbmltcG9ydCB7IGRyaXp6bGUgfSBmcm9tICdkcml6emxlLW9ybS9uZW9uLXNlcnZlcmxlc3MnO1xuaW1wb3J0ICogYXMgc2NoZW1hIGZyb20gJy4uL3NoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgZXEsIGFuZCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvZW1haWwtc2VydmljZSc7XG5pbXBvcnQgeyBxdWVyeUNhY2hlIH0gZnJvbSAnLi9xdWVyeS1jYWNoZSc7XG5cbi8qKlxuICogQ2hlY2sgaWYgYSB1c2VyIHJvbGUgaGFzIGEgc3BlY2lmaWMgcGVybWlzc2lvbiB2aWEgZGF0YWJhc2UgbG9va3VwLlxuICogQHBhcmFtIHVzZXJSb2xlIC0gVGhlIHVzZXIncyByb2xlIChhZG1pbiwgbWFuYWdlciwgdGVuYW50LCByZXNpZGVudCkuXG4gKiBAcGFyYW0gcGVybWlzc2lvbk5hbWUgLSBUaGUgcGVybWlzc2lvbiBuYW1lIChlLmcuLCAncmVhZDp1c2VyJywgJ2NyZWF0ZTpidWlsZGluZycpLlxuICogQHJldHVybnMgUHJvbWlzZTxib29sZWFuPiAtIFRydWUgaWYgdXNlciBoYXMgcGVybWlzc2lvbi5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gY2hlY2tVc2VyUGVybWlzc2lvbih1c2VyUm9sZTogc3RyaW5nLCBwZXJtaXNzaW9uTmFtZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgLy8gRGVidWcgbG9nZ2luZyByZW1vdmVkIGZvciBwcm9kdWN0aW9uIHNlY3VyaXR5XG5cbiAgICAvLyBGaXJzdCBjaGVjayBpZiBwZXJtaXNzaW9uIGV4aXN0cyBhdCBhbGxcbiAgICBjb25zdCBwZXJtaXNzaW9uRXhpc3RzID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oc2NoZW1hLnBlcm1pc3Npb25zKVxuICAgICAgLndoZXJlKGVxKHNjaGVtYS5wZXJtaXNzaW9ucy5uYW1lLCBwZXJtaXNzaW9uTmFtZSkpXG4gICAgICAubGltaXQoMSk7XG5cbiAgICAvLyBQZXJtaXNzaW9uIGV4aXN0cyBjaGVjayBjb21wbGV0ZVxuXG4gICAgLy8gQ2hlY2sgcm9sZSBwZXJtaXNzaW9uc1xuICAgIGNvbnN0IHJvbGVQZXJtaXNzaW9ucyA9IGF3YWl0IGRiXG4gICAgICAuc2VsZWN0KClcbiAgICAgIC5mcm9tKHNjaGVtYS5yb2xlUGVybWlzc2lvbnMpXG4gICAgICAud2hlcmUoZXEoc2NoZW1hLnJvbGVQZXJtaXNzaW9ucy5yb2xlLCB1c2VyUm9sZSBhcyBhbnkpKTtcblxuICAgIC8vIFJvbGUgcGVybWlzc2lvbnMgY2hlY2tlZFxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oc2NoZW1hLnJvbGVQZXJtaXNzaW9ucylcbiAgICAgIC5sZWZ0Sm9pbihzY2hlbWEucGVybWlzc2lvbnMsIGVxKHNjaGVtYS5yb2xlUGVybWlzc2lvbnMucGVybWlzc2lvbklkLCBzY2hlbWEucGVybWlzc2lvbnMuaWQpKVxuICAgICAgLndoZXJlKFxuICAgICAgICBhbmQoXG4gICAgICAgICAgZXEoc2NoZW1hLnJvbGVQZXJtaXNzaW9ucy5yb2xlLCB1c2VyUm9sZSBhcyBhbnkpLFxuICAgICAgICAgIGVxKHNjaGVtYS5wZXJtaXNzaW9ucy5uYW1lLCBwZXJtaXNzaW9uTmFtZSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLmxpbWl0KDEpO1xuXG4gICAgLy8gUGVybWlzc2lvbiBjaGVjayBjb21wbGV0ZWRcblxuICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBQZXJtaXNzaW9uIG5vdCBmb3VuZFxuICAgICAgLy8gRGVidWc6IGxpc3QgYWxsIGFkbWluIHBlcm1pc3Npb25zXG4gICAgICBpZiAodXNlclJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgICAgY29uc3QgYWRtaW5QZXJtcyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7IG5hbWU6IHNjaGVtYS5wZXJtaXNzaW9ucy5uYW1lIH0pXG4gICAgICAgICAgLmZyb20oc2NoZW1hLnJvbGVQZXJtaXNzaW9ucylcbiAgICAgICAgICAubGVmdEpvaW4oXG4gICAgICAgICAgICBzY2hlbWEucGVybWlzc2lvbnMsXG4gICAgICAgICAgICBlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnBlcm1pc3Npb25JZCwgc2NoZW1hLnBlcm1pc3Npb25zLmlkKVxuICAgICAgICAgIClcbiAgICAgICAgICAud2hlcmUoZXEoc2NoZW1hLnJvbGVQZXJtaXNzaW9ucy5yb2xlLCAnYWRtaW4nKSk7XG4gICAgICAgIC8vIEFkbWluIHBlcm1pc3Npb25zIGRlYnVnIHJlbW92ZWQgZm9yIHNlY3VyaXR5XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPiAwO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcign4p2MIFBlcm1pc3Npb24gY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLy8gSW5pdGlhbGl6ZSBlbWFpbCBzZXJ2aWNlXG5jb25zdCBlbWFpbFNlcnZpY2UgPSBuZXcgRW1haWxTZXJ2aWNlKCk7XG5cbi8vIERhdGFiYXNlIGNvbm5lY3Rpb24gYWxyZWFkeSBpbXBvcnRlZCBhdCB0b3Agb2YgZmlsZVxuXG4vLyBDb25maWd1cmUgc2Vzc2lvbiBzdG9yZSB3aXRoIFBvc3RncmVTUUxcbmNvbnN0IFBvc3RncmVTcWxTdG9yZSA9IGNvbm5lY3RQZyhzZXNzaW9uKTtcblxuLyoqXG4gKiBHZXQgdGhlIGNvcnJlY3QgZGF0YWJhc2UgVVJMIGJhc2VkIG9uIGVudmlyb25tZW50IGFuZCByZXF1ZXN0IGRvbWFpbi5cbiAqIFVzZXMgY2VudHJhbGl6ZWQgY29uZmlndXJhdGlvbiB0byBkZXRlcm1pbmUgdGhlIGFwcHJvcHJpYXRlIGRhdGFiYXNlLlxuICovXG5mdW5jdGlvbiBnZXREYXRhYmFzZVVybChyZXF1ZXN0RG9tYWluPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgLy8gVXNlIHRoZSBjZW50cmFsaXplZCBkYXRhYmFzZSBjb25maWd1cmF0aW9uXG4gIGNvbnN0IHNlbGVjdGVkVXJsID0gY29uZmlnLmRhdGFiYXNlLmdldFJ1bnRpbWVEYXRhYmFzZVVybChyZXF1ZXN0RG9tYWluKTtcbiAgY29uc3QgaXNLb3Zlb1JlcXVlc3QgPSByZXF1ZXN0RG9tYWluPy5pbmNsdWRlcygna292ZW8tZ2VzdGlvbi5jb20nKTtcbiAgY29uc3QgaXNQcm9kdWN0aW9uID0gY29uZmlnLnNlcnZlci5pc1Byb2R1Y3Rpb24gfHwgaXNLb3Zlb1JlcXVlc3Q7XG4gIFxuICBjb25zb2xlLmxvZyhg8J+UlyBTZXNzaW9uIHN0b3JlIHVzaW5nICR7aXNQcm9kdWN0aW9uID8gJ1BST0RVQ1RJT04nIDogJ0RFVkVMT1BNRU5UJ30gZGF0YWJhc2U6ICR7c2VsZWN0ZWRVcmw/LnN1YnN0cmluZygwLCA1MCl9Li4uIChkb21haW46ICR7cmVxdWVzdERvbWFpbiB8fCAndW5rbm93bid9KWApO1xuICBcbiAgaWYgKCFzZWxlY3RlZFVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YWJhc2UgVVJMIGF2YWlsYWJsZSBmb3Igc2Vzc2lvbiBzdG9yZScpO1xuICB9XG4gIFxuICByZXR1cm4gc2VsZWN0ZWRVcmw7XG59XG5cbi8qKlxuICogU2Vzc2lvbiBjb25maWd1cmF0aW9uIGZvciBRdWViZWMtY29tcGxpYW50IHVzZXIgYXV0aGVudGljYXRpb24uXG4gKiBVc2VzIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3Igc2NhbGFiaWxpdHkgYW5kIExhdyAyNSBjb21wbGlhbmNlLlxuICogSW5jbHVkZXMgZmFsbGJhY2sgZm9yIGRhdGFiYXNlIGNvbm5lY3Rpb24gaXNzdWVzIGluIHByb2R1Y3Rpb24uXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVNlc3Npb25TdG9yZShyZXF1ZXN0RG9tYWluPzogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgLy8gQ3JlYXRlIGEgcHJvcGVyIFBvc3RncmVTUUwgcG9vbCBmb3IgdGhlIHNlc3Npb24gc3RvcmVcbiAgICAvLyBjb25uZWN0LXBnLXNpbXBsZSBuZWVkcyBhIHJlYWwgUG9zdGdyZVNRTCBwb29sLCBub3QgdGhlIE5lb24gSFRUUCBjbGllbnRcbiAgICBjb25zdCBzZXNzaW9uUG9vbCA9IG5ldyBQb29sKHsgXG4gICAgICBjb25uZWN0aW9uU3RyaW5nOiBnZXREYXRhYmFzZVVybChyZXF1ZXN0RG9tYWluKSxcbiAgICAgIG1heDogMiwgLy8gU21hbGwgcG9vbCBmb3Igc2Vzc2lvbnNcbiAgICAgIG1pbjogMSxcbiAgICAgIG1heFVzZXM6IDc1MDAsIC8vIE1heGltdW0gbnVtYmVyIG9mIHRpbWVzIGEgY29ubmVjdGlvbiBjYW4gYmUgcmV1c2VkXG4gICAgICBpZGxlVGltZW91dE1pbGxpczogMzAwMDAsIC8vIDMwIHNlY29uZHMgaWRsZSB0aW1lb3V0XG4gICAgICBhbGxvd0V4aXRPbklkbGU6IHRydWUsIC8vIEFsbG93IHBvb2wgdG8gY2xvc2Ugd2hlbiBpZGxlXG4gICAgfSk7XG4gICAgXG4gICAgLy8gVXNlIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3IgcGVyc2lzdGVudCBzZXNzaW9uc1xuICAgIGNvbnN0IHN0b3JlID0gbmV3IFBvc3RncmVTcWxTdG9yZSh7XG4gICAgICBwb29sOiBzZXNzaW9uUG9vbCxcbiAgICAgIHRhYmxlTmFtZTogJ3Nlc3Npb24nLFxuICAgICAgY3JlYXRlVGFibGVJZk1pc3Npbmc6IHRydWUsIC8vIEF1dG8tY3JlYXRlIHRhYmxlIGluIHByb2R1Y3Rpb24gaWYgbWlzc2luZ1xuICAgICAgZXJyb3JMb2c6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgPyAoKSA9PiB7fSA6IGNvbnNvbGUuZXJyb3IsIC8vIFN1cHByZXNzIGVycm9yIGxvZ2dpbmcgaW4gdGVzdHNcbiAgICAgIFxuICAgICAgLy8gQWRkIGV4cGxpY2l0IGNvbmZpZ3VyYXRpb24gZm9yIHNlc3Npb24gcmV0cmlldmFsXG4gICAgICBwcnVuZVNlc3Npb25JbnRlcnZhbDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyA/IGZhbHNlIDogNjAgKiAxMDAwLCAvLyBEaXNhYmxlIHBydW5pbmcgaW4gdGVzdHNcbiAgICAgIHNjaGVtYU5hbWU6ICdwdWJsaWMnLCAvLyBFeHBsaWNpdGx5IHNldCBzY2hlbWFcbiAgICB9KTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygn4pyFIFNlc3Npb24gc3RvcmU6IFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBjcmVhdGVkIHdpdGggcHJvcGVyIHBvb2wnKTtcbiAgICBcbiAgICAvLyBUZXN0IHRoZSBzdG9yZSBjb25uZWN0aW9uIChza2lwIGluIHRlc3QgZW52aXJvbm1lbnQpXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcpIHtcbiAgICAgIHN0b3JlLmdldCgndGVzdC1zZXNzaW9uLWlkJywgKGVyciwgc2Vzc2lvbikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc3RvcmUgY29ubmVjdGlvbiB0ZXN0IGZhaWxlZDonLCBlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCfinIUgU2Vzc2lvbiBzdG9yZSBjb25uZWN0aW9uIHRlc3QgcGFzc2VkJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gc3RvcmU7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgU2Vzc2lvbiBzdG9yZSBjcmVhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIGNvbnNvbGUubG9nKCfimqDvuI8gRmFsbGluZyBiYWNrIHRvIG1lbW9yeSBzdG9yZSAoc2Vzc2lvbnMgd2lsbCBub3QgcGVyc2lzdCknKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkOyAvLyBXaWxsIHVzZSBkZWZhdWx0IG1lbW9yeSBzdG9yZSBhcyBmYWxsYmFja1xuICB9XG59XG5cbi8vIENyZWF0ZSBzZXNzaW9uIHN0b3JlIHdpdGggYmV0dGVyIGRhdGFiYXNlIGRldGVjdGlvbiAgXG5sZXQgc2Vzc2lvblN0b3JlOiBhbnk7XG50cnkge1xuICAvLyBUcnkgdG8gY3JlYXRlIHNlc3Npb24gc3RvcmUgd2l0aCBhdXRvbWF0aWMgZGF0YWJhc2UgZGV0ZWN0aW9uXG4gIHNlc3Npb25TdG9yZSA9IGNyZWF0ZVNlc3Npb25TdG9yZSgpO1xufSBjYXRjaCAoZXJyb3IpIHtcbiAgY29uc29sZS5lcnJvcign4p2MIEZhaWxlZCB0byBjcmVhdGUgaW5pdGlhbCBzZXNzaW9uIHN0b3JlOicsIGVycm9yKTtcbiAgc2Vzc2lvblN0b3JlID0gdW5kZWZpbmVkOyAvLyBXaWxsIGZhbGwgYmFjayB0byBtZW1vcnkgc3RvcmVcbn1cblxuZXhwb3J0IGNvbnN0IHNlc3Npb25Db25maWcgPSBzZXNzaW9uKHtcbiAgc3RvcmU6IHNlc3Npb25TdG9yZSwgLy8gVXNlIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3IgcGVyc2lzdGVuY2VcbiAgc2VjcmV0OiBwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCB8fCAnZmFsbGJhY2stc2VjcmV0LWNoYW5nZS1pbi1wcm9kdWN0aW9uJyxcbiAgcmVzYXZlOiBmYWxzZSwgLy8gRG9uJ3Qgc2F2ZSB1bmNoYW5nZWQgc2Vzc2lvbnNcbiAgc2F2ZVVuaW5pdGlhbGl6ZWQ6IGZhbHNlLFxuICByb2xsaW5nOiB0cnVlLCAvLyBSZXNldCBleHBpcnkgb24gZWFjaCByZXF1ZXN0XG4gIGNvb2tpZToge1xuICAgIHNlY3VyZTogZmFsc2UsIC8vIEtlZXAgZmFsc2UgZm9yIGRldmVsb3BtZW50IHRvIGVuc3VyZSBjb29raWVzIHdvcmtcbiAgICBodHRwT25seTogdHJ1ZSxcbiAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLCAvLyA3IGRheXMgLSBsb25nZXIgc2Vzc2lvbiBkdXJhdGlvblxuICAgIHNhbWVTaXRlOiAnbGF4JyxcbiAgICBwYXRoOiAnLycsIC8vIEV4cGxpY2l0bHkgc2V0IHBhdGhcbiAgfSxcbiAgbmFtZTogJ2tvdmVvLnNpZCcsXG4gIHByb3h5OiBmYWxzZSxcbn0pO1xuXG4vKipcbiAqIEVuaGFuY2VkIHBhc3N3b3JkIGhhc2hpbmcgdXNpbmcgYmNyeXB0IHdpdGggc2FsdCBmb3IgUXVlYmVjIExhdyAyNSBjb21wbGlhbmNlLlxuICogUHJvdmlkZXMgc3Ryb25nIHNlY3VyaXR5IHVzaW5nIGluZHVzdHJ5LXN0YW5kYXJkIGJjcnlwdCBhbGdvcml0aG1cbiAqIHdpdGggY29uZmlndXJhYmxlIHNhbHQgcm91bmRzIChkZWZhdWx0OiAxMikuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhc3N3b3JkIC0gUGxhaW4gdGV4dCBwYXNzd29yZCB0byBoYXNoLlxuICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gUHJvbWlzZSByZXNvbHZpbmcgdG8gYmNyeXB0IGhhc2hlZCBwYXNzd29yZC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBoYXNoUGFzc3dvcmQoJ3VzZXJQYXNzd29yZDEyMycpO1xuICogLy8gU3RvcmUgaGFzaGVkIHBhc3N3b3JkIHNlY3VyZWx5IGluIGRhdGFiYXNlXG4gKiBhd2FpdCBzdG9yYWdlLmNyZWF0ZVVzZXIoeyAuLi51c2VyRGF0YSwgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkIH0pO1xuICogYGBgXG4gKi9cbi8qKlxuICogSGFzaFBhc3N3b3JkIGZ1bmN0aW9uLlxuICogQHBhcmFtIHBhc3N3b3JkXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYXNoUGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHNhbHRSb3VuZHMgPSAxMjsgLy8gUmVjb21tZW5kZWQgZm9yIHByb2R1Y3Rpb25cbiAgcmV0dXJuIGF3YWl0IGJjcnlwdC5oYXNoKHBhc3N3b3JkLCBzYWx0Um91bmRzKTtcbn1cblxuLyoqXG4gKiBWZXJpZmllcyBhIHBhc3N3b3JkIGFnYWluc3Qgc3RvcmVkIGJjcnlwdCBoYXNoIHVzaW5nIGNvbnN0YW50LXRpbWUgY29tcGFyaXNvbi5cbiAqIFVzZXMgYmNyeXB0LmNvbXBhcmUgZm9yIHNlY3VyZSBwYXNzd29yZCB2ZXJpZmljYXRpb24uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhc3N3b3JkIC0gUGxhaW4gdGV4dCBwYXNzd29yZCB0byB2ZXJpZnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gaGFzaGVkUGFzc3dvcmQgLSBTdG9yZWQgYmNyeXB0IGhhc2ggZnJvbSB1c2VyIHJlY29yZC5cbiAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBQcm9taXNlIHJlc29sdmluZyB0byB0cnVlIGlmIHBhc3N3b3JkIG1hdGNoZXMsIGZhbHNlIG90aGVyd2lzZS5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICogY29uc3QgaXNWYWxpZCA9IGF3YWl0IHZlcmlmeVBhc3N3b3JkKGlucHV0UGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xuICogaWYgKGlzVmFsaWQpIHtcbiAqICAgLy8gR3JhbnQgYWNjZXNzXG4gKiB9XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBWZXJpZnlQYXNzd29yZCBmdW5jdGlvbi5cbiAqIEBwYXJhbSBwYXNzd29yZFxuICogQHBhcmFtIGhhc2hlZFBhc3N3b3JkXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlQYXNzd29yZChwYXNzd29yZDogc3RyaW5nLCBoYXNoZWRQYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHJldHVybiBhd2FpdCBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgaGFzaGVkUGFzc3dvcmQpO1xufVxuXG4vKipcbiAqIEF1dGhlbnRpY2F0aW9uIG1pZGRsZXdhcmUgdG8gcHJvdGVjdCByb3V0ZXMgcmVxdWlyaW5nIHVzZXIgbG9naW4uXG4gKiBWYWxpZGF0ZXMgc2Vzc2lvbiBleGlzdGVuY2UsIHJldHJpZXZlcyB1c2VyIGRhdGEsIGFuZCBlbnN1cmVzIGFjY291bnQgaXMgYWN0aXZlLlxuICogQXV0b21hdGljYWxseSBkZXN0cm95cyBpbnZhbGlkIHNlc3Npb25zIGZvciBzZWN1cml0eS5cbiAqXG4gKiBAcGFyYW0ge1JlcXVlc3R9IHJlcSAtIEV4cHJlc3MgcmVxdWVzdCBvYmplY3Qgd2l0aCBzZXNzaW9uIGRhdGEuXG4gKiBAcGFyYW0ge1Jlc3BvbnNlfSByZXMgLSBFeHByZXNzIHJlc3BvbnNlIG9iamVjdCBmb3Igc2VuZGluZyBlcnJvciByZXNwb25zZXMuXG4gKiBAcGFyYW0ge05leHRGdW5jdGlvbn0gbmV4dCAtIEV4cHJlc3MgbmV4dCBmdW5jdGlvbiB0byBjb250aW51ZSB0byBwcm90ZWN0ZWQgcm91dGUuXG4gKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gUHJvbWlzZSB0aGF0IHJlc29sdmVzIHdoZW4gYXV0aGVudGljYXRpb24gaXMgdmVyaWZpZWQuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIGFwcC5nZXQoJy9hcGkvcHJvdGVjdGVkLXJvdXRlJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICogICAvLyByZXEudXNlciBpcyBub3cgYXZhaWxhYmxlIGFuZCB2ZXJpZmllZFxuICogICByZXMuanNvbih7IHVzZXJJZDogcmVxLnVzZXIuaWQgfSk7XG4gKiB9KTtcbiAqIGBgYFxuICovXG4vKipcbiAqIFJlcXVpcmVBdXRoIGZ1bmN0aW9uLlxuICogQHBhcmFtIHJlcVxuICogQHBhcmFtIHJlc1xuICogQHBhcmFtIG5leHRcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVBdXRoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gIGlmICghcmVxLnNlc3Npb24/LnVzZXJJZCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBPcHRpbWl6ZWQgc2Vzc2lvbiB0b3VjaCAtIG9ubHkgdG91Y2ggd2hlbiBzZXNzaW9uIGlzIGNsb3NlIHRvIGV4cGlyaW5nXG4gICAgaWYgKHJlcS5zZXNzaW9uICYmIHJlcS5zZXNzaW9uLnRvdWNoICYmIHJlcS5zZXNzaW9uLmNvb2tpZSkge1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IHNlc3Npb25BZ2UgPSBub3cgLSAocmVxLnNlc3Npb24uY29va2llLm9yaWdpbmFsTWF4QWdlIHx8IDApICsgKHJlcS5zZXNzaW9uLmNvb2tpZS5tYXhBZ2UgfHwgMCk7XG4gICAgICBjb25zdCBzZXNzaW9uTGlmZXRpbWUgPSByZXEuc2Vzc2lvbi5jb29raWUub3JpZ2luYWxNYXhBZ2UgfHwgKDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgIFxuICAgICAgLy8gT25seSB0b3VjaCBzZXNzaW9uIGlmIG1vcmUgdGhhbiAyNSUgb2YgaXRzIGxpZmV0aW1lIGhhcyBwYXNzZWRcbiAgICAgIGlmIChzZXNzaW9uQWdlID4gc2Vzc2lvbkxpZmV0aW1lICogMC4yNSkge1xuICAgICAgICByZXEuc2Vzc2lvbi50b3VjaCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIExvYWRpbmcgdXNlciBzZXNzaW9uXG5cbiAgICAvLyBDbGVhciBhbnkgY2FjaGVkIHVzZXIgZGF0YSBmb3IgdGhpcyBJRCB0byBlbnN1cmUgZnJlc2ggbG9hZFxuICAgIHF1ZXJ5Q2FjaGUuaW52YWxpZGF0ZSgndXNlcnMnLCBgdXNlcjoke3JlcS5zZXNzaW9uLnVzZXJJZH1gKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ3VzZXJzJywgYHVzZXJfZW1haWw6KmApO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXEuc2Vzc2lvbi51c2VySWQpO1xuICAgIC8vIFVzZXIgbG9hZGVkIGZyb20gc2Vzc2lvblxuICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAvLyBTZXNzaW9uIGRlc3RydWN0aW9uIGVycm9yIGhhbmRsZWRcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnVXNlciBhY2NvdW50IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScsXG4gICAgICAgIGNvZGU6ICdVU0VSX0lOQUNUSVZFJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFNldCBzZXNzaW9uIHJvbGUgKHBlcm1pc3Npb25zIGhhbmRsZWQgdmlhIGRhdGFiYXNlKVxuICAgIHJlcS5zZXNzaW9uLnJvbGUgPSB1c2VyLnJvbGU7XG5cbiAgICAvLyBBZGQgb3JnYW5pemF0aW9uIGluZm9ybWF0aW9uIHRvIHRoZSB1c2VyIG9iamVjdCAtIHdpdGggZXJyb3IgaGFuZGxpbmcgZm9yIHJlc2lsaWVuY2VcbiAgICBsZXQgdXNlck9yZ2FuaXphdGlvbnM6IGFueVtdID0gW107XG4gICAgdHJ5IHtcbiAgICAgIHVzZXJPcmdhbml6YXRpb25zID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCxcbiAgICAgICAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zOiBzY2hlbWEudXNlck9yZ2FuaXphdGlvbnMuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20oc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEoc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zLnVzZXJJZCwgdXNlci5pZCksXG4gICAgICAgICAgICBlcShzY2hlbWEudXNlck9yZ2FuaXphdGlvbnMuaXNBY3RpdmUsIHRydWUpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH0gY2F0Y2ggKG9yZ0Vycm9yKSB7XG4gICAgICAvLyBPcmdhbml6YXRpb24gbG9va3VwIGVycm9yIGhhbmRsZWQgZ3JhY2VmdWxseVxuICAgICAgLy8gQ29udGludWUgd2l0aCBlbXB0eSBvcmdhbml6YXRpb25zIC0gdXNlciBjYW4gc3RpbGwgYXV0aGVudGljYXRlXG4gICAgICB1c2VyT3JnYW5pemF0aW9ucyA9IFtdO1xuICAgIH1cblxuICAgIC8vIEVuaGFuY2VkIHVzZXIgb2JqZWN0IHdpdGggb3JnYW5pemF0aW9uIGFjY2VzcyBpbmZvcm1hdGlvblxuICAgIHJlcS51c2VyID0ge1xuICAgICAgLi4udXNlcixcbiAgICAgIG9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLm1hcCgodW8pID0+IHVvLm9yZ2FuaXphdGlvbklkKSxcbiAgICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLnNvbWUoKHVvKSA9PiB1by5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zKSxcbiAgICB9IGFzIGFueTtcblxuICAgIC8vIFNwZWNpYWwgaGFuZGxpbmcgZm9yIGhhcmRjb2RlZCBkZW1vIHVzZXJzIC0gZW5zdXJlIHRoZXkgaGF2ZSBwcm9wZXIgb3JnYW5pemF0aW9uIGFjY2Vzc1xuICAgIC8vIENoZWNrIGlmIHRoZSB1c2VyIHJlY29yZCBoYXMgb3JnYW5pemF0aW9uIGFjY2VzcyBjb25maWd1cmVkXG4gICAgaWYgKFxuICAgICAgdXNlci5yb2xlPy5zdGFydHNXaXRoKCdkZW1vXycpICYmXG4gICAgICAoIXJlcS51c2VyLm9yZ2FuaXphdGlvbnMgfHwgcmVxLnVzZXIub3JnYW5pemF0aW9ucy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICAvLyBEZW1vIHVzZXJzIHNob3VsZCBnZXQgYWNjZXNzIHRvIGRlbW8gb3JnYW5pemF0aW9uc1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGVtb09yZ3MgPSBhd2FpdCBkYlxuICAgICAgICAgIC5zZWxlY3QoeyBpZDogc2NoZW1hLm9yZ2FuaXphdGlvbnMuaWQgfSlcbiAgICAgICAgICAuZnJvbShzY2hlbWEub3JnYW5pemF0aW9ucylcbiAgICAgICAgICAud2hlcmUoZXEoc2NoZW1hLm9yZ2FuaXphdGlvbnMudHlwZSwgJ2RlbW8nKSlcbiAgICAgICAgICAubGltaXQoMSk7XG4gICAgICAgIFxuICAgICAgICBpZiAoZGVtb09yZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgIC8vIEFkZGluZyBvcmdhbml6YXRpb24gYWNjZXNzIGZvciBkZW1vIHVzZXJcbiAgICAgICAgICByZXEudXNlci5vcmdhbml6YXRpb25zID0gW2RlbW9PcmdzWzBdLmlkXTtcbiAgICAgICAgICByZXEudXNlci5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGRlbW9PcmdFcnJvcikge1xuICAgICAgICAvLyBEZW1vIG9yZ2FuaXphdGlvbiBsb29rdXAgZmFpbGVkLCBjb250aW51ZSB3aXRob3V0IGFjY2Vzc1xuICAgICAgfVxuICAgIH1cblxuICAgIG5leHQoKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIC8vIEF1dGhlbnRpY2F0aW9uIGVycm9yIGhhbmRsZWRcbiAgICBjb25zb2xlLmVycm9yKCfinYwgQXV0aGVudGljYXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gZXJyb3InLFxuICAgICAgY29kZTogJ0FVVEhfRVJST1InLFxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogUm9sZS1iYXNlZCBhdXRob3JpemF0aW9uIG1pZGRsZXdhcmUgZmFjdG9yeSBmb3IgUXVlYmVjIHByb3BlcnR5IG1hbmFnZW1lbnQgcm9sZXMuXG4gKiBDcmVhdGVzIG1pZGRsZXdhcmUgdGhhdCByZXN0cmljdHMgYWNjZXNzIGJhc2VkIG9uIHVzZXIgcm9sZXMgc3VjaCBhcyBhZG1pbiwgbWFuYWdlciwgdGVuYW50LlxuICogTXVzdCBiZSB1c2VkIGFmdGVyIHJlcXVpcmVBdXRoIG1pZGRsZXdhcmUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmdbXX0gYWxsb3dlZFJvbGVzIC0gQXJyYXkgb2Ygcm9sZXMgdGhhdCBjYW4gYWNjZXNzIHRoZSByb3V0ZSAoZS5nLiwgWydhZG1pbicsICdtYW5hZ2VyJ10pLlxuICogQHJldHVybnMge0Z1bmN0aW9ufSBFeHByZXNzIG1pZGRsZXdhcmUgZnVuY3Rpb24gZm9yIHJvbGUgdmFsaWRhdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogLy8gT25seSBhZG1pbnMgY2FuIGFjY2VzcyB1c2VyIG1hbmFnZW1lbnRcbiAqIGFwcC5nZXQoJy9hcGkvYWRtaW4vdXNlcnMnLCByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUoWydhZG1pbiddKSwgZ2V0VXNlckxpc3QpO1xuICpcbiAqIC8vIE1hbmFnZXJzIGFuZCBhZG1pbnMgY2FuIGFjY2VzcyBidWlsZGluZyBkYXRhXG4gKiBhcHAuZ2V0KCcvYXBpL2J1aWxkaW5ncycsIHJlcXVpcmVBdXRoLCByZXF1aXJlUm9sZShbJ2FkbWluJywgJ21hbmFnZXInXSksIGdldEJ1aWxkaW5ncyk7XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBSZXF1aXJlUm9sZSBmdW5jdGlvbi5cbiAqIEBwYXJhbSBhbGxvd2VkUm9sZXNcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVSb2xlKGFsbG93ZWRSb2xlczogc3RyaW5nW10pIHtcbiAgcmV0dXJuIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghYWxsb3dlZFJvbGVzLmluY2x1ZGVzKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnSW5zdWZmaWNpZW50IHBlcm1pc3Npb25zJyxcbiAgICAgICAgY29kZTogJ0lOU1VGRklDSUVOVF9QRVJNSVNTSU9OUycsXG4gICAgICAgIHJlcXVpcmVkOiBhbGxvd2VkUm9sZXMsXG4gICAgICAgIGN1cnJlbnQ6IHJlcS51c2VyLnJvbGUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8qKlxuICogUGVybWlzc2lvbi1iYXNlZCBhdXRob3JpemF0aW9uIG1pZGRsZXdhcmUgZmFjdG9yeSB1c2luZyB0aGUgY29tcHJlaGVuc2l2ZSBSQkFDIHN5c3RlbS5cbiAqIFZhbGlkYXRlcyB1c2VyIHBlcm1pc3Npb25zIGJhc2VkIG9uIHRoZSBkYXRhYmFzZSBSQkFDIHN5c3RlbS5cbiAqIE11c3QgYmUgdXNlZCBhZnRlciByZXF1aXJlQXV0aCBtaWRkbGV3YXJlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZXJtaXNzaW9uIC0gU3BlY2lmaWMgcGVybWlzc2lvbiByZXF1aXJlZCB0byBhY2Nlc3MgdGhlIHJvdXRlIChlLmcuLCAncmVhZDpiaWxsJywgJ2NyZWF0ZTptYWludGVuYW5jZV9yZXF1ZXN0JykuXG4gKiBAcmV0dXJucyB7RnVuY3Rpb259IEV4cHJlc3MgbWlkZGxld2FyZSBmdW5jdGlvbiBmb3IgcGVybWlzc2lvbiB2YWxpZGF0aW9uLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiAvLyBPbmx5IHVzZXJzIHdpdGggJ3JlYWQ6YmlsbCcgcGVybWlzc2lvbiBjYW4gYWNjZXNzXG4gKiBhcHAuZ2V0KCcvYXBpL2JpbGxzJywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgncmVhZDpiaWxsJyksIGdldEJpbGxzKTtcbiAqXG4gKiAvLyBPbmx5IHVzZXJzIHdpdGggJ2RlbGV0ZTp1c2VyJyBwZXJtaXNzaW9uIGNhbiBkZWxldGUgdXNlcnNcbiAqIGFwcC5kZWxldGUoJy9hcGkvdXNlcnMvOmlkJywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgnZGVsZXRlOnVzZXInKSwgZGVsZXRlVXNlcik7XG4gKlxuICogLy8gTXVsdGlwbGUgcm91dGUgcHJvdGVjdGlvblxuICogcm91dGVyLnVzZShhdXRob3JpemUoJ21hbmFnZTpidWlsZGluZycpKTtcbiAqIHJvdXRlci5wb3N0KCcvYnVpbGRpbmdzJywgY3JlYXRlQnVpbGRpbmcpO1xuICogcm91dGVyLnBhdGNoKCcvYnVpbGRpbmdzLzppZCcsIHVwZGF0ZUJ1aWxkaW5nKTtcbiAqIGBgYFxuICovXG4vKipcbiAqIEF1dGhvcml6ZSBmdW5jdGlvbi5cbiAqIEBwYXJhbSBwZXJtaXNzaW9uXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdXRob3JpemUocGVybWlzc2lvbjogc3RyaW5nKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBpZiAoIXJlcS51c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgdGhlIHVzZXIncyByb2xlIGhhcyB0aGUgcmVxdWlyZWQgcGVybWlzc2lvbiB2aWEgZGF0YWJhc2VcbiAgICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBhd2FpdCBjaGVja1VzZXJQZXJtaXNzaW9uKHJlcS51c2VyLnJvbGUgYXMgYW55LCBwZXJtaXNzaW9uKTtcblxuICAgICAgaWYgKCFoYXNQZXJtaXNzaW9uKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycsXG4gICAgICAgICAgY29kZTogJ1BFUk1JU1NJT05fREVOSUVEJyxcbiAgICAgICAgICByZXF1aXJlZDogcGVybWlzc2lvbixcbiAgICAgICAgICB1c2VyUm9sZTogcmVxLnVzZXIucm9sZSxcbiAgICAgICAgICBkZXRhaWxzOiBgVXNlciB3aXRoIHJvbGUgJyR7cmVxLnVzZXIucm9sZX0nIGRvZXMgbm90IGhhdmUgcGVybWlzc2lvbiAnJHtwZXJtaXNzaW9ufSdgLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIC8vIEF1dGhvcml6YXRpb24gZXJyb3IgaGFuZGxlZFxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEF1dGhvcml6YXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhvcml6YXRpb24gY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ0FVVEhPUklaQVRJT05fRVJST1InLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFNldHMgdXAgYXV0aGVudGljYXRpb24gcm91dGVzIGZvciBRdWViZWMtY29tcGxpYW50IHVzZXIgbWFuYWdlbWVudC5cbiAqIEltcGxlbWVudHMgbG9naW4sIGxvZ291dCwgcmVnaXN0cmF0aW9uLCBhbmQgY3VycmVudCB1c2VyIGVuZHBvaW50c1xuICogd2l0aCBwcm9wZXIgc2Vzc2lvbiBtYW5hZ2VtZW50IGFuZCBMYXcgMjUgY29tcGxpYW5jZSBjb25zaWRlcmF0aW9ucy5cbiAqXG4gKiBAcGFyYW0ge2FueX0gYXBwIC0gRXhwcmVzcyBhcHBsaWNhdGlvbiBpbnN0YW5jZSB0byByZWdpc3RlciByb3V0ZXMgb24uXG4gKiBAcmV0dXJucyB7dm9pZH0gTm8gcmV0dXJuIHZhbHVlIC0gcm91dGVzIGFyZSByZWdpc3RlcmVkIGRpcmVjdGx5IG9uIGFwcC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgYXBwID0gZXhwcmVzcygpO1xuICogYXBwLnVzZShzZXNzaW9uQ29uZmlnKTtcbiAqIHNldHVwQXV0aFJvdXRlcyhhcHApO1xuICogLy8gQXV0aGVudGljYXRpb24gcm91dGVzIGFyZSBub3cgYXZhaWxhYmxlOlxuICogLy8gUE9TVCAvYXBpL2F1dGgvbG9naW5cbiAqIC8vIFBPU1QgL2FwaS9hdXRoL2xvZ291dFxuICogLy8gR0VUIC9hcGkvYXV0aC91c2VyXG4gKiAvLyBQT1NUIC9hcGkvYXV0aC9yZWdpc3RlclxuICogYGBgXG4gKi9cbi8qKlxuICogU2V0dXBBdXRoUm91dGVzIGZ1bmN0aW9uLlxuICogQHBhcmFtIGFwcFxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBBdXRoUm91dGVzKGFwcDogYW55KSB7XG4gIC8vIExvZ2luIHJvdXRlXG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcbiAgICAgIC8vIExvZ2luIGF0dGVtcHQgaW5pdGlhdGVkXG5cbiAgICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0VtYWlsIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdNSVNTSU5HX0NSRURFTlRJQUxTJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHJpZXZpbmcgdXNlciBieSBlbWFpbFxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwudG9Mb3dlckNhc2UoKSk7XG5cbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyxcbiAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9DUkVERU5USUFMUycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQWNjb3VudCBpcyBpbmFjdGl2ZScsXG4gICAgICAgICAgY29kZTogJ0FDQ09VTlRfSU5BQ1RJVkUnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVXNlIGJjcnlwdCBmb3IgcGFzc3dvcmQgdmVyaWZpY2F0aW9uXG4gICAgICAvLyBWZXJpZnlpbmcgcGFzc3dvcmQgZm9yIHVzZXJcbiAgICAgIC8vIFBhc3N3b3JkIHZlcmlmaWNhdGlvbiBpbml0aWF0ZWRcbiAgICAgIGNvbnN0IGlzVmFsaWRQYXNzd29yZCA9IGF3YWl0IHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcbiAgICAgIC8vIFBhc3N3b3JkIHZlcmlmaWNhdGlvbiBjb21wbGV0ZWRcblxuICAgICAgaWYgKCFpc1ZhbGlkUGFzc3dvcmQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBjcmVkZW50aWFscycsXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfQ1JFREVOVElBTFMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVXBkYXRlIGxhc3QgbG9naW5cbiAgICAgIGF3YWl0IHN0b3JhZ2UudXBkYXRlVXNlcih1c2VyLmlkLCB7IGxhc3RMb2dpbkF0OiBuZXcgRGF0ZSgpIH0pO1xuXG4gICAgICAvLyBTZXQgc2Vzc2lvbiB3aXRoIHVzZXIgZGF0YVxuICAgICAgcmVxLnNlc3Npb24udXNlcklkID0gdXNlci5pZDtcbiAgICAgIHJlcS5zZXNzaW9uLnVzZXJSb2xlID0gdXNlci5yb2xlO1xuICAgICAgcmVxLnNlc3Npb24ucm9sZSA9IHVzZXIucm9sZTtcbiAgICAgIHJlcS5zZXNzaW9uLnVzZXIgPSB1c2VyOyAvLyBBZGQgY29tcGxldGUgdXNlciBvYmplY3QgZm9yIG1pZGRsZXdhcmUgY29tcGF0aWJpbGl0eVxuXG4gICAgICAvLyBTYXZlIHNlc3Npb24gZXhwbGljaXRseSB0byBlbnN1cmUgaXQncyBwZXJzaXN0ZWRcbiAgICAgIHJlcS5zZXNzaW9uLnNhdmUoKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc2F2ZSBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU2Vzc2lvbiBzYXZlIGZhaWxlZCcsXG4gICAgICAgICAgICBjb2RlOiAnU0VTU0lPTl9TQVZFX0VSUk9SJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIFxuICAgICAgICAvLyBSZXR1cm4gdXNlciBkYXRhICh3aXRob3V0IHBhc3N3b3JkKVxuICAgICAgICBjb25zdCB7IHBhc3N3b3JkOiBfLCAuLi51c2VyRGF0YSB9ID0gdXNlcjtcbiAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgIHVzZXI6IHVzZXJEYXRhLFxuICAgICAgICAgIG1lc3NhZ2U6ICdMb2dpbiBzdWNjZXNzZnVsJyxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChfZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcignTG9naW4gZXJyb3I6Jywge1xuICAgICAgICBlcnJvcjogX2Vycm9yLFxuICAgICAgICBlbWFpbDogcmVxLmJvZHk/LmVtYWlsLFxuICAgICAgICBoYXNQYXNzd29yZDogISFyZXEuYm9keT8ucGFzc3dvcmQsXG4gICAgICAgIGRhdGFiYXNlVXJsOiAhIXByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCxcbiAgICAgICAgc2Vzc2lvblNlY3JldDogISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCxcbiAgICAgIH0pO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnTG9naW4gZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ0xPR0lOX0VSUk9SJyxcbiAgICAgICAgLi4uKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnICYmIHsgZGV0YWlsczogX2Vycm9yIH0pLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBMb2dvdXQgcm91dGVcbiAgYXBwLnBvc3QoJy9hcGkvYXV0aC9sb2dvdXQnLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0xvZ291dCBfZXJyb3I6JywgZXJyKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTG9nb3V0IGZhaWxlZCcsXG4gICAgICAgICAgY29kZTogJ0xPR09VVF9FUlJPUicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBjb29raWUgd2l0aCBzYW1lIHNldHRpbmdzIGFzIHdoZW4gaXQgd2FzIHNldFxuICAgICAgY29uc3QgY29va2llT3B0aW9uczogYW55ID0ge1xuICAgICAgICBodHRwT25seTogdHJ1ZSxcbiAgICAgICAgc2VjdXJlOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nLFxuICAgICAgICBzYW1lU2l0ZTogJ2xheCcsXG4gICAgICB9O1xuXG4gICAgICByZXMuY2xlYXJDb29raWUoJ2tvdmVvLnNpZCcsIGNvb2tpZU9wdGlvbnMpO1xuICAgICAgcmVzLmpzb24oeyBtZXNzYWdlOiAnTG9nb3V0IHN1Y2Nlc3NmdWwnIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBHZXQgY3VycmVudCB1c2VyIHJvdXRlXG4gIGFwcC5nZXQoJy9hcGkvYXV0aC91c2VyJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayB1c2VyIHNlc3Npb25cbiAgICAgIGNvbnNvbGUubG9nKCfwn5SNIEF1dGggY2hlY2sgLSBTZXNzaW9uIGV4aXN0czonLCAhIXJlcS5zZXNzaW9uKTtcbiAgICAgIGNvbnNvbGUubG9nKCfwn5SNIEF1dGggY2hlY2sgLSBTZXNzaW9uIElEOicsIHJlcS5zZXNzaW9uPy5pZD8uc3Vic3RyaW5nKDAsIDgpICsgJy4uLicpO1xuICAgICAgY29uc29sZS5sb2coJ/CflI0gQXV0aCBjaGVjayAtIFVzZXIgSUQgaW4gc2Vzc2lvbjonLCByZXEuc2Vzc2lvbj8udXNlcklkKTtcblxuICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIHZhbGlkIHNlc3Npb24gd2l0aCB1c2VyIElEXG4gICAgICBpZiAoIXJlcS5zZXNzaW9uPy51c2VySWQpIHtcbiAgICAgICAgLy8gTm8gc2Vzc2lvbiBmb3VuZFxuICAgICAgICBjb25zb2xlLmxvZygn4p2MIE5vIHZhbGlkIHNlc3Npb24gZm91bmQnKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTm90IGF1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgIGNvZGU6ICdOT1RfQVVUSEVOVElDQVRFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBUcnkgdG8gZ2V0IHVzZXIgZnJvbSBkYXRhYmFzZVxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXEuc2Vzc2lvbi51c2VySWQpO1xuICAgICAgICAvLyBVc2VyIGxvb2t1cCBjb21wbGV0ZWRcblxuICAgICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgICAvLyBVc2VyIG5vdCBmb3VuZCBvciBpbmFjdGl2ZSwgZGVzdHJveWluZyBzZXNzaW9uXG4gICAgICAgICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1Nlc3Npb24gZGVzdHJ1Y3Rpb24gZXJyb3I6JywgZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBub3QgZm91bmQgb3IgaW5hY3RpdmUnLFxuICAgICAgICAgICAgY29kZTogJ1VTRVJfSU5BQ1RJVkUnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gT3B0aW1pemVkIHNlc3Npb24gdG91Y2ggLSBvbmx5IHdoZW4gbmVlZGVkXG4gICAgICAgIGlmIChyZXEuc2Vzc2lvbiAmJiByZXEuc2Vzc2lvbi50b3VjaCAmJiByZXEuc2Vzc2lvbi5jb29raWUpIHtcbiAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgIGNvbnN0IHNlc3Npb25BZ2UgPSBub3cgLSAocmVxLnNlc3Npb24uY29va2llLm9yaWdpbmFsTWF4QWdlIHx8IDApICsgKHJlcS5zZXNzaW9uLmNvb2tpZS5tYXhBZ2UgfHwgMCk7XG4gICAgICAgICAgY29uc3Qgc2Vzc2lvbkxpZmV0aW1lID0gcmVxLnNlc3Npb24uY29va2llLm9yaWdpbmFsTWF4QWdlIHx8ICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gT25seSB0b3VjaCBzZXNzaW9uIGlmIG1vcmUgdGhhbiAyNSUgb2YgaXRzIGxpZmV0aW1lIGhhcyBwYXNzZWRcbiAgICAgICAgICBpZiAoc2Vzc2lvbkFnZSA+IHNlc3Npb25MaWZldGltZSAqIDAuMjUpIHtcbiAgICAgICAgICAgIHJlcS5zZXNzaW9uLnRvdWNoKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmV0dXJuIHVzZXIgZGF0YSB3aXRob3V0IHBhc3N3b3JkXG4gICAgICAgIGNvbnN0IHsgcGFzc3dvcmQ6IF8sIC4uLnVzZXJEYXRhIH0gPSB1c2VyO1xuICAgICAgICAvLyBTdWNjZXNzZnVsbHkgYXV0aGVudGljYXRlZCB1c2VyXG4gICAgICAgIHJlcy5qc29uKHVzZXJEYXRhKTtcblxuICAgICAgfSBjYXRjaCAodXNlckVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0RhdGFiYXNlIGVycm9yIGdldHRpbmcgdXNlcjonLCB1c2VyRXJyb3IpO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBjaGVjayBmYWlsZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX0NIRUNLX0VSUk9SJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEF1dGggY2hlY2sgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ0FVVEhfQ0hFQ0tfRVJST1InLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBEZWJ1ZyBlbmRwb2ludCB0byBjaGVjayBhdXRoIGNvbmZpZ3VyYXRpb24gKHByb2R1Y3Rpb24gb25seSwgdGVtcG9yYXJ5KVxuICBhcHAuZ2V0KCcvYXBpL2F1dGgvZGVidWcnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgY29uc3QgZGVidWdJbmZvID0ge1xuICAgICAgaGFzU2Vzc2lvbjogISFyZXEuc2Vzc2lvbixcbiAgICAgIHNlc3Npb25JZDogcmVxLnNlc3Npb25JRCxcbiAgICAgIHVzZXJJZDogcmVxLnNlc3Npb24/LnVzZXJJZCxcbiAgICAgIHVzZXJSb2xlOiByZXEuc2Vzc2lvbj8udXNlclJvbGUsXG4gICAgICBub2RlRW52OiBwcm9jZXNzLmVudi5OT0RFX0VOVixcbiAgICAgIGhhc0RhdGFiYXNlVXJsOiAhIXByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCxcbiAgICAgIGhhc1Nlc3Npb25TZWNyZXQ6ICEhcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQsXG4gICAgICBjb29raWVzOiByZXEuaGVhZGVycy5jb29raWUgPyAncHJlc2VudCcgOiAnbWlzc2luZycsXG4gICAgICBjb29raWVIZWFkZXI6IHJlcS5oZWFkZXJzLmNvb2tpZSxcbiAgICAgIHNlc3Npb25TdG9yZTogcmVxLnNlc3Npb24/LnN0b3JlPy5jb25zdHJ1Y3Rvcj8ubmFtZSB8fCAndW5rbm93bicsXG4gICAgICB1c2VyQWdlbnQ6IHJlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10sXG4gICAgICBob3N0OiByZXEuaGVhZGVycy5ob3N0LFxuICAgICAgcHJvdG9jb2w6IHJlcS5wcm90b2NvbCxcbiAgICAgIHNlY3VyZTogcmVxLnNlY3VyZSxcbiAgICAgIHRydXN0UHJveHk6ICEhcmVxLmFwcC5nZXQoJ3RydXN0IHByb3h5JyksXG4gICAgfTtcblxuICAgIGNvbnNvbGUubG9nKCdBdXRoIGRlYnVnIGluZm86JywgZGVidWdJbmZvKTtcbiAgICByZXMuanNvbihkZWJ1Z0luZm8pO1xuICB9KTtcblxuICAvLyBUZXN0IGNvb2tpZSBzZXR0aW5nIGVuZHBvaW50XG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvdGVzdC1jb29raWUnLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgLy8gU2V0IGEgdGVzdCBzZXNzaW9uIHZhbHVlXG4gICAgcmVxLnNlc3Npb24udGVzdFZhbHVlID0gJ3Rlc3QtJyArIERhdGUubm93KCk7XG5cbiAgICByZXEuc2Vzc2lvbi5zYXZlKChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdGYWlsZWQgdG8gc2F2ZSBzZXNzaW9uJywgZGV0YWlsczogZXJyLm1lc3NhZ2UgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1Rlc3QgY29va2llIHNldCcsXG4gICAgICAgIHNlc3Npb25JZDogcmVxLnNlc3Npb25JRCxcbiAgICAgICAgdGVzdFZhbHVlOiByZXEuc2Vzc2lvbi50ZXN0VmFsdWUsXG4gICAgICAgIGNvb2tpZVNldHRpbmdzOiB7XG4gICAgICAgICAgc2VjdXJlOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nLFxuICAgICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICAgIHNhbWVTaXRlOiAnbGF4JyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBSZWdpc3RlciByb3V0ZSAoYWRtaW4gb25seSBmb3Igbm93KVxuICBhcHAucG9zdChcbiAgICAnL2FwaS9hdXRoL3JlZ2lzdGVyJyxcbiAgICByZXF1aXJlQXV0aCxcbiAgICByZXF1aXJlUm9sZShbJ2FkbWluJ10pLFxuICAgIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkLCBmaXJzdE5hbWUsIGxhc3ROYW1lLCByb2xlID0gJ3RlbmFudCcsIGxhbmd1YWdlID0gJ2ZyJyB9ID0gcmVxLmJvZHk7XG5cbiAgICAgICAgaWYgKCFlbWFpbCB8fCAhcGFzc3dvcmQgfHwgIWZpcnN0TmFtZSB8fCAhbGFzdE5hbWUpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ0FsbCBmaWVsZHMgYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgICAgIGNvZGU6ICdNSVNTSU5HX0ZJRUxEUycsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgZXhpc3RzXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nVXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgIGlmIChleGlzdGluZ1VzZXIpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDkpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWxyZWFkeSBleGlzdHMnLFxuICAgICAgICAgICAgY29kZTogJ1VTRVJfRVhJU1RTJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSB1c2VyIHdpdGggYmNyeXB0IGhhc2hlZCBwYXNzd29yZFxuICAgICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGhhc2hQYXNzd29yZChwYXNzd29yZCk7XG5cbiAgICAgICAgY29uc3QgbmV3VXNlciA9IGF3YWl0IHN0b3JhZ2UuY3JlYXRlVXNlcih7XG4gICAgICAgICAgZW1haWw6IGVtYWlsLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgICBsYXN0TmFtZSxcbiAgICAgICAgICB1c2VybmFtZTogZW1haWwudG9Mb3dlckNhc2UoKSwgLy8gVXNlIGVtYWlsIGFzIHVzZXJuYW1lXG4gICAgICAgICAgcm9sZSxcbiAgICAgICAgICBsYW5ndWFnZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlckRhdGEgfSA9IG5ld1VzZXI7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgICAgICB1c2VyOiB1c2VyRGF0YSxcbiAgICAgICAgICBtZXNzYWdlOiAnVXNlciBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgUmVnaXN0cmF0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdSZWdpc3RyYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBjb2RlOiAnUkVHSVNUUkFUSU9OX0VSUk9SJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIC8vIFBhc3N3b3JkIFJlc2V0IFJlcXVlc3QgUm91dGVcbiAgYXBwLnBvc3QoJy9hcGkvYXV0aC9mb3Jnb3QtcGFzc3dvcmQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW1haWwgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBpZiAoIWVtYWlsKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0VtYWlsIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnTUlTU0lOR19FTUFJTCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyQnlFbWFpbChlbWFpbC50b0xvd2VyQ2FzZSgpKTtcbiAgICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgICAvLyBBbHdheXMgcmVzcG9uZCB3aXRoIHN1Y2Nlc3MgZm9yIHNlY3VyaXR5IChkb24ndCByZXZlYWwgaWYgZW1haWwgZXhpc3RzKVxuICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJZiB0aGlzIGVtYWlsIGV4aXN0cywgYSBwYXNzd29yZCByZXNldCBsaW5rIGhhcyBiZWVuIHNlbnQuJyxcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gR2VuZXJhdGUgc2VjdXJlIHJhbmRvbSB0b2tlblxuICAgICAgY29uc3QgcmVzZXRUb2tlbiA9IHJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgICBjb25zdCB0b2tlbkhhc2ggPSBjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUocmVzZXRUb2tlbikuZGlnZXN0KCdoZXgnKTtcblxuICAgICAgLy8gQ3JlYXRlIHBhc3N3b3JkIHJlc2V0IHRva2VuIChleHBpcmVzIGluIDEgaG91cilcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKCk7XG4gICAgICBleHBpcmVzQXQuc2V0SG91cnMoZXhwaXJlc0F0LmdldEhvdXJzKCkgKyAxKTtcblxuICAgICAgYXdhaXQgc3RvcmFnZS5jcmVhdGVQYXNzd29yZFJlc2V0VG9rZW4oe1xuICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICAgIHRva2VuOiByZXNldFRva2VuLFxuICAgICAgICB0b2tlbkhhc2g6IHRva2VuSGFzaCxcbiAgICAgICAgZXhwaXJlc0F0OiBleHBpcmVzQXQsXG4gICAgICAgIGlwQWRkcmVzczogcmVxLmlwIHx8IHJlcS5jb25uZWN0aW9uPy5yZW1vdGVBZGRyZXNzIHx8ICd1bmtub3duJyxcbiAgICAgICAgdXNlckFnZW50OiByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddIHx8ICd1bmtub3duJyxcbiAgICAgIH0gYXMgYW55KTtcblxuICAgICAgLy8gU2VuZCBwYXNzd29yZCByZXNldCBlbWFpbFxuICAgICAgY29uc3QgaG9zdCA9IHJlcS5nZXQoJ2hvc3QnKSB8fCAnJztcblxuICAgICAgLy8gVXNlIGRldmVsb3BtZW50IFVSTCBmb3IgUmVwbGl0IGVudmlyb25tZW50cywgcHJvZHVjdGlvbiBVUkwgb3RoZXJ3aXNlXG4gICAgICBsZXQgZnJvbnRlbmRVcmw7XG4gICAgICBpZiAoXG4gICAgICAgIGhvc3QuaW5jbHVkZXMoJ3JlcGxpdC5kZXYnKSB8fFxuICAgICAgICBob3N0LmluY2x1ZGVzKCdyZXBsaXQuY29tJykgfHxcbiAgICAgICAgaG9zdC5pbmNsdWRlcygncmVwbGl0LmNvJykgfHxcbiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCdcbiAgICAgICkge1xuICAgICAgICAvLyBVc2UgdGhlIGFjdHVhbCBSZXBsaXQgZGV2ZWxvcG1lbnQgVVJMXG4gICAgICAgIGZyb250ZW5kVXJsID0gYCR7cmVxLnByb3RvY29sfTovLyR7aG9zdH1gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVXNlIHByb2R1Y3Rpb24gVVJMIC0gcHJpb3JpdGl6ZSBrb3Zlby1nZXN0aW9uLmNvbSBmb3IgcHJvZHVjdGlvblxuICAgICAgICBpZiAoaG9zdC5pbmNsdWRlcygna292ZW8tZ2VzdGlvbi5jb20nKSkge1xuICAgICAgICAgIGZyb250ZW5kVXJsID0gYGh0dHBzOi8vJHtob3N0fWA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZnJvbnRlbmRVcmwgPSBwcm9jZXNzLmVudi5GUk9OVEVORF9VUkwgfHwgJ2h0dHBzOi8va292ZW8tZ2VzdGlvbi5jb20nO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNsZWFuVXJsID0gZnJvbnRlbmRVcmwuZW5kc1dpdGgoJy8nKSA/IGZyb250ZW5kVXJsLnNsaWNlKDAsIC0xKSA6IGZyb250ZW5kVXJsO1xuICAgICAgY29uc3QgcmVzZXRVcmwgPSBgJHtjbGVhblVybH0vcmVzZXQtcGFzc3dvcmQ/dG9rZW49JHtyZXNldFRva2VufWA7XG5cblxuICAgICAgY29uc3QgZW1haWxTZW50ID0gYXdhaXQgZW1haWxTZXJ2aWNlLnNlbmRQYXNzd29yZFJlc2V0RW1haWwoXG4gICAgICAgIGVtYWlsLnRvTG93ZXJDYXNlKCksXG4gICAgICAgIGAke3VzZXIuZmlyc3ROYW1lfSAke3VzZXIubGFzdE5hbWV9YCxcbiAgICAgICAgcmVzZXRVcmxcbiAgICAgICk7XG5cbiAgICAgIGlmICghZW1haWxTZW50KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIHBhc3N3b3JkIHJlc2V0IGVtYWlsIHRvOicsIGVtYWlsKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgZW1haWwnLFxuICAgICAgICAgIGNvZGU6ICdFTUFJTF9TRU5EX0ZBSUxFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdJZiB0aGlzIGVtYWlsIGV4aXN0cywgYSBwYXNzd29yZCByZXNldCBsaW5rIGhhcyBiZWVuIHNlbnQuJyxcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBQYXNzd29yZCByZXNldCByZXF1ZXN0IGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIHJlc2V0IHJlcXVlc3QgZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ1BBU1NXT1JEX1JFU0VUX1JFUVVFU1RfRVJST1InLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBQYXNzd29yZCBSZXNldCBSb3V0ZVxuICBhcHAucG9zdCgnL2FwaS9hdXRoL3Jlc2V0LXBhc3N3b3JkJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRva2VuLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIGlmICghdG9rZW4gfHwgIXBhc3N3b3JkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1Rva2VuIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdNSVNTSU5HX0ZJRUxEUycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBwYXNzd29yZCBzdHJlbmd0aFxuICAgICAgaWYgKHBhc3N3b3JkLmxlbmd0aCA8IDgpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA4IGNoYXJhY3RlcnMgbG9uZycsXG4gICAgICAgICAgY29kZTogJ1BBU1NXT1JEX1RPT19TSE9SVCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBwYXNzd29yZCBjb21wbGV4aXR5IHJlcXVpcmVtZW50c1xuICAgICAgY29uc3QgaGFzVXBwZXJDYXNlID0gL1tBLVpdLy50ZXN0KHBhc3N3b3JkKTtcbiAgICAgIGNvbnN0IGhhc0xvd2VyQ2FzZSA9IC9bYS16XS8udGVzdChwYXNzd29yZCk7XG4gICAgICBjb25zdCBoYXNOdW1iZXJzID0gL1xcZC8udGVzdChwYXNzd29yZCk7XG5cbiAgICAgIGlmICghaGFzVXBwZXJDYXNlIHx8ICFoYXNMb3dlckNhc2UgfHwgIWhhc051bWJlcnMpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgdXBwZXJjYXNlIGxldHRlciwgb25lIGxvd2VyY2FzZSBsZXR0ZXIsIGFuZCBvbmUgbnVtYmVyJyxcbiAgICAgICAgICBjb2RlOiAnUEFTU1dPUkRfVE9PX1dFQUsnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gRmluZCB0aGUgcGFzc3dvcmQgcmVzZXQgdG9rZW5cbiAgICAgIGNvbnN0IHJlc2V0VG9rZW4gPSBhd2FpdCBzdG9yYWdlLmdldFBhc3N3b3JkUmVzZXRUb2tlbih0b2tlbik7XG4gICAgICBpZiAoIXJlc2V0VG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHBhc3N3b3JkIHJlc2V0IHRva2VuJyxcbiAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9UT0tFTicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB0b2tlbiBpcyBleHBpcmVkXG4gICAgICBpZiAobmV3IERhdGUoKSA+IHJlc2V0VG9rZW4uZXhwaXJlc0F0KSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIHJlc2V0IHRva2VuIGhhcyBleHBpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnVE9LRU5fRVhQSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB0b2tlbiBoYXMgYWxyZWFkeSBiZWVuIHVzZWRcbiAgICAgIGlmIChyZXNldFRva2VuLmlzVXNlZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCB0b2tlbiBoYXMgYWxyZWFkeSBiZWVuIHVzZWQnLFxuICAgICAgICAgIGNvZGU6ICdUT0tFTl9BTFJFQURZX1VTRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IHRva2VuIGhhc2ggZm9yIGFkZGl0aW9uYWwgc2VjdXJpdHlcbiAgICAgIGNvbnN0IHRva2VuSGFzaCA9IGNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZSh0b2tlbikuZGlnZXN0KCdoZXgnKTtcbiAgICAgIGlmICh0b2tlbkhhc2ggIT09IHJlc2V0VG9rZW4udG9rZW5IYXNoKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgcGFzc3dvcmQgcmVzZXQgdG9rZW4nLFxuICAgICAgICAgIGNvZGU6ICdJTlZBTElEX1RPS0VOX0hBU0gnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IHRoZSB1c2VyXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyKHJlc2V0VG9rZW4udXNlcklkKTtcbiAgICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIGFjY291bnQgbm90IGZvdW5kIG9yIGluYWN0aXZlJyxcbiAgICAgICAgICBjb2RlOiAnVVNFUl9OT1RfRk9VTkQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVXBkYXRlIHVzZXIgcGFzc3dvcmQgd2l0aCBiY3J5cHQgaGFzaGVkIHZlcnNpb25cbiAgICAgIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgaGFzaFBhc3N3b3JkKHBhc3N3b3JkKTtcblxuICAgICAgYXdhaXQgc3RvcmFnZS51cGRhdGVVc2VyKHVzZXIuaWQsIHtcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9KTtcblxuICAgICAgLy8gTWFyayB0b2tlbiBhcyB1c2VkXG4gICAgICBhd2FpdCBzdG9yYWdlLm1hcmtQYXNzd29yZFJlc2V0VG9rZW5Bc1VzZWQocmVzZXRUb2tlbi5pZCk7XG5cbiAgICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgdG9rZW5zXG4gICAgICBhd2FpdCBzdG9yYWdlLmNsZWFudXBFeHBpcmVkUGFzc3dvcmRSZXNldFRva2VucygpO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCBoYXMgYmVlbiByZXNldCBzdWNjZXNzZnVsbHknLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIFBhc3N3b3JkIHJlc2V0IGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIHJlc2V0IGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdQQVNTV09SRF9SRVNFVF9FUlJPUicsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIERvY3VtZW50IFJCQUMgRnVuY3Rpb25zIC0gUm9sZS1CYXNlZCBBY2Nlc3MgQ29udHJvbCBmb3IgRG9jdW1lbnRzXG4gKiBJbXBsZW1lbnRzIHRoZSBmb3VyLXRpZXIgcGVybWlzc2lvbiBzeXN0ZW06IEFkbWluID4gTWFuYWdlciA+IFJlc2lkZW50ID4gVGVuYW50XG4gKi9cblxuLyoqXG4gKiBDaGVjayBpZiB1c2VyIGNhbiB2aWV3IGEgc3BlY2lmaWMgZG9jdW1lbnQgYmFzZWQgb24gUkJBQyBydWxlc1xuICogQHBhcmFtIHVzZXIgLSBUaGUgYXV0aGVudGljYXRlZCB1c2VyXG4gKiBAcGFyYW0gZG9jdW1lbnQgLSBUaGUgZG9jdW1lbnQgdG8gY2hlY2sgYWNjZXNzIGZvclxuICogQHBhcmFtIHVzZXJSZXNpZGVuY2VzIC0gVXNlcidzIHJlc2lkZW5jZSBhc3NvY2lhdGlvbnNcbiAqIEByZXR1cm5zIFByb21pc2U8Ym9vbGVhbj4gLSBUcnVlIGlmIHVzZXIgY2FuIHZpZXcgZG9jdW1lbnRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhblZpZXdEb2N1bWVudChcbiAgdXNlcjogQXV0aGVudGljYXRlZFVzZXIsIFxuICBkb2N1bWVudDogYW55LCBcbiAgdXNlclJlc2lkZW5jZXM/OiBhbnlbXVxuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgLy8gQWRtaW46IENhbiB2aWV3IGFsbCBkb2N1bWVudHNcbiAgICBpZiAodXNlci5yb2xlID09PSAnYWRtaW4nKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBNYW5hZ2VyOiBDYW4gdmlldyBhbGwgZG9jdW1lbnRzIGluIHRoZWlyIG9yZ2FuaXphdGlvblxuICAgIGlmICh1c2VyLnJvbGUgPT09ICdtYW5hZ2VyJykge1xuICAgICAgLy8gQ2hlY2sgaWYgZG9jdW1lbnQgYmVsb25ncyB0byBtYW5hZ2VyJ3Mgb3JnYW5pemF0aW9uXG4gICAgICBpZiAoZG9jdW1lbnQuYnVpbGRpbmdJZCkge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcoZG9jdW1lbnQuYnVpbGRpbmdJZCk7XG4gICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAoZG9jdW1lbnQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgc3RvcmFnZS5nZXRSZXNpZGVuY2UoZG9jdW1lbnQucmVzaWRlbmNlSWQpO1xuICAgICAgICBpZiAocmVzaWRlbmNlKSB7XG4gICAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1aWxkaW5nKHJlc2lkZW5jZS5idWlsZGluZ0lkKTtcbiAgICAgICAgICByZXR1cm4gYnVpbGRpbmc/Lm9yZ2FuaXphdGlvbklkID09PSB1c2VyLm9yZ2FuaXphdGlvbklkO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTsgLy8gTWFuYWdlciBjYW4gdmlldyBvcmdhbml6YXRpb24tbGV2ZWwgZG9jc1xuICAgIH1cblxuICAgIC8vIFJlc2lkZW50OiBDYW4gdmlldyBkb2N1bWVudHMgaW4gdGhlaXIgcmVzaWRlbmNlL2J1aWxkaW5nXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ3Jlc2lkZW50Jykge1xuICAgICAgaWYgKGRvY3VtZW50LnJlc2lkZW5jZUlkKSB7XG4gICAgICAgIHJldHVybiB1c2VyUmVzaWRlbmNlcz8uc29tZSh1ciA9PiB1ci5yZXNpZGVuY2VJZCA9PT0gZG9jdW1lbnQucmVzaWRlbmNlSWQpIHx8IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKGRvY3VtZW50LmJ1aWxkaW5nSWQpIHtcbiAgICAgICAgLy8gQ2FuIHZpZXcgYnVpbGRpbmcgZG9jcyBpZiB0aGV5IGxpdmUgaW4gdGhhdCBidWlsZGluZ1xuICAgICAgICBjb25zdCB1c2VyQnVpbGRpbmdJZHMgPSB1c2VyUmVzaWRlbmNlcz8ubWFwKGFzeW5jIHVyID0+IHtcbiAgICAgICAgICBjb25zdCByZXNpZGVuY2UgPSBhd2FpdCBzdG9yYWdlLmdldFJlc2lkZW5jZSh1ci5yZXNpZGVuY2VJZCk7XG4gICAgICAgICAgcmV0dXJuIHJlc2lkZW5jZT8uYnVpbGRpbmdJZDtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nSWRzID0gYXdhaXQgUHJvbWlzZS5hbGwodXNlckJ1aWxkaW5nSWRzIHx8IFtdKTtcbiAgICAgICAgcmV0dXJuIGJ1aWxkaW5nSWRzLmluY2x1ZGVzKGRvY3VtZW50LmJ1aWxkaW5nSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFRlbmFudDogQ2FuIG9ubHkgdmlldyBkb2N1bWVudHMgbWFya2VkIGFzIHZpc2libGUgdG8gdGVuYW50c1xuICAgIGlmICh1c2VyLnJvbGUgPT09ICd0ZW5hbnQnKSB7XG4gICAgICBpZiAoIWRvY3VtZW50LmlzVmlzaWJsZVRvVGVuYW50cykge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmIChkb2N1bWVudC5yZXNpZGVuY2VJZCkge1xuICAgICAgICByZXR1cm4gdXNlclJlc2lkZW5jZXM/LnNvbWUodXIgPT4gdXIucmVzaWRlbmNlSWQgPT09IGRvY3VtZW50LnJlc2lkZW5jZUlkKSB8fCBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChkb2N1bWVudC5idWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbnN0IHVzZXJCdWlsZGluZ0lkcyA9IHVzZXJSZXNpZGVuY2VzPy5tYXAoYXN5bmMgdXIgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc2lkZW5jZSA9IGF3YWl0IHN0b3JhZ2UuZ2V0UmVzaWRlbmNlKHVyLnJlc2lkZW5jZUlkKTtcbiAgICAgICAgICByZXR1cm4gcmVzaWRlbmNlPy5idWlsZGluZ0lkO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgYnVpbGRpbmdJZHMgPSBhd2FpdCBQcm9taXNlLmFsbCh1c2VyQnVpbGRpbmdJZHMgfHwgW10pO1xuICAgICAgICByZXR1cm4gYnVpbGRpbmdJZHMuaW5jbHVkZXMoZG9jdW1lbnQuYnVpbGRpbmdJZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0RvY3VtZW50IHZpZXcgcGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrIGlmIHVzZXIgY2FuIGVkaXQgYSBzcGVjaWZpYyBkb2N1bWVudFxuICogQHBhcmFtIHVzZXIgLSBUaGUgYXV0aGVudGljYXRlZCB1c2VyXG4gKiBAcGFyYW0gZG9jdW1lbnQgLSBUaGUgZG9jdW1lbnQgdG8gY2hlY2tcbiAqIEBwYXJhbSB1c2VyUmVzaWRlbmNlcyAtIFVzZXIncyByZXNpZGVuY2UgYXNzb2NpYXRpb25zXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGNhbiBlZGl0IGRvY3VtZW50XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYW5FZGl0RG9jdW1lbnQoXG4gIHVzZXI6IEF1dGhlbnRpY2F0ZWRVc2VyLCBcbiAgZG9jdW1lbnQ6IGFueSwgXG4gIHVzZXJSZXNpZGVuY2VzPzogYW55W11cbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIC8vIEFkbWluOiBDYW4gZWRpdCBhbGwgZG9jdW1lbnRzXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gTWFuYWdlcjogQ2FuIGVkaXQgYWxsIGRvY3VtZW50cyBpbiB0aGVpciBvcmdhbml6YXRpb25cbiAgICBpZiAodXNlci5yb2xlID09PSAnbWFuYWdlcicpIHtcbiAgICAgIGlmIChkb2N1bWVudC5idWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgc3RvcmFnZS5nZXRCdWlsZGluZyhkb2N1bWVudC5idWlsZGluZ0lkKTtcbiAgICAgICAgcmV0dXJuIGJ1aWxkaW5nPy5vcmdhbml6YXRpb25JZCA9PT0gdXNlci5vcmdhbml6YXRpb25JZDtcbiAgICAgIH1cbiAgICAgIGlmIChkb2N1bWVudC5yZXNpZGVuY2VJZCkge1xuICAgICAgICBjb25zdCByZXNpZGVuY2UgPSBhd2FpdCBzdG9yYWdlLmdldFJlc2lkZW5jZShkb2N1bWVudC5yZXNpZGVuY2VJZCk7XG4gICAgICAgIGlmIChyZXNpZGVuY2UpIHtcbiAgICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcocmVzaWRlbmNlLmJ1aWxkaW5nSWQpO1xuICAgICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFJlc2lkZW50OiBDYW4gZWRpdCBkb2N1bWVudHMgdGhleSBjcmVhdGVkIG9yIGluIHRoZWlyIHJlc2lkZW5jZVxuICAgIGlmICh1c2VyLnJvbGUgPT09ICdyZXNpZGVudCcpIHtcbiAgICAgIC8vIENhbiBlZGl0IG93biBkb2N1bWVudHNcbiAgICAgIGlmIChkb2N1bWVudC51cGxvYWRlZEJ5ID09PSB1c2VyLmlkKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDYW4gZWRpdCByZXNpZGVuY2UgZG9jdW1lbnRzXG4gICAgICBpZiAoZG9jdW1lbnQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgcmV0dXJuIHVzZXJSZXNpZGVuY2VzPy5zb21lKHVyID0+IHVyLnJlc2lkZW5jZUlkID09PSBkb2N1bWVudC5yZXNpZGVuY2VJZCkgfHwgZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVGVuYW50OiBDYW5ub3QgZWRpdCBkb2N1bWVudHMgKHJlYWQtb25seSBhY2Nlc3MpXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0RvY3VtZW50IGVkaXQgcGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrIGlmIHVzZXIgY2FuIGRlbGV0ZSBhIHNwZWNpZmljIGRvY3VtZW50XG4gKiBAcGFyYW0gdXNlciAtIFRoZSBhdXRoZW50aWNhdGVkIHVzZXJcbiAqIEBwYXJhbSBkb2N1bWVudCAtIFRoZSBkb2N1bWVudCB0byBjaGVja1xuICogQHBhcmFtIHVzZXJSZXNpZGVuY2VzIC0gVXNlcidzIHJlc2lkZW5jZSBhc3NvY2lhdGlvbnNcbiAqIEByZXR1cm5zIFByb21pc2U8Ym9vbGVhbj4gLSBUcnVlIGlmIHVzZXIgY2FuIGRlbGV0ZSBkb2N1bWVudFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FuRGVsZXRlRG9jdW1lbnQoXG4gIHVzZXI6IEF1dGhlbnRpY2F0ZWRVc2VyLCBcbiAgZG9jdW1lbnQ6IGFueSwgXG4gIHVzZXJSZXNpZGVuY2VzPzogYW55W11cbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIC8vIEFkbWluOiBDYW4gZGVsZXRlIGFsbCBkb2N1bWVudHNcbiAgICBpZiAodXNlci5yb2xlID09PSAnYWRtaW4nKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBNYW5hZ2VyOiBDYW4gZGVsZXRlIGRvY3VtZW50cyBpbiB0aGVpciBvcmdhbml6YXRpb25cbiAgICBpZiAodXNlci5yb2xlID09PSAnbWFuYWdlcicpIHtcbiAgICAgIGlmIChkb2N1bWVudC5idWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgc3RvcmFnZS5nZXRCdWlsZGluZyhkb2N1bWVudC5idWlsZGluZ0lkKTtcbiAgICAgICAgcmV0dXJuIGJ1aWxkaW5nPy5vcmdhbml6YXRpb25JZCA9PT0gdXNlci5vcmdhbml6YXRpb25JZDtcbiAgICAgIH1cbiAgICAgIGlmIChkb2N1bWVudC5yZXNpZGVuY2VJZCkge1xuICAgICAgICBjb25zdCByZXNpZGVuY2UgPSBhd2FpdCBzdG9yYWdlLmdldFJlc2lkZW5jZShkb2N1bWVudC5yZXNpZGVuY2VJZCk7XG4gICAgICAgIGlmIChyZXNpZGVuY2UpIHtcbiAgICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcocmVzaWRlbmNlLmJ1aWxkaW5nSWQpO1xuICAgICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFJlc2lkZW50OiBDYW4gb25seSBkZWxldGUgZG9jdW1lbnRzIHRoZXkgdXBsb2FkZWRcbiAgICBpZiAodXNlci5yb2xlID09PSAncmVzaWRlbnQnKSB7XG4gICAgICByZXR1cm4gZG9jdW1lbnQudXBsb2FkZWRCeSA9PT0gdXNlci5pZDtcbiAgICB9XG5cbiAgICAvLyBUZW5hbnQ6IENhbm5vdCBkZWxldGUgZG9jdW1lbnRzXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0RvY3VtZW50IGRlbGV0ZSBwZXJtaXNzaW9uIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgdXNlciBjYW4gY3JlYXRlIGRvY3VtZW50cyBpbiBhIHNwZWNpZmljIGNvbnRleHRcbiAqIEBwYXJhbSB1c2VyIC0gVGhlIGF1dGhlbnRpY2F0ZWQgdXNlclxuICogQHBhcmFtIGNvbnRleHQgLSBUaGUgY29udGV4dCAoYnVpbGRpbmdJZCwgcmVzaWRlbmNlSWQsIG9yIG9yZ2FuaXphdGlvbilcbiAqIEByZXR1cm5zIFByb21pc2U8Ym9vbGVhbj4gLSBUcnVlIGlmIHVzZXIgY2FuIGNyZWF0ZSBkb2N1bWVudHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbkNyZWF0ZURvY3VtZW50KFxuICB1c2VyOiBBdXRoZW50aWNhdGVkVXNlcixcbiAgY29udGV4dDogeyBidWlsZGluZ0lkPzogc3RyaW5nOyByZXNpZGVuY2VJZD86IHN0cmluZzsgb3JnYW5pemF0aW9uSWQ/OiBzdHJpbmcgfVxuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgLy8gQWRtaW46IENhbiBjcmVhdGUgZG9jdW1lbnRzIGFueXdoZXJlXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gTWFuYWdlcjogQ2FuIGNyZWF0ZSBkb2N1bWVudHMgaW4gdGhlaXIgb3JnYW5pemF0aW9uXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ21hbmFnZXInKSB7XG4gICAgICBpZiAoY29udGV4dC5vcmdhbml6YXRpb25JZCkge1xuICAgICAgICByZXR1cm4gY29udGV4dC5vcmdhbml6YXRpb25JZCA9PT0gdXNlci5vcmdhbml6YXRpb25JZDtcbiAgICAgIH1cbiAgICAgIGlmIChjb250ZXh0LmJ1aWxkaW5nSWQpIHtcbiAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1aWxkaW5nKGNvbnRleHQuYnVpbGRpbmdJZCk7XG4gICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAoY29udGV4dC5yZXNpZGVuY2VJZCkge1xuICAgICAgICBjb25zdCByZXNpZGVuY2UgPSBhd2FpdCBzdG9yYWdlLmdldFJlc2lkZW5jZShjb250ZXh0LnJlc2lkZW5jZUlkKTtcbiAgICAgICAgaWYgKHJlc2lkZW5jZSkge1xuICAgICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgc3RvcmFnZS5nZXRCdWlsZGluZyhyZXNpZGVuY2UuYnVpbGRpbmdJZCk7XG4gICAgICAgICAgcmV0dXJuIGJ1aWxkaW5nPy5vcmdhbml6YXRpb25JZCA9PT0gdXNlci5vcmdhbml6YXRpb25JZDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gUmVzaWRlbnQ6IENhbiBjcmVhdGUgZG9jdW1lbnRzIGluIHRoZWlyIHJlc2lkZW5jZVxuICAgIGlmICh1c2VyLnJvbGUgPT09ICdyZXNpZGVudCcpIHtcbiAgICAgIGlmIChjb250ZXh0LnJlc2lkZW5jZUlkKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHVzZXIgbGl2ZXMgaW4gdGhpcyByZXNpZGVuY2VcbiAgICAgICAgY29uc3QgdXNlclJlc2lkZW5jZXMgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXJSZXNpZGVuY2VzKHVzZXIuaWQpO1xuICAgICAgICByZXR1cm4gdXNlclJlc2lkZW5jZXMuc29tZSh1ciA9PiB1ci5yZXNpZGVuY2VJZCA9PT0gY29udGV4dC5yZXNpZGVuY2VJZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVGVuYW50OiBDYW5ub3QgY3JlYXRlIGRvY3VtZW50c1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdEb2N1bWVudCBjcmVhdGUgcGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vLyBFeHRlbmRlZCB1c2VyIGludGVyZmFjZSBmb3IgYXV0aGVudGljYXRpb24gY29udGV4dFxuaW50ZXJmYWNlIEF1dGhlbnRpY2F0ZWRVc2VyIGV4dGVuZHMgVXNlciB7XG4gIG9yZ2FuaXphdGlvbnM/OiBzdHJpbmdbXTtcbiAgY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucz86IGJvb2xlYW47XG4gIG9yZ2FuaXphdGlvbklkPzogc3RyaW5nO1xufVxuXG4vLyBFeHRlbmQgRXhwcmVzcyBSZXF1ZXN0IGludGVyZmFjZSB0byBpbmNsdWRlIGF1dGhlbnRpY2F0ZWQgdXNlclxuZGVjbGFyZSBnbG9iYWwge1xuICBuYW1lc3BhY2UgRXhwcmVzcyB7XG4gICAgaW50ZXJmYWNlIFJlcXVlc3Qge1xuICAgICAgdXNlcj86IEF1dGhlbnRpY2F0ZWRVc2VyO1xuICAgIH1cbiAgfVxufVxuXG4vLyBFeHRlbmQgZXhwcmVzcy1zZXNzaW9uIHRvIGluY2x1ZGUgY3VzdG9tIHByb3BlcnRpZXNcbmRlY2xhcmUgbW9kdWxlICdleHByZXNzLXNlc3Npb24nIHtcbiAgaW50ZXJmYWNlIFNlc3Npb25EYXRhIHtcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgdXNlclJvbGU/OiBzdHJpbmc7XG4gICAgcm9sZT86IHN0cmluZztcbiAgICB1c2VyPzogQXV0aGVudGljYXRlZFVzZXI7XG4gICAgcGVybWlzc2lvbnM/OiBzdHJpbmdbXTtcbiAgICBzdG9yZT86IGFueTtcbiAgICB0ZXN0VmFsdWU/OiBhbnk7XG4gICAgb3JnYW5pemF0aW9uSWQ/OiBzdHJpbmc7XG4gICAgb3JnYW5pemF0aW9ucz86IHN0cmluZ1tdO1xuICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM/OiBib29sZWFuO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=