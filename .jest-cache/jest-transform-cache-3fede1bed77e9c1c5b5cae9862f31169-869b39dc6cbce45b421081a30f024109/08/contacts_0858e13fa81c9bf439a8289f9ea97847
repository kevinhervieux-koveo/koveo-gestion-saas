10fabb773e76864bd9c73b0cefde6181
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerContactRoutes = registerContactRoutes;
const db_1 = require("../db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const index_1 = require("../auth/index");
/**
 * Register contact routes for managing entity contacts.
 *
 * @param app - Express application instance.
 */
/**
 * RegisterContactRoutes function.
 * @param app
 * @returns Function result.
 */
function registerContactRoutes(app) {
    // Get contacts for a specific entity
    app.get('/api/contacts/:entity/:entityId', index_1.requireAuth, async (req, res) => {
        try {
            const { entity, entityId } = req.params;
            const user = req.user;
            // Validate entity type
            if (!['organization', 'building', 'residence'].includes(entity)) {
                return res.status(400).json({ message: 'Invalid entity type' });
            }
            // Get contacts
            const entityContacts = await db_1.db
                .select()
                .from(schema_1.contacts)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.contacts.entity, entity), (0, drizzle_orm_1.eq)(schema_1.contacts.entityId, entityId), (0, drizzle_orm_1.eq)(schema_1.contacts.isActive, true)));
            res.json(entityContacts);
        }
        catch (error) {
            console.error('❌ Error fetching entity contacts:', error);
            res.status(500).json({ message: 'Failed to fetch contacts' });
        }
    });
    // Get contacts for a residence with access control
    app.get('/api/residences/:residenceId/contacts', index_1.requireAuth, async (req, res) => {
        try {
            const { residenceId } = req.params;
            const user = req.user;
            // Check if user has access to this residence
            if (user.role !== 'admin') {
                const hasAccess = await db_1.db
                    .select()
                    .from(schema_1.residences)
                    .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                    .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.id, residenceId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
                if (hasAccess.length === 0) {
                    return res.status(403).json({ message: 'Access denied' });
                }
            }
            // Get contacts for the residence
            const residenceContacts = await db_1.db
                .select()
                .from(schema_1.contacts)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.contacts.entity, 'residence'), (0, drizzle_orm_1.eq)(schema_1.contacts.entityId, residenceId), (0, drizzle_orm_1.eq)(schema_1.contacts.isActive, true)));
            res.json(residenceContacts);
        }
        catch (error) {
            console.error('❌ Error fetching residence contacts:', error);
            res.status(500).json({ message: 'Failed to fetch residence contacts' });
        }
    });
    // Get contacts with filtering by entity and entityId
    app.get('/api/contacts', index_1.requireAuth, async (req, res) => {
        try {
            const { entity, entityId } = req.query;
            const user = req.user;
            if (!entity || !entityId) {
                // Return empty array instead of error for missing parameters
                return res.json([]);
            }
            // Check permissions for building contacts
            if (entity === 'building') {
                // Anyone can view building contacts for buildings they have access to
                const hasAccess = await db_1.db
                    .select()
                    .from(schema_1.buildings)
                    .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.id, entityId), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                if (hasAccess.length === 0) {
                    return res.status(404).json({ message: 'Building not found' });
                }
            }
            // Get contacts for the specified entity
            const entityContacts = await db_1.db
                .select()
                .from(schema_1.contacts)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.contacts.entity, entity), (0, drizzle_orm_1.eq)(schema_1.contacts.entityId, entityId), (0, drizzle_orm_1.eq)(schema_1.contacts.isActive, true)));
            res.json(entityContacts);
        }
        catch (error) {
            console.error('❌ Error fetching contacts:', error);
            res.status(500).json({ message: 'Failed to fetch contacts' });
        }
    });
    // Create a new contact
    app.post('/api/contacts', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const validatedData = schema_1.insertContactSchema.parse(req.body);
            // Check permissions based on user role and entity
            const { entity, entityId, name, email, phone, contactCategory } = validatedData;
            // Only managers and admins can add building contacts
            if (entity === 'building' && user.role !== 'admin' && user.role !== 'manager') {
                return res
                    .status(403)
                    .json({ message: 'Only managers and admins can add building contacts' });
            }
            // Verify entity exists based on type
            if (entity === 'residence') {
                const residence = await db_1.db
                    .select()
                    .from(schema_1.residences)
                    .where((0, drizzle_orm_1.eq)(schema_1.residences.id, entityId))
                    .limit(1);
                if (residence.length === 0) {
                    return res.status(400).json({ message: 'Residence not found' });
                }
            }
            else if (entity === 'building') {
                const building = await db_1.db
                    .select()
                    .from(schema_1.buildings)
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, entityId))
                    .limit(1);
                if (building.length === 0) {
                    return res.status(400).json({ message: 'Building not found' });
                }
            }
            // Create the contact
            const [newContact] = await db_1.db
                .insert(schema_1.contacts)
                .values([
                {
                    ...validatedData,
                    entity: validatedData.entity,
                    contactCategory: validatedData.contactCategory,
                },
            ])
                .returning();
            res.status(201).json(newContact);
        }
        catch (error) {
            console.error('❌ Error creating contact:', error);
            res.status(500).json({ message: 'Failed to create contact' });
        }
    });
    // Update a contact
    app.patch('/api/contacts/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const updates = req.body;
            // Get the existing contact
            const existing = await db_1.db.select().from(schema_1.contacts).where((0, drizzle_orm_1.eq)(schema_1.contacts.id, id)).limit(1);
            if (existing.length === 0) {
                return res.status(404).json({ message: 'Contact not found' });
            }
            const contact = existing[0];
            // Check permissions - only managers and admins can edit contacts
            if (user.role !== 'admin' && user.role !== 'manager') {
                return res.status(403).json({ message: 'Access denied' });
            }
            // Update the contact
            const [updatedContact] = await db_1.db
                .update(schema_1.contacts)
                .set({
                ...updates,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.contacts.id, id))
                .returning();
            res.json(updatedContact);
        }
        catch (error) {
            console.error('❌ Error updating contact:', error);
            res.status(500).json({ message: 'Failed to update contact' });
        }
    });
    // Delete a contact
    app.delete('/api/contacts/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            // Get the existing contact
            const existing = await db_1.db.select().from(schema_1.contacts).where((0, drizzle_orm_1.eq)(schema_1.contacts.id, id)).limit(1);
            if (existing.length === 0) {
                return res.status(404).json({ message: 'Contact not found' });
            }
            const contact = existing[0];
            // Check permissions - residents, managers and admins can delete contacts
            if (user.role !== 'admin' && user.role !== 'manager' && user.role !== 'resident') {
                return res.status(403).json({ message: 'Access denied' });
            }
            // Soft delete the contact
            await db_1.db
                .update(schema_1.contacts)
                .set({
                isActive: false,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.contacts.id, id));
            res.json({ message: 'Contact deleted successfully' });
        }
        catch (error) {
            console.error('❌ Error deleting contact:', error);
            res.status(500).json({ message: 'Failed to delete contact' });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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O1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2xELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLENBQUMsQ0FBQztRQUNoRSxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2FwaS9jb250YWN0cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeHByZXNzIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uL2RiJztcbmltcG9ydCB7XG4gIGNvbnRhY3RzLFxuICByZXNpZGVuY2VzLFxuICBidWlsZGluZ3MsXG4gIG9yZ2FuaXphdGlvbnMsXG4gIGluc2VydENvbnRhY3RTY2hlbWEsXG59IGZyb20gJy4uLy4uL3NoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgZXEsIGFuZCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vYXV0aC9pbmRleCc7XG5cbi8qKlxuICogUmVnaXN0ZXIgY29udGFjdCByb3V0ZXMgZm9yIG1hbmFnaW5nIGVudGl0eSBjb250YWN0cy5cbiAqXG4gKiBAcGFyYW0gYXBwIC0gRXhwcmVzcyBhcHBsaWNhdGlvbiBpbnN0YW5jZS5cbiAqL1xuLyoqXG4gKiBSZWdpc3RlckNvbnRhY3RSb3V0ZXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYXBwXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckNvbnRhY3RSb3V0ZXMoYXBwOiBFeHByZXNzKSB7XG4gIC8vIEdldCBjb250YWN0cyBmb3IgYSBzcGVjaWZpYyBlbnRpdHlcbiAgYXBwLmdldCgnL2FwaS9jb250YWN0cy86ZW50aXR5LzplbnRpdHlJZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW50aXR5LCBlbnRpdHlJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgLy8gVmFsaWRhdGUgZW50aXR5IHR5cGVcbiAgICAgIGlmICghWydvcmdhbml6YXRpb24nLCAnYnVpbGRpbmcnLCAncmVzaWRlbmNlJ10uaW5jbHVkZXMoZW50aXR5KSkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAnSW52YWxpZCBlbnRpdHkgdHlwZScgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBjb250YWN0c1xuICAgICAgY29uc3QgZW50aXR5Q29udGFjdHMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgLmZyb20oY29udGFjdHMpXG4gICAgICAgIC53aGVyZShcbiAgICAgICAgICBhbmQoXG4gICAgICAgICAgICBlcShjb250YWN0cy5lbnRpdHksIGVudGl0eSBhcyBhbnkpLFxuICAgICAgICAgICAgZXEoY29udGFjdHMuZW50aXR5SWQsIGVudGl0eUlkKSxcbiAgICAgICAgICAgIGVxKGNvbnRhY3RzLmlzQWN0aXZlLCB0cnVlKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgcmVzLmpzb24oZW50aXR5Q29udGFjdHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBlbnRpdHkgY29udGFjdHM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIGNvbnRhY3RzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCBjb250YWN0cyBmb3IgYSByZXNpZGVuY2Ugd2l0aCBhY2Nlc3MgY29udHJvbFxuICBhcHAuZ2V0KCcvYXBpL3Jlc2lkZW5jZXMvOnJlc2lkZW5jZUlkL2NvbnRhY3RzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXNpZGVuY2VJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgYWNjZXNzIHRvIHRoaXMgcmVzaWRlbmNlXG4gICAgICBpZiAodXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgIGNvbnN0IGhhc0FjY2VzcyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgICAuaW5uZXJKb2luKGJ1aWxkaW5ncywgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ3MuaWQpKVxuICAgICAgICAgIC5pbm5lckpvaW4ob3JnYW5pemF0aW9ucywgZXEoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgICAud2hlcmUoYW5kKGVxKHJlc2lkZW5jZXMuaWQsIHJlc2lkZW5jZUlkKSwgZXEocmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgICBpZiAoaGFzQWNjZXNzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBHZXQgY29udGFjdHMgZm9yIHRoZSByZXNpZGVuY2VcbiAgICAgIGNvbnN0IHJlc2lkZW5jZUNvbnRhY3RzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgIC5mcm9tKGNvbnRhY3RzKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEoY29udGFjdHMuZW50aXR5LCAncmVzaWRlbmNlJyksXG4gICAgICAgICAgICBlcShjb250YWN0cy5lbnRpdHlJZCwgcmVzaWRlbmNlSWQpLFxuICAgICAgICAgICAgZXEoY29udGFjdHMuaXNBY3RpdmUsIHRydWUpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICByZXMuanNvbihyZXNpZGVuY2VDb250YWN0cyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIHJlc2lkZW5jZSBjb250YWN0czonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggcmVzaWRlbmNlIGNvbnRhY3RzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCBjb250YWN0cyB3aXRoIGZpbHRlcmluZyBieSBlbnRpdHkgYW5kIGVudGl0eUlkXG4gIGFwcC5nZXQoJy9hcGkvY29udGFjdHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVudGl0eSwgZW50aXR5SWQgfSA9IHJlcS5xdWVyeTtcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgaWYgKCFlbnRpdHkgfHwgIWVudGl0eUlkKSB7XG4gICAgICAgIC8vIFJldHVybiBlbXB0eSBhcnJheSBpbnN0ZWFkIG9mIGVycm9yIGZvciBtaXNzaW5nIHBhcmFtZXRlcnNcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKFtdKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgcGVybWlzc2lvbnMgZm9yIGJ1aWxkaW5nIGNvbnRhY3RzXG4gICAgICBpZiAoZW50aXR5ID09PSAnYnVpbGRpbmcnKSB7XG4gICAgICAgIC8vIEFueW9uZSBjYW4gdmlldyBidWlsZGluZyBjb250YWN0cyBmb3IgYnVpbGRpbmdzIHRoZXkgaGF2ZSBhY2Nlc3MgdG9cbiAgICAgICAgY29uc3QgaGFzQWNjZXNzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgLmlubmVySm9pbihvcmdhbml6YXRpb25zLCBlcShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ2FuaXphdGlvbnMuaWQpKVxuICAgICAgICAgIC53aGVyZShhbmQoZXEoYnVpbGRpbmdzLmlkLCBlbnRpdHlJZCksIGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgICBpZiAoaGFzQWNjZXNzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdCdWlsZGluZyBub3QgZm91bmQnIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBjb250YWN0cyBmb3IgdGhlIHNwZWNpZmllZCBlbnRpdHlcbiAgICAgIGNvbnN0IGVudGl0eUNvbnRhY3RzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgIC5mcm9tKGNvbnRhY3RzKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEoY29udGFjdHMuZW50aXR5LCBlbnRpdHkgYXMgJ2J1aWxkaW5nJyB8ICdyZXNpZGVuY2UnIHwgJ29yZ2FuaXphdGlvbicpLFxuICAgICAgICAgICAgZXEoY29udGFjdHMuZW50aXR5SWQsIGVudGl0eUlkKSxcbiAgICAgICAgICAgIGVxKGNvbnRhY3RzLmlzQWN0aXZlLCB0cnVlKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgcmVzLmpzb24oZW50aXR5Q29udGFjdHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBjb250YWN0czonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggY29udGFjdHMnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gQ3JlYXRlIGEgbmV3IGNvbnRhY3RcbiAgYXBwLnBvc3QoJy9hcGkvY29udGFjdHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG4gICAgICBjb25zdCB2YWxpZGF0ZWREYXRhID0gaW5zZXJ0Q29udGFjdFNjaGVtYS5wYXJzZShyZXEuYm9keSk7XG5cbiAgICAgIC8vIENoZWNrIHBlcm1pc3Npb25zIGJhc2VkIG9uIHVzZXIgcm9sZSBhbmQgZW50aXR5XG4gICAgICBjb25zdCB7IGVudGl0eSwgZW50aXR5SWQsIG5hbWUsIGVtYWlsLCBwaG9uZSwgY29udGFjdENhdGVnb3J5IH0gPSB2YWxpZGF0ZWREYXRhO1xuXG4gICAgICAvLyBPbmx5IG1hbmFnZXJzIGFuZCBhZG1pbnMgY2FuIGFkZCBidWlsZGluZyBjb250YWN0c1xuICAgICAgaWYgKGVudGl0eSA9PT0gJ2J1aWxkaW5nJyAmJiB1c2VyLnJvbGUgIT09ICdhZG1pbicgJiYgdXNlci5yb2xlICE9PSAnbWFuYWdlcicpIHtcbiAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgIC5zdGF0dXMoNDAzKVxuICAgICAgICAgIC5qc29uKHsgbWVzc2FnZTogJ09ubHkgbWFuYWdlcnMgYW5kIGFkbWlucyBjYW4gYWRkIGJ1aWxkaW5nIGNvbnRhY3RzJyB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IGVudGl0eSBleGlzdHMgYmFzZWQgb24gdHlwZVxuICAgICAgaWYgKGVudGl0eSA9PT0gJ3Jlc2lkZW5jZScpIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgICAuZnJvbShyZXNpZGVuY2VzKVxuICAgICAgICAgIC53aGVyZShlcShyZXNpZGVuY2VzLmlkLCBlbnRpdHlJZCkpXG4gICAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICAgIGlmIChyZXNpZGVuY2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZSBub3QgZm91bmQnIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGVudGl0eSA9PT0gJ2J1aWxkaW5nJykge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgICAgLmZyb20oYnVpbGRpbmdzKVxuICAgICAgICAgIC53aGVyZShlcShidWlsZGluZ3MuaWQsIGVudGl0eUlkKSlcbiAgICAgICAgICAubGltaXQoMSk7XG5cbiAgICAgICAgaWYgKGJ1aWxkaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdCdWlsZGluZyBub3QgZm91bmQnIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSB0aGUgY29udGFjdFxuICAgICAgY29uc3QgW25ld0NvbnRhY3RdID0gYXdhaXQgZGJcbiAgICAgICAgLmluc2VydChjb250YWN0cylcbiAgICAgICAgLnZhbHVlcyhbXG4gICAgICAgICAge1xuICAgICAgICAgICAgLi4udmFsaWRhdGVkRGF0YSxcbiAgICAgICAgICAgIGVudGl0eTogdmFsaWRhdGVkRGF0YS5lbnRpdHkgYXMgJ29yZ2FuaXphdGlvbicgfCAnYnVpbGRpbmcnIHwgJ3Jlc2lkZW5jZScsXG4gICAgICAgICAgICBjb250YWN0Q2F0ZWdvcnk6IHZhbGlkYXRlZERhdGEuY29udGFjdENhdGVnb3J5IGFzXG4gICAgICAgICAgICAgIHwgJ3Jlc2lkZW50J1xuICAgICAgICAgICAgICB8ICdtYW5hZ2VyJ1xuICAgICAgICAgICAgICB8ICd0ZW5hbnQnXG4gICAgICAgICAgICAgIHwgJ21haW50ZW5hbmNlJ1xuICAgICAgICAgICAgICB8ICdvdGhlcicsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSlcbiAgICAgICAgLnJldHVybmluZygpO1xuXG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihuZXdDb250YWN0KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgY3JlYXRpbmcgY29udGFjdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gY3JlYXRlIGNvbnRhY3QnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gVXBkYXRlIGEgY29udGFjdFxuICBhcHAucGF0Y2goJy9hcGkvY29udGFjdHMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcbiAgICAgIGNvbnN0IHVwZGF0ZXMgPSByZXEuYm9keTtcblxuICAgICAgLy8gR2V0IHRoZSBleGlzdGluZyBjb250YWN0XG4gICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGRiLnNlbGVjdCgpLmZyb20oY29udGFjdHMpLndoZXJlKGVxKGNvbnRhY3RzLmlkLCBpZCkpLmxpbWl0KDEpO1xuXG4gICAgICBpZiAoZXhpc3RpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdDb250YWN0IG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBleGlzdGluZ1swXTtcblxuICAgICAgLy8gQ2hlY2sgcGVybWlzc2lvbnMgLSBvbmx5IG1hbmFnZXJzIGFuZCBhZG1pbnMgY2FuIGVkaXQgY29udGFjdHNcbiAgICAgIGlmICh1c2VyLnJvbGUgIT09ICdhZG1pbicgJiYgdXNlci5yb2xlICE9PSAnbWFuYWdlcicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdGhlIGNvbnRhY3RcbiAgICAgIGNvbnN0IFt1cGRhdGVkQ29udGFjdF0gPSBhd2FpdCBkYlxuICAgICAgICAudXBkYXRlKGNvbnRhY3RzKVxuICAgICAgICAuc2V0KHtcbiAgICAgICAgICAuLi51cGRhdGVzLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLndoZXJlKGVxKGNvbnRhY3RzLmlkLCBpZCkpXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgICAgcmVzLmpzb24odXBkYXRlZENvbnRhY3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyBjb250YWN0OicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgY29udGFjdCcgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBEZWxldGUgYSBjb250YWN0XG4gIGFwcC5kZWxldGUoJy9hcGkvY29udGFjdHMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgLy8gR2V0IHRoZSBleGlzdGluZyBjb250YWN0XG4gICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IGRiLnNlbGVjdCgpLmZyb20oY29udGFjdHMpLndoZXJlKGVxKGNvbnRhY3RzLmlkLCBpZCkpLmxpbWl0KDEpO1xuXG4gICAgICBpZiAoZXhpc3RpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdDb250YWN0IG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBleGlzdGluZ1swXTtcblxuICAgICAgLy8gQ2hlY2sgcGVybWlzc2lvbnMgLSByZXNpZGVudHMsIG1hbmFnZXJzIGFuZCBhZG1pbnMgY2FuIGRlbGV0ZSBjb250YWN0c1xuICAgICAgaWYgKHVzZXIucm9sZSAhPT0gJ2FkbWluJyAmJiB1c2VyLnJvbGUgIT09ICdtYW5hZ2VyJyAmJiB1c2VyLnJvbGUgIT09ICdyZXNpZGVudCcpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBTb2Z0IGRlbGV0ZSB0aGUgY29udGFjdFxuICAgICAgYXdhaXQgZGJcbiAgICAgICAgLnVwZGF0ZShjb250YWN0cylcbiAgICAgICAgLnNldCh7XG4gICAgICAgICAgaXNBY3RpdmU6IGZhbHNlLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLndoZXJlKGVxKGNvbnRhY3RzLmlkLCBpZCkpO1xuXG4gICAgICByZXMuanNvbih7IG1lc3NhZ2U6ICdDb250YWN0IGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5JyB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZGVsZXRpbmcgY29udGFjdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZGVsZXRlIGNvbnRhY3QnIH0pO1xuICAgIH1cbiAgfSk7XG59XG4iXSwidmVyc2lvbiI6M30=