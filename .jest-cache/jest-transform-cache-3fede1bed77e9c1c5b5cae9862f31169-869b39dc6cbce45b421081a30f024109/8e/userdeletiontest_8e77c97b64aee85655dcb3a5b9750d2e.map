{"file":"/home/runner/workspace/tests/unit/auth/user-deletion.test.ts","mappings":"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","names":[],"sources":["/home/runner/workspace/tests/unit/auth/user-deletion.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport express from 'express';\nimport request from 'supertest';\nimport { registerRoutes } from '../../../server/routes';\nimport { db } from '../../../server/db';\nimport * as schema from '../../../shared/schema';\nimport { eq } from 'drizzle-orm';\nimport bcrypt from 'bcryptjs';\n\n/**\n * User Deletion Test Suite\n * \n * Tests complete user deletion functionality including:\n * - Complete record removal (not marking inactive)\n * - Authentication requirements\n * - Admin vs self-deletion permissions\n * - Related data cleanup\n * - Error handling for non-existent users\n */\n\n// Create test app\nconst createTestApp = () => {\n  const app = express();\n  app.use(express.json());\n  app.use(express.urlencoded({ extended: true }));\n  registerRoutes(app);\n  return app;\n};\n\ndescribe('User Deletion', () => {\n  let app: express.Application;\n  let testUser: any;\n  let adminUser: any;\n  let testOrganization: any;\n  let authCookie: string;\n\n  beforeEach(async () => {\n    app = createTestApp();\n    \n    // Clean up any existing test data\n    await db.delete(schema.users).where(eq(schema.users.email, 'test-deletion@example.com'));\n    await db.delete(schema.users).where(eq(schema.users.email, 'admin-test@example.com'));\n\n    // Create test organization\n    testOrganization = await db\n      .insert(schema.organizations)\n      .values({\n        name: 'Test Deletion Org',\n        type: 'syndicate',\n        address: '456 Delete St',\n        city: 'Quebec City',\n        province: 'QC',\n        postalCode: 'G1A 1A1',\n      })\n      .returning();\n\n    // Create admin user for testing admin deletion\n    adminUser = await db\n      .insert(schema.users)\n      .values({\n        username: 'admintest',\n        email: 'admin-test@example.com',\n        firstName: 'Admin',\n        lastName: 'Test',\n        password: await bcrypt.hash('AdminPass123!', 12),\n        role: 'admin',\n      })\n      .returning();\n\n    // Create test user to be deleted\n    testUser = await db\n      .insert(schema.users)\n      .values({\n        username: 'testdeletion',\n        email: 'test-deletion@example.com',\n        firstName: 'Delete',\n        lastName: 'Me',\n        password: await bcrypt.hash('DeletePass123!', 12),\n        role: 'manager',\n      })\n      .returning();\n\n    // Create user-organization relationship\n    await db.insert(schema.userOrganizations).values({\n      userId: testUser[0].id,\n      organizationId: testOrganization[0].id,\n    });\n\n    // Authenticate as admin for admin deletion tests\n    const loginResponse = await request(app)\n      .post('/api/auth/login')\n      .send({\n        email: 'admin-test@example.com',\n        password: 'AdminPass123!',\n      });\n\n    authCookie = loginResponse.headers['set-cookie'][0];\n  });\n\n  afterEach(async () => {\n    // Clean up test data\n    if (testUser?.[0]?.id) {\n      await db.delete(schema.userOrganizations).where(eq(schema.userOrganizations.userId, testUser[0].id));\n    }\n    await db.delete(schema.users).where(eq(schema.users.email, 'test-deletion@example.com'));\n    await db.delete(schema.users).where(eq(schema.users.email, 'admin-test@example.com'));\n    if (testOrganization?.[0]?.id) {\n      await db.delete(schema.organizations).where(eq(schema.organizations.id, testOrganization[0].id));\n    }\n  });\n\n  describe('Admin User Deletion', () => {\n    it('should completely remove user record from database', async () => {\n      const response = await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .set('Cookie', authCookie)\n        .expect(200);\n\n      expect(response.body).toMatchObject({\n        message: 'User account deleted successfully',\n        success: true,\n      });\n\n      // Verify user is completely removed from database\n      const deletedUser = await db\n        .select()\n        .from(schema.users)\n        .where(eq(schema.users.id, testUser[0].id))\n        .limit(1);\n\n      expect(deletedUser).toHaveLength(0);\n    });\n\n    it('should remove user-organization relationships', async () => {\n      await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .set('Cookie', authCookie)\n        .expect(200);\n\n      // Verify user-organization relationships are removed\n      const userOrgs = await db\n        .select()\n        .from(schema.userOrganizations)\n        .where(eq(schema.userOrganizations.userId, testUser[0].id));\n\n      expect(userOrgs).toHaveLength(0);\n    });\n\n    it('should require authentication for admin deletion', async () => {\n      const response = await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .expect(401);\n\n      expect(response.body).toMatchObject({\n        message: 'Authentication required',\n        code: 'AUTH_REQUIRED',\n      });\n    });\n\n    it('should return error for non-existent user deletion', async () => {\n      const response = await request(app)\n        .post('/api/users/non-existent-user-id/delete-account')\n        .set('Cookie', authCookie)\n        .expect(404);\n\n      expect(response.body).toMatchObject({\n        message: 'User not found',\n        code: 'USER_NOT_FOUND',\n      });\n    });\n\n    it('should require valid user ID parameter', async () => {\n      const response = await request(app)\n        .post('/api/users//delete-account')\n        .set('Cookie', authCookie)\n        .expect(400);\n\n      expect(response.body).toMatchObject({\n        message: 'User ID is required',\n        code: 'MISSING_USER_ID',\n      });\n    });\n  });\n\n  describe('Self Deletion', () => {\n    let userAuthCookie: string;\n\n    beforeEach(async () => {\n      // Login as the test user for self-deletion tests\n      const userLoginResponse = await request(app)\n        .post('/api/auth/login')\n        .send({\n          email: 'test-deletion@example.com',\n          password: 'DeletePass123!',\n        });\n\n      userAuthCookie = userLoginResponse.headers['set-cookie'][0];\n    });\n\n    it('should allow user to delete their own account', async () => {\n      const response = await request(app)\n        .post('/api/users/me/delete-account')\n        .set('Cookie', userAuthCookie)\n        .expect(200);\n\n      expect(response.body).toMatchObject({\n        message: 'Your account has been deleted successfully',\n        success: true,\n      });\n\n      // Verify user is completely removed\n      const deletedUser = await db\n        .select()\n        .from(schema.users)\n        .where(eq(schema.users.id, testUser[0].id))\n        .limit(1);\n\n      expect(deletedUser).toHaveLength(0);\n    });\n\n    it('should require authentication for self deletion', async () => {\n      const response = await request(app)\n        .post('/api/users/me/delete-account')\n        .expect(401);\n\n      expect(response.body).toMatchObject({\n        message: 'Authentication required',\n        code: 'AUTH_REQUIRED',\n      });\n    });\n\n    it('should clear session after self deletion', async () => {\n      await request(app)\n        .post('/api/users/me/delete-account')\n        .set('Cookie', userAuthCookie)\n        .expect(200);\n\n      // Try to access protected endpoint with same cookie\n      const protectedResponse = await request(app)\n        .get('/api/users/me/organizations')\n        .set('Cookie', userAuthCookie)\n        .expect(401);\n\n      expect(protectedResponse.body).toMatchObject({\n        message: 'Authentication required',\n      });\n    });\n  });\n\n  describe('Data Integrity', () => {\n    it('should maintain referential integrity after user deletion', async () => {\n      // Create some related data\n      const invitation = await db\n        .insert(schema.invitations)\n        .values({\n          email: 'related-invite@example.com',\n          token: 'related-token',\n          tokenHash: 'hash123',\n          role: 'tenant',\n          organizationId: testOrganization[0].id,\n          invitedByUserId: testUser[0].id,\n          expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n          status: 'pending',\n        })\n        .returning();\n\n      // Delete the user\n      await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .set('Cookie', authCookie)\n        .expect(200);\n\n      // Verify related invitation still exists but references are handled properly\n      const relatedInvitation = await db\n        .select()\n        .from(schema.invitations)\n        .where(eq(schema.invitations.id, invitation[0].id))\n        .limit(1);\n\n      expect(relatedInvitation).toHaveLength(1);\n      expect(relatedInvitation[0].invitedByUserId).toBe(testUser[0].id);\n\n      // Clean up\n      await db.delete(schema.invitations).where(eq(schema.invitations.id, invitation[0].id));\n    });\n  });\n\n  describe('Edge Cases', () => {\n    it('should handle deletion of user with no organization assignments', async () => {\n      // Remove organization assignments\n      await db\n        .delete(schema.userOrganizations)\n        .where(eq(schema.userOrganizations.userId, testUser[0].id));\n\n      const response = await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .set('Cookie', authCookie)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n\n      // Verify user is deleted\n      const deletedUser = await db\n        .select()\n        .from(schema.users)\n        .where(eq(schema.users.id, testUser[0].id))\n        .limit(1);\n\n      expect(deletedUser).toHaveLength(0);\n    });\n\n    it('should prevent deletion of the last admin user', async () => {\n      // Make test user the only admin\n      await db\n        .update(schema.users)\n        .set({ role: 'admin' })\n        .where(eq(schema.users.id, testUser[0].id));\n\n      // Delete the current admin user\n      await db.delete(schema.users).where(eq(schema.users.id, adminUser[0].id));\n\n      const response = await request(app)\n        .post(`/api/users/${testUser[0].id}/delete-account`)\n        .set('Cookie', authCookie)\n        .expect(403);\n\n      expect(response.body).toMatchObject({\n        message: 'Cannot delete the last admin user',\n        code: 'CANNOT_DELETE_LAST_ADMIN',\n      });\n    });\n  });\n});"],"version":3}