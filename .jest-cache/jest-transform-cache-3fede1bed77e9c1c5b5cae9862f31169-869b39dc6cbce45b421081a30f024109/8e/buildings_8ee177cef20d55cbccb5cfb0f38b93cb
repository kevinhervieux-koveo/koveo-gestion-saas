1ba265dae8bf79bbc516df85a51b9386
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerBuildingRoutes = registerBuildingRoutes;
const db_1 = require("../db");
const schema_1 = require("@shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const auth_1 = require("../auth");
const crypto_1 = __importDefault(require("crypto"));
/**
 * Handles creating or deleting residences when building totalUnits changes
 */
async function handleResidenceChanges(buildingId, organizationId, newTotalUnits, currentResidenceCount, totalFloors) {
    try {
        // Object storage hierarchy will be created automatically when documents are uploaded
        if (newTotalUnits > currentResidenceCount) {
            // Need to create more residences
            const residencesToCreate = newTotalUnits - currentResidenceCount;
            // Get existing residence numbers to avoid conflicts
            const existingResidences = await db_1.db
                .select({ unitNumber: schema_1.residences.unitNumber })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId));
            const existingUnitNumbers = new Set(existingResidences.map((r) => r.unitNumber));
            const floors = totalFloors || 1;
            const unitsPerFloor = Math.ceil(newTotalUnits / floors);
            const newResidences = [];
            let unitCounter = 1;
            for (let residenceIndex = 0; residenceIndex < residencesToCreate; residenceIndex++) {
                // Find next available unit number
                while (existingUnitNumbers.has(unitCounter.toString())) {
                    unitCounter++;
                }
                const floor = Math.ceil(unitCounter / unitsPerFloor);
                const unitNumber = unitCounter.toString();
                newResidences.push({
                    buildingId,
                    unitNumber,
                    floor: floor,
                    isActive: true,
                });
                existingUnitNumbers.add(unitNumber);
                unitCounter++;
            }
            // Create residences in batch
            if (newResidences.length > 0) {
                const createdResidences = await db_1.db.insert(schema_1.residences).values(newResidences).returning();
                // Create object storage hierarchy for each new residence
                for (const residence of createdResidences) {
                    try {
                        // TODO: Object storage service integration
                        // await objectStorageService.createResidenceHierarchy(
                        //   organizationId,
                        //   buildingId,
                        //   residence.id
                        // );
                    }
                    catch (storageError) {
                        console.error(`‚ö†Ô∏è Error creating storage hierarchy for residence ${residence.id}:`, storageError);
                        // Don't fail the whole operation for storage errors
                    }
                }
                console.log(`‚úÖ Created ${createdResidences.length} new residences for building ${buildingId}`);
            }
        }
        else if (newTotalUnits < currentResidenceCount) {
            // Need to delete some residences
            const residencesToDelete = currentResidenceCount - newTotalUnits;
            console.log(`üìâ Marking ${residencesToDelete} residences as inactive for building ${buildingId}`);
            // Get residences that can be safely deleted (no active user relationships)
            const deletableResidences = await db_1.db
                .select({ id: schema_1.residences.id, unitNumber: schema_1.residences.unitNumber })
                .from(schema_1.residences)
                .leftJoin(schema_1.userResidences, (0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true), (0, drizzle_orm_1.isNull)(schema_1.userResidences.id) // No active user relationships
            ))
                .orderBy((0, drizzle_orm_1.sql) `${schema_1.residences.unitNumber}::integer DESC`) // Delete highest unit numbers first
                .limit(residencesToDelete);
            if (deletableResidences.length > 0) {
                const residenceIdsToDelete = deletableResidences.map((r) => r.id);
                // Soft delete residences (mark as inactive)
                await db_1.db
                    .update(schema_1.residences)
                    .set({
                    isActive: false,
                    updatedAt: new Date(),
                })
                    .where((0, drizzle_orm_1.inArray)(schema_1.residences.id, residenceIdsToDelete));
                console.log(`‚úÖ Marked ${deletableResidences.length} residences as inactive for building ${buildingId}`);
                // Log which residences couldn't be deleted due to user relationships
                const protectedCount = residencesToDelete - deletableResidences.length;
                if (protectedCount > 0) {
                    console.log(`‚ö†Ô∏è Could not delete ${protectedCount} residences - they have active user relationships`);
                }
            }
            else {
            }
        }
        else {
            console.log(`‚úì No residence changes needed - building ${buildingId} already has ${currentResidenceCount} residences`);
        }
        // Don't throw the error to avoid breaking the building update
    }
    catch (error) {
        console.error('‚ùå Error updating residence count:', error);
        // Don't throw the error to avoid breaking the building update
    }
}
/**
 *
 * @param app
 */
/**
 * RegisterBuildingRoutes function.
 * @param app
 * @returns Function result.
 */
function registerBuildingRoutes(app) {
    /**
     * GET /api/buildings - Retrieves buildings based on user role and organization access.
     * Used by bills page and other components.
     *
     * Access Control Logic:
     * - Admin: Can see all buildings if they have global access, or buildings in their organizations
     * - Manager: Can see only buildings in their organizations
     * - Others: No access to buildings list.
     */
    app.get('/api/buildings', auth_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            if (!user) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Role-based access control for buildings
            if (![
                'admin',
                'manager',
                'demo_manager',
                'demo_tenant',
                'demo_resident',
                'tenant',
                'resident',
            ].includes(user.role)) {
                return res.status(403).json({
                    message: 'Access denied. Insufficient permissions.',
                    code: 'INSUFFICIENT_PERMISSIONS',
                });
            }
            console.log('üè¢ [Buildings API] User accessing buildings:', {
                id: user.id,
                role: user.role,
                organizations: user.organizations,
                canAccessAllOrganizations: user.canAccessAllOrganizations,
            });
            let buildingsQuery;
            // Admin users should always have access to all buildings, regardless of organization assignments
            if (user.role === 'admin') {
                console.log(`üè¢ [BUILDINGS DEBUG] Admin user detected - granting access to ALL buildings`);
                buildingsQuery = db_1.db
                    .select({
                    id: schema_1.buildings.id,
                    name: schema_1.buildings.name,
                    address: schema_1.buildings.address,
                    city: schema_1.buildings.city,
                    province: schema_1.buildings.province,
                    postalCode: schema_1.buildings.postalCode,
                    buildingType: schema_1.buildings.buildingType,
                    yearBuilt: schema_1.buildings.yearBuilt,
                    totalUnits: schema_1.buildings.totalUnits,
                    totalFloors: schema_1.buildings.totalFloors,
                    parkingSpaces: schema_1.buildings.parkingSpaces,
                    storageSpaces: schema_1.buildings.storageSpaces,
                    organizationId: schema_1.buildings.organizationId,
                    isActive: schema_1.buildings.isActive,
                    createdAt: schema_1.buildings.createdAt,
                    organizationName: schema_1.organizations.name,
                })
                    .from(schema_1.buildings)
                    .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true))
                    .orderBy(schema_1.organizations.name, schema_1.buildings.name);
            }
            else {
                // Managers and other roles: only buildings from their organizations
                console.log(`üîç [BUILDINGS DEBUG] Non-admin user (${user.role}) - checking organization access. User ${user.id} organizations:`, user.organizations);
                if (!user.organizations || user.organizations.length === 0) {
                    console.log(`üîç [BUILDINGS DEBUG] User ${user.id} has no organizations, checking residence access...`);
                    // For tenant/resident roles: Get buildings through their residences
                    if (['tenant', 'resident', 'demo_tenant', 'demo_resident'].includes(user.role)) {
                        const userResidencesList = await db_1.db
                            .select({
                            buildingId: schema_1.residences.buildingId,
                        })
                            .from(schema_1.userResidences)
                            .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
                        console.log(`üîç [BUILDINGS DEBUG] Found ${userResidencesList.length} residences for user ${user.id}`);
                        if (userResidencesList.length === 0) {
                            return res.json([]); // No residences = no buildings
                        }
                        const accessibleBuildingIds = [
                            ...new Set(userResidencesList.map((ur) => ur.buildingId)),
                        ];
                        console.log(`üîç [BUILDINGS DEBUG] Accessible building IDs:`, accessibleBuildingIds);
                        buildingsQuery = db_1.db
                            .select({
                            id: schema_1.buildings.id,
                            name: schema_1.buildings.name,
                            address: schema_1.buildings.address,
                            city: schema_1.buildings.city,
                            province: schema_1.buildings.province,
                            postalCode: schema_1.buildings.postalCode,
                            buildingType: schema_1.buildings.buildingType,
                            yearBuilt: schema_1.buildings.yearBuilt,
                            totalUnits: schema_1.buildings.totalUnits,
                            totalFloors: schema_1.buildings.totalFloors,
                            parkingSpaces: schema_1.buildings.parkingSpaces,
                            storageSpaces: schema_1.buildings.storageSpaces,
                            organizationId: schema_1.buildings.organizationId,
                            isActive: schema_1.buildings.isActive,
                            createdAt: schema_1.buildings.createdAt,
                            organizationName: schema_1.organizations.name,
                        })
                            .from(schema_1.buildings)
                            .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true), (0, drizzle_orm_1.inArray)(schema_1.buildings.id, accessibleBuildingIds)))
                            .orderBy(schema_1.organizations.name, schema_1.buildings.name);
                    }
                    else {
                        console.log(`üîç [BUILDINGS DEBUG] Manager/other role user ${user.id} has no organizations - returning empty result`);
                        return res.json([]); // No organizations = no buildings for managers/others
                    }
                }
                else {
                    // User has organizations - use organization-based access
                    buildingsQuery = db_1.db
                        .select({
                        id: schema_1.buildings.id,
                        name: schema_1.buildings.name,
                        address: schema_1.buildings.address,
                        city: schema_1.buildings.city,
                        province: schema_1.buildings.province,
                        postalCode: schema_1.buildings.postalCode,
                        buildingType: schema_1.buildings.buildingType,
                        yearBuilt: schema_1.buildings.yearBuilt,
                        totalUnits: schema_1.buildings.totalUnits,
                        totalFloors: schema_1.buildings.totalFloors,
                        parkingSpaces: schema_1.buildings.parkingSpaces,
                        storageSpaces: schema_1.buildings.storageSpaces,
                        organizationId: schema_1.buildings.organizationId,
                        isActive: schema_1.buildings.isActive,
                        createdAt: schema_1.buildings.createdAt,
                        organizationName: schema_1.organizations.name,
                    })
                        .from(schema_1.buildings)
                        .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                        .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true), (0, drizzle_orm_1.inArray)(schema_1.buildings.organizationId, user.organizations)))
                        .orderBy(schema_1.organizations.name, schema_1.buildings.name);
                }
            }
            const result = await buildingsQuery;
            res.json(result);
        }
        catch (error) {
            console.error('‚ùå Error fetching buildings:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to fetch buildings',
            });
        }
    });
    /**
     * GET /api/manager/buildings - Retrieves buildings based on user role and associations.
     *
     * Access Control Logic:
     * - Admin: Can see all buildings in their organization + buildings where they have residences
     * - Manager: Can see all buildings in their organization + buildings where they have residences
     * - Resident/Tenant: Can see only buildings where they have residences (role is not used, only residence links).
     */
    app.get('/api/manager/buildings', async (req, res) => {
        // Authentication check
        if (!req.session?.userId && !req.session?.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Use session data directly for now
            let currentUser = req.user || req.session?.user;
            // If we only have userId, we need to fetch the user
            if (!currentUser && req.session?.userId) {
                // Import storage from the auth route pattern
                const { storage } = await Promise.resolve().then(() => __importStar(require('../storage')));
                currentUser = await storage.getUser(req.session.userId);
            }
            if (!currentUser) {
                return res.status(401).json({
                    message: 'User not found',
                    code: 'USER_NOT_FOUND',
                });
            }
            console.log(`üìä Fetching buildings for user ${currentUser.id} with role ${currentUser.role}`);
            const accessibleBuildings = [];
            const buildingIds = new Set();
            // Check if user belongs to Koveo organization (special global access)
            const userOrgs = await db_1.db
                .select({
                organizationId: schema_1.userOrganizations.organizationId,
                organizationName: schema_1.organizations.name,
                canAccessAllOrganizations: schema_1.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema_1.userOrganizations)
                .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.userOrganizations.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userOrganizations.userId, currentUser.id), (0, drizzle_orm_1.eq)(schema_1.userOrganizations.isActive, true)));
            const hasGlobalAccess = currentUser.role === 'admin' ||
                userOrgs.some((org) => org.organizationName === 'Koveo' || org.canAccessAllOrganizations);
            if (hasGlobalAccess) {
                console.log(`üåü Admin user or user with global access detected - granting access to ALL buildings`);
                // Koveo users can see ALL buildings from ALL organizations
                const allBuildings = await db_1.db
                    .select({
                    id: schema_1.buildings.id,
                    name: schema_1.buildings.name,
                    address: schema_1.buildings.address,
                    city: schema_1.buildings.city,
                    province: schema_1.buildings.province,
                    postalCode: schema_1.buildings.postalCode,
                    buildingType: schema_1.buildings.buildingType,
                    yearBuilt: schema_1.buildings.yearBuilt,
                    totalUnits: schema_1.buildings.totalUnits,
                    totalFloors: schema_1.buildings.totalFloors,
                    parkingSpaces: schema_1.buildings.parkingSpaces,
                    storageSpaces: schema_1.buildings.storageSpaces,
                    amenities: schema_1.buildings.amenities,
                    managementCompany: schema_1.buildings.managementCompany,
                    organizationId: schema_1.buildings.organizationId,
                    isActive: schema_1.buildings.isActive,
                    createdAt: schema_1.buildings.createdAt,
                    updatedAt: schema_1.buildings.updatedAt,
                    organizationName: schema_1.organizations.name,
                    organizationType: schema_1.organizations.type,
                })
                    .from(schema_1.buildings)
                    .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true))
                    .orderBy(schema_1.organizations.name, schema_1.buildings.name);
                // Add all buildings with special Koveo access type
                allBuildings.forEach((building) => {
                    if (!buildingIds.has(building.id)) {
                        buildingIds.add(building.id);
                        accessibleBuildings.push({
                            ...building,
                            accessType: 'koveo-global', // Special access type for Koveo users
                        });
                    }
                });
            }
            else {
                // Regular users: For Admin and Manager roles: Get buildings from their organizations only
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    if (userOrgs.length > 0) {
                        const orgIds = userOrgs.map((uo) => uo.organizationId);
                        // Get all buildings from these organizations only
                        const orgBuildings = await db_1.db
                            .select({
                            id: schema_1.buildings.id,
                            name: schema_1.buildings.name,
                            address: schema_1.buildings.address,
                            city: schema_1.buildings.city,
                            province: schema_1.buildings.province,
                            postalCode: schema_1.buildings.postalCode,
                            buildingType: schema_1.buildings.buildingType,
                            yearBuilt: schema_1.buildings.yearBuilt,
                            totalUnits: schema_1.buildings.totalUnits,
                            totalFloors: schema_1.buildings.totalFloors,
                            parkingSpaces: schema_1.buildings.parkingSpaces,
                            storageSpaces: schema_1.buildings.storageSpaces,
                            amenities: schema_1.buildings.amenities,
                            managementCompany: schema_1.buildings.managementCompany,
                            organizationId: schema_1.buildings.organizationId,
                            isActive: schema_1.buildings.isActive,
                            createdAt: schema_1.buildings.createdAt,
                            updatedAt: schema_1.buildings.updatedAt,
                            organizationName: schema_1.organizations.name,
                            organizationType: schema_1.organizations.type,
                        })
                            .from(schema_1.buildings)
                            .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.buildings.organizationId, orgIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                        orgBuildings.forEach((building) => {
                            if (!buildingIds.has(building.id)) {
                                buildingIds.add(building.id);
                                accessibleBuildings.push({
                                    ...building,
                                    accessType: 'organization', // Track how user has access
                                });
                            }
                        });
                    }
                }
            }
            // For ALL roles (Admin, Manager, Resident, Tenant): Get buildings from their residences
            // This is the many-to-many relationship - users can have residences in different buildings
            const userResidenceRecords = await db_1.db
                .select({
                residenceId: schema_1.userResidences.residenceId,
                relationshipType: schema_1.userResidences.relationshipType,
            })
                .from(schema_1.userResidences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, currentUser.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            if (userResidenceRecords.length > 0) {
                const residenceIds = userResidenceRecords.map((ur) => ur.residenceId);
                // Get buildings through residences
                const residenceBuildings = await db_1.db
                    .select({
                    id: schema_1.buildings.id,
                    name: schema_1.buildings.name,
                    address: schema_1.buildings.address,
                    city: schema_1.buildings.city,
                    province: schema_1.buildings.province,
                    postalCode: schema_1.buildings.postalCode,
                    buildingType: schema_1.buildings.buildingType,
                    yearBuilt: schema_1.buildings.yearBuilt,
                    totalUnits: schema_1.buildings.totalUnits,
                    totalFloors: schema_1.buildings.totalFloors,
                    parkingSpaces: schema_1.buildings.parkingSpaces,
                    storageSpaces: schema_1.buildings.storageSpaces,
                    amenities: schema_1.buildings.amenities,
                    managementCompany: schema_1.buildings.managementCompany,
                    organizationId: schema_1.buildings.organizationId,
                    isActive: schema_1.buildings.isActive,
                    createdAt: schema_1.buildings.createdAt,
                    updatedAt: schema_1.buildings.updatedAt,
                    organizationName: schema_1.organizations.name,
                    organizationType: schema_1.organizations.type,
                    residenceId: schema_1.residences.id,
                    unitNumber: schema_1.residences.unitNumber,
                    floor: schema_1.residences.floor,
                })
                    .from(schema_1.residences)
                    .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                    .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.residences.id, residenceIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                // Add residence-based buildings (avoid duplicates)
                residenceBuildings.forEach((building) => {
                    if (!buildingIds.has(building.id)) {
                        buildingIds.add(building.id);
                        accessibleBuildings.push({
                            id: building.id,
                            name: building.name,
                            address: building.address,
                            city: building.city,
                            province: building.province,
                            postalCode: building.postalCode,
                            buildingType: building.buildingType,
                            yearBuilt: building.yearBuilt,
                            totalUnits: building.totalUnits,
                            totalFloors: building.totalFloors,
                            parkingSpaces: building.parkingSpaces,
                            storageSpaces: building.storageSpaces,
                            amenities: building.amenities,
                            managementCompany: building.managementCompany,
                            organizationId: building.organizationId,
                            isActive: building.isActive,
                            createdAt: building.createdAt,
                            updatedAt: building.updatedAt,
                            organizationName: building.organizationName,
                            organizationType: building.organizationType,
                            accessType: 'residence', // Track how user has access
                            userResidence: {
                                residenceId: building.residenceId,
                                unitNumber: building.unitNumber,
                                floor: building.floor,
                            },
                        });
                    }
                    else {
                        // Building already exists, but we might want to add residence info
                        const existingBuilding = accessibleBuildings.find((b) => b.id === building.id);
                        if (existingBuilding && !existingBuilding.userResidence) {
                            existingBuilding.userResidence = {
                                residenceId: building.residenceId,
                                unitNumber: building.unitNumber,
                                floor: building.floor,
                            };
                            // Update access type if this is from both organization and residence
                            if (existingBuilding.accessType === 'organization') {
                                existingBuilding.accessType = 'both';
                            }
                        }
                    }
                });
            }
            // Get statistics for each building
            const buildingsWithStats = await Promise.all(accessibleBuildings.map(async (building) => {
                // Get residence count
                const residenceCount = await db_1.db
                    .select({ count: (0, drizzle_orm_1.sql) `count(*)::int` })
                    .from(schema_1.residences)
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, building.id), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
                // Calculate occupancy rate
                const occupiedUnits = residenceCount[0]?.count || 0;
                const occupancyRate = building.totalUnits > 0 ? Math.round((occupiedUnits / building.totalUnits) * 100) : 0;
                return {
                    ...building,
                    statistics: {
                        totalUnits: building.totalUnits,
                        occupiedUnits,
                        occupancyRate,
                        vacantUnits: building.totalUnits - occupiedUnits,
                    },
                };
            }));
            // Sort buildings by name
            buildingsWithStats.sort((a, b) => a.name.localeCompare(b.name));
            console.log(`‚úÖ Found ${buildingsWithStats.length} accessible buildings for user ${currentUser.id}`);
            res.json({
                buildings: buildingsWithStats,
                meta: {
                    total: buildingsWithStats.length,
                    userRole: currentUser.role,
                    userId: currentUser.id,
                },
            });
        }
        catch (error) {
            console.error('‚ùå Error fetching manager buildings:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to fetch buildings',
            });
        }
    });
    /**
     * GET /api/manager/buildings/:id - Get a specific building with detailed information
     * Uses the same access control logic as the list endpoint.
     */
    app.get('/api/manager/buildings/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user;
            const buildingId = req.params.id;
            if (!currentUser) {
                return res.status(401).json({
                    _error: 'Unauthorized',
                    message: 'Authentication required',
                });
            }
            console.log(`üìä Fetching building ${buildingId} for user ${currentUser.id} with role ${currentUser.role}`);
            let hasAccess = false;
            let accessType = '';
            // Check if user belongs to Koveo organization (special global access)
            const userOrgs = await db_1.db
                .select({
                organizationId: schema_1.userOrganizations.organizationId,
                organizationName: schema_1.organizations.name,
                canAccessAllOrganizations: schema_1.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema_1.userOrganizations)
                .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.userOrganizations.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userOrganizations.userId, currentUser.id), (0, drizzle_orm_1.eq)(schema_1.userOrganizations.isActive, true)));
            const hasGlobalAccess = currentUser.role === 'admin' ||
                userOrgs.some((org) => org.organizationName === 'Koveo' || org.canAccessAllOrganizations);
            if (hasGlobalAccess) {
                hasAccess = true;
                accessType = 'global';
            }
            else {
                // Check organization-based access for Admin and Manager
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    if (userOrgs.length > 0) {
                        const orgIds = userOrgs.map((uo) => uo.organizationId);
                        // Check if building belongs to user's organizations
                        const buildingOrg = await db_1.db
                            .select({ id: schema_1.buildings.id })
                            .from(schema_1.buildings)
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId), (0, drizzle_orm_1.inArray)(schema_1.buildings.organizationId, orgIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                        if (buildingOrg.length > 0) {
                            hasAccess = true;
                            accessType = 'organization';
                        }
                    }
                }
            }
            // Check residence-based access for all roles
            if (!hasAccess) {
                const userResidenceAccess = await db_1.db
                    .select({ residenceId: schema_1.userResidences.residenceId })
                    .from(schema_1.userResidences)
                    .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, currentUser.id), (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
                if (userResidenceAccess.length > 0) {
                    hasAccess = true;
                    accessType = accessType ? 'both' : 'residence';
                }
            }
            if (!hasAccess) {
                return res.status(403).json({
                    _error: 'Forbidden',
                    message: 'You do not have access to this building',
                });
            }
            // Get building details
            const buildingData = await db_1.db
                .select({
                id: schema_1.buildings.id,
                name: schema_1.buildings.name,
                address: schema_1.buildings.address,
                city: schema_1.buildings.city,
                province: schema_1.buildings.province,
                postalCode: schema_1.buildings.postalCode,
                buildingType: schema_1.buildings.buildingType,
                yearBuilt: schema_1.buildings.yearBuilt,
                totalUnits: schema_1.buildings.totalUnits,
                totalFloors: schema_1.buildings.totalFloors,
                parkingSpaces: schema_1.buildings.parkingSpaces,
                storageSpaces: schema_1.buildings.storageSpaces,
                amenities: schema_1.buildings.amenities,
                managementCompany: schema_1.buildings.managementCompany,
                organizationId: schema_1.buildings.organizationId,
                isActive: schema_1.buildings.isActive,
                createdAt: schema_1.buildings.createdAt,
                updatedAt: schema_1.buildings.updatedAt,
                organizationName: schema_1.organizations.name,
                organizationType: schema_1.organizations.type,
                organizationAddress: schema_1.organizations.address,
                organizationCity: schema_1.organizations.city,
                organizationPhone: schema_1.organizations.phone,
                organizationEmail: schema_1.organizations.email,
            })
                .from(schema_1.buildings)
                .innerJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId));
            if (buildingData.length === 0) {
                return res.status(404).json({
                    _error: 'Not found',
                    message: 'Building not found',
                });
            }
            const building = buildingData[0];
            // Get all residences for this building
            const buildingResidences = await db_1.db
                .select({
                id: schema_1.residences.id,
                unitNumber: schema_1.residences.unitNumber,
                floor: schema_1.residences.floor,
                squareFootage: schema_1.residences.squareFootage,
                bedrooms: schema_1.residences.bedrooms,
                bathrooms: schema_1.residences.bathrooms,
                balcony: schema_1.residences.balcony,
                parkingSpaceNumbers: schema_1.residences.parkingSpaceNumbers,
                storageSpaceNumbers: schema_1.residences.storageSpaceNumbers,
                monthlyFees: schema_1.residences.monthlyFees,
                isActive: schema_1.residences.isActive,
            })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
            // Get user's residences in this building if any
            let userResidencesInBuilding = [];
            const userResidenceRecords = await db_1.db
                .select({
                residenceId: schema_1.userResidences.residenceId,
                relationshipType: schema_1.userResidences.relationshipType,
                startDate: schema_1.userResidences.startDate,
                endDate: schema_1.userResidences.endDate,
            })
                .from(schema_1.userResidences)
                .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, currentUser.id), (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            if (userResidenceRecords.length > 0) {
                userResidencesInBuilding = userResidenceRecords.map((ur) => {
                    const residence = buildingResidences.find((r) => r.id === ur.residenceId);
                    return {
                        ...residence,
                        relationshipType: ur.relationshipType,
                        startDate: ur.startDate,
                        endDate: ur.endDate,
                    };
                });
            }
            // Calculate statistics
            const occupiedUnits = buildingResidences.length;
            const occupancyRate = building.totalUnits > 0 ? Math.round((occupiedUnits / building.totalUnits) * 100) : 0;
            res.json({
                ...building,
                accessType,
                statistics: {
                    totalUnits: building.totalUnits,
                    occupiedUnits,
                    occupancyRate,
                    vacantUnits: building.totalUnits - occupiedUnits,
                    totalResidences: buildingResidences.length,
                },
                userResidences: userResidencesInBuilding,
                // Only include full residence list for managers/admins
                residences: currentUser.role === 'admin' || currentUser.role === 'manager'
                    ? buildingResidences
                    : undefined,
            });
        }
        catch (error) {
            console.error('‚ùå Error fetching building details:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to fetch building details',
            });
        }
    });
    /**
     * POST /api/admin/buildings - Create a new building (Admin only).
     */
    app.post('/api/admin/buildings', auth_1.requireAuth, async (req, res) => {
        try {
            // Check if user is admin
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    message: 'Admin access required',
                    code: 'ADMIN_REQUIRED',
                });
            }
            const buildingData = req.body;
            // Validate required fields
            if (!buildingData.name || !buildingData.organizationId) {
                return res.status(400).json({
                    _error: 'Validation error',
                    message: 'Building name and organization are required',
                });
            }
            // Create building with ID
            const buildingId = crypto_1.default.randomUUID();
            const newBuilding = await db_1.db
                .insert(schema_1.buildings)
                .values({
                id: buildingId,
                name: buildingData.name,
                address: buildingData.address || '',
                city: buildingData.city || '',
                province: buildingData.province || 'QC',
                postalCode: buildingData.postalCode || '',
                buildingType: buildingData.buildingType || 'condo',
                yearBuilt: buildingData.yearBuilt,
                totalUnits: buildingData.totalUnits || 0,
                totalFloors: buildingData.totalFloors,
                parkingSpaces: buildingData.parkingSpaces,
                storageSpaces: buildingData.storageSpaces,
                amenities: buildingData.amenities ? JSON.stringify(buildingData.amenities) : null,
                managementCompany: buildingData.managementCompany,
                organizationId: buildingData.organizationId,
                isActive: true,
                createdAt: new Date(),
                updatedAt: new Date(),
            })
                .returning();
            // Building storage hierarchy will be created automatically when documents are uploaded
            console.log('Building created - storage hierarchy will be created on first document upload');
            // Auto-generate residences if totalUnits is specified and <= 300
            if (buildingData.totalUnits &&
                buildingData.totalUnits > 0 &&
                buildingData.totalUnits <= 300) {
                try {
                    const totalUnits = buildingData.totalUnits;
                    const totalFloors = buildingData.totalFloors || 1;
                    const unitsPerFloor = Math.ceil(totalUnits / totalFloors);
                    const residencesToCreate = [];
                    for (let unit = 1; unit <= totalUnits; unit++) {
                        const floor = Math.ceil(unit / unitsPerFloor);
                        const unitOnFloor = ((unit - 1) % unitsPerFloor) + 1;
                        const unitNumber = `${floor}${unitOnFloor.toString().padStart(2, '0')}`;
                        residencesToCreate.push({
                            buildingId: buildingId,
                            unitNumber,
                            floor,
                            isActive: true,
                        });
                    }
                    // Insert all residences at once
                    const createdResidences = await db_1.db
                        .insert(schema_1.residences)
                        .values(residencesToCreate)
                        .returning();
                    console.log(`‚úÖ Auto-generated ${createdResidences.length} residences for building ${buildingId}`);
                    // TODO: Object storage service integration
                    // Create object storage hierarchy for each residence
                    // for (const residence of createdResidences) {
                    //   await objectStorageService.createResidenceHierarchy(
                    //     buildingData.organizationId,
                    //     buildingId,
                    //     residence.id
                    //   );
                    // }
                }
                catch (___residenceError) {
                    console.error('‚ö†Ô∏è Error auto-generating residences:', ___residenceError);
                    // Don't fail the building creation if residence generation fails
                }
            }
            res.status(201).json({
                message: 'Building created successfully',
                building: newBuilding[0],
            });
        }
        catch (error) {
            console.error('‚ùå Error creating building:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to create building',
            });
        }
    });
    /**
     * GET /api/buildings/:id/residences-for-deletion - Get list of residences that can be selected for deletion
     * Only admins can access this endpoint
     */
    app.get('/api/buildings/:id/residences-for-deletion', auth_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const buildingId = req.params.id;
            const maxToSelect = parseInt(req.query.maxToSelect) || 10;
            if (!user) {
                return res.status(401).json({ message: 'Authentication required' });
            }
            // Only admins can delete residences
            if (user.role !== 'admin') {
                return res.status(403).json({ message: 'Only admins can access residence deletion options' });
            }
            const { getResidencesForSelection } = await Promise.resolve().then(() => __importStar(require('./buildings/operations')));
            const residencesToSelect = await getResidencesForSelection(buildingId, maxToSelect);
            res.json({
                residences: residencesToSelect,
                message: `Found ${residencesToSelect.length} residences available for deletion`
            });
        }
        catch (error) {
            console.error('‚ùå Error fetching residences for deletion:', error);
            res.status(500).json({ message: 'Failed to fetch residences for deletion' });
        }
    });
    /**
     * DELETE /api/buildings/:id/residences - Delete selected residences
     * Only admins can delete residences
     */
    app.delete('/api/buildings/:id/residences', auth_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const buildingId = req.params.id;
            const { residenceIds } = req.body;
            if (!user) {
                return res.status(401).json({ message: 'Authentication required' });
            }
            // Only admins can delete residences
            if (user.role !== 'admin') {
                return res.status(403).json({ message: 'Only admins can delete residences' });
            }
            if (!Array.isArray(residenceIds) || residenceIds.length === 0) {
                return res.status(400).json({ message: 'residenceIds array is required' });
            }
            const { deleteSelectedResidences } = await Promise.resolve().then(() => __importStar(require('./buildings/operations')));
            const result = await deleteSelectedResidences(buildingId, residenceIds, user.role);
            res.json({
                success: true,
                deletedCount: result.deletedCount,
                documentsDeleted: result.documentsDeleted,
                message: `Successfully deleted ${result.deletedCount} residences and ${result.documentsDeleted} associated documents`
            });
        }
        catch (error) {
            console.error('‚ùå Error deleting residences:', error);
            res.status(500).json({ message: error.message || 'Failed to delete residences' });
        }
    });
    /**
     * PUT /api/admin/buildings/:id - Update a building (Admin and Manager).
     */
    app.put('/api/admin/buildings/:id', auth_1.requireAuth, async (req, res) => {
        try {
            // Check if user is admin or manager
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                return res.status(403).json({
                    message: 'Admin or Manager access required',
                    code: 'ADMIN_MANAGER_REQUIRED',
                });
            }
            const buildingId = req.params.id;
            const buildingData = req.body;
            // Validate required fields
            if (!buildingData.name || !buildingData.organizationId) {
                return res.status(400).json({
                    _error: 'Validation error',
                    message: 'Building name and organization are required',
                });
            }
            // Check if building exists
            const existingBuilding = await db_1.db
                .select()
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .limit(1);
            if (existingBuilding.length === 0) {
                return res.status(404).json({
                    _error: 'Not found',
                    message: 'Building not found',
                });
            }
            // Check current number of active residences
            const currentResidences = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)::int` })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
            const currentResidenceCount = currentResidences[0]?.count || 0;
            const newTotalUnits = buildingData.totalUnits || 0;
            const previousTotalUnits = existingBuilding[0].totalUnits || 0;
            console.log(`üîÑ Building ${buildingId}: ${previousTotalUnits} ‚Üí ${newTotalUnits} units (currently has ${currentResidenceCount} active residences)`);
            // Update building
            const updatedBuilding = await db_1.db
                .update(schema_1.buildings)
                .set({
                name: buildingData.name,
                address: buildingData.address || '',
                city: buildingData.city || '',
                province: buildingData.province || 'QC',
                postalCode: buildingData.postalCode || '',
                buildingType: buildingData.buildingType || 'condo',
                yearBuilt: buildingData.yearBuilt,
                totalUnits: newTotalUnits,
                totalFloors: buildingData.totalFloors,
                parkingSpaces: buildingData.parkingSpaces,
                storageSpaces: buildingData.storageSpaces,
                amenities: buildingData.amenities ? JSON.stringify(buildingData.amenities) : null,
                managementCompany: buildingData.managementCompany,
                organizationId: buildingData.organizationId,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .returning();
            // Handle residence count changes with new admin-only functionality
            if (newTotalUnits !== previousTotalUnits) {
                console.log(`üè† Building units changed from ${previousTotalUnits} to ${newTotalUnits}, adjusting residences...`);
                // Only admins can adjust residence counts
                if (currentUser.role !== 'admin') {
                    return res.status(403).json({
                        message: 'Only admins can increase or decrease building residence counts',
                        code: 'ADMIN_REQUIRED_FOR_RESIDENCE_CHANGES',
                    });
                }
                const { adjustResidenceCount } = await Promise.resolve().then(() => __importStar(require('./buildings/operations')));
                const adjustmentResult = await adjustResidenceCount(buildingId, existingBuilding[0].organizationId, newTotalUnits, previousTotalUnits, buildingData.totalFloors || existingBuilding[0].totalFloors || 1);
                // If residences need to be decreased, return the selection list to user
                if (adjustmentResult.action === 'decreased' && adjustmentResult.residencesToSelect) {
                    return res.json({
                        message: 'Building updated, but residence count needs to be reduced',
                        buildingUpdated: true,
                        needsResidenceSelection: true,
                        residencesToSelect: adjustmentResult.residencesToSelect,
                        instruction: `Please select ${previousTotalUnits - newTotalUnits} residences to delete from the list provided. Use DELETE /api/buildings/${buildingId}/residences with the selected residence IDs.`
                    });
                }
            }
            res.json({
                message: 'Building updated successfully',
                building: updatedBuilding[0],
            });
        }
        catch (error) {
            console.error('‚ùå Error updating building:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to update building',
            });
        }
    });
    /**
     * DELETE /api/admin/buildings/:id - Delete a building (Admin only).
     */
    app.delete('/api/admin/buildings/:id', auth_1.requireAuth, async (req, res) => {
        try {
            // Check if user is admin
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    message: 'Admin access required',
                    code: 'ADMIN_REQUIRED',
                });
            }
            const buildingId = req.params.id;
            // Check if building exists
            const existingBuilding = await db_1.db
                .select()
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .limit(1);
            if (existingBuilding.length === 0) {
                return res.status(404).json({
                    _error: 'Not found',
                    message: 'Building not found',
                });
            }
            // Soft delete by setting isActive to false
            await db_1.db
                .update(schema_1.buildings)
                .set({
                isActive: false,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId));
            // Object storage cleanup will be handled automatically
            console.log('Building deleted - storage cleanup will be handled automatically');
            res.json({
                message: 'Building deleted successfully',
            });
        }
        catch (error) {
            console.error('‚ùå Error deleting building:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to delete building',
            });
        }
    });
    /**
     * GET /api/admin/buildings/:id/deletion-impact - Get deletion impact analysis
     * Shows what will be deleted when removing a building.
     */
    app.get('/api/admin/buildings/:id/deletion-impact', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    message: 'Admin access required',
                    code: 'ADMIN_REQUIRED',
                });
            }
            const buildingId = req.params.id;
            // Check if building exists
            const building = await db_1.db
                .select({ id: schema_1.buildings.id, name: schema_1.buildings.name })
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)))
                .limit(1);
            if (building.length === 0) {
                return res.status(404).json({
                    _error: 'Not found',
                    message: 'Building not found',
                });
            }
            // Count residences in this building
            const residencesCount = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
            // Count documents associated with this building or its residences
            const documentsCount = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                .from(schema_1.documents)
                .where((0, drizzle_orm_1.or)((0, drizzle_orm_1.eq)(schema_1.documents.buildingId, buildingId), (0, drizzle_orm_1.sql) `${schema_1.documents.residenceId} IN (SELECT id FROM residences WHERE building_id = ${buildingId})`));
            // Count users who will become orphaned (only have relationships with residences in this building)
            const potentialOrphansCount = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(distinct ${schema_1.userResidences.userId})` })
                .from(schema_1.userResidences)
                .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true), (0, drizzle_orm_1.eq)(schema_1.users.isActive, true)));
            const impact = {
                building: building[0],
                residences: residencesCount[0]?.count || 0,
                documents: documentsCount[0]?.count || 0,
                potentialOrphanedUsers: potentialOrphansCount[0]?.count || 0,
            };
            res.json(impact);
        }
        catch (error) {
            console.error('‚ùå Error analyzing deletion impact:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to analyze deletion impact',
            });
        }
    });
    /**
     * DELETE /api/admin/buildings/:id/cascade - Cascade delete a building
     * Replaces the simple delete with cascading delete that removes residences and documents. Users are preserved for data safety.
     */
    app.delete('/api/admin/buildings/:id/cascade', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    message: 'Admin access required',
                    code: 'ADMIN_REQUIRED',
                });
            }
            const buildingId = req.params.id;
            // Check if building exists
            const building = await db_1.db
                .select({ id: schema_1.buildings.id, name: schema_1.buildings.name })
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)))
                .limit(1);
            if (building.length === 0) {
                return res.status(404).json({
                    _error: 'Not found',
                    message: 'Building not found',
                });
            }
            // Start transaction for cascading delete
            await db_1.db.transaction(async (tx) => {
                // 1. Get all residences in this building
                const buildingResidences = await tx
                    .select({ id: schema_1.residences.id })
                    .from(schema_1.residences)
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
                const residenceIds = buildingResidences.map((r) => r.id);
                if (residenceIds.length > 0) {
                    // 2. Delete documents associated with building or its residences
                    await tx
                        .delete(schema_1.documents)
                        .where((0, drizzle_orm_1.or)((0, drizzle_orm_1.eq)(schema_1.documents.buildingId, buildingId), (0, drizzle_orm_1.inArray)(schema_1.documents.residenceId, residenceIds)));
                    // 3. Soft delete user-residence relationships
                    await tx
                        .update(schema_1.userResidences)
                        .set({ isActive: false, updatedAt: new Date() })
                        .where((0, drizzle_orm_1.inArray)(schema_1.userResidences.residenceId, residenceIds));
                    // 4. DISABLED: User deletion prohibited for data safety
                    const orphanedUsers = await tx
                        .select({ id: schema_1.users.id })
                        .from(schema_1.users)
                        .leftJoin(schema_1.userOrganizations, (0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.users.id, schema_1.userOrganizations.userId), (0, drizzle_orm_1.eq)(schema_1.userOrganizations.isActive, true)))
                        .leftJoin(schema_1.userResidences, (0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.users.id, schema_1.userResidences.userId), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)))
                        .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.users.isActive, true), (0, drizzle_orm_1.isNull)(schema_1.userOrganizations.userId), (0, drizzle_orm_1.isNull)(schema_1.userResidences.userId)));
                    if (orphanedUsers.length > 0) {
                        const orphanedUserIds = orphanedUsers.map((u) => u.id);
                        await tx
                            .update(schema_1.users)
                            .set({ isActive: false, updatedAt: new Date() })
                            .where((0, drizzle_orm_1.inArray)(schema_1.users.id, orphanedUserIds));
                    }
                    // 5. Soft delete residences
                    await tx
                        .update(schema_1.residences)
                        .set({ isActive: false, updatedAt: new Date() })
                        .where((0, drizzle_orm_1.inArray)(schema_1.residences.id, residenceIds));
                }
                else {
                    // Still delete documents associated directly with the building
                    await tx.delete(schema_1.documents).where((0, drizzle_orm_1.eq)(schema_1.documents.buildingId, buildingId));
                }
                // 6. Finally, soft delete the building
                await tx
                    .update(schema_1.buildings)
                    .set({ isActive: false, updatedAt: new Date() })
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId));
            });
            // Clean up object storage hierarchy for the deleted building
            // Get organization ID from building before deletion
            const buildingOrg = await db_1.db
                .select({ organizationId: schema_1.buildings.organizationId })
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .limit(1);
            if (buildingOrg.length > 0) {
                // Object storage cleanup will be handled automatically
                console.log('Building deleted - storage cleanup will be handled automatically');
            }
            res.json({
                message: 'Building and related entities deleted successfully',
                deletedBuilding: building[0].name,
            });
        }
        catch (error) {
            console.error('‚ùå Error during cascade delete:', error);
            res.status(500).json({
                _error: 'Internal server error',
                message: 'Failed to delete building and related entities',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXBpL2J1aWxkaW5ncy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1LQSx3REFxeENDO0FBdjdDRCw4QkFBMkI7QUFDM0IsMkNBUXdCO0FBQ3hCLDZDQUF1RTtBQUN2RSxrQ0FBc0M7QUFDdEMsb0RBQTRCO0FBRTVCOztHQUVHO0FBQ0gsS0FBSyxVQUFVLHNCQUFzQixDQUNuQyxVQUFrQixFQUNsQixjQUFzQixFQUN0QixhQUFxQixFQUNyQixxQkFBNkIsRUFDN0IsV0FBb0I7SUFFcEIsSUFBSSxDQUFDO1FBQ0gscUZBQXFGO1FBRXJGLElBQUksYUFBYSxHQUFHLHFCQUFxQixFQUFFLENBQUM7WUFDMUMsaUNBQWlDO1lBQ2pDLE1BQU0sa0JBQWtCLEdBQUcsYUFBYSxHQUFHLHFCQUFxQixDQUFDO1lBRWpFLG9EQUFvRDtZQUNwRCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sT0FBRTtpQkFDaEMsTUFBTSxDQUFDLEVBQUUsVUFBVSxFQUFFLG1CQUFVLENBQUMsVUFBVSxFQUFFLENBQUM7aUJBQzdDLElBQUksQ0FBQyxtQkFBVSxDQUFDO2lCQUNoQixLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLG1CQUFVLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFFaEQsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBRWpGLE1BQU0sTUFBTSxHQUFHLFdBQVcsSUFBSSxDQUFDLENBQUM7WUFDaEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFFeEQsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztZQUVwQixLQUFLLElBQUksY0FBYyxHQUFHLENBQUMsRUFBRSxjQUFjLEdBQUcsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLEVBQUUsQ0FBQztnQkFDbkYsa0NBQWtDO2dCQUNsQyxPQUFPLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDO29CQUN2RCxXQUFXLEVBQUUsQ0FBQztnQkFDaEIsQ0FBQztnQkFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUMsQ0FBQztnQkFDckQsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUUxQyxhQUFhLENBQUMsSUFBSSxDQUFDO29CQUNqQixVQUFVO29CQUNWLFVBQVU7b0JBQ1YsS0FBSyxFQUFFLEtBQUs7b0JBQ1osUUFBUSxFQUFFLElBQUk7aUJBQ2YsQ0FBQyxDQUFDO2dCQUVILG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDcEMsV0FBVyxFQUFFLENBQUM7WUFDaEIsQ0FBQztZQUVELDZCQUE2QjtZQUM3QixJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQzdCLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxPQUFFLENBQUMsTUFBTSxDQUFDLG1CQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBRXhGLHlEQUF5RDtnQkFDekQsS0FBSyxNQUFNLFNBQVMsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO29CQUMxQyxJQUFJLENBQUM7d0JBQ0gsMkNBQTJDO3dCQUMzQyx1REFBdUQ7d0JBQ3ZELG9CQUFvQjt3QkFDcEIsZ0JBQWdCO3dCQUNoQixpQkFBaUI7d0JBQ2pCLEtBQUs7b0JBQ1AsQ0FBQztvQkFBQyxPQUFPLFlBQVksRUFBRSxDQUFDO3dCQUN0QixPQUFPLENBQUMsS0FBSyxDQUNYLHFEQUFxRCxTQUFTLENBQUMsRUFBRSxHQUFHLEVBQ3BFLFlBQVksQ0FDYixDQUFDO3dCQUNGLG9EQUFvRDtvQkFDdEQsQ0FBQztnQkFDSCxDQUFDO2dCQUVELE9BQU8sQ0FBQyxHQUFHLENBQ1QsYUFBYSxpQkFBaUIsQ0FBQyxNQUFNLGdDQUFnQyxVQUFVLEVBQUUsQ0FDbEYsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDO2FBQU0sSUFBSSxhQUFhLEdBQUcscUJBQXFCLEVBQUUsQ0FBQztZQUNqRCxpQ0FBaUM7WUFDakMsTUFBTSxrQkFBa0IsR0FBRyxxQkFBcUIsR0FBRyxhQUFhLENBQUM7WUFDakUsT0FBTyxDQUFDLEdBQUcsQ0FDVCxjQUFjLGtCQUFrQix3Q0FBd0MsVUFBVSxFQUFFLENBQ3JGLENBQUM7WUFFRiwyRUFBMkU7WUFDM0UsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLE9BQUU7aUJBQ2pDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxtQkFBVSxDQUFDLEVBQUUsRUFBRSxVQUFVLEVBQUUsbUJBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztpQkFDaEUsSUFBSSxDQUFDLG1CQUFVLENBQUM7aUJBQ2hCLFFBQVEsQ0FDUCx1QkFBYyxFQUNkLElBQUEsaUJBQUcsRUFBQyxJQUFBLGdCQUFFLEVBQUMsdUJBQWMsQ0FBQyxXQUFXLEVBQUUsbUJBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsdUJBQWMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FDdEY7aUJBQ0EsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQ3JDLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFDN0IsSUFBQSxvQkFBTSxFQUFDLHVCQUFjLENBQUMsRUFBRSxDQUFDLENBQUMsK0JBQStCO2FBQzFELENBQ0Y7aUJBQ0EsT0FBTyxDQUFDLElBQUEsaUJBQUcsRUFBQSxHQUFHLG1CQUFVLENBQUMsVUFBVSxnQkFBZ0IsQ0FBQyxDQUFDLG9DQUFvQztpQkFDekYsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFFN0IsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ25DLE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBRWxFLDRDQUE0QztnQkFDNUMsTUFBTSxPQUFFO3FCQUNMLE1BQU0sQ0FBQyxtQkFBVSxDQUFDO3FCQUNsQixHQUFHLENBQUM7b0JBQ0gsUUFBUSxFQUFFLEtBQUs7b0JBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUN0QixDQUFDO3FCQUNELEtBQUssQ0FBQyxJQUFBLHFCQUFPLEVBQUMsbUJBQVUsQ0FBQyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO2dCQUV2RCxPQUFPLENBQUMsR0FBRyxDQUNULFlBQVksbUJBQW1CLENBQUMsTUFBTSx3Q0FBd0MsVUFBVSxFQUFFLENBQzNGLENBQUM7Z0JBRUYscUVBQXFFO2dCQUNyRSxNQUFNLGNBQWMsR0FBRyxrQkFBa0IsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZFLElBQUksY0FBYyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUN2QixPQUFPLENBQUMsR0FBRyxDQUNULHVCQUF1QixjQUFjLG1EQUFtRCxDQUN6RixDQUFDO2dCQUNKLENBQUM7WUFDSCxDQUFDO2lCQUFNLENBQUM7WUFDUixDQUFDO1FBQ0gsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLENBQUMsR0FBRyxDQUNULDRDQUE0QyxVQUFVLGdCQUFnQixxQkFBcUIsYUFBYSxDQUN6RyxDQUFDO1FBQ0osQ0FBQztRQUNELDhEQUE4RDtJQUNoRSxDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFELDhEQUE4RDtJQUNoRSxDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7R0FHRztBQUNIOzs7O0dBSUc7QUFDSCxTQUFnQixzQkFBc0IsQ0FBQyxHQUFZO0lBQ2pEOzs7Ozs7OztPQVFHO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxrQkFBVyxFQUFFLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDN0QsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUV0QixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtvQkFDbEMsSUFBSSxFQUFFLGVBQWU7aUJBQ3RCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCwwQ0FBMEM7WUFDMUMsSUFDRSxDQUFDO2dCQUNDLE9BQU87Z0JBQ1AsU0FBUztnQkFDVCxjQUFjO2dCQUNkLGFBQWE7Z0JBQ2IsZUFBZTtnQkFDZixRQUFRO2dCQUNSLFVBQVU7YUFDWCxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQ3JCLENBQUM7Z0JBQ0QsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDBDQUEwQztvQkFDbkQsSUFBSSxFQUFFLDBCQUEwQjtpQkFDakMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsOENBQThDLEVBQUU7Z0JBQzFELEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDWCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhO2dCQUNqQyx5QkFBeUIsRUFBRSxJQUFJLENBQUMseUJBQXlCO2FBQzFELENBQUMsQ0FBQztZQUVILElBQUksY0FBYyxDQUFDO1lBRW5CLGlHQUFpRztZQUNqRyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQzFCLE9BQU8sQ0FBQyxHQUFHLENBQ1QsNkVBQTZFLENBQzlFLENBQUM7Z0JBQ0YsY0FBYyxHQUFHLE9BQUU7cUJBQ2hCLE1BQU0sQ0FBQztvQkFDTixFQUFFLEVBQUUsa0JBQVMsQ0FBQyxFQUFFO29CQUNoQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO29CQUNwQixPQUFPLEVBQUUsa0JBQVMsQ0FBQyxPQUFPO29CQUMxQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO29CQUNwQixRQUFRLEVBQUUsa0JBQVMsQ0FBQyxRQUFRO29CQUM1QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO29CQUNoQyxZQUFZLEVBQUUsa0JBQVMsQ0FBQyxZQUFZO29CQUNwQyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO29CQUM5QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO29CQUNoQyxXQUFXLEVBQUUsa0JBQVMsQ0FBQyxXQUFXO29CQUNsQyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO29CQUN0QyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO29CQUN0QyxjQUFjLEVBQUUsa0JBQVMsQ0FBQyxjQUFjO29CQUN4QyxRQUFRLEVBQUUsa0JBQVMsQ0FBQyxRQUFRO29CQUM1QixTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO29CQUM5QixnQkFBZ0IsRUFBRSxzQkFBYSxDQUFDLElBQUk7aUJBQ3JDLENBQUM7cUJBQ0QsSUFBSSxDQUFDLGtCQUFTLENBQUM7cUJBQ2YsU0FBUyxDQUFDLHNCQUFhLEVBQUUsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsY0FBYyxFQUFFLHNCQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7cUJBQ3hFLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7cUJBQ25DLE9BQU8sQ0FBQyxzQkFBYSxDQUFDLElBQUksRUFBRSxrQkFBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pELENBQUM7aUJBQU0sQ0FBQztnQkFDTixvRUFBb0U7Z0JBQ3BFLE9BQU8sQ0FBQyxHQUFHLENBQ1Qsd0NBQXdDLElBQUksQ0FBQyxJQUFJLDBDQUEwQyxJQUFJLENBQUMsRUFBRSxpQkFBaUIsRUFDbkgsSUFBSSxDQUFDLGFBQWEsQ0FDbkIsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFDM0QsT0FBTyxDQUFDLEdBQUcsQ0FDVCw2QkFBNkIsSUFBSSxDQUFDLEVBQUUscURBQXFELENBQzFGLENBQUM7b0JBRUYsb0VBQW9FO29CQUNwRSxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO3dCQUMvRSxNQUFNLGtCQUFrQixHQUFHLE1BQU0sT0FBRTs2QkFDaEMsTUFBTSxDQUFDOzRCQUNOLFVBQVUsRUFBRSxtQkFBVSxDQUFDLFVBQVU7eUJBQ2xDLENBQUM7NkJBQ0QsSUFBSSxDQUFDLHVCQUFjLENBQUM7NkJBQ3BCLFNBQVMsQ0FBQyxtQkFBVSxFQUFFLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFdBQVcsRUFBRSxtQkFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDOzZCQUNwRSxLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLHVCQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFFckYsT0FBTyxDQUFDLEdBQUcsQ0FDVCw4QkFBOEIsa0JBQWtCLENBQUMsTUFBTSx3QkFBd0IsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUN6RixDQUFDO3dCQUVGLElBQUksa0JBQWtCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDOzRCQUNwQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQywrQkFBK0I7d0JBQ3RELENBQUM7d0JBRUQsTUFBTSxxQkFBcUIsR0FBRzs0QkFDNUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQzt5QkFDMUQsQ0FBQzt3QkFDRixPQUFPLENBQUMsR0FBRyxDQUFDLCtDQUErQyxFQUFFLHFCQUFxQixDQUFDLENBQUM7d0JBRXBGLGNBQWMsR0FBRyxPQUFFOzZCQUNoQixNQUFNLENBQUM7NEJBQ04sRUFBRSxFQUFFLGtCQUFTLENBQUMsRUFBRTs0QkFDaEIsSUFBSSxFQUFFLGtCQUFTLENBQUMsSUFBSTs0QkFDcEIsT0FBTyxFQUFFLGtCQUFTLENBQUMsT0FBTzs0QkFDMUIsSUFBSSxFQUFFLGtCQUFTLENBQUMsSUFBSTs0QkFDcEIsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTs0QkFDNUIsVUFBVSxFQUFFLGtCQUFTLENBQUMsVUFBVTs0QkFDaEMsWUFBWSxFQUFFLGtCQUFTLENBQUMsWUFBWTs0QkFDcEMsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUzs0QkFDOUIsVUFBVSxFQUFFLGtCQUFTLENBQUMsVUFBVTs0QkFDaEMsV0FBVyxFQUFFLGtCQUFTLENBQUMsV0FBVzs0QkFDbEMsYUFBYSxFQUFFLGtCQUFTLENBQUMsYUFBYTs0QkFDdEMsYUFBYSxFQUFFLGtCQUFTLENBQUMsYUFBYTs0QkFDdEMsY0FBYyxFQUFFLGtCQUFTLENBQUMsY0FBYzs0QkFDeEMsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTs0QkFDNUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUzs0QkFDOUIsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJO3lCQUNyQyxDQUFDOzZCQUNELElBQUksQ0FBQyxrQkFBUyxDQUFDOzZCQUNmLFNBQVMsQ0FBQyxzQkFBYSxFQUFFLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLGNBQWMsRUFBRSxzQkFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDOzZCQUN4RSxLQUFLLENBQ0osSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFBLHFCQUFPLEVBQUMsa0JBQVMsQ0FBQyxFQUFFLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUNoRjs2QkFDQSxPQUFPLENBQUMsc0JBQWEsQ0FBQyxJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDakQsQ0FBQzt5QkFBTSxDQUFDO3dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0RBQWdELElBQUksQ0FBQyxFQUFFLGdEQUFnRCxDQUFDLENBQUM7d0JBQ3JILE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLHNEQUFzRDtvQkFDN0UsQ0FBQztnQkFDSCxDQUFDO3FCQUFNLENBQUM7b0JBQ04seURBQXlEO29CQUN6RCxjQUFjLEdBQUcsT0FBRTt5QkFDaEIsTUFBTSxDQUFDO3dCQUNOLEVBQUUsRUFBRSxrQkFBUyxDQUFDLEVBQUU7d0JBQ2hCLElBQUksRUFBRSxrQkFBUyxDQUFDLElBQUk7d0JBQ3BCLE9BQU8sRUFBRSxrQkFBUyxDQUFDLE9BQU87d0JBQzFCLElBQUksRUFBRSxrQkFBUyxDQUFDLElBQUk7d0JBQ3BCLFFBQVEsRUFBRSxrQkFBUyxDQUFDLFFBQVE7d0JBQzVCLFVBQVUsRUFBRSxrQkFBUyxDQUFDLFVBQVU7d0JBQ2hDLFlBQVksRUFBRSxrQkFBUyxDQUFDLFlBQVk7d0JBQ3BDLFNBQVMsRUFBRSxrQkFBUyxDQUFDLFNBQVM7d0JBQzlCLFVBQVUsRUFBRSxrQkFBUyxDQUFDLFVBQVU7d0JBQ2hDLFdBQVcsRUFBRSxrQkFBUyxDQUFDLFdBQVc7d0JBQ2xDLGFBQWEsRUFBRSxrQkFBUyxDQUFDLGFBQWE7d0JBQ3RDLGFBQWEsRUFBRSxrQkFBUyxDQUFDLGFBQWE7d0JBQ3RDLGNBQWMsRUFBRSxrQkFBUyxDQUFDLGNBQWM7d0JBQ3hDLFFBQVEsRUFBRSxrQkFBUyxDQUFDLFFBQVE7d0JBQzVCLFNBQVMsRUFBRSxrQkFBUyxDQUFDLFNBQVM7d0JBQzlCLGdCQUFnQixFQUFFLHNCQUFhLENBQUMsSUFBSTtxQkFDckMsQ0FBQzt5QkFDRCxJQUFJLENBQUMsa0JBQVMsQ0FBQzt5QkFDZixTQUFTLENBQUMsc0JBQWEsRUFBRSxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxjQUFjLEVBQUUsc0JBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQzt5QkFDeEUsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQzVCLElBQUEscUJBQU8sRUFBQyxrQkFBUyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQ3RELENBQ0Y7eUJBQ0EsT0FBTyxDQUFDLHNCQUFhLENBQUMsSUFBSSxFQUFFLGtCQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pELENBQUM7WUFDSCxDQUFDO1lBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxjQUFjLENBQUM7WUFFcEMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNuQixDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3BELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixNQUFNLEVBQUUsdUJBQXVCO2dCQUMvQixPQUFPLEVBQUUsMkJBQTJCO2FBQ3JDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVIOzs7Ozs7O09BT0c7SUFDSCxHQUFHLENBQUMsR0FBRyxDQUFDLHdCQUF3QixFQUFFLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDeEQsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7WUFDL0MsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtnQkFDbEMsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILG9DQUFvQztZQUNwQyxJQUFJLFdBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDO1lBRWhELG9EQUFvRDtZQUNwRCxJQUFJLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUM7Z0JBQ3hDLDZDQUE2QztnQkFDN0MsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLHdEQUFhLFlBQVksR0FBQyxDQUFDO2dCQUMvQyxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUQsQ0FBQztZQUVELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDakIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLGdCQUFnQjtvQkFDekIsSUFBSSxFQUFFLGdCQUFnQjtpQkFDdkIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQ1Qsa0NBQWtDLFdBQVcsQ0FBQyxFQUFFLGNBQWMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUNqRixDQUFDO1lBRUYsTUFBTSxtQkFBbUIsR0FBVSxFQUFFLENBQUM7WUFDdEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztZQUV0QyxzRUFBc0U7WUFDdEUsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFO2lCQUN0QixNQUFNLENBQUM7Z0JBQ04sY0FBYyxFQUFFLDBCQUFpQixDQUFDLGNBQWM7Z0JBQ2hELGdCQUFnQixFQUFFLHNCQUFhLENBQUMsSUFBSTtnQkFDcEMseUJBQXlCLEVBQUUsMEJBQWlCLENBQUMseUJBQXlCO2FBQ3ZFLENBQUM7aUJBQ0QsSUFBSSxDQUFDLDBCQUFpQixDQUFDO2lCQUN2QixTQUFTLENBQUMsc0JBQWEsRUFBRSxJQUFBLGdCQUFFLEVBQUMsMEJBQWlCLENBQUMsY0FBYyxFQUFFLHNCQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ2hGLEtBQUssQ0FDSixJQUFBLGlCQUFHLEVBQUMsSUFBQSxnQkFBRSxFQUFDLDBCQUFpQixDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLDBCQUFpQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUN4RixDQUFDO1lBRUosTUFBTSxlQUFlLEdBQ25CLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTztnQkFDNUIsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLGdCQUFnQixLQUFLLE9BQU8sSUFBSSxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUU1RixJQUFJLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixPQUFPLENBQUMsR0FBRyxDQUNULHNGQUFzRixDQUN2RixDQUFDO2dCQUVGLDJEQUEyRDtnQkFDM0QsTUFBTSxZQUFZLEdBQUcsTUFBTSxPQUFFO3FCQUMxQixNQUFNLENBQUM7b0JBQ04sRUFBRSxFQUFFLGtCQUFTLENBQUMsRUFBRTtvQkFDaEIsSUFBSSxFQUFFLGtCQUFTLENBQUMsSUFBSTtvQkFDcEIsT0FBTyxFQUFFLGtCQUFTLENBQUMsT0FBTztvQkFDMUIsSUFBSSxFQUFFLGtCQUFTLENBQUMsSUFBSTtvQkFDcEIsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTtvQkFDNUIsVUFBVSxFQUFFLGtCQUFTLENBQUMsVUFBVTtvQkFDaEMsWUFBWSxFQUFFLGtCQUFTLENBQUMsWUFBWTtvQkFDcEMsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztvQkFDOUIsVUFBVSxFQUFFLGtCQUFTLENBQUMsVUFBVTtvQkFDaEMsV0FBVyxFQUFFLGtCQUFTLENBQUMsV0FBVztvQkFDbEMsYUFBYSxFQUFFLGtCQUFTLENBQUMsYUFBYTtvQkFDdEMsYUFBYSxFQUFFLGtCQUFTLENBQUMsYUFBYTtvQkFDdEMsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztvQkFDOUIsaUJBQWlCLEVBQUUsa0JBQVMsQ0FBQyxpQkFBaUI7b0JBQzlDLGNBQWMsRUFBRSxrQkFBUyxDQUFDLGNBQWM7b0JBQ3hDLFFBQVEsRUFBRSxrQkFBUyxDQUFDLFFBQVE7b0JBQzVCLFNBQVMsRUFBRSxrQkFBUyxDQUFDLFNBQVM7b0JBQzlCLFNBQVMsRUFBRSxrQkFBUyxDQUFDLFNBQVM7b0JBQzlCLGdCQUFnQixFQUFFLHNCQUFhLENBQUMsSUFBSTtvQkFDcEMsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJO2lCQUNyQyxDQUFDO3FCQUNELElBQUksQ0FBQyxrQkFBUyxDQUFDO3FCQUNmLFNBQVMsQ0FBQyxzQkFBYSxFQUFFLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLGNBQWMsRUFBRSxzQkFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUN4RSxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUNuQyxPQUFPLENBQUMsc0JBQWEsQ0FBQyxJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFL0MsbURBQW1EO2dCQUNuRCxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO3dCQUNsQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDN0IsbUJBQW1CLENBQUMsSUFBSSxDQUFDOzRCQUN2QixHQUFHLFFBQVE7NEJBQ1gsVUFBVSxFQUFFLGNBQWMsRUFBRSxzQ0FBc0M7eUJBQ25FLENBQUMsQ0FBQztvQkFDTCxDQUFDO2dCQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLDBGQUEwRjtnQkFDMUYsSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO29CQUNuRSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7d0JBQ3hCLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQzt3QkFFdkQsa0RBQWtEO3dCQUNsRCxNQUFNLFlBQVksR0FBRyxNQUFNLE9BQUU7NkJBQzFCLE1BQU0sQ0FBQzs0QkFDTixFQUFFLEVBQUUsa0JBQVMsQ0FBQyxFQUFFOzRCQUNoQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJOzRCQUNwQixPQUFPLEVBQUUsa0JBQVMsQ0FBQyxPQUFPOzRCQUMxQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJOzRCQUNwQixRQUFRLEVBQUUsa0JBQVMsQ0FBQyxRQUFROzRCQUM1QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVOzRCQUNoQyxZQUFZLEVBQUUsa0JBQVMsQ0FBQyxZQUFZOzRCQUNwQyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTOzRCQUM5QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVOzRCQUNoQyxXQUFXLEVBQUUsa0JBQVMsQ0FBQyxXQUFXOzRCQUNsQyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhOzRCQUN0QyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhOzRCQUN0QyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTOzRCQUM5QixpQkFBaUIsRUFBRSxrQkFBUyxDQUFDLGlCQUFpQjs0QkFDOUMsY0FBYyxFQUFFLGtCQUFTLENBQUMsY0FBYzs0QkFDeEMsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTs0QkFDNUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUzs0QkFDOUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUzs0QkFDOUIsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJOzRCQUNwQyxnQkFBZ0IsRUFBRSxzQkFBYSxDQUFDLElBQUk7eUJBQ3JDLENBQUM7NkJBQ0QsSUFBSSxDQUFDLGtCQUFTLENBQUM7NkJBQ2YsU0FBUyxDQUFDLHNCQUFhLEVBQUUsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsY0FBYyxFQUFFLHNCQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7NkJBQ3hFLEtBQUssQ0FBQyxJQUFBLGlCQUFHLEVBQUMsSUFBQSxxQkFBTyxFQUFDLGtCQUFTLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxFQUFFLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBRXZGLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTs0QkFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7Z0NBQ2xDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dDQUM3QixtQkFBbUIsQ0FBQyxJQUFJLENBQUM7b0NBQ3ZCLEdBQUcsUUFBUTtvQ0FDWCxVQUFVLEVBQUUsY0FBYyxFQUFFLDRCQUE0QjtpQ0FDekQsQ0FBQyxDQUFDOzRCQUNMLENBQUM7d0JBQ0gsQ0FBQyxDQUFDLENBQUM7b0JBQ0wsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztZQUVELHdGQUF3RjtZQUN4RiwyRkFBMkY7WUFDM0YsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLE9BQUU7aUJBQ2xDLE1BQU0sQ0FBQztnQkFDTixXQUFXLEVBQUUsdUJBQWMsQ0FBQyxXQUFXO2dCQUN2QyxnQkFBZ0IsRUFBRSx1QkFBYyxDQUFDLGdCQUFnQjthQUNsRCxDQUFDO2lCQUNELElBQUksQ0FBQyx1QkFBYyxDQUFDO2lCQUNwQixLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLHVCQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUU1RixJQUFJLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDcEMsTUFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBRXRFLG1DQUFtQztnQkFDbkMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLE9BQUU7cUJBQ2hDLE1BQU0sQ0FBQztvQkFDTixFQUFFLEVBQUUsa0JBQVMsQ0FBQyxFQUFFO29CQUNoQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO29CQUNwQixPQUFPLEVBQUUsa0JBQVMsQ0FBQyxPQUFPO29CQUMxQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO29CQUNwQixRQUFRLEVBQUUsa0JBQVMsQ0FBQyxRQUFRO29CQUM1QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO29CQUNoQyxZQUFZLEVBQUUsa0JBQVMsQ0FBQyxZQUFZO29CQUNwQyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO29CQUM5QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO29CQUNoQyxXQUFXLEVBQUUsa0JBQVMsQ0FBQyxXQUFXO29CQUNsQyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO29CQUN0QyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO29CQUN0QyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO29CQUM5QixpQkFBaUIsRUFBRSxrQkFBUyxDQUFDLGlCQUFpQjtvQkFDOUMsY0FBYyxFQUFFLGtCQUFTLENBQUMsY0FBYztvQkFDeEMsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTtvQkFDNUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztvQkFDOUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztvQkFDOUIsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJO29CQUNwQyxnQkFBZ0IsRUFBRSxzQkFBYSxDQUFDLElBQUk7b0JBQ3BDLFdBQVcsRUFBRSxtQkFBVSxDQUFDLEVBQUU7b0JBQzFCLFVBQVUsRUFBRSxtQkFBVSxDQUFDLFVBQVU7b0JBQ2pDLEtBQUssRUFBRSxtQkFBVSxDQUFDLEtBQUs7aUJBQ3hCLENBQUM7cUJBQ0QsSUFBSSxDQUFDLG1CQUFVLENBQUM7cUJBQ2hCLFNBQVMsQ0FBQyxrQkFBUyxFQUFFLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFVBQVUsRUFBRSxrQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUM3RCxTQUFTLENBQUMsc0JBQWEsRUFBRSxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxjQUFjLEVBQUUsc0JBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztxQkFDeEUsS0FBSyxDQUFDLElBQUEsaUJBQUcsRUFBQyxJQUFBLHFCQUFPLEVBQUMsbUJBQVUsQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFbEYsbURBQW1EO2dCQUNuRCxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtvQkFDdEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7d0JBQ2xDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO3dCQUM3QixtQkFBbUIsQ0FBQyxJQUFJLENBQUM7NEJBQ3ZCLEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRTs0QkFDZixJQUFJLEVBQUUsUUFBUSxDQUFDLElBQUk7NEJBQ25CLE9BQU8sRUFBRSxRQUFRLENBQUMsT0FBTzs0QkFDekIsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJOzRCQUNuQixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7NEJBQzNCLFVBQVUsRUFBRSxRQUFRLENBQUMsVUFBVTs0QkFDL0IsWUFBWSxFQUFFLFFBQVEsQ0FBQyxZQUFZOzRCQUNuQyxTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVM7NEJBQzdCLFVBQVUsRUFBRSxRQUFRLENBQUMsVUFBVTs0QkFDL0IsV0FBVyxFQUFFLFFBQVEsQ0FBQyxXQUFXOzRCQUNqQyxhQUFhLEVBQUUsUUFBUSxDQUFDLGFBQWE7NEJBQ3JDLGFBQWEsRUFBRSxRQUFRLENBQUMsYUFBYTs0QkFDckMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTOzRCQUM3QixpQkFBaUIsRUFBRSxRQUFRLENBQUMsaUJBQWlCOzRCQUM3QyxjQUFjLEVBQUUsUUFBUSxDQUFDLGNBQWM7NEJBQ3ZDLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTs0QkFDM0IsU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTOzRCQUM3QixTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVM7NEJBQzdCLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxnQkFBZ0I7NEJBQzNDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxnQkFBZ0I7NEJBQzNDLFVBQVUsRUFBRSxXQUFXLEVBQUUsNEJBQTRCOzRCQUNyRCxhQUFhLEVBQUU7Z0NBQ2IsV0FBVyxFQUFFLFFBQVEsQ0FBQyxXQUFXO2dDQUNqQyxVQUFVLEVBQUUsUUFBUSxDQUFDLFVBQVU7Z0NBQy9CLEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSzs2QkFDdEI7eUJBQ0YsQ0FBQyxDQUFDO29CQUNMLENBQUM7eUJBQU0sQ0FBQzt3QkFDTixtRUFBbUU7d0JBQ25FLE1BQU0sZ0JBQWdCLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDL0UsSUFBSSxnQkFBZ0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxDQUFDOzRCQUN4RCxnQkFBZ0IsQ0FBQyxhQUFhLEdBQUc7Z0NBQy9CLFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVztnQ0FDakMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxVQUFVO2dDQUMvQixLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUs7NkJBQ3RCLENBQUM7NEJBQ0YscUVBQXFFOzRCQUNyRSxJQUFJLGdCQUFnQixDQUFDLFVBQVUsS0FBSyxjQUFjLEVBQUUsQ0FBQztnQ0FDbkQsZ0JBQWdCLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQzs0QkFDdkMsQ0FBQzt3QkFDSCxDQUFDO29CQUNILENBQUM7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsbUNBQW1DO1lBQ25DLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUMxQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFO2dCQUN6QyxzQkFBc0I7Z0JBQ3RCLE1BQU0sY0FBYyxHQUFHLE1BQU0sT0FBRTtxQkFDNUIsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUEsaUJBQUcsRUFBUSxlQUFlLEVBQUUsQ0FBQztxQkFDN0MsSUFBSSxDQUFDLG1CQUFVLENBQUM7cUJBQ2hCLEtBQUssQ0FBQyxJQUFBLGlCQUFHLEVBQUMsSUFBQSxnQkFBRSxFQUFDLG1CQUFVLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUVyRiwyQkFBMkI7Z0JBQzNCLE1BQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxDQUFDO2dCQUNwRCxNQUFNLGFBQWEsR0FDakIsUUFBUSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRXhGLE9BQU87b0JBQ0wsR0FBRyxRQUFRO29CQUNYLFVBQVUsRUFBRTt3QkFDVixVQUFVLEVBQUUsUUFBUSxDQUFDLFVBQVU7d0JBQy9CLGFBQWE7d0JBQ2IsYUFBYTt3QkFDYixXQUFXLEVBQUUsUUFBUSxDQUFDLFVBQVUsR0FBRyxhQUFhO3FCQUNqRDtpQkFDRixDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztZQUVGLHlCQUF5QjtZQUN6QixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUVoRSxPQUFPLENBQUMsR0FBRyxDQUNULFdBQVcsa0JBQWtCLENBQUMsTUFBTSxrQ0FBa0MsV0FBVyxDQUFDLEVBQUUsRUFBRSxDQUN2RixDQUFDO1lBRUYsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxTQUFTLEVBQUUsa0JBQWtCO2dCQUM3QixJQUFJLEVBQUU7b0JBQ0osS0FBSyxFQUFFLGtCQUFrQixDQUFDLE1BQU07b0JBQ2hDLFFBQVEsRUFBRSxXQUFXLENBQUMsSUFBSTtvQkFDMUIsTUFBTSxFQUFFLFdBQVcsQ0FBQyxFQUFFO2lCQUN2QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDNUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE1BQU0sRUFBRSx1QkFBdUI7Z0JBQy9CLE9BQU8sRUFBRSwyQkFBMkI7YUFDckMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUg7OztPQUdHO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSxrQkFBVyxFQUFFLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDekUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUM3QixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUVqQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE1BQU0sRUFBRSxjQUFjO29CQUN0QixPQUFPLEVBQUUseUJBQXlCO2lCQUNuQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FDVCx3QkFBd0IsVUFBVSxhQUFhLFdBQVcsQ0FBQyxFQUFFLGNBQWMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUM5RixDQUFDO1lBRUYsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBQ3RCLElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztZQUVwQixzRUFBc0U7WUFDdEUsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFO2lCQUN0QixNQUFNLENBQUM7Z0JBQ04sY0FBYyxFQUFFLDBCQUFpQixDQUFDLGNBQWM7Z0JBQ2hELGdCQUFnQixFQUFFLHNCQUFhLENBQUMsSUFBSTtnQkFDcEMseUJBQXlCLEVBQUUsMEJBQWlCLENBQUMseUJBQXlCO2FBQ3ZFLENBQUM7aUJBQ0QsSUFBSSxDQUFDLDBCQUFpQixDQUFDO2lCQUN2QixTQUFTLENBQUMsc0JBQWEsRUFBRSxJQUFBLGdCQUFFLEVBQUMsMEJBQWlCLENBQUMsY0FBYyxFQUFFLHNCQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ2hGLEtBQUssQ0FDSixJQUFBLGlCQUFHLEVBQUMsSUFBQSxnQkFBRSxFQUFDLDBCQUFpQixDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLDBCQUFpQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUN4RixDQUFDO1lBRUosTUFBTSxlQUFlLEdBQ25CLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTztnQkFDNUIsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLGdCQUFnQixLQUFLLE9BQU8sSUFBSSxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUU1RixJQUFJLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixTQUFTLEdBQUcsSUFBSSxDQUFDO2dCQUNqQixVQUFVLEdBQUcsUUFBUSxDQUFDO1lBQ3hCLENBQUM7aUJBQU0sQ0FBQztnQkFDTix3REFBd0Q7Z0JBQ3hELElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUUsQ0FBQztvQkFDbkUsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO3dCQUN4QixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUM7d0JBRXZELG9EQUFvRDt3QkFDcEQsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFFOzZCQUN6QixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsa0JBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQzs2QkFDNUIsSUFBSSxDQUFDLGtCQUFTLENBQUM7NkJBQ2YsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLEVBQzVCLElBQUEscUJBQU8sRUFBQyxrQkFBUyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsRUFDekMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUM3QixDQUNGLENBQUM7d0JBRUosSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDOzRCQUMzQixTQUFTLEdBQUcsSUFBSSxDQUFDOzRCQUNqQixVQUFVLEdBQUcsY0FBYyxDQUFDO3dCQUM5QixDQUFDO29CQUNILENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7WUFFRCw2Q0FBNkM7WUFDN0MsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNmLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxPQUFFO3FCQUNqQyxNQUFNLENBQUMsRUFBRSxXQUFXLEVBQUUsdUJBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztxQkFDbkQsSUFBSSxDQUFDLHVCQUFjLENBQUM7cUJBQ3BCLFNBQVMsQ0FBQyxtQkFBVSxFQUFFLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFdBQVcsRUFBRSxtQkFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUNwRSxLQUFLLENBQ0osSUFBQSxpQkFBRyxFQUNELElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQ3pDLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFDckMsSUFBQSxnQkFBRSxFQUFDLHVCQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUNsQyxDQUNGLENBQUM7Z0JBRUosSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQ25DLFNBQVMsR0FBRyxJQUFJLENBQUM7b0JBQ2pCLFVBQVUsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO2dCQUNqRCxDQUFDO1lBQ0gsQ0FBQztZQUVELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDZixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixNQUFNLEVBQUUsV0FBVztvQkFDbkIsT0FBTyxFQUFFLHlDQUF5QztpQkFDbkQsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELHVCQUF1QjtZQUN2QixNQUFNLFlBQVksR0FBRyxNQUFNLE9BQUU7aUJBQzFCLE1BQU0sQ0FBQztnQkFDTixFQUFFLEVBQUUsa0JBQVMsQ0FBQyxFQUFFO2dCQUNoQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO2dCQUNwQixPQUFPLEVBQUUsa0JBQVMsQ0FBQyxPQUFPO2dCQUMxQixJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJO2dCQUNwQixRQUFRLEVBQUUsa0JBQVMsQ0FBQyxRQUFRO2dCQUM1QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO2dCQUNoQyxZQUFZLEVBQUUsa0JBQVMsQ0FBQyxZQUFZO2dCQUNwQyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO2dCQUM5QixVQUFVLEVBQUUsa0JBQVMsQ0FBQyxVQUFVO2dCQUNoQyxXQUFXLEVBQUUsa0JBQVMsQ0FBQyxXQUFXO2dCQUNsQyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO2dCQUN0QyxhQUFhLEVBQUUsa0JBQVMsQ0FBQyxhQUFhO2dCQUN0QyxTQUFTLEVBQUUsa0JBQVMsQ0FBQyxTQUFTO2dCQUM5QixpQkFBaUIsRUFBRSxrQkFBUyxDQUFDLGlCQUFpQjtnQkFDOUMsY0FBYyxFQUFFLGtCQUFTLENBQUMsY0FBYztnQkFDeEMsUUFBUSxFQUFFLGtCQUFTLENBQUMsUUFBUTtnQkFDNUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztnQkFDOUIsU0FBUyxFQUFFLGtCQUFTLENBQUMsU0FBUztnQkFDOUIsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJO2dCQUNwQyxnQkFBZ0IsRUFBRSxzQkFBYSxDQUFDLElBQUk7Z0JBQ3BDLG1CQUFtQixFQUFFLHNCQUFhLENBQUMsT0FBTztnQkFDMUMsZ0JBQWdCLEVBQUUsc0JBQWEsQ0FBQyxJQUFJO2dCQUNwQyxpQkFBaUIsRUFBRSxzQkFBYSxDQUFDLEtBQUs7Z0JBQ3RDLGlCQUFpQixFQUFFLHNCQUFhLENBQUMsS0FBSzthQUN2QyxDQUFDO2lCQUNELElBQUksQ0FBQyxrQkFBUyxDQUFDO2lCQUNmLFNBQVMsQ0FBQyxzQkFBYSxFQUFFLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLGNBQWMsRUFBRSxzQkFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUN4RSxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFFdkMsSUFBSSxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUM5QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixNQUFNLEVBQUUsV0FBVztvQkFDbkIsT0FBTyxFQUFFLG9CQUFvQjtpQkFDOUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVqQyx1Q0FBdUM7WUFDdkMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLE9BQUU7aUJBQ2hDLE1BQU0sQ0FBQztnQkFDTixFQUFFLEVBQUUsbUJBQVUsQ0FBQyxFQUFFO2dCQUNqQixVQUFVLEVBQUUsbUJBQVUsQ0FBQyxVQUFVO2dCQUNqQyxLQUFLLEVBQUUsbUJBQVUsQ0FBQyxLQUFLO2dCQUN2QixhQUFhLEVBQUUsbUJBQVUsQ0FBQyxhQUFhO2dCQUN2QyxRQUFRLEVBQUUsbUJBQVUsQ0FBQyxRQUFRO2dCQUM3QixTQUFTLEVBQUUsbUJBQVUsQ0FBQyxTQUFTO2dCQUMvQixPQUFPLEVBQUUsbUJBQVUsQ0FBQyxPQUFPO2dCQUMzQixtQkFBbUIsRUFBRSxtQkFBVSxDQUFDLG1CQUFtQjtnQkFDbkQsbUJBQW1CLEVBQUUsbUJBQVUsQ0FBQyxtQkFBbUI7Z0JBQ25ELFdBQVcsRUFBRSxtQkFBVSxDQUFDLFdBQVc7Z0JBQ25DLFFBQVEsRUFBRSxtQkFBVSxDQUFDLFFBQVE7YUFDOUIsQ0FBQztpQkFDRCxJQUFJLENBQUMsbUJBQVUsQ0FBQztpQkFDaEIsS0FBSyxDQUFDLElBQUEsaUJBQUcsRUFBQyxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLG1CQUFVLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVwRixnREFBZ0Q7WUFDaEQsSUFBSSx3QkFBd0IsR0FBYyxFQUFFLENBQUM7WUFDN0MsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLE9BQUU7aUJBQ2xDLE1BQU0sQ0FBQztnQkFDTixXQUFXLEVBQUUsdUJBQWMsQ0FBQyxXQUFXO2dCQUN2QyxnQkFBZ0IsRUFBRSx1QkFBYyxDQUFDLGdCQUFnQjtnQkFDakQsU0FBUyxFQUFFLHVCQUFjLENBQUMsU0FBUztnQkFDbkMsT0FBTyxFQUFFLHVCQUFjLENBQUMsT0FBTzthQUNoQyxDQUFDO2lCQUNELElBQUksQ0FBQyx1QkFBYyxDQUFDO2lCQUNwQixTQUFTLENBQUMsbUJBQVUsRUFBRSxJQUFBLGdCQUFFLEVBQUMsdUJBQWMsQ0FBQyxXQUFXLEVBQUUsbUJBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDcEUsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsdUJBQWMsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLEVBQUUsQ0FBQyxFQUN6QyxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQ3JDLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FDbEMsQ0FDRixDQUFDO1lBRUosSUFBSSxvQkFBb0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3BDLHdCQUF3QixHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFO29CQUN6RCxNQUFNLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUMxRSxPQUFPO3dCQUNMLEdBQUcsU0FBUzt3QkFDWixnQkFBZ0IsRUFBRSxFQUFFLENBQUMsZ0JBQWdCO3dCQUNyQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVM7d0JBQ3ZCLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTztxQkFDcEIsQ0FBQztnQkFDSixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCx1QkFBdUI7WUFDdkIsTUFBTSxhQUFhLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDO1lBQ2hELE1BQU0sYUFBYSxHQUNqQixRQUFRLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUV4RixHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLEdBQUcsUUFBUTtnQkFDWCxVQUFVO2dCQUNWLFVBQVUsRUFBRTtvQkFDVixVQUFVLEVBQUUsUUFBUSxDQUFDLFVBQVU7b0JBQy9CLGFBQWE7b0JBQ2IsYUFBYTtvQkFDYixXQUFXLEVBQUUsUUFBUSxDQUFDLFVBQVUsR0FBRyxhQUFhO29CQUNoRCxlQUFlLEVBQUUsa0JBQWtCLENBQUMsTUFBTTtpQkFDM0M7Z0JBQ0QsY0FBYyxFQUFFLHdCQUF3QjtnQkFDeEMsdURBQXVEO2dCQUN2RCxVQUFVLEVBQ1IsV0FBVyxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxTQUFTO29CQUM1RCxDQUFDLENBQUMsa0JBQWtCO29CQUNwQixDQUFDLENBQUMsU0FBUzthQUNoQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzNELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixNQUFNLEVBQUUsdUJBQXVCO2dCQUMvQixPQUFPLEVBQUUsa0NBQWtDO2FBQzVDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVIOztPQUVHO0lBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxrQkFBVyxFQUFFLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDcEUsSUFBSSxDQUFDO1lBQ0gseUJBQXlCO1lBQ3pCLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUseUJBQXlCO29CQUNsQyxJQUFJLEVBQUUsZUFBZTtpQkFDdEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDakMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHVCQUF1QjtvQkFDaEMsSUFBSSxFQUFFLGdCQUFnQjtpQkFDdkIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFOUIsMkJBQTJCO1lBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUN2RCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixNQUFNLEVBQUUsa0JBQWtCO29CQUMxQixPQUFPLEVBQUUsNkNBQTZDO2lCQUN2RCxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsMEJBQTBCO1lBQzFCLE1BQU0sVUFBVSxHQUFHLGdCQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7WUFFdkMsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFFO2lCQUN6QixNQUFNLENBQUMsa0JBQVMsQ0FBQztpQkFDakIsTUFBTSxDQUFDO2dCQUNOLEVBQUUsRUFBRSxVQUFVO2dCQUNkLElBQUksRUFBRSxZQUFZLENBQUMsSUFBSTtnQkFDdkIsT0FBTyxFQUFFLFlBQVksQ0FBQyxPQUFPLElBQUksRUFBRTtnQkFDbkMsSUFBSSxFQUFFLFlBQVksQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDN0IsUUFBUSxFQUFFLFlBQVksQ0FBQyxRQUFRLElBQUksSUFBSTtnQkFDdkMsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVLElBQUksRUFBRTtnQkFDekMsWUFBWSxFQUFFLFlBQVksQ0FBQyxZQUFZLElBQUksT0FBTztnQkFDbEQsU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTO2dCQUNqQyxVQUFVLEVBQUUsWUFBWSxDQUFDLFVBQVUsSUFBSSxDQUFDO2dCQUN4QyxXQUFXLEVBQUUsWUFBWSxDQUFDLFdBQVc7Z0JBQ3JDLGFBQWEsRUFBRSxZQUFZLENBQUMsYUFBYTtnQkFDekMsYUFBYSxFQUFFLFlBQVksQ0FBQyxhQUFhO2dCQUN6QyxTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7Z0JBQ2pGLGlCQUFpQixFQUFFLFlBQVksQ0FBQyxpQkFBaUI7Z0JBQ2pELGNBQWMsRUFBRSxZQUFZLENBQUMsY0FBYztnQkFDM0MsUUFBUSxFQUFFLElBQUk7Z0JBQ2QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7YUFDdEIsQ0FBQztpQkFDRCxTQUFTLEVBQUUsQ0FBQztZQUdmLHVGQUF1RjtZQUN2RixPQUFPLENBQUMsR0FBRyxDQUFDLCtFQUErRSxDQUFDLENBQUM7WUFFN0YsaUVBQWlFO1lBQ2pFLElBQ0UsWUFBWSxDQUFDLFVBQVU7Z0JBQ3ZCLFlBQVksQ0FBQyxVQUFVLEdBQUcsQ0FBQztnQkFDM0IsWUFBWSxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQzlCLENBQUM7Z0JBQ0QsSUFBSSxDQUFDO29CQUNILE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7b0JBQzNDLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDO29CQUNsRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUMsQ0FBQztvQkFFMUQsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUM7b0JBQzlCLEtBQUssSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLElBQUksSUFBSSxVQUFVLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQzt3QkFDOUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsYUFBYSxDQUFDLENBQUM7d0JBQzlDLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUNyRCxNQUFNLFVBQVUsR0FBRyxHQUFHLEtBQUssR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO3dCQUV4RSxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7NEJBQ3RCLFVBQVUsRUFBRSxVQUFVOzRCQUN0QixVQUFVOzRCQUNWLEtBQUs7NEJBQ0wsUUFBUSxFQUFFLElBQUk7eUJBQ2YsQ0FBQyxDQUFDO29CQUNMLENBQUM7b0JBRUQsZ0NBQWdDO29CQUNoQyxNQUFNLGlCQUFpQixHQUFHLE1BQU0sT0FBRTt5QkFDL0IsTUFBTSxDQUFDLG1CQUFVLENBQUM7eUJBQ2xCLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQzt5QkFDMUIsU0FBUyxFQUFFLENBQUM7b0JBRWYsT0FBTyxDQUFDLEdBQUcsQ0FDVCxvQkFBb0IsaUJBQWlCLENBQUMsTUFBTSw0QkFBNEIsVUFBVSxFQUFFLENBQ3JGLENBQUM7b0JBRUYsMkNBQTJDO29CQUMzQyxxREFBcUQ7b0JBQ3JELCtDQUErQztvQkFDL0MseURBQXlEO29CQUN6RCxtQ0FBbUM7b0JBQ25DLGtCQUFrQjtvQkFDbEIsbUJBQW1CO29CQUNuQixPQUFPO29CQUNQLElBQUk7Z0JBQ04sQ0FBQztnQkFBQyxPQUFPLGlCQUFpQixFQUFFLENBQUM7b0JBQzNCLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0NBQXNDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztvQkFDekUsaUVBQWlFO2dCQUNuRSxDQUFDO1lBQ0gsQ0FBQztZQUVELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsK0JBQStCO2dCQUN4QyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQzthQUN6QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25ELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixNQUFNLEVBQUUsdUJBQXVCO2dCQUMvQixPQUFPLEVBQUUsMkJBQTJCO2FBQ3JDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVIOzs7T0FHRztJQUNILEdBQUcsQ0FBQyxHQUFHLENBQUMsNENBQTRDLEVBQUUsa0JBQVcsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ3pGLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDdEIsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDakMsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBcUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUVwRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxDQUFDLENBQUM7WUFDdEUsQ0FBQztZQUVELG9DQUFvQztZQUNwQyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQzFCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsbURBQW1ELEVBQUUsQ0FBQyxDQUFDO1lBQ2hHLENBQUM7WUFFRCxNQUFNLEVBQUUseUJBQXlCLEVBQUUsR0FBRyx3REFBYSx3QkFBd0IsR0FBQyxDQUFDO1lBQzdFLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSx5QkFBeUIsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFFcEYsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxVQUFVLEVBQUUsa0JBQWtCO2dCQUM5QixPQUFPLEVBQUUsU0FBUyxrQkFBa0IsQ0FBQyxNQUFNLG9DQUFvQzthQUNoRixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLDJDQUEyQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2xFLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLHlDQUF5QyxFQUFFLENBQUMsQ0FBQztRQUMvRSxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSDs7O09BR0c7SUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLCtCQUErQixFQUFFLGtCQUFXLEVBQUUsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUMvRSxJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3RCLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQ2pDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBRWxDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDVixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLENBQUMsQ0FBQztZQUN0RSxDQUFDO1lBRUQsb0NBQW9DO1lBQ3BDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDMUIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxDQUFDLENBQUM7WUFDaEYsQ0FBQztZQUVELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQzlELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDO1lBQzdFLENBQUM7WUFFRCxNQUFNLEVBQUUsd0JBQXdCLEVBQUUsR0FBRyx3REFBYSx3QkFBd0IsR0FBQyxDQUFDO1lBQzVFLE1BQU0sTUFBTSxHQUFHLE1BQU0sd0JBQXdCLENBQUMsVUFBVSxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFbkYsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsSUFBSTtnQkFDYixZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVk7Z0JBQ2pDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxnQkFBZ0I7Z0JBQ3pDLE9BQU8sRUFBRSx3QkFBd0IsTUFBTSxDQUFDLFlBQVksbUJBQW1CLE1BQU0sQ0FBQyxnQkFBZ0IsdUJBQXVCO2FBQ3RILENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDckQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sSUFBSSw2QkFBNkIsRUFBRSxDQUFDLENBQUM7UUFDcEYsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUg7O09BRUc7SUFDSCxHQUFHLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLGtCQUFXLEVBQUUsS0FBSyxFQUFFLEdBQVEsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN2RSxJQUFJLENBQUM7WUFDSCxvQ0FBb0M7WUFDcEMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztZQUNsRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSx5QkFBeUI7b0JBQ2xDLElBQUksRUFBRSxlQUFlO2lCQUN0QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUNuRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsa0NBQWtDO29CQUMzQyxJQUFJLEVBQUUsd0JBQXdCO2lCQUMvQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDakMsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUU5QiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3ZELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE1BQU0sRUFBRSxrQkFBa0I7b0JBQzFCLE9BQU8sRUFBRSw2Q0FBNkM7aUJBQ3ZELENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCwyQkFBMkI7WUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLE9BQUU7aUJBQzlCLE1BQU0sRUFBRTtpQkFDUixJQUFJLENBQUMsa0JBQVMsQ0FBQztpQkFDZixLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2lCQUNuQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFWixJQUFJLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDbEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsTUFBTSxFQUFFLFdBQVc7b0JBQ25CLE9BQU8sRUFBRSxvQkFBb0I7aUJBQzlCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCw0Q0FBNEM7WUFDNUMsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLE9BQUU7aUJBQy9CLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFBLGlCQUFHLEVBQVEsZUFBZSxFQUFFLENBQUM7aUJBQzdDLElBQUksQ0FBQyxtQkFBVSxDQUFDO2lCQUNoQixLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXBGLE1BQU0scUJBQXFCLEdBQUcsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQztZQUMvRCxNQUFNLGFBQWEsR0FBRyxZQUFZLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQztZQUNuRCxNQUFNLGtCQUFrQixHQUFHLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7WUFFL0QsT0FBTyxDQUFDLEdBQUcsQ0FDVCxlQUFlLFVBQVUsS0FBSyxrQkFBa0IsTUFBTSxhQUFhLHlCQUF5QixxQkFBcUIscUJBQXFCLENBQ3ZJLENBQUM7WUFFRixrQkFBa0I7WUFDbEIsTUFBTSxlQUFlLEdBQUcsTUFBTSxPQUFFO2lCQUM3QixNQUFNLENBQUMsa0JBQVMsQ0FBQztpQkFDakIsR0FBRyxDQUFDO2dCQUNILElBQUksRUFBRSxZQUFZLENBQUMsSUFBSTtnQkFDdkIsT0FBTyxFQUFFLFlBQVksQ0FBQyxPQUFPLElBQUksRUFBRTtnQkFDbkMsSUFBSSxFQUFFLFlBQVksQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDN0IsUUFBUSxFQUFFLFlBQVksQ0FBQyxRQUFRLElBQUksSUFBSTtnQkFDdkMsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVLElBQUksRUFBRTtnQkFDekMsWUFBWSxFQUFFLFlBQVksQ0FBQyxZQUFZLElBQUksT0FBTztnQkFDbEQsU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTO2dCQUNqQyxVQUFVLEVBQUUsYUFBYTtnQkFDekIsV0FBVyxFQUFFLFlBQVksQ0FBQyxXQUFXO2dCQUNyQyxhQUFhLEVBQUUsWUFBWSxDQUFDLGFBQWE7Z0JBQ3pDLGFBQWEsRUFBRSxZQUFZLENBQUMsYUFBYTtnQkFDekMsU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO2dCQUNqRixpQkFBaUIsRUFBRSxZQUFZLENBQUMsaUJBQWlCO2dCQUNqRCxjQUFjLEVBQUUsWUFBWSxDQUFDLGNBQWM7Z0JBQzNDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDO2lCQUNELEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7aUJBQ25DLFNBQVMsRUFBRSxDQUFDO1lBRWYsbUVBQW1FO1lBQ25FLElBQUksYUFBYSxLQUFLLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLGtCQUFrQixPQUFPLGFBQWEsMkJBQTJCLENBQUMsQ0FBQztnQkFFakgsMENBQTBDO2dCQUMxQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7b0JBQ2pDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxnRUFBZ0U7d0JBQ3pFLElBQUksRUFBRSxzQ0FBc0M7cUJBQzdDLENBQUMsQ0FBQztnQkFDTCxDQUFDO2dCQUVELE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLHdEQUFhLHdCQUF3QixHQUFDLENBQUM7Z0JBQ3hFLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxvQkFBb0IsQ0FDakQsVUFBVSxFQUNWLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsRUFDbEMsYUFBYSxFQUNiLGtCQUFrQixFQUNsQixZQUFZLENBQUMsV0FBVyxJQUFJLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQ2pFLENBQUM7Z0JBRUYsd0VBQXdFO2dCQUN4RSxJQUFJLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxXQUFXLElBQUksZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztvQkFDbkYsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO3dCQUNkLE9BQU8sRUFBRSwyREFBMkQ7d0JBQ3BFLGVBQWUsRUFBRSxJQUFJO3dCQUNyQix1QkFBdUIsRUFBRSxJQUFJO3dCQUM3QixrQkFBa0IsRUFBRSxnQkFBZ0IsQ0FBQyxrQkFBa0I7d0JBQ3ZELFdBQVcsRUFBRSxpQkFBaUIsa0JBQWtCLEdBQUcsYUFBYSwyRUFBMkUsVUFBVSw4Q0FBOEM7cUJBQ3BNLENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQztZQUdELEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLCtCQUErQjtnQkFDeEMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUM7YUFDN0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNuRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsT0FBTyxFQUFFLDJCQUEyQjthQUNyQyxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSDs7T0FFRztJQUNILEdBQUcsQ0FBQyxNQUFNLENBQUMsMEJBQTBCLEVBQUUsa0JBQVcsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQzFFLElBQUksQ0FBQztZQUNILHlCQUF5QjtZQUN6QixNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDO1lBQ2xELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDakIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtvQkFDbEMsSUFBSSxFQUFFLGVBQWU7aUJBQ3RCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFJLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQ2pDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSx1QkFBdUI7b0JBQ2hDLElBQUksRUFBRSxnQkFBZ0I7aUJBQ3ZCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUVqQywyQkFBMkI7WUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLE9BQUU7aUJBQzlCLE1BQU0sRUFBRTtpQkFDUixJQUFJLENBQUMsa0JBQVMsQ0FBQztpQkFDZixLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2lCQUNuQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFWixJQUFJLGdCQUFnQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDbEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsTUFBTSxFQUFFLFdBQVc7b0JBQ25CLE9BQU8sRUFBRSxvQkFBb0I7aUJBQzlCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCwyQ0FBMkM7WUFDM0MsTUFBTSxPQUFFO2lCQUNMLE1BQU0sQ0FBQyxrQkFBUyxDQUFDO2lCQUNqQixHQUFHLENBQUM7Z0JBQ0gsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3RCLENBQUM7aUJBQ0QsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBR3ZDLHVEQUF1RDtZQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGtFQUFrRSxDQUFDLENBQUM7WUFFaEYsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsK0JBQStCO2FBQ3pDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDbkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE1BQU0sRUFBRSx1QkFBdUI7Z0JBQy9CLE9BQU8sRUFBRSwyQkFBMkI7YUFDckMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUg7OztPQUdHO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsRUFBRSxrQkFBVyxFQUFFLEtBQUssRUFBRSxHQUFRLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDdkYsSUFBSSxDQUFDO1lBQ0gsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQztZQUNsRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSx5QkFBeUI7b0JBQ2xDLElBQUksRUFBRSxlQUFlO2lCQUN0QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO2dCQUNqQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsdUJBQXVCO29CQUNoQyxJQUFJLEVBQUUsZ0JBQWdCO2lCQUN2QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFFakMsMkJBQTJCO1lBQzNCLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBRTtpQkFDdEIsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLGtCQUFTLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxrQkFBUyxDQUFDLElBQUksRUFBRSxDQUFDO2lCQUNsRCxJQUFJLENBQUMsa0JBQVMsQ0FBQztpQkFDZixLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyxrQkFBUyxDQUFDLEVBQUUsRUFBRSxVQUFVLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztpQkFDdEUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRVosSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUMxQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixNQUFNLEVBQUUsV0FBVztvQkFDbkIsT0FBTyxFQUFFLG9CQUFvQjtpQkFDOUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELG9DQUFvQztZQUNwQyxNQUFNLGVBQWUsR0FBRyxNQUFNLE9BQUU7aUJBQzdCLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFBLGlCQUFHLEVBQVEsVUFBVSxFQUFFLENBQUM7aUJBQ3hDLElBQUksQ0FBQyxtQkFBVSxDQUFDO2lCQUNoQixLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXBGLGtFQUFrRTtZQUNsRSxNQUFNLGNBQWMsR0FBRyxNQUFNLE9BQUU7aUJBQzVCLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFBLGlCQUFHLEVBQVEsVUFBVSxFQUFFLENBQUM7aUJBQ3hDLElBQUksQ0FBQyxrQkFBUyxDQUFDO2lCQUNmLEtBQUssQ0FDSixJQUFBLGdCQUFFLEVBQ0EsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxFQUNwQyxJQUFBLGlCQUFHLEVBQUEsR0FBRyxrQkFBUyxDQUFDLFdBQVcsc0RBQXNELFVBQVUsR0FBRyxDQUMvRixDQUNGLENBQUM7WUFFSixrR0FBa0c7WUFDbEcsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLE9BQUU7aUJBQ25DLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFBLGlCQUFHLEVBQVEsa0JBQWtCLHVCQUFjLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztpQkFDeEUsSUFBSSxDQUFDLHVCQUFjLENBQUM7aUJBQ3BCLFNBQVMsQ0FBQyxtQkFBVSxFQUFFLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFdBQVcsRUFBRSxtQkFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNwRSxTQUFTLENBQUMsY0FBSyxFQUFFLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLE1BQU0sRUFBRSxjQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3JELEtBQUssQ0FDSixJQUFBLGlCQUFHLEVBQ0QsSUFBQSxnQkFBRSxFQUFDLG1CQUFVLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxFQUNyQyxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQzdCLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFDakMsSUFBQSxnQkFBRSxFQUFDLGNBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQ3pCLENBQ0YsQ0FBQztZQUVKLE1BQU0sTUFBTSxHQUFHO2dCQUNiLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixVQUFVLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDO2dCQUMxQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDO2dCQUN4QyxzQkFBc0IsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQzthQUM3RCxDQUFDO1lBRUYsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNuQixDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzNELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixNQUFNLEVBQUUsdUJBQXVCO2dCQUMvQixPQUFPLEVBQUUsbUNBQW1DO2FBQzdDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVIOzs7T0FHRztJQUNILEdBQUcsQ0FBQyxNQUFNLENBQUMsa0NBQWtDLEVBQUUsa0JBQVcsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ2xGLElBQUksQ0FBQztZQUNILE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUseUJBQXlCO29CQUNsQyxJQUFJLEVBQUUsZUFBZTtpQkFDdEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDakMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHVCQUF1QjtvQkFDaEMsSUFBSSxFQUFFLGdCQUFnQjtpQkFDdkIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBRWpDLDJCQUEyQjtZQUMzQixNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQUU7aUJBQ3RCLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxrQkFBUyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsa0JBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDbEQsSUFBSSxDQUFDLGtCQUFTLENBQUM7aUJBQ2YsS0FBSyxDQUFDLElBQUEsaUJBQUcsRUFBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLEVBQUUsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7aUJBQ3RFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVaLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDMUIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsTUFBTSxFQUFFLFdBQVc7b0JBQ25CLE9BQU8sRUFBRSxvQkFBb0I7aUJBQzlCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCx5Q0FBeUM7WUFDekMsTUFBTSxPQUFFLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRTtnQkFDaEMseUNBQXlDO2dCQUN6QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sRUFBRTtxQkFDaEMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLG1CQUFVLENBQUMsRUFBRSxFQUFFLENBQUM7cUJBQzdCLElBQUksQ0FBQyxtQkFBVSxDQUFDO3FCQUNoQixLQUFLLENBQUMsSUFBQSxpQkFBRyxFQUFDLElBQUEsZ0JBQUUsRUFBQyxtQkFBVSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsbUJBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUVwRixNQUFNLFlBQVksR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFekQsSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUM1QixpRUFBaUU7b0JBQ2pFLE1BQU0sRUFBRTt5QkFDTCxNQUFNLENBQUMsa0JBQVMsQ0FBQzt5QkFDakIsS0FBSyxDQUNKLElBQUEsZ0JBQUUsRUFBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQUUsSUFBQSxxQkFBTyxFQUFDLGtCQUFTLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQ3ZGLENBQUM7b0JBRUosOENBQThDO29CQUM5QyxNQUFNLEVBQUU7eUJBQ0wsTUFBTSxDQUFDLHVCQUFjLENBQUM7eUJBQ3RCLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQzt5QkFDL0MsS0FBSyxDQUFDLElBQUEscUJBQU8sRUFBQyx1QkFBYyxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO29CQUU1RCx3REFBd0Q7b0JBQ3hELE1BQU0sYUFBYSxHQUFHLE1BQU0sRUFBRTt5QkFDM0IsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLGNBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQzt5QkFDeEIsSUFBSSxDQUFDLGNBQUssQ0FBQzt5QkFDWCxRQUFRLENBQ1AsMEJBQWlCLEVBQ2pCLElBQUEsaUJBQUcsRUFBQyxJQUFBLGdCQUFFLEVBQUMsY0FBSyxDQUFDLEVBQUUsRUFBRSwwQkFBaUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFBLGdCQUFFLEVBQUMsMEJBQWlCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQ2xGO3lCQUNBLFFBQVEsQ0FDUCx1QkFBYyxFQUNkLElBQUEsaUJBQUcsRUFBQyxJQUFBLGdCQUFFLEVBQUMsY0FBSyxDQUFDLEVBQUUsRUFBRSx1QkFBYyxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUEsZ0JBQUUsRUFBQyx1QkFBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUM1RTt5QkFDQSxLQUFLLENBQ0osSUFBQSxpQkFBRyxFQUNELElBQUEsZ0JBQUUsRUFBQyxjQUFLLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUN4QixJQUFBLG9CQUFNLEVBQUMsMEJBQWlCLENBQUMsTUFBTSxDQUFDLEVBQ2hDLElBQUEsb0JBQU0sRUFBQyx1QkFBYyxDQUFDLE1BQU0sQ0FBQyxDQUM5QixDQUNGLENBQUM7b0JBRUosSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO3dCQUM3QixNQUFNLGVBQWUsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQ3ZELE1BQU0sRUFBRTs2QkFDTCxNQUFNLENBQUMsY0FBSyxDQUFDOzZCQUNiLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQzs2QkFDL0MsS0FBSyxDQUFDLElBQUEscUJBQU8sRUFBQyxjQUFLLENBQUMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQy9DLENBQUM7b0JBRUQsNEJBQTRCO29CQUM1QixNQUFNLEVBQUU7eUJBQ0wsTUFBTSxDQUFDLG1CQUFVLENBQUM7eUJBQ2xCLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQzt5QkFDL0MsS0FBSyxDQUFDLElBQUEscUJBQU8sRUFBQyxtQkFBVSxDQUFDLEVBQUUsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUNqRCxDQUFDO3FCQUFNLENBQUM7b0JBQ04sK0RBQStEO29CQUMvRCxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsa0JBQVMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDekUsQ0FBQztnQkFFRCx1Q0FBdUM7Z0JBQ3ZDLE1BQU0sRUFBRTtxQkFDTCxNQUFNLENBQUMsa0JBQVMsQ0FBQztxQkFDakIsR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsRUFBRSxDQUFDO3FCQUMvQyxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGtCQUFTLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDekMsQ0FBQyxDQUFDLENBQUM7WUFHSCw2REFBNkQ7WUFDN0Qsb0RBQW9EO1lBQ3BELE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBRTtpQkFDekIsTUFBTSxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7aUJBQ3BELElBQUksQ0FBQyxrQkFBUyxDQUFDO2lCQUNmLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsa0JBQVMsQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7aUJBQ25DLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVaLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDM0IsdURBQXVEO2dCQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGtFQUFrRSxDQUFDLENBQUM7WUFDbEYsQ0FBQztZQUVELEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLG9EQUFvRDtnQkFDN0QsZUFBZSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO2FBQ2xDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE1BQU0sRUFBRSx1QkFBdUI7Z0JBQy9CLE9BQU8sRUFBRSxnREFBZ0Q7YUFDMUQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hcGkvYnVpbGRpbmdzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV4cHJlc3MgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGRiIH0gZnJvbSAnLi4vZGInO1xuaW1wb3J0IHtcbiAgYnVpbGRpbmdzLFxuICBvcmdhbml6YXRpb25zLFxuICByZXNpZGVuY2VzLFxuICB1c2VyUmVzaWRlbmNlcyxcbiAgdXNlck9yZ2FuaXphdGlvbnMsXG4gIHVzZXJzLFxuICBkb2N1bWVudHMsXG59IGZyb20gJ0BzaGFyZWQvc2NoZW1hJztcbmltcG9ydCB7IGVxLCBhbmQsIG9yLCBpbkFycmF5LCBzcWwsIGlzTnVsbCwgY291bnQgfSBmcm9tICdkcml6emxlLW9ybSc7XG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG4vKipcbiAqIEhhbmRsZXMgY3JlYXRpbmcgb3IgZGVsZXRpbmcgcmVzaWRlbmNlcyB3aGVuIGJ1aWxkaW5nIHRvdGFsVW5pdHMgY2hhbmdlc1xuICovXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVSZXNpZGVuY2VDaGFuZ2VzKFxuICBidWlsZGluZ0lkOiBzdHJpbmcsXG4gIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcsXG4gIG5ld1RvdGFsVW5pdHM6IG51bWJlcixcbiAgY3VycmVudFJlc2lkZW5jZUNvdW50OiBudW1iZXIsXG4gIHRvdGFsRmxvb3JzPzogbnVtYmVyXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICAvLyBPYmplY3Qgc3RvcmFnZSBoaWVyYXJjaHkgd2lsbCBiZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbiBkb2N1bWVudHMgYXJlIHVwbG9hZGVkXG5cbiAgICBpZiAobmV3VG90YWxVbml0cyA+IGN1cnJlbnRSZXNpZGVuY2VDb3VudCkge1xuICAgICAgLy8gTmVlZCB0byBjcmVhdGUgbW9yZSByZXNpZGVuY2VzXG4gICAgICBjb25zdCByZXNpZGVuY2VzVG9DcmVhdGUgPSBuZXdUb3RhbFVuaXRzIC0gY3VycmVudFJlc2lkZW5jZUNvdW50O1xuXG4gICAgICAvLyBHZXQgZXhpc3RpbmcgcmVzaWRlbmNlIG51bWJlcnMgdG8gYXZvaWQgY29uZmxpY3RzXG4gICAgICBjb25zdCBleGlzdGluZ1Jlc2lkZW5jZXMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHsgdW5pdE51bWJlcjogcmVzaWRlbmNlcy51bml0TnVtYmVyIH0pXG4gICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgIC53aGVyZShlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5nSWQpKTtcblxuICAgICAgY29uc3QgZXhpc3RpbmdVbml0TnVtYmVycyA9IG5ldyBTZXQoZXhpc3RpbmdSZXNpZGVuY2VzLm1hcCgocikgPT4gci51bml0TnVtYmVyKSk7XG5cbiAgICAgIGNvbnN0IGZsb29ycyA9IHRvdGFsRmxvb3JzIHx8IDE7XG4gICAgICBjb25zdCB1bml0c1BlckZsb29yID0gTWF0aC5jZWlsKG5ld1RvdGFsVW5pdHMgLyBmbG9vcnMpO1xuXG4gICAgICBjb25zdCBuZXdSZXNpZGVuY2VzID0gW107XG4gICAgICBsZXQgdW5pdENvdW50ZXIgPSAxO1xuXG4gICAgICBmb3IgKGxldCByZXNpZGVuY2VJbmRleCA9IDA7IHJlc2lkZW5jZUluZGV4IDwgcmVzaWRlbmNlc1RvQ3JlYXRlOyByZXNpZGVuY2VJbmRleCsrKSB7XG4gICAgICAgIC8vIEZpbmQgbmV4dCBhdmFpbGFibGUgdW5pdCBudW1iZXJcbiAgICAgICAgd2hpbGUgKGV4aXN0aW5nVW5pdE51bWJlcnMuaGFzKHVuaXRDb3VudGVyLnRvU3RyaW5nKCkpKSB7XG4gICAgICAgICAgdW5pdENvdW50ZXIrKztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZsb29yID0gTWF0aC5jZWlsKHVuaXRDb3VudGVyIC8gdW5pdHNQZXJGbG9vcik7XG4gICAgICAgIGNvbnN0IHVuaXROdW1iZXIgPSB1bml0Q291bnRlci50b1N0cmluZygpO1xuXG4gICAgICAgIG5ld1Jlc2lkZW5jZXMucHVzaCh7XG4gICAgICAgICAgYnVpbGRpbmdJZCxcbiAgICAgICAgICB1bml0TnVtYmVyLFxuICAgICAgICAgIGZsb29yOiBmbG9vcixcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZXhpc3RpbmdVbml0TnVtYmVycy5hZGQodW5pdE51bWJlcik7XG4gICAgICAgIHVuaXRDb3VudGVyKys7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSByZXNpZGVuY2VzIGluIGJhdGNoXG4gICAgICBpZiAobmV3UmVzaWRlbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGNyZWF0ZWRSZXNpZGVuY2VzID0gYXdhaXQgZGIuaW5zZXJ0KHJlc2lkZW5jZXMpLnZhbHVlcyhuZXdSZXNpZGVuY2VzKS5yZXR1cm5pbmcoKTtcblxuICAgICAgICAvLyBDcmVhdGUgb2JqZWN0IHN0b3JhZ2UgaGllcmFyY2h5IGZvciBlYWNoIG5ldyByZXNpZGVuY2VcbiAgICAgICAgZm9yIChjb25zdCByZXNpZGVuY2Ugb2YgY3JlYXRlZFJlc2lkZW5jZXMpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gVE9ETzogT2JqZWN0IHN0b3JhZ2Ugc2VydmljZSBpbnRlZ3JhdGlvblxuICAgICAgICAgICAgLy8gYXdhaXQgb2JqZWN0U3RvcmFnZVNlcnZpY2UuY3JlYXRlUmVzaWRlbmNlSGllcmFyY2h5KFxuICAgICAgICAgICAgLy8gICBvcmdhbml6YXRpb25JZCxcbiAgICAgICAgICAgIC8vICAgYnVpbGRpbmdJZCxcbiAgICAgICAgICAgIC8vICAgcmVzaWRlbmNlLmlkXG4gICAgICAgICAgICAvLyApO1xuICAgICAgICAgIH0gY2F0Y2ggKHN0b3JhZ2VFcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAgICAgYOKaoO+4jyBFcnJvciBjcmVhdGluZyBzdG9yYWdlIGhpZXJhcmNoeSBmb3IgcmVzaWRlbmNlICR7cmVzaWRlbmNlLmlkfTpgLFxuICAgICAgICAgICAgICBzdG9yYWdlRXJyb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICAvLyBEb24ndCBmYWlsIHRoZSB3aG9sZSBvcGVyYXRpb24gZm9yIHN0b3JhZ2UgZXJyb3JzXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYOKchSBDcmVhdGVkICR7Y3JlYXRlZFJlc2lkZW5jZXMubGVuZ3RofSBuZXcgcmVzaWRlbmNlcyBmb3IgYnVpbGRpbmcgJHtidWlsZGluZ0lkfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKG5ld1RvdGFsVW5pdHMgPCBjdXJyZW50UmVzaWRlbmNlQ291bnQpIHtcbiAgICAgIC8vIE5lZWQgdG8gZGVsZXRlIHNvbWUgcmVzaWRlbmNlc1xuICAgICAgY29uc3QgcmVzaWRlbmNlc1RvRGVsZXRlID0gY3VycmVudFJlc2lkZW5jZUNvdW50IC0gbmV3VG90YWxVbml0cztcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg8J+TiSBNYXJraW5nICR7cmVzaWRlbmNlc1RvRGVsZXRlfSByZXNpZGVuY2VzIGFzIGluYWN0aXZlIGZvciBidWlsZGluZyAke2J1aWxkaW5nSWR9YFxuICAgICAgKTtcblxuICAgICAgLy8gR2V0IHJlc2lkZW5jZXMgdGhhdCBjYW4gYmUgc2FmZWx5IGRlbGV0ZWQgKG5vIGFjdGl2ZSB1c2VyIHJlbGF0aW9uc2hpcHMpXG4gICAgICBjb25zdCBkZWxldGFibGVSZXNpZGVuY2VzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGlkOiByZXNpZGVuY2VzLmlkLCB1bml0TnVtYmVyOiByZXNpZGVuY2VzLnVuaXROdW1iZXIgfSlcbiAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgLmxlZnRKb2luKFxuICAgICAgICAgIHVzZXJSZXNpZGVuY2VzLFxuICAgICAgICAgIGFuZChlcSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlcy5pZCksIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgICAgKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSxcbiAgICAgICAgICAgIGVxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgICAgaXNOdWxsKHVzZXJSZXNpZGVuY2VzLmlkKSAvLyBObyBhY3RpdmUgdXNlciByZWxhdGlvbnNoaXBzXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIC5vcmRlckJ5KHNxbGAke3Jlc2lkZW5jZXMudW5pdE51bWJlcn06OmludGVnZXIgREVTQ2ApIC8vIERlbGV0ZSBoaWdoZXN0IHVuaXQgbnVtYmVycyBmaXJzdFxuICAgICAgICAubGltaXQocmVzaWRlbmNlc1RvRGVsZXRlKTtcblxuICAgICAgaWYgKGRlbGV0YWJsZVJlc2lkZW5jZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCByZXNpZGVuY2VJZHNUb0RlbGV0ZSA9IGRlbGV0YWJsZVJlc2lkZW5jZXMubWFwKChyKSA9PiByLmlkKTtcblxuICAgICAgICAvLyBTb2Z0IGRlbGV0ZSByZXNpZGVuY2VzIChtYXJrIGFzIGluYWN0aXZlKVxuICAgICAgICBhd2FpdCBkYlxuICAgICAgICAgIC51cGRhdGUocmVzaWRlbmNlcylcbiAgICAgICAgICAuc2V0KHtcbiAgICAgICAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC53aGVyZShpbkFycmF5KHJlc2lkZW5jZXMuaWQsIHJlc2lkZW5jZUlkc1RvRGVsZXRlKSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYOKchSBNYXJrZWQgJHtkZWxldGFibGVSZXNpZGVuY2VzLmxlbmd0aH0gcmVzaWRlbmNlcyBhcyBpbmFjdGl2ZSBmb3IgYnVpbGRpbmcgJHtidWlsZGluZ0lkfWBcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBMb2cgd2hpY2ggcmVzaWRlbmNlcyBjb3VsZG4ndCBiZSBkZWxldGVkIGR1ZSB0byB1c2VyIHJlbGF0aW9uc2hpcHNcbiAgICAgICAgY29uc3QgcHJvdGVjdGVkQ291bnQgPSByZXNpZGVuY2VzVG9EZWxldGUgLSBkZWxldGFibGVSZXNpZGVuY2VzLmxlbmd0aDtcbiAgICAgICAgaWYgKHByb3RlY3RlZENvdW50ID4gMCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgYOKaoO+4jyBDb3VsZCBub3QgZGVsZXRlICR7cHJvdGVjdGVkQ291bnR9IHJlc2lkZW5jZXMgLSB0aGV5IGhhdmUgYWN0aXZlIHVzZXIgcmVsYXRpb25zaGlwc2BcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYOKckyBObyByZXNpZGVuY2UgY2hhbmdlcyBuZWVkZWQgLSBidWlsZGluZyAke2J1aWxkaW5nSWR9IGFscmVhZHkgaGFzICR7Y3VycmVudFJlc2lkZW5jZUNvdW50fSByZXNpZGVuY2VzYFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gRG9uJ3QgdGhyb3cgdGhlIGVycm9yIHRvIGF2b2lkIGJyZWFraW5nIHRoZSBidWlsZGluZyB1cGRhdGVcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyByZXNpZGVuY2UgY291bnQ6JywgZXJyb3IpO1xuICAgIC8vIERvbid0IHRocm93IHRoZSBlcnJvciB0byBhdm9pZCBicmVha2luZyB0aGUgYnVpbGRpbmcgdXBkYXRlXG4gIH1cbn1cblxuLyoqXG4gKlxuICogQHBhcmFtIGFwcFxuICovXG4vKipcbiAqIFJlZ2lzdGVyQnVpbGRpbmdSb3V0ZXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYXBwXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckJ1aWxkaW5nUm91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICAvKipcbiAgICogR0VUIC9hcGkvYnVpbGRpbmdzIC0gUmV0cmlldmVzIGJ1aWxkaW5ncyBiYXNlZCBvbiB1c2VyIHJvbGUgYW5kIG9yZ2FuaXphdGlvbiBhY2Nlc3MuXG4gICAqIFVzZWQgYnkgYmlsbHMgcGFnZSBhbmQgb3RoZXIgY29tcG9uZW50cy5cbiAgICpcbiAgICogQWNjZXNzIENvbnRyb2wgTG9naWM6XG4gICAqIC0gQWRtaW46IENhbiBzZWUgYWxsIGJ1aWxkaW5ncyBpZiB0aGV5IGhhdmUgZ2xvYmFsIGFjY2Vzcywgb3IgYnVpbGRpbmdzIGluIHRoZWlyIG9yZ2FuaXphdGlvbnNcbiAgICogLSBNYW5hZ2VyOiBDYW4gc2VlIG9ubHkgYnVpbGRpbmdzIGluIHRoZWlyIG9yZ2FuaXphdGlvbnNcbiAgICogLSBPdGhlcnM6IE5vIGFjY2VzcyB0byBidWlsZGluZ3MgbGlzdC5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvYnVpbGRpbmdzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBSb2xlLWJhc2VkIGFjY2VzcyBjb250cm9sIGZvciBidWlsZGluZ3NcbiAgICAgIGlmIChcbiAgICAgICAgIVtcbiAgICAgICAgICAnYWRtaW4nLFxuICAgICAgICAgICdtYW5hZ2VyJyxcbiAgICAgICAgICAnZGVtb19tYW5hZ2VyJyxcbiAgICAgICAgICAnZGVtb190ZW5hbnQnLFxuICAgICAgICAgICdkZW1vX3Jlc2lkZW50JyxcbiAgICAgICAgICAndGVuYW50JyxcbiAgICAgICAgICAncmVzaWRlbnQnLFxuICAgICAgICBdLmluY2x1ZGVzKHVzZXIucm9sZSlcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkLiBJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMuJyxcbiAgICAgICAgICBjb2RlOiAnSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKCfwn4+iIFtCdWlsZGluZ3MgQVBJXSBVc2VyIGFjY2Vzc2luZyBidWlsZGluZ3M6Jywge1xuICAgICAgICBpZDogdXNlci5pZCxcbiAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICBvcmdhbml6YXRpb25zOiB1c2VyLm9yZ2FuaXphdGlvbnMsXG4gICAgICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM6IHVzZXIuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyxcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgYnVpbGRpbmdzUXVlcnk7XG5cbiAgICAgIC8vIEFkbWluIHVzZXJzIHNob3VsZCBhbHdheXMgaGF2ZSBhY2Nlc3MgdG8gYWxsIGJ1aWxkaW5ncywgcmVnYXJkbGVzcyBvZiBvcmdhbml6YXRpb24gYXNzaWdubWVudHNcbiAgICAgIGlmICh1c2VyLnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYPCfj6IgW0JVSUxESU5HUyBERUJVR10gQWRtaW4gdXNlciBkZXRlY3RlZCAtIGdyYW50aW5nIGFjY2VzcyB0byBBTEwgYnVpbGRpbmdzYFxuICAgICAgICApO1xuICAgICAgICBidWlsZGluZ3NRdWVyeSA9IGRiXG4gICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICBpZDogYnVpbGRpbmdzLmlkLFxuICAgICAgICAgICAgbmFtZTogYnVpbGRpbmdzLm5hbWUsXG4gICAgICAgICAgICBhZGRyZXNzOiBidWlsZGluZ3MuYWRkcmVzcyxcbiAgICAgICAgICAgIGNpdHk6IGJ1aWxkaW5ncy5jaXR5LFxuICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5ncy5wcm92aW5jZSxcbiAgICAgICAgICAgIHBvc3RhbENvZGU6IGJ1aWxkaW5ncy5wb3N0YWxDb2RlLFxuICAgICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ3MuYnVpbGRpbmdUeXBlLFxuICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ3MueWVhckJ1aWx0LFxuICAgICAgICAgICAgdG90YWxVbml0czogYnVpbGRpbmdzLnRvdGFsVW5pdHMsXG4gICAgICAgICAgICB0b3RhbEZsb29yczogYnVpbGRpbmdzLnRvdGFsRmxvb3JzLFxuICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmdzLnBhcmtpbmdTcGFjZXMsXG4gICAgICAgICAgICBzdG9yYWdlU3BhY2VzOiBidWlsZGluZ3Muc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiBidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgICBpc0FjdGl2ZTogYnVpbGRpbmdzLmlzQWN0aXZlLFxuICAgICAgICAgICAgY3JlYXRlZEF0OiBidWlsZGluZ3MuY3JlYXRlZEF0LFxuICAgICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogb3JnYW5pemF0aW9ucy5uYW1lLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmZyb20oYnVpbGRpbmdzKVxuICAgICAgICAgIC5pbm5lckpvaW4ob3JnYW5pemF0aW9ucywgZXEoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgICAud2hlcmUoZXEoYnVpbGRpbmdzLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgICAgICAub3JkZXJCeShvcmdhbml6YXRpb25zLm5hbWUsIGJ1aWxkaW5ncy5uYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE1hbmFnZXJzIGFuZCBvdGhlciByb2xlczogb25seSBidWlsZGluZ3MgZnJvbSB0aGVpciBvcmdhbml6YXRpb25zXG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGDwn5SNIFtCVUlMRElOR1MgREVCVUddIE5vbi1hZG1pbiB1c2VyICgke3VzZXIucm9sZX0pIC0gY2hlY2tpbmcgb3JnYW5pemF0aW9uIGFjY2Vzcy4gVXNlciAke3VzZXIuaWR9IG9yZ2FuaXphdGlvbnM6YCxcbiAgICAgICAgICB1c2VyLm9yZ2FuaXphdGlvbnNcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCF1c2VyLm9yZ2FuaXphdGlvbnMgfHwgdXNlci5vcmdhbml6YXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgYPCflI0gW0JVSUxESU5HUyBERUJVR10gVXNlciAke3VzZXIuaWR9IGhhcyBubyBvcmdhbml6YXRpb25zLCBjaGVja2luZyByZXNpZGVuY2UgYWNjZXNzLi4uYFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBGb3IgdGVuYW50L3Jlc2lkZW50IHJvbGVzOiBHZXQgYnVpbGRpbmdzIHRocm91Z2ggdGhlaXIgcmVzaWRlbmNlc1xuICAgICAgICAgIGlmIChbJ3RlbmFudCcsICdyZXNpZGVudCcsICdkZW1vX3RlbmFudCcsICdkZW1vX3Jlc2lkZW50J10uaW5jbHVkZXModXNlci5yb2xlKSkge1xuICAgICAgICAgICAgY29uc3QgdXNlclJlc2lkZW5jZXNMaXN0ID0gYXdhaXQgZGJcbiAgICAgICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICAgICAgYnVpbGRpbmdJZDogcmVzaWRlbmNlcy5idWlsZGluZ0lkLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuZnJvbSh1c2VyUmVzaWRlbmNlcylcbiAgICAgICAgICAgICAgLmlubmVySm9pbihyZXNpZGVuY2VzLCBlcSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlcy5pZCkpXG4gICAgICAgICAgICAgIC53aGVyZShhbmQoZXEodXNlclJlc2lkZW5jZXMudXNlcklkLCB1c2VyLmlkKSwgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICBg8J+UjSBbQlVJTERJTkdTIERFQlVHXSBGb3VuZCAke3VzZXJSZXNpZGVuY2VzTGlzdC5sZW5ndGh9IHJlc2lkZW5jZXMgZm9yIHVzZXIgJHt1c2VyLmlkfWBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmICh1c2VyUmVzaWRlbmNlc0xpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXMuanNvbihbXSk7IC8vIE5vIHJlc2lkZW5jZXMgPSBubyBidWlsZGluZ3NcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYWNjZXNzaWJsZUJ1aWxkaW5nSWRzID0gW1xuICAgICAgICAgICAgICAuLi5uZXcgU2V0KHVzZXJSZXNpZGVuY2VzTGlzdC5tYXAoKHVyKSA9PiB1ci5idWlsZGluZ0lkKSksXG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYPCflI0gW0JVSUxESU5HUyBERUJVR10gQWNjZXNzaWJsZSBidWlsZGluZyBJRHM6YCwgYWNjZXNzaWJsZUJ1aWxkaW5nSWRzKTtcblxuICAgICAgICAgICAgYnVpbGRpbmdzUXVlcnkgPSBkYlxuICAgICAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgICAgICBpZDogYnVpbGRpbmdzLmlkLFxuICAgICAgICAgICAgICAgIG5hbWU6IGJ1aWxkaW5ncy5uYW1lLFxuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGJ1aWxkaW5ncy5hZGRyZXNzLFxuICAgICAgICAgICAgICAgIGNpdHk6IGJ1aWxkaW5ncy5jaXR5LFxuICAgICAgICAgICAgICAgIHByb3ZpbmNlOiBidWlsZGluZ3MucHJvdmluY2UsXG4gICAgICAgICAgICAgICAgcG9zdGFsQ29kZTogYnVpbGRpbmdzLnBvc3RhbENvZGUsXG4gICAgICAgICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ3MuYnVpbGRpbmdUeXBlLFxuICAgICAgICAgICAgICAgIHllYXJCdWlsdDogYnVpbGRpbmdzLnllYXJCdWlsdCxcbiAgICAgICAgICAgICAgICB0b3RhbFVuaXRzOiBidWlsZGluZ3MudG90YWxVbml0cyxcbiAgICAgICAgICAgICAgICB0b3RhbEZsb29yczogYnVpbGRpbmdzLnRvdGFsRmxvb3JzLFxuICAgICAgICAgICAgICAgIHBhcmtpbmdTcGFjZXM6IGJ1aWxkaW5ncy5wYXJraW5nU3BhY2VzLFxuICAgICAgICAgICAgICAgIHN0b3JhZ2VTcGFjZXM6IGJ1aWxkaW5ncy5zdG9yYWdlU3BhY2VzLFxuICAgICAgICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiBidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgICAgICAgaXNBY3RpdmU6IGJ1aWxkaW5ncy5pc0FjdGl2ZSxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IGJ1aWxkaW5ncy5jcmVhdGVkQXQsXG4gICAgICAgICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogb3JnYW5pemF0aW9ucy5uYW1lLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgICAgIC5pbm5lckpvaW4ob3JnYW5pemF0aW9ucywgZXEoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgICAgIGFuZChlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpLCBpbkFycmF5KGJ1aWxkaW5ncy5pZCwgYWNjZXNzaWJsZUJ1aWxkaW5nSWRzKSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAub3JkZXJCeShvcmdhbml6YXRpb25zLm5hbWUsIGJ1aWxkaW5ncy5uYW1lKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYPCflI0gW0JVSUxESU5HUyBERUJVR10gTWFuYWdlci9vdGhlciByb2xlIHVzZXIgJHt1c2VyLmlkfSBoYXMgbm8gb3JnYW5pemF0aW9ucyAtIHJldHVybmluZyBlbXB0eSByZXN1bHRgKTtcbiAgICAgICAgICAgIHJldHVybiByZXMuanNvbihbXSk7IC8vIE5vIG9yZ2FuaXphdGlvbnMgPSBubyBidWlsZGluZ3MgZm9yIG1hbmFnZXJzL290aGVyc1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBVc2VyIGhhcyBvcmdhbml6YXRpb25zIC0gdXNlIG9yZ2FuaXphdGlvbi1iYXNlZCBhY2Nlc3NcbiAgICAgICAgICBidWlsZGluZ3NRdWVyeSA9IGRiXG4gICAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgICAgaWQ6IGJ1aWxkaW5ncy5pZCxcbiAgICAgICAgICAgICAgbmFtZTogYnVpbGRpbmdzLm5hbWUsXG4gICAgICAgICAgICAgIGFkZHJlc3M6IGJ1aWxkaW5ncy5hZGRyZXNzLFxuICAgICAgICAgICAgICBjaXR5OiBidWlsZGluZ3MuY2l0eSxcbiAgICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5ncy5wcm92aW5jZSxcbiAgICAgICAgICAgICAgcG9zdGFsQ29kZTogYnVpbGRpbmdzLnBvc3RhbENvZGUsXG4gICAgICAgICAgICAgIGJ1aWxkaW5nVHlwZTogYnVpbGRpbmdzLmJ1aWxkaW5nVHlwZSxcbiAgICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ3MueWVhckJ1aWx0LFxuICAgICAgICAgICAgICB0b3RhbFVuaXRzOiBidWlsZGluZ3MudG90YWxVbml0cyxcbiAgICAgICAgICAgICAgdG90YWxGbG9vcnM6IGJ1aWxkaW5ncy50b3RhbEZsb29ycyxcbiAgICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmdzLnBhcmtpbmdTcGFjZXMsXG4gICAgICAgICAgICAgIHN0b3JhZ2VTcGFjZXM6IGJ1aWxkaW5ncy5zdG9yYWdlU3BhY2VzLFxuICAgICAgICAgICAgICBvcmdhbml6YXRpb25JZDogYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgICAgICBpc0FjdGl2ZTogYnVpbGRpbmdzLmlzQWN0aXZlLFxuICAgICAgICAgICAgICBjcmVhdGVkQXQ6IGJ1aWxkaW5ncy5jcmVhdGVkQXQsXG4gICAgICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgICAuaW5uZXJKb2luKG9yZ2FuaXphdGlvbnMsIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgICAgICAud2hlcmUoXG4gICAgICAgICAgICAgIGFuZChcbiAgICAgICAgICAgICAgICBlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgICAgICAgIGluQXJyYXkoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCB1c2VyLm9yZ2FuaXphdGlvbnMpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5vcmRlckJ5KG9yZ2FuaXphdGlvbnMubmFtZSwgYnVpbGRpbmdzLm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJ1aWxkaW5nc1F1ZXJ5O1xuXG4gICAgICByZXMuanNvbihyZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBidWlsZGluZ3M6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBfZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIGJ1aWxkaW5ncycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBHRVQgL2FwaS9tYW5hZ2VyL2J1aWxkaW5ncyAtIFJldHJpZXZlcyBidWlsZGluZ3MgYmFzZWQgb24gdXNlciByb2xlIGFuZCBhc3NvY2lhdGlvbnMuXG4gICAqXG4gICAqIEFjY2VzcyBDb250cm9sIExvZ2ljOlxuICAgKiAtIEFkbWluOiBDYW4gc2VlIGFsbCBidWlsZGluZ3MgaW4gdGhlaXIgb3JnYW5pemF0aW9uICsgYnVpbGRpbmdzIHdoZXJlIHRoZXkgaGF2ZSByZXNpZGVuY2VzXG4gICAqIC0gTWFuYWdlcjogQ2FuIHNlZSBhbGwgYnVpbGRpbmdzIGluIHRoZWlyIG9yZ2FuaXphdGlvbiArIGJ1aWxkaW5ncyB3aGVyZSB0aGV5IGhhdmUgcmVzaWRlbmNlc1xuICAgKiAtIFJlc2lkZW50L1RlbmFudDogQ2FuIHNlZSBvbmx5IGJ1aWxkaW5ncyB3aGVyZSB0aGV5IGhhdmUgcmVzaWRlbmNlcyAocm9sZSBpcyBub3QgdXNlZCwgb25seSByZXNpZGVuY2UgbGlua3MpLlxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9tYW5hZ2VyL2J1aWxkaW5ncycsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gY2hlY2tcbiAgICBpZiAoIXJlcS5zZXNzaW9uPy51c2VySWQgJiYgIXJlcS5zZXNzaW9uPy51c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gVXNlIHNlc3Npb24gZGF0YSBkaXJlY3RseSBmb3Igbm93XG4gICAgICBsZXQgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgLy8gSWYgd2Ugb25seSBoYXZlIHVzZXJJZCwgd2UgbmVlZCB0byBmZXRjaCB0aGUgdXNlclxuICAgICAgaWYgKCFjdXJyZW50VXNlciAmJiByZXEuc2Vzc2lvbj8udXNlcklkKSB7XG4gICAgICAgIC8vIEltcG9ydCBzdG9yYWdlIGZyb20gdGhlIGF1dGggcm91dGUgcGF0dGVyblxuICAgICAgICBjb25zdCB7IHN0b3JhZ2UgfSA9IGF3YWl0IGltcG9ydCgnLi4vc3RvcmFnZScpO1xuICAgICAgICBjdXJyZW50VXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXEuc2Vzc2lvbi51c2VySWQpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJyxcbiAgICAgICAgICBjb2RlOiAnVVNFUl9OT1RfRk9VTkQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGDwn5OKIEZldGNoaW5nIGJ1aWxkaW5ncyBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfSB3aXRoIHJvbGUgJHtjdXJyZW50VXNlci5yb2xlfWBcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGFjY2Vzc2libGVCdWlsZGluZ3M6IGFueVtdID0gW107XG4gICAgICBjb25zdCBidWlsZGluZ0lkcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGJlbG9uZ3MgdG8gS292ZW8gb3JnYW5pemF0aW9uIChzcGVjaWFsIGdsb2JhbCBhY2Nlc3MpXG4gICAgICBjb25zdCB1c2VyT3JncyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiB1c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCxcbiAgICAgICAgICBvcmdhbml6YXRpb25OYW1lOiBvcmdhbml6YXRpb25zLm5hbWUsXG4gICAgICAgICAgY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9uczogdXNlck9yZ2FuaXphdGlvbnMuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20odXNlck9yZ2FuaXphdGlvbnMpXG4gICAgICAgIC5pbm5lckpvaW4ob3JnYW5pemF0aW9ucywgZXEodXNlck9yZ2FuaXphdGlvbnMub3JnYW5pemF0aW9uSWQsIG9yZ2FuaXphdGlvbnMuaWQpKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKGVxKHVzZXJPcmdhbml6YXRpb25zLnVzZXJJZCwgY3VycmVudFVzZXIuaWQpLCBlcSh1c2VyT3JnYW5pemF0aW9ucy5pc0FjdGl2ZSwgdHJ1ZSkpXG4gICAgICAgICk7XG5cbiAgICAgIGNvbnN0IGhhc0dsb2JhbEFjY2VzcyA9XG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUgPT09ICdhZG1pbicgfHxcbiAgICAgICAgdXNlck9yZ3Muc29tZSgob3JnKSA9PiBvcmcub3JnYW5pemF0aW9uTmFtZSA9PT0gJ0tvdmVvJyB8fCBvcmcuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyk7XG5cbiAgICAgIGlmIChoYXNHbG9iYWxBY2Nlc3MpIHtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYPCfjJ8gQWRtaW4gdXNlciBvciB1c2VyIHdpdGggZ2xvYmFsIGFjY2VzcyBkZXRlY3RlZCAtIGdyYW50aW5nIGFjY2VzcyB0byBBTEwgYnVpbGRpbmdzYFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIEtvdmVvIHVzZXJzIGNhbiBzZWUgQUxMIGJ1aWxkaW5ncyBmcm9tIEFMTCBvcmdhbml6YXRpb25zXG4gICAgICAgIGNvbnN0IGFsbEJ1aWxkaW5ncyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICBpZDogYnVpbGRpbmdzLmlkLFxuICAgICAgICAgICAgbmFtZTogYnVpbGRpbmdzLm5hbWUsXG4gICAgICAgICAgICBhZGRyZXNzOiBidWlsZGluZ3MuYWRkcmVzcyxcbiAgICAgICAgICAgIGNpdHk6IGJ1aWxkaW5ncy5jaXR5LFxuICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5ncy5wcm92aW5jZSxcbiAgICAgICAgICAgIHBvc3RhbENvZGU6IGJ1aWxkaW5ncy5wb3N0YWxDb2RlLFxuICAgICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ3MuYnVpbGRpbmdUeXBlLFxuICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ3MueWVhckJ1aWx0LFxuICAgICAgICAgICAgdG90YWxVbml0czogYnVpbGRpbmdzLnRvdGFsVW5pdHMsXG4gICAgICAgICAgICB0b3RhbEZsb29yczogYnVpbGRpbmdzLnRvdGFsRmxvb3JzLFxuICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmdzLnBhcmtpbmdTcGFjZXMsXG4gICAgICAgICAgICBzdG9yYWdlU3BhY2VzOiBidWlsZGluZ3Muc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICAgIGFtZW5pdGllczogYnVpbGRpbmdzLmFtZW5pdGllcyxcbiAgICAgICAgICAgIG1hbmFnZW1lbnRDb21wYW55OiBidWlsZGluZ3MubWFuYWdlbWVudENvbXBhbnksXG4gICAgICAgICAgICBvcmdhbml6YXRpb25JZDogYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgICAgaXNBY3RpdmU6IGJ1aWxkaW5ncy5pc0FjdGl2ZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogYnVpbGRpbmdzLmNyZWF0ZWRBdCxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogYnVpbGRpbmdzLnVwZGF0ZWRBdCxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvblR5cGU6IG9yZ2FuaXphdGlvbnMudHlwZSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5mcm9tKGJ1aWxkaW5ncylcbiAgICAgICAgICAuaW5uZXJKb2luKG9yZ2FuaXphdGlvbnMsIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSkpXG4gICAgICAgICAgLm9yZGVyQnkob3JnYW5pemF0aW9ucy5uYW1lLCBidWlsZGluZ3MubmFtZSk7XG5cbiAgICAgICAgLy8gQWRkIGFsbCBidWlsZGluZ3Mgd2l0aCBzcGVjaWFsIEtvdmVvIGFjY2VzcyB0eXBlXG4gICAgICAgIGFsbEJ1aWxkaW5ncy5mb3JFYWNoKChidWlsZGluZykgPT4ge1xuICAgICAgICAgIGlmICghYnVpbGRpbmdJZHMuaGFzKGJ1aWxkaW5nLmlkKSkge1xuICAgICAgICAgICAgYnVpbGRpbmdJZHMuYWRkKGJ1aWxkaW5nLmlkKTtcbiAgICAgICAgICAgIGFjY2Vzc2libGVCdWlsZGluZ3MucHVzaCh7XG4gICAgICAgICAgICAgIC4uLmJ1aWxkaW5nLFxuICAgICAgICAgICAgICBhY2Nlc3NUeXBlOiAna292ZW8tZ2xvYmFsJywgLy8gU3BlY2lhbCBhY2Nlc3MgdHlwZSBmb3IgS292ZW8gdXNlcnNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBSZWd1bGFyIHVzZXJzOiBGb3IgQWRtaW4gYW5kIE1hbmFnZXIgcm9sZXM6IEdldCBidWlsZGluZ3MgZnJvbSB0aGVpciBvcmdhbml6YXRpb25zIG9ubHlcbiAgICAgICAgaWYgKGN1cnJlbnRVc2VyLnJvbGUgPT09ICdhZG1pbicgfHwgY3VycmVudFVzZXIucm9sZSA9PT0gJ21hbmFnZXInKSB7XG4gICAgICAgICAgaWYgKHVzZXJPcmdzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IG9yZ0lkcyA9IHVzZXJPcmdzLm1hcCgodW8pID0+IHVvLm9yZ2FuaXphdGlvbklkKTtcblxuICAgICAgICAgICAgLy8gR2V0IGFsbCBidWlsZGluZ3MgZnJvbSB0aGVzZSBvcmdhbml6YXRpb25zIG9ubHlcbiAgICAgICAgICAgIGNvbnN0IG9yZ0J1aWxkaW5ncyA9IGF3YWl0IGRiXG4gICAgICAgICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgICAgICAgIGlkOiBidWlsZGluZ3MuaWQsXG4gICAgICAgICAgICAgICAgbmFtZTogYnVpbGRpbmdzLm5hbWUsXG4gICAgICAgICAgICAgICAgYWRkcmVzczogYnVpbGRpbmdzLmFkZHJlc3MsXG4gICAgICAgICAgICAgICAgY2l0eTogYnVpbGRpbmdzLmNpdHksXG4gICAgICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5ncy5wcm92aW5jZSxcbiAgICAgICAgICAgICAgICBwb3N0YWxDb2RlOiBidWlsZGluZ3MucG9zdGFsQ29kZSxcbiAgICAgICAgICAgICAgICBidWlsZGluZ1R5cGU6IGJ1aWxkaW5ncy5idWlsZGluZ1R5cGUsXG4gICAgICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ3MueWVhckJ1aWx0LFxuICAgICAgICAgICAgICAgIHRvdGFsVW5pdHM6IGJ1aWxkaW5ncy50b3RhbFVuaXRzLFxuICAgICAgICAgICAgICAgIHRvdGFsRmxvb3JzOiBidWlsZGluZ3MudG90YWxGbG9vcnMsXG4gICAgICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmdzLnBhcmtpbmdTcGFjZXMsXG4gICAgICAgICAgICAgICAgc3RvcmFnZVNwYWNlczogYnVpbGRpbmdzLnN0b3JhZ2VTcGFjZXMsXG4gICAgICAgICAgICAgICAgYW1lbml0aWVzOiBidWlsZGluZ3MuYW1lbml0aWVzLFxuICAgICAgICAgICAgICAgIG1hbmFnZW1lbnRDb21wYW55OiBidWlsZGluZ3MubWFuYWdlbWVudENvbXBhbnksXG4gICAgICAgICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCxcbiAgICAgICAgICAgICAgICBpc0FjdGl2ZTogYnVpbGRpbmdzLmlzQWN0aXZlLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogYnVpbGRpbmdzLmNyZWF0ZWRBdCxcbiAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IGJ1aWxkaW5ncy51cGRhdGVkQXQsXG4gICAgICAgICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogb3JnYW5pemF0aW9ucy5uYW1lLFxuICAgICAgICAgICAgICAgIG9yZ2FuaXphdGlvblR5cGU6IG9yZ2FuaXphdGlvbnMudHlwZSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmZyb20oYnVpbGRpbmdzKVxuICAgICAgICAgICAgICAuaW5uZXJKb2luKG9yZ2FuaXphdGlvbnMsIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgICAgICAgIC53aGVyZShhbmQoaW5BcnJheShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ0lkcyksIGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgICAgICAgb3JnQnVpbGRpbmdzLmZvckVhY2goKGJ1aWxkaW5nKSA9PiB7XG4gICAgICAgICAgICAgIGlmICghYnVpbGRpbmdJZHMuaGFzKGJ1aWxkaW5nLmlkKSkge1xuICAgICAgICAgICAgICAgIGJ1aWxkaW5nSWRzLmFkZChidWlsZGluZy5pZCk7XG4gICAgICAgICAgICAgICAgYWNjZXNzaWJsZUJ1aWxkaW5ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIC4uLmJ1aWxkaW5nLFxuICAgICAgICAgICAgICAgICAgYWNjZXNzVHlwZTogJ29yZ2FuaXphdGlvbicsIC8vIFRyYWNrIGhvdyB1c2VyIGhhcyBhY2Nlc3NcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEZvciBBTEwgcm9sZXMgKEFkbWluLCBNYW5hZ2VyLCBSZXNpZGVudCwgVGVuYW50KTogR2V0IGJ1aWxkaW5ncyBmcm9tIHRoZWlyIHJlc2lkZW5jZXNcbiAgICAgIC8vIFRoaXMgaXMgdGhlIG1hbnktdG8tbWFueSByZWxhdGlvbnNoaXAgLSB1c2VycyBjYW4gaGF2ZSByZXNpZGVuY2VzIGluIGRpZmZlcmVudCBidWlsZGluZ3NcbiAgICAgIGNvbnN0IHVzZXJSZXNpZGVuY2VSZWNvcmRzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgcmVzaWRlbmNlSWQ6IHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLFxuICAgICAgICAgIHJlbGF0aW9uc2hpcFR5cGU6IHVzZXJSZXNpZGVuY2VzLnJlbGF0aW9uc2hpcFR5cGUsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAud2hlcmUoYW5kKGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgY3VycmVudFVzZXIuaWQpLCBlcSh1c2VyUmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgaWYgKHVzZXJSZXNpZGVuY2VSZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlSWRzID0gdXNlclJlc2lkZW5jZVJlY29yZHMubWFwKCh1cikgPT4gdXIucmVzaWRlbmNlSWQpO1xuXG4gICAgICAgIC8vIEdldCBidWlsZGluZ3MgdGhyb3VnaCByZXNpZGVuY2VzXG4gICAgICAgIGNvbnN0IHJlc2lkZW5jZUJ1aWxkaW5ncyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICBpZDogYnVpbGRpbmdzLmlkLFxuICAgICAgICAgICAgbmFtZTogYnVpbGRpbmdzLm5hbWUsXG4gICAgICAgICAgICBhZGRyZXNzOiBidWlsZGluZ3MuYWRkcmVzcyxcbiAgICAgICAgICAgIGNpdHk6IGJ1aWxkaW5ncy5jaXR5LFxuICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5ncy5wcm92aW5jZSxcbiAgICAgICAgICAgIHBvc3RhbENvZGU6IGJ1aWxkaW5ncy5wb3N0YWxDb2RlLFxuICAgICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ3MuYnVpbGRpbmdUeXBlLFxuICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ3MueWVhckJ1aWx0LFxuICAgICAgICAgICAgdG90YWxVbml0czogYnVpbGRpbmdzLnRvdGFsVW5pdHMsXG4gICAgICAgICAgICB0b3RhbEZsb29yczogYnVpbGRpbmdzLnRvdGFsRmxvb3JzLFxuICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmdzLnBhcmtpbmdTcGFjZXMsXG4gICAgICAgICAgICBzdG9yYWdlU3BhY2VzOiBidWlsZGluZ3Muc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICAgIGFtZW5pdGllczogYnVpbGRpbmdzLmFtZW5pdGllcyxcbiAgICAgICAgICAgIG1hbmFnZW1lbnRDb21wYW55OiBidWlsZGluZ3MubWFuYWdlbWVudENvbXBhbnksXG4gICAgICAgICAgICBvcmdhbml6YXRpb25JZDogYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgICAgaXNBY3RpdmU6IGJ1aWxkaW5ncy5pc0FjdGl2ZSxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogYnVpbGRpbmdzLmNyZWF0ZWRBdCxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogYnVpbGRpbmdzLnVwZGF0ZWRBdCxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICAgIG9yZ2FuaXphdGlvblR5cGU6IG9yZ2FuaXphdGlvbnMudHlwZSxcbiAgICAgICAgICAgIHJlc2lkZW5jZUlkOiByZXNpZGVuY2VzLmlkLFxuICAgICAgICAgICAgdW5pdE51bWJlcjogcmVzaWRlbmNlcy51bml0TnVtYmVyLFxuICAgICAgICAgICAgZmxvb3I6IHJlc2lkZW5jZXMuZmxvb3IsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZnJvbShyZXNpZGVuY2VzKVxuICAgICAgICAgIC5pbm5lckpvaW4oYnVpbGRpbmdzLCBlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5ncy5pZCkpXG4gICAgICAgICAgLmlubmVySm9pbihvcmdhbml6YXRpb25zLCBlcShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ2FuaXphdGlvbnMuaWQpKVxuICAgICAgICAgIC53aGVyZShhbmQoaW5BcnJheShyZXNpZGVuY2VzLmlkLCByZXNpZGVuY2VJZHMpLCBlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgLy8gQWRkIHJlc2lkZW5jZS1iYXNlZCBidWlsZGluZ3MgKGF2b2lkIGR1cGxpY2F0ZXMpXG4gICAgICAgIHJlc2lkZW5jZUJ1aWxkaW5ncy5mb3JFYWNoKChidWlsZGluZykgPT4ge1xuICAgICAgICAgIGlmICghYnVpbGRpbmdJZHMuaGFzKGJ1aWxkaW5nLmlkKSkge1xuICAgICAgICAgICAgYnVpbGRpbmdJZHMuYWRkKGJ1aWxkaW5nLmlkKTtcbiAgICAgICAgICAgIGFjY2Vzc2libGVCdWlsZGluZ3MucHVzaCh7XG4gICAgICAgICAgICAgIGlkOiBidWlsZGluZy5pZCxcbiAgICAgICAgICAgICAgbmFtZTogYnVpbGRpbmcubmFtZSxcbiAgICAgICAgICAgICAgYWRkcmVzczogYnVpbGRpbmcuYWRkcmVzcyxcbiAgICAgICAgICAgICAgY2l0eTogYnVpbGRpbmcuY2l0eSxcbiAgICAgICAgICAgICAgcHJvdmluY2U6IGJ1aWxkaW5nLnByb3ZpbmNlLFxuICAgICAgICAgICAgICBwb3N0YWxDb2RlOiBidWlsZGluZy5wb3N0YWxDb2RlLFxuICAgICAgICAgICAgICBidWlsZGluZ1R5cGU6IGJ1aWxkaW5nLmJ1aWxkaW5nVHlwZSxcbiAgICAgICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZy55ZWFyQnVpbHQsXG4gICAgICAgICAgICAgIHRvdGFsVW5pdHM6IGJ1aWxkaW5nLnRvdGFsVW5pdHMsXG4gICAgICAgICAgICAgIHRvdGFsRmxvb3JzOiBidWlsZGluZy50b3RhbEZsb29ycyxcbiAgICAgICAgICAgICAgcGFya2luZ1NwYWNlczogYnVpbGRpbmcucGFya2luZ1NwYWNlcyxcbiAgICAgICAgICAgICAgc3RvcmFnZVNwYWNlczogYnVpbGRpbmcuc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICAgICAgYW1lbml0aWVzOiBidWlsZGluZy5hbWVuaXRpZXMsXG4gICAgICAgICAgICAgIG1hbmFnZW1lbnRDb21wYW55OiBidWlsZGluZy5tYW5hZ2VtZW50Q29tcGFueSxcbiAgICAgICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IGJ1aWxkaW5nLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgICAgICBpc0FjdGl2ZTogYnVpbGRpbmcuaXNBY3RpdmUsXG4gICAgICAgICAgICAgIGNyZWF0ZWRBdDogYnVpbGRpbmcuY3JlYXRlZEF0LFxuICAgICAgICAgICAgICB1cGRhdGVkQXQ6IGJ1aWxkaW5nLnVwZGF0ZWRBdCxcbiAgICAgICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogYnVpbGRpbmcub3JnYW5pemF0aW9uTmFtZSxcbiAgICAgICAgICAgICAgb3JnYW5pemF0aW9uVHlwZTogYnVpbGRpbmcub3JnYW5pemF0aW9uVHlwZSxcbiAgICAgICAgICAgICAgYWNjZXNzVHlwZTogJ3Jlc2lkZW5jZScsIC8vIFRyYWNrIGhvdyB1c2VyIGhhcyBhY2Nlc3NcbiAgICAgICAgICAgICAgdXNlclJlc2lkZW5jZToge1xuICAgICAgICAgICAgICAgIHJlc2lkZW5jZUlkOiBidWlsZGluZy5yZXNpZGVuY2VJZCxcbiAgICAgICAgICAgICAgICB1bml0TnVtYmVyOiBidWlsZGluZy51bml0TnVtYmVyLFxuICAgICAgICAgICAgICAgIGZsb29yOiBidWlsZGluZy5mbG9vcixcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBCdWlsZGluZyBhbHJlYWR5IGV4aXN0cywgYnV0IHdlIG1pZ2h0IHdhbnQgdG8gYWRkIHJlc2lkZW5jZSBpbmZvXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0J1aWxkaW5nID0gYWNjZXNzaWJsZUJ1aWxkaW5ncy5maW5kKChiKSA9PiBiLmlkID09PSBidWlsZGluZy5pZCk7XG4gICAgICAgICAgICBpZiAoZXhpc3RpbmdCdWlsZGluZyAmJiAhZXhpc3RpbmdCdWlsZGluZy51c2VyUmVzaWRlbmNlKSB7XG4gICAgICAgICAgICAgIGV4aXN0aW5nQnVpbGRpbmcudXNlclJlc2lkZW5jZSA9IHtcbiAgICAgICAgICAgICAgICByZXNpZGVuY2VJZDogYnVpbGRpbmcucmVzaWRlbmNlSWQsXG4gICAgICAgICAgICAgICAgdW5pdE51bWJlcjogYnVpbGRpbmcudW5pdE51bWJlcixcbiAgICAgICAgICAgICAgICBmbG9vcjogYnVpbGRpbmcuZmxvb3IsXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIC8vIFVwZGF0ZSBhY2Nlc3MgdHlwZSBpZiB0aGlzIGlzIGZyb20gYm90aCBvcmdhbml6YXRpb24gYW5kIHJlc2lkZW5jZVxuICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdCdWlsZGluZy5hY2Nlc3NUeXBlID09PSAnb3JnYW5pemF0aW9uJykge1xuICAgICAgICAgICAgICAgIGV4aXN0aW5nQnVpbGRpbmcuYWNjZXNzVHlwZSA9ICdib3RoJztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBzdGF0aXN0aWNzIGZvciBlYWNoIGJ1aWxkaW5nXG4gICAgICBjb25zdCBidWlsZGluZ3NXaXRoU3RhdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgYWNjZXNzaWJsZUJ1aWxkaW5ncy5tYXAoYXN5bmMgKGJ1aWxkaW5nKSA9PiB7XG4gICAgICAgICAgLy8gR2V0IHJlc2lkZW5jZSBjb3VudFxuICAgICAgICAgIGNvbnN0IHJlc2lkZW5jZUNvdW50ID0gYXdhaXQgZGJcbiAgICAgICAgICAgIC5zZWxlY3QoeyBjb3VudDogc3FsPG51bWJlcj5gY291bnQoKik6OmludGAgfSlcbiAgICAgICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgICAgICAud2hlcmUoYW5kKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmcuaWQpLCBlcShyZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSkpO1xuXG4gICAgICAgICAgLy8gQ2FsY3VsYXRlIG9jY3VwYW5jeSByYXRlXG4gICAgICAgICAgY29uc3Qgb2NjdXBpZWRVbml0cyA9IHJlc2lkZW5jZUNvdW50WzBdPy5jb3VudCB8fCAwO1xuICAgICAgICAgIGNvbnN0IG9jY3VwYW5jeVJhdGUgPVxuICAgICAgICAgICAgYnVpbGRpbmcudG90YWxVbml0cyA+IDAgPyBNYXRoLnJvdW5kKChvY2N1cGllZFVuaXRzIC8gYnVpbGRpbmcudG90YWxVbml0cykgKiAxMDApIDogMDtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5idWlsZGluZyxcbiAgICAgICAgICAgIHN0YXRpc3RpY3M6IHtcbiAgICAgICAgICAgICAgdG90YWxVbml0czogYnVpbGRpbmcudG90YWxVbml0cyxcbiAgICAgICAgICAgICAgb2NjdXBpZWRVbml0cyxcbiAgICAgICAgICAgICAgb2NjdXBhbmN5UmF0ZSxcbiAgICAgICAgICAgICAgdmFjYW50VW5pdHM6IGJ1aWxkaW5nLnRvdGFsVW5pdHMgLSBvY2N1cGllZFVuaXRzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgLy8gU29ydCBidWlsZGluZ3MgYnkgbmFtZVxuICAgICAgYnVpbGRpbmdzV2l0aFN0YXRzLnNvcnQoKGEsIGIpID0+IGEubmFtZS5sb2NhbGVDb21wYXJlKGIubmFtZSkpO1xuXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYOKchSBGb3VuZCAke2J1aWxkaW5nc1dpdGhTdGF0cy5sZW5ndGh9IGFjY2Vzc2libGUgYnVpbGRpbmdzIGZvciB1c2VyICR7Y3VycmVudFVzZXIuaWR9YFxuICAgICAgKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBidWlsZGluZ3M6IGJ1aWxkaW5nc1dpdGhTdGF0cyxcbiAgICAgICAgbWV0YToge1xuICAgICAgICAgIHRvdGFsOiBidWlsZGluZ3NXaXRoU3RhdHMubGVuZ3RoLFxuICAgICAgICAgIHVzZXJSb2xlOiBjdXJyZW50VXNlci5yb2xlLFxuICAgICAgICAgIHVzZXJJZDogY3VycmVudFVzZXIuaWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgbWFuYWdlciBidWlsZGluZ3M6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBfZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIGJ1aWxkaW5ncycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBHRVQgL2FwaS9tYW5hZ2VyL2J1aWxkaW5ncy86aWQgLSBHZXQgYSBzcGVjaWZpYyBidWlsZGluZyB3aXRoIGRldGFpbGVkIGluZm9ybWF0aW9uXG4gICAqIFVzZXMgdGhlIHNhbWUgYWNjZXNzIGNvbnRyb2wgbG9naWMgYXMgdGhlIGxpc3QgZW5kcG9pbnQuXG4gICAqL1xuICBhcHAuZ2V0KCcvYXBpL21hbmFnZXIvYnVpbGRpbmdzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgYnVpbGRpbmdJZCA9IHJlcS5wYXJhbXMuaWQ7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBfZXJyb3I6ICdVbmF1dGhvcml6ZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYPCfk4ogRmV0Y2hpbmcgYnVpbGRpbmcgJHtidWlsZGluZ0lkfSBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfSB3aXRoIHJvbGUgJHtjdXJyZW50VXNlci5yb2xlfWBcbiAgICAgICk7XG5cbiAgICAgIGxldCBoYXNBY2Nlc3MgPSBmYWxzZTtcbiAgICAgIGxldCBhY2Nlc3NUeXBlID0gJyc7XG5cbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgYmVsb25ncyB0byBLb3ZlbyBvcmdhbml6YXRpb24gKHNwZWNpYWwgZ2xvYmFsIGFjY2VzcylcbiAgICAgIGNvbnN0IHVzZXJPcmdzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IHVzZXJPcmdhbml6YXRpb25zLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zOiB1c2VyT3JnYW5pemF0aW9ucy5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbSh1c2VyT3JnYW5pemF0aW9ucylcbiAgICAgICAgLmlubmVySm9pbihvcmdhbml6YXRpb25zLCBlcSh1c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgIC53aGVyZShcbiAgICAgICAgICBhbmQoZXEodXNlck9yZ2FuaXphdGlvbnMudXNlcklkLCBjdXJyZW50VXNlci5pZCksIGVxKHVzZXJPcmdhbml6YXRpb25zLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgICAgKTtcblxuICAgICAgY29uc3QgaGFzR2xvYmFsQWNjZXNzID1cbiAgICAgICAgY3VycmVudFVzZXIucm9sZSA9PT0gJ2FkbWluJyB8fFxuICAgICAgICB1c2VyT3Jncy5zb21lKChvcmcpID0+IG9yZy5vcmdhbml6YXRpb25OYW1lID09PSAnS292ZW8nIHx8IG9yZy5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zKTtcblxuICAgICAgaWYgKGhhc0dsb2JhbEFjY2Vzcykge1xuICAgICAgICBoYXNBY2Nlc3MgPSB0cnVlO1xuICAgICAgICBhY2Nlc3NUeXBlID0gJ2dsb2JhbCc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBDaGVjayBvcmdhbml6YXRpb24tYmFzZWQgYWNjZXNzIGZvciBBZG1pbiBhbmQgTWFuYWdlclxuICAgICAgICBpZiAoY3VycmVudFVzZXIucm9sZSA9PT0gJ2FkbWluJyB8fCBjdXJyZW50VXNlci5yb2xlID09PSAnbWFuYWdlcicpIHtcbiAgICAgICAgICBpZiAodXNlck9yZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgb3JnSWRzID0gdXNlck9yZ3MubWFwKCh1bykgPT4gdW8ub3JnYW5pemF0aW9uSWQpO1xuXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBidWlsZGluZyBiZWxvbmdzIHRvIHVzZXIncyBvcmdhbml6YXRpb25zXG4gICAgICAgICAgICBjb25zdCBidWlsZGluZ09yZyA9IGF3YWl0IGRiXG4gICAgICAgICAgICAgIC5zZWxlY3QoeyBpZDogYnVpbGRpbmdzLmlkIH0pXG4gICAgICAgICAgICAgIC5mcm9tKGJ1aWxkaW5ncylcbiAgICAgICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgICAgIGFuZChcbiAgICAgICAgICAgICAgICAgIGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCksXG4gICAgICAgICAgICAgICAgICBpbkFycmF5KGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnSWRzKSxcbiAgICAgICAgICAgICAgICAgIGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChidWlsZGluZ09yZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgIGhhc0FjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgIGFjY2Vzc1R5cGUgPSAnb3JnYW5pemF0aW9uJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgcmVzaWRlbmNlLWJhc2VkIGFjY2VzcyBmb3IgYWxsIHJvbGVzXG4gICAgICBpZiAoIWhhc0FjY2Vzcykge1xuICAgICAgICBjb25zdCB1c2VyUmVzaWRlbmNlQWNjZXNzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgcmVzaWRlbmNlSWQ6IHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkIH0pXG4gICAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgICAgLmlubmVySm9pbihyZXNpZGVuY2VzLCBlcSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlcy5pZCkpXG4gICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgYW5kKFxuICAgICAgICAgICAgICBlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIGN1cnJlbnRVc2VyLmlkKSxcbiAgICAgICAgICAgICAgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSxcbiAgICAgICAgICAgICAgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcblxuICAgICAgICBpZiAodXNlclJlc2lkZW5jZUFjY2Vzcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaGFzQWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICBhY2Nlc3NUeXBlID0gYWNjZXNzVHlwZSA/ICdib3RoJyA6ICdyZXNpZGVuY2UnO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghaGFzQWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgX2Vycm9yOiAnRm9yYmlkZGVuJyxcbiAgICAgICAgICBtZXNzYWdlOiAnWW91IGRvIG5vdCBoYXZlIGFjY2VzcyB0byB0aGlzIGJ1aWxkaW5nJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBidWlsZGluZyBkZXRhaWxzXG4gICAgICBjb25zdCBidWlsZGluZ0RhdGEgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICBpZDogYnVpbGRpbmdzLmlkLFxuICAgICAgICAgIG5hbWU6IGJ1aWxkaW5ncy5uYW1lLFxuICAgICAgICAgIGFkZHJlc3M6IGJ1aWxkaW5ncy5hZGRyZXNzLFxuICAgICAgICAgIGNpdHk6IGJ1aWxkaW5ncy5jaXR5LFxuICAgICAgICAgIHByb3ZpbmNlOiBidWlsZGluZ3MucHJvdmluY2UsXG4gICAgICAgICAgcG9zdGFsQ29kZTogYnVpbGRpbmdzLnBvc3RhbENvZGUsXG4gICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ3MuYnVpbGRpbmdUeXBlLFxuICAgICAgICAgIHllYXJCdWlsdDogYnVpbGRpbmdzLnllYXJCdWlsdCxcbiAgICAgICAgICB0b3RhbFVuaXRzOiBidWlsZGluZ3MudG90YWxVbml0cyxcbiAgICAgICAgICB0b3RhbEZsb29yczogYnVpbGRpbmdzLnRvdGFsRmxvb3JzLFxuICAgICAgICAgIHBhcmtpbmdTcGFjZXM6IGJ1aWxkaW5ncy5wYXJraW5nU3BhY2VzLFxuICAgICAgICAgIHN0b3JhZ2VTcGFjZXM6IGJ1aWxkaW5ncy5zdG9yYWdlU3BhY2VzLFxuICAgICAgICAgIGFtZW5pdGllczogYnVpbGRpbmdzLmFtZW5pdGllcyxcbiAgICAgICAgICBtYW5hZ2VtZW50Q29tcGFueTogYnVpbGRpbmdzLm1hbmFnZW1lbnRDb21wYW55LFxuICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiBidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgaXNBY3RpdmU6IGJ1aWxkaW5ncy5pc0FjdGl2ZSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IGJ1aWxkaW5ncy5jcmVhdGVkQXQsXG4gICAgICAgICAgdXBkYXRlZEF0OiBidWlsZGluZ3MudXBkYXRlZEF0LFxuICAgICAgICAgIG9yZ2FuaXphdGlvbk5hbWU6IG9yZ2FuaXphdGlvbnMubmFtZSxcbiAgICAgICAgICBvcmdhbml6YXRpb25UeXBlOiBvcmdhbml6YXRpb25zLnR5cGUsXG4gICAgICAgICAgb3JnYW5pemF0aW9uQWRkcmVzczogb3JnYW5pemF0aW9ucy5hZGRyZXNzLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbkNpdHk6IG9yZ2FuaXphdGlvbnMuY2l0eSxcbiAgICAgICAgICBvcmdhbml6YXRpb25QaG9uZTogb3JnYW5pemF0aW9ucy5waG9uZSxcbiAgICAgICAgICBvcmdhbml6YXRpb25FbWFpbDogb3JnYW5pemF0aW9ucy5lbWFpbCxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20oYnVpbGRpbmdzKVxuICAgICAgICAuaW5uZXJKb2luKG9yZ2FuaXphdGlvbnMsIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgb3JnYW5pemF0aW9ucy5pZCkpXG4gICAgICAgIC53aGVyZShlcShidWlsZGluZ3MuaWQsIGJ1aWxkaW5nSWQpKTtcblxuICAgICAgaWYgKGJ1aWxkaW5nRGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBfZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWlsZGluZyBub3QgZm91bmQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYnVpbGRpbmcgPSBidWlsZGluZ0RhdGFbMF07XG5cbiAgICAgIC8vIEdldCBhbGwgcmVzaWRlbmNlcyBmb3IgdGhpcyBidWlsZGluZ1xuICAgICAgY29uc3QgYnVpbGRpbmdSZXNpZGVuY2VzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgaWQ6IHJlc2lkZW5jZXMuaWQsXG4gICAgICAgICAgdW5pdE51bWJlcjogcmVzaWRlbmNlcy51bml0TnVtYmVyLFxuICAgICAgICAgIGZsb29yOiByZXNpZGVuY2VzLmZsb29yLFxuICAgICAgICAgIHNxdWFyZUZvb3RhZ2U6IHJlc2lkZW5jZXMuc3F1YXJlRm9vdGFnZSxcbiAgICAgICAgICBiZWRyb29tczogcmVzaWRlbmNlcy5iZWRyb29tcyxcbiAgICAgICAgICBiYXRocm9vbXM6IHJlc2lkZW5jZXMuYmF0aHJvb21zLFxuICAgICAgICAgIGJhbGNvbnk6IHJlc2lkZW5jZXMuYmFsY29ueSxcbiAgICAgICAgICBwYXJraW5nU3BhY2VOdW1iZXJzOiByZXNpZGVuY2VzLnBhcmtpbmdTcGFjZU51bWJlcnMsXG4gICAgICAgICAgc3RvcmFnZVNwYWNlTnVtYmVyczogcmVzaWRlbmNlcy5zdG9yYWdlU3BhY2VOdW1iZXJzLFxuICAgICAgICAgIG1vbnRobHlGZWVzOiByZXNpZGVuY2VzLm1vbnRobHlGZWVzLFxuICAgICAgICAgIGlzQWN0aXZlOiByZXNpZGVuY2VzLmlzQWN0aXZlLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbShyZXNpZGVuY2VzKVxuICAgICAgICAud2hlcmUoYW5kKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCksIGVxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgIC8vIEdldCB1c2VyJ3MgcmVzaWRlbmNlcyBpbiB0aGlzIGJ1aWxkaW5nIGlmIGFueVxuICAgICAgbGV0IHVzZXJSZXNpZGVuY2VzSW5CdWlsZGluZzogdW5rbm93bltdID0gW107XG4gICAgICBjb25zdCB1c2VyUmVzaWRlbmNlUmVjb3JkcyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIHJlc2lkZW5jZUlkOiB1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCxcbiAgICAgICAgICByZWxhdGlvbnNoaXBUeXBlOiB1c2VyUmVzaWRlbmNlcy5yZWxhdGlvbnNoaXBUeXBlLFxuICAgICAgICAgIHN0YXJ0RGF0ZTogdXNlclJlc2lkZW5jZXMuc3RhcnREYXRlLFxuICAgICAgICAgIGVuZERhdGU6IHVzZXJSZXNpZGVuY2VzLmVuZERhdGUsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAuaW5uZXJKb2luKHJlc2lkZW5jZXMsIGVxKHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLCByZXNpZGVuY2VzLmlkKSlcbiAgICAgICAgLndoZXJlKFxuICAgICAgICAgIGFuZChcbiAgICAgICAgICAgIGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgY3VycmVudFVzZXIuaWQpLFxuICAgICAgICAgICAgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSxcbiAgICAgICAgICAgIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgaWYgKHVzZXJSZXNpZGVuY2VSZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdXNlclJlc2lkZW5jZXNJbkJ1aWxkaW5nID0gdXNlclJlc2lkZW5jZVJlY29yZHMubWFwKCh1cikgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc2lkZW5jZSA9IGJ1aWxkaW5nUmVzaWRlbmNlcy5maW5kKChyKSA9PiByLmlkID09PSB1ci5yZXNpZGVuY2VJZCk7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLnJlc2lkZW5jZSxcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcFR5cGU6IHVyLnJlbGF0aW9uc2hpcFR5cGUsXG4gICAgICAgICAgICBzdGFydERhdGU6IHVyLnN0YXJ0RGF0ZSxcbiAgICAgICAgICAgIGVuZERhdGU6IHVyLmVuZERhdGUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBzdGF0aXN0aWNzXG4gICAgICBjb25zdCBvY2N1cGllZFVuaXRzID0gYnVpbGRpbmdSZXNpZGVuY2VzLmxlbmd0aDtcbiAgICAgIGNvbnN0IG9jY3VwYW5jeVJhdGUgPVxuICAgICAgICBidWlsZGluZy50b3RhbFVuaXRzID4gMCA/IE1hdGgucm91bmQoKG9jY3VwaWVkVW5pdHMgLyBidWlsZGluZy50b3RhbFVuaXRzKSAqIDEwMCkgOiAwO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIC4uLmJ1aWxkaW5nLFxuICAgICAgICBhY2Nlc3NUeXBlLFxuICAgICAgICBzdGF0aXN0aWNzOiB7XG4gICAgICAgICAgdG90YWxVbml0czogYnVpbGRpbmcudG90YWxVbml0cyxcbiAgICAgICAgICBvY2N1cGllZFVuaXRzLFxuICAgICAgICAgIG9jY3VwYW5jeVJhdGUsXG4gICAgICAgICAgdmFjYW50VW5pdHM6IGJ1aWxkaW5nLnRvdGFsVW5pdHMgLSBvY2N1cGllZFVuaXRzLFxuICAgICAgICAgIHRvdGFsUmVzaWRlbmNlczogYnVpbGRpbmdSZXNpZGVuY2VzLmxlbmd0aCxcbiAgICAgICAgfSxcbiAgICAgICAgdXNlclJlc2lkZW5jZXM6IHVzZXJSZXNpZGVuY2VzSW5CdWlsZGluZyxcbiAgICAgICAgLy8gT25seSBpbmNsdWRlIGZ1bGwgcmVzaWRlbmNlIGxpc3QgZm9yIG1hbmFnZXJzL2FkbWluc1xuICAgICAgICByZXNpZGVuY2VzOlxuICAgICAgICAgIGN1cnJlbnRVc2VyLnJvbGUgPT09ICdhZG1pbicgfHwgY3VycmVudFVzZXIucm9sZSA9PT0gJ21hbmFnZXInXG4gICAgICAgICAgICA/IGJ1aWxkaW5nUmVzaWRlbmNlc1xuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgYnVpbGRpbmcgZGV0YWlsczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIF9lcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggYnVpbGRpbmcgZGV0YWlscycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBQT1NUIC9hcGkvYWRtaW4vYnVpbGRpbmdzIC0gQ3JlYXRlIGEgbmV3IGJ1aWxkaW5nIChBZG1pbiBvbmx5KS5cbiAgICovXG4gIGFwcC5wb3N0KCcvYXBpL2FkbWluL2J1aWxkaW5ncycsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFkbWluXG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGN1cnJlbnRVc2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQURNSU5fUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYnVpbGRpbmdEYXRhID0gcmVxLmJvZHk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkc1xuICAgICAgaWYgKCFidWlsZGluZ0RhdGEubmFtZSB8fCAhYnVpbGRpbmdEYXRhLm9yZ2FuaXphdGlvbklkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgX2Vycm9yOiAnVmFsaWRhdGlvbiBlcnJvcicsXG4gICAgICAgICAgbWVzc2FnZTogJ0J1aWxkaW5nIG5hbWUgYW5kIG9yZ2FuaXphdGlvbiBhcmUgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIGJ1aWxkaW5nIHdpdGggSURcbiAgICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuXG4gICAgICBjb25zdCBuZXdCdWlsZGluZyA9IGF3YWl0IGRiXG4gICAgICAgIC5pbnNlcnQoYnVpbGRpbmdzKVxuICAgICAgICAudmFsdWVzKHtcbiAgICAgICAgICBpZDogYnVpbGRpbmdJZCxcbiAgICAgICAgICBuYW1lOiBidWlsZGluZ0RhdGEubmFtZSxcbiAgICAgICAgICBhZGRyZXNzOiBidWlsZGluZ0RhdGEuYWRkcmVzcyB8fCAnJyxcbiAgICAgICAgICBjaXR5OiBidWlsZGluZ0RhdGEuY2l0eSB8fCAnJyxcbiAgICAgICAgICBwcm92aW5jZTogYnVpbGRpbmdEYXRhLnByb3ZpbmNlIHx8ICdRQycsXG4gICAgICAgICAgcG9zdGFsQ29kZTogYnVpbGRpbmdEYXRhLnBvc3RhbENvZGUgfHwgJycsXG4gICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ0RhdGEuYnVpbGRpbmdUeXBlIHx8ICdjb25kbycsXG4gICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ0RhdGEueWVhckJ1aWx0LFxuICAgICAgICAgIHRvdGFsVW5pdHM6IGJ1aWxkaW5nRGF0YS50b3RhbFVuaXRzIHx8IDAsXG4gICAgICAgICAgdG90YWxGbG9vcnM6IGJ1aWxkaW5nRGF0YS50b3RhbEZsb29ycyxcbiAgICAgICAgICBwYXJraW5nU3BhY2VzOiBidWlsZGluZ0RhdGEucGFya2luZ1NwYWNlcyxcbiAgICAgICAgICBzdG9yYWdlU3BhY2VzOiBidWlsZGluZ0RhdGEuc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICBhbWVuaXRpZXM6IGJ1aWxkaW5nRGF0YS5hbWVuaXRpZXMgPyBKU09OLnN0cmluZ2lmeShidWlsZGluZ0RhdGEuYW1lbml0aWVzKSA6IG51bGwsXG4gICAgICAgICAgbWFuYWdlbWVudENvbXBhbnk6IGJ1aWxkaW5nRGF0YS5tYW5hZ2VtZW50Q29tcGFueSxcbiAgICAgICAgICBvcmdhbml6YXRpb25JZDogYnVpbGRpbmdEYXRhLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0pXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcblxuXG4gICAgICAvLyBCdWlsZGluZyBzdG9yYWdlIGhpZXJhcmNoeSB3aWxsIGJlIGNyZWF0ZWQgYXV0b21hdGljYWxseSB3aGVuIGRvY3VtZW50cyBhcmUgdXBsb2FkZWRcbiAgICAgIGNvbnNvbGUubG9nKCdCdWlsZGluZyBjcmVhdGVkIC0gc3RvcmFnZSBoaWVyYXJjaHkgd2lsbCBiZSBjcmVhdGVkIG9uIGZpcnN0IGRvY3VtZW50IHVwbG9hZCcpO1xuXG4gICAgICAvLyBBdXRvLWdlbmVyYXRlIHJlc2lkZW5jZXMgaWYgdG90YWxVbml0cyBpcyBzcGVjaWZpZWQgYW5kIDw9IDMwMFxuICAgICAgaWYgKFxuICAgICAgICBidWlsZGluZ0RhdGEudG90YWxVbml0cyAmJlxuICAgICAgICBidWlsZGluZ0RhdGEudG90YWxVbml0cyA+IDAgJiZcbiAgICAgICAgYnVpbGRpbmdEYXRhLnRvdGFsVW5pdHMgPD0gMzAwXG4gICAgICApIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB0b3RhbFVuaXRzID0gYnVpbGRpbmdEYXRhLnRvdGFsVW5pdHM7XG4gICAgICAgICAgY29uc3QgdG90YWxGbG9vcnMgPSBidWlsZGluZ0RhdGEudG90YWxGbG9vcnMgfHwgMTtcbiAgICAgICAgICBjb25zdCB1bml0c1BlckZsb29yID0gTWF0aC5jZWlsKHRvdGFsVW5pdHMgLyB0b3RhbEZsb29ycyk7XG5cbiAgICAgICAgICBjb25zdCByZXNpZGVuY2VzVG9DcmVhdGUgPSBbXTtcbiAgICAgICAgICBmb3IgKGxldCB1bml0ID0gMTsgdW5pdCA8PSB0b3RhbFVuaXRzOyB1bml0KyspIHtcbiAgICAgICAgICAgIGNvbnN0IGZsb29yID0gTWF0aC5jZWlsKHVuaXQgLyB1bml0c1BlckZsb29yKTtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRPbkZsb29yID0gKCh1bml0IC0gMSkgJSB1bml0c1BlckZsb29yKSArIDE7XG4gICAgICAgICAgICBjb25zdCB1bml0TnVtYmVyID0gYCR7Zmxvb3J9JHt1bml0T25GbG9vci50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDtcblxuICAgICAgICAgICAgcmVzaWRlbmNlc1RvQ3JlYXRlLnB1c2goe1xuICAgICAgICAgICAgICBidWlsZGluZ0lkOiBidWlsZGluZ0lkLFxuICAgICAgICAgICAgICB1bml0TnVtYmVyLFxuICAgICAgICAgICAgICBmbG9vcixcbiAgICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBJbnNlcnQgYWxsIHJlc2lkZW5jZXMgYXQgb25jZVxuICAgICAgICAgIGNvbnN0IGNyZWF0ZWRSZXNpZGVuY2VzID0gYXdhaXQgZGJcbiAgICAgICAgICAgIC5pbnNlcnQocmVzaWRlbmNlcylcbiAgICAgICAgICAgIC52YWx1ZXMocmVzaWRlbmNlc1RvQ3JlYXRlKVxuICAgICAgICAgICAgLnJldHVybmluZygpO1xuXG4gICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBg4pyFIEF1dG8tZ2VuZXJhdGVkICR7Y3JlYXRlZFJlc2lkZW5jZXMubGVuZ3RofSByZXNpZGVuY2VzIGZvciBidWlsZGluZyAke2J1aWxkaW5nSWR9YFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBUT0RPOiBPYmplY3Qgc3RvcmFnZSBzZXJ2aWNlIGludGVncmF0aW9uXG4gICAgICAgICAgLy8gQ3JlYXRlIG9iamVjdCBzdG9yYWdlIGhpZXJhcmNoeSBmb3IgZWFjaCByZXNpZGVuY2VcbiAgICAgICAgICAvLyBmb3IgKGNvbnN0IHJlc2lkZW5jZSBvZiBjcmVhdGVkUmVzaWRlbmNlcykge1xuICAgICAgICAgIC8vICAgYXdhaXQgb2JqZWN0U3RvcmFnZVNlcnZpY2UuY3JlYXRlUmVzaWRlbmNlSGllcmFyY2h5KFxuICAgICAgICAgIC8vICAgICBidWlsZGluZ0RhdGEub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgLy8gICAgIGJ1aWxkaW5nSWQsXG4gICAgICAgICAgLy8gICAgIHJlc2lkZW5jZS5pZFxuICAgICAgICAgIC8vICAgKTtcbiAgICAgICAgICAvLyB9XG4gICAgICAgIH0gY2F0Y2ggKF9fX3Jlc2lkZW5jZUVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4pqg77iPIEVycm9yIGF1dG8tZ2VuZXJhdGluZyByZXNpZGVuY2VzOicsIF9fX3Jlc2lkZW5jZUVycm9yKTtcbiAgICAgICAgICAvLyBEb24ndCBmYWlsIHRoZSBidWlsZGluZyBjcmVhdGlvbiBpZiByZXNpZGVuY2UgZ2VuZXJhdGlvbiBmYWlsc1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0J1aWxkaW5nIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgYnVpbGRpbmc6IG5ld0J1aWxkaW5nWzBdLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGNyZWF0aW5nIGJ1aWxkaW5nOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgX2Vycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgYnVpbGRpbmcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogR0VUIC9hcGkvYnVpbGRpbmdzLzppZC9yZXNpZGVuY2VzLWZvci1kZWxldGlvbiAtIEdldCBsaXN0IG9mIHJlc2lkZW5jZXMgdGhhdCBjYW4gYmUgc2VsZWN0ZWQgZm9yIGRlbGV0aW9uXG4gICAqIE9ubHkgYWRtaW5zIGNhbiBhY2Nlc3MgdGhpcyBlbmRwb2ludFxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9idWlsZGluZ3MvOmlkL3Jlc2lkZW5jZXMtZm9yLWRlbGV0aW9uJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcbiAgICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSByZXEucGFyYW1zLmlkO1xuICAgICAgY29uc3QgbWF4VG9TZWxlY3QgPSBwYXJzZUludChyZXEucXVlcnkubWF4VG9TZWxlY3QgYXMgc3RyaW5nKSB8fCAxMDtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE9ubHkgYWRtaW5zIGNhbiBkZWxldGUgcmVzaWRlbmNlc1xuICAgICAgaWYgKHVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBtZXNzYWdlOiAnT25seSBhZG1pbnMgY2FuIGFjY2VzcyByZXNpZGVuY2UgZGVsZXRpb24gb3B0aW9ucycgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgZ2V0UmVzaWRlbmNlc0ZvclNlbGVjdGlvbiB9ID0gYXdhaXQgaW1wb3J0KCcuL2J1aWxkaW5ncy9vcGVyYXRpb25zJyk7XG4gICAgICBjb25zdCByZXNpZGVuY2VzVG9TZWxlY3QgPSBhd2FpdCBnZXRSZXNpZGVuY2VzRm9yU2VsZWN0aW9uKGJ1aWxkaW5nSWQsIG1heFRvU2VsZWN0KTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICByZXNpZGVuY2VzOiByZXNpZGVuY2VzVG9TZWxlY3QsXG4gICAgICAgIG1lc3NhZ2U6IGBGb3VuZCAke3Jlc2lkZW5jZXNUb1NlbGVjdC5sZW5ndGh9IHJlc2lkZW5jZXMgYXZhaWxhYmxlIGZvciBkZWxldGlvbmBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyByZXNpZGVuY2VzIGZvciBkZWxldGlvbjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggcmVzaWRlbmNlcyBmb3IgZGVsZXRpb24nIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIERFTEVURSAvYXBpL2J1aWxkaW5ncy86aWQvcmVzaWRlbmNlcyAtIERlbGV0ZSBzZWxlY3RlZCByZXNpZGVuY2VzXG4gICAqIE9ubHkgYWRtaW5zIGNhbiBkZWxldGUgcmVzaWRlbmNlc1xuICAgKi9cbiAgYXBwLmRlbGV0ZSgnL2FwaS9idWlsZGluZ3MvOmlkL3Jlc2lkZW5jZXMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgYnVpbGRpbmdJZCA9IHJlcS5wYXJhbXMuaWQ7XG4gICAgICBjb25zdCB7IHJlc2lkZW5jZUlkcyB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBPbmx5IGFkbWlucyBjYW4gZGVsZXRlIHJlc2lkZW5jZXNcbiAgICAgIGlmICh1c2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogJ09ubHkgYWRtaW5zIGNhbiBkZWxldGUgcmVzaWRlbmNlcycgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXNpZGVuY2VJZHMpIHx8IHJlc2lkZW5jZUlkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ3Jlc2lkZW5jZUlkcyBhcnJheSBpcyByZXF1aXJlZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgZGVsZXRlU2VsZWN0ZWRSZXNpZGVuY2VzIH0gPSBhd2FpdCBpbXBvcnQoJy4vYnVpbGRpbmdzL29wZXJhdGlvbnMnKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRlbGV0ZVNlbGVjdGVkUmVzaWRlbmNlcyhidWlsZGluZ0lkLCByZXNpZGVuY2VJZHMsIHVzZXIucm9sZSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGVsZXRlZENvdW50OiByZXN1bHQuZGVsZXRlZENvdW50LFxuICAgICAgICBkb2N1bWVudHNEZWxldGVkOiByZXN1bHQuZG9jdW1lbnRzRGVsZXRlZCxcbiAgICAgICAgbWVzc2FnZTogYFN1Y2Nlc3NmdWxseSBkZWxldGVkICR7cmVzdWx0LmRlbGV0ZWRDb3VudH0gcmVzaWRlbmNlcyBhbmQgJHtyZXN1bHQuZG9jdW1lbnRzRGVsZXRlZH0gYXNzb2NpYXRlZCBkb2N1bWVudHNgXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZGVsZXRpbmcgcmVzaWRlbmNlczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfHwgJ0ZhaWxlZCB0byBkZWxldGUgcmVzaWRlbmNlcycgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogUFVUIC9hcGkvYWRtaW4vYnVpbGRpbmdzLzppZCAtIFVwZGF0ZSBhIGJ1aWxkaW5nIChBZG1pbiBhbmQgTWFuYWdlcikuXG4gICAqL1xuICBhcHAucHV0KCcvYXBpL2FkbWluL2J1aWxkaW5ncy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhZG1pbiBvciBtYW5hZ2VyXG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGN1cnJlbnRVc2VyLnJvbGUgIT09ICdhZG1pbicgJiYgY3VycmVudFVzZXIucm9sZSAhPT0gJ21hbmFnZXInKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0FkbWluIG9yIE1hbmFnZXIgYWNjZXNzIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQURNSU5fTUFOQUdFUl9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBidWlsZGluZ0lkID0gcmVxLnBhcmFtcy5pZDtcbiAgICAgIGNvbnN0IGJ1aWxkaW5nRGF0YSA9IHJlcS5ib2R5O1xuXG4gICAgICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBmaWVsZHNcbiAgICAgIGlmICghYnVpbGRpbmdEYXRhLm5hbWUgfHwgIWJ1aWxkaW5nRGF0YS5vcmdhbml6YXRpb25JZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIF9lcnJvcjogJ1ZhbGlkYXRpb24gZXJyb3InLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWlsZGluZyBuYW1lIGFuZCBvcmdhbml6YXRpb24gYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIGJ1aWxkaW5nIGV4aXN0c1xuICAgICAgY29uc3QgZXhpc3RpbmdCdWlsZGluZyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgIC53aGVyZShlcShidWlsZGluZ3MuaWQsIGJ1aWxkaW5nSWQpKVxuICAgICAgICAubGltaXQoMSk7XG5cbiAgICAgIGlmIChleGlzdGluZ0J1aWxkaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIF9lcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0J1aWxkaW5nIG5vdCBmb3VuZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBjdXJyZW50IG51bWJlciBvZiBhY3RpdmUgcmVzaWRlbmNlc1xuICAgICAgY29uc3QgY3VycmVudFJlc2lkZW5jZXMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHsgY291bnQ6IHNxbDxudW1iZXI+YGNvdW50KCopOjppbnRgIH0pXG4gICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgIC53aGVyZShhbmQoZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSwgZXEocmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgY29uc3QgY3VycmVudFJlc2lkZW5jZUNvdW50ID0gY3VycmVudFJlc2lkZW5jZXNbMF0/LmNvdW50IHx8IDA7XG4gICAgICBjb25zdCBuZXdUb3RhbFVuaXRzID0gYnVpbGRpbmdEYXRhLnRvdGFsVW5pdHMgfHwgMDtcbiAgICAgIGNvbnN0IHByZXZpb3VzVG90YWxVbml0cyA9IGV4aXN0aW5nQnVpbGRpbmdbMF0udG90YWxVbml0cyB8fCAwO1xuXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYPCflIQgQnVpbGRpbmcgJHtidWlsZGluZ0lkfTogJHtwcmV2aW91c1RvdGFsVW5pdHN9IOKGkiAke25ld1RvdGFsVW5pdHN9IHVuaXRzIChjdXJyZW50bHkgaGFzICR7Y3VycmVudFJlc2lkZW5jZUNvdW50fSBhY3RpdmUgcmVzaWRlbmNlcylgXG4gICAgICApO1xuXG4gICAgICAvLyBVcGRhdGUgYnVpbGRpbmdcbiAgICAgIGNvbnN0IHVwZGF0ZWRCdWlsZGluZyA9IGF3YWl0IGRiXG4gICAgICAgIC51cGRhdGUoYnVpbGRpbmdzKVxuICAgICAgICAuc2V0KHtcbiAgICAgICAgICBuYW1lOiBidWlsZGluZ0RhdGEubmFtZSxcbiAgICAgICAgICBhZGRyZXNzOiBidWlsZGluZ0RhdGEuYWRkcmVzcyB8fCAnJyxcbiAgICAgICAgICBjaXR5OiBidWlsZGluZ0RhdGEuY2l0eSB8fCAnJyxcbiAgICAgICAgICBwcm92aW5jZTogYnVpbGRpbmdEYXRhLnByb3ZpbmNlIHx8ICdRQycsXG4gICAgICAgICAgcG9zdGFsQ29kZTogYnVpbGRpbmdEYXRhLnBvc3RhbENvZGUgfHwgJycsXG4gICAgICAgICAgYnVpbGRpbmdUeXBlOiBidWlsZGluZ0RhdGEuYnVpbGRpbmdUeXBlIHx8ICdjb25kbycsXG4gICAgICAgICAgeWVhckJ1aWx0OiBidWlsZGluZ0RhdGEueWVhckJ1aWx0LFxuICAgICAgICAgIHRvdGFsVW5pdHM6IG5ld1RvdGFsVW5pdHMsXG4gICAgICAgICAgdG90YWxGbG9vcnM6IGJ1aWxkaW5nRGF0YS50b3RhbEZsb29ycyxcbiAgICAgICAgICBwYXJraW5nU3BhY2VzOiBidWlsZGluZ0RhdGEucGFya2luZ1NwYWNlcyxcbiAgICAgICAgICBzdG9yYWdlU3BhY2VzOiBidWlsZGluZ0RhdGEuc3RvcmFnZVNwYWNlcyxcbiAgICAgICAgICBhbWVuaXRpZXM6IGJ1aWxkaW5nRGF0YS5hbWVuaXRpZXMgPyBKU09OLnN0cmluZ2lmeShidWlsZGluZ0RhdGEuYW1lbml0aWVzKSA6IG51bGwsXG4gICAgICAgICAgbWFuYWdlbWVudENvbXBhbnk6IGJ1aWxkaW5nRGF0YS5tYW5hZ2VtZW50Q29tcGFueSxcbiAgICAgICAgICBvcmdhbml6YXRpb25JZDogYnVpbGRpbmdEYXRhLm9yZ2FuaXphdGlvbklkLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCkpXG4gICAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgICAgLy8gSGFuZGxlIHJlc2lkZW5jZSBjb3VudCBjaGFuZ2VzIHdpdGggbmV3IGFkbWluLW9ubHkgZnVuY3Rpb25hbGl0eVxuICAgICAgaWYgKG5ld1RvdGFsVW5pdHMgIT09IHByZXZpb3VzVG90YWxVbml0cykge1xuICAgICAgICBjb25zb2xlLmxvZyhg8J+PoCBCdWlsZGluZyB1bml0cyBjaGFuZ2VkIGZyb20gJHtwcmV2aW91c1RvdGFsVW5pdHN9IHRvICR7bmV3VG90YWxVbml0c30sIGFkanVzdGluZyByZXNpZGVuY2VzLi4uYCk7XG4gICAgICAgIFxuICAgICAgICAvLyBPbmx5IGFkbWlucyBjYW4gYWRqdXN0IHJlc2lkZW5jZSBjb3VudHNcbiAgICAgICAgaWYgKGN1cnJlbnRVc2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ09ubHkgYWRtaW5zIGNhbiBpbmNyZWFzZSBvciBkZWNyZWFzZSBidWlsZGluZyByZXNpZGVuY2UgY291bnRzJyxcbiAgICAgICAgICAgIGNvZGU6ICdBRE1JTl9SRVFVSVJFRF9GT1JfUkVTSURFTkNFX0NIQU5HRVMnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgeyBhZGp1c3RSZXNpZGVuY2VDb3VudCB9ID0gYXdhaXQgaW1wb3J0KCcuL2J1aWxkaW5ncy9vcGVyYXRpb25zJyk7XG4gICAgICAgIGNvbnN0IGFkanVzdG1lbnRSZXN1bHQgPSBhd2FpdCBhZGp1c3RSZXNpZGVuY2VDb3VudChcbiAgICAgICAgICBidWlsZGluZ0lkLFxuICAgICAgICAgIGV4aXN0aW5nQnVpbGRpbmdbMF0ub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgbmV3VG90YWxVbml0cyxcbiAgICAgICAgICBwcmV2aW91c1RvdGFsVW5pdHMsXG4gICAgICAgICAgYnVpbGRpbmdEYXRhLnRvdGFsRmxvb3JzIHx8IGV4aXN0aW5nQnVpbGRpbmdbMF0udG90YWxGbG9vcnMgfHwgMVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIElmIHJlc2lkZW5jZXMgbmVlZCB0byBiZSBkZWNyZWFzZWQsIHJldHVybiB0aGUgc2VsZWN0aW9uIGxpc3QgdG8gdXNlclxuICAgICAgICBpZiAoYWRqdXN0bWVudFJlc3VsdC5hY3Rpb24gPT09ICdkZWNyZWFzZWQnICYmIGFkanVzdG1lbnRSZXN1bHQucmVzaWRlbmNlc1RvU2VsZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdCdWlsZGluZyB1cGRhdGVkLCBidXQgcmVzaWRlbmNlIGNvdW50IG5lZWRzIHRvIGJlIHJlZHVjZWQnLFxuICAgICAgICAgICAgYnVpbGRpbmdVcGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgbmVlZHNSZXNpZGVuY2VTZWxlY3Rpb246IHRydWUsXG4gICAgICAgICAgICByZXNpZGVuY2VzVG9TZWxlY3Q6IGFkanVzdG1lbnRSZXN1bHQucmVzaWRlbmNlc1RvU2VsZWN0LFxuICAgICAgICAgICAgaW5zdHJ1Y3Rpb246IGBQbGVhc2Ugc2VsZWN0ICR7cHJldmlvdXNUb3RhbFVuaXRzIC0gbmV3VG90YWxVbml0c30gcmVzaWRlbmNlcyB0byBkZWxldGUgZnJvbSB0aGUgbGlzdCBwcm92aWRlZC4gVXNlIERFTEVURSAvYXBpL2J1aWxkaW5ncy8ke2J1aWxkaW5nSWR9L3Jlc2lkZW5jZXMgd2l0aCB0aGUgc2VsZWN0ZWQgcmVzaWRlbmNlIElEcy5gXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdCdWlsZGluZyB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIGJ1aWxkaW5nOiB1cGRhdGVkQnVpbGRpbmdbMF0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgdXBkYXRpbmcgYnVpbGRpbmc6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBfZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHVwZGF0ZSBidWlsZGluZycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBERUxFVEUgL2FwaS9hZG1pbi9idWlsZGluZ3MvOmlkIC0gRGVsZXRlIGEgYnVpbGRpbmcgKEFkbWluIG9ubHkpLlxuICAgKi9cbiAgYXBwLmRlbGV0ZSgnL2FwaS9hZG1pbi9idWlsZGluZ3MvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYWRtaW5cbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoY3VycmVudFVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBZG1pbiBhY2Nlc3MgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBRE1JTl9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBidWlsZGluZ0lkID0gcmVxLnBhcmFtcy5pZDtcblxuICAgICAgLy8gQ2hlY2sgaWYgYnVpbGRpbmcgZXhpc3RzXG4gICAgICBjb25zdCBleGlzdGluZ0J1aWxkaW5nID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgIC5mcm9tKGJ1aWxkaW5ncylcbiAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCkpXG4gICAgICAgIC5saW1pdCgxKTtcblxuICAgICAgaWYgKGV4aXN0aW5nQnVpbGRpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgX2Vycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVpbGRpbmcgbm90IGZvdW5kJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNvZnQgZGVsZXRlIGJ5IHNldHRpbmcgaXNBY3RpdmUgdG8gZmFsc2VcbiAgICAgIGF3YWl0IGRiXG4gICAgICAgIC51cGRhdGUoYnVpbGRpbmdzKVxuICAgICAgICAuc2V0KHtcbiAgICAgICAgICBpc0FjdGl2ZTogZmFsc2UsXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9KVxuICAgICAgICAud2hlcmUoZXEoYnVpbGRpbmdzLmlkLCBidWlsZGluZ0lkKSk7XG5cblxuICAgICAgLy8gT2JqZWN0IHN0b3JhZ2UgY2xlYW51cCB3aWxsIGJlIGhhbmRsZWQgYXV0b21hdGljYWxseVxuICAgICAgY29uc29sZS5sb2coJ0J1aWxkaW5nIGRlbGV0ZWQgLSBzdG9yYWdlIGNsZWFudXAgd2lsbCBiZSBoYW5kbGVkIGF1dG9tYXRpY2FsbHknKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQnVpbGRpbmcgZGVsZXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGRlbGV0aW5nIGJ1aWxkaW5nOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgX2Vycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBkZWxldGUgYnVpbGRpbmcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogR0VUIC9hcGkvYWRtaW4vYnVpbGRpbmdzLzppZC9kZWxldGlvbi1pbXBhY3QgLSBHZXQgZGVsZXRpb24gaW1wYWN0IGFuYWx5c2lzXG4gICAqIFNob3dzIHdoYXQgd2lsbCBiZSBkZWxldGVkIHdoZW4gcmVtb3ZpbmcgYSBidWlsZGluZy5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvYWRtaW4vYnVpbGRpbmdzLzppZC9kZWxldGlvbi1pbXBhY3QnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjdXJyZW50VXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0FkbWluIGFjY2VzcyByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FETUlOX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSByZXEucGFyYW1zLmlkO1xuXG4gICAgICAvLyBDaGVjayBpZiBidWlsZGluZyBleGlzdHNcbiAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGlkOiBidWlsZGluZ3MuaWQsIG5hbWU6IGJ1aWxkaW5ncy5uYW1lIH0pXG4gICAgICAgIC5mcm9tKGJ1aWxkaW5ncylcbiAgICAgICAgLndoZXJlKGFuZChlcShidWlsZGluZ3MuaWQsIGJ1aWxkaW5nSWQpLCBlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpKSlcbiAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICBpZiAoYnVpbGRpbmcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgX2Vycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVpbGRpbmcgbm90IGZvdW5kJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvdW50IHJlc2lkZW5jZXMgaW4gdGhpcyBidWlsZGluZ1xuICAgICAgY29uc3QgcmVzaWRlbmNlc0NvdW50ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGNvdW50OiBzcWw8bnVtYmVyPmBjb3VudCgqKWAgfSlcbiAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgLndoZXJlKGFuZChlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5nSWQpLCBlcShyZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSkpO1xuXG4gICAgICAvLyBDb3VudCBkb2N1bWVudHMgYXNzb2NpYXRlZCB3aXRoIHRoaXMgYnVpbGRpbmcgb3IgaXRzIHJlc2lkZW5jZXNcbiAgICAgIGNvbnN0IGRvY3VtZW50c0NvdW50ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGNvdW50OiBzcWw8bnVtYmVyPmBjb3VudCgqKWAgfSlcbiAgICAgICAgLmZyb20oZG9jdW1lbnRzKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgb3IoXG4gICAgICAgICAgICBlcShkb2N1bWVudHMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCksXG4gICAgICAgICAgICBzcWxgJHtkb2N1bWVudHMucmVzaWRlbmNlSWR9IElOIChTRUxFQ1QgaWQgRlJPTSByZXNpZGVuY2VzIFdIRVJFIGJ1aWxkaW5nX2lkID0gJHtidWlsZGluZ0lkfSlgXG4gICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICAvLyBDb3VudCB1c2VycyB3aG8gd2lsbCBiZWNvbWUgb3JwaGFuZWQgKG9ubHkgaGF2ZSByZWxhdGlvbnNoaXBzIHdpdGggcmVzaWRlbmNlcyBpbiB0aGlzIGJ1aWxkaW5nKVxuICAgICAgY29uc3QgcG90ZW50aWFsT3JwaGFuc0NvdW50ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGNvdW50OiBzcWw8bnVtYmVyPmBjb3VudChkaXN0aW5jdCAke3VzZXJSZXNpZGVuY2VzLnVzZXJJZH0pYCB9KVxuICAgICAgICAuZnJvbSh1c2VyUmVzaWRlbmNlcylcbiAgICAgICAgLmlubmVySm9pbihyZXNpZGVuY2VzLCBlcSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlcy5pZCkpXG4gICAgICAgIC5pbm5lckpvaW4odXNlcnMsIGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgdXNlcnMuaWQpKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSxcbiAgICAgICAgICAgIGVxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgICAgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgICAgZXEodXNlcnMuaXNBY3RpdmUsIHRydWUpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICBjb25zdCBpbXBhY3QgPSB7XG4gICAgICAgIGJ1aWxkaW5nOiBidWlsZGluZ1swXSxcbiAgICAgICAgcmVzaWRlbmNlczogcmVzaWRlbmNlc0NvdW50WzBdPy5jb3VudCB8fCAwLFxuICAgICAgICBkb2N1bWVudHM6IGRvY3VtZW50c0NvdW50WzBdPy5jb3VudCB8fCAwLFxuICAgICAgICBwb3RlbnRpYWxPcnBoYW5lZFVzZXJzOiBwb3RlbnRpYWxPcnBoYW5zQ291bnRbMF0/LmNvdW50IHx8IDAsXG4gICAgICB9O1xuXG4gICAgICByZXMuanNvbihpbXBhY3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBhbmFseXppbmcgZGVsZXRpb24gaW1wYWN0OicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgX2Vycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBhbmFseXplIGRlbGV0aW9uIGltcGFjdCcsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBERUxFVEUgL2FwaS9hZG1pbi9idWlsZGluZ3MvOmlkL2Nhc2NhZGUgLSBDYXNjYWRlIGRlbGV0ZSBhIGJ1aWxkaW5nXG4gICAqIFJlcGxhY2VzIHRoZSBzaW1wbGUgZGVsZXRlIHdpdGggY2FzY2FkaW5nIGRlbGV0ZSB0aGF0IHJlbW92ZXMgcmVzaWRlbmNlcyBhbmQgZG9jdW1lbnRzLiBVc2VycyBhcmUgcHJlc2VydmVkIGZvciBkYXRhIHNhZmV0eS5cbiAgICovXG4gIGFwcC5kZWxldGUoJy9hcGkvYWRtaW4vYnVpbGRpbmdzLzppZC9jYXNjYWRlJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoY3VycmVudFVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBZG1pbiBhY2Nlc3MgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBRE1JTl9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBidWlsZGluZ0lkID0gcmVxLnBhcmFtcy5pZDtcblxuICAgICAgLy8gQ2hlY2sgaWYgYnVpbGRpbmcgZXhpc3RzXG4gICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoeyBpZDogYnVpbGRpbmdzLmlkLCBuYW1lOiBidWlsZGluZ3MubmFtZSB9KVxuICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgIC53aGVyZShhbmQoZXEoYnVpbGRpbmdzLmlkLCBidWlsZGluZ0lkKSwgZXEoYnVpbGRpbmdzLmlzQWN0aXZlLCB0cnVlKSkpXG4gICAgICAgIC5saW1pdCgxKTtcblxuICAgICAgaWYgKGJ1aWxkaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIF9lcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0J1aWxkaW5nIG5vdCBmb3VuZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBTdGFydCB0cmFuc2FjdGlvbiBmb3IgY2FzY2FkaW5nIGRlbGV0ZVxuICAgICAgYXdhaXQgZGIudHJhbnNhY3Rpb24oYXN5bmMgKHR4KSA9PiB7XG4gICAgICAgIC8vIDEuIEdldCBhbGwgcmVzaWRlbmNlcyBpbiB0aGlzIGJ1aWxkaW5nXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nUmVzaWRlbmNlcyA9IGF3YWl0IHR4XG4gICAgICAgICAgLnNlbGVjdCh7IGlkOiByZXNpZGVuY2VzLmlkIH0pXG4gICAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgICAud2hlcmUoYW5kKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCksIGVxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgY29uc3QgcmVzaWRlbmNlSWRzID0gYnVpbGRpbmdSZXNpZGVuY2VzLm1hcCgocikgPT4gci5pZCk7XG5cbiAgICAgICAgaWYgKHJlc2lkZW5jZUlkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgLy8gMi4gRGVsZXRlIGRvY3VtZW50cyBhc3NvY2lhdGVkIHdpdGggYnVpbGRpbmcgb3IgaXRzIHJlc2lkZW5jZXNcbiAgICAgICAgICBhd2FpdCB0eFxuICAgICAgICAgICAgLmRlbGV0ZShkb2N1bWVudHMpXG4gICAgICAgICAgICAud2hlcmUoXG4gICAgICAgICAgICAgIG9yKGVxKGRvY3VtZW50cy5idWlsZGluZ0lkLCBidWlsZGluZ0lkKSwgaW5BcnJheShkb2N1bWVudHMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZUlkcykpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gMy4gU29mdCBkZWxldGUgdXNlci1yZXNpZGVuY2UgcmVsYXRpb25zaGlwc1xuICAgICAgICAgIGF3YWl0IHR4XG4gICAgICAgICAgICAudXBkYXRlKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAgICAgLnNldCh7IGlzQWN0aXZlOiBmYWxzZSwgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpIH0pXG4gICAgICAgICAgICAud2hlcmUoaW5BcnJheSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlSWRzKSk7XG5cbiAgICAgICAgICAvLyA0LiBESVNBQkxFRDogVXNlciBkZWxldGlvbiBwcm9oaWJpdGVkIGZvciBkYXRhIHNhZmV0eVxuICAgICAgICAgIGNvbnN0IG9ycGhhbmVkVXNlcnMgPSBhd2FpdCB0eFxuICAgICAgICAgICAgLnNlbGVjdCh7IGlkOiB1c2Vycy5pZCB9KVxuICAgICAgICAgICAgLmZyb20odXNlcnMpXG4gICAgICAgICAgICAubGVmdEpvaW4oXG4gICAgICAgICAgICAgIHVzZXJPcmdhbml6YXRpb25zLFxuICAgICAgICAgICAgICBhbmQoZXEodXNlcnMuaWQsIHVzZXJPcmdhbml6YXRpb25zLnVzZXJJZCksIGVxKHVzZXJPcmdhbml6YXRpb25zLmlzQWN0aXZlLCB0cnVlKSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5sZWZ0Sm9pbihcbiAgICAgICAgICAgICAgdXNlclJlc2lkZW5jZXMsXG4gICAgICAgICAgICAgIGFuZChlcSh1c2Vycy5pZCwgdXNlclJlc2lkZW5jZXMudXNlcklkKSwgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLndoZXJlKFxuICAgICAgICAgICAgICBhbmQoXG4gICAgICAgICAgICAgICAgZXEodXNlcnMuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgICAgICAgIGlzTnVsbCh1c2VyT3JnYW5pemF0aW9ucy51c2VySWQpLFxuICAgICAgICAgICAgICAgIGlzTnVsbCh1c2VyUmVzaWRlbmNlcy51c2VySWQpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAob3JwaGFuZWRVc2Vycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBvcnBoYW5lZFVzZXJJZHMgPSBvcnBoYW5lZFVzZXJzLm1hcCgodSkgPT4gdS5pZCk7XG4gICAgICAgICAgICBhd2FpdCB0eFxuICAgICAgICAgICAgICAudXBkYXRlKHVzZXJzKVxuICAgICAgICAgICAgICAuc2V0KHsgaXNBY3RpdmU6IGZhbHNlLCB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkgfSlcbiAgICAgICAgICAgICAgLndoZXJlKGluQXJyYXkodXNlcnMuaWQsIG9ycGhhbmVkVXNlcklkcykpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIDUuIFNvZnQgZGVsZXRlIHJlc2lkZW5jZXNcbiAgICAgICAgICBhd2FpdCB0eFxuICAgICAgICAgICAgLnVwZGF0ZShyZXNpZGVuY2VzKVxuICAgICAgICAgICAgLnNldCh7IGlzQWN0aXZlOiBmYWxzZSwgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpIH0pXG4gICAgICAgICAgICAud2hlcmUoaW5BcnJheShyZXNpZGVuY2VzLmlkLCByZXNpZGVuY2VJZHMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBTdGlsbCBkZWxldGUgZG9jdW1lbnRzIGFzc29jaWF0ZWQgZGlyZWN0bHkgd2l0aCB0aGUgYnVpbGRpbmdcbiAgICAgICAgICBhd2FpdCB0eC5kZWxldGUoZG9jdW1lbnRzKS53aGVyZShlcShkb2N1bWVudHMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gNi4gRmluYWxseSwgc29mdCBkZWxldGUgdGhlIGJ1aWxkaW5nXG4gICAgICAgIGF3YWl0IHR4XG4gICAgICAgICAgLnVwZGF0ZShidWlsZGluZ3MpXG4gICAgICAgICAgLnNldCh7IGlzQWN0aXZlOiBmYWxzZSwgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpIH0pXG4gICAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCkpO1xuICAgICAgfSk7XG5cblxuICAgICAgLy8gQ2xlYW4gdXAgb2JqZWN0IHN0b3JhZ2UgaGllcmFyY2h5IGZvciB0aGUgZGVsZXRlZCBidWlsZGluZ1xuICAgICAgLy8gR2V0IG9yZ2FuaXphdGlvbiBJRCBmcm9tIGJ1aWxkaW5nIGJlZm9yZSBkZWxldGlvblxuICAgICAgY29uc3QgYnVpbGRpbmdPcmcgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHsgb3JnYW5pemF0aW9uSWQ6IGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCB9KVxuICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgIC53aGVyZShlcShidWlsZGluZ3MuaWQsIGJ1aWxkaW5nSWQpKVxuICAgICAgICAubGltaXQoMSk7XG5cbiAgICAgIGlmIChidWlsZGluZ09yZy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIE9iamVjdCBzdG9yYWdlIGNsZWFudXAgd2lsbCBiZSBoYW5kbGVkIGF1dG9tYXRpY2FsbHlcbiAgICAgICAgY29uc29sZS5sb2coJ0J1aWxkaW5nIGRlbGV0ZWQgLSBzdG9yYWdlIGNsZWFudXAgd2lsbCBiZSBoYW5kbGVkIGF1dG9tYXRpY2FsbHknKTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQnVpbGRpbmcgYW5kIHJlbGF0ZWQgZW50aXRpZXMgZGVsZXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICBkZWxldGVkQnVpbGRpbmc6IGJ1aWxkaW5nWzBdLm5hbWUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZHVyaW5nIGNhc2NhZGUgZGVsZXRlOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgX2Vycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBkZWxldGUgYnVpbGRpbmcgYW5kIHJlbGF0ZWQgZW50aXRpZXMnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==