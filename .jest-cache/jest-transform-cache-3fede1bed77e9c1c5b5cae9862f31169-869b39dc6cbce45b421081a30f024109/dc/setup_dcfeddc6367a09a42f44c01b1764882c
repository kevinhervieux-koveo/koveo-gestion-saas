b17434d6da4be00914583d821c5e5328
'use strict';
var patchFocus = require('../document/patchFocus.js');
var prepareDocument = require('../document/prepareDocument.js');
var dispatchEvent = require('../event/dispatchEvent.js');
var Clipboard = require('../utils/dataTransfer/Clipboard.js');
var getWindow = require('../utils/misc/getWindow.js');
var getDocumentFromNode = require('../utils/misc/getDocumentFromNode.js');
var level = require('../utils/misc/level.js');
var wait = require('../utils/misc/wait.js');
var options = require('../options.js');
require('@testing-library/dom');
var keyMap = require('../keyboard/keyMap.js');
var keyMap$1 = require('../pointer/keyMap.js');
var index = require('../system/index.js');
var api = require('./api.js');
var wrapAsync = require('./wrapAsync.js');
/**
 * Default options applied when API is called per `userEvent.anyApi()`
 */ const defaultOptionsDirect = {
    applyAccept: true,
    autoModify: true,
    delay: 0,
    document: globalThis.document,
    keyboardMap: keyMap.defaultKeyMap,
    pointerMap: keyMap$1.defaultKeyMap,
    pointerEventsCheck: options.PointerEventsCheckLevel.EachApiCall,
    skipAutoClose: false,
    skipClick: false,
    skipHover: false,
    writeToClipboard: false,
    advanceTimers: () => Promise.resolve()
};
/**
 * Default options applied when API is called per `userEvent().anyApi()`
 */ const defaultOptionsSetup = {
    ...defaultOptionsDirect,
    writeToClipboard: true
};
function createConfig(options = {}, defaults = defaultOptionsSetup, node) {
    const document = getDocument(options, node, defaults);
    return {
        ...defaults,
        ...options,
        document
    };
}
/**
 * Start a "session" with userEvent.
 * All APIs returned by this function share an input device state and a default configuration.
 */ function setupMain(options = {}) {
    const config = createConfig(options);
    prepareDocument.prepareDocument(config.document);
    patchFocus.patchFocus(getWindow.getWindow(config.document).HTMLElement);
    var _config_document_defaultView;
    const view = (_config_document_defaultView = config.document.defaultView) !== null && _config_document_defaultView !== undefined ? _config_document_defaultView : /* istanbul ignore next */ globalThis.window;
    Clipboard.attachClipboardStubToView(view);
    return createInstance(config).api;
}
/**
 * Setup in direct call per `userEvent.anyApi()`
 */ function setupDirect({ keyboardState, pointerState, ...options } = {}, node) {
    const config = createConfig(options, defaultOptionsDirect, node);
    prepareDocument.prepareDocument(config.document);
    patchFocus.patchFocus(getWindow.getWindow(config.document).HTMLElement);
    var _ref;
    const system = (_ref = pointerState !== null && pointerState !== undefined ? pointerState : keyboardState) !== null && _ref !== undefined ? _ref : new index.System();
    return {
        api: createInstance(config, system).api,
        system
    };
}
/**
 * Create a set of callbacks with different default settings but the same state.
 */ function setupSub(options) {
    return createInstance({
        ...this.config,
        ...options
    }, this.system).api;
}
function wrapAndBindImpl(instance, impl) {
    function method(...args) {
        level.setLevelRef(instance, level.ApiLevel.Call);
        return wrapAsync.wrapAsync(() => impl.apply(instance, args).then(async (ret) => {
            await wait.wait(instance.config);
            return ret;
        }));
    }
    Object.defineProperty(method, 'name', {
        get: () => impl.name
    });
    return method;
}
function createInstance(config, system = new index.System()) {
    const instance = {};
    Object.assign(instance, {
        config,
        dispatchEvent: dispatchEvent.dispatchEvent.bind(instance),
        dispatchUIEvent: dispatchEvent.dispatchUIEvent.bind(instance),
        system,
        levelRefs: {},
        ...api.userEventApi
    });
    return {
        instance,
        api: {
            ...Object.fromEntries(Object.entries(api.userEventApi).map(([name, api]) => [
                name,
                wrapAndBindImpl(instance, api)
            ])),
            setup: setupSub.bind(instance)
        }
    };
}
function getDocument(options, node, defaults) {
    var _options_document, _ref;
    return (_ref = (_options_document = options.document) !== null && _options_document !== undefined ? _options_document : node && getDocumentFromNode.getDocumentFromNode(node)) !== null && _ref !== undefined ? _ref : defaults.document;
}
exports.createConfig = createConfig;
exports.createInstance = createInstance;
exports.setupDirect = setupDirect;
exports.setupMain = setupMain;
exports.setupSub = setupSub;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3NldHVwL3NldHVwLmpzIiwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3RELElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2hFLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3pELElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQzlELElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RELElBQUksbUJBQW1CLEdBQUcsT0FBTyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7QUFDMUUsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDOUMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDNUMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3ZDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2hDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQzlDLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQy9DLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQzFDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUM5QixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUUxQzs7R0FFRyxDQUFDLE1BQU0sb0JBQW9CLEdBQUc7SUFDN0IsV0FBVyxFQUFFLElBQUk7SUFDakIsVUFBVSxFQUFFLElB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L3J1bm5lci93b3Jrc3BhY2Uvbm9kZV9tb2R1bGVzL0B0ZXN0aW5nLWxpYnJhcnkvdXNlci1ldmVudC9kaXN0L2Nqcy9zZXR1cC9zZXR1cC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBwYXRjaEZvY3VzID0gcmVxdWlyZSgnLi4vZG9jdW1lbnQvcGF0Y2hGb2N1cy5qcycpO1xudmFyIHByZXBhcmVEb2N1bWVudCA9IHJlcXVpcmUoJy4uL2RvY3VtZW50L3ByZXBhcmVEb2N1bWVudC5qcycpO1xudmFyIGRpc3BhdGNoRXZlbnQgPSByZXF1aXJlKCcuLi9ldmVudC9kaXNwYXRjaEV2ZW50LmpzJyk7XG52YXIgQ2xpcGJvYXJkID0gcmVxdWlyZSgnLi4vdXRpbHMvZGF0YVRyYW5zZmVyL0NsaXBib2FyZC5qcycpO1xudmFyIGdldFdpbmRvdyA9IHJlcXVpcmUoJy4uL3V0aWxzL21pc2MvZ2V0V2luZG93LmpzJyk7XG52YXIgZ2V0RG9jdW1lbnRGcm9tTm9kZSA9IHJlcXVpcmUoJy4uL3V0aWxzL21pc2MvZ2V0RG9jdW1lbnRGcm9tTm9kZS5qcycpO1xudmFyIGxldmVsID0gcmVxdWlyZSgnLi4vdXRpbHMvbWlzYy9sZXZlbC5qcycpO1xudmFyIHdhaXQgPSByZXF1aXJlKCcuLi91dGlscy9taXNjL3dhaXQuanMnKTtcbnZhciBvcHRpb25zID0gcmVxdWlyZSgnLi4vb3B0aW9ucy5qcycpO1xucmVxdWlyZSgnQHRlc3RpbmctbGlicmFyeS9kb20nKTtcbnZhciBrZXlNYXAgPSByZXF1aXJlKCcuLi9rZXlib2FyZC9rZXlNYXAuanMnKTtcbnZhciBrZXlNYXAkMSA9IHJlcXVpcmUoJy4uL3BvaW50ZXIva2V5TWFwLmpzJyk7XG52YXIgaW5kZXggPSByZXF1aXJlKCcuLi9zeXN0ZW0vaW5kZXguanMnKTtcbnZhciBhcGkgPSByZXF1aXJlKCcuL2FwaS5qcycpO1xudmFyIHdyYXBBc3luYyA9IHJlcXVpcmUoJy4vd3JhcEFzeW5jLmpzJyk7XG5cbi8qKlxuICogRGVmYXVsdCBvcHRpb25zIGFwcGxpZWQgd2hlbiBBUEkgaXMgY2FsbGVkIHBlciBgdXNlckV2ZW50LmFueUFwaSgpYFxuICovIGNvbnN0IGRlZmF1bHRPcHRpb25zRGlyZWN0ID0ge1xuICAgIGFwcGx5QWNjZXB0OiB0cnVlLFxuICAgIGF1dG9Nb2RpZnk6IHRydWUsXG4gICAgZGVsYXk6IDAsXG4gICAgZG9jdW1lbnQ6IGdsb2JhbFRoaXMuZG9jdW1lbnQsXG4gICAga2V5Ym9hcmRNYXA6IGtleU1hcC5kZWZhdWx0S2V5TWFwLFxuICAgIHBvaW50ZXJNYXA6IGtleU1hcCQxLmRlZmF1bHRLZXlNYXAsXG4gICAgcG9pbnRlckV2ZW50c0NoZWNrOiBvcHRpb25zLlBvaW50ZXJFdmVudHNDaGVja0xldmVsLkVhY2hBcGlDYWxsLFxuICAgIHNraXBBdXRvQ2xvc2U6IGZhbHNlLFxuICAgIHNraXBDbGljazogZmFsc2UsXG4gICAgc2tpcEhvdmVyOiBmYWxzZSxcbiAgICB3cml0ZVRvQ2xpcGJvYXJkOiBmYWxzZSxcbiAgICBhZHZhbmNlVGltZXJzOiAoKT0+UHJvbWlzZS5yZXNvbHZlKClcbn07XG4vKipcbiAqIERlZmF1bHQgb3B0aW9ucyBhcHBsaWVkIHdoZW4gQVBJIGlzIGNhbGxlZCBwZXIgYHVzZXJFdmVudCgpLmFueUFwaSgpYFxuICovIGNvbnN0IGRlZmF1bHRPcHRpb25zU2V0dXAgPSB7XG4gICAgLi4uZGVmYXVsdE9wdGlvbnNEaXJlY3QsXG4gICAgd3JpdGVUb0NsaXBib2FyZDogdHJ1ZVxufTtcbmZ1bmN0aW9uIGNyZWF0ZUNvbmZpZyhvcHRpb25zID0ge30sIGRlZmF1bHRzID0gZGVmYXVsdE9wdGlvbnNTZXR1cCwgbm9kZSkge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gZ2V0RG9jdW1lbnQob3B0aW9ucywgbm9kZSwgZGVmYXVsdHMpO1xuICAgIHJldHVybiB7XG4gICAgICAgIC4uLmRlZmF1bHRzLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICBkb2N1bWVudFxuICAgIH07XG59XG4vKipcbiAqIFN0YXJ0IGEgXCJzZXNzaW9uXCIgd2l0aCB1c2VyRXZlbnQuXG4gKiBBbGwgQVBJcyByZXR1cm5lZCBieSB0aGlzIGZ1bmN0aW9uIHNoYXJlIGFuIGlucHV0IGRldmljZSBzdGF0ZSBhbmQgYSBkZWZhdWx0IGNvbmZpZ3VyYXRpb24uXG4gKi8gZnVuY3Rpb24gc2V0dXBNYWluKG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IGNvbmZpZyA9IGNyZWF0ZUNvbmZpZyhvcHRpb25zKTtcbiAgICBwcmVwYXJlRG9jdW1lbnQucHJlcGFyZURvY3VtZW50KGNvbmZpZy5kb2N1bWVudCk7XG4gICAgcGF0Y2hGb2N1cy5wYXRjaEZvY3VzKGdldFdpbmRvdy5nZXRXaW5kb3coY29uZmlnLmRvY3VtZW50KS5IVE1MRWxlbWVudCk7XG4gICAgdmFyIF9jb25maWdfZG9jdW1lbnRfZGVmYXVsdFZpZXc7XG4gICAgY29uc3QgdmlldyA9IChfY29uZmlnX2RvY3VtZW50X2RlZmF1bHRWaWV3ID0gY29uZmlnLmRvY3VtZW50LmRlZmF1bHRWaWV3KSAhPT0gbnVsbCAmJiBfY29uZmlnX2RvY3VtZW50X2RlZmF1bHRWaWV3ICE9PSB1bmRlZmluZWQgPyBfY29uZmlnX2RvY3VtZW50X2RlZmF1bHRWaWV3IDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gZ2xvYmFsVGhpcy53aW5kb3c7XG4gICAgQ2xpcGJvYXJkLmF0dGFjaENsaXBib2FyZFN0dWJUb1ZpZXcodmlldyk7XG4gICAgcmV0dXJuIGNyZWF0ZUluc3RhbmNlKGNvbmZpZykuYXBpO1xufVxuLyoqXG4gKiBTZXR1cCBpbiBkaXJlY3QgY2FsbCBwZXIgYHVzZXJFdmVudC5hbnlBcGkoKWBcbiAqLyBmdW5jdGlvbiBzZXR1cERpcmVjdCh7IGtleWJvYXJkU3RhdGUsIHBvaW50ZXJTdGF0ZSwgLi4ub3B0aW9ucyB9ID0ge30sIG5vZGUpIHtcbiAgICBjb25zdCBjb25maWcgPSBjcmVhdGVDb25maWcob3B0aW9ucywgZGVmYXVsdE9wdGlvbnNEaXJlY3QsIG5vZGUpO1xuICAgIHByZXBhcmVEb2N1bWVudC5wcmVwYXJlRG9jdW1lbnQoY29uZmlnLmRvY3VtZW50KTtcbiAgICBwYXRjaEZvY3VzLnBhdGNoRm9jdXMoZ2V0V2luZG93LmdldFdpbmRvdyhjb25maWcuZG9jdW1lbnQpLkhUTUxFbGVtZW50KTtcbiAgICB2YXIgX3JlZjtcbiAgICBjb25zdCBzeXN0ZW0gPSAoX3JlZiA9IHBvaW50ZXJTdGF0ZSAhPT0gbnVsbCAmJiBwb2ludGVyU3RhdGUgIT09IHVuZGVmaW5lZCA/IHBvaW50ZXJTdGF0ZSA6IGtleWJvYXJkU3RhdGUpICE9PSBudWxsICYmIF9yZWYgIT09IHVuZGVmaW5lZCA/IF9yZWYgOiBuZXcgaW5kZXguU3lzdGVtKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgYXBpOiBjcmVhdGVJbnN0YW5jZShjb25maWcsIHN5c3RlbSkuYXBpLFxuICAgICAgICBzeXN0ZW1cbiAgICB9O1xufVxuLyoqXG4gKiBDcmVhdGUgYSBzZXQgb2YgY2FsbGJhY2tzIHdpdGggZGlmZmVyZW50IGRlZmF1bHQgc2V0dGluZ3MgYnV0IHRoZSBzYW1lIHN0YXRlLlxuICovIGZ1bmN0aW9uIHNldHVwU3ViKG9wdGlvbnMpIHtcbiAgICByZXR1cm4gY3JlYXRlSW5zdGFuY2Uoe1xuICAgICAgICAuLi50aGlzLmNvbmZpZyxcbiAgICAgICAgLi4ub3B0aW9uc1xuICAgIH0sIHRoaXMuc3lzdGVtKS5hcGk7XG59XG5mdW5jdGlvbiB3cmFwQW5kQmluZEltcGwoaW5zdGFuY2UsIGltcGwpIHtcbiAgICBmdW5jdGlvbiBtZXRob2QoLi4uYXJncykge1xuICAgICAgICBsZXZlbC5zZXRMZXZlbFJlZihpbnN0YW5jZSwgbGV2ZWwuQXBpTGV2ZWwuQ2FsbCk7XG4gICAgICAgIHJldHVybiB3cmFwQXN5bmMud3JhcEFzeW5jKCgpPT5pbXBsLmFwcGx5KGluc3RhbmNlLCBhcmdzKS50aGVuKGFzeW5jIChyZXQpPT57XG4gICAgICAgICAgICAgICAgYXdhaXQgd2FpdC53YWl0KGluc3RhbmNlLmNvbmZpZyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG1ldGhvZCwgJ25hbWUnLCB7XG4gICAgICAgIGdldDogKCk9PmltcGwubmFtZVxuICAgIH0pO1xuICAgIHJldHVybiBtZXRob2Q7XG59XG5mdW5jdGlvbiBjcmVhdGVJbnN0YW5jZShjb25maWcsIHN5c3RlbSA9IG5ldyBpbmRleC5TeXN0ZW0oKSkge1xuICAgIGNvbnN0IGluc3RhbmNlID0ge307XG4gICAgT2JqZWN0LmFzc2lnbihpbnN0YW5jZSwge1xuICAgICAgICBjb25maWcsXG4gICAgICAgIGRpc3BhdGNoRXZlbnQ6IGRpc3BhdGNoRXZlbnQuZGlzcGF0Y2hFdmVudC5iaW5kKGluc3RhbmNlKSxcbiAgICAgICAgZGlzcGF0Y2hVSUV2ZW50OiBkaXNwYXRjaEV2ZW50LmRpc3BhdGNoVUlFdmVudC5iaW5kKGluc3RhbmNlKSxcbiAgICAgICAgc3lzdGVtLFxuICAgICAgICBsZXZlbFJlZnM6IHt9LFxuICAgICAgICAuLi5hcGkudXNlckV2ZW50QXBpXG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaW5zdGFuY2UsXG4gICAgICAgIGFwaToge1xuICAgICAgICAgICAgLi4uT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKGFwaS51c2VyRXZlbnRBcGkpLm1hcCgoW25hbWUsIGFwaV0pPT5bXG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHdyYXBBbmRCaW5kSW1wbChpbnN0YW5jZSwgYXBpKVxuICAgICAgICAgICAgICAgIF0pKSxcbiAgICAgICAgICAgIHNldHVwOiBzZXR1cFN1Yi5iaW5kKGluc3RhbmNlKVxuICAgICAgICB9XG4gICAgfTtcbn1cbmZ1bmN0aW9uIGdldERvY3VtZW50KG9wdGlvbnMsIG5vZGUsIGRlZmF1bHRzKSB7XG4gICAgdmFyIF9vcHRpb25zX2RvY3VtZW50LCBfcmVmO1xuICAgIHJldHVybiAoX3JlZiA9IChfb3B0aW9uc19kb2N1bWVudCA9IG9wdGlvbnMuZG9jdW1lbnQpICE9PSBudWxsICYmIF9vcHRpb25zX2RvY3VtZW50ICE9PSB1bmRlZmluZWQgPyBfb3B0aW9uc19kb2N1bWVudCA6IG5vZGUgJiYgZ2V0RG9jdW1lbnRGcm9tTm9kZS5nZXREb2N1bWVudEZyb21Ob2RlKG5vZGUpKSAhPT0gbnVsbCAmJiBfcmVmICE9PSB1bmRlZmluZWQgPyBfcmVmIDogZGVmYXVsdHMuZG9jdW1lbnQ7XG59XG5cbmV4cG9ydHMuY3JlYXRlQ29uZmlnID0gY3JlYXRlQ29uZmlnO1xuZXhwb3J0cy5jcmVhdGVJbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlO1xuZXhwb3J0cy5zZXR1cERpcmVjdCA9IHNldHVwRGlyZWN0O1xuZXhwb3J0cy5zZXR1cE1haW4gPSBzZXR1cE1haW47XG5leHBvcnRzLnNldHVwU3ViID0gc2V0dXBTdWI7XG4iXSwidmVyc2lvbiI6M30=