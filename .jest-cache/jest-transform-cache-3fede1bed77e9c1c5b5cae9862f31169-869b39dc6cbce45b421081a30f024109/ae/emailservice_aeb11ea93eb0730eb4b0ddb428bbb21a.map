{"file":"/home/runner/workspace/server/services/email-service.ts","mappings":"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","names":[],"sources":["/home/runner/workspace/server/services/email-service.ts"],"sourcesContent":["import { MailService } from '@sendgrid/mail';\n\n/**\n * Email service for Quebec-compliant transactional emails using SendGrid.\n * Handles password resets, invitations, and other security-related communications.\n */\nclass EmailService {\n  private mailService: MailService;\n  private fromEmail: string = 'info@koveo-gestion.com';\n  private fromName: string = 'Koveo Gestion';\n\n  /**\n   * Initializes the EmailService with SendGrid configuration.\n   * Validates that the SENDGRID_API_KEY environment variable is set.\n   *\n   * @throws {Error} When SENDGRID_API_KEY environment variable is not set.\n   *\n   * @example\n   * ```typescript\n   * const emailService = new EmailService();\n   * await emailService.sendPasswordResetEmail('user@example.com', 'John', 'https://reset-url');\n   * ```\n   */\n  constructor() {\n    if (!process.env.SENDGRID_API_KEY) {\n      throw new Error('SENDGRID_API_KEY environment variable must be set');\n    }\n\n    this.mailService = new MailService();\n    this.mailService.setApiKey(process.env.SENDGRID_API_KEY);\n  }\n\n  /**\n   * Sends password reset email in French or English with Quebec Law 25 compliance.\n   * Link tracking is disabled for direct URL access as required by security protocols.\n   *\n   * @param {string} to - Recipient email address.\n   * @param {string} userName - User's display name for personalization.\n   * @param {string} resetUrl - Complete password reset URL with token.\n   * @param {'fr' | 'en'} [language='fr'] - Email language (defaults to French for Quebec).\n   * @returns {Promise<boolean>} Promise resolving to true if email sent successfully.\n   *\n   * @throws {Error} When SendGrid API fails or invalid parameters provided.\n   *\n   * @example\n   * ```typescript\n   * const emailService = new EmailService();\n   * const success = await emailService.sendPasswordResetEmail(\n   *   'user@example.com',\n   *   'Jean Dupont',\n   *   'https://app.koveo.com/reset-password?token=abc123',\n   *   'fr'\n   * );\n   * ```\n   */\n  async sendPasswordResetEmail(\n    to: string,\n    userName: string,\n    resetUrl: string,\n    language: 'fr' | 'en' = 'fr'\n  ): Promise<boolean> {\n    try {\n      const templates = {\n        fr: {\n          subject: 'Réinitialisation de votre mot de passe - Koveo Gestion',\n          html: `\n            <!DOCTYPE html>\n            <html>\n            <head>\n              <meta charset=\"UTF-8\">\n              <title>Réinitialisation de mot de passe</title>\n            </head>\n            <body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n              <div style=\"background: #f8f9fa; padding: 30px; border-radius: 8px;\">\n                <h1 style=\"color: #2563eb; margin-bottom: 20px;\">Koveo Gestion</h1>\n                \n                <h2 style=\"color: #374151;\">Réinitialisation de votre mot de passe</h2>\n                \n                <p>Bonjour ${userName},</p>\n                \n                <p>Vous avez demandé la réinitialisation de votre mot de passe pour votre compte Koveo Gestion.</p>\n                \n                <p>Copiez et collez ce lien dans votre navigateur pour réinitialiser votre mot de passe :</p>\n                \n                <div style=\"background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0; word-break: break-all;\">\n                  <code style=\"font-size: 14px; color: #374151;\">${resetUrl}</code>\n                </div>\n                \n                <p style=\"text-align: center; margin: 20px 0;\">\n                  <strong style=\"color: #dc2626;\">Important:</strong> Ce lien expire dans 1 heure.\n                </p>\n                \n                <p><strong>Ce lien expire dans 1 heure pour votre sécurité.</strong></p>\n                \n                <p>Si vous n'avez pas demandé cette réinitialisation, ignorez ce courriel.</p>\n                \n                <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;\">\n                \n                <div style=\"font-size: 12px; color: #6b7280;\">\n                  <p><strong>Confidentialité & Sécurité</strong></p>\n                  <p>Conforme à la Loi 25 du Québec. Vos données personnelles sont protégées selon les normes de sécurité les plus strictes.</p>\n                  \n                  <p>© 2025 Koveo Gestion. Tous droits réservés.</p>\n                </div>\n              </div>\n            </body>\n            </html>\n          `,\n          text: `Réinitialisation de votre mot de passe - Koveo Gestion\n\nBonjour ${userName},\n\nVous avez demandé la réinitialisation de votre mot de passe pour votre compte Koveo Gestion.\n\nCliquez sur ce lien pour créer un nouveau mot de passe :\n${resetUrl}\n\nCe lien expire dans 1 heure pour votre sécurité.\n\nSi vous n'avez pas demandé cette réinitialisation, ignorez ce courriel.\n\nConforme à la Loi 25 du Québec. Vos données personnelles sont protégées selon les normes de sécurité les plus strictes.\n\n© 2025 Koveo Gestion. Tous droits réservés.`,\n        },\n        en: {\n          subject: 'Password Reset - Koveo Gestion',\n          html: `\n            <!DOCTYPE html>\n            <html>\n            <head>\n              <meta charset=\"UTF-8\">\n              <title>Password Reset</title>\n            </head>\n            <body style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n              <div style=\"background: #f8f9fa; padding: 30px; border-radius: 8px;\">\n                <h1 style=\"color: #2563eb; margin-bottom: 20px;\">Koveo Gestion</h1>\n                \n                <h2 style=\"color: #374151;\">Reset Your Password</h2>\n                \n                <p>Hello ${userName},</p>\n                \n                <p>You have requested to reset your password for your Koveo Gestion account.</p>\n                \n                <p>Copy and paste this link into your browser to reset your password:</p>\n                \n                <div style=\"background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0; word-break: break-all;\">\n                  <code style=\"font-size: 14px; color: #374151;\">${resetUrl}</code>\n                </div>\n                \n                <p style=\"text-align: center; margin: 20px 0;\">\n                  <strong style=\"color: #dc2626;\">Important:</strong> This link expires in 1 hour.\n                </p>\n                \n                <p><strong>This link expires in 1 hour for your security.</strong></p>\n                \n                <p>If you did not request this reset, please ignore this email.</p>\n                \n                <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;\">\n                \n                <div style=\"font-size: 12px; color: #6b7280;\">\n                  <p><strong>Privacy & Security</strong></p>\n                  <p>Quebec Law 25 compliant. Your personal data is protected according to the strictest security standards.</p>\n                  \n                  <p>© 2025 Koveo Gestion. All rights reserved.</p>\n                </div>\n              </div>\n            </body>\n            </html>\n          `,\n          text: `Password Reset - Koveo Gestion\n\nHello ${userName},\n\nYou have requested to reset your password for your Koveo Gestion account.\n\nClick this link to create a new password:\n${resetUrl}\n\nThis link expires in 1 hour for your security.\n\nIf you did not request this reset, please ignore this email.\n\nQuebec Law 25 compliant. Your personal data is protected according to the strictest security standards.\n\n© 2025 Koveo Gestion. All rights reserved.`,\n        },\n      };\n\n      const template = templates[language];\n\n\n      await this.mailService.send({\n        to,\n        from: {\n          email: this.fromEmail,\n          name: this.fromName,\n        },\n        subject: template.subject,\n        text: template.text,\n        html: template.html,\n        mailSettings: {\n          bypassListManagement: {\n            enable: false,\n          },\n          footer: {\n            enable: false,\n          },\n          sandboxMode: {\n            enable: false,\n          },\n        },\n        trackingSettings: {\n          clickTracking: {\n            enable: false,\n            enableText: false,\n          },\n          openTracking: {\n            enable: false,\n          },\n          subscriptionTracking: {\n            enable: false,\n          },\n          ganalytics: {\n            enable: false,\n          },\n        },\n      });\n\n      return true;\n    } catch (error: any) {\n      console.error('❌ Error sending email:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Sends an invitation email to a new user with their invitation link.\n   *\n   * @param {string} to - Recipient's email address.\n   * @param {string} recipientName - Name of the person being invited.\n   * @param {string} token - Invitation token for the registration URL.\n   * @param {string} organizationName - Name of the organization they're being invited to.\n   * @param {string} inviterName - Name of the person sending the invitation.\n   * @param {Date} expiresAt - When the invitation expires.\n   * @param {string} language - Language preference (en/fr).\n   * @param {string} personalMessage - Optional personal message from inviter.\n   * @returns {Promise<boolean>} Promise resolving to true if email sent successfully.\n   */\n  async sendInvitationEmail(\n    to: string,\n    recipientName: string,\n    token: string,\n    organizationName: string,\n    inviterName: string,\n    expiresAt: Date,\n    language: string = 'fr',\n    personalMessage?: string\n  ): Promise<boolean> {\n    try {\n      // Smart environment detection for invitation URLs\n      const isDevelopment = process.env.NODE_ENV !== 'production';\n      let baseUrl;\n\n      if (isDevelopment) {\n        // For development: use the exact replit domain from REPLIT_DOMAINS\n        const replitUrl = process.env.REPLIT_DOMAINS\n          ? `https://${process.env.REPLIT_DOMAINS}`\n          : null;\n        baseUrl = replitUrl || 'http://localhost:5000';\n      } else {\n        // For production: use configured frontend URL\n        baseUrl = process.env.FRONTEND_URL || 'http://localhost:5000';\n      }\n      const invitationUrl = `${baseUrl}/register?invitation=${token}`;\n      const expiryDate = expiresAt.toLocaleDateString(language === 'fr' ? 'fr-CA' : 'en-CA');\n\n      const isFrench = language === 'fr';\n\n      const subject = isFrench\n        ? `Invitation à rejoindre ${organizationName} - Koveo Gestion`\n        : `Invitation to join ${organizationName} - Koveo Gestion`;\n\n      const htmlContent = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <h2 style=\"color: #2563eb;\">${isFrench ? 'Invitation à Koveo Gestion' : 'Koveo Gestion Invitation'}</h2>\n          \n          <p>${isFrench ? 'Bonjour' : 'Hello'} ${recipientName},</p>\n          \n          <p>${\n            isFrench\n              ? `${inviterName} vous invite à rejoindre <strong>${organizationName}</strong> sur Koveo Gestion.`\n              : `${inviterName} has invited you to join <strong>${organizationName}</strong> on Koveo Gestion.`\n          }</p>\n\n          ${\n            personalMessage\n              ? `<div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;\">\n            <p style=\"margin: 0;\"><strong>${isFrench ? 'Message personnel' : 'Personal message'}:</strong></p>\n            <p style=\"margin: 10px 0 0 0; font-style: italic;\">\"${personalMessage}\"</p>\n          </div>`\n              : ''\n          }\n          \n          <p>${\n            isFrench\n              ? 'Pour créer votre compte et accepter cette invitation, cliquez sur le bouton ci-dessous :'\n              : 'To create your account and accept this invitation, click the button below:'\n          }</p>\n          \n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${invitationUrl}\" \n               style=\"background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              ${isFrench ? 'Créer mon compte' : 'Create My Account'}\n            </a>\n          </div>\n          \n          <p style=\"color: #6b7280; font-size: 14px;\">\n            ${\n              isFrench\n                ? `Cette invitation expire le ${expiryDate}. Si vous ne pouvez pas cliquer sur le bouton, copiez et collez ce lien dans votre navigateur :`\n                : `This invitation expires on ${expiryDate}. If you can't click the button, copy and paste this link into your browser:`\n            }\n          </p>\n          \n          <p style=\"word-break: break-all; background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 12px;\">\n            ${invitationUrl}\n          </p>\n          \n          <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #e5e7eb;\">\n          \n          <p style=\"color: #9ca3af; font-size: 12px;\">\n            ${\n              isFrench\n                ? \"Cet email a été envoyé par Koveo Gestion. Si vous n'avez pas demandé cette invitation, vous pouvez ignorer cet email.\"\n                : 'This email was sent by Koveo Gestion. If you did not request this invitation, you can safely ignore this email.'\n            }\n          </p>\n        </div>\n      `;\n\n      const textContent = `\n        ${isFrench ? 'Bonjour' : 'Hello'} ${recipientName},\n\n        ${\n          isFrench\n            ? `${inviterName} vous invite à rejoindre ${organizationName} sur Koveo Gestion.`\n            : `${inviterName} has invited you to join ${organizationName} on Koveo Gestion.`\n        }\n\n        ${personalMessage ? `${isFrench ? 'Message personnel' : 'Personal message'}: \"${personalMessage}\"` : ''}\n\n        ${\n          isFrench\n            ? 'Pour créer votre compte et accepter cette invitation, visitez :'\n            : 'To create your account and accept this invitation, visit:'\n        }\n        ${invitationUrl}\n\n        ${\n          isFrench\n            ? `Cette invitation expire le ${expiryDate}.`\n            : `This invitation expires on ${expiryDate}.`\n        }\n\n        ${\n          isFrench\n            ? \"Si vous n'avez pas demandé cette invitation, vous pouvez ignorer cet email.\"\n            : 'If you did not request this invitation, you can safely ignore this email.'\n        }\n      `;\n\n      await this.mailService.send({\n        to,\n        from: {\n          email: this.fromEmail,\n          name: this.fromName,\n        },\n        subject,\n        text: textContent.trim(),\n        html: htmlContent,\n        trackingSettings: {\n          clickTracking: {\n            enable: false,\n          },\n          openTracking: {\n            enable: false,\n          },\n          subscriptionTracking: {\n            enable: false,\n          },\n          ganalytics: {\n            enable: false,\n          },\n        },\n      });\n\n      return true;\n    } catch (error: any) {\n      console.error('❌ Error details:', JSON.stringify(error, null, 2));\n      return false;\n    }\n  }\n\n  /**\n   * Sends a reminder email for pending invitations.\n   *\n   * @param {string} to - Recipient's email address.\n   * @param {string} recipientName - Name of the person being reminded.\n   * @param {string} token - Invitation token for the registration URL.\n   * @param {string} organizationName - Name of the organization they're being invited to.\n   * @param {Date} expiresAt - When the invitation expires.\n   * @param {string} language - Language preference (en/fr).\n   * @returns {Promise<boolean>} Promise resolving to true if email sent successfully.\n   */\n  async sendReminderEmail(\n    to: string,\n    recipientName: string,\n    token: string,\n    organizationName: string,\n    expiresAt: Date,\n    language: string = 'fr'\n  ): Promise<boolean> {\n    try {\n      // Smart environment detection for invitation URLs\n      const isDevelopment = process.env.NODE_ENV !== 'production';\n      let baseUrl;\n\n      if (isDevelopment) {\n        const replitUrl = process.env.REPLIT_DOMAINS\n          ? `https://${process.env.REPLIT_DOMAINS}`\n          : null;\n        baseUrl = replitUrl || 'http://localhost:5000';\n      } else {\n        baseUrl = process.env.FRONTEND_URL || 'http://localhost:5000';\n      }\n      const invitationUrl = `${baseUrl}/register?invitation=${token}`;\n      const expiryDate = expiresAt.toLocaleDateString(language === 'fr' ? 'fr-CA' : 'en-CA');\n\n      const isFrench = language === 'fr';\n\n      const subject = isFrench\n        ? `Rappel: Invitation à rejoindre ${organizationName} - Koveo Gestion`\n        : `Reminder: Invitation to join ${organizationName} - Koveo Gestion`;\n\n      const htmlContent = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <h2 style=\"color: #2563eb;\">${isFrench ? 'Rappel d\\'invitation - Koveo Gestion' : 'Invitation Reminder - Koveo Gestion'}</h2>\n          \n          <p>${isFrench ? 'Bonjour' : 'Hello'} ${recipientName},</p>\n          \n          <p>${\n            isFrench\n              ? `Ceci est un rappel concernant votre invitation à rejoindre <strong>${organizationName}</strong> sur Koveo Gestion.`\n              : `This is a reminder about your invitation to join <strong>${organizationName}</strong> on Koveo Gestion.`\n          }</p>\n          \n          <p>${\n            isFrench\n              ? 'Votre invitation expire bientôt. Pour créer votre compte, cliquez sur le bouton ci-dessous :'\n              : 'Your invitation expires soon. To create your account, click the button below:'\n          }</p>\n          \n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${invitationUrl}\" \n               style=\"background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              ${isFrench ? 'Créer mon compte' : 'Create My Account'}\n            </a>\n          </div>\n          \n          <p style=\"color: #dc2626; font-weight: bold;\">\n            ${\n              isFrench\n                ? `⚠️ Cette invitation expire le ${expiryDate}.`\n                : `⚠️ This invitation expires on ${expiryDate}.`\n            }\n          </p>\n          \n          <p style=\"word-break: break-all; background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 12px;\">\n            ${invitationUrl}\n          </p>\n          \n          <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #e5e7eb;\">\n          \n          <p style=\"color: #9ca3af; font-size: 12px;\">\n            ${\n              isFrench\n                ? \"Cet email a été envoyé par Koveo Gestion.\"\n                : 'This email was sent by Koveo Gestion.'\n            }\n          </p>\n        </div>\n      `;\n\n      const textContent = `\n        ${isFrench ? 'Bonjour' : 'Hello'} ${recipientName},\n\n        ${\n          isFrench\n            ? `Ceci est un rappel concernant votre invitation à rejoindre ${organizationName} sur Koveo Gestion.`\n            : `This is a reminder about your invitation to join ${organizationName} on Koveo Gestion.`\n        }\n\n        ${\n          isFrench\n            ? 'Pour créer votre compte et accepter cette invitation, visitez :'\n            : 'To create your account and accept this invitation, visit:'\n        }\n        ${invitationUrl}\n\n        ${\n          isFrench\n            ? `Cette invitation expire le ${expiryDate}.`\n            : `This invitation expires on ${expiryDate}.`\n        }\n      `;\n\n      await this.mailService.send({\n        to,\n        from: {\n          email: this.fromEmail,\n          name: this.fromName,\n        },\n        subject,\n        text: textContent.trim(),\n        html: htmlContent,\n        trackingSettings: {\n          clickTracking: {\n            enable: false,\n          },\n          openTracking: {\n            enable: false,\n          },\n          subscriptionTracking: {\n            enable: false,\n          },\n          ganalytics: {\n            enable: false,\n          },\n        },\n      });\n\n      return true;\n    } catch (error: any) {\n      console.error('❌ Error sending reminder email:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Verifies an unsubscribe token for security.\n   *\n   * @param {string} email - Email address to verify token for.\n   * @param {string} token - Unsubscribe token to verify.\n   * @returns {boolean} True if token is valid.\n   */\n  verifyUnsubscribeToken(email: string, token: string): boolean {\n    try {\n      // Simple token verification - in production you'd use proper crypto\n      const expectedToken = Buffer.from(email).toString('base64');\n      return token === expectedToken;\n    } catch (error: any) {\n      console.error('❌ Error verifying unsubscribe token:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Sends a test email to verify SendGrid configuration and connectivity.\n   * Used for troubleshooting email delivery issues and validating API setup.\n   *\n   * @param {string} to - Recipient email address for the test email.\n   * @returns {Promise<boolean>} Promise resolving to true if test email sent successfully.\n   *\n   * @example\n   * ```typescript\n   * const emailService = new EmailService();\n   * const success = await emailService.sendTestEmail('admin@example.com');\n   * if (success) {\n   * }\n   * ```\n   */\n  async sendTestEmail(to: string): Promise<boolean> {\n    try {\n      await this.mailService.send({\n        to,\n        from: {\n          email: this.fromEmail,\n          name: this.fromName,\n        },\n        subject: 'Test Email - Koveo Gestion',\n        text: 'This is a test email to verify SendGrid configuration.',\n        html: '<p>This is a test email to verify SendGrid configuration.</p>',\n      });\n\n      return true;\n    } catch (error: any) {\n      console.error('❌ Error sending email:', error);\n      return false;\n    }\n  }\n}\n\n// Create singleton instance\nexport const emailService = new EmailService();\nexport { EmailService };\n"],"version":3}