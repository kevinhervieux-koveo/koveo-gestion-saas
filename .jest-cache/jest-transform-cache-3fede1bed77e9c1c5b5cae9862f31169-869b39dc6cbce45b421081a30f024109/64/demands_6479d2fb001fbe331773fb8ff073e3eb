205eab6afbafe24721ad62f05ef98457
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerDemandRoutes = registerDemandRoutes;
const db_1 = require("../db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const index_1 = require("../auth/index");
const operations_1 = require("../../shared/schemas/operations");
/**
 * Register demand routes for managing resident demands and complaints.
 *
 * @param app - Express application instance.
 */
/**
 * RegisterDemandRoutes function.
 * @param app
 * @returns Function result.
 */
function registerDemandRoutes(app) {
    // Get demands for a user (residents and managers)
    app.get('/api/demands', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const { buildingId, residenceId, type, status, search } = req.query;
            // Base query with joins
            let query = db_1.db
                .select({
                id: schema_1.demands.id,
                submitterId: schema_1.demands.submitterId,
                type: schema_1.demands.type,
                assignationResidenceId: schema_1.demands.assignationResidenceId,
                assignationBuildingId: schema_1.demands.assignationBuildingId,
                description: schema_1.demands.description,
                attachments: schema_1.demands.attachments,
                residenceId: schema_1.demands.residenceId,
                buildingId: schema_1.demands.buildingId,
                status: schema_1.demands.status,
                reviewedBy: schema_1.demands.reviewedBy,
                reviewedAt: schema_1.demands.reviewedAt,
                reviewNotes: schema_1.demands.reviewNotes,
                createdAt: schema_1.demands.createdAt,
                updatedAt: schema_1.demands.updatedAt,
                submitter: {
                    id: schema_1.users.id,
                    firstName: schema_1.users.firstName,
                    lastName: schema_1.users.lastName,
                    email: schema_1.users.email,
                },
                residence: {
                    id: schema_1.residences.id,
                    unitNumber: schema_1.residences.unitNumber,
                    buildingId: schema_1.residences.buildingId,
                },
                building: {
                    id: schema_1.buildings.id,
                    name: schema_1.buildings.name,
                    address: schema_1.buildings.address,
                },
            })
                .from(schema_1.demands)
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.demands.submitterId, schema_1.users.id))
                .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.demands.residenceId, schema_1.residences.id))
                .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.demands.buildingId, schema_1.buildings.id));
            // Apply filters - all users only see demands they created
            const conditions = [(0, drizzle_orm_1.eq)(schema_1.demands.submitterId, user.id)];
            // Add filter conditions
            if (buildingId) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.demands.buildingId, buildingId));
            }
            if (residenceId) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.demands.residenceId, residenceId));
            }
            if (type) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.demands.type, type));
            }
            if (status) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.demands.status, status));
            }
            // Apply conditions to query if any exist
            let finalQuery;
            if (conditions.length > 0) {
                finalQuery = query.where((0, drizzle_orm_1.and)(...conditions));
            }
            else {
                finalQuery = query;
            }
            const results = await finalQuery.orderBy((0, drizzle_orm_1.desc)(schema_1.demands.createdAt));
            // Filter by search term if provided
            let filteredResults = results;
            if (search) {
                const searchTerm = search.toLowerCase();
                filteredResults = results.filter((demand) => demand.description.toLowerCase().includes(searchTerm) ||
                    demand.submitter.firstName?.toLowerCase().includes(searchTerm) ||
                    demand.submitter.lastName?.toLowerCase().includes(searchTerm) ||
                    demand.residence.unitNumber.toLowerCase().includes(searchTerm) ||
                    demand.building.name.toLowerCase().includes(searchTerm));
            }
            res.json(filteredResults);
        }
        catch (error) {
            res.status(500).json({ message: 'Failed to fetch demands' });
        }
    });
    // Get a specific demand
    app.get('/api/demands/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const demand = await db_1.db
                .select({
                id: schema_1.demands.id,
                submitterId: schema_1.demands.submitterId,
                type: schema_1.demands.type,
                assignationResidenceId: schema_1.demands.assignationResidenceId,
                assignationBuildingId: schema_1.demands.assignationBuildingId,
                description: schema_1.demands.description,
                attachments: schema_1.demands.attachments,
                residenceId: schema_1.demands.residenceId,
                buildingId: schema_1.demands.buildingId,
                status: schema_1.demands.status,
                reviewedBy: schema_1.demands.reviewedBy,
                reviewedAt: schema_1.demands.reviewedAt,
                reviewNotes: schema_1.demands.reviewNotes,
                createdAt: schema_1.demands.createdAt,
                updatedAt: schema_1.demands.updatedAt,
                submitter: {
                    id: schema_1.users.id,
                    firstName: schema_1.users.firstName,
                    lastName: schema_1.users.lastName,
                    email: schema_1.users.email,
                },
                residence: {
                    id: schema_1.residences.id,
                    unitNumber: schema_1.residences.unitNumber,
                    buildingId: schema_1.residences.buildingId,
                },
                building: {
                    id: schema_1.buildings.id,
                    name: schema_1.buildings.name,
                    address: schema_1.buildings.address,
                },
            })
                .from(schema_1.demands)
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.demands.submitterId, schema_1.users.id))
                .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.demands.residenceId, schema_1.residences.id))
                .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.demands.buildingId, schema_1.buildings.id))
                .where((0, drizzle_orm_1.eq)(schema_1.demands.id, id))
                .limit(1);
            if (demand.length === 0) {
                return res.status(404).json({ message: 'Demand not found' });
            }
            const demandData = demand[0];
            // Check access permissions - users can only view their own demands
            if (demandData.submitterId !== user.id) {
                return res.status(403).json({ message: 'Access denied' });
            }
            res.json(demandData);
        }
        catch (error) {
            res.status(500).json({ message: 'Failed to fetch demand' });
        }
    });
    // Create a new demand
    app.post('/api/demands', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const demandData = req.body;
            // Validate input using the corrected schema that already has optional fields
            const demandInputSchema = operations_1.insertDemandSchema.omit({ submitterId: true });
            // Validate input
            const validatedData = demandInputSchema.parse(demandData);
            console.log('✅ Demand validation passed:', validatedData);
            // Auto-populate residence and building from user's primary residence if not provided
            if (!validatedData.residenceId || !validatedData.buildingId) {
                const userResidenceData = await db_1.db
                    .select({
                    residenceId: schema_1.userResidences.residenceId,
                    buildingId: schema_1.residences.buildingId,
                })
                    .from(schema_1.userResidences)
                    .innerJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                    .where((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id))
                    .limit(1);
                if (userResidenceData.length === 0) {
                    return res
                        .status(400)
                        .json({ message: 'User must be assigned to a residence to create demands' });
                }
                validatedData.residenceId = validatedData.residenceId || userResidenceData[0].residenceId;
                validatedData.buildingId = validatedData.buildingId || userResidenceData[0].buildingId;
            }
            // Ensure required fields are present after auto-population
            if (!validatedData.buildingId || !validatedData.residenceId) {
                return res.status(400).json({
                    message: 'Building and residence are required to create a demand'
                });
            }
            console.log('✅ Final demand data before insertion:', {
                buildingId: validatedData.buildingId,
                residenceId: validatedData.residenceId,
                type: validatedData.type,
                description: validatedData.description
            });
            const demandInsertData = {
                ...validatedData,
                buildingId: validatedData.buildingId,
                residenceId: validatedData.residenceId,
                submitterId: user.id,
                status: validatedData.status || 'submitted',
            };
            const newDemand = await db_1.db.insert(schema_1.demands).values([demandInsertData]).returning();
            res.status(201).json(newDemand[0]);
        }
        catch (error) {
            if (error.name === 'ZodError') {
                return res.status(400).json({ message: 'Invalid demand data', errors: error.errors });
            }
            res.status(500).json({ message: 'Failed to create demand' });
        }
    });
    // Update a demand
    app.put('/api/demands/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const updates = req.body;
            // Get the current demand
            const currentDemand = await db_1.db.select().from(schema_1.demands).where((0, drizzle_orm_1.eq)(schema_1.demands.id, id)).limit(1);
            if (currentDemand.length === 0) {
                return res.status(404).json({ message: 'Demand not found' });
            }
            const demand = currentDemand[0];
            // Check permissions - users can only update their own demands
            if (demand.submitterId !== user.id) {
                return res.status(403).json({ message: 'Access denied' });
            }
            const updatedDemand = await db_1.db
                .update(schema_1.demands)
                .set({ ...updates, updatedAt: new Date() })
                .where((0, drizzle_orm_1.eq)(schema_1.demands.id, id))
                .returning();
            res.json(updatedDemand[0]);
        }
        catch (error) {
            res.status(500).json({ message: 'Failed to update demand' });
        }
    });
    // Delete a demand
    app.delete('/api/demands/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            // Get the current demand
            const currentDemand = await db_1.db.select().from(schema_1.demands).where((0, drizzle_orm_1.eq)(schema_1.demands.id, id)).limit(1);
            if (currentDemand.length === 0) {
                return res.status(404).json({ message: 'Demand not found' });
            }
            const demand = currentDemand[0];
            // Check permissions - users can only delete their own demands
            if (demand.submitterId !== user.id) {
                return res.status(403).json({ message: 'Access denied' });
            }
            await db_1.db.delete(schema_1.demands).where((0, drizzle_orm_1.eq)(schema_1.demands.id, id));
            res.json({ message: 'Demand deleted successfully' });
        }
        catch (error) {
            res.status(500).json({ message: 'Failed to delete demand' });
        }
    });
    // Get comments for a demand
    app.get('/api/demands/:id/comments', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            // First check if user has access to the demand
            const demand = await db_1.db.select().from(schema_1.demands).where((0, drizzle_orm_1.eq)(schema_1.demands.id, id)).limit(1);
            if (demand.length === 0) {
                return res.status(404).json({ message: 'Demand not found' });
            }
            // Check access permissions (same logic as get demand)
            // ... (permission check logic similar to get demand endpoint)
            const comments = await db_1.db
                .select({
                id: schema_1.demandComments.id,
                demandId: schema_1.demandComments.demandId,
                commentText: schema_1.demandComments.commentText,
                commentType: schema_1.demandComments.commentType,
                isInternal: schema_1.demandComments.isInternal,
                commenterId: schema_1.demandComments.commenterId,
                createdAt: schema_1.demandComments.createdAt,
                author: {
                    id: schema_1.users.id,
                    firstName: schema_1.users.firstName,
                    lastName: schema_1.users.lastName,
                    email: schema_1.users.email,
                },
            })
                .from(schema_1.demandComments)
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.demandComments.commenterId, schema_1.users.id))
                .where((0, drizzle_orm_1.eq)(schema_1.demandComments.demandId, id))
                .orderBy((0, drizzle_orm_1.asc)(schema_1.demandComments.createdAt));
            res.json(comments);
        }
        catch (error) {
            res.status(500).json({ message: 'Failed to fetch demand comments' });
        }
    });
    // Create a comment on a demand
    app.post('/api/demands/:id/comments', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const commentData = req.body;
            // Validate input
            const validatedData = operations_1.insertDemandCommentSchema.parse({
                ...commentData,
                demandId: id,
                commenterId: user.id,
            });
            // Check if user has access to the demand (similar logic as above)
            const demand = await db_1.db.select().from(schema_1.demands).where((0, drizzle_orm_1.eq)(schema_1.demands.id, id)).limit(1);
            if (demand.length === 0) {
                return res.status(404).json({ message: 'Demand not found' });
            }
            const newComment = await db_1.db.insert(schema_1.demandComments).values(validatedData).returning();
            res.status(201).json(newComment[0]);
        }
        catch (error) {
            if (error.name === 'ZodError') {
                return res.status(400).json({ message: 'Invalid comment data', errors: error.errors });
            }
            res.status(500).json({ message: 'Failed to create comment' });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxDQUFDLENBQUM7UUFDaEUsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hcGkvZGVtYW5kcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeHByZXNzIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBkYiB9IGZyb20gJy4uL2RiJztcbmltcG9ydCB7XG4gIGRlbWFuZHMsXG4gIGRlbWFuZENvbW1lbnRzLFxuICByZXNpZGVuY2VzLFxuICBidWlsZGluZ3MsXG4gIHVzZXJzLFxuICB1c2VyUmVzaWRlbmNlcyxcbiAgdXNlck9yZ2FuaXphdGlvbnMsXG4gIG9yZ2FuaXphdGlvbnMsXG59IGZyb20gJy4uLy4uL3NoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgZXEsIGFuZCwgb3IsIGluQXJyYXksIGRlc2MsIGFzYyB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vYXV0aC9pbmRleCc7XG5pbXBvcnQgeyBpbnNlcnREZW1hbmRTY2hlbWEsIGluc2VydERlbWFuZENvbW1lbnRTY2hlbWEgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZW1hcy9vcGVyYXRpb25zJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG4vKipcbiAqIFJlZ2lzdGVyIGRlbWFuZCByb3V0ZXMgZm9yIG1hbmFnaW5nIHJlc2lkZW50IGRlbWFuZHMgYW5kIGNvbXBsYWludHMuXG4gKlxuICogQHBhcmFtIGFwcCAtIEV4cHJlc3MgYXBwbGljYXRpb24gaW5zdGFuY2UuXG4gKi9cbi8qKlxuICogUmVnaXN0ZXJEZW1hbmRSb3V0ZXMgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYXBwXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckRlbWFuZFJvdXRlcyhhcHA6IEV4cHJlc3MpIHtcbiAgLy8gR2V0IGRlbWFuZHMgZm9yIGEgdXNlciAocmVzaWRlbnRzIGFuZCBtYW5hZ2VycylcbiAgYXBwLmdldCgnL2FwaS9kZW1hbmRzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgeyBidWlsZGluZ0lkLCByZXNpZGVuY2VJZCwgdHlwZSwgc3RhdHVzLCBzZWFyY2ggfSA9IHJlcS5xdWVyeTtcblxuICAgICAgLy8gQmFzZSBxdWVyeSB3aXRoIGpvaW5zXG4gICAgICBsZXQgcXVlcnkgPSBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICBpZDogZGVtYW5kcy5pZCxcbiAgICAgICAgICBzdWJtaXR0ZXJJZDogZGVtYW5kcy5zdWJtaXR0ZXJJZCxcbiAgICAgICAgICB0eXBlOiBkZW1hbmRzLnR5cGUsXG4gICAgICAgICAgYXNzaWduYXRpb25SZXNpZGVuY2VJZDogZGVtYW5kcy5hc3NpZ25hdGlvblJlc2lkZW5jZUlkLFxuICAgICAgICAgIGFzc2lnbmF0aW9uQnVpbGRpbmdJZDogZGVtYW5kcy5hc3NpZ25hdGlvbkJ1aWxkaW5nSWQsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGRlbWFuZHMuZGVzY3JpcHRpb24sXG4gICAgICAgICAgYXR0YWNobWVudHM6IGRlbWFuZHMuYXR0YWNobWVudHMsXG4gICAgICAgICAgcmVzaWRlbmNlSWQ6IGRlbWFuZHMucmVzaWRlbmNlSWQsXG4gICAgICAgICAgYnVpbGRpbmdJZDogZGVtYW5kcy5idWlsZGluZ0lkLFxuICAgICAgICAgIHN0YXR1czogZGVtYW5kcy5zdGF0dXMsXG4gICAgICAgICAgcmV2aWV3ZWRCeTogZGVtYW5kcy5yZXZpZXdlZEJ5LFxuICAgICAgICAgIHJldmlld2VkQXQ6IGRlbWFuZHMucmV2aWV3ZWRBdCxcbiAgICAgICAgICByZXZpZXdOb3RlczogZGVtYW5kcy5yZXZpZXdOb3RlcyxcbiAgICAgICAgICBjcmVhdGVkQXQ6IGRlbWFuZHMuY3JlYXRlZEF0LFxuICAgICAgICAgIHVwZGF0ZWRBdDogZGVtYW5kcy51cGRhdGVkQXQsXG4gICAgICAgICAgc3VibWl0dGVyOiB7XG4gICAgICAgICAgICBpZDogdXNlcnMuaWQsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHVzZXJzLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB1c2Vycy5sYXN0TmFtZSxcbiAgICAgICAgICAgIGVtYWlsOiB1c2Vycy5lbWFpbCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJlc2lkZW5jZToge1xuICAgICAgICAgICAgaWQ6IHJlc2lkZW5jZXMuaWQsXG4gICAgICAgICAgICB1bml0TnVtYmVyOiByZXNpZGVuY2VzLnVuaXROdW1iZXIsXG4gICAgICAgICAgICBidWlsZGluZ0lkOiByZXNpZGVuY2VzLmJ1aWxkaW5nSWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBidWlsZGluZzoge1xuICAgICAgICAgICAgaWQ6IGJ1aWxkaW5ncy5pZCxcbiAgICAgICAgICAgIG5hbWU6IGJ1aWxkaW5ncy5uYW1lLFxuICAgICAgICAgICAgYWRkcmVzczogYnVpbGRpbmdzLmFkZHJlc3MsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20oZGVtYW5kcylcbiAgICAgICAgLmlubmVySm9pbih1c2VycywgZXEoZGVtYW5kcy5zdWJtaXR0ZXJJZCwgdXNlcnMuaWQpKVxuICAgICAgICAuaW5uZXJKb2luKHJlc2lkZW5jZXMsIGVxKGRlbWFuZHMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZXMuaWQpKVxuICAgICAgICAuaW5uZXJKb2luKGJ1aWxkaW5ncywgZXEoZGVtYW5kcy5idWlsZGluZ0lkLCBidWlsZGluZ3MuaWQpKTtcblxuICAgICAgLy8gQXBwbHkgZmlsdGVycyAtIGFsbCB1c2VycyBvbmx5IHNlZSBkZW1hbmRzIHRoZXkgY3JlYXRlZFxuICAgICAgY29uc3QgY29uZGl0aW9ucyA9IFtlcShkZW1hbmRzLnN1Ym1pdHRlcklkLCB1c2VyLmlkKV07XG5cbiAgICAgIC8vIEFkZCBmaWx0ZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKGJ1aWxkaW5nSWQpIHtcbiAgICAgICAgY29uZGl0aW9ucy5wdXNoKGVxKGRlbWFuZHMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCkpO1xuICAgICAgfVxuICAgICAgaWYgKHJlc2lkZW5jZUlkKSB7XG4gICAgICAgIGNvbmRpdGlvbnMucHVzaChlcShkZW1hbmRzLnJlc2lkZW5jZUlkLCByZXNpZGVuY2VJZCkpO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgY29uZGl0aW9ucy5wdXNoKGVxKGRlbWFuZHMudHlwZSwgdHlwZSkpO1xuICAgICAgfVxuICAgICAgaWYgKHN0YXR1cykge1xuICAgICAgICBjb25kaXRpb25zLnB1c2goZXEoZGVtYW5kcy5zdGF0dXMsIHN0YXR1cykpO1xuICAgICAgfVxuXG4gICAgICAvLyBBcHBseSBjb25kaXRpb25zIHRvIHF1ZXJ5IGlmIGFueSBleGlzdFxuICAgICAgbGV0IGZpbmFsUXVlcnk7XG4gICAgICBpZiAoY29uZGl0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZpbmFsUXVlcnkgPSBxdWVyeS53aGVyZShhbmQoLi4uY29uZGl0aW9ucykpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmluYWxRdWVyeSA9IHF1ZXJ5O1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgZmluYWxRdWVyeS5vcmRlckJ5KGRlc2MoZGVtYW5kcy5jcmVhdGVkQXQpKTtcblxuICAgICAgLy8gRmlsdGVyIGJ5IHNlYXJjaCB0ZXJtIGlmIHByb3ZpZGVkXG4gICAgICBsZXQgZmlsdGVyZWRSZXN1bHRzID0gcmVzdWx0cztcbiAgICAgIGlmIChzZWFyY2gpIHtcbiAgICAgICAgY29uc3Qgc2VhcmNoVGVybSA9IHNlYXJjaC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBmaWx0ZXJlZFJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihcbiAgICAgICAgICAoZGVtYW5kKSA9PlxuICAgICAgICAgICAgZGVtYW5kLmRlc2NyaXB0aW9uLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2VhcmNoVGVybSkgfHxcbiAgICAgICAgICAgIGRlbWFuZC5zdWJtaXR0ZXIuZmlyc3ROYW1lPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHNlYXJjaFRlcm0pIHx8XG4gICAgICAgICAgICBkZW1hbmQuc3VibWl0dGVyLmxhc3ROYW1lPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHNlYXJjaFRlcm0pIHx8XG4gICAgICAgICAgICBkZW1hbmQucmVzaWRlbmNlLnVuaXROdW1iZXIudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hUZXJtKSB8fFxuICAgICAgICAgICAgZGVtYW5kLmJ1aWxkaW5nLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hUZXJtKVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbihmaWx0ZXJlZFJlc3VsdHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBkZW1hbmRzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCBhIHNwZWNpZmljIGRlbWFuZFxuICBhcHAuZ2V0KCcvYXBpL2RlbWFuZHMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgY29uc3QgZGVtYW5kID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgaWQ6IGRlbWFuZHMuaWQsXG4gICAgICAgICAgc3VibWl0dGVySWQ6IGRlbWFuZHMuc3VibWl0dGVySWQsXG4gICAgICAgICAgdHlwZTogZGVtYW5kcy50eXBlLFxuICAgICAgICAgIGFzc2lnbmF0aW9uUmVzaWRlbmNlSWQ6IGRlbWFuZHMuYXNzaWduYXRpb25SZXNpZGVuY2VJZCxcbiAgICAgICAgICBhc3NpZ25hdGlvbkJ1aWxkaW5nSWQ6IGRlbWFuZHMuYXNzaWduYXRpb25CdWlsZGluZ0lkLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZW1hbmRzLmRlc2NyaXB0aW9uLFxuICAgICAgICAgIGF0dGFjaG1lbnRzOiBkZW1hbmRzLmF0dGFjaG1lbnRzLFxuICAgICAgICAgIHJlc2lkZW5jZUlkOiBkZW1hbmRzLnJlc2lkZW5jZUlkLFxuICAgICAgICAgIGJ1aWxkaW5nSWQ6IGRlbWFuZHMuYnVpbGRpbmdJZCxcbiAgICAgICAgICBzdGF0dXM6IGRlbWFuZHMuc3RhdHVzLFxuICAgICAgICAgIHJldmlld2VkQnk6IGRlbWFuZHMucmV2aWV3ZWRCeSxcbiAgICAgICAgICByZXZpZXdlZEF0OiBkZW1hbmRzLnJldmlld2VkQXQsXG4gICAgICAgICAgcmV2aWV3Tm90ZXM6IGRlbWFuZHMucmV2aWV3Tm90ZXMsXG4gICAgICAgICAgY3JlYXRlZEF0OiBkZW1hbmRzLmNyZWF0ZWRBdCxcbiAgICAgICAgICB1cGRhdGVkQXQ6IGRlbWFuZHMudXBkYXRlZEF0LFxuICAgICAgICAgIHN1Ym1pdHRlcjoge1xuICAgICAgICAgICAgaWQ6IHVzZXJzLmlkLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB1c2Vycy5maXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdXNlcnMubGFzdE5hbWUsXG4gICAgICAgICAgICBlbWFpbDogdXNlcnMuZW1haWwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICByZXNpZGVuY2U6IHtcbiAgICAgICAgICAgIGlkOiByZXNpZGVuY2VzLmlkLFxuICAgICAgICAgICAgdW5pdE51bWJlcjogcmVzaWRlbmNlcy51bml0TnVtYmVyLFxuICAgICAgICAgICAgYnVpbGRpbmdJZDogcmVzaWRlbmNlcy5idWlsZGluZ0lkLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgYnVpbGRpbmc6IHtcbiAgICAgICAgICAgIGlkOiBidWlsZGluZ3MuaWQsXG4gICAgICAgICAgICBuYW1lOiBidWlsZGluZ3MubmFtZSxcbiAgICAgICAgICAgIGFkZHJlc3M6IGJ1aWxkaW5ncy5hZGRyZXNzLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKGRlbWFuZHMpXG4gICAgICAgIC5pbm5lckpvaW4odXNlcnMsIGVxKGRlbWFuZHMuc3VibWl0dGVySWQsIHVzZXJzLmlkKSlcbiAgICAgICAgLmlubmVySm9pbihyZXNpZGVuY2VzLCBlcShkZW1hbmRzLnJlc2lkZW5jZUlkLCByZXNpZGVuY2VzLmlkKSlcbiAgICAgICAgLmlubmVySm9pbihidWlsZGluZ3MsIGVxKGRlbWFuZHMuYnVpbGRpbmdJZCwgYnVpbGRpbmdzLmlkKSlcbiAgICAgICAgLndoZXJlKGVxKGRlbWFuZHMuaWQsIGlkKSlcbiAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICBpZiAoZGVtYW5kLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnRGVtYW5kIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRlbWFuZERhdGEgPSBkZW1hbmRbMF07XG5cbiAgICAgIC8vIENoZWNrIGFjY2VzcyBwZXJtaXNzaW9ucyAtIHVzZXJzIGNhbiBvbmx5IHZpZXcgdGhlaXIgb3duIGRlbWFuZHNcbiAgICAgIGlmIChkZW1hbmREYXRhLnN1Ym1pdHRlcklkICE9PSB1c2VyLmlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oZGVtYW5kRGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIGRlbWFuZCcgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBDcmVhdGUgYSBuZXcgZGVtYW5kXG4gIGFwcC5wb3N0KCcvYXBpL2RlbWFuZHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG4gICAgICBjb25zdCBkZW1hbmREYXRhID0gcmVxLmJvZHk7XG4gICAgICBcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXQgdXNpbmcgdGhlIGNvcnJlY3RlZCBzY2hlbWEgdGhhdCBhbHJlYWR5IGhhcyBvcHRpb25hbCBmaWVsZHNcbiAgICAgIGNvbnN0IGRlbWFuZElucHV0U2NoZW1hID0gaW5zZXJ0RGVtYW5kU2NoZW1hLm9taXQoeyBzdWJtaXR0ZXJJZDogdHJ1ZSB9KTtcbiAgICAgIFxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGNvbnN0IHZhbGlkYXRlZERhdGEgPSBkZW1hbmRJbnB1dFNjaGVtYS5wYXJzZShkZW1hbmREYXRhKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coJ+KchSBEZW1hbmQgdmFsaWRhdGlvbiBwYXNzZWQ6JywgdmFsaWRhdGVkRGF0YSk7XG5cbiAgICAgIC8vIEF1dG8tcG9wdWxhdGUgcmVzaWRlbmNlIGFuZCBidWlsZGluZyBmcm9tIHVzZXIncyBwcmltYXJ5IHJlc2lkZW5jZSBpZiBub3QgcHJvdmlkZWRcbiAgICAgIGlmICghdmFsaWRhdGVkRGF0YS5yZXNpZGVuY2VJZCB8fCAhdmFsaWRhdGVkRGF0YS5idWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbnN0IHVzZXJSZXNpZGVuY2VEYXRhID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgIHJlc2lkZW5jZUlkOiB1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCxcbiAgICAgICAgICAgIGJ1aWxkaW5nSWQ6IHJlc2lkZW5jZXMuYnVpbGRpbmdJZCxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAgIC5pbm5lckpvaW4ocmVzaWRlbmNlcywgZXEodXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZXMuaWQpKVxuICAgICAgICAgIC53aGVyZShlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXIuaWQpKVxuICAgICAgICAgIC5saW1pdCgxKTtcblxuICAgICAgICBpZiAodXNlclJlc2lkZW5jZURhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgLnN0YXR1cyg0MDApXG4gICAgICAgICAgICAuanNvbih7IG1lc3NhZ2U6ICdVc2VyIG11c3QgYmUgYXNzaWduZWQgdG8gYSByZXNpZGVuY2UgdG8gY3JlYXRlIGRlbWFuZHMnIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFsaWRhdGVkRGF0YS5yZXNpZGVuY2VJZCA9IHZhbGlkYXRlZERhdGEucmVzaWRlbmNlSWQgfHwgdXNlclJlc2lkZW5jZURhdGFbMF0ucmVzaWRlbmNlSWQ7XG4gICAgICAgIHZhbGlkYXRlZERhdGEuYnVpbGRpbmdJZCA9IHZhbGlkYXRlZERhdGEuYnVpbGRpbmdJZCB8fCB1c2VyUmVzaWRlbmNlRGF0YVswXS5idWlsZGluZ0lkO1xuICAgICAgfVxuXG4gICAgICAvLyBFbnN1cmUgcmVxdWlyZWQgZmllbGRzIGFyZSBwcmVzZW50IGFmdGVyIGF1dG8tcG9wdWxhdGlvblxuICAgICAgaWYgKCF2YWxpZGF0ZWREYXRhLmJ1aWxkaW5nSWQgfHwgIXZhbGlkYXRlZERhdGEucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgXG4gICAgICAgICAgbWVzc2FnZTogJ0J1aWxkaW5nIGFuZCByZXNpZGVuY2UgYXJlIHJlcXVpcmVkIHRvIGNyZWF0ZSBhIGRlbWFuZCcgXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBjb25zb2xlLmxvZygn4pyFIEZpbmFsIGRlbWFuZCBkYXRhIGJlZm9yZSBpbnNlcnRpb246Jywge1xuICAgICAgICBidWlsZGluZ0lkOiB2YWxpZGF0ZWREYXRhLmJ1aWxkaW5nSWQsXG4gICAgICAgIHJlc2lkZW5jZUlkOiB2YWxpZGF0ZWREYXRhLnJlc2lkZW5jZUlkLFxuICAgICAgICB0eXBlOiB2YWxpZGF0ZWREYXRhLnR5cGUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiB2YWxpZGF0ZWREYXRhLmRlc2NyaXB0aW9uXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgZGVtYW5kSW5zZXJ0RGF0YSA9IHtcbiAgICAgICAgLi4udmFsaWRhdGVkRGF0YSxcbiAgICAgICAgYnVpbGRpbmdJZDogdmFsaWRhdGVkRGF0YS5idWlsZGluZ0lkLFxuICAgICAgICByZXNpZGVuY2VJZDogdmFsaWRhdGVkRGF0YS5yZXNpZGVuY2VJZCxcbiAgICAgICAgc3VibWl0dGVySWQ6IHVzZXIuaWQsXG4gICAgICAgIHN0YXR1czogKHZhbGlkYXRlZERhdGEuc3RhdHVzIGFzICdzdWJtaXR0ZWQnIHwgJ3VuZGVyX3JldmlldycgfCAnYXBwcm92ZWQnIHwgJ3JlamVjdGVkJyB8ICdpbl9wcm9ncmVzcycgfCAnY29tcGxldGVkJyB8ICdjYW5jZWxsZWQnKSB8fCAnc3VibWl0dGVkJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG5ld0RlbWFuZCA9IGF3YWl0IGRiLmluc2VydChkZW1hbmRzKS52YWx1ZXMoW2RlbWFuZEluc2VydERhdGFdKS5yZXR1cm5pbmcoKTtcblxuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24obmV3RGVtYW5kWzBdKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ1pvZEVycm9yJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAnSW52YWxpZCBkZW1hbmQgZGF0YScsIGVycm9yczogZXJyb3IuZXJyb3JzIH0pO1xuICAgICAgfVxuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGNyZWF0ZSBkZW1hbmQnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gVXBkYXRlIGEgZGVtYW5kXG4gIGFwcC5wdXQoJy9hcGkvZGVtYW5kcy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgdXBkYXRlcyA9IHJlcS5ib2R5O1xuXG4gICAgICAvLyBHZXQgdGhlIGN1cnJlbnQgZGVtYW5kXG4gICAgICBjb25zdCBjdXJyZW50RGVtYW5kID0gYXdhaXQgZGIuc2VsZWN0KCkuZnJvbShkZW1hbmRzKS53aGVyZShlcShkZW1hbmRzLmlkLCBpZCkpLmxpbWl0KDEpO1xuXG4gICAgICBpZiAoY3VycmVudERlbWFuZC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0RlbWFuZCBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkZW1hbmQgPSBjdXJyZW50RGVtYW5kWzBdO1xuXG4gICAgICAvLyBDaGVjayBwZXJtaXNzaW9ucyAtIHVzZXJzIGNhbiBvbmx5IHVwZGF0ZSB0aGVpciBvd24gZGVtYW5kc1xuICAgICAgaWYgKGRlbWFuZC5zdWJtaXR0ZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBtZXNzYWdlOiAnQWNjZXNzIGRlbmllZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWREZW1hbmQgPSBhd2FpdCBkYlxuICAgICAgICAudXBkYXRlKGRlbWFuZHMpXG4gICAgICAgIC5zZXQoeyAuLi51cGRhdGVzLCB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkgfSlcbiAgICAgICAgLndoZXJlKGVxKGRlbWFuZHMuaWQsIGlkKSlcbiAgICAgICAgLnJldHVybmluZygpO1xuXG4gICAgICByZXMuanNvbih1cGRhdGVkRGVtYW5kWzBdKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gdXBkYXRlIGRlbWFuZCcgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBEZWxldGUgYSBkZW1hbmRcbiAgYXBwLmRlbGV0ZSgnL2FwaS9kZW1hbmRzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG5cbiAgICAgIC8vIEdldCB0aGUgY3VycmVudCBkZW1hbmRcbiAgICAgIGNvbnN0IGN1cnJlbnREZW1hbmQgPSBhd2FpdCBkYi5zZWxlY3QoKS5mcm9tKGRlbWFuZHMpLndoZXJlKGVxKGRlbWFuZHMuaWQsIGlkKSkubGltaXQoMSk7XG5cbiAgICAgIGlmIChjdXJyZW50RGVtYW5kLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnRGVtYW5kIG5vdCBmb3VuZCcgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRlbWFuZCA9IGN1cnJlbnREZW1hbmRbMF07XG5cbiAgICAgIC8vIENoZWNrIHBlcm1pc3Npb25zIC0gdXNlcnMgY2FuIG9ubHkgZGVsZXRlIHRoZWlyIG93biBkZW1hbmRzXG4gICAgICBpZiAoZGVtYW5kLnN1Ym1pdHRlcklkICE9PSB1c2VyLmlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgZGIuZGVsZXRlKGRlbWFuZHMpLndoZXJlKGVxKGRlbWFuZHMuaWQsIGlkKSk7XG5cbiAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ0RlbWFuZCBkZWxldGVkIHN1Y2Nlc3NmdWxseScgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGRlbGV0ZSBkZW1hbmQnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gR2V0IGNvbW1lbnRzIGZvciBhIGRlbWFuZFxuICBhcHAuZ2V0KCcvYXBpL2RlbWFuZHMvOmlkL2NvbW1lbnRzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgLy8gRmlyc3QgY2hlY2sgaWYgdXNlciBoYXMgYWNjZXNzIHRvIHRoZSBkZW1hbmRcbiAgICAgIGNvbnN0IGRlbWFuZCA9IGF3YWl0IGRiLnNlbGVjdCgpLmZyb20oZGVtYW5kcykud2hlcmUoZXEoZGVtYW5kcy5pZCwgaWQpKS5saW1pdCgxKTtcblxuICAgICAgaWYgKGRlbWFuZC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ0RlbWFuZCBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBhY2Nlc3MgcGVybWlzc2lvbnMgKHNhbWUgbG9naWMgYXMgZ2V0IGRlbWFuZClcbiAgICAgIC8vIC4uLiAocGVybWlzc2lvbiBjaGVjayBsb2dpYyBzaW1pbGFyIHRvIGdldCBkZW1hbmQgZW5kcG9pbnQpXG5cbiAgICAgIGNvbnN0IGNvbW1lbnRzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgaWQ6IGRlbWFuZENvbW1lbnRzLmlkLFxuICAgICAgICAgIGRlbWFuZElkOiBkZW1hbmRDb21tZW50cy5kZW1hbmRJZCxcbiAgICAgICAgICBjb21tZW50VGV4dDogZGVtYW5kQ29tbWVudHMuY29tbWVudFRleHQsXG4gICAgICAgICAgY29tbWVudFR5cGU6IGRlbWFuZENvbW1lbnRzLmNvbW1lbnRUeXBlLFxuICAgICAgICAgIGlzSW50ZXJuYWw6IGRlbWFuZENvbW1lbnRzLmlzSW50ZXJuYWwsXG4gICAgICAgICAgY29tbWVudGVySWQ6IGRlbWFuZENvbW1lbnRzLmNvbW1lbnRlcklkLFxuICAgICAgICAgIGNyZWF0ZWRBdDogZGVtYW5kQ29tbWVudHMuY3JlYXRlZEF0LFxuICAgICAgICAgIGF1dGhvcjoge1xuICAgICAgICAgICAgaWQ6IHVzZXJzLmlkLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB1c2Vycy5maXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdXNlcnMubGFzdE5hbWUsXG4gICAgICAgICAgICBlbWFpbDogdXNlcnMuZW1haWwsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20oZGVtYW5kQ29tbWVudHMpXG4gICAgICAgIC5pbm5lckpvaW4odXNlcnMsIGVxKGRlbWFuZENvbW1lbnRzLmNvbW1lbnRlcklkLCB1c2Vycy5pZCkpXG4gICAgICAgIC53aGVyZShlcShkZW1hbmRDb21tZW50cy5kZW1hbmRJZCwgaWQpKVxuICAgICAgICAub3JkZXJCeShhc2MoZGVtYW5kQ29tbWVudHMuY3JlYXRlZEF0KSk7XG5cbiAgICAgIHJlcy5qc29uKGNvbW1lbnRzKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggZGVtYW5kIGNvbW1lbnRzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIENyZWF0ZSBhIGNvbW1lbnQgb24gYSBkZW1hbmRcbiAgYXBwLnBvc3QoJy9hcGkvZGVtYW5kcy86aWQvY29tbWVudHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgdXNlciA9IHJlcS51c2VyO1xuICAgICAgY29uc3QgY29tbWVudERhdGEgPSByZXEuYm9keTtcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGNvbnN0IHZhbGlkYXRlZERhdGEgPSBpbnNlcnREZW1hbmRDb21tZW50U2NoZW1hLnBhcnNlKHtcbiAgICAgICAgLi4uY29tbWVudERhdGEsXG4gICAgICAgIGRlbWFuZElkOiBpZCxcbiAgICAgICAgY29tbWVudGVySWQ6IHVzZXIuaWQsXG4gICAgICB9KTtcblxuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgYWNjZXNzIHRvIHRoZSBkZW1hbmQgKHNpbWlsYXIgbG9naWMgYXMgYWJvdmUpXG4gICAgICBjb25zdCBkZW1hbmQgPSBhd2FpdCBkYi5zZWxlY3QoKS5mcm9tKGRlbWFuZHMpLndoZXJlKGVxKGRlbWFuZHMuaWQsIGlkKSkubGltaXQoMSk7XG5cbiAgICAgIGlmIChkZW1hbmQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdEZW1hbmQgbm90IGZvdW5kJyB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbmV3Q29tbWVudCA9IGF3YWl0IGRiLmluc2VydChkZW1hbmRDb21tZW50cykudmFsdWVzKHZhbGlkYXRlZERhdGEpLnJldHVybmluZygpO1xuXG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihuZXdDb21tZW50WzBdKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ1pvZEVycm9yJykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiAnSW52YWxpZCBjb21tZW50IGRhdGEnLCBlcnJvcnM6IGVycm9yLmVycm9ycyB9KTtcbiAgICAgIH1cbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgY29tbWVudCcgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==