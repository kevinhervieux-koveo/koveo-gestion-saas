64c50c10b6edb1a52614df68da085454
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const jsx_runtime_1 = require("react/jsx-runtime");
jest.mock('../../../client/src/lib/queryClient', () => ({
    apiRequest: mockApiRequest,
    queryClient: new (jest.requireActual('@tanstack/react-query').QueryClient)(),
}));
// Mock authentication context
jest.mock('../../../client/src/hooks/use-auth', () => ({
    useAuth: () => ({
        user: { id: '1', email: 'test@test.com', role: 'admin' },
        isAuthenticated: true,
        login: jest.fn(),
        logout: jest.fn(),
    }),
}));
jest.mock('../../../client/src/hooks/use-toast', () => ({
    useToast: () => ({
        toast: mockToast,
    }),
}));
/**
 * Form Action Button Functionality Tests
 * Tests all form submission, saving, and action buttons
 */
const react_1 = __importDefault(require("react"));
const react_2 = require("@testing-library/react");
const react_query_1 = require("@tanstack/react-query");
require("@testing-library/jest-dom");
const user_event_1 = __importDefault(require("@testing-library/user-event"));
// Mock API requests
const mockApiRequest = jest.fn();
// Mock toast notifications
const mockToast = jest.fn();
describe('Form Action Buttons Functionality', () => {
    let queryClient;
    let user;
    beforeEach(() => {
        queryClient = new react_query_1.QueryClient({
            defaultOptions: {
                queries: { retry: false },
                mutations: { retry: false },
            },
        });
        user = user_event_1.default.setup();
        jest.clearAllMocks();
        mockApiRequest.mockResolvedValue({ ok: true, json: () => Promise.resolve({}) });
    });
    const renderWithProvider = (component) => {
        return (0, react_2.render)((0, jsx_runtime_1.jsx)(react_query_1.QueryClientProvider, { client: queryClient, children: component }));
    };
    describe('Save Buttons', () => {
        const saveButtonTestIds = [
            'save-residences',
            'save-buildings',
            'save-organizations',
            'button-save-text-file',
            'button-save-edit',
        ];
        saveButtonTestIds.forEach(testId => {
            it(`should handle save action for ${testId}`, async () => {
                // Create a mock component with the save button
                const MockComponent = () => {
                    const handleSave = () => {
                        mockApiRequest('/api/save', { method: 'POST' });
                    };
                    return ((0, jsx_runtime_1.jsx)("button", { "data-testid": testId, onClick: handleSave, children: "Save" }));
                };
                renderWithProvider((0, jsx_runtime_1.jsx)(MockComponent, {}));
                const saveButton = react_2.screen.getByTestId(testId);
                expect(saveButton).toBeInTheDocument();
                await user.click(saveButton);
                await (0, react_2.waitFor)(() => {
                    expect(mockApiRequest).toHaveBeenCalledWith('/api/save', { method: 'POST' });
                });
            });
        });
    });
    describe('Submit Buttons', () => {
        const submitButtonTestIds = [
            'button-submit-bug',
            'button-submit-feature-request',
        ];
        submitButtonTestIds.forEach(testId => {
            it(`should handle form submission for ${testId}`, async () => {
                const MockForm = () => {
                    const handleSubmit = (e) => {
                        e.preventDefault();
                        mockApiRequest('/api/submit', { method: 'POST' });
                    };
                    return ((0, jsx_runtime_1.jsxs)("form", { onSubmit: handleSubmit, children: [(0, jsx_runtime_1.jsx)("input", { type: "text", name: "title", defaultValue: "Test Title" }), (0, jsx_runtime_1.jsx)("button", { type: "submit", "data-testid": testId, children: "Submit" })] }));
                };
                renderWithProvider((0, jsx_runtime_1.jsx)(MockForm, {}));
                const submitButton = react_2.screen.getByTestId(testId);
                expect(submitButton).toBeInTheDocument();
                await user.click(submitButton);
                await (0, react_2.waitFor)(() => {
                    expect(mockApiRequest).toHaveBeenCalledWith('/api/submit', { method: 'POST' });
                });
            });
        });
    });
    describe('Update Buttons', () => {
        const updateButtonTestIds = [
            'button-update-bug',
            'button-update-feature-request',
        ];
        updateButtonTestIds.forEach(testId => {
            it(`should handle update action for ${testId}`, async () => {
                const MockComponent = () => {
                    const handleUpdate = () => {
                        mockApiRequest('/api/update', { method: 'PATCH' });
                    };
                    return ((0, jsx_runtime_1.jsx)("button", { "data-testid": testId, onClick: handleUpdate, children: "Update" }));
                };
                renderWithProvider((0, jsx_runtime_1.jsx)(MockComponent, {}));
                const updateButton = react_2.screen.getByTestId(testId);
                expect(updateButton).toBeInTheDocument();
                await user.click(updateButton);
                await (0, react_2.waitFor)(() => {
                    expect(mockApiRequest).toHaveBeenCalledWith('/api/update', { method: 'PATCH' });
                });
            });
        });
    });
    describe('Create Buttons', () => {
        const createButtonTestIds = [
            'button-create-bug',
            'button-create-feature-request',
            'button-create-space',
            'button-invite-user',
        ];
        createButtonTestIds.forEach(testId => {
            it(`should handle create action for ${testId}`, async () => {
                const MockComponent = () => {
                    const handleCreate = () => {
                        mockApiRequest('/api/create', { method: 'POST' });
                    };
                    return ((0, jsx_runtime_1.jsx)("button", { "data-testid": testId, onClick: handleCreate, children: "Create" }));
                };
                renderWithProvider((0, jsx_runtime_1.jsx)(MockComponent, {}));
                const createButton = react_2.screen.getByTestId(testId);
                expect(createButton).toBeInTheDocument();
                await user.click(createButton);
                await (0, react_2.waitFor)(() => {
                    expect(mockApiRequest).toHaveBeenCalledWith('/api/create', { method: 'POST' });
                });
            });
        });
    });
    describe('Button States', () => {
        it('should handle loading states correctly', () => {
            const MockComponent = () => {
                const [isLoading, setIsLoading] = react_1.default.useState(false);
                const handleClick = () => {
                    setIsLoading(true);
                    setTimeout(() => setIsLoading(false), 1000);
                };
                return ((0, jsx_runtime_1.jsx)("button", { "data-testid": "loading-button", onClick: handleClick, disabled: isLoading, children: isLoading ? 'Loading...' : 'Click Me' }));
            };
            renderWithProvider((0, jsx_runtime_1.jsx)(MockComponent, {}));
            const button = react_2.screen.getByTestId('loading-button');
            expect(button).toBeInTheDocument();
            expect(button).not.toBeDisabled();
            react_2.fireEvent.click(button);
            expect(button).toBeDisabled();
        });
        it('should handle disabled states correctly', () => {
            const MockComponent = () => ((0, jsx_runtime_1.jsx)("button", { "data-testid": "disabled-button", disabled: true, children: "Disabled Button" }));
            renderWithProvider((0, jsx_runtime_1.jsx)(MockComponent, {}));
            const button = react_2.screen.getByTestId('disabled-button');
            expect(button).toBeInTheDocument();
            expect(button).toBeDisabled();
        });
        it('should handle Create Draft button submission and error cases', async () => {
            // Test the specific Create Draft button that was failing
            const MockCreateDraftComponent = () => {
                const [isSubmitting, setIsSubmitting] = react_1.default.useState(false);
                const handleCreateDraft = async () => {
                    setIsSubmitting(true);
                    try {
                        const response = await fetch('/api/demands', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'maintenance',
                                buildingId: 'test-building',
                                residenceId: 'test-residence',
                                description: 'Test demand'
                            })
                        });
                        if (!response.ok) {
                            throw new Error('Failed to create demand');
                        }
                    }
                    catch (error) {
                        // Should handle errors gracefully
                        console.error('Create demand failed:', error);
                    }
                    finally {
                        setIsSubmitting(false);
                    }
                };
                return ((0, jsx_runtime_1.jsx)("button", { "data-testid": "button-create-draft", onClick: handleCreateDraft, disabled: isSubmitting, children: isSubmitting ? 'Creating...' : 'Create Draft' }));
            };
            // Mock fetch to simulate the failing API
            global.fetch = jest.fn().mockResolvedValue({
                ok: false,
                status: 400,
                json: () => Promise.resolve({ message: 'Failed to create demand' })
            });
            renderWithProvider((0, jsx_runtime_1.jsx)(MockCreateDraftComponent, {}));
            const createDraftButton = react_2.screen.getByTestId('button-create-draft');
            expect(createDraftButton).toBeInTheDocument();
            expect(createDraftButton).toHaveTextContent('Create Draft');
            // Click the button and verify it handles errors
            await user.click(createDraftButton);
            // Wait for the loading state to appear and then disappear
            await (0, react_2.waitFor)(() => {
                expect(createDraftButton).toHaveTextContent('Creating...');
            });
            await (0, react_2.waitFor)(() => {
                expect(createDraftButton).toHaveTextContent('Create Draft');
            });
            expect(global.fetch).toHaveBeenCalledWith('/api/demands', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'maintenance',
                    buildingId: 'test-building',
                    residenceId: 'test-residence',
                    description: 'Test demand'
                })
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy91bml0L2J1dHRvbi1mdW5jdGlvbmFsaXR5L2Zvcm0tYWN0aW9uLWJ1dHRvbnMudGVzdC50c3giLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBYUEsSUFBSSxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELFVBQVUsRUFBRSxjQUFjO0lBQzFCLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFO0NBQzdFLENBQUMsQ0FBQyxDQUFDO0FBRUosOEJBQThCO0FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyRCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNkLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO1FBQ3hELGVBQWUsRUFBRSxJQUFJO1FBQ3JCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2hCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2xCLENBQUM7Q0FDSCxDQUFDLENBQUMsQ0FBQztBQUlKLElBQUksQ0FBQyxJQUFJLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN0RCxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNmLEtBQUssRUFBRSxTQUFTO0tBQ2pCLENBQUM7Q0FDSCxDQUFDLENBQUMsQ0FBQztBQWxDSjs7O0dBR0c7QUFFSCxrREFBMEI7QUFDMUIsa0RBQTRFO0FBQzVFLHVEQUF5RTtBQUN6RSxxQ0FBbUM7QUFDbkMsNkVBQW9EO0FBRXBELG9CQUFvQjtBQUNwQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7QUFnQmpDLDJCQUEyQjtBQUMzQixN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RSxlQUFlO29CQUMzQixXQUFXLEVBQUUsZ0JBQWdCO29CQUM3QixXQUFXLEVBQUUsYUFBYTtpQkFDM0IsQ0FBQzthQUNILENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3Rlc3RzL3VuaXQvYnV0dG9uLWZ1bmN0aW9uYWxpdHkvZm9ybS1hY3Rpb24tYnV0dG9ucy50ZXN0LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZvcm0gQWN0aW9uIEJ1dHRvbiBGdW5jdGlvbmFsaXR5IFRlc3RzXG4gKiBUZXN0cyBhbGwgZm9ybSBzdWJtaXNzaW9uLCBzYXZpbmcsIGFuZCBhY3Rpb24gYnV0dG9uc1xuICovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyByZW5kZXIsIHNjcmVlbiwgZmlyZUV2ZW50LCB3YWl0Rm9yIH0gZnJvbSAnQHRlc3RpbmctbGlicmFyeS9yZWFjdCc7XG5pbXBvcnQgeyBRdWVyeUNsaWVudCwgUXVlcnlDbGllbnRQcm92aWRlciB9IGZyb20gJ0B0YW5zdGFjay9yZWFjdC1xdWVyeSc7XG5pbXBvcnQgJ0B0ZXN0aW5nLWxpYnJhcnkvamVzdC1kb20nO1xuaW1wb3J0IHVzZXJFdmVudCBmcm9tICdAdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQnO1xuXG4vLyBNb2NrIEFQSSByZXF1ZXN0c1xuY29uc3QgbW9ja0FwaVJlcXVlc3QgPSBqZXN0LmZuKCk7XG5qZXN0Lm1vY2soJy4uLy4uLy4uL2NsaWVudC9zcmMvbGliL3F1ZXJ5Q2xpZW50JywgKCkgPT4gKHtcbiAgYXBpUmVxdWVzdDogbW9ja0FwaVJlcXVlc3QsXG4gIHF1ZXJ5Q2xpZW50OiBuZXcgKGplc3QucmVxdWlyZUFjdHVhbCgnQHRhbnN0YWNrL3JlYWN0LXF1ZXJ5JykuUXVlcnlDbGllbnQpKCksXG59KSk7XG5cbi8vIE1vY2sgYXV0aGVudGljYXRpb24gY29udGV4dFxuamVzdC5tb2NrKCcuLi8uLi8uLi9jbGllbnQvc3JjL2hvb2tzL3VzZS1hdXRoJywgKCkgPT4gKHtcbiAgdXNlQXV0aDogKCkgPT4gKHtcbiAgICB1c2VyOiB7IGlkOiAnMScsIGVtYWlsOiAndGVzdEB0ZXN0LmNvbScsIHJvbGU6ICdhZG1pbicgfSxcbiAgICBpc0F1dGhlbnRpY2F0ZWQ6IHRydWUsXG4gICAgbG9naW46IGplc3QuZm4oKSxcbiAgICBsb2dvdXQ6IGplc3QuZm4oKSxcbiAgfSksXG59KSk7XG5cbi8vIE1vY2sgdG9hc3Qgbm90aWZpY2F0aW9uc1xuY29uc3QgbW9ja1RvYXN0ID0gamVzdC5mbigpO1xuamVzdC5tb2NrKCcuLi8uLi8uLi9jbGllbnQvc3JjL2hvb2tzL3VzZS10b2FzdCcsICgpID0+ICh7XG4gIHVzZVRvYXN0OiAoKSA9PiAoe1xuICAgIHRvYXN0OiBtb2NrVG9hc3QsXG4gIH0pLFxufSkpO1xuXG5kZXNjcmliZSgnRm9ybSBBY3Rpb24gQnV0dG9ucyBGdW5jdGlvbmFsaXR5JywgKCkgPT4ge1xuICBsZXQgcXVlcnlDbGllbnQ6IFF1ZXJ5Q2xpZW50O1xuICBsZXQgdXNlcjogYW55O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHF1ZXJ5Q2xpZW50ID0gbmV3IFF1ZXJ5Q2xpZW50KHtcbiAgICAgIGRlZmF1bHRPcHRpb25zOiB7XG4gICAgICAgIHF1ZXJpZXM6IHsgcmV0cnk6IGZhbHNlIH0sXG4gICAgICAgIG11dGF0aW9uczogeyByZXRyeTogZmFsc2UgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgdXNlciA9IHVzZXJFdmVudC5zZXR1cCgpO1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIG1vY2tBcGlSZXF1ZXN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgb2s6IHRydWUsIGpzb246ICgpID0+IFByb21pc2UucmVzb2x2ZSh7fSkgfSk7XG4gIH0pO1xuXG4gIGNvbnN0IHJlbmRlcldpdGhQcm92aWRlciA9IChjb21wb25lbnQ6IFJlYWN0LlJlYWN0RWxlbWVudCkgPT4ge1xuICAgIHJldHVybiByZW5kZXIoXG4gICAgICA8UXVlcnlDbGllbnRQcm92aWRlciBjbGllbnQ9e3F1ZXJ5Q2xpZW50fT5cbiAgICAgICAge2NvbXBvbmVudH1cbiAgICAgIDwvUXVlcnlDbGllbnRQcm92aWRlcj5cbiAgICApO1xuICB9O1xuXG4gIGRlc2NyaWJlKCdTYXZlIEJ1dHRvbnMnLCAoKSA9PiB7XG4gICAgY29uc3Qgc2F2ZUJ1dHRvblRlc3RJZHMgPSBbXG4gICAgICAnc2F2ZS1yZXNpZGVuY2VzJyxcbiAgICAgICdzYXZlLWJ1aWxkaW5ncycsIFxuICAgICAgJ3NhdmUtb3JnYW5pemF0aW9ucycsXG4gICAgICAnYnV0dG9uLXNhdmUtdGV4dC1maWxlJyxcbiAgICAgICdidXR0b24tc2F2ZS1lZGl0JyxcbiAgICBdO1xuXG4gICAgc2F2ZUJ1dHRvblRlc3RJZHMuZm9yRWFjaCh0ZXN0SWQgPT4ge1xuICAgICAgaXQoYHNob3VsZCBoYW5kbGUgc2F2ZSBhY3Rpb24gZm9yICR7dGVzdElkfWAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gQ3JlYXRlIGEgbW9jayBjb21wb25lbnQgd2l0aCB0aGUgc2F2ZSBidXR0b25cbiAgICAgICAgY29uc3QgTW9ja0NvbXBvbmVudCA9ICgpID0+IHtcbiAgICAgICAgICBjb25zdCBoYW5kbGVTYXZlID0gKCkgPT4ge1xuICAgICAgICAgICAgbW9ja0FwaVJlcXVlc3QoJy9hcGkvc2F2ZScsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8YnV0dG9uIGRhdGEtdGVzdGlkPXt0ZXN0SWR9IG9uQ2xpY2s9e2hhbmRsZVNhdmV9PlxuICAgICAgICAgICAgICBTYXZlXG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJlbmRlcldpdGhQcm92aWRlcig8TW9ja0NvbXBvbmVudCAvPik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzYXZlQnV0dG9uID0gc2NyZWVuLmdldEJ5VGVzdElkKHRlc3RJZCk7XG4gICAgICAgIGV4cGVjdChzYXZlQnV0dG9uKS50b0JlSW5UaGVEb2N1bWVudCgpO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgdXNlci5jbGljayhzYXZlQnV0dG9uKTtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IHdhaXRGb3IoKCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChtb2NrQXBpUmVxdWVzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJy9hcGkvc2F2ZScsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTdWJtaXQgQnV0dG9ucycsICgpID0+IHtcbiAgICBjb25zdCBzdWJtaXRCdXR0b25UZXN0SWRzID0gW1xuICAgICAgJ2J1dHRvbi1zdWJtaXQtYnVnJyxcbiAgICAgICdidXR0b24tc3VibWl0LWZlYXR1cmUtcmVxdWVzdCcsXG4gICAgXTtcblxuICAgIHN1Ym1pdEJ1dHRvblRlc3RJZHMuZm9yRWFjaCh0ZXN0SWQgPT4ge1xuICAgICAgaXQoYHNob3VsZCBoYW5kbGUgZm9ybSBzdWJtaXNzaW9uIGZvciAke3Rlc3RJZH1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IE1vY2tGb3JtID0gKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGhhbmRsZVN1Ym1pdCA9IChlOiBSZWFjdC5Gb3JtRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIG1vY2tBcGlSZXF1ZXN0KCcvYXBpL3N1Ym1pdCcsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8Zm9ybSBvblN1Ym1pdD17aGFuZGxlU3VibWl0fT5cbiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9XCJ0ZXh0XCIgbmFtZT1cInRpdGxlXCIgZGVmYXVsdFZhbHVlPVwiVGVzdCBUaXRsZVwiIC8+XG4gICAgICAgICAgICAgIDxidXR0b24gdHlwZT1cInN1Ym1pdFwiIGRhdGEtdGVzdGlkPXt0ZXN0SWR9PlxuICAgICAgICAgICAgICAgIFN1Ym1pdFxuICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgIDwvZm9ybT5cbiAgICAgICAgICApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJlbmRlcldpdGhQcm92aWRlcig8TW9ja0Zvcm0gLz4pO1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgc3VibWl0QnV0dG9uID0gc2NyZWVuLmdldEJ5VGVzdElkKHRlc3RJZCk7XG4gICAgICAgIGV4cGVjdChzdWJtaXRCdXR0b24pLnRvQmVJblRoZURvY3VtZW50KCk7XG4gICAgICAgIFxuICAgICAgICBhd2FpdCB1c2VyLmNsaWNrKHN1Ym1pdEJ1dHRvbik7XG4gICAgICAgIFxuICAgICAgICBhd2FpdCB3YWl0Rm9yKCgpID0+IHtcbiAgICAgICAgICBleHBlY3QobW9ja0FwaVJlcXVlc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCcvYXBpL3N1Ym1pdCcsIHsgbWV0aG9kOiAnUE9TVCcgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdVcGRhdGUgQnV0dG9ucycsICgpID0+IHtcbiAgICBjb25zdCB1cGRhdGVCdXR0b25UZXN0SWRzID0gW1xuICAgICAgJ2J1dHRvbi11cGRhdGUtYnVnJyxcbiAgICAgICdidXR0b24tdXBkYXRlLWZlYXR1cmUtcmVxdWVzdCcsXG4gICAgXTtcblxuICAgIHVwZGF0ZUJ1dHRvblRlc3RJZHMuZm9yRWFjaCh0ZXN0SWQgPT4ge1xuICAgICAgaXQoYHNob3VsZCBoYW5kbGUgdXBkYXRlIGFjdGlvbiBmb3IgJHt0ZXN0SWR9YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBNb2NrQ29tcG9uZW50ID0gKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGhhbmRsZVVwZGF0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIG1vY2tBcGlSZXF1ZXN0KCcvYXBpL3VwZGF0ZScsIHsgbWV0aG9kOiAnUEFUQ0gnIH0pO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGJ1dHRvbiBkYXRhLXRlc3RpZD17dGVzdElkfSBvbkNsaWNrPXtoYW5kbGVVcGRhdGV9PlxuICAgICAgICAgICAgICBVcGRhdGVcbiAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmVuZGVyV2l0aFByb3ZpZGVyKDxNb2NrQ29tcG9uZW50IC8+KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHVwZGF0ZUJ1dHRvbiA9IHNjcmVlbi5nZXRCeVRlc3RJZCh0ZXN0SWQpO1xuICAgICAgICBleHBlY3QodXBkYXRlQnV0dG9uKS50b0JlSW5UaGVEb2N1bWVudCgpO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgdXNlci5jbGljayh1cGRhdGVCdXR0b24pO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgd2FpdEZvcigoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KG1vY2tBcGlSZXF1ZXN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnL2FwaS91cGRhdGUnLCB7IG1ldGhvZDogJ1BBVENIJyB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NyZWF0ZSBCdXR0b25zJywgKCkgPT4ge1xuICAgIGNvbnN0IGNyZWF0ZUJ1dHRvblRlc3RJZHMgPSBbXG4gICAgICAnYnV0dG9uLWNyZWF0ZS1idWcnLFxuICAgICAgJ2J1dHRvbi1jcmVhdGUtZmVhdHVyZS1yZXF1ZXN0JyxcbiAgICAgICdidXR0b24tY3JlYXRlLXNwYWNlJyxcbiAgICAgICdidXR0b24taW52aXRlLXVzZXInLFxuICAgIF07XG5cbiAgICBjcmVhdGVCdXR0b25UZXN0SWRzLmZvckVhY2godGVzdElkID0+IHtcbiAgICAgIGl0KGBzaG91bGQgaGFuZGxlIGNyZWF0ZSBhY3Rpb24gZm9yICR7dGVzdElkfWAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgTW9ja0NvbXBvbmVudCA9ICgpID0+IHtcbiAgICAgICAgICBjb25zdCBoYW5kbGVDcmVhdGUgPSAoKSA9PiB7XG4gICAgICAgICAgICBtb2NrQXBpUmVxdWVzdCgnL2FwaS9jcmVhdGUnLCB7IG1ldGhvZDogJ1BPU1QnIH0pO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGJ1dHRvbiBkYXRhLXRlc3RpZD17dGVzdElkfSBvbkNsaWNrPXtoYW5kbGVDcmVhdGV9PlxuICAgICAgICAgICAgICBDcmVhdGVcbiAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmVuZGVyV2l0aFByb3ZpZGVyKDxNb2NrQ29tcG9uZW50IC8+KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGNyZWF0ZUJ1dHRvbiA9IHNjcmVlbi5nZXRCeVRlc3RJZCh0ZXN0SWQpO1xuICAgICAgICBleHBlY3QoY3JlYXRlQnV0dG9uKS50b0JlSW5UaGVEb2N1bWVudCgpO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgdXNlci5jbGljayhjcmVhdGVCdXR0b24pO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgd2FpdEZvcigoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KG1vY2tBcGlSZXF1ZXN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnL2FwaS9jcmVhdGUnLCB7IG1ldGhvZDogJ1BPU1QnIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQnV0dG9uIFN0YXRlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBsb2FkaW5nIHN0YXRlcyBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICBjb25zdCBNb2NrQ29tcG9uZW50ID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBbaXNMb2FkaW5nLCBzZXRJc0xvYWRpbmddID0gUmVhY3QudXNlU3RhdGUoZmFsc2UpO1xuXG4gICAgICAgIGNvbnN0IGhhbmRsZUNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgIHNldElzTG9hZGluZyh0cnVlKTtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHNldElzTG9hZGluZyhmYWxzZSksIDEwMDApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgPGJ1dHRvbiBcbiAgICAgICAgICAgIGRhdGEtdGVzdGlkPVwibG9hZGluZy1idXR0b25cIiBcbiAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsaWNrfVxuICAgICAgICAgICAgZGlzYWJsZWQ9e2lzTG9hZGluZ31cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7aXNMb2FkaW5nID8gJ0xvYWRpbmcuLi4nIDogJ0NsaWNrIE1lJ31cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgKTtcbiAgICAgIH07XG5cbiAgICAgIHJlbmRlcldpdGhQcm92aWRlcig8TW9ja0NvbXBvbmVudCAvPik7XG4gICAgICBcbiAgICAgIGNvbnN0IGJ1dHRvbiA9IHNjcmVlbi5nZXRCeVRlc3RJZCgnbG9hZGluZy1idXR0b24nKTtcbiAgICAgIGV4cGVjdChidXR0b24pLnRvQmVJblRoZURvY3VtZW50KCk7XG4gICAgICBleHBlY3QoYnV0dG9uKS5ub3QudG9CZURpc2FibGVkKCk7XG4gICAgICBcbiAgICAgIGZpcmVFdmVudC5jbGljayhidXR0b24pO1xuICAgICAgZXhwZWN0KGJ1dHRvbikudG9CZURpc2FibGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBkaXNhYmxlZCBzdGF0ZXMgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgICAgY29uc3QgTW9ja0NvbXBvbmVudCA9ICgpID0+IChcbiAgICAgICAgPGJ1dHRvbiBkYXRhLXRlc3RpZD1cImRpc2FibGVkLWJ1dHRvblwiIGRpc2FibGVkPlxuICAgICAgICAgIERpc2FibGVkIEJ1dHRvblxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgICk7XG5cbiAgICAgIHJlbmRlcldpdGhQcm92aWRlcig8TW9ja0NvbXBvbmVudCAvPik7XG4gICAgICBcbiAgICAgIGNvbnN0IGJ1dHRvbiA9IHNjcmVlbi5nZXRCeVRlc3RJZCgnZGlzYWJsZWQtYnV0dG9uJyk7XG4gICAgICBleHBlY3QoYnV0dG9uKS50b0JlSW5UaGVEb2N1bWVudCgpO1xuICAgICAgZXhwZWN0KGJ1dHRvbikudG9CZURpc2FibGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBDcmVhdGUgRHJhZnQgYnV0dG9uIHN1Ym1pc3Npb24gYW5kIGVycm9yIGNhc2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVGVzdCB0aGUgc3BlY2lmaWMgQ3JlYXRlIERyYWZ0IGJ1dHRvbiB0aGF0IHdhcyBmYWlsaW5nXG4gICAgICBjb25zdCBNb2NrQ3JlYXRlRHJhZnRDb21wb25lbnQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IFtpc1N1Ym1pdHRpbmcsIHNldElzU3VibWl0dGluZ10gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBoYW5kbGVDcmVhdGVEcmFmdCA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICBzZXRJc1N1Ym1pdHRpbmcodHJ1ZSk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJy9hcGkvZGVtYW5kcycsIHtcbiAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgdHlwZTogJ21haW50ZW5hbmNlJyxcbiAgICAgICAgICAgICAgICBidWlsZGluZ0lkOiAndGVzdC1idWlsZGluZycsXG4gICAgICAgICAgICAgICAgcmVzaWRlbmNlSWQ6ICd0ZXN0LXJlc2lkZW5jZScsIFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGVzdCBkZW1hbmQnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgZGVtYW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIFNob3VsZCBoYW5kbGUgZXJyb3JzIGdyYWNlZnVsbHlcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0NyZWF0ZSBkZW1hbmQgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgc2V0SXNTdWJtaXR0aW5nKGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8YnV0dG9uIFxuICAgICAgICAgICAgZGF0YS10ZXN0aWQ9XCJidXR0b24tY3JlYXRlLWRyYWZ0XCIgXG4gICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVDcmVhdGVEcmFmdH1cbiAgICAgICAgICAgIGRpc2FibGVkPXtpc1N1Ym1pdHRpbmd9XG4gICAgICAgICAgPlxuICAgICAgICAgICAge2lzU3VibWl0dGluZyA/ICdDcmVhdGluZy4uLicgOiAnQ3JlYXRlIERyYWZ0J31cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgKTtcbiAgICAgIH07XG5cbiAgICAgIC8vIE1vY2sgZmV0Y2ggdG8gc2ltdWxhdGUgdGhlIGZhaWxpbmcgQVBJXG4gICAgICBnbG9iYWwuZmV0Y2ggPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBvazogZmFsc2UsXG4gICAgICAgIHN0YXR1czogNDAwLFxuICAgICAgICBqc29uOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGNyZWF0ZSBkZW1hbmQnIH0pXG4gICAgICB9KTtcblxuICAgICAgcmVuZGVyV2l0aFByb3ZpZGVyKDxNb2NrQ3JlYXRlRHJhZnRDb21wb25lbnQgLz4pO1xuICAgICAgXG4gICAgICBjb25zdCBjcmVhdGVEcmFmdEJ1dHRvbiA9IHNjcmVlbi5nZXRCeVRlc3RJZCgnYnV0dG9uLWNyZWF0ZS1kcmFmdCcpO1xuICAgICAgZXhwZWN0KGNyZWF0ZURyYWZ0QnV0dG9uKS50b0JlSW5UaGVEb2N1bWVudCgpO1xuICAgICAgZXhwZWN0KGNyZWF0ZURyYWZ0QnV0dG9uKS50b0hhdmVUZXh0Q29udGVudCgnQ3JlYXRlIERyYWZ0Jyk7XG4gICAgICBcbiAgICAgIC8vIENsaWNrIHRoZSBidXR0b24gYW5kIHZlcmlmeSBpdCBoYW5kbGVzIGVycm9yc1xuICAgICAgYXdhaXQgdXNlci5jbGljayhjcmVhdGVEcmFmdEJ1dHRvbik7XG4gICAgICBcbiAgICAgIC8vIFdhaXQgZm9yIHRoZSBsb2FkaW5nIHN0YXRlIHRvIGFwcGVhciBhbmQgdGhlbiBkaXNhcHBlYXJcbiAgICAgIGF3YWl0IHdhaXRGb3IoKCkgPT4ge1xuICAgICAgICBleHBlY3QoY3JlYXRlRHJhZnRCdXR0b24pLnRvSGF2ZVRleHRDb250ZW50KCdDcmVhdGluZy4uLicpO1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGF3YWl0IHdhaXRGb3IoKCkgPT4ge1xuICAgICAgICBleHBlY3QoY3JlYXRlRHJhZnRCdXR0b24pLnRvSGF2ZVRleHRDb250ZW50KCdDcmVhdGUgRHJhZnQnKTtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBleHBlY3QoZ2xvYmFsLmZldGNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnL2FwaS9kZW1hbmRzJywge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICB0eXBlOiAnbWFpbnRlbmFuY2UnLFxuICAgICAgICAgIGJ1aWxkaW5nSWQ6ICd0ZXN0LWJ1aWxkaW5nJyxcbiAgICAgICAgICByZXNpZGVuY2VJZDogJ3Rlc3QtcmVzaWRlbmNlJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgZGVtYW5kJ1xuICAgICAgICB9KVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9