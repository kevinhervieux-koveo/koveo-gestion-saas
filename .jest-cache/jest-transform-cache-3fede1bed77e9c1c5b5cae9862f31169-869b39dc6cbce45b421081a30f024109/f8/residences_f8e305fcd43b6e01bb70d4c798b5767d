3bcd088b975277c08e7149abc6113d5f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerResidenceRoutes = registerResidenceRoutes;
const db_1 = require("../db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const index_1 = require("../auth/index");
const delayed_update_service_1 = require("../services/delayed-update-service");
/**
 *
 * @param app
 */
/**
 * RegisterResidenceRoutes function.
 * @param app
 * @returns Function result.
 */
function registerResidenceRoutes(app) {
    // Get user's residences
    app.get('/api/user/residences', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const userResidencesList = await db_1.db
                .select({
                residenceId: schema_1.userResidences.residenceId,
            })
                .from(schema_1.userResidences)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json(userResidencesList);
        }
        catch (error) {
            console.error('âŒ Error fetching user residences:', error);
            res.status(500).json({ message: 'Failed to fetch user residences' });
        }
    });
    // Get assigned users for a specific residence
    app.get('/api/residences/:residenceId/assigned-users', index_1.requireAuth, async (req, res) => {
        try {
            const { residenceId } = req.params;
            const currentUser = req.user;
            // Get assigned users with their details
            const assignedUsers = await db_1.db
                .select({
                id: schema_1.users.id,
                username: schema_1.users.username,
                email: schema_1.users.email,
                firstName: schema_1.users.firstName,
                lastName: schema_1.users.lastName,
                phone: schema_1.users.phone,
                relationshipType: schema_1.userResidences.relationshipType,
                startDate: schema_1.userResidences.startDate,
                endDate: schema_1.userResidences.endDate,
                isActive: schema_1.userResidences.isActive,
            })
                .from(schema_1.userResidences)
                .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, residenceId), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json(assignedUsers);
        }
        catch (error) {
            console.error('âŒ Error fetching assigned users:', error);
            res.status(500).json({ message: 'Failed to fetch assigned users' });
        }
    });
    // Update assigned user information
    app.put('/api/residences/:residenceId/assigned-users/:userId', index_1.requireAuth, async (req, res) => {
        try {
            const { userId } = req.params;
            const { firstName, lastName, email, phone } = req.body;
            const currentUser = req.user;
            // Update user information
            await db_1.db
                .update(schema_1.users)
                .set({
                firstName,
                lastName,
                email,
                phone,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.users.id, userId));
            res.json({ message: 'User updated successfully' });
        }
        catch (error) {
            console.error('âŒ Error updating assigned user:', error);
            res.status(500).json({ message: 'Failed to update assigned user' });
        }
    });
    // Get all residences with filtering and search
    app.get('/api/residences', index_1.requireAuth, async (req, res) => {
        try {
            const user = req.user;
            const { search, buildingId, floor } = req.query;
            // Start with base conditions
            const conditions = [(0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)];
            // Apply filters
            if (buildingId) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId));
            }
            if (floor) {
                conditions.push((0, drizzle_orm_1.eq)(schema_1.residences.floor, parseInt(floor)));
            }
            // Use the same access control logic as /api/manager/buildings
            const accessibleBuildingIds = new Set();
            // Check if user belongs to Koveo organization (special global access)
            const userOrgs = await db_1.db
                .select({
                organizationId: schema_1.organizations.id,
                organizationName: schema_1.organizations.name,
                canAccessAllOrganizations: schema_1.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema_1.organizations)
                .innerJoin(schema_1.userOrganizations, (0, drizzle_orm_1.eq)(schema_1.userOrganizations.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userOrganizations.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userOrganizations.isActive, true)));
            const hasGlobalAccess = user.role === 'admin' ||
                userOrgs.some((org) => org.organizationName === 'Koveo' || org.canAccessAllOrganizations);
            if (hasGlobalAccess) {
                console.log(`ðŸŒŸ Admin user or user with global access detected - granting access to ALL residences`);
                // Koveo users can see ALL residences from ALL buildings
                const allBuildings = await db_1.db
                    .select({ id: schema_1.buildings.id })
                    .from(schema_1.buildings)
                    .where((0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true));
                allBuildings.forEach((building) => {
                    accessibleBuildingIds.add(building.id);
                });
            }
            else {
                // Regular users: Get buildings from their organizations
                if (user.role === 'admin' || user.role === 'manager' || user.role === 'demo_manager') {
                    if (userOrgs.length > 0) {
                        const orgIds = userOrgs.map((uo) => uo.organizationId);
                        // Get all buildings from these organizations
                        const orgBuildings = await db_1.db
                            .select({ id: schema_1.buildings.id })
                            .from(schema_1.buildings)
                            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.buildings.organizationId, orgIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                        orgBuildings.forEach((building) => {
                            accessibleBuildingIds.add(building.id);
                        });
                    }
                }
                // For ALL roles (Admin, Manager, Resident, Tenant): Get buildings from their residences
                console.log(`ðŸ” [ACCESS DEBUG] Checking residence access for user ${user.id} with role ${user.role}`);
                const userResidenceRecords = await db_1.db
                    .select({
                    residenceId: schema_1.userResidences.residenceId,
                })
                    .from(schema_1.userResidences)
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
                console.log(`ðŸ” [ACCESS DEBUG] Found ${userResidenceRecords.length} residence records for user ${user.id}`);
                if (userResidenceRecords.length > 0) {
                    const residenceIds = userResidenceRecords.map((ur) => ur.residenceId);
                    // Get buildings through residences
                    const residenceBuildings = await db_1.db
                        .select({ id: schema_1.buildings.id })
                        .from(schema_1.residences)
                        .innerJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                        .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.residences.id, residenceIds), (0, drizzle_orm_1.eq)(schema_1.buildings.isActive, true)));
                    residenceBuildings.forEach((building) => {
                        accessibleBuildingIds.add(building.id);
                    });
                }
            }
            // Add building access filter to conditions
            console.log(`ðŸ” [ACCESS DEBUG] User ${user.id} has access to ${accessibleBuildingIds.size} buildings:`, Array.from(accessibleBuildingIds));
            if (accessibleBuildingIds.size > 0) {
                conditions.push((0, drizzle_orm_1.inArray)(schema_1.residences.buildingId, Array.from(accessibleBuildingIds)));
            }
            else {
                // User has no access to any buildings, return empty result
                return res.json([]);
            }
            // Get residences with building and organization info
            const baseQuery = db_1.db
                .select({
                residence: schema_1.residences,
                building: schema_1.buildings,
                organization: schema_1.organizations,
            })
                .from(schema_1.residences)
                .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                .leftJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)(...conditions));
            let results = await baseQuery;
            // Apply search filter
            if (search) {
                const searchLower = search.toLowerCase();
                results = results.filter((result) => result.residence.unitNumber.toLowerCase().includes(searchLower) ||
                    result.building?.name.toLowerCase().includes(searchLower));
            }
            // Get tenants for each residence
            const residenceIds = results.map((r) => r.residence.id);
            const tenants = residenceIds.length > 0
                ? await db_1.db
                    .select({
                    residenceId: schema_1.userResidences.residenceId,
                    tenant: schema_1.users,
                })
                    .from(schema_1.userResidences)
                    .innerJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.inArray)(schema_1.userResidences.residenceId, residenceIds), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)))
                : [];
            // Group tenants by residence
            const tenantsByResidence = tenants.reduce((acc, { residenceId, tenant }) => {
                if (!acc[residenceId]) {
                    acc[residenceId] = [];
                }
                acc[residenceId].push({
                    id: tenant.id,
                    firstName: tenant.firstName,
                    lastName: tenant.lastName,
                    email: tenant.email,
                });
                return acc;
            }, {});
            // Combine results
            const residencesList = results.map((result) => ({
                ...result.residence,
                building: result.building,
                organization: result.organization,
                tenants: tenantsByResidence[result.residence.id] || [],
            }));
            res.json(residencesList);
        }
        catch (error) {
            console.error('âŒ Error fetching residences:', error);
            res.status(500).json({ message: 'Failed to fetch residences' });
        }
    });
    // Get a specific residence by ID
    app.get('/api/residences/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const user = req.user;
            const result = await db_1.db
                .select({
                residence: schema_1.residences,
                building: schema_1.buildings,
                organization: schema_1.organizations,
            })
                .from(schema_1.residences)
                .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                .leftJoin(schema_1.organizations, (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, schema_1.organizations.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.residences.id, id), (0, drizzle_orm_1.eq)(schema_1.residences.isActive, true)));
            if (result.length === 0) {
                return res.status(404).json({ message: 'Residence not found' });
            }
            const residence = result[0];
            // Apply RBAC check
            if (user.role !== 'admin' && !user.canAccessAllOrganizations) {
                // Check if user has access to this residence's organization
                const userHasAccess = await db_1.db
                    .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                    .from(schema_1.userResidences)
                    .leftJoin(schema_1.residences, (0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, schema_1.residences.id))
                    .leftJoin(schema_1.buildings, (0, drizzle_orm_1.eq)(schema_1.residences.buildingId, schema_1.buildings.id))
                    .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.userId, user.id), (0, drizzle_orm_1.eq)(schema_1.buildings.organizationId, residence.organization.id)));
                if (userHasAccess[0].count === 0) {
                    return res.status(403).json({ message: 'Access denied' });
                }
            }
            // Get tenants for this residence
            const tenants = await db_1.db
                .select({
                id: schema_1.users.id,
                firstName: schema_1.users.firstName,
                lastName: schema_1.users.lastName,
                email: schema_1.users.email,
                relationshipType: schema_1.userResidences.relationshipType,
                startDate: schema_1.userResidences.startDate,
                endDate: schema_1.userResidences.endDate,
            })
                .from(schema_1.userResidences)
                .leftJoin(schema_1.users, (0, drizzle_orm_1.eq)(schema_1.userResidences.userId, schema_1.users.id))
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema_1.userResidences.residenceId, id), (0, drizzle_orm_1.eq)(schema_1.userResidences.isActive, true)));
            res.json({
                ...residence.residence,
                building: residence.building,
                organization: residence.organization,
                tenants,
            });
        }
        catch (error) {
            console.error('âŒ Error fetching residence:', error);
            res.status(500).json({ message: 'Failed to fetch residence' });
        }
    });
    // Update a residence
    app.put('/api/residences/:id', index_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const updateData = req.body;
            // Remove readonly fields
            delete updateData.id;
            delete updateData.createdAt;
            delete updateData.buildingId; // Don't allow changing building
            const updated = await db_1.db
                .update(schema_1.residences)
                .set({
                ...updateData,
                updatedAt: new Date(),
            })
                .where((0, drizzle_orm_1.eq)(schema_1.residences.id, id))
                .returning();
            if (updated.length === 0) {
                return res.status(404).json({ message: 'Residence not found' });
            }
            // Schedule delayed money flow and budget update for the updated residence
            try {
                delayed_update_service_1.delayedUpdateService.scheduleResidenceUpdate(id);
                // Don't fail the residence update if scheduling fails
            }
            catch (e) {
                console.warn('âš ï¸ Failed to schedule residence update:', e);
            }
            res.json(updated[0]);
        }
        catch (error) {
            console.error('âŒ Error updating residence:', error);
            res.status(500).json({ message: 'Failed to update residence' });
        }
    });
    // Create residences when a building is created (called internally)
    app.post('/api/buildings/:buildingId/generate-residences', index_1.requireAuth, async (req, res) => {
        try {
            const { buildingId } = req.params;
            // Get building details
            const building = await db_1.db
                .select()
                .from(schema_1.buildings)
                .where((0, drizzle_orm_1.eq)(schema_1.buildings.id, buildingId))
                .limit(1);
            if (building.length === 0) {
                return res.status(404).json({ message: 'Building not found' });
            }
            const buildingData = building[0];
            const totalUnits = buildingData.totalUnits;
            const totalFloors = buildingData.totalFloors || 1;
            if (totalUnits > 300) {
                return res
                    .status(400)
                    .json({ message: 'Cannot create more than 300 residences per building' });
            }
            // Check if residences already exist for this building
            const existingResidences = await db_1.db
                .select({ count: (0, drizzle_orm_1.sql) `count(*)` })
                .from(schema_1.residences)
                .where((0, drizzle_orm_1.eq)(schema_1.residences.buildingId, buildingId));
            if (existingResidences[0].count > 0) {
                return res.status(400).json({ message: 'Residences already exist for this building' });
            }
            // Generate residences
            const residencesToCreate = [];
            const unitsPerFloor = Math.ceil(totalUnits / totalFloors);
            for (let unit = 1; unit <= totalUnits; unit++) {
                const floor = Math.ceil(unit / unitsPerFloor);
                const unitOnFloor = ((unit - 1) % unitsPerFloor) + 1;
                const unitNumber = `${floor}${unitOnFloor.toString().padStart(2, '0')}`;
                residencesToCreate.push({
                    buildingId,
                    unitNumber,
                    floor,
                    isActive: true,
                });
            }
            // Insert all residences at once
            const createdResidences = await db_1.db
                .insert(schema_1.residences)
                .values(residencesToCreate)
                .returning();
            res.json({
                message: `Successfully created ${createdResidences.length} residences`,
                residences: createdResidences,
            });
        }
        catch (error) {
            console.error('âŒ Error generating residences:', error);
            res.status(500).json({ message: 'Failed to generate residences' });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUMsa0JBQWtCLENBQUM7aUJBQzFCLFNBQVMsRUFBRSxDQUFDO1lBRWYsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsd0JBQXdCLGlCQUFpQixDQUFDLE1BQU0sYUFBYTtnQkFDdEUsVUFBVSxFQUFFLGlCQUFpQjthQUM5QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLCtCQUErQixFQUFFLENBQUMsQ0FBQztRQUNyRSxDQUFDO0lBQ0gsQ0FBQyxDQUNGLENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2FwaS9yZXNpZGVuY2VzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV4cHJlc3MgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGRiIH0gZnJvbSAnLi4vZGInO1xuaW1wb3J0IHtcbiAgcmVzaWRlbmNlcyxcbiAgYnVpbGRpbmdzLFxuICBvcmdhbml6YXRpb25zLFxuICB1c2VyUmVzaWRlbmNlcyxcbiAgdXNlcnMsXG4gIHVzZXJPcmdhbml6YXRpb25zLFxufSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZW1hJztcbmltcG9ydCB7IGVxLCBhbmQsIG9yLCBpbGlrZSwgaW5BcnJheSwgc3FsIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xuaW1wb3J0IHsgcmVxdWlyZUF1dGggfSBmcm9tICcuLi9hdXRoL2luZGV4JztcbmltcG9ydCB7IGRlbGF5ZWRVcGRhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZGVsYXllZC11cGRhdGUtc2VydmljZSc7XG5cbi8qKlxuICpcbiAqIEBwYXJhbSBhcHBcbiAqL1xuLyoqXG4gKiBSZWdpc3RlclJlc2lkZW5jZVJvdXRlcyBmdW5jdGlvbi5cbiAqIEBwYXJhbSBhcHBcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVyUmVzaWRlbmNlUm91dGVzKGFwcDogRXhwcmVzcykge1xuICAvLyBHZXQgdXNlcidzIHJlc2lkZW5jZXNcbiAgYXBwLmdldCgnL2FwaS91c2VyL3Jlc2lkZW5jZXMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XG4gICAgICBjb25zdCB1c2VyUmVzaWRlbmNlc0xpc3QgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICByZXNpZGVuY2VJZDogdXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHVzZXJSZXNpZGVuY2VzKVxuICAgICAgICAud2hlcmUoYW5kKGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgdXNlci5pZCksIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKSkpO1xuICAgICAgcmVzLmpzb24odXNlclJlc2lkZW5jZXNMaXN0KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZmV0Y2hpbmcgdXNlciByZXNpZGVuY2VzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCB1c2VyIHJlc2lkZW5jZXMnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gR2V0IGFzc2lnbmVkIHVzZXJzIGZvciBhIHNwZWNpZmljIHJlc2lkZW5jZVxuICBhcHAuZ2V0KFxuICAgICcvYXBpL3Jlc2lkZW5jZXMvOnJlc2lkZW5jZUlkL2Fzc2lnbmVkLXVzZXJzJyxcbiAgICByZXF1aXJlQXV0aCxcbiAgICBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IHJlc2lkZW5jZUlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyO1xuXG4gICAgICAgIC8vIEdldCBhc3NpZ25lZCB1c2VycyB3aXRoIHRoZWlyIGRldGFpbHNcbiAgICAgICAgY29uc3QgYXNzaWduZWRVc2VycyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgICBpZDogdXNlcnMuaWQsXG4gICAgICAgICAgICB1c2VybmFtZTogdXNlcnMudXNlcm5hbWUsXG4gICAgICAgICAgICBlbWFpbDogdXNlcnMuZW1haWwsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHVzZXJzLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB1c2Vycy5sYXN0TmFtZSxcbiAgICAgICAgICAgIHBob25lOiB1c2Vycy5waG9uZSxcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcFR5cGU6IHVzZXJSZXNpZGVuY2VzLnJlbGF0aW9uc2hpcFR5cGUsXG4gICAgICAgICAgICBzdGFydERhdGU6IHVzZXJSZXNpZGVuY2VzLnN0YXJ0RGF0ZSxcbiAgICAgICAgICAgIGVuZERhdGU6IHVzZXJSZXNpZGVuY2VzLmVuZERhdGUsXG4gICAgICAgICAgICBpc0FjdGl2ZTogdXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZnJvbSh1c2VyUmVzaWRlbmNlcylcbiAgICAgICAgICAuaW5uZXJKb2luKHVzZXJzLCBlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXJzLmlkKSlcbiAgICAgICAgICAud2hlcmUoXG4gICAgICAgICAgICBhbmQoZXEodXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZUlkKSwgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKVxuICAgICAgICAgICk7XG5cbiAgICAgICAgcmVzLmpzb24oYXNzaWduZWRVc2Vycyk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBhc3NpZ25lZCB1c2VyczonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBhc3NpZ25lZCB1c2VycycgfSk7XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIC8vIFVwZGF0ZSBhc3NpZ25lZCB1c2VyIGluZm9ybWF0aW9uXG4gIGFwcC5wdXQoXG4gICAgJy9hcGkvcmVzaWRlbmNlcy86cmVzaWRlbmNlSWQvYXNzaWduZWQtdXNlcnMvOnVzZXJJZCcsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICAgIGNvbnN0IHsgZmlyc3ROYW1lLCBsYXN0TmFtZSwgZW1haWwsIHBob25lIH0gPSByZXEuYm9keTtcbiAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlcjtcblxuICAgICAgICAvLyBVcGRhdGUgdXNlciBpbmZvcm1hdGlvblxuICAgICAgICBhd2FpdCBkYlxuICAgICAgICAgIC51cGRhdGUodXNlcnMpXG4gICAgICAgICAgLnNldCh7XG4gICAgICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZSxcbiAgICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgICAgcGhvbmUsXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSlcbiAgICAgICAgICAud2hlcmUoZXEodXNlcnMuaWQsIHVzZXJJZCkpO1xuXG4gICAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ1VzZXIgdXBkYXRlZCBzdWNjZXNzZnVsbHknIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgdXBkYXRpbmcgYXNzaWduZWQgdXNlcjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgYXNzaWduZWQgdXNlcicgfSk7XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIC8vIEdldCBhbGwgcmVzaWRlbmNlcyB3aXRoIGZpbHRlcmluZyBhbmQgc2VhcmNoXG4gIGFwcC5nZXQoJy9hcGkvcmVzaWRlbmNlcycsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcbiAgICAgIGNvbnN0IHsgc2VhcmNoLCBidWlsZGluZ0lkLCBmbG9vciB9ID0gcmVxLnF1ZXJ5O1xuXG5cbiAgICAgIC8vIFN0YXJ0IHdpdGggYmFzZSBjb25kaXRpb25zXG4gICAgICBjb25zdCBjb25kaXRpb25zID0gW2VxKHJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpXTtcblxuICAgICAgLy8gQXBwbHkgZmlsdGVyc1xuICAgICAgaWYgKGJ1aWxkaW5nSWQpIHtcbiAgICAgICAgY29uZGl0aW9ucy5wdXNoKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCkpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmxvb3IpIHtcbiAgICAgICAgY29uZGl0aW9ucy5wdXNoKGVxKHJlc2lkZW5jZXMuZmxvb3IsIHBhcnNlSW50KGZsb29yKSkpO1xuICAgICAgfVxuXG4gICAgICAvLyBVc2UgdGhlIHNhbWUgYWNjZXNzIGNvbnRyb2wgbG9naWMgYXMgL2FwaS9tYW5hZ2VyL2J1aWxkaW5nc1xuICAgICAgY29uc3QgYWNjZXNzaWJsZUJ1aWxkaW5nSWRzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgYmVsb25ncyB0byBLb3ZlbyBvcmdhbml6YXRpb24gKHNwZWNpYWwgZ2xvYmFsIGFjY2VzcylcbiAgICAgIGNvbnN0IHVzZXJPcmdzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IG9yZ2FuaXphdGlvbnMuaWQsXG4gICAgICAgICAgb3JnYW5pemF0aW9uTmFtZTogb3JnYW5pemF0aW9ucy5uYW1lLFxuICAgICAgICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLmNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnMsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKG9yZ2FuaXphdGlvbnMpXG4gICAgICAgIC5pbm5lckpvaW4odXNlck9yZ2FuaXphdGlvbnMsIGVxKHVzZXJPcmdhbml6YXRpb25zLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgLndoZXJlKGFuZChlcSh1c2VyT3JnYW5pemF0aW9ucy51c2VySWQsIHVzZXIuaWQpLCBlcSh1c2VyT3JnYW5pemF0aW9ucy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgY29uc3QgaGFzR2xvYmFsQWNjZXNzID1cbiAgICAgICAgdXNlci5yb2xlID09PSAnYWRtaW4nIHx8XG4gICAgICAgIHVzZXJPcmdzLnNvbWUoKG9yZykgPT4gb3JnLm9yZ2FuaXphdGlvbk5hbWUgPT09ICdLb3ZlbycgfHwgb3JnLmNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnMpO1xuXG4gICAgICBpZiAoaGFzR2xvYmFsQWNjZXNzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGDwn4yfIEFkbWluIHVzZXIgb3IgdXNlciB3aXRoIGdsb2JhbCBhY2Nlc3MgZGV0ZWN0ZWQgLSBncmFudGluZyBhY2Nlc3MgdG8gQUxMIHJlc2lkZW5jZXNgXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gS292ZW8gdXNlcnMgY2FuIHNlZSBBTEwgcmVzaWRlbmNlcyBmcm9tIEFMTCBidWlsZGluZ3NcbiAgICAgICAgY29uc3QgYWxsQnVpbGRpbmdzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgaWQ6IGJ1aWxkaW5ncy5pZCB9KVxuICAgICAgICAgIC5mcm9tKGJ1aWxkaW5ncylcbiAgICAgICAgICAud2hlcmUoZXEoYnVpbGRpbmdzLmlzQWN0aXZlLCB0cnVlKSk7XG5cbiAgICAgICAgYWxsQnVpbGRpbmdzLmZvckVhY2goKGJ1aWxkaW5nKSA9PiB7XG4gICAgICAgICAgYWNjZXNzaWJsZUJ1aWxkaW5nSWRzLmFkZChidWlsZGluZy5pZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gUmVndWxhciB1c2VyczogR2V0IGJ1aWxkaW5ncyBmcm9tIHRoZWlyIG9yZ2FuaXphdGlvbnNcbiAgICAgICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJyB8fCB1c2VyLnJvbGUgPT09ICdtYW5hZ2VyJyB8fCB1c2VyLnJvbGUgPT09ICdkZW1vX21hbmFnZXInKSB7XG4gICAgICAgICAgaWYgKHVzZXJPcmdzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IG9yZ0lkcyA9IHVzZXJPcmdzLm1hcCgodW8pID0+IHVvLm9yZ2FuaXphdGlvbklkKTtcblxuICAgICAgICAgICAgLy8gR2V0IGFsbCBidWlsZGluZ3MgZnJvbSB0aGVzZSBvcmdhbml6YXRpb25zXG4gICAgICAgICAgICBjb25zdCBvcmdCdWlsZGluZ3MgPSBhd2FpdCBkYlxuICAgICAgICAgICAgICAuc2VsZWN0KHsgaWQ6IGJ1aWxkaW5ncy5pZCB9KVxuICAgICAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgICAgIC53aGVyZShhbmQoaW5BcnJheShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ0lkcyksIGVxKGJ1aWxkaW5ncy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgICAgICAgb3JnQnVpbGRpbmdzLmZvckVhY2goKGJ1aWxkaW5nKSA9PiB7XG4gICAgICAgICAgICAgIGFjY2Vzc2libGVCdWlsZGluZ0lkcy5hZGQoYnVpbGRpbmcuaWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRm9yIEFMTCByb2xlcyAoQWRtaW4sIE1hbmFnZXIsIFJlc2lkZW50LCBUZW5hbnQpOiBHZXQgYnVpbGRpbmdzIGZyb20gdGhlaXIgcmVzaWRlbmNlc1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBg8J+UjSBbQUNDRVNTIERFQlVHXSBDaGVja2luZyByZXNpZGVuY2UgYWNjZXNzIGZvciB1c2VyICR7dXNlci5pZH0gd2l0aCByb2xlICR7dXNlci5yb2xlfWBcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgdXNlclJlc2lkZW5jZVJlY29yZHMgPSBhd2FpdCBkYlxuICAgICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgICAgcmVzaWRlbmNlSWQ6IHVzZXJSZXNpZGVuY2VzLnJlc2lkZW5jZUlkLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgICAgLndoZXJlKGFuZChlcSh1c2VyUmVzaWRlbmNlcy51c2VySWQsIHVzZXIuaWQpLCBlcSh1c2VyUmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBg8J+UjSBbQUNDRVNTIERFQlVHXSBGb3VuZCAke3VzZXJSZXNpZGVuY2VSZWNvcmRzLmxlbmd0aH0gcmVzaWRlbmNlIHJlY29yZHMgZm9yIHVzZXIgJHt1c2VyLmlkfWBcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAodXNlclJlc2lkZW5jZVJlY29yZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IHJlc2lkZW5jZUlkcyA9IHVzZXJSZXNpZGVuY2VSZWNvcmRzLm1hcCgodXIpID0+IHVyLnJlc2lkZW5jZUlkKTtcblxuICAgICAgICAgIC8vIEdldCBidWlsZGluZ3MgdGhyb3VnaCByZXNpZGVuY2VzXG4gICAgICAgICAgY29uc3QgcmVzaWRlbmNlQnVpbGRpbmdzID0gYXdhaXQgZGJcbiAgICAgICAgICAgIC5zZWxlY3QoeyBpZDogYnVpbGRpbmdzLmlkIH0pXG4gICAgICAgICAgICAuZnJvbShyZXNpZGVuY2VzKVxuICAgICAgICAgICAgLmlubmVySm9pbihidWlsZGluZ3MsIGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdzLmlkKSlcbiAgICAgICAgICAgIC53aGVyZShhbmQoaW5BcnJheShyZXNpZGVuY2VzLmlkLCByZXNpZGVuY2VJZHMpLCBlcShidWlsZGluZ3MuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgICAgICByZXNpZGVuY2VCdWlsZGluZ3MuZm9yRWFjaCgoYnVpbGRpbmcpID0+IHtcbiAgICAgICAgICAgIGFjY2Vzc2libGVCdWlsZGluZ0lkcy5hZGQoYnVpbGRpbmcuaWQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBidWlsZGluZyBhY2Nlc3MgZmlsdGVyIHRvIGNvbmRpdGlvbnNcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg8J+UjSBbQUNDRVNTIERFQlVHXSBVc2VyICR7dXNlci5pZH0gaGFzIGFjY2VzcyB0byAke2FjY2Vzc2libGVCdWlsZGluZ0lkcy5zaXplfSBidWlsZGluZ3M6YCxcbiAgICAgICAgQXJyYXkuZnJvbShhY2Nlc3NpYmxlQnVpbGRpbmdJZHMpXG4gICAgICApO1xuICAgICAgaWYgKGFjY2Vzc2libGVCdWlsZGluZ0lkcy5zaXplID4gMCkge1xuICAgICAgICBjb25kaXRpb25zLnB1c2goaW5BcnJheShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIEFycmF5LmZyb20oYWNjZXNzaWJsZUJ1aWxkaW5nSWRzKSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVXNlciBoYXMgbm8gYWNjZXNzIHRvIGFueSBidWlsZGluZ3MsIHJldHVybiBlbXB0eSByZXN1bHRcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKFtdKTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IHJlc2lkZW5jZXMgd2l0aCBidWlsZGluZyBhbmQgb3JnYW5pemF0aW9uIGluZm9cbiAgICAgIGNvbnN0IGJhc2VRdWVyeSA9IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIHJlc2lkZW5jZTogcmVzaWRlbmNlcyxcbiAgICAgICAgICBidWlsZGluZzogYnVpbGRpbmdzLFxuICAgICAgICAgIG9yZ2FuaXphdGlvbjogb3JnYW5pemF0aW9ucyxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgLmxlZnRKb2luKGJ1aWxkaW5ncywgZXEocmVzaWRlbmNlcy5idWlsZGluZ0lkLCBidWlsZGluZ3MuaWQpKVxuICAgICAgICAubGVmdEpvaW4ob3JnYW5pemF0aW9ucywgZXEoYnVpbGRpbmdzLm9yZ2FuaXphdGlvbklkLCBvcmdhbml6YXRpb25zLmlkKSlcbiAgICAgICAgLndoZXJlKGFuZCguLi5jb25kaXRpb25zKSk7XG5cbiAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgYmFzZVF1ZXJ5O1xuXG4gICAgICAvLyBBcHBseSBzZWFyY2ggZmlsdGVyXG4gICAgICBpZiAoc2VhcmNoKSB7XG4gICAgICAgIGNvbnN0IHNlYXJjaExvd2VyID0gc2VhcmNoLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihcbiAgICAgICAgICAocmVzdWx0KSA9PlxuICAgICAgICAgICAgcmVzdWx0LnJlc2lkZW5jZS51bml0TnVtYmVyLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2VhcmNoTG93ZXIpIHx8XG4gICAgICAgICAgICByZXN1bHQuYnVpbGRpbmc/Lm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hMb3dlcilcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IHRlbmFudHMgZm9yIGVhY2ggcmVzaWRlbmNlXG4gICAgICBjb25zdCByZXNpZGVuY2VJZHMgPSByZXN1bHRzLm1hcCgocikgPT4gci5yZXNpZGVuY2UuaWQpO1xuICAgICAgY29uc3QgdGVuYW50cyA9XG4gICAgICAgIHJlc2lkZW5jZUlkcy5sZW5ndGggPiAwXG4gICAgICAgICAgPyBhd2FpdCBkYlxuICAgICAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgICAgICByZXNpZGVuY2VJZDogdXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsXG4gICAgICAgICAgICAgICAgdGVuYW50OiB1c2VycyxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgICAgICAgIC5pbm5lckpvaW4odXNlcnMsIGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgdXNlcnMuaWQpKVxuICAgICAgICAgICAgICAud2hlcmUoXG4gICAgICAgICAgICAgICAgYW5kKFxuICAgICAgICAgICAgICAgICAgaW5BcnJheSh1c2VyUmVzaWRlbmNlcy5yZXNpZGVuY2VJZCwgcmVzaWRlbmNlSWRzKSxcbiAgICAgICAgICAgICAgICAgIGVxKHVzZXJSZXNpZGVuY2VzLmlzQWN0aXZlLCB0cnVlKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgIDogW107XG5cbiAgICAgIC8vIEdyb3VwIHRlbmFudHMgYnkgcmVzaWRlbmNlXG4gICAgICBjb25zdCB0ZW5hbnRzQnlSZXNpZGVuY2UgPSB0ZW5hbnRzLnJlZHVjZShcbiAgICAgICAgKGFjYywgeyByZXNpZGVuY2VJZCwgdGVuYW50IH0pID0+IHtcbiAgICAgICAgICBpZiAoIWFjY1tyZXNpZGVuY2VJZF0pIHtcbiAgICAgICAgICAgIGFjY1tyZXNpZGVuY2VJZF0gPSBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYWNjW3Jlc2lkZW5jZUlkXS5wdXNoKHtcbiAgICAgICAgICAgIGlkOiB0ZW5hbnQuaWQsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRlbmFudC5maXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdGVuYW50Lmxhc3ROYW1lLFxuICAgICAgICAgICAgZW1haWw6IHRlbmFudC5lbWFpbCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LFxuICAgICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnlbXT5cbiAgICAgICk7XG5cbiAgICAgIC8vIENvbWJpbmUgcmVzdWx0c1xuICAgICAgY29uc3QgcmVzaWRlbmNlc0xpc3QgPSByZXN1bHRzLm1hcCgocmVzdWx0KSA9PiAoe1xuICAgICAgICAuLi5yZXN1bHQucmVzaWRlbmNlLFxuICAgICAgICBidWlsZGluZzogcmVzdWx0LmJ1aWxkaW5nLFxuICAgICAgICBvcmdhbml6YXRpb246IHJlc3VsdC5vcmdhbml6YXRpb24sXG4gICAgICAgIHRlbmFudHM6IHRlbmFudHNCeVJlc2lkZW5jZVtyZXN1bHQucmVzaWRlbmNlLmlkXSB8fCBbXSxcbiAgICAgIH0pKTtcblxuICAgICAgcmVzLmpzb24ocmVzaWRlbmNlc0xpc3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyByZXNpZGVuY2VzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCByZXNpZGVuY2VzJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEdldCBhIHNwZWNpZmljIHJlc2lkZW5jZSBieSBJRFxuICBhcHAuZ2V0KCcvYXBpL3Jlc2lkZW5jZXMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgcmVzaWRlbmNlOiByZXNpZGVuY2VzLFxuICAgICAgICAgIGJ1aWxkaW5nOiBidWlsZGluZ3MsXG4gICAgICAgICAgb3JnYW5pemF0aW9uOiBvcmdhbml6YXRpb25zLFxuICAgICAgICB9KVxuICAgICAgICAuZnJvbShyZXNpZGVuY2VzKVxuICAgICAgICAubGVmdEpvaW4oYnVpbGRpbmdzLCBlcShyZXNpZGVuY2VzLmJ1aWxkaW5nSWQsIGJ1aWxkaW5ncy5pZCkpXG4gICAgICAgIC5sZWZ0Sm9pbihvcmdhbml6YXRpb25zLCBlcShidWlsZGluZ3Mub3JnYW5pemF0aW9uSWQsIG9yZ2FuaXphdGlvbnMuaWQpKVxuICAgICAgICAud2hlcmUoYW5kKGVxKHJlc2lkZW5jZXMuaWQsIGlkKSwgZXEocmVzaWRlbmNlcy5pc0FjdGl2ZSwgdHJ1ZSkpKTtcblxuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZSBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXNpZGVuY2UgPSByZXN1bHRbMF07XG5cbiAgICAgIC8vIEFwcGx5IFJCQUMgY2hlY2tcbiAgICAgIGlmICh1c2VyLnJvbGUgIT09ICdhZG1pbicgJiYgIXVzZXIuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucykge1xuICAgICAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyBhY2Nlc3MgdG8gdGhpcyByZXNpZGVuY2UncyBvcmdhbml6YXRpb25cbiAgICAgICAgY29uc3QgdXNlckhhc0FjY2VzcyA9IGF3YWl0IGRiXG4gICAgICAgICAgLnNlbGVjdCh7IGNvdW50OiBzcWw8bnVtYmVyPmBjb3VudCgqKWAgfSlcbiAgICAgICAgICAuZnJvbSh1c2VyUmVzaWRlbmNlcylcbiAgICAgICAgICAubGVmdEpvaW4ocmVzaWRlbmNlcywgZXEodXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIHJlc2lkZW5jZXMuaWQpKVxuICAgICAgICAgIC5sZWZ0Sm9pbihidWlsZGluZ3MsIGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdzLmlkKSlcbiAgICAgICAgICAud2hlcmUoXG4gICAgICAgICAgICBhbmQoXG4gICAgICAgICAgICAgIGVxKHVzZXJSZXNpZGVuY2VzLnVzZXJJZCwgdXNlci5pZCksXG4gICAgICAgICAgICAgIGVxKGJ1aWxkaW5ncy5vcmdhbml6YXRpb25JZCwgcmVzaWRlbmNlLm9yZ2FuaXphdGlvbi5pZClcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuXG4gICAgICAgIGlmICh1c2VySGFzQWNjZXNzWzBdLmNvdW50ID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCB0ZW5hbnRzIGZvciB0aGlzIHJlc2lkZW5jZVxuICAgICAgY29uc3QgdGVuYW50cyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIGlkOiB1c2Vycy5pZCxcbiAgICAgICAgICBmaXJzdE5hbWU6IHVzZXJzLmZpcnN0TmFtZSxcbiAgICAgICAgICBsYXN0TmFtZTogdXNlcnMubGFzdE5hbWUsXG4gICAgICAgICAgZW1haWw6IHVzZXJzLmVtYWlsLFxuICAgICAgICAgIHJlbGF0aW9uc2hpcFR5cGU6IHVzZXJSZXNpZGVuY2VzLnJlbGF0aW9uc2hpcFR5cGUsXG4gICAgICAgICAgc3RhcnREYXRlOiB1c2VyUmVzaWRlbmNlcy5zdGFydERhdGUsXG4gICAgICAgICAgZW5kRGF0ZTogdXNlclJlc2lkZW5jZXMuZW5kRGF0ZSxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20odXNlclJlc2lkZW5jZXMpXG4gICAgICAgIC5sZWZ0Sm9pbih1c2VycywgZXEodXNlclJlc2lkZW5jZXMudXNlcklkLCB1c2Vycy5pZCkpXG4gICAgICAgIC53aGVyZShhbmQoZXEodXNlclJlc2lkZW5jZXMucmVzaWRlbmNlSWQsIGlkKSwgZXEodXNlclJlc2lkZW5jZXMuaXNBY3RpdmUsIHRydWUpKSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgLi4ucmVzaWRlbmNlLnJlc2lkZW5jZSxcbiAgICAgICAgYnVpbGRpbmc6IHJlc2lkZW5jZS5idWlsZGluZyxcbiAgICAgICAgb3JnYW5pemF0aW9uOiByZXNpZGVuY2Uub3JnYW5pemF0aW9uLFxuICAgICAgICB0ZW5hbnRzLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIHJlc2lkZW5jZTonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggcmVzaWRlbmNlJyB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFVwZGF0ZSBhIHJlc2lkZW5jZVxuICBhcHAucHV0KCcvYXBpL3Jlc2lkZW5jZXMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHVwZGF0ZURhdGEgPSByZXEuYm9keTtcblxuICAgICAgLy8gUmVtb3ZlIHJlYWRvbmx5IGZpZWxkc1xuICAgICAgZGVsZXRlIHVwZGF0ZURhdGEuaWQ7XG4gICAgICBkZWxldGUgdXBkYXRlRGF0YS5jcmVhdGVkQXQ7XG4gICAgICBkZWxldGUgdXBkYXRlRGF0YS5idWlsZGluZ0lkOyAvLyBEb24ndCBhbGxvdyBjaGFuZ2luZyBidWlsZGluZ1xuXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgZGJcbiAgICAgICAgLnVwZGF0ZShyZXNpZGVuY2VzKVxuICAgICAgICAuc2V0KHtcbiAgICAgICAgICAuLi51cGRhdGVEYXRhLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLndoZXJlKGVxKHJlc2lkZW5jZXMuaWQsIGlkKSlcbiAgICAgICAgLnJldHVybmluZygpO1xuXG4gICAgICBpZiAodXBkYXRlZC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZSBub3QgZm91bmQnIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBTY2hlZHVsZSBkZWxheWVkIG1vbmV5IGZsb3cgYW5kIGJ1ZGdldCB1cGRhdGUgZm9yIHRoZSB1cGRhdGVkIHJlc2lkZW5jZVxuICAgICAgdHJ5IHtcbiAgICAgICAgZGVsYXllZFVwZGF0ZVNlcnZpY2Uuc2NoZWR1bGVSZXNpZGVuY2VVcGRhdGUoaWQpO1xuICAgICAgICAvLyBEb24ndCBmYWlsIHRoZSByZXNpZGVuY2UgdXBkYXRlIGlmIHNjaGVkdWxpbmcgZmFpbHNcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCfimqDvuI8gRmFpbGVkIHRvIHNjaGVkdWxlIHJlc2lkZW5jZSB1cGRhdGU6JywgZSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHVwZGF0ZWRbMF0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyByZXNpZGVuY2U6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAnRmFpbGVkIHRvIHVwZGF0ZSByZXNpZGVuY2UnIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gQ3JlYXRlIHJlc2lkZW5jZXMgd2hlbiBhIGJ1aWxkaW5nIGlzIGNyZWF0ZWQgKGNhbGxlZCBpbnRlcm5hbGx5KVxuICBhcHAucG9zdChcbiAgICAnL2FwaS9idWlsZGluZ3MvOmJ1aWxkaW5nSWQvZ2VuZXJhdGUtcmVzaWRlbmNlcycsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBidWlsZGluZ0lkIH0gPSByZXEucGFyYW1zO1xuXG4gICAgICAgIC8vIEdldCBidWlsZGluZyBkZXRhaWxzXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgICAuZnJvbShidWlsZGluZ3MpXG4gICAgICAgICAgLndoZXJlKGVxKGJ1aWxkaW5ncy5pZCwgYnVpbGRpbmdJZCkpXG4gICAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICAgIGlmIChidWlsZGluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnQnVpbGRpbmcgbm90IGZvdW5kJyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nRGF0YSA9IGJ1aWxkaW5nWzBdO1xuICAgICAgICBjb25zdCB0b3RhbFVuaXRzID0gYnVpbGRpbmdEYXRhLnRvdGFsVW5pdHM7XG4gICAgICAgIGNvbnN0IHRvdGFsRmxvb3JzID0gYnVpbGRpbmdEYXRhLnRvdGFsRmxvb3JzIHx8IDE7XG5cbiAgICAgICAgaWYgKHRvdGFsVW5pdHMgPiAzMDApIHtcbiAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICAuc3RhdHVzKDQwMClcbiAgICAgICAgICAgIC5qc29uKHsgbWVzc2FnZTogJ0Nhbm5vdCBjcmVhdGUgbW9yZSB0aGFuIDMwMCByZXNpZGVuY2VzIHBlciBidWlsZGluZycgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiByZXNpZGVuY2VzIGFscmVhZHkgZXhpc3QgZm9yIHRoaXMgYnVpbGRpbmdcbiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXNpZGVuY2VzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgY291bnQ6IHNxbDxudW1iZXI+YGNvdW50KCopYCB9KVxuICAgICAgICAgIC5mcm9tKHJlc2lkZW5jZXMpXG4gICAgICAgICAgLndoZXJlKGVxKHJlc2lkZW5jZXMuYnVpbGRpbmdJZCwgYnVpbGRpbmdJZCkpO1xuXG4gICAgICAgIGlmIChleGlzdGluZ1Jlc2lkZW5jZXNbMF0uY291bnQgPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ1Jlc2lkZW5jZXMgYWxyZWFkeSBleGlzdCBmb3IgdGhpcyBidWlsZGluZycgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZW5lcmF0ZSByZXNpZGVuY2VzXG4gICAgICAgIGNvbnN0IHJlc2lkZW5jZXNUb0NyZWF0ZSA9IFtdO1xuICAgICAgICBjb25zdCB1bml0c1BlckZsb29yID0gTWF0aC5jZWlsKHRvdGFsVW5pdHMgLyB0b3RhbEZsb29ycyk7XG5cbiAgICAgICAgZm9yIChsZXQgdW5pdCA9IDE7IHVuaXQgPD0gdG90YWxVbml0czsgdW5pdCsrKSB7XG4gICAgICAgICAgY29uc3QgZmxvb3IgPSBNYXRoLmNlaWwodW5pdCAvIHVuaXRzUGVyRmxvb3IpO1xuICAgICAgICAgIGNvbnN0IHVuaXRPbkZsb29yID0gKCh1bml0IC0gMSkgJSB1bml0c1BlckZsb29yKSArIDE7XG4gICAgICAgICAgY29uc3QgdW5pdE51bWJlciA9IGAke2Zsb29yfSR7dW5pdE9uRmxvb3IudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWA7XG5cbiAgICAgICAgICByZXNpZGVuY2VzVG9DcmVhdGUucHVzaCh7XG4gICAgICAgICAgICBidWlsZGluZ0lkLFxuICAgICAgICAgICAgdW5pdE51bWJlcixcbiAgICAgICAgICAgIGZsb29yLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJbnNlcnQgYWxsIHJlc2lkZW5jZXMgYXQgb25jZVxuICAgICAgICBjb25zdCBjcmVhdGVkUmVzaWRlbmNlcyA9IGF3YWl0IGRiXG4gICAgICAgICAgLmluc2VydChyZXNpZGVuY2VzKVxuICAgICAgICAgIC52YWx1ZXMocmVzaWRlbmNlc1RvQ3JlYXRlKVxuICAgICAgICAgIC5yZXR1cm5pbmcoKTtcblxuICAgICAgICByZXMuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogYFN1Y2Nlc3NmdWxseSBjcmVhdGVkICR7Y3JlYXRlZFJlc2lkZW5jZXMubGVuZ3RofSByZXNpZGVuY2VzYCxcbiAgICAgICAgICByZXNpZGVuY2VzOiBjcmVhdGVkUmVzaWRlbmNlcyxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBnZW5lcmF0aW5nIHJlc2lkZW5jZXM6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gZ2VuZXJhdGUgcmVzaWRlbmNlcycgfSk7XG4gICAgICB9XG4gICAgfVxuICApO1xufVxuIl0sInZlcnNpb24iOjN9