45e302bd608d6fbd423050d6921450ba
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.insertSslCertificateSchema = exports.sslCertificates = exports.sslStatusEnum = void 0;
const drizzle_orm_1 = require("drizzle-orm");
const pg_core_1 = require("drizzle-orm/pg-core");
const zod_1 = require("zod");
const core_1 = require("./core");
// Infrastructure enums
exports.sslStatusEnum = (0, pg_core_1.pgEnum)('ssl_status', [
    'active',
    'pending',
    'expired',
    'revoked',
    'failed',
]);
// Infrastructure tables
/**
 * SSL certificates table for managing domain SSL certificates.
 * Supports automated certificate management and renewal tracking.
 */
exports.sslCertificates = (0, pg_core_1.pgTable)('ssl_certificates', {
    id: (0, pg_core_1.uuid)('id')
        .primaryKey()
        .default((0, drizzle_orm_1.sql) `gen_random_uuid()`),
    domain: (0, pg_core_1.text)('domain').notNull().unique(),
    certificateData: (0, pg_core_1.text)('certificate_data').notNull(),
    privateKey: (0, pg_core_1.text)('private_key').notNull(),
    issuer: (0, pg_core_1.text)('issuer').notNull(),
    subject: (0, pg_core_1.text)('subject').notNull(),
    serialNumber: (0, pg_core_1.text)('serial_number').notNull(),
    fingerprint: (0, pg_core_1.text)('fingerprint').notNull(),
    validFrom: (0, pg_core_1.timestamp)('valid_from').notNull(),
    validTo: (0, pg_core_1.timestamp)('valid_to').notNull(),
    status: (0, exports.sslStatusEnum)('status').notNull().default('pending'),
    autoRenew: (0, pg_core_1.boolean)('auto_renew').notNull().default(true),
    renewalAttempts: (0, pg_core_1.integer)('renewal_attempts').notNull().default(0),
    maxRenewalAttempts: (0, pg_core_1.integer)('max_renewal_attempts').notNull().default(3),
    dnsProvider: (0, pg_core_1.text)('dns_provider'),
    lastRenewalAttempt: (0, pg_core_1.timestamp)('last_renewal_attempt'),
    nextRenewalDate: (0, pg_core_1.timestamp)('next_renewal_date'),
    // Additional SSL management fields
    certificateChain: (0, pg_core_1.text)('certificate_chain'),
    renewalError: (0, pg_core_1.text)('renewal_error'),
    dnsCredentials: (0, pg_core_1.text)('dns_credentials'),
    notificationEmails: (0, pg_core_1.text)('notification_emails'),
    createdBy: (0, pg_core_1.uuid)('created_by')
        .notNull()
        .references(() => core_1.users.id),
    createdAt: (0, pg_core_1.timestamp)('created_at').defaultNow(),
    updatedAt: (0, pg_core_1.timestamp)('updated_at').defaultNow(),
});
// Insert schemas
exports.insertSslCertificateSchema = zod_1.z.object({
    domain: zod_1.z.string(),
    certificateData: zod_1.z.string(),
    privateKey: zod_1.z.string(),
    issuer: zod_1.z.string(),
    subject: zod_1.z.string(),
    serialNumber: zod_1.z.string(),
    fingerprint: zod_1.z.string(),
    validFrom: zod_1.z.date(),
    validTo: zod_1.z.date(),
    status: zod_1.z.string().default('pending'),
    autoRenew: zod_1.z.boolean().default(true),
    renewalAttempts: zod_1.z.number().int().default(0),
    maxRenewalAttempts: zod_1.z.number().int().default(3),
    dnsProvider: zod_1.z.string().optional(),
    lastRenewalAttempt: zod_1.z.date().optional(),
    nextRenewalDate: zod_1.z.date().optional(),
    createdBy: zod_1.z.string().uuid(),
});
// Relations - temporarily commented out due to drizzle-orm version compatibility
// export const sslCertificatesRelations = relations(sslCertificates, ({ one }) => ({
//   createdBy: one(users, {
//     fields: [sslCertificates.createdBy],
//     references: [users.id],
//   }),
// }));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zaGFyZWQvc2NoZW1hcy9pbmZyYXN0cnVjdHVyZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBa0M7QUFDbEMsaURBQStGO0FBRS9GLDZCQUF3QjtBQUV4QixpQ0FBK0I7QUFFL0IsdUJBQXVCO0FBQ1YsUUFBQSxhQUFhLEdBQUcsSUFBQSxnQkFBTSxFQUFDLFlBQVksRUFBRTtJQUNoRCxRQUFRO0lBQ1IsU0FBUztJQUNULFNBQVM7SUFDVCxTQUFTO0lBQ1QsUUFBUTtDQUNULENBQUMsQ0FBQztBQUVILHdCQUF3QjtBQUN4Qjs7O0dBR0c7QUFDVSxRQUFBLGVBQWUsR0FBRyxJQUFBLGlCQUFPLEVBQUMsa0JBQWtCLEVBQUU7SUFDekQsRUFBRSxFQUFFLElBQUEsY0FBSSxFQUFDLElBQUksQ0FBQztTQUNYLFVBQVUsRUFBRTtTQUNaLE9BQU8sQ0FBQyxJQUFBLGlCQUFHLEVBQUEsbUJBQW1CLENBQUM7SUFDbEMsTUFBTSxFQUFFLElBQUEsY0FBSSxFQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sRUFBRTtJQUN6QyxlQUFlLEVBQUUsSUFBQSxjQUFJLEVBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFPLEVBQUU7SUFDbkQsVUFBVSxFQUFFLElBQUEsY0FBSSxFQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sRUFBRTtJQUN6QyxNQUFNLEVBQUUsSUFBQSxjQUFJLEVBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxFQUFFO0lBQ2hDLE9BQU8sRUFBRSxJQUFBLGNBQUksRUFBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLEVBQUU7SUFDbEMsWUFBWSxFQUFFLElBQUEsY0FBSSxFQUFDLGVBQWUsQ0FBQyxDQUFDLE9BQU8sRUFBRTtJQUM3QyxXQUFXLEVBQUUsSUFBQSxjQUFJLEVBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxFQUFFO0lBQzFDLFNBQVMsRUFBRSxJQUFBLG1CQUFTLEVBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxFQUFFO0lBQzVD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O0NBQzdCLENBQUMsQ0FBQztBQVlILGlGQUFpRjtBQUNqRixxRkFBcUY7QUFDckYsNEJBQTRCO0FBQzVCLDJDQUEyQztBQUMzQyw4QkFBOEI7QUFDOUIsUUFBUTtBQUNSLE9BQU8iLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zaGFyZWQvc2NoZW1hcy9pbmZyYXN0cnVjdHVyZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzcWwgfSBmcm9tICdkcml6emxlLW9ybSc7XG5pbXBvcnQgeyBwZ1RhYmxlLCB0ZXh0LCB0aW1lc3RhbXAsIHV1aWQsIHBnRW51bSwgYm9vbGVhbiwgaW50ZWdlciB9IGZyb20gJ2RyaXp6bGUtb3JtL3BnLWNvcmUnO1xuaW1wb3J0IHsgY3JlYXRlSW5zZXJ0U2NoZW1hIH0gZnJvbSAnZHJpenpsZS16b2QnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyByZWxhdGlvbnMgfSBmcm9tICdkcml6emxlLW9ybSc7XG5pbXBvcnQgeyB1c2VycyB9IGZyb20gJy4vY29yZSc7XG5cbi8vIEluZnJhc3RydWN0dXJlIGVudW1zXG5leHBvcnQgY29uc3Qgc3NsU3RhdHVzRW51bSA9IHBnRW51bSgnc3NsX3N0YXR1cycsIFtcbiAgJ2FjdGl2ZScsXG4gICdwZW5kaW5nJyxcbiAgJ2V4cGlyZWQnLFxuICAncmV2b2tlZCcsXG4gICdmYWlsZWQnLFxuXSk7XG5cbi8vIEluZnJhc3RydWN0dXJlIHRhYmxlc1xuLyoqXG4gKiBTU0wgY2VydGlmaWNhdGVzIHRhYmxlIGZvciBtYW5hZ2luZyBkb21haW4gU1NMIGNlcnRpZmljYXRlcy5cbiAqIFN1cHBvcnRzIGF1dG9tYXRlZCBjZXJ0aWZpY2F0ZSBtYW5hZ2VtZW50IGFuZCByZW5ld2FsIHRyYWNraW5nLlxuICovXG5leHBvcnQgY29uc3Qgc3NsQ2VydGlmaWNhdGVzID0gcGdUYWJsZSgnc3NsX2NlcnRpZmljYXRlcycsIHtcbiAgaWQ6IHV1aWQoJ2lkJylcbiAgICAucHJpbWFyeUtleSgpXG4gICAgLmRlZmF1bHQoc3FsYGdlbl9yYW5kb21fdXVpZCgpYCksXG4gIGRvbWFpbjogdGV4dCgnZG9tYWluJykubm90TnVsbCgpLnVuaXF1ZSgpLFxuICBjZXJ0aWZpY2F0ZURhdGE6IHRleHQoJ2NlcnRpZmljYXRlX2RhdGEnKS5ub3ROdWxsKCksXG4gIHByaXZhdGVLZXk6IHRleHQoJ3ByaXZhdGVfa2V5Jykubm90TnVsbCgpLFxuICBpc3N1ZXI6IHRleHQoJ2lzc3VlcicpLm5vdE51bGwoKSxcbiAgc3ViamVjdDogdGV4dCgnc3ViamVjdCcpLm5vdE51bGwoKSxcbiAgc2VyaWFsTnVtYmVyOiB0ZXh0KCdzZXJpYWxfbnVtYmVyJykubm90TnVsbCgpLFxuICBmaW5nZXJwcmludDogdGV4dCgnZmluZ2VycHJpbnQnKS5ub3ROdWxsKCksXG4gIHZhbGlkRnJvbTogdGltZXN0YW1wKCd2YWxpZF9mcm9tJykubm90TnVsbCgpLFxuICB2YWxpZFRvOiB0aW1lc3RhbXAoJ3ZhbGlkX3RvJykubm90TnVsbCgpLFxuICBzdGF0dXM6IHNzbFN0YXR1c0VudW0oJ3N0YXR1cycpLm5vdE51bGwoKS5kZWZhdWx0KCdwZW5kaW5nJyksXG4gIGF1dG9SZW5ldzogYm9vbGVhbignYXV0b19yZW5ldycpLm5vdE51bGwoKS5kZWZhdWx0KHRydWUpLFxuICByZW5ld2FsQXR0ZW1wdHM6IGludGVnZXIoJ3JlbmV3YWxfYXR0ZW1wdHMnKS5ub3ROdWxsKCkuZGVmYXVsdCgwKSxcbiAgbWF4UmVuZXdhbEF0dGVtcHRzOiBpbnRlZ2VyKCdtYXhfcmVuZXdhbF9hdHRlbXB0cycpLm5vdE51bGwoKS5kZWZhdWx0KDMpLFxuICBkbnNQcm92aWRlcjogdGV4dCgnZG5zX3Byb3ZpZGVyJyksXG4gIGxhc3RSZW5ld2FsQXR0ZW1wdDogdGltZXN0YW1wKCdsYXN0X3JlbmV3YWxfYXR0ZW1wdCcpLFxuICBuZXh0UmVuZXdhbERhdGU6IHRpbWVzdGFtcCgnbmV4dF9yZW5ld2FsX2RhdGUnKSxcbiAgLy8gQWRkaXRpb25hbCBTU0wgbWFuYWdlbWVudCBmaWVsZHNcbiAgY2VydGlmaWNhdGVDaGFpbjogdGV4dCgnY2VydGlmaWNhdGVfY2hhaW4nKSxcbiAgcmVuZXdhbEVycm9yOiB0ZXh0KCdyZW5ld2FsX2Vycm9yJyksXG4gIGRuc0NyZWRlbnRpYWxzOiB0ZXh0KCdkbnNfY3JlZGVudGlhbHMnKSxcbiAgbm90aWZpY2F0aW9uRW1haWxzOiB0ZXh0KCdub3RpZmljYXRpb25fZW1haWxzJyksXG4gIGNyZWF0ZWRCeTogdXVpZCgnY3JlYXRlZF9ieScpXG4gICAgLm5vdE51bGwoKVxuICAgIC5yZWZlcmVuY2VzKCgpID0+IHVzZXJzLmlkKSxcbiAgY3JlYXRlZEF0OiB0aW1lc3RhbXAoJ2NyZWF0ZWRfYXQnKS5kZWZhdWx0Tm93KCksXG4gIHVwZGF0ZWRBdDogdGltZXN0YW1wKCd1cGRhdGVkX2F0JykuZGVmYXVsdE5vdygpLFxufSk7XG5cbi8vIEluc2VydCBzY2hlbWFzXG5leHBvcnQgY29uc3QgaW5zZXJ0U3NsQ2VydGlmaWNhdGVTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGRvbWFpbjogei5zdHJpbmcoKSxcbiAgY2VydGlmaWNhdGVEYXRhOiB6LnN0cmluZygpLFxuICBwcml2YXRlS2V5OiB6LnN0cmluZygpLFxuICBpc3N1ZXI6IHouc3RyaW5nKCksXG4gIHN1YmplY3Q6IHouc3RyaW5nKCksXG4gIHNlcmlhbE51bWJlcjogei5zdHJpbmcoKSxcbiAgZmluZ2VycHJpbnQ6IHouc3RyaW5nKCksXG4gIHZhbGlkRnJvbTogei5kYXRlKCksXG4gIHZhbGlkVG86IHouZGF0ZSgpLFxuICBzdGF0dXM6IHouc3RyaW5nKCkuZGVmYXVsdCgncGVuZGluZycpLFxuICBhdXRvUmVuZXc6IHouYm9vbGVhbigpLmRlZmF1bHQodHJ1ZSksXG4gIHJlbmV3YWxBdHRlbXB0czogei5udW1iZXIoKS5pbnQoKS5kZWZhdWx0KDApLFxuICBtYXhSZW5ld2FsQXR0ZW1wdHM6IHoubnVtYmVyKCkuaW50KCkuZGVmYXVsdCgzKSxcbiAgZG5zUHJvdmlkZXI6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgbGFzdFJlbmV3YWxBdHRlbXB0OiB6LmRhdGUoKS5vcHRpb25hbCgpLFxuICBuZXh0UmVuZXdhbERhdGU6IHouZGF0ZSgpLm9wdGlvbmFsKCksXG4gIGNyZWF0ZWRCeTogei5zdHJpbmcoKS51dWlkKCksXG59KTtcblxuLy8gVHlwZXNcbi8qKlxuICpcbiAqL1xuZXhwb3J0IHR5cGUgSW5zZXJ0U3NsQ2VydGlmaWNhdGUgPSB6LmluZmVyPHR5cGVvZiBpbnNlcnRTc2xDZXJ0aWZpY2F0ZVNjaGVtYT47XG4vKipcbiAqXG4gKi9cbmV4cG9ydCB0eXBlIFNzbENlcnRpZmljYXRlID0gdHlwZW9mIHNzbENlcnRpZmljYXRlcy4kaW5mZXJTZWxlY3Q7XG5cbi8vIFJlbGF0aW9ucyAtIHRlbXBvcmFyaWx5IGNvbW1lbnRlZCBvdXQgZHVlIHRvIGRyaXp6bGUtb3JtIHZlcnNpb24gY29tcGF0aWJpbGl0eVxuLy8gZXhwb3J0IGNvbnN0IHNzbENlcnRpZmljYXRlc1JlbGF0aW9ucyA9IHJlbGF0aW9ucyhzc2xDZXJ0aWZpY2F0ZXMsICh7IG9uZSB9KSA9PiAoe1xuLy8gICBjcmVhdGVkQnk6IG9uZSh1c2Vycywge1xuLy8gICAgIGZpZWxkczogW3NzbENlcnRpZmljYXRlcy5jcmVhdGVkQnldLFxuLy8gICAgIHJlZmVyZW5jZXM6IFt1c2Vycy5pZF0sXG4vLyAgIH0pLFxuLy8gfSkpO1xuIl0sInZlcnNpb24iOjN9