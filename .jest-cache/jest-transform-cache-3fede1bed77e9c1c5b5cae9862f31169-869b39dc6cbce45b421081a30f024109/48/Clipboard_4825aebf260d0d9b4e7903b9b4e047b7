c1672e71ca529ff1049d81d752bd6372
'use strict';
var getWindow = require('../misc/getWindow.js');
var Blob = require('./Blob.js');
var DataTransfer = require('./DataTransfer.js');
// Clipboard is not available in jsdom
function _define_property(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    }
    else {
        obj[key] = value;
    }
    return obj;
}
// MDN lists string|Blob|Promise<Blob|string> as possible types in ClipboardItemData
// lib.dom.d.ts lists only Promise<Blob|string>
// https://developer.mozilla.org/en-US/docs/Web/API/ClipboardItem/ClipboardItem#syntax
function createClipboardItem(window, ...blobs) {
    const dataMap = Object.fromEntries(blobs.map((b) => [
        typeof b === 'string' ? 'text/plain' : b.type,
        Promise.resolve(b)
    ]));
    // use real ClipboardItem if available
    /* istanbul ignore if */ if (typeof window.ClipboardItem !== 'undefined') {
        return new window.ClipboardItem(dataMap);
    }
    return new class ClipboardItem {
        get types() {
            return Array.from(Object.keys(this.data));
        }
        async getType(type) {
            const value = await this.data[type];
            if (!value) {
                throw new Error(`${type} is not one of the available MIME types on this item.`);
            }
            return value instanceof window.Blob ? value : new window.Blob([
                value
            ], {
                type
            });
        }
        constructor(d) {
            _define_property(this, "data", undefined);
            this.data = d;
        }
    }(dataMap);
}
const ClipboardStubControl = Symbol('Manage ClipboardSub');
function createClipboardStub(window, control) {
    return Object.assign(new class Clipboard extends window.EventTarget {
        async read() {
            return Array.from(this.items);
        }
        async readText() {
            let text = '';
            for (const item of this.items) {
                const type = item.types.includes('text/plain') ? 'text/plain' : item.types.find((t) => t.startsWith('text/'));
                if (type) {
                    text += await item.getType(type).then((b) => Blob.readBlobText(b, window.FileReader));
                }
            }
            return text;
        }
        async write(data) {
            this.items = data;
        }
        async writeText(text) {
            this.items = [
                createClipboardItem(window, text)
            ];
        }
        constructor(...args) {
            super(...args), _define_property(this, "items", []);
        }
    }(), {
        [ClipboardStubControl]: control
    });
}
function isClipboardStub(clipboard) {
    return !!(clipboard === null || clipboard === undefined ? undefined : clipboard[ClipboardStubControl]);
}
function attachClipboardStubToView(window) {
    if (isClipboardStub(window.navigator.clipboard)) {
        return window.navigator.clipboard[ClipboardStubControl];
    }
    const realClipboard = Object.getOwnPropertyDescriptor(window.navigator, 'clipboard');
    let stub;
    const control = {
        resetClipboardStub: () => {
            stub = createClipboardStub(window, control);
        },
        detachClipboardStub: () => {
            /* istanbul ignore if */ if (realClipboard) {
                Object.defineProperty(window.navigator, 'clipboard', realClipboard);
            }
            else {
                Object.defineProperty(window.navigator, 'clipboard', {
                    value: undefined,
                    configurable: true
                });
            }
        }
    };
    stub = createClipboardStub(window, control);
    Object.defineProperty(window.navigator, 'clipboard', {
        get: () => stub,
        configurable: true
    });
    return stub[ClipboardStubControl];
}
function resetClipboardStubOnView(window) {
    if (isClipboardStub(window.navigator.clipboard)) {
        window.navigator.clipboard[ClipboardStubControl].resetClipboardStub();
    }
}
function detachClipboardStubFromView(window) {
    if (isClipboardStub(window.navigator.clipboard)) {
        window.navigator.clipboard[ClipboardStubControl].detachClipboardStub();
    }
}
async function readDataTransferFromClipboard(document) {
    const window = document.defaultView;
    const clipboard = window === null || window === undefined ? undefined : window.navigator.clipboard;
    const items = clipboard && await clipboard.read();
    if (!items) {
        throw new Error('The Clipboard API is unavailable.');
    }
    const dt = DataTransfer.createDataTransfer(window);
    for (const item of items) {
        for (const type of item.types) {
            dt.setData(type, await item.getType(type).then((b) => Blob.readBlobText(b, window.FileReader)));
        }
    }
    return dt;
}
async function writeDataTransferToClipboard(document, clipboardData) {
    const window = getWindow.getWindow(document);
    const clipboard = window.navigator.clipboard;
    const items = [];
    for (let i = 0; i < clipboardData.items.length; i++) {
        const dtItem = clipboardData.items[i];
        const blob = await DataTransfer.getBlobFromDataTransferItem(window, dtItem);
        items.push(createClipboardItem(window, blob));
    }
    const written = clipboard && await clipboard.write(items).then(() => true, // Can happen with other implementations that e.g. require permissions
    /* istanbul ignore next */ () => false);
    if (!written) {
        throw new Error('The Clipboard API is unavailable.');
    }
}
const g = globalThis;
/* istanbul ignore else */ if (typeof g.afterEach === 'function') {
    g.afterEach(() => resetClipboardStubOnView(globalThis.window));
}
/* istanbul ignore else */ if (typeof g.afterAll === 'function') {
    g.afterAll(() => detachClipboardStubFromView(globalThis.window));
}
exports.attachClipboardStubToView = attachClipboardStubToView;
exports.createClipboardItem = createClipboardItem;
exports.detachClipboardStubFromView = detachClipboardStubFromView;
exports.readDataTransferFromClipboard = readDataTransferFromClipboard;
exports.resetClipboardStubOnView = resetClipboardStubOnView;
exports.writeDataTransferToClipboard = writeDataTransferToClipboard;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3V0aWxzL2RhdGFUcmFuc2Zlci9DbGlwYm9hcmQuanMiLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDaEQsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ2hDLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRWhELHNDQUFzQztBQUN0QyxTQUFTLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSztJQUNyQyxJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNiLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUM1QixLQUFLLEVBQUUsS0FBSztZQUNaLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLFFBQVEsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztJQUNQLENBQUM7U0FBTSxDQUFDO1FBQ0osR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDO0FBQ0Qsb0ZBQW9GO0FBQ3BGLCtDQUErQztBQUMvQyxzRkFBc0Y7QUFDdEYsU0FBUyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsR0FBRyxLQUFLO0lBQ3pDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLENBQUE7UUFDMUMsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO1FBQzdDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxD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WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL25vZGVfbW9kdWxlcy9AdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQvZGlzdC9janMvdXRpbHMvZGF0YVRyYW5zZmVyL0NsaXBib2FyZC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBnZXRXaW5kb3cgPSByZXF1aXJlKCcuLi9taXNjL2dldFdpbmRvdy5qcycpO1xudmFyIEJsb2IgPSByZXF1aXJlKCcuL0Jsb2IuanMnKTtcbnZhciBEYXRhVHJhbnNmZXIgPSByZXF1aXJlKCcuL0RhdGFUcmFuc2Zlci5qcycpO1xuXG4vLyBDbGlwYm9hcmQgaXMgbm90IGF2YWlsYWJsZSBpbiBqc2RvbVxuZnVuY3Rpb24gX2RlZmluZV9wcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5IGluIG9iaikge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHtcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBvYmpba2V5XSA9IHZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuLy8gTUROIGxpc3RzIHN0cmluZ3xCbG9ifFByb21pc2U8QmxvYnxzdHJpbmc+IGFzIHBvc3NpYmxlIHR5cGVzIGluIENsaXBib2FyZEl0ZW1EYXRhXG4vLyBsaWIuZG9tLmQudHMgbGlzdHMgb25seSBQcm9taXNlPEJsb2J8c3RyaW5nPlxuLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0NsaXBib2FyZEl0ZW0vQ2xpcGJvYXJkSXRlbSNzeW50YXhcbmZ1bmN0aW9uIGNyZWF0ZUNsaXBib2FyZEl0ZW0od2luZG93LCAuLi5ibG9icykge1xuICAgIGNvbnN0IGRhdGFNYXAgPSBPYmplY3QuZnJvbUVudHJpZXMoYmxvYnMubWFwKChiKT0+W1xuICAgICAgICAgICAgdHlwZW9mIGIgPT09ICdzdHJpbmcnID8gJ3RleHQvcGxhaW4nIDogYi50eXBlLFxuICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKGIpXG4gICAgICAgIF0pKTtcbiAgICAvLyB1c2UgcmVhbCBDbGlwYm9hcmRJdGVtIGlmIGF2YWlsYWJsZVxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLyBpZiAodHlwZW9mIHdpbmRvdy5DbGlwYm9hcmRJdGVtICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICByZXR1cm4gbmV3IHdpbmRvdy5DbGlwYm9hcmRJdGVtKGRhdGFNYXApO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IGNsYXNzIENsaXBib2FyZEl0ZW0ge1xuICAgICAgICBnZXQgdHlwZXMoKSB7XG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShPYmplY3Qua2V5cyh0aGlzLmRhdGEpKTtcbiAgICAgICAgfVxuICAgICAgICBhc3luYyBnZXRUeXBlKHR5cGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5kYXRhW3R5cGVdO1xuICAgICAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0eXBlfSBpcyBub3Qgb25lIG9mIHRoZSBhdmFpbGFibGUgTUlNRSB0eXBlcyBvbiB0aGlzIGl0ZW0uYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiB3aW5kb3cuQmxvYiA/IHZhbHVlIDogbmV3IHdpbmRvdy5CbG9iKFtcbiAgICAgICAgICAgICAgICB2YWx1ZVxuICAgICAgICAgICAgXSwge1xuICAgICAgICAgICAgICAgIHR5cGVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0cnVjdG9yKGQpe1xuICAgICAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImRhdGFcIiwgdW5kZWZpbmVkKTtcbiAgICAgICAgICAgIHRoaXMuZGF0YSA9IGQ7XG4gICAgICAgIH1cbiAgICB9KGRhdGFNYXApO1xufVxuY29uc3QgQ2xpcGJvYXJkU3R1YkNvbnRyb2wgPSBTeW1ib2woJ01hbmFnZSBDbGlwYm9hcmRTdWInKTtcbmZ1bmN0aW9uIGNyZWF0ZUNsaXBib2FyZFN0dWIod2luZG93LCBjb250cm9sKSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IGNsYXNzIENsaXBib2FyZCBleHRlbmRzIHdpbmRvdy5FdmVudFRhcmdldCB7XG4gICAgICAgIGFzeW5jIHJlYWQoKSB7XG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLml0ZW1zKTtcbiAgICAgICAgfVxuICAgICAgICBhc3luYyByZWFkVGV4dCgpIHtcbiAgICAgICAgICAgIGxldCB0ZXh0ID0gJyc7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdGhpcy5pdGVtcyl7XG4gICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IGl0ZW0udHlwZXMuaW5jbHVkZXMoJ3RleHQvcGxhaW4nKSA/ICd0ZXh0L3BsYWluJyA6IGl0ZW0udHlwZXMuZmluZCgodCk9PnQuc3RhcnRzV2l0aCgndGV4dC8nKSk7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBhd2FpdCBpdGVtLmdldFR5cGUodHlwZSkudGhlbigoYik9PkJsb2IucmVhZEJsb2JUZXh0KGIsIHdpbmRvdy5GaWxlUmVhZGVyKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRleHQ7XG4gICAgICAgIH1cbiAgICAgICAgYXN5bmMgd3JpdGUoZGF0YSkge1xuICAgICAgICAgICAgdGhpcy5pdGVtcyA9IGRhdGE7XG4gICAgICAgIH1cbiAgICAgICAgYXN5bmMgd3JpdGVUZXh0KHRleHQpIHtcbiAgICAgICAgICAgIHRoaXMuaXRlbXMgPSBbXG4gICAgICAgICAgICAgICAgY3JlYXRlQ2xpcGJvYXJkSXRlbSh3aW5kb3csIHRleHQpXG4gICAgICAgICAgICBdO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3Mpe1xuICAgICAgICAgICAgc3VwZXIoLi4uYXJncyksIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJpdGVtc1wiLCBbXSk7XG4gICAgICAgIH1cbiAgICB9KCksIHtcbiAgICAgICAgW0NsaXBib2FyZFN0dWJDb250cm9sXTogY29udHJvbFxuICAgIH0pO1xufVxuZnVuY3Rpb24gaXNDbGlwYm9hcmRTdHViKGNsaXBib2FyZCkge1xuICAgIHJldHVybiAhIShjbGlwYm9hcmQgPT09IG51bGwgfHwgY2xpcGJvYXJkID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBjbGlwYm9hcmRbQ2xpcGJvYXJkU3R1YkNvbnRyb2xdKTtcbn1cbmZ1bmN0aW9uIGF0dGFjaENsaXBib2FyZFN0dWJUb1ZpZXcod2luZG93KSB7XG4gICAgaWYgKGlzQ2xpcGJvYXJkU3R1Yih3aW5kb3cubmF2aWdhdG9yLmNsaXBib2FyZCkpIHtcbiAgICAgICAgcmV0dXJuIHdpbmRvdy5uYXZpZ2F0b3IuY2xpcGJvYXJkW0NsaXBib2FyZFN0dWJDb250cm9sXTtcbiAgICB9XG4gICAgY29uc3QgcmVhbENsaXBib2FyZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93Lm5hdmlnYXRvciwgJ2NsaXBib2FyZCcpO1xuICAgIGxldCBzdHViO1xuICAgIGNvbnN0IGNvbnRyb2wgPSB7XG4gICAgICAgIHJlc2V0Q2xpcGJvYXJkU3R1YjogKCk9PntcbiAgICAgICAgICAgIHN0dWIgPSBjcmVhdGVDbGlwYm9hcmRTdHViKHdpbmRvdywgY29udHJvbCk7XG4gICAgICAgIH0sXG4gICAgICAgIGRldGFjaENsaXBib2FyZFN0dWI6ICgpPT57XG4gICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8gaWYgKHJlYWxDbGlwYm9hcmQpIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93Lm5hdmlnYXRvciwgJ2NsaXBib2FyZCcsIHJlYWxDbGlwYm9hcmQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93Lm5hdmlnYXRvciwgJ2NsaXBib2FyZCcsIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHN0dWIgPSBjcmVhdGVDbGlwYm9hcmRTdHViKHdpbmRvdywgY29udHJvbCk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdy5uYXZpZ2F0b3IsICdjbGlwYm9hcmQnLCB7XG4gICAgICAgIGdldDogKCk9PnN0dWIsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgIH0pO1xuICAgIHJldHVybiBzdHViW0NsaXBib2FyZFN0dWJDb250cm9sXTtcbn1cbmZ1bmN0aW9uIHJlc2V0Q2xpcGJvYXJkU3R1Yk9uVmlldyh3aW5kb3cpIHtcbiAgICBpZiAoaXNDbGlwYm9hcmRTdHViKHdpbmRvdy5uYXZpZ2F0b3IuY2xpcGJvYXJkKSkge1xuICAgICAgICB3aW5kb3cubmF2aWdhdG9yLmNsaXBib2FyZFtDbGlwYm9hcmRTdHViQ29udHJvbF0ucmVzZXRDbGlwYm9hcmRTdHViKCk7XG4gICAgfVxufVxuZnVuY3Rpb24gZGV0YWNoQ2xpcGJvYXJkU3R1YkZyb21WaWV3KHdpbmRvdykge1xuICAgIGlmIChpc0NsaXBib2FyZFN0dWIod2luZG93Lm5hdmlnYXRvci5jbGlwYm9hcmQpKSB7XG4gICAgICAgIHdpbmRvdy5uYXZpZ2F0b3IuY2xpcGJvYXJkW0NsaXBib2FyZFN0dWJDb250cm9sXS5kZXRhY2hDbGlwYm9hcmRTdHViKCk7XG4gICAgfVxufVxuYXN5bmMgZnVuY3Rpb24gcmVhZERhdGFUcmFuc2ZlckZyb21DbGlwYm9hcmQoZG9jdW1lbnQpIHtcbiAgICBjb25zdCB3aW5kb3cgPSBkb2N1bWVudC5kZWZhdWx0VmlldztcbiAgICBjb25zdCBjbGlwYm9hcmQgPSB3aW5kb3cgPT09IG51bGwgfHwgd2luZG93ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB3aW5kb3cubmF2aWdhdG9yLmNsaXBib2FyZDtcbiAgICBjb25zdCBpdGVtcyA9IGNsaXBib2FyZCAmJiBhd2FpdCBjbGlwYm9hcmQucmVhZCgpO1xuICAgIGlmICghaXRlbXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgQ2xpcGJvYXJkIEFQSSBpcyB1bmF2YWlsYWJsZS4nKTtcbiAgICB9XG4gICAgY29uc3QgZHQgPSBEYXRhVHJhbnNmZXIuY3JlYXRlRGF0YVRyYW5zZmVyKHdpbmRvdyk7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXtcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIGl0ZW0udHlwZXMpe1xuICAgICAgICAgICAgZHQuc2V0RGF0YSh0eXBlLCBhd2FpdCBpdGVtLmdldFR5cGUodHlwZSkudGhlbigoYik9PkJsb2IucmVhZEJsb2JUZXh0KGIsIHdpbmRvdy5GaWxlUmVhZGVyKSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkdDtcbn1cbmFzeW5jIGZ1bmN0aW9uIHdyaXRlRGF0YVRyYW5zZmVyVG9DbGlwYm9hcmQoZG9jdW1lbnQsIGNsaXBib2FyZERhdGEpIHtcbiAgICBjb25zdCB3aW5kb3cgPSBnZXRXaW5kb3cuZ2V0V2luZG93KGRvY3VtZW50KTtcbiAgICBjb25zdCBjbGlwYm9hcmQgPSB3aW5kb3cubmF2aWdhdG9yLmNsaXBib2FyZDtcbiAgICBjb25zdCBpdGVtcyA9IFtdO1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCBjbGlwYm9hcmREYXRhLml0ZW1zLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgY29uc3QgZHRJdGVtID0gY2xpcGJvYXJkRGF0YS5pdGVtc1tpXTtcbiAgICAgICAgY29uc3QgYmxvYiA9IGF3YWl0IERhdGFUcmFuc2Zlci5nZXRCbG9iRnJvbURhdGFUcmFuc2Zlckl0ZW0od2luZG93LCBkdEl0ZW0pO1xuICAgICAgICBpdGVtcy5wdXNoKGNyZWF0ZUNsaXBib2FyZEl0ZW0od2luZG93LCBibG9iKSk7XG4gICAgfVxuICAgIGNvbnN0IHdyaXR0ZW4gPSBjbGlwYm9hcmQgJiYgYXdhaXQgY2xpcGJvYXJkLndyaXRlKGl0ZW1zKS50aGVuKCgpPT50cnVlLCAvLyBDYW4gaGFwcGVuIHdpdGggb3RoZXIgaW1wbGVtZW50YXRpb25zIHRoYXQgZS5nLiByZXF1aXJlIHBlcm1pc3Npb25zXG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gKCk9PmZhbHNlKTtcbiAgICBpZiAoIXdyaXR0ZW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgQ2xpcGJvYXJkIEFQSSBpcyB1bmF2YWlsYWJsZS4nKTtcbiAgICB9XG59XG5jb25zdCBnID0gZ2xvYmFsVGhpcztcbi8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovIGlmICh0eXBlb2YgZy5hZnRlckVhY2ggPT09ICdmdW5jdGlvbicpIHtcbiAgICBnLmFmdGVyRWFjaCgoKT0+cmVzZXRDbGlwYm9hcmRTdHViT25WaWV3KGdsb2JhbFRoaXMud2luZG93KSk7XG59XG4vKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLyBpZiAodHlwZW9mIGcuYWZ0ZXJBbGwgPT09ICdmdW5jdGlvbicpIHtcbiAgICBnLmFmdGVyQWxsKCgpPT5kZXRhY2hDbGlwYm9hcmRTdHViRnJvbVZpZXcoZ2xvYmFsVGhpcy53aW5kb3cpKTtcbn1cblxuZXhwb3J0cy5hdHRhY2hDbGlwYm9hcmRTdHViVG9WaWV3ID0gYXR0YWNoQ2xpcGJvYXJkU3R1YlRvVmlldztcbmV4cG9ydHMuY3JlYXRlQ2xpcGJvYXJkSXRlbSA9IGNyZWF0ZUNsaXBib2FyZEl0ZW07XG5leHBvcnRzLmRldGFjaENsaXBib2FyZFN0dWJGcm9tVmlldyA9IGRldGFjaENsaXBib2FyZFN0dWJGcm9tVmlldztcbmV4cG9ydHMucmVhZERhdGFUcmFuc2ZlckZyb21DbGlwYm9hcmQgPSByZWFkRGF0YVRyYW5zZmVyRnJvbUNsaXBib2FyZDtcbmV4cG9ydHMucmVzZXRDbGlwYm9hcmRTdHViT25WaWV3ID0gcmVzZXRDbGlwYm9hcmRTdHViT25WaWV3O1xuZXhwb3J0cy53cml0ZURhdGFUcmFuc2ZlclRvQ2xpcGJvYXJkID0gd3JpdGVEYXRhVHJhbnNmZXJUb0NsaXBib2FyZDtcbiJdLCJ2ZXJzaW9uIjozfQ==