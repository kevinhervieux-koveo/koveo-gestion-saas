0200cdcb0c6adc05a7f71d730e1604c0
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
// Mock WebSocket constructor for Jest environment
jest.mock('ws', () => ({
    __esModule: true,
    default: class MockWebSocket {
    }
}));
const express_1 = __importDefault(require("express"));
const supertest_1 = __importDefault(require("supertest"));
const routes_1 = require("../../../server/routes");
/**
 * Security Headers Validation Test Suite
 *
 * Validates that proper security headers are set:
 * - Content Security Policy (CSP)
 * - X-Content-Type-Options
 * - X-Frame-Options
 * - X-XSS-Protection
 * - Strict-Transport-Security
 * - Referrer-Policy
 */
const createTestApp = () => {
    const app = (0, express_1.default)();
    // Add Helmet security middleware for testing
    const helmet = require('helmet');
    app.use(helmet({
        contentSecurityPolicy: {
            directives: {
                defaultSrc: ["'self'"],
                scriptSrc: ["'self'", "'unsafe-inline'"],
                styleSrc: ["'self'", "'unsafe-inline'"],
                imgSrc: ["'self'", "data:", "https:"],
                connectSrc: ["'self'"],
                fontSrc: ["'self'"],
                objectSrc: ["'none'"],
                mediaSrc: ["'self'"],
                frameSrc: ["'none'"],
            },
        },
        crossOriginEmbedderPolicy: false,
    }));
    app.use(express_1.default.json());
    app.use(express_1.default.urlencoded({ extended: true }));
    (0, routes_1.registerRoutes)(app);
    return app;
};
(0, globals_1.describe)('Security Headers Validation', () => {
    let app;
    (0, globals_1.beforeEach)(async () => {
        app = createTestApp();
    });
    (0, globals_1.describe)('Essential Security Headers', () => {
        (0, globals_1.it)('should set X-Content-Type-Options header', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            (0, globals_1.expect)(response.headers['x-content-type-options']).toBe('nosniff');
        });
        (0, globals_1.it)('should set X-Frame-Options header', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            (0, globals_1.expect)(response.headers['x-frame-options']).toMatch(/^(DENY|SAMEORIGIN)$/);
        });
        (0, globals_1.it)('should set X-XSS-Protection header', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            (0, globals_1.expect)(response.headers['x-xss-protection']).toBe('1; mode=block');
        });
        (0, globals_1.it)('should set Referrer-Policy header', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            (0, globals_1.expect)(response.headers['referrer-policy']).toBeDefined();
            (0, globals_1.expect)(response.headers['referrer-policy']).toMatch(/^(strict-origin-when-cross-origin|same-origin|no-referrer)$/);
        });
    });
    (0, globals_1.describe)('Content Security Policy', () => {
        (0, globals_1.it)('should set Content-Security-Policy header', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            const csp = response.headers['content-security-policy'];
            (0, globals_1.expect)(csp).toBeDefined();
            // Should contain basic CSP directives
            if (csp) {
                (0, globals_1.expect)(csp).toContain('default-src');
            }
        });
        (0, globals_1.it)('should prevent inline script execution via CSP', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            const csp = response.headers['content-security-policy'];
            if (csp) {
                // Should not allow unsafe-inline for scripts
                (0, globals_1.expect)(csp).not.toContain("script-src 'unsafe-inline'");
            }
        });
    });
    (0, globals_1.describe)('HTTPS Security Headers', () => {
        (0, globals_1.it)('should set Strict-Transport-Security when using HTTPS', async () => {
            // Test with HTTPS simulation
            const response = await (0, supertest_1.default)(app)
                .get('/api/health')
                .set('X-Forwarded-Proto', 'https');
            // In production, should have HSTS header
            if (process.env.NODE_ENV === 'production') {
                (0, globals_1.expect)(response.headers['strict-transport-security']).toBeDefined();
            }
        });
    });
    (0, globals_1.describe)('API-Specific Security Headers', () => {
        (0, globals_1.it)('should set proper CORS headers for API endpoints', async () => {
            const response = await (0, supertest_1.default)(app)
                .options('/api/users');
            // Should handle CORS preflight properly
            (0, globals_1.expect)(response.headers['access-control-allow-methods']).toBeDefined();
        });
        (0, globals_1.it)('should set Cache-Control headers for sensitive endpoints', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/auth/profile');
            // Sensitive endpoints should have no-cache directive
            const cacheControl = response.headers['cache-control'];
            if (cacheControl) {
                (0, globals_1.expect)(cacheControl).toMatch(/(no-cache|no-store|private)/);
            }
        });
        (0, globals_1.it)('should not expose server information', async () => {
            const response = await (0, supertest_1.default)(app)
                .get('/api/health');
            // Should not expose Express version or server details
            (0, globals_1.expect)(response.headers['x-powered-by']).toBeUndefined();
            (0, globals_1.expect)(response.headers['server']).not.toContain('Express');
        });
    });
    (0, globals_1.describe)('Error Response Security', () => {
        (0, globals_1.it)('should not leak sensitive information in error messages', async () => {
            // Try to trigger various error conditions
            const responses = await Promise.all([
                (0, supertest_1.default)(app).get('/api/nonexistent').expect(404),
                (0, supertest_1.default)(app).post('/api/users').send({ invalid: 'data' }).expect(400),
                (0, supertest_1.default)(app).get('/api/buildings/999999').expect(404),
            ]);
            responses.forEach(response => {
                const body = response.body;
                const errorText = JSON.stringify(body).toLowerCase();
                // Should not contain internal paths, stack traces, or database info
                (0, globals_1.expect)(errorText).not.toContain('/home/runner');
                (0, globals_1.expect)(errorText).not.toContain('node_modules');
                (0, globals_1.expect)(errorText).not.toContain('postgresql');
                (0, globals_1.expect)(errorText).not.toContain('stack trace');
                (0, globals_1.expect)(errorText).not.toContain('at object.');
            });
        });
        (0, globals_1.it)('should set appropriate status codes for security violations', async () => {
            // Test unauthorized access
            const unauthorizedResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/profile');
            (0, globals_1.expect)(unauthorizedResponse.status).toBe(401);
            // Test forbidden access (would need proper auth setup for realistic test)
            const forbiddenResponse = await (0, supertest_1.default)(app)
                .delete('/api/users/1');
            (0, globals_1.expect)([401, 403]).toContain(forbiddenResponse.status);
        });
    });
    (0, globals_1.describe)('Input Validation Security', () => {
        (0, globals_1.it)('should handle malicious input safely', async () => {
            const maliciousInputs = [
                '<script>alert("xss")</script>',
                "'; DROP TABLE users; --",
                '../../../etc/passwd',
                '{{constructor.constructor("return process")().env}}',
                '\x00\x01\x02', // Binary data
            ];
            for (const maliciousInput of maliciousInputs) {
                const response = await (0, supertest_1.default)(app)
                    .post('/api/organizations')
                    .send({
                    name: maliciousInput,
                    type: 'syndicate',
                    address: '123 Test St',
                    city: 'Montreal',
                    province: 'QC',
                    postalCode: 'H1A 1A1',
                });
                // Should either reject the input or sanitize it properly
                (0, globals_1.expect)([400, 401, 403]).toContain(response.status);
                if (response.body.error) {
                    // Error message should not echo back the malicious input
                    (0, globals_1.expect)(response.body.error).not.toContain('<script>');
                    (0, globals_1.expect)(response.body.error).not.toContain('DROP TABLE');
                }
            }
        });
        (0, globals_1.it)('should enforce request size limits', async () => {
            // Create oversized payload
            const largePayload = 'a'.repeat(10 * 1024 * 1024); // 10MB
            const response = await (0, supertest_1.default)(app)
                .post('/api/organizations')
                .send({
                name: largePayload,
                type: 'syndicate',
                address: '123 Test St',
                city: 'Montreal',
                province: 'QC',
                postalCode: 'H1A 1A1',
            });
            // Should reject oversized requests
            (0, globals_1.expect)(response.status).toBe(413);
        });
    });
    (0, globals_1.describe)('Authentication Security', () => {
        (0, globals_1.it)('should handle authentication bypass attempts', async () => {
            const bypassAttempts = [
                { 'x-user-id': '1' },
                { 'x-role': 'admin' },
                { 'authorization': 'Bearer fake-token' },
                { 'x-forwarded-user': 'admin' },
            ];
            for (const headers of bypassAttempts) {
                const response = await (0, supertest_1.default)(app)
                    .get('/api/auth/profile')
                    .set(headers);
                // Should not bypass authentication
                (0, globals_1.expect)(response.status).toBe(401);
            }
        });
        (0, globals_1.it)('should handle session manipulation attempts', async () => {
            const manipulationAttempts = [
                'admin-session-id',
                '../admin-session',
                'null',
                'undefined',
                JSON.stringify({ userId: 1, role: 'admin' }),
            ];
            for (const sessionId of manipulationAttempts) {
                const response = await (0, supertest_1.default)(app)
                    .get('/api/auth/profile')
                    .set('Cookie', `koveo.sid=${sessionId}`);
                // Should not accept manipulated sessions
                (0, globals_1.expect)(response.status).toBe(401);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy91bml0L3NlY3VyaXR5L3NlY3VyaXR5LWhlYWRlcnMudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLDJDQUFpRTtBQUlqRSxrREFBa0Q7QUFDbEQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyQixVQUFVLEVBQUUsSUFBSTtJQUNoQixPQUFPLEVBQUUsTUFBTSxhQUFhO0tBQUc7Q0FDaEMsQ0FBQyxDQUFDLENBQUM7QUFQSixzREFBOEI7QUFDOUIsMERBQWdDO0FBUWhDLG1EQUF3RDtBQUV4RDs7Ozs7Ozs7OztHQVVHO0FBRUgsTUFBTSxhQUFhLEdBQUcsR0FBRyxFQUFFO0lBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0lBRXRCLDZDQUE2QztJQUM3QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDYixxQkFBcUIsRUFBRTtZQUNyQixVQUFVLEVBQUU7Z0JBQ1YsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQUN0QixTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsaUJBQWlCLENBQUM7Z0JBQ3hDLFFBQVEsRUFBRSxDQUFDLFFBQVEsRUFBRSxpQkFBaUIsQ0FBQztnQkFDdkMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUM7Z0JBQ3JDLFVBQVUsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFDdEIsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQUNuQixTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBQ3JCLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFDcEIsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDO2FBQ3JCO1NBQ0Y7UUFDRCx5QkFBeUIsRUFBRSxLQUFLO0tBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBRUosR0FB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SSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDO2FBQzdDLENBQUM7WUFFRixLQUFLLE1BQU0sU0FBUyxJQUFJLG9CQUFvQixFQUFFLENBQUM7Z0JBQzdDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxtQkFBTyxFQUFDLEdBQUcsQ0FBQztxQkFDaEMsR0FBRyxDQUFDLG1CQUFtQixDQUFDO3FCQUN4QixHQUFHLENBQUMsUUFBUSxFQUFFLGFBQWEsU0FBUyxFQUFFLENBQUMsQ0FBQztnQkFFM0MseUNBQXlDO2dCQUN6QyxJQUFBLGdCQUFNLEVBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2UvdGVzdHMvdW5pdC9zZWN1cml0eS9zZWN1cml0eS1oZWFkZXJzLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAnc3VwZXJ0ZXN0JztcblxuLy8gTW9jayBXZWJTb2NrZXQgY29uc3RydWN0b3IgZm9yIEplc3QgZW52aXJvbm1lbnRcbmplc3QubW9jaygnd3MnLCAoKSA9PiAoe1xuICBfX2VzTW9kdWxlOiB0cnVlLFxuICBkZWZhdWx0OiBjbGFzcyBNb2NrV2ViU29ja2V0IHt9XG59KSk7XG5cbmltcG9ydCB7IHJlZ2lzdGVyUm91dGVzIH0gZnJvbSAnLi4vLi4vLi4vc2VydmVyL3JvdXRlcyc7XG5cbi8qKlxuICogU2VjdXJpdHkgSGVhZGVycyBWYWxpZGF0aW9uIFRlc3QgU3VpdGVcbiAqIFxuICogVmFsaWRhdGVzIHRoYXQgcHJvcGVyIHNlY3VyaXR5IGhlYWRlcnMgYXJlIHNldDpcbiAqIC0gQ29udGVudCBTZWN1cml0eSBQb2xpY3kgKENTUClcbiAqIC0gWC1Db250ZW50LVR5cGUtT3B0aW9uc1xuICogLSBYLUZyYW1lLU9wdGlvbnNcbiAqIC0gWC1YU1MtUHJvdGVjdGlvblxuICogLSBTdHJpY3QtVHJhbnNwb3J0LVNlY3VyaXR5XG4gKiAtIFJlZmVycmVyLVBvbGljeVxuICovXG5cbmNvbnN0IGNyZWF0ZVRlc3RBcHAgPSAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbiAgXG4gIC8vIEFkZCBIZWxtZXQgc2VjdXJpdHkgbWlkZGxld2FyZSBmb3IgdGVzdGluZ1xuICBjb25zdCBoZWxtZXQgPSByZXF1aXJlKCdoZWxtZXQnKTtcbiAgYXBwLnVzZShoZWxtZXQoe1xuICAgIGNvbnRlbnRTZWN1cml0eVBvbGljeToge1xuICAgICAgZGlyZWN0aXZlczoge1xuICAgICAgICBkZWZhdWx0U3JjOiBbXCInc2VsZidcIl0sXG4gICAgICAgIHNjcmlwdFNyYzogW1wiJ3NlbGYnXCIsIFwiJ3Vuc2FmZS1pbmxpbmUnXCJdLFxuICAgICAgICBzdHlsZVNyYzogW1wiJ3NlbGYnXCIsIFwiJ3Vuc2FmZS1pbmxpbmUnXCJdLFxuICAgICAgICBpbWdTcmM6IFtcIidzZWxmJ1wiLCBcImRhdGE6XCIsIFwiaHR0cHM6XCJdLFxuICAgICAgICBjb25uZWN0U3JjOiBbXCInc2VsZidcIl0sXG4gICAgICAgIGZvbnRTcmM6IFtcIidzZWxmJ1wiXSxcbiAgICAgICAgb2JqZWN0U3JjOiBbXCInbm9uZSdcIl0sXG4gICAgICAgIG1lZGlhU3JjOiBbXCInc2VsZidcIl0sXG4gICAgICAgIGZyYW1lU3JjOiBbXCInbm9uZSdcIl0sXG4gICAgICB9LFxuICAgIH0sXG4gICAgY3Jvc3NPcmlnaW5FbWJlZGRlclBvbGljeTogZmFsc2UsXG4gIH0pKTtcbiAgXG4gIGFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xuICBhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKTtcbiAgcmVnaXN0ZXJSb3V0ZXMoYXBwKTtcbiAgcmV0dXJuIGFwcDtcbn07XG5cbmRlc2NyaWJlKCdTZWN1cml0eSBIZWFkZXJzIFZhbGlkYXRpb24nLCAoKSA9PiB7XG4gIGxldCBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXBwID0gY3JlYXRlVGVzdEFwcCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnRXNzZW50aWFsIFNlY3VyaXR5IEhlYWRlcnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZXQgWC1Db250ZW50LVR5cGUtT3B0aW9ucyBoZWFkZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2hlYWx0aCcpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1sneC1jb250ZW50LXR5cGUtb3B0aW9ucyddKS50b0JlKCdub3NuaWZmJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNldCBYLUZyYW1lLU9wdGlvbnMgaGVhZGVyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9oZWFsdGgnKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmhlYWRlcnNbJ3gtZnJhbWUtb3B0aW9ucyddKS50b01hdGNoKC9eKERFTll8U0FNRU9SSUdJTikkLyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNldCBYLVhTUy1Qcm90ZWN0aW9uIGhlYWRlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvaGVhbHRoJyk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5oZWFkZXJzWyd4LXhzcy1wcm90ZWN0aW9uJ10pLnRvQmUoJzE7IG1vZGU9YmxvY2snKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2V0IFJlZmVycmVyLVBvbGljeSBoZWFkZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2hlYWx0aCcpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1sncmVmZXJyZXItcG9saWN5J10pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1sncmVmZXJyZXItcG9saWN5J10pLnRvTWF0Y2goL14oc3RyaWN0LW9yaWdpbi13aGVuLWNyb3NzLW9yaWdpbnxzYW1lLW9yaWdpbnxuby1yZWZlcnJlcikkLyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDb250ZW50IFNlY3VyaXR5IFBvbGljeScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNldCBDb250ZW50LVNlY3VyaXR5LVBvbGljeSBoZWFkZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2hlYWx0aCcpO1xuXG4gICAgICBjb25zdCBjc3AgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXNlY3VyaXR5LXBvbGljeSddO1xuICAgICAgZXhwZWN0KGNzcCkudG9CZURlZmluZWQoKTtcbiAgICAgIFxuICAgICAgLy8gU2hvdWxkIGNvbnRhaW4gYmFzaWMgQ1NQIGRpcmVjdGl2ZXNcbiAgICAgIGlmIChjc3ApIHtcbiAgICAgICAgZXhwZWN0KGNzcCkudG9Db250YWluKCdkZWZhdWx0LXNyYycpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcmV2ZW50IGlubGluZSBzY3JpcHQgZXhlY3V0aW9uIHZpYSBDU1AnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2hlYWx0aCcpO1xuXG4gICAgICBjb25zdCBjc3AgPSByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXNlY3VyaXR5LXBvbGljeSddO1xuICAgICAgaWYgKGNzcCkge1xuICAgICAgICAvLyBTaG91bGQgbm90IGFsbG93IHVuc2FmZS1pbmxpbmUgZm9yIHNjcmlwdHNcbiAgICAgICAgZXhwZWN0KGNzcCkubm90LnRvQ29udGFpbihcInNjcmlwdC1zcmMgJ3Vuc2FmZS1pbmxpbmUnXCIpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSFRUUFMgU2VjdXJpdHkgSGVhZGVycycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNldCBTdHJpY3QtVHJhbnNwb3J0LVNlY3VyaXR5IHdoZW4gdXNpbmcgSFRUUFMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUZXN0IHdpdGggSFRUUFMgc2ltdWxhdGlvblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9oZWFsdGgnKVxuICAgICAgICAuc2V0KCdYLUZvcndhcmRlZC1Qcm90bycsICdodHRwcycpO1xuXG4gICAgICAvLyBJbiBwcm9kdWN0aW9uLCBzaG91bGQgaGF2ZSBIU1RTIGhlYWRlclxuICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmhlYWRlcnNbJ3N0cmljdC10cmFuc3BvcnQtc2VjdXJpdHknXSkudG9CZURlZmluZWQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSS1TcGVjaWZpYyBTZWN1cml0eSBIZWFkZXJzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2V0IHByb3BlciBDT1JTIGhlYWRlcnMgZm9yIEFQSSBlbmRwb2ludHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAub3B0aW9ucygnL2FwaS91c2VycycpO1xuXG4gICAgICAvLyBTaG91bGQgaGFuZGxlIENPUlMgcHJlZmxpZ2h0IHByb3Blcmx5XG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1snYWNjZXNzLWNvbnRyb2wtYWxsb3ctbWV0aG9kcyddKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZXQgQ2FjaGUtQ29udHJvbCBoZWFkZXJzIGZvciBzZW5zaXRpdmUgZW5kcG9pbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3Byb2ZpbGUnKTtcblxuICAgICAgLy8gU2Vuc2l0aXZlIGVuZHBvaW50cyBzaG91bGQgaGF2ZSBuby1jYWNoZSBkaXJlY3RpdmVcbiAgICAgIGNvbnN0IGNhY2hlQ29udHJvbCA9IHJlc3BvbnNlLmhlYWRlcnNbJ2NhY2hlLWNvbnRyb2wnXTtcbiAgICAgIGlmIChjYWNoZUNvbnRyb2wpIHtcbiAgICAgICAgZXhwZWN0KGNhY2hlQ29udHJvbCkudG9NYXRjaCgvKG5vLWNhY2hlfG5vLXN0b3JlfHByaXZhdGUpLyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBleHBvc2Ugc2VydmVyIGluZm9ybWF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9oZWFsdGgnKTtcblxuICAgICAgLy8gU2hvdWxkIG5vdCBleHBvc2UgRXhwcmVzcyB2ZXJzaW9uIG9yIHNlcnZlciBkZXRhaWxzXG4gICAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1sneC1wb3dlcmVkLWJ5J10pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5oZWFkZXJzWydzZXJ2ZXInXSkubm90LnRvQ29udGFpbignRXhwcmVzcycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRXJyb3IgUmVzcG9uc2UgU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBub3QgbGVhayBzZW5zaXRpdmUgaW5mb3JtYXRpb24gaW4gZXJyb3IgbWVzc2FnZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUcnkgdG8gdHJpZ2dlciB2YXJpb3VzIGVycm9yIGNvbmRpdGlvbnNcbiAgICAgIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgcmVxdWVzdChhcHApLmdldCgnL2FwaS9ub25leGlzdGVudCcpLmV4cGVjdCg0MDQpLFxuICAgICAgICByZXF1ZXN0KGFwcCkucG9zdCgnL2FwaS91c2VycycpLnNlbmQoeyBpbnZhbGlkOiAnZGF0YScgfSkuZXhwZWN0KDQwMCksXG4gICAgICAgIHJlcXVlc3QoYXBwKS5nZXQoJy9hcGkvYnVpbGRpbmdzLzk5OTk5OScpLmV4cGVjdCg0MDQpLFxuICAgICAgXSk7XG5cbiAgICAgIHJlc3BvbnNlcy5mb3JFYWNoKHJlc3BvbnNlID0+IHtcbiAgICAgICAgY29uc3QgYm9keSA9IHJlc3BvbnNlLmJvZHk7XG4gICAgICAgIGNvbnN0IGVycm9yVGV4dCA9IEpTT04uc3RyaW5naWZ5KGJvZHkpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIFxuICAgICAgICAvLyBTaG91bGQgbm90IGNvbnRhaW4gaW50ZXJuYWwgcGF0aHMsIHN0YWNrIHRyYWNlcywgb3IgZGF0YWJhc2UgaW5mb1xuICAgICAgICBleHBlY3QoZXJyb3JUZXh0KS5ub3QudG9Db250YWluKCcvaG9tZS9ydW5uZXInKTtcbiAgICAgICAgZXhwZWN0KGVycm9yVGV4dCkubm90LnRvQ29udGFpbignbm9kZV9tb2R1bGVzJyk7XG4gICAgICAgIGV4cGVjdChlcnJvclRleHQpLm5vdC50b0NvbnRhaW4oJ3Bvc3RncmVzcWwnKTtcbiAgICAgICAgZXhwZWN0KGVycm9yVGV4dCkubm90LnRvQ29udGFpbignc3RhY2sgdHJhY2UnKTtcbiAgICAgICAgZXhwZWN0KGVycm9yVGV4dCkubm90LnRvQ29udGFpbignYXQgb2JqZWN0LicpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNldCBhcHByb3ByaWF0ZSBzdGF0dXMgY29kZXMgZm9yIHNlY3VyaXR5IHZpb2xhdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUZXN0IHVuYXV0aG9yaXplZCBhY2Nlc3NcbiAgICAgIGNvbnN0IHVuYXV0aG9yaXplZFJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC9wcm9maWxlJyk7XG4gICAgICBleHBlY3QodW5hdXRob3JpemVkUmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMSk7XG5cbiAgICAgIC8vIFRlc3QgZm9yYmlkZGVuIGFjY2VzcyAod291bGQgbmVlZCBwcm9wZXIgYXV0aCBzZXR1cCBmb3IgcmVhbGlzdGljIHRlc3QpXG4gICAgICBjb25zdCBmb3JiaWRkZW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZGVsZXRlKCcvYXBpL3VzZXJzLzEnKTtcbiAgICAgIGV4cGVjdChbNDAxLCA0MDNdKS50b0NvbnRhaW4oZm9yYmlkZGVuUmVzcG9uc2Uuc3RhdHVzKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0lucHV0IFZhbGlkYXRpb24gU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWFsaWNpb3VzIGlucHV0IHNhZmVseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1hbGljaW91c0lucHV0cyA9IFtcbiAgICAgICAgJzxzY3JpcHQ+YWxlcnQoXCJ4c3NcIik8L3NjcmlwdD4nLFxuICAgICAgICBcIic7IERST1AgVEFCTEUgdXNlcnM7IC0tXCIsXG4gICAgICAgICcuLi8uLi8uLi9ldGMvcGFzc3dkJyxcbiAgICAgICAgJ3t7Y29uc3RydWN0b3IuY29uc3RydWN0b3IoXCJyZXR1cm4gcHJvY2Vzc1wiKSgpLmVudn19JyxcbiAgICAgICAgJ1xceDAwXFx4MDFcXHgwMicsIC8vIEJpbmFyeSBkYXRhXG4gICAgICBdO1xuXG4gICAgICBmb3IgKGNvbnN0IG1hbGljaW91c0lucHV0IG9mIG1hbGljaW91c0lucHV0cykge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgIC5wb3N0KCcvYXBpL29yZ2FuaXphdGlvbnMnKVxuICAgICAgICAgIC5zZW5kKHtcbiAgICAgICAgICAgIG5hbWU6IG1hbGljaW91c0lucHV0LFxuICAgICAgICAgICAgdHlwZTogJ3N5bmRpY2F0ZScsXG4gICAgICAgICAgICBhZGRyZXNzOiAnMTIzIFRlc3QgU3QnLFxuICAgICAgICAgICAgY2l0eTogJ01vbnRyZWFsJyxcbiAgICAgICAgICAgIHByb3ZpbmNlOiAnUUMnLFxuICAgICAgICAgICAgcG9zdGFsQ29kZTogJ0gxQSAxQTEnLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNob3VsZCBlaXRoZXIgcmVqZWN0IHRoZSBpbnB1dCBvciBzYW5pdGl6ZSBpdCBwcm9wZXJseVxuICAgICAgICBleHBlY3QoWzQwMCwgNDAxLCA0MDNdKS50b0NvbnRhaW4ocmVzcG9uc2Uuc3RhdHVzKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXNwb25zZS5ib2R5LmVycm9yKSB7XG4gICAgICAgICAgLy8gRXJyb3IgbWVzc2FnZSBzaG91bGQgbm90IGVjaG8gYmFjayB0aGUgbWFsaWNpb3VzIGlucHV0XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZXJyb3IpLm5vdC50b0NvbnRhaW4oJzxzY3JpcHQ+Jyk7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZXJyb3IpLm5vdC50b0NvbnRhaW4oJ0RST1AgVEFCTEUnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlbmZvcmNlIHJlcXVlc3Qgc2l6ZSBsaW1pdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgb3ZlcnNpemVkIHBheWxvYWRcbiAgICAgIGNvbnN0IGxhcmdlUGF5bG9hZCA9ICdhJy5yZXBlYXQoMTAgKiAxMDI0ICogMTAyNCk7IC8vIDEwTUJcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvb3JnYW5pemF0aW9ucycpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBuYW1lOiBsYXJnZVBheWxvYWQsXG4gICAgICAgICAgdHlwZTogJ3N5bmRpY2F0ZScsXG4gICAgICAgICAgYWRkcmVzczogJzEyMyBUZXN0IFN0JyxcbiAgICAgICAgICBjaXR5OiAnTW9udHJlYWwnLFxuICAgICAgICAgIHByb3ZpbmNlOiAnUUMnLFxuICAgICAgICAgIHBvc3RhbENvZGU6ICdIMUEgMUExJyxcbiAgICAgICAgfSk7XG5cbiAgICAgIC8vIFNob3VsZCByZWplY3Qgb3ZlcnNpemVkIHJlcXVlc3RzXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQxMyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBdXRoZW50aWNhdGlvbiBTZWN1cml0eScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBhdXRoZW50aWNhdGlvbiBieXBhc3MgYXR0ZW1wdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBieXBhc3NBdHRlbXB0cyA9IFtcbiAgICAgICAgeyAneC11c2VyLWlkJzogJzEnIH0sXG4gICAgICAgIHsgJ3gtcm9sZSc6ICdhZG1pbicgfSxcbiAgICAgICAgeyAnYXV0aG9yaXphdGlvbic6ICdCZWFyZXIgZmFrZS10b2tlbicgfSxcbiAgICAgICAgeyAneC1mb3J3YXJkZWQtdXNlcic6ICdhZG1pbicgfSxcbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3QgaGVhZGVycyBvZiBieXBhc3NBdHRlbXB0cykge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgIC5nZXQoJy9hcGkvYXV0aC9wcm9maWxlJylcbiAgICAgICAgICAuc2V0KGhlYWRlcnMpO1xuXG4gICAgICAgIC8vIFNob3VsZCBub3QgYnlwYXNzIGF1dGhlbnRpY2F0aW9uXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAxKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNlc3Npb24gbWFuaXB1bGF0aW9uIGF0dGVtcHRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWFuaXB1bGF0aW9uQXR0ZW1wdHMgPSBbXG4gICAgICAgICdhZG1pbi1zZXNzaW9uLWlkJyxcbiAgICAgICAgJy4uL2FkbWluLXNlc3Npb24nLFxuICAgICAgICAnbnVsbCcsXG4gICAgICAgICd1bmRlZmluZWQnLFxuICAgICAgICBKU09OLnN0cmluZ2lmeSh7IHVzZXJJZDogMSwgcm9sZTogJ2FkbWluJyB9KSxcbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3Qgc2Vzc2lvbklkIG9mIG1hbmlwdWxhdGlvbkF0dGVtcHRzKSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgICAgLmdldCgnL2FwaS9hdXRoL3Byb2ZpbGUnKVxuICAgICAgICAgIC5zZXQoJ0Nvb2tpZScsIGBrb3Zlby5zaWQ9JHtzZXNzaW9uSWR9YCk7XG5cbiAgICAgICAgLy8gU2hvdWxkIG5vdCBhY2NlcHQgbWFuaXB1bGF0ZWQgc2Vzc2lvbnNcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSg0MDEpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==