1705bc522ec123a854569aba01ba3e0f
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sessionConfig = void 0;
exports.hashPassword = hashPassword;
exports.verifyPassword = verifyPassword;
exports.requireAuth = requireAuth;
exports.requireRole = requireRole;
exports.authorize = authorize;
exports.setupAuthRoutes = setupAuthRoutes;
exports.canViewDocument = canViewDocument;
exports.canEditDocument = canEditDocument;
exports.canDeleteDocument = canDeleteDocument;
exports.canCreateDocument = canCreateDocument;
const express_session_1 = __importDefault(require("express-session"));
const connect_pg_simple_1 = __importDefault(require("connect-pg-simple"));
const crypto_1 = require("crypto");
const bcrypt = __importStar(require("bcryptjs"));
const storage_1 = require("./storage");
const db_1 = require("./db");
const index_1 = require("./config/index");
// Database-based permission checking - no config files needed
const serverless_1 = require("@neondatabase/serverless");
const schema = __importStar(require("../shared/schema"));
const drizzle_orm_1 = require("drizzle-orm");
const email_service_1 = require("./services/email-service");
const query_cache_1 = require("./query-cache");
/**
 * Check if a user role has a specific permission via database lookup.
 * @param userRole - The user's role (admin, manager, tenant, resident).
 * @param permissionName - The permission name (e.g., 'read:user', 'create:building').
 * @returns Promise<boolean> - True if user has permission.
 */
async function checkUserPermission(userRole, permissionName) {
    try {
        // Debug logging removed for production security
        // First check if permission exists at all
        const permissionExists = await db_1.db
            .select()
            .from(schema.permissions)
            .where((0, drizzle_orm_1.eq)(schema.permissions.name, permissionName))
            .limit(1);
        // Permission exists check complete
        // Check role permissions
        const rolePermissions = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole));
        // Role permissions checked
        const result = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole), (0, drizzle_orm_1.eq)(schema.permissions.name, permissionName)))
            .limit(1);
        // Permission check completed
        if (result.length === 0) {
            // Permission not found
            // Debug: list all admin permissions
            if (userRole === 'admin') {
                const adminPerms = await db_1.db
                    .select({ name: schema.permissions.name })
                    .from(schema.rolePermissions)
                    .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
                    .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, 'admin'));
                // Admin permissions debug removed for security
            }
        }
        return result.length > 0;
    }
    catch (error) {
        console.error('‚ùå Permission check failed:', error);
        return false;
    }
}
// Initialize email service
const emailService = new email_service_1.EmailService();
// Database connection already imported at top of file
// Configure session store with PostgreSQL
const PostgreSqlStore = (0, connect_pg_simple_1.default)(express_session_1.default);
/**
 * Get the correct database URL based on environment and request domain.
 * Uses centralized configuration to determine the appropriate database.
 */
function getDatabaseUrl(requestDomain) {
    // CRITICAL: koveo-gestion.com MUST use DATABASE_URL_KOVEO exclusively
    const finalUrl = index_1.config.database.getRuntimeDatabaseUrl(requestDomain);
    const isKoveoRequest = requestDomain?.includes('koveo-gestion.com');
    const isProduction = index_1.config.server.isProduction || isKoveoRequest;
    console.log(`üîó Session store using ${isProduction ? 'PRODUCTION (DATABASE_URL_KOVEO)' : 'DEVELOPMENT (DATABASE_URL)'} database: ${finalUrl?.substring(0, 50)}... (domain: ${requestDomain || 'unknown'})`);
    if (!finalUrl) {
        throw new Error('No database URL available for session store');
    }
    return finalUrl;
}
/**
 * Session configuration for Quebec-compliant user authentication.
 * Uses PostgreSQL session store for scalability and Law 25 compliance.
 * Includes fallback for database connection issues in production.
 */
function createSessionStore(requestDomain) {
    try {
        // Create a proper PostgreSQL pool for the session store
        // connect-pg-simple needs a real PostgreSQL pool, not the Neon HTTP client
        const sessionPool = new serverless_1.Pool({
            connectionString: getDatabaseUrl(requestDomain),
            max: 5, // Increased pool size for better production performance
            min: 1,
            maxUses: 10000, // Increased reuse limit
            idleTimeoutMillis: 60000, // Increased to 60 seconds for production stability
            allowExitOnIdle: false, // Keep connections alive in production
            connectionTimeoutMillis: 30000, // 30 second connection timeout
        });
        // Add connection error handling
        sessionPool.on('error', (err) => {
            console.error('‚ùå Session pool error:', err);
        });
        sessionPool.on('connect', () => {
            console.log('‚úÖ Session pool connection established');
        });
        // Use PostgreSQL session store for persistent sessions
        const store = new PostgreSqlStore({
            pool: sessionPool,
            tableName: 'session',
            createTableIfMissing: true, // Auto-create table in production if missing
            errorLog: process.env.NODE_ENV === 'test' ? () => { } : console.error, // Suppress error logging in tests
            // Add explicit configuration for session retrieval
            pruneSessionInterval: process.env.NODE_ENV === 'test' ? false : 5 * 60 * 1000, // Every 5 minutes in production
            schemaName: 'public', // Explicitly set schema
            // Additional production optimizations
            ttl: 7 * 24 * 60 * 60, // 7 days in seconds to match cookie maxAge
            disableTouch: false, // Enable touch to extend session lifetime
        });
        console.log('‚úÖ Session store: PostgreSQL session store created with proper pool');
        // Test the store connection (skip in test environment)
        if (process.env.NODE_ENV !== 'test') {
            // More robust connection test
            const testSessionId = `test-${Date.now()}`;
            store.set(testSessionId, { test: true }, (err) => {
                if (err) {
                    console.error('‚ùå Session store write test failed:', err);
                }
                else {
                    store.get(testSessionId, (getErr, session) => {
                        if (getErr) {
                            console.error('‚ùå Session store read test failed:', getErr);
                        }
                        else {
                            console.log('‚úÖ Session store read/write test passed');
                            // Clean up test session
                            store.destroy(testSessionId, () => { });
                        }
                    });
                }
            });
        }
        return store;
    }
    catch (error) {
        console.error('‚ùå Session store creation failed:', error);
        console.log('‚ö†Ô∏è Falling back to memory store (sessions will not persist)');
        return undefined; // Will use default memory store as fallback
    }
}
// Create session store with better database detection  
let sessionStore;
try {
    // Try to create session store with automatic database detection
    sessionStore = createSessionStore();
}
catch (error) {
    console.error('‚ùå Failed to create initial session store:', error);
    sessionStore = undefined; // Will fall back to memory store
}
exports.sessionConfig = (0, express_session_1.default)({
    store: sessionStore, // Use PostgreSQL session store for persistence
    secret: process.env.SESSION_SECRET || 'fallback-secret-change-in-production',
    resave: false, // Don't save unchanged sessions
    saveUninitialized: false,
    rolling: true, // Reset expiry on each request
    cookie: {
        secure: index_1.config.server.isProduction, // Use HTTPS in production
        httpOnly: true,
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days - longer session duration
        sameSite: index_1.config.server.isProduction ? 'strict' : 'lax', // Stricter in production
        path: '/', // Explicitly set path
        domain: index_1.config.server.isProduction && index_1.config.server.domain.includes('koveo-gestion.com')
            ? '.koveo-gestion.com' // Allow subdomain sharing in production
            : undefined,
    },
    name: 'koveo.sid',
    proxy: index_1.config.server.isProduction, // Enable proxy trust in production
});
/**
 * Enhanced password hashing using bcrypt with salt for Quebec Law 25 compliance.
 * Provides strong security using industry-standard bcrypt algorithm
 * with configurable salt rounds (default: 12).
 *
 * @param {string} password - Plain text password to hash.
 * @returns {Promise<string>} Promise resolving to bcrypt hashed password.
 *
 * @example
 * ```typescript
 * const hashedPassword = await hashPassword('userPassword123');
 * // Store hashed password securely in database
 * await storage.createUser({ ...userData, password: hashedPassword });
 * ```
 */
/**
 * HashPassword function.
 * @param password
 * @returns Function result.
 */
async function hashPassword(password) {
    const saltRounds = 12; // Recommended for production
    return await bcrypt.hash(password, saltRounds);
}
/**
 * Verifies a password against stored bcrypt hash using constant-time comparison.
 * Uses bcrypt.compare for secure password verification.
 *
 * @param {string} password - Plain text password to verify.
 * @param {string} hashedPassword - Stored bcrypt hash from user record.
 * @returns {Promise<boolean>} Promise resolving to true if password matches, false otherwise.
 *
 * @example
 * ```typescript
 * const user = await storage.getUserByEmail(email);
 * const isValid = await verifyPassword(inputPassword, user.password);
 * if (isValid) {
 *   // Grant access
 * }
 * ```
 */
/**
 * VerifyPassword function.
 * @param password
 * @param hashedPassword
 * @returns Function result.
 */
async function verifyPassword(password, hashedPassword) {
    return await bcrypt.compare(password, hashedPassword);
}
/**
 * Authentication middleware to protect routes requiring user login.
 * Validates session existence, retrieves user data, and ensures account is active.
 * Automatically destroys invalid sessions for security.
 *
 * @param {Request} req - Express request object with session data.
 * @param {Response} res - Express response object for sending error responses.
 * @param {NextFunction} next - Express next function to continue to protected route.
 * @returns {Promise<void>} Promise that resolves when authentication is verified.
 *
 * @example
 * ```typescript
 * app.get('/api/protected-route', requireAuth, async (req, res) => {
 *   // req.user is now available and verified
 *   res.json({ userId: req.user.id });
 * });
 * ```
 */
/**
 * RequireAuth function.
 * @param req
 * @param res
 * @param next
 * @returns Function result.
 */
async function requireAuth(req, res, next) {
    if (!req.session?.userId) {
        return res.status(401).json({
            message: 'Authentication required',
            code: 'AUTH_REQUIRED',
        });
    }
    try {
        // More aggressive session touch for better UX - extend session on each authenticated request
        if (req.session && req.session.touch && req.session.cookie) {
            const now = Date.now();
            const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
            const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
            // Touch session if more than 10% of its lifetime has passed (more responsive)
            if (sessionAge > sessionLifetime * 0.1) {
                req.session.touch();
            }
        }
        // Loading user session
        // Clear any cached user data for this ID to ensure fresh load
        query_cache_1.queryCache.invalidate('users', `user:${req.session.userId}`);
        query_cache_1.queryCache.invalidate('users', `user_email:*`);
        const user = await storage_1.storage.getUser(req.session.userId);
        // User loaded from session
        if (!user || !user.isActive) {
            req.session.destroy((err) => {
                if (err) {
                    // Session destruction error handled
                }
            });
            return res.status(401).json({
                message: 'User account not found or inactive',
                code: 'USER_INACTIVE',
            });
        }
        // Set session role (permissions handled via database)
        req.session.role = user.role;
        // Add organization information to the user object - with error handling for resilience
        let userOrganizations = [];
        try {
            userOrganizations = await db_1.db
                .select({
                organizationId: schema.userOrganizations.organizationId,
                canAccessAllOrganizations: schema.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema.userOrganizations)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.userOrganizations.userId, user.id), (0, drizzle_orm_1.eq)(schema.userOrganizations.isActive, true)));
        }
        catch (orgError) {
            // Organization lookup error handled gracefully
            // Continue with empty organizations - user can still authenticate
            userOrganizations = [];
        }
        // Enhanced user object with organization access information
        req.user = {
            ...user,
            organizations: userOrganizations.map((uo) => uo.organizationId),
            canAccessAllOrganizations: userOrganizations.some((uo) => uo.canAccessAllOrganizations),
        };
        // Special handling for hardcoded demo users - ensure they have proper organization access
        // Check if the user record has organization access configured
        if (user.role?.startsWith('demo_') &&
            (!req.user.organizations || req.user.organizations.length === 0)) {
            // Demo users should get access to demo organizations
            try {
                const demoOrgs = await db_1.db
                    .select({ id: schema.organizations.id })
                    .from(schema.organizations)
                    .where((0, drizzle_orm_1.eq)(schema.organizations.type, 'demo'))
                    .limit(1);
                if (demoOrgs.length > 0) {
                    // Adding organization access for demo user
                    req.user.organizations = [demoOrgs[0].id];
                    req.user.canAccessAllOrganizations = false;
                }
            }
            catch (demoOrgError) {
                // Demo organization lookup failed, continue without access
            }
        }
        next();
    }
    catch (error) {
        // Authentication error handled
        console.error('‚ùå Authentication error:', error);
        return res.status(500).json({
            message: 'Authentication error',
            code: 'AUTH_ERROR',
        });
    }
}
/**
 * Role-based authorization middleware factory for Quebec property management roles.
 * Creates middleware that restricts access based on user roles such as admin, manager, tenant.
 * Must be used after requireAuth middleware.
 *
 * @param {string[]} allowedRoles - Array of roles that can access the route (e.g., ['admin', 'manager']).
 * @returns {Function} Express middleware function for role validation.
 *
 * @example
 * ```typescript
 * // Only admins can access user management
 * app.get('/api/admin/users', requireAuth, requireRole(['admin']), getUserList);
 *
 * // Managers and admins can access building data
 * app.get('/api/buildings', requireAuth, requireRole(['admin', 'manager']), getBuildings);
 * ```
 */
/**
 * RequireRole function.
 * @param allowedRoles
 * @returns Function result.
 */
function requireRole(allowedRoles) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        if (!allowedRoles.includes(req.user.role)) {
            return res.status(403).json({
                message: 'Insufficient permissions',
                code: 'INSUFFICIENT_PERMISSIONS',
                required: allowedRoles,
                current: req.user.role,
            });
        }
        next();
    };
}
/**
 * Permission-based authorization middleware factory using the comprehensive RBAC system.
 * Validates user permissions based on the database RBAC system.
 * Must be used after requireAuth middleware.
 *
 * @param {string} permission - Specific permission required to access the route (e.g., 'read:bill', 'create:maintenance_request').
 * @returns {Function} Express middleware function for permission validation.
 *
 * @example
 * ```typescript
 * // Only users with 'read:bill' permission can access
 * app.get('/api/bills', requireAuth, authorize('read:bill'), getBills);
 *
 * // Only users with 'delete:user' permission can delete users
 * app.delete('/api/users/:id', requireAuth, authorize('delete:user'), deleteUser);
 *
 * // Multiple route protection
 * router.use(authorize('manage:building'));
 * router.post('/buildings', createBuilding);
 * router.patch('/buildings/:id', updateBuilding);
 * ```
 */
/**
 * Authorize function.
 * @param permission
 * @returns Function result.
 */
function authorize(permission) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Check if the user's role has the required permission via database
            const hasPermission = await checkUserPermission(req.user.role, permission);
            if (!hasPermission) {
                return res.status(403).json({
                    message: 'Insufficient permissions',
                    code: 'PERMISSION_DENIED',
                    required: permission,
                    userRole: req.user.role,
                    details: `User with role '${req.user.role}' does not have permission '${permission}'`,
                });
            }
            next();
        }
        catch (error) {
            // Authorization error handled
            console.error('‚ùå Authorization error:', error);
            return res.status(500).json({
                message: 'Authorization check failed',
                code: 'AUTHORIZATION_ERROR',
            });
        }
    };
}
/**
 * Sets up authentication routes for Quebec-compliant user management.
 * Implements login, logout, registration, and current user endpoints
 * with proper session management and Law 25 compliance considerations.
 *
 * @param {any} app - Express application instance to register routes on.
 * @returns {void} No return value - routes are registered directly on app.
 *
 * @example
 * ```typescript
 * const app = express();
 * app.use(sessionConfig);
 * setupAuthRoutes(app);
 * // Authentication routes are now available:
 * // POST /api/auth/login
 * // POST /api/auth/logout
 * // GET /api/auth/user
 * // POST /api/auth/register
 * ```
 */
/**
 * SetupAuthRoutes function.
 * @param app
 * @returns Function result.
 */
function setupAuthRoutes(app) {
    // Login route
    app.post('/api/auth/login', async (req, res) => {
        try {
            const { email, password } = req.body;
            // Login attempt initiated
            if (!email || !password) {
                return res.status(400).json({
                    message: 'Email and password are required',
                    code: 'MISSING_CREDENTIALS',
                });
            }
            // Retrieving user by email
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            if (!user.isActive) {
                return res.status(401).json({
                    message: 'Account is inactive',
                    code: 'ACCOUNT_INACTIVE',
                });
            }
            // Use bcrypt for password verification
            // Verifying password for user
            // Password verification initiated
            const isValidPassword = await verifyPassword(password, user.password);
            // Password verification completed
            if (!isValidPassword) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            // Update last login
            await storage_1.storage.updateUser(user.id, { lastLoginAt: new Date() });
            // Set session with user data
            req.session.userId = user.id;
            req.session.userRole = user.role;
            req.session.role = user.role;
            req.session.user = user; // Add complete user object for middleware compatibility
            // Save session explicitly to ensure it's persisted
            req.session.save((err) => {
                if (err) {
                    console.error('‚ùå Session save error:', err);
                    return res.status(500).json({
                        message: 'Session save failed',
                        code: 'SESSION_SAVE_ERROR',
                    });
                }
                // Return user data (without password)
                const { password: _, ...userData } = user;
                res.json({
                    user: userData,
                    message: 'Login successful',
                });
            });
        }
        catch (_error) {
            console.error('Login error:', {
                error: _error,
                email: req.body?.email,
                hasPassword: !!req.body?.password,
                databaseUrl: !!process.env.DATABASE_URL,
                sessionSecret: !!process.env.SESSION_SECRET,
            });
            res.status(500).json({
                message: 'Login failed',
                code: 'LOGIN_ERROR',
                ...(process.env.NODE_ENV === 'development' && { details: _error }),
            });
        }
    });
    // Logout route
    app.post('/api/auth/logout', (req, res) => {
        req.session.destroy((err) => {
            if (err) {
                console.error('Logout error:', err);
                return res.status(500).json({
                    message: 'Logout failed',
                    code: 'LOGOUT_ERROR',
                });
            }
            // Clear cookie with proper options that match session config
            const cookieOptions = {
                httpOnly: true,
                secure: index_1.config.server.isProduction,
                sameSite: index_1.config.server.isProduction ? 'strict' : 'lax',
                path: '/',
            };
            // Also clear with domain if in production
            if (index_1.config.server.isProduction && index_1.config.server.domain.includes('koveo-gestion.com')) {
                cookieOptions.domain = '.koveo-gestion.com';
            }
            res.clearCookie('koveo.sid', cookieOptions);
            // Also try clearing without domain as fallback
            res.clearCookie('koveo.sid', {
                httpOnly: true,
                secure: index_1.config.server.isProduction,
                sameSite: index_1.config.server.isProduction ? 'strict' : 'lax',
                path: '/',
            });
            res.json({ message: 'Logout successful' });
        });
    });
    // Get current user route
    app.get('/api/auth/user', async (req, res) => {
        try {
            // Check user session
            // Check if we have a valid session with user ID
            if (!req.session?.userId) {
                // No session found
                console.log('‚ùå No valid session found');
                return res.status(401).json({
                    message: 'Not authenticated',
                    code: 'NOT_AUTHENTICATED',
                });
            }
            // Try to get user from database
            try {
                const user = await storage_1.storage.getUser(req.session.userId);
                // User lookup completed
                if (!user || !user.isActive) {
                    // User not found or inactive, destroying session
                    req.session.destroy((err) => {
                        if (err) {
                            console.error('Session destruction error:', err);
                        }
                    });
                    return res.status(401).json({
                        message: 'User account not found or inactive',
                        code: 'USER_INACTIVE',
                    });
                }
                // Touch session more frequently for better UX
                if (req.session && req.session.touch && req.session.cookie) {
                    const now = Date.now();
                    const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
                    const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
                    // Touch session if more than 10% of its lifetime has passed
                    if (sessionAge > sessionLifetime * 0.1) {
                        req.session.touch();
                    }
                }
                // Return user data without password
                const { password: _, ...userData } = user;
                // Successfully authenticated user
                res.json(userData);
            }
            catch (userError) {
                console.error('Database error getting user:', userError);
                return res.status(500).json({
                    message: 'Authentication check failed',
                    code: 'AUTH_CHECK_ERROR',
                });
            }
        }
        catch (error) {
            console.error('‚ùå Auth check error:', error);
            res.status(500).json({
                message: 'Authentication check failed',
                code: 'AUTH_CHECK_ERROR',
            });
        }
    });
    // Debug endpoint to check auth configuration (production only, temporary)
    app.get('/api/auth/debug', async (req, res) => {
        const debugInfo = {
            hasSession: !!req.session,
            sessionId: req.sessionID,
            userId: req.session?.userId,
            userRole: req.session?.userRole,
            nodeEnv: process.env.NODE_ENV,
            hasDatabaseUrl: !!process.env.DATABASE_URL,
            hasSessionSecret: !!process.env.SESSION_SECRET,
            cookies: req.headers.cookie ? 'present' : 'missing',
            cookieHeader: req.headers.cookie,
            sessionStore: req.session?.store?.constructor?.name || 'unknown',
            userAgent: req.headers['user-agent'],
            host: req.headers.host,
            protocol: req.protocol,
            secure: req.secure,
            trustProxy: !!req.app.get('trust proxy'),
        };
        console.log('Auth debug info:', debugInfo);
        res.json(debugInfo);
    });
    // Test cookie setting endpoint
    app.post('/api/auth/test-cookie', (req, res) => {
        // Set a test session value
        req.session.testValue = 'test-' + Date.now();
        req.session.save((err) => {
            if (err) {
                return res.status(500).json({ error: 'Failed to save session', details: err.message });
            }
            res.json({
                message: 'Test cookie set',
                sessionId: req.sessionID,
                testValue: req.session.testValue,
                cookieSettings: {
                    secure: process.env.NODE_ENV === 'production',
                    httpOnly: true,
                    sameSite: 'lax',
                },
            });
        });
    });
    // Register route (admin only for now)
    app.post('/api/auth/register', requireAuth, requireRole(['admin']), async (req, res) => {
        try {
            const { email, password, firstName, lastName, role = 'tenant', language = 'fr' } = req.body;
            if (!email || !password || !firstName || !lastName) {
                return res.status(400).json({
                    message: 'All fields are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Check if user already exists
            const existingUser = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (existingUser) {
                return res.status(409).json({
                    message: 'User already exists',
                    code: 'USER_EXISTS',
                });
            }
            // Create user with bcrypt hashed password
            const hashedPassword = await hashPassword(password);
            const newUser = await storage_1.storage.createUser({
                email: email.toLowerCase(),
                password: hashedPassword,
                firstName,
                lastName,
                username: email.toLowerCase(), // Use email as username
                role,
                language,
            });
            const { password: _, ...userData } = newUser;
            res.status(201).json({
                user: userData,
                message: 'User created successfully',
            });
        }
        catch (error) {
            console.error('‚ùå Registration error:', error);
            res.status(500).json({
                message: 'Registration failed',
                code: 'REGISTRATION_ERROR',
            });
        }
    });
    // Password Reset Request Route
    app.post('/api/auth/forgot-password', async (req, res) => {
        try {
            const { email } = req.body;
            if (!email) {
                return res.status(400).json({
                    message: 'Email is required',
                    code: 'MISSING_EMAIL',
                });
            }
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user || !user.isActive) {
                // Always respond with success for security (don't reveal if email exists)
                return res.json({
                    message: 'If this email exists, a password reset link has been sent.',
                    success: true,
                });
            }
            // Generate secure random token
            const resetToken = (0, crypto_1.randomBytes)(32).toString('hex');
            const tokenHash = (0, crypto_1.createHash)('sha256').update(resetToken).digest('hex');
            // Create password reset token (expires in 1 hour)
            const expiresAt = new Date();
            expiresAt.setHours(expiresAt.getHours() + 1);
            await storage_1.storage.createPasswordResetToken({
                userId: user.id,
                token: resetToken,
                tokenHash: tokenHash,
                expiresAt: expiresAt,
                ipAddress: req.ip || req.connection?.remoteAddress || 'unknown',
                userAgent: req.headers['user-agent'] || 'unknown',
            });
            // Send password reset email
            const host = req.get('host') || '';
            // Use development URL for Replit environments, production URL otherwise
            let frontendUrl;
            if (host.includes('replit.dev') ||
                host.includes('replit.com') ||
                host.includes('replit.co') ||
                process.env.NODE_ENV === 'development') {
                // Use the actual Replit development URL
                frontendUrl = `${req.protocol}://${host}`;
            }
            else {
                // Use production URL - prioritize koveo-gestion.com for production
                if (host.includes('koveo-gestion.com')) {
                    frontendUrl = `https://${host}`;
                }
                else {
                    frontendUrl = process.env.FRONTEND_URL || 'https://koveo-gestion.com';
                }
            }
            const cleanUrl = frontendUrl.endsWith('/') ? frontendUrl.slice(0, -1) : frontendUrl;
            const resetUrl = `${cleanUrl}/reset-password?token=${resetToken}`;
            const emailSent = await emailService.sendPasswordResetEmail(email.toLowerCase(), `${user.firstName} ${user.lastName}`, resetUrl);
            if (!emailSent) {
                console.error('Failed to send password reset email to:', email);
                return res.status(500).json({
                    message: 'Failed to send password reset email',
                    code: 'EMAIL_SEND_FAILED',
                });
            }
            res.json({
                message: 'If this email exists, a password reset link has been sent.',
                success: true,
            });
        }
        catch (error) {
            console.error('‚ùå Password reset request error:', error);
            res.status(500).json({
                message: 'Password reset request failed',
                code: 'PASSWORD_RESET_REQUEST_ERROR',
            });
        }
    });
    // Password Reset Route
    app.post('/api/auth/reset-password', async (req, res) => {
        try {
            const { token, password } = req.body;
            if (!token || !password) {
                return res.status(400).json({
                    message: 'Token and password are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Validate password strength
            if (password.length < 8) {
                return res.status(400).json({
                    message: 'Password must be at least 8 characters long',
                    code: 'PASSWORD_TOO_SHORT',
                });
            }
            // Check password complexity requirements
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
                return res.status(400).json({
                    message: 'Password must contain at least one uppercase letter, one lowercase letter, and one number',
                    code: 'PASSWORD_TOO_WEAK',
                });
            }
            // Find the password reset token
            const resetToken = await storage_1.storage.getPasswordResetToken(token);
            if (!resetToken) {
                return res.status(400).json({
                    message: 'Invalid or expired password reset token',
                    code: 'INVALID_TOKEN',
                });
            }
            // Check if token is expired
            if (new Date() > resetToken.expiresAt) {
                return res.status(400).json({
                    message: 'Password reset token has expired',
                    code: 'TOKEN_EXPIRED',
                });
            }
            // Check if token has already been used
            if (resetToken.isUsed) {
                return res.status(400).json({
                    message: 'Password reset token has already been used',
                    code: 'TOKEN_ALREADY_USED',
                });
            }
            // Verify token hash for additional security
            const tokenHash = (0, crypto_1.createHash)('sha256').update(token).digest('hex');
            if (tokenHash !== resetToken.tokenHash) {
                return res.status(400).json({
                    message: 'Invalid password reset token',
                    code: 'INVALID_TOKEN_HASH',
                });
            }
            // Get the user
            const user = await storage_1.storage.getUser(resetToken.userId);
            if (!user || !user.isActive) {
                return res.status(400).json({
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                });
            }
            // Update user password with bcrypt hashed version
            const hashedPassword = await hashPassword(password);
            await storage_1.storage.updateUser(user.id, {
                password: hashedPassword,
                updatedAt: new Date(),
            });
            // Mark token as used
            await storage_1.storage.markPasswordResetTokenAsUsed(resetToken.id);
            // Clean up expired tokens
            await storage_1.storage.cleanupExpiredPasswordResetTokens();
            res.json({
                message: 'Password has been reset successfully',
                success: true,
            });
        }
        catch (error) {
            console.error('‚ùå Password reset error:', error);
            res.status(500).json({
                message: 'Password reset failed',
                code: 'PASSWORD_RESET_ERROR',
            });
        }
    });
}
/**
 * Document RBAC Functions - Role-Based Access Control for Documents
 * Implements the four-tier permission system: Admin > Manager > Resident > Tenant
 */
/**
 * Check if user can view a specific document based on RBAC rules
 * @param user - The authenticated user
 * @param document - The document to check access for
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can view document
 */
async function canViewDocument(user, document, userResidences) {
    try {
        // Admin: Can view all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can view all documents in their organization
        if (user.role === 'manager') {
            // Check if document belongs to manager's organization
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true; // Manager can view organization-level docs
        }
        // Resident: Can view documents in their residence/building
        if (user.role === 'resident') {
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            if (document.buildingId) {
                // Can view building docs if they live in that building
                const userBuildingIds = userResidences?.map(async (ur) => {
                    const residence = await storage_1.storage.getResidence(ur.residenceId);
                    return residence?.buildingId;
                });
                const buildingIds = await Promise.all(userBuildingIds || []);
                return buildingIds.includes(document.buildingId);
            }
            return false;
        }
        // Tenant: Can only view documents marked as visible to tenants
        if (user.role === 'tenant') {
            if (!document.isVisibleToTenants) {
                return false;
            }
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            if (document.buildingId) {
                const userBuildingIds = userResidences?.map(async (ur) => {
                    const residence = await storage_1.storage.getResidence(ur.residenceId);
                    return residence?.buildingId;
                });
                const buildingIds = await Promise.all(userBuildingIds || []);
                return buildingIds.includes(document.buildingId);
            }
            return false;
        }
        return false;
    }
    catch (error) {
        console.error('Document view permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can edit a specific document
 * @param user - The authenticated user
 * @param document - The document to check
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can edit document
 */
async function canEditDocument(user, document, userResidences) {
    try {
        // Admin: Can edit all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can edit all documents in their organization
        if (user.role === 'manager') {
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can edit documents they created or in their residence
        if (user.role === 'resident') {
            // Can edit own documents
            if (document.uploadedBy === user.id) {
                return true;
            }
            // Can edit residence documents
            if (document.residenceId) {
                return userResidences?.some(ur => ur.residenceId === document.residenceId) || false;
            }
            return false;
        }
        // Tenant: Cannot edit documents (read-only access)
        return false;
    }
    catch (error) {
        console.error('Document edit permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can delete a specific document
 * @param user - The authenticated user
 * @param document - The document to check
 * @param userResidences - User's residence associations
 * @returns Promise<boolean> - True if user can delete document
 */
async function canDeleteDocument(user, document, userResidences) {
    try {
        // Admin: Can delete all documents
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can delete documents in their organization
        if (user.role === 'manager') {
            if (document.buildingId) {
                const building = await storage_1.storage.getBuilding(document.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (document.residenceId) {
                const residence = await storage_1.storage.getResidence(document.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can only delete documents they uploaded
        if (user.role === 'resident') {
            return document.uploadedBy === user.id;
        }
        // Tenant: Cannot delete documents
        return false;
    }
    catch (error) {
        console.error('Document delete permission check failed:', error);
        return false;
    }
}
/**
 * Check if user can create documents in a specific context
 * @param user - The authenticated user
 * @param context - The context (buildingId, residenceId, or organization)
 * @returns Promise<boolean> - True if user can create documents
 */
async function canCreateDocument(user, context) {
    try {
        // Admin: Can create documents anywhere
        if (user.role === 'admin') {
            return true;
        }
        // Manager: Can create documents in their organization
        if (user.role === 'manager') {
            if (context.organizationId) {
                return context.organizationId === user.organizationId;
            }
            if (context.buildingId) {
                const building = await storage_1.storage.getBuilding(context.buildingId);
                return building?.organizationId === user.organizationId;
            }
            if (context.residenceId) {
                const residence = await storage_1.storage.getResidence(context.residenceId);
                if (residence) {
                    const building = await storage_1.storage.getBuilding(residence.buildingId);
                    return building?.organizationId === user.organizationId;
                }
            }
            return true;
        }
        // Resident: Can create documents in their residence
        if (user.role === 'resident') {
            if (context.residenceId) {
                // Check if user lives in this residence
                const userResidences = await storage_1.storage.getUserResidences(user.id);
                return userResidences.some(ur => ur.residenceId === context.residenceId);
            }
            return false;
        }
        // Tenant: Cannot create documents
        return false;
    }
    catch (error) {
        console.error('Document create permission check failed:', error);
        return false;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXV0aC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF5T0Esb0NBR0M7QUF5QkQsd0NBRUM7QUEyQkQsa0NBeUdDO0FBd0JELGtDQW9CQztBQTZCRCw4QkFpQ0M7QUEyQkQsMENBb2VDO0FBY0QsMENBc0VDO0FBU0QsMENBK0NDO0FBU0QsOENBc0NDO0FBUUQsOENBNkNDO0FBbnVDRCxzRUFBc0M7QUFDdEMsMEVBQTBDO0FBQzFDLG1DQUFpRDtBQUNqRCxpREFBbUM7QUFDbkMsdUNBQW9DO0FBQ3BDLDZCQUFxQztBQUNyQywwQ0FBd0M7QUFFeEMsOERBQThEO0FBQzlELHlEQUFnRDtBQUVoRCx5REFBMkM7QUFDM0MsNkNBQXNDO0FBQ3RDLDREQUF3RDtBQUN4RCwrQ0FBMkM7QUFFM0M7Ozs7O0dBS0c7QUFDSCxLQUFLLFVBQVUsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxjQUFzQjtJQUN6RSxJQUFJLENBQUM7UUFDSCxnREFBZ0Q7UUFFaEQsMENBQTBDO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxPQUFFO2FBQzlCLE1BQU0sRUFBRTthQUNSLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO2FBQ3hCLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7YUFDbEQsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRVosbUNBQW1DO1FBRW5DLHlCQUF5QjtRQUN6QixNQUFNLGVBQWUsR0FBRyxNQUFNLE9BQUU7YUFDN0IsTUFBTSxFQUFFO2FBQ1IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7YUFDNUIsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxRQUFlLENBQUMsQ0FBQyxDQUFDO1FBRTNELDJCQUEyQjtRQUUzQixNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQUU7YUFDcEIsTUFBTSxFQUFFO2FBQ1IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7YUFDNUIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBQSxnQkFBRSxFQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDNUYsS0FBSyxDQUNKLElBQUEsaUJBQUcsRUFDRCxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsUUFBZSxDQUFDLEVBQ2hELElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FDNUMsQ0FDRjthQUNBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVaLDZCQUE2QjtRQUU3QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDeEIsdUJBQXVCO1lBQ3ZCLG9DQUFvQztZQUNwQyxJQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDekIsTUFBTSxVQUFVLEdBQUcsTUFBTSxPQUFFO3FCQUN4QixNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztxQkFDekMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7cUJBQzVCLFFBQVEsQ0FDUCxNQUFNLENBQUMsV0FBVyxFQUNsQixJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FDL0Q7cUJBQ0EsS0FBSyxDQUFDLElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCwrQ0FBK0M7WUFDakQsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0FBQ0gsQ0FBQztBQUVELDJCQUEyQjtBQUMzQixNQUFNLFlBQVksR0FBRyxJQUFJLDRCQUFZLEVBQUUsQ0FBQztBQUV4QyxzREFBc0Q7QUFFdEQsMENBQTBDO0FBQzFDLE1BQU0sZUFBZSxHQUFHLElBQUEsMkJBQVMsRUFBQyx5QkFBTyxDQUFDLENBQUM7QUFFM0M7OztHQUdHO0FBQ0gsU0FBUyxjQUFjLENBQUMsYUFBc0I7SUFDNUMsc0VBQXNFO0lBQ3RFLE1BQU0sUUFBUSxHQUFHLGNBQU0sQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEUsTUFBTSxjQUFjLEdBQUcsYUFBYSxFQUFFLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLE1BQU0sWUFBWSxHQUFHLGNBQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLGNBQWMsQ0FBQztJQUVsRSxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixZQUFZLENBQUMsQ0FBQyxDQUFDLGlDQUFpQyxDQUFDLENBQUMsQ0FBQyw0QkFBNEIsY0FBYyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsZ0JBQWdCLGFBQWEsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0lBRTVNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLGFBQXNCO0lBQ2hELElBQUksQ0FBQztRQUNILHdEQUF3RDtRQUN4RCwyRUFBMkU7UUFDM0UsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBSSxDQUFDO1lBQzNCLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxhQUFhLENBQUM7WUFDL0MsR0FBRyxFQUFFLENBQUMsRUFBRSx3REFBd0Q7WUFDaEUsR0FBRyxFQUFFLENBQUM7WUFDTixPQUFPLEVBQUUsS0FBSyxFQUFFLHdCQUF3QjtZQUN4QyxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsbURBQW1EO1lBQzdFLGVBQWUsRUFBRSxLQUFLLEVBQUUsdUNBQXVDO1lBQy9ELHVCQUF1QixFQUFFLEtBQUssRUFBRSwrQkFBK0I7U0FDaEUsQ0FBQyxDQUFDO1FBRUgsZ0NBQWdDO1FBQ2hDLFdBQVcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDOUIsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztRQUVILFdBQVcsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRTtZQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDLENBQUM7UUFFSCx1REFBdUQ7UUFDdkQsTUFBTSxLQUFLLEdBQUcsSUFBSSxlQUFlLENBQUM7WUFDaEMsSUFBSSxFQUFFLFdBQVc7WUFDakIsU0FBUyxFQUFFLFNBQVM7WUFDcEIsb0JBQW9CLEVBQUUsSUFBSSxFQUFFLDZDQUE2QztZQUN6RSxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsa0NBQWtDO1lBRXhHLG1EQUFtRDtZQUNuRCxvQkFBb0IsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsZ0NBQWdDO1lBQy9HLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCO1lBRTlDLHNDQUFzQztZQUN0QyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLDJDQUEyQztZQUNsRSxZQUFZLEVBQUUsS0FBSyxFQUFFLDBDQUEwQztTQUNoRSxDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsR0FBRyxDQUFDLG9FQUFvRSxDQUFDLENBQUM7UUFFbEYsdURBQXVEO1FBQ3ZELElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDcEMsOEJBQThCO1lBQzlCLE1BQU0sYUFBYSxHQUFHLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDM0MsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDL0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztvQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUMzRCxDQUFDO3FCQUFNLENBQUM7b0JBQ04sS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUU7d0JBQzNDLElBQUksTUFBTSxFQUFFLENBQUM7NEJBQ1gsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxNQUFNLENBQUMsQ0FBQzt3QkFDN0QsQ0FBQzs2QkFBTSxDQUFDOzRCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0NBQXdDLENBQUMsQ0FBQzs0QkFDdEQsd0JBQXdCOzRCQUN4QixLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQzt3QkFDekMsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pELE9BQU8sQ0FBQyxHQUFHLENBQUMsNkRBQTZELENBQUMsQ0FBQztRQUMzRSxPQUFPLFNBQVMsQ0FBQyxDQUFDLDRDQUE0QztJQUNoRSxDQUFDO0FBQ0gsQ0FBQztBQUVELHdEQUF3RDtBQUN4RCxJQUFJLFlBQWlCLENBQUM7QUFDdEIsSUFBSSxDQUFDO0lBQ0gsZ0VBQWdFO0lBQ2hFLFlBQVksR0FBRyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3RDLENBQUM7QUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO0lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQ0FBMkMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNsRSxZQUFZLEdBQUcsU0FBUyxDQUFDLENBQUMsaUNBQWlDO0FBQzdELENBQUM7QUFFWSxRQUFBLGFBQWEsR0FBRyxJQUFBLHlCQUFPLEVBQUM7SUFDbkMsS0FBSyxFQUFFLFlBQVksRUFBRSwrQ0FBK0M7SUFDcEUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLHNDQUFzQztJQUM1RSxNQUFNLEVBQUUsS0FBSyxFQUFFLGdDQUFnQztJQUMvQyxpQkFBaUIsRUFBRSxLQUFLO0lBQ3hCLE9BQU8sRUFBRSxJQUFJLEVBQUUsK0JBQStCO0lBQzlDLE1BQU0sRUFBRTtRQUNOLE1BQU0sRUFBRSxjQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSwwQkFBMEI7UUFDOUQsUUFBUSxFQUFFLElBQUk7UUFDZCxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxtQ0FBbUM7UUFDcEUsUUFBUSxFQUFFLGNBQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSx5QkFBeUI7UUFDbEYsSUFBSSxFQUFFLEdBQUcsRUFBRSxzQkFBc0I7UUFDakMsTUFBTSxFQUFFLGNBQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLGNBQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQztZQUN0RixDQUFDLENBQUMsb0JBQW9CLENBQUMsd0NBQXdDO1lBQy9ELENBQUMsQ0FBQyxTQUFTO0tBQ2Q7SUFDRCxJQUFJLEVBQUUsV0FBVztJQUNqQixLQUFLLEVBQUUsY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsbUNBQW1DO0NBQ3ZFLENBQUMsQ0FBQztBQUVIOzs7Ozs7Ozs7Ozs7OztHQWNHO0FBQ0g7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxZQUFZLENBQUMsUUFBZ0I7SUFDakQsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDLENBQUMsNkJBQTZCO0lBQ3BELE9BQU8sTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxjQUFjLENBQUMsUUFBZ0IsRUFBRSxjQUFzQjtJQUMzRSxPQUFPLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUNIOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxXQUFXLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUMvRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQztRQUN6QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSx5QkFBeUI7WUFDbEMsSUFBSSxFQUFFLGVBQWU7U0FDdEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksQ0FBQztRQUNILDZGQUE2RjtRQUM3RixJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsTUFBTSxVQUFVLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JHLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUV2Riw4RUFBOEU7WUFDOUUsSUFBSSxVQUFVLEdBQUcsZUFBZSxHQUFHLEdBQUcsRUFBRSxDQUFDO2dCQUN2QyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RCLENBQUM7UUFDSCxDQUFDO1FBRUQsdUJBQXVCO1FBRXZCLDhEQUE4RDtRQUM5RCx3QkFBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDN0Qsd0JBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2RCwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUMxQixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLG9DQUFvQztnQkFDdEMsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLG9DQUFvQztnQkFDN0MsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELHNEQUFzRDtRQUN0RCxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRTdCLHVGQUF1RjtRQUN2RixJQUFJLGlCQUFpQixHQUFVLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUM7WUFDSCxpQkFBaUIsR0FBRyxNQUFNLE9BQUU7aUJBQ3pCLE1BQU0sQ0FBQztnQkFDTixjQUFjLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGNBQWM7Z0JBQ3ZELHlCQUF5QixFQUFFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyx5QkFBeUI7YUFDOUUsQ0FBQztpQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDO2lCQUM5QixLQUFLLENBQ0osSUFBQSxpQkFBRyxFQUNELElBQUEsZ0JBQUUsRUFBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsRUFDNUMsSUFBQSxnQkFBRSxFQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQzVDLENBQ0YsQ0FBQztRQUNOLENBQUM7UUFBQyxPQUFPLFFBQVEsRUFBRSxDQUFDO1lBQ2xCLCtDQUErQztZQUMvQyxrRUFBa0U7WUFDbEUsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLENBQUM7UUFFRCw0REFBNEQ7UUFDNUQsR0FBRyxDQUFDLElBQUksR0FBRztZQUNULEdBQUcsSUFBSTtZQUNQLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDL0QseUJBQXlCLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMseUJBQXlCLENBQUM7U0FDakYsQ0FBQztRQUVULDBGQUEwRjtRQUMxRiw4REFBOEQ7UUFDOUQsSUFDRSxJQUFJLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUM7WUFDOUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsRUFDaEUsQ0FBQztZQUNELHFEQUFxRDtZQUNyRCxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxPQUFFO3FCQUN0QixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztxQkFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7cUJBQzFCLEtBQUssQ0FBQyxJQUFBLGdCQUFFLEVBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7cUJBQzVDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFWixJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQ3hCLDJDQUEyQztvQkFDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQzFDLEdBQUcsQ0FBQyxJQUFJLENBQUMseUJBQXlCLEdBQUcsS0FBSyxDQUFDO2dCQUM3QyxDQUFDO1lBQ0gsQ0FBQztZQUFDLE9BQU8sWUFBWSxFQUFFLENBQUM7Z0JBQ3RCLDJEQUEyRDtZQUM3RCxDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksRUFBRSxDQUFDO0lBQ1QsQ0FBQztJQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7UUFDcEIsK0JBQStCO1FBQy9CLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsc0JBQXNCO1lBQy9CLElBQUksRUFBRSxZQUFZO1NBQ25CLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSDs7OztHQUlHO0FBQ0gsU0FBZ0IsV0FBVyxDQUFDLFlBQXNCO0lBQ2hELE9BQU8sS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1FBQy9ELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMxQixPQUFPLEVBQUUseUJBQXlCO2dCQUNsQyxJQUFJLEVBQUUsZUFBZTthQUN0QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzFDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSwwQkFBMEI7Z0JBQ25DLElBQUksRUFBRSwwQkFBMEI7Z0JBQ2hDLFFBQVEsRUFBRSxZQUFZO2dCQUN0QixPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJO2FBQ3ZCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLEVBQUUsQ0FBQztJQUNULENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBQ0g7Ozs7R0FJRztBQUNILFNBQWdCLFNBQVMsQ0FBQyxVQUFrQjtJQUMxQyxPQUFPLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCLEVBQUUsRUFBRTtRQUMvRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtnQkFDbEMsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILG9FQUFvRTtZQUNwRSxNQUFNLGFBQWEsR0FBRyxNQUFNLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBRWxGLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDbkIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDBCQUEwQjtvQkFDbkMsSUFBSSxFQUFFLG1CQUFtQjtvQkFDekIsUUFBUSxFQUFFLFVBQVU7b0JBQ3BCLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUk7b0JBQ3ZCLE9BQU8sRUFBRSxtQkFBbUIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLCtCQUErQixVQUFVLEdBQUc7aUJBQ3RGLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFJLEVBQUUsQ0FBQztRQUNULENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLDhCQUE4QjtZQUM5QixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSw0QkFBNEI7Z0JBQ3JDLElBQUksRUFBRSxxQkFBcUI7YUFDNUIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUNIOzs7O0dBSUc7QUFDSCxTQUFnQixlQUFlLENBQUMsR0FBUTtJQUN0QyxjQUFjO0lBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQ2hFLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNyQywwQkFBMEI7WUFFMUIsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUN4QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsaUNBQWlDO29CQUMxQyxJQUFJLEVBQUUscUJBQXFCO2lCQUM1QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsMkJBQTJCO1lBQzNCLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNWLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxxQkFBcUI7b0JBQzlCLElBQUksRUFBRSxxQkFBcUI7aUJBQzVCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNuQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUJBQXFCO29CQUM5QixJQUFJLEVBQUUsa0JBQWtCO2lCQUN6QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsdUNBQXVDO1lBQ3ZDLDhCQUE4QjtZQUM5QixrQ0FBa0M7WUFDbEMsTUFBTSxlQUFlLEdBQUcsTUFBTSxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0RSxrQ0FBa0M7WUFFbEMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNyQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUJBQXFCO29CQUM5QixJQUFJLEVBQUUscUJBQXFCO2lCQUM1QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsb0JBQW9CO1lBQ3BCLE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUUvRCw2QkFBNkI7WUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2pDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsd0RBQXdEO1lBRWpGLG1EQUFtRDtZQUNuRCxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUN2QixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQzVDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxxQkFBcUI7d0JBQzlCLElBQUksRUFBRSxvQkFBb0I7cUJBQzNCLENBQUMsQ0FBQztnQkFDTCxDQUFDO2dCQUdELHNDQUFzQztnQkFDdEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7Z0JBQzFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7b0JBQ1AsSUFBSSxFQUFFLFFBQVE7b0JBQ2QsT0FBTyxFQUFFLGtCQUFrQjtpQkFDNUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxNQUFXLEVBQUUsQ0FBQztZQUNyQixPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtnQkFDNUIsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSztnQkFDdEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVE7Z0JBQ2pDLFdBQVcsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO2dCQUN2QyxhQUFhLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYzthQUM1QyxDQUFDLENBQUM7WUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLGNBQWM7Z0JBQ3ZCLElBQUksRUFBRSxhQUFhO2dCQUNuQixHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDO2FBQ25FLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILGVBQWU7SUFDZixHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQzNELEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDMUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDcEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLGVBQWU7b0JBQ3hCLElBQUksRUFBRSxjQUFjO2lCQUNyQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsNkRBQTZEO1lBQzdELE1BQU0sYUFBYSxHQUFRO2dCQUN6QixRQUFRLEVBQUUsSUFBSTtnQkFDZCxNQUFNLEVBQUUsY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZO2dCQUNsQyxRQUFRLEVBQUUsY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSztnQkFDdkQsSUFBSSxFQUFFLEdBQUc7YUFDVixDQUFDO1lBRUYsMENBQTBDO1lBQzFDLElBQUksY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksY0FBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQztnQkFDckYsYUFBYSxDQUFDLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQztZQUM5QyxDQUFDO1lBRUQsR0FBRyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFFNUMsK0NBQStDO1lBQy9DLEdBQUcsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFO2dCQUMzQixRQUFRLEVBQUUsSUFBSTtnQkFDZCxNQUFNLEVBQUUsY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZO2dCQUNsQyxRQUFRLEVBQUUsY0FBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSztnQkFDdkQsSUFBSSxFQUFFLEdBQUc7YUFDVixDQUFDLENBQUM7WUFFSCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUM3QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgseUJBQXlCO0lBQ3pCLEdBQUcsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUM5RCxJQUFJLENBQUM7WUFDSCxxQkFBcUI7WUFFckIsZ0RBQWdEO1lBQ2hELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDO2dCQUN6QixtQkFBbUI7Z0JBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztnQkFDeEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLG1CQUFtQjtvQkFDNUIsSUFBSSxFQUFFLG1CQUFtQjtpQkFDMUIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELGdDQUFnQztZQUNoQyxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxpQkFBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN2RCx3QkFBd0I7Z0JBRXhCLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQzVCLGlEQUFpRDtvQkFDakQsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTt3QkFDMUIsSUFBSSxHQUFHLEVBQUUsQ0FBQzs0QkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixFQUFFLEdBQUcsQ0FBQyxDQUFDO3dCQUNuRCxDQUFDO29CQUNILENBQUMsQ0FBQyxDQUFDO29CQUNILE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQzFCLE9BQU8sRUFBRSxvQ0FBb0M7d0JBQzdDLElBQUksRUFBRSxlQUFlO3FCQUN0QixDQUFDLENBQUM7Z0JBQ0wsQ0FBQztnQkFFRCw4Q0FBOEM7Z0JBQzlDLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUMzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7b0JBQ3ZCLE1BQU0sVUFBVSxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDckcsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO29CQUV2Riw0REFBNEQ7b0JBQzVELElBQUksVUFBVSxHQUFHLGVBQWUsR0FBRyxHQUFHLEVBQUUsQ0FBQzt3QkFDdkMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDdEIsQ0FBQztnQkFDSCxDQUFDO2dCQUVELG9DQUFvQztnQkFDcEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7Z0JBQzFDLGtDQUFrQztnQkFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVyQixDQUFDO1lBQUMsT0FBTyxTQUFTLEVBQUUsQ0FBQztnQkFDbkIsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDekQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDZCQUE2QjtvQkFDdEMsSUFBSSxFQUFFLGtCQUFrQjtpQkFDekIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMscUJBQXFCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDNUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSw2QkFBNkI7Z0JBQ3RDLElBQUksRUFBRSxrQkFBa0I7YUFDekIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsMEVBQTBFO0lBQzFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUMvRCxNQUFNLFNBQVMsR0FBRztZQUNoQixVQUFVLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPO1lBQ3pCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUztZQUN4QixNQUFNLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxNQUFNO1lBQzNCLFFBQVEsRUFBRSxHQUFHLENBQUMsT0FBTyxFQUFFLFFBQVE7WUFDL0IsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUTtZQUM3QixjQUFjLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtZQUMxQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1lBQzlDLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ25ELFlBQVksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDaEMsWUFBWSxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxJQUFJLElBQUksU0FBUztZQUNoRSxTQUFTLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7WUFDcEMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSTtZQUN0QixRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7WUFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLFVBQVUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDO1NBQ3pDLENBQUM7UUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzNDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFFSCwrQkFBK0I7SUFDL0IsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUNoRSwyQkFBMkI7UUFDM0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU3QyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3ZCLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ1IsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSx3QkFBd0IsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDekYsQ0FBQztZQUVELEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLGlCQUFpQjtnQkFDMUIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTO2dCQUN4QixTQUFTLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTO2dCQUNoQyxjQUFjLEVBQUU7b0JBQ2QsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFlBQVk7b0JBQzdDLFFBQVEsRUFBRSxJQUFJO29CQUNkLFFBQVEsRUFBRSxLQUFLO2lCQUNoQjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxzQ0FBc0M7SUFDdEMsR0FBRyxDQUFDLElBQUksQ0FDTixvQkFBb0IsRUFDcEIsV0FBVyxFQUNYLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQ3RCLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDcEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxJQUFJLEdBQUcsUUFBUSxFQUFFLFFBQVEsR0FBRyxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBRTVGLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDbkQsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHlCQUF5QjtvQkFDbEMsSUFBSSxFQUFFLGdCQUFnQjtpQkFDdkIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELCtCQUErQjtZQUMvQixNQUFNLFlBQVksR0FBRyxNQUFNLGlCQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZFLElBQUksWUFBWSxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxxQkFBcUI7b0JBQzlCLElBQUksRUFBRSxhQUFhO2lCQUNwQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsMENBQTBDO1lBQzFDLE1BQU0sY0FBYyxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXBELE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUM7Z0JBQ3ZDLEtBQUssRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFO2dCQUMxQixRQUFRLEVBQUUsY0FBYztnQkFDeEIsU0FBUztnQkFDVCxRQUFRO2dCQUNSLFFBQVEsRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsd0JBQXdCO2dCQUN2RCxJQUFJO2dCQUNKLFFBQVE7YUFDVCxDQUFDLENBQUM7WUFFSCxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxHQUFHLFFBQVEsRUFBRSxHQUFHLE9BQU8sQ0FBQztZQUM3QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsT0FBTyxFQUFFLDJCQUEyQjthQUNyQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzlDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUscUJBQXFCO2dCQUM5QixJQUFJLEVBQUUsb0JBQW9CO2FBQzNCLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQ0YsQ0FBQztJQUVGLCtCQUErQjtJQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLDJCQUEyQixFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDMUUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFM0IsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNYLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxtQkFBbUI7b0JBQzVCLElBQUksRUFBRSxlQUFlO2lCQUN0QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxpQkFBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUM1QiwwRUFBMEU7Z0JBQzFFLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztvQkFDZCxPQUFPLEVBQUUsNERBQTREO29CQUNyRSxPQUFPLEVBQUUsSUFBSTtpQkFDZCxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsK0JBQStCO1lBQy9CLE1BQU0sVUFBVSxHQUFHLElBQUEsb0JBQVcsRUFBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkQsTUFBTSxTQUFTLEdBQUcsSUFBQSxtQkFBVSxFQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFeEUsa0RBQWtEO1lBQ2xELE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7WUFDN0IsU0FBUyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFN0MsTUFBTSxpQkFBTyxDQUFDLHdCQUF3QixDQUFDO2dCQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ2YsS0FBSyxFQUFFLFVBQVU7Z0JBQ2pCLFNBQVMsRUFBRSxTQUFTO2dCQUNwQixTQUFTLEVBQUUsU0FBUztnQkFDcEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxDQUFDLFVBQVUsRUFBRSxhQUFhLElBQUksU0FBUztnQkFDL0QsU0FBUyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUzthQUMzQyxDQUFDLENBQUM7WUFFViw0QkFBNEI7WUFDNUIsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFbkMsd0VBQXdFO1lBQ3hFLElBQUksV0FBVyxDQUFDO1lBQ2hCLElBQ0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDO2dCQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztnQkFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxFQUN0QyxDQUFDO2dCQUNELHdDQUF3QztnQkFDeEMsV0FBVyxHQUFHLEdBQUcsR0FBRyxDQUFDLFFBQVEsTUFBTSxJQUFJLEVBQUUsQ0FBQztZQUM1QyxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sbUVBQW1FO2dCQUNuRSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDO29CQUN2QyxXQUFXLEdBQUcsV0FBVyxJQUFJLEVBQUUsQ0FBQztnQkFDbEMsQ0FBQztxQkFBTSxDQUFDO29CQUNOLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSwyQkFBMkIsQ0FBQztnQkFDeEUsQ0FBQztZQUNILENBQUM7WUFFRCxNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7WUFDcEYsTUFBTSxRQUFRLEdBQUcsR0FBRyxRQUFRLHlCQUF5QixVQUFVLEVBQUUsQ0FBQztZQUdsRSxNQUFNLFNBQVMsR0FBRyxNQUFNLFlBQVksQ0FBQyxzQkFBc0IsQ0FDekQsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUNuQixHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUNwQyxRQUFRLENBQ1QsQ0FBQztZQUVGLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNoRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUscUNBQXFDO29CQUM5QyxJQUFJLEVBQUUsbUJBQW1CO2lCQUMxQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsNERBQTREO2dCQUNyRSxPQUFPLEVBQUUsSUFBSTthQUNkLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDeEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSwrQkFBK0I7Z0JBQ3hDLElBQUksRUFBRSw4QkFBOEI7YUFDckMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsdUJBQXVCO0lBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUN6RSxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFckMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUN4QixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsaUNBQWlDO29CQUMxQyxJQUFJLEVBQUUsZ0JBQWdCO2lCQUN2QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsNkJBQTZCO1lBQzdCLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLDZDQUE2QztvQkFDdEQsSUFBSSxFQUFFLG9CQUFvQjtpQkFDM0IsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELHlDQUF5QztZQUN6QyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDNUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV2QyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ2xELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFDTCwyRkFBMkY7b0JBQzdGLElBQUksRUFBRSxtQkFBbUI7aUJBQzFCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxnQ0FBZ0M7WUFDaEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxpQkFBTyxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDaEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLHlDQUF5QztvQkFDbEQsSUFBSSxFQUFFLGVBQWU7aUJBQ3RCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCw0QkFBNEI7WUFDNUIsSUFBSSxJQUFJLElBQUksRUFBRSxHQUFHLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDdEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDMUIsT0FBTyxFQUFFLGtDQUFrQztvQkFDM0MsSUFBSSxFQUFFLGVBQWU7aUJBQ3RCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCx1Q0FBdUM7WUFDdkMsSUFBSSxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3RCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSw0Q0FBNEM7b0JBQ3JELElBQUksRUFBRSxvQkFBb0I7aUJBQzNCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCw0Q0FBNEM7WUFDNUMsTUFBTSxTQUFTLEdBQUcsSUFBQSxtQkFBVSxFQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkUsSUFBSSxTQUFTLEtBQUssVUFBVSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN2QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUsOEJBQThCO29CQUN2QyxJQUFJLEVBQUUsb0JBQW9CO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsZUFBZTtZQUNmLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzVCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxvQ0FBb0M7b0JBQzdDLElBQUksRUFBRSxnQkFBZ0I7aUJBQ3ZCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxrREFBa0Q7WUFDbEQsTUFBTSxjQUFjLEdBQUcsTUFBTSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFcEQsTUFBTSxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNoQyxRQUFRLEVBQUUsY0FBYztnQkFDeEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3RCLENBQUMsQ0FBQztZQUVILHFCQUFxQjtZQUNyQixNQUFNLGlCQUFPLENBQUMsNEJBQTRCLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRTFELDBCQUEwQjtZQUMxQixNQUFNLGlCQUFPLENBQUMsaUNBQWlDLEVBQUUsQ0FBQztZQUVsRCxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLE9BQU8sRUFBRSxzQ0FBc0M7Z0JBQy9DLE9BQU8sRUFBRSxJQUFJO2FBQ2QsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLHVCQUF1QjtnQkFDaEMsSUFBSSxFQUFFLHNCQUFzQjthQUM3QixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQ7OztHQUdHO0FBRUg7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLGVBQWUsQ0FDbkMsSUFBdUIsRUFDdkIsUUFBYSxFQUNiLGNBQXNCO0lBRXRCLElBQUksQ0FBQztRQUNILGdDQUFnQztRQUNoQyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDMUIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsd0RBQXdEO1FBQ3hELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM1QixzREFBc0Q7WUFDdEQsSUFBSSxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNoRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUMxRCxDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3pCLE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNqRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztnQkFDMUQsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQyxDQUFDLDJDQUEyQztRQUMxRCxDQUFDO1FBRUQsMkRBQTJEO1FBQzNELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUM3QixJQUFJLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDekIsT0FBTyxjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFdBQVcsS0FBSyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDO1lBQ3RGLENBQUM7WUFDRCxJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDeEIsdURBQXVEO2dCQUN2RCxNQUFNLGVBQWUsR0FBRyxjQUFjLEVBQUUsR0FBRyxDQUFDLEtBQUssRUFBQyxFQUFFLEVBQUMsRUFBRTtvQkFDckQsTUFBTSxTQUFTLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQzdELE9BQU8sU0FBUyxFQUFFLFVBQVUsQ0FBQztnQkFDL0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDN0QsT0FBTyxXQUFXLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNuRCxDQUFDO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsK0RBQStEO1FBQy9ELElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQztZQUVELElBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN6QixPQUFPLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsV0FBVyxLQUFLLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLENBQUM7WUFDdEYsQ0FBQztZQUNELElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLGVBQWUsR0FBRyxjQUFjLEVBQUUsR0FBRyxDQUFDLEtBQUssRUFBQyxFQUFFLEVBQUMsRUFBRTtvQkFDckQsTUFBTSxTQUFTLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQzdELE9BQU8sU0FBUyxFQUFFLFVBQVUsQ0FBQztnQkFDL0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDN0QsT0FBTyxXQUFXLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNuRCxDQUFDO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0NBQXdDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDL0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQ25DLElBQXVCLEVBQ3ZCLFFBQWEsRUFDYixjQUFzQjtJQUV0QixJQUFJLENBQUM7UUFDSCxnQ0FBZ0M7UUFDaEMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQzFCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELHdEQUF3RDtRQUN4RCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDNUIsSUFBSSxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNoRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUMxRCxDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3pCLE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNqRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztnQkFDMUQsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxrRUFBa0U7UUFDbEUsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQzdCLHlCQUF5QjtZQUN6QixJQUFJLFFBQVEsQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUNwQyxPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3pCLE9BQU8sY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEtBQUssUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssQ0FBQztZQUN0RixDQUFDO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsbURBQW1EO1FBQ25ELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9ELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsaUJBQWlCLENBQ3JDLElBQXVCLEVBQ3ZCLFFBQWEsRUFDYixjQUFzQjtJQUV0QixJQUFJLENBQUM7UUFDSCxrQ0FBa0M7UUFDbEMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQzFCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELHNEQUFzRDtRQUN0RCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDNUIsSUFBSSxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNoRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUMxRCxDQUFDO1lBQ0QsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3pCLE1BQU0sU0FBUyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUNqRSxPQUFPLFFBQVEsRUFBRSxjQUFjLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQztnQkFDMUQsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxvREFBb0Q7UUFDcEQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQzdCLE9BQU8sUUFBUSxDQUFDLFVBQVUsS0FBSyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3pDLENBQUM7UUFFRCxrQ0FBa0M7UUFDbEMsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsMENBQTBDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakUsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0ksS0FBSyxVQUFVLGlCQUFpQixDQUNyQyxJQUF1QixFQUN2QixPQUErRTtJQUUvRSxJQUFJLENBQUM7UUFDSCx1Q0FBdUM7UUFDdkMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQzFCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELHNEQUFzRDtRQUN0RCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDNUIsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQzNCLE9BQU8sT0FBTyxDQUFDLGNBQWMsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQ3hELENBQUM7WUFDRCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDdkIsTUFBTSxRQUFRLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQy9ELE9BQU8sUUFBUSxFQUFFLGNBQWMsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQzFELENBQUM7WUFDRCxJQUFJLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDeEIsTUFBTSxTQUFTLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ2xFLElBQUksU0FBUyxFQUFFLENBQUM7b0JBQ2QsTUFBTSxRQUFRLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ2pFLE9BQU8sUUFBUSxFQUFFLGNBQWMsS0FBSyxJQUFJLENBQUMsY0FBYyxDQUFDO2dCQUMxRCxDQUFDO1lBQ0gsQ0FBQztZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELG9EQUFvRDtRQUNwRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFLENBQUM7WUFDN0IsSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3hCLHdDQUF3QztnQkFDeEMsTUFBTSxjQUFjLEdBQUcsTUFBTSxpQkFBTyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFdBQVcsS0FBSyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDM0UsQ0FBQztZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELGtDQUFrQztRQUNsQyxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywwQ0FBMEMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqRSxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2F1dGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHNlc3Npb24gZnJvbSAnZXhwcmVzcy1zZXNzaW9uJztcbmltcG9ydCBjb25uZWN0UGcgZnJvbSAnY29ubmVjdC1wZy1zaW1wbGUnO1xuaW1wb3J0IHsgY3JlYXRlSGFzaCwgcmFuZG9tQnl0ZXMgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0ICogYXMgYmNyeXB0IGZyb20gJ2JjcnlwdGpzJztcbmltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tICcuL3N0b3JhZ2UnO1xuaW1wb3J0IHsgc3FsLCBkYiwgcG9vbCB9IGZyb20gJy4vZGInO1xuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi9jb25maWcvaW5kZXgnO1xuaW1wb3J0IHR5cGUgeyBVc2VyIH0gZnJvbSAnQHNoYXJlZC9zY2hlbWEnO1xuLy8gRGF0YWJhc2UtYmFzZWQgcGVybWlzc2lvbiBjaGVja2luZyAtIG5vIGNvbmZpZyBmaWxlcyBuZWVkZWRcbmltcG9ydCB7IFBvb2wgfSBmcm9tICdAbmVvbmRhdGFiYXNlL3NlcnZlcmxlc3MnO1xuaW1wb3J0IHsgZHJpenpsZSB9IGZyb20gJ2RyaXp6bGUtb3JtL25lb24tc2VydmVybGVzcyc7XG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnLi4vc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyBlcSwgYW5kIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xuaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9lbWFpbC1zZXJ2aWNlJztcbmltcG9ydCB7IHF1ZXJ5Q2FjaGUgfSBmcm9tICcuL3F1ZXJ5LWNhY2hlJztcblxuLyoqXG4gKiBDaGVjayBpZiBhIHVzZXIgcm9sZSBoYXMgYSBzcGVjaWZpYyBwZXJtaXNzaW9uIHZpYSBkYXRhYmFzZSBsb29rdXAuXG4gKiBAcGFyYW0gdXNlclJvbGUgLSBUaGUgdXNlcidzIHJvbGUgKGFkbWluLCBtYW5hZ2VyLCB0ZW5hbnQsIHJlc2lkZW50KS5cbiAqIEBwYXJhbSBwZXJtaXNzaW9uTmFtZSAtIFRoZSBwZXJtaXNzaW9uIG5hbWUgKGUuZy4sICdyZWFkOnVzZXInLCAnY3JlYXRlOmJ1aWxkaW5nJykuXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uLlxuICovXG5hc3luYyBmdW5jdGlvbiBjaGVja1VzZXJQZXJtaXNzaW9uKHVzZXJSb2xlOiBzdHJpbmcsIHBlcm1pc3Npb25OYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICAvLyBEZWJ1ZyBsb2dnaW5nIHJlbW92ZWQgZm9yIHByb2R1Y3Rpb24gc2VjdXJpdHlcblxuICAgIC8vIEZpcnN0IGNoZWNrIGlmIHBlcm1pc3Npb24gZXhpc3RzIGF0IGFsbFxuICAgIGNvbnN0IHBlcm1pc3Npb25FeGlzdHMgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShzY2hlbWEucGVybWlzc2lvbnMpXG4gICAgICAud2hlcmUoZXEoc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUsIHBlcm1pc3Npb25OYW1lKSlcbiAgICAgIC5saW1pdCgxKTtcblxuICAgIC8vIFBlcm1pc3Npb24gZXhpc3RzIGNoZWNrIGNvbXBsZXRlXG5cbiAgICAvLyBDaGVjayByb2xlIHBlcm1pc3Npb25zXG4gICAgY29uc3Qgcm9sZVBlcm1pc3Npb25zID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oc2NoZW1hLnJvbGVQZXJtaXNzaW9ucylcbiAgICAgIC53aGVyZShlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsIHVzZXJSb2xlIGFzIGFueSkpO1xuXG4gICAgLy8gUm9sZSBwZXJtaXNzaW9ucyBjaGVja2VkXG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShzY2hlbWEucm9sZVBlcm1pc3Npb25zKVxuICAgICAgLmxlZnRKb2luKHNjaGVtYS5wZXJtaXNzaW9ucywgZXEoc2NoZW1hLnJvbGVQZXJtaXNzaW9ucy5wZXJtaXNzaW9uSWQsIHNjaGVtYS5wZXJtaXNzaW9ucy5pZCkpXG4gICAgICAud2hlcmUoXG4gICAgICAgIGFuZChcbiAgICAgICAgICBlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsIHVzZXJSb2xlIGFzIGFueSksXG4gICAgICAgICAgZXEoc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUsIHBlcm1pc3Npb25OYW1lKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAubGltaXQoMSk7XG5cbiAgICAvLyBQZXJtaXNzaW9uIGNoZWNrIGNvbXBsZXRlZFxuXG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIFBlcm1pc3Npb24gbm90IGZvdW5kXG4gICAgICAvLyBEZWJ1ZzogbGlzdCBhbGwgYWRtaW4gcGVybWlzc2lvbnNcbiAgICAgIGlmICh1c2VyUm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgICBjb25zdCBhZG1pblBlcm1zID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgbmFtZTogc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUgfSlcbiAgICAgICAgICAuZnJvbShzY2hlbWEucm9sZVBlcm1pc3Npb25zKVxuICAgICAgICAgIC5sZWZ0Sm9pbihcbiAgICAgICAgICAgIHNjaGVtYS5wZXJtaXNzaW9ucyxcbiAgICAgICAgICAgIGVxKHNjaGVtYS5yb2xlUGVybWlzc2lvbnMucGVybWlzc2lvbklkLCBzY2hlbWEucGVybWlzc2lvbnMuaWQpXG4gICAgICAgICAgKVxuICAgICAgICAgIC53aGVyZShlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsICdhZG1pbicpKTtcbiAgICAgICAgLy8gQWRtaW4gcGVybWlzc2lvbnMgZGVidWcgcmVtb3ZlZCBmb3Igc2VjdXJpdHlcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDA7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgUGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vLyBJbml0aWFsaXplIGVtYWlsIHNlcnZpY2VcbmNvbnN0IGVtYWlsU2VydmljZSA9IG5ldyBFbWFpbFNlcnZpY2UoKTtcblxuLy8gRGF0YWJhc2UgY29ubmVjdGlvbiBhbHJlYWR5IGltcG9ydGVkIGF0IHRvcCBvZiBmaWxlXG5cbi8vIENvbmZpZ3VyZSBzZXNzaW9uIHN0b3JlIHdpdGggUG9zdGdyZVNRTFxuY29uc3QgUG9zdGdyZVNxbFN0b3JlID0gY29ubmVjdFBnKHNlc3Npb24pO1xuXG4vKipcbiAqIEdldCB0aGUgY29ycmVjdCBkYXRhYmFzZSBVUkwgYmFzZWQgb24gZW52aXJvbm1lbnQgYW5kIHJlcXVlc3QgZG9tYWluLlxuICogVXNlcyBjZW50cmFsaXplZCBjb25maWd1cmF0aW9uIHRvIGRldGVybWluZSB0aGUgYXBwcm9wcmlhdGUgZGF0YWJhc2UuXG4gKi9cbmZ1bmN0aW9uIGdldERhdGFiYXNlVXJsKHJlcXVlc3REb21haW4/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAvLyBDUklUSUNBTDoga292ZW8tZ2VzdGlvbi5jb20gTVVTVCB1c2UgREFUQUJBU0VfVVJMX0tPVkVPIGV4Y2x1c2l2ZWx5XG4gIGNvbnN0IGZpbmFsVXJsID0gY29uZmlnLmRhdGFiYXNlLmdldFJ1bnRpbWVEYXRhYmFzZVVybChyZXF1ZXN0RG9tYWluKTtcbiAgY29uc3QgaXNLb3Zlb1JlcXVlc3QgPSByZXF1ZXN0RG9tYWluPy5pbmNsdWRlcygna292ZW8tZ2VzdGlvbi5jb20nKTtcbiAgY29uc3QgaXNQcm9kdWN0aW9uID0gY29uZmlnLnNlcnZlci5pc1Byb2R1Y3Rpb24gfHwgaXNLb3Zlb1JlcXVlc3Q7XG4gIFxuICBjb25zb2xlLmxvZyhg8J+UlyBTZXNzaW9uIHN0b3JlIHVzaW5nICR7aXNQcm9kdWN0aW9uID8gJ1BST0RVQ1RJT04gKERBVEFCQVNFX1VSTF9LT1ZFTyknIDogJ0RFVkVMT1BNRU5UIChEQVRBQkFTRV9VUkwpJ30gZGF0YWJhc2U6ICR7ZmluYWxVcmw/LnN1YnN0cmluZygwLCA1MCl9Li4uIChkb21haW46ICR7cmVxdWVzdERvbWFpbiB8fCAndW5rbm93bid9KWApO1xuICBcbiAgaWYgKCFmaW5hbFVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YWJhc2UgVVJMIGF2YWlsYWJsZSBmb3Igc2Vzc2lvbiBzdG9yZScpO1xuICB9XG4gIFxuICByZXR1cm4gZmluYWxVcmw7XG59XG5cbi8qKlxuICogU2Vzc2lvbiBjb25maWd1cmF0aW9uIGZvciBRdWViZWMtY29tcGxpYW50IHVzZXIgYXV0aGVudGljYXRpb24uXG4gKiBVc2VzIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3Igc2NhbGFiaWxpdHkgYW5kIExhdyAyNSBjb21wbGlhbmNlLlxuICogSW5jbHVkZXMgZmFsbGJhY2sgZm9yIGRhdGFiYXNlIGNvbm5lY3Rpb24gaXNzdWVzIGluIHByb2R1Y3Rpb24uXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVNlc3Npb25TdG9yZShyZXF1ZXN0RG9tYWluPzogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgLy8gQ3JlYXRlIGEgcHJvcGVyIFBvc3RncmVTUUwgcG9vbCBmb3IgdGhlIHNlc3Npb24gc3RvcmVcbiAgICAvLyBjb25uZWN0LXBnLXNpbXBsZSBuZWVkcyBhIHJlYWwgUG9zdGdyZVNRTCBwb29sLCBub3QgdGhlIE5lb24gSFRUUCBjbGllbnRcbiAgICBjb25zdCBzZXNzaW9uUG9vbCA9IG5ldyBQb29sKHsgXG4gICAgICBjb25uZWN0aW9uU3RyaW5nOiBnZXREYXRhYmFzZVVybChyZXF1ZXN0RG9tYWluKSxcbiAgICAgIG1heDogNSwgLy8gSW5jcmVhc2VkIHBvb2wgc2l6ZSBmb3IgYmV0dGVyIHByb2R1Y3Rpb24gcGVyZm9ybWFuY2VcbiAgICAgIG1pbjogMSxcbiAgICAgIG1heFVzZXM6IDEwMDAwLCAvLyBJbmNyZWFzZWQgcmV1c2UgbGltaXRcbiAgICAgIGlkbGVUaW1lb3V0TWlsbGlzOiA2MDAwMCwgLy8gSW5jcmVhc2VkIHRvIDYwIHNlY29uZHMgZm9yIHByb2R1Y3Rpb24gc3RhYmlsaXR5XG4gICAgICBhbGxvd0V4aXRPbklkbGU6IGZhbHNlLCAvLyBLZWVwIGNvbm5lY3Rpb25zIGFsaXZlIGluIHByb2R1Y3Rpb25cbiAgICAgIGNvbm5lY3Rpb25UaW1lb3V0TWlsbGlzOiAzMDAwMCwgLy8gMzAgc2Vjb25kIGNvbm5lY3Rpb24gdGltZW91dFxuICAgIH0pO1xuICAgIFxuICAgIC8vIEFkZCBjb25uZWN0aW9uIGVycm9yIGhhbmRsaW5nXG4gICAgc2Vzc2lvblBvb2wub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gcG9vbCBlcnJvcjonLCBlcnIpO1xuICAgIH0pO1xuICAgIFxuICAgIHNlc3Npb25Qb29sLm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ+KchSBTZXNzaW9uIHBvb2wgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCcpO1xuICAgIH0pO1xuICAgIFxuICAgIC8vIFVzZSBQb3N0Z3JlU1FMIHNlc3Npb24gc3RvcmUgZm9yIHBlcnNpc3RlbnQgc2Vzc2lvbnNcbiAgICBjb25zdCBzdG9yZSA9IG5ldyBQb3N0Z3JlU3FsU3RvcmUoe1xuICAgICAgcG9vbDogc2Vzc2lvblBvb2wsXG4gICAgICB0YWJsZU5hbWU6ICdzZXNzaW9uJyxcbiAgICAgIGNyZWF0ZVRhYmxlSWZNaXNzaW5nOiB0cnVlLCAvLyBBdXRvLWNyZWF0ZSB0YWJsZSBpbiBwcm9kdWN0aW9uIGlmIG1pc3NpbmdcbiAgICAgIGVycm9yTG9nOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnID8gKCkgPT4ge30gOiBjb25zb2xlLmVycm9yLCAvLyBTdXBwcmVzcyBlcnJvciBsb2dnaW5nIGluIHRlc3RzXG4gICAgICBcbiAgICAgIC8vIEFkZCBleHBsaWNpdCBjb25maWd1cmF0aW9uIGZvciBzZXNzaW9uIHJldHJpZXZhbFxuICAgICAgcHJ1bmVTZXNzaW9uSW50ZXJ2YWw6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgPyBmYWxzZSA6IDUgKiA2MCAqIDEwMDAsIC8vIEV2ZXJ5IDUgbWludXRlcyBpbiBwcm9kdWN0aW9uXG4gICAgICBzY2hlbWFOYW1lOiAncHVibGljJywgLy8gRXhwbGljaXRseSBzZXQgc2NoZW1hXG4gICAgICBcbiAgICAgIC8vIEFkZGl0aW9uYWwgcHJvZHVjdGlvbiBvcHRpbWl6YXRpb25zXG4gICAgICB0dGw6IDcgKiAyNCAqIDYwICogNjAsIC8vIDcgZGF5cyBpbiBzZWNvbmRzIHRvIG1hdGNoIGNvb2tpZSBtYXhBZ2VcbiAgICAgIGRpc2FibGVUb3VjaDogZmFsc2UsIC8vIEVuYWJsZSB0b3VjaCB0byBleHRlbmQgc2Vzc2lvbiBsaWZldGltZVxuICAgIH0pO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCfinIUgU2Vzc2lvbiBzdG9yZTogUG9zdGdyZVNRTCBzZXNzaW9uIHN0b3JlIGNyZWF0ZWQgd2l0aCBwcm9wZXIgcG9vbCcpO1xuICAgIFxuICAgIC8vIFRlc3QgdGhlIHN0b3JlIGNvbm5lY3Rpb24gKHNraXAgaW4gdGVzdCBlbnZpcm9ubWVudClcbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICAgICAgLy8gTW9yZSByb2J1c3QgY29ubmVjdGlvbiB0ZXN0XG4gICAgICBjb25zdCB0ZXN0U2Vzc2lvbklkID0gYHRlc3QtJHtEYXRlLm5vdygpfWA7XG4gICAgICBzdG9yZS5zZXQodGVzdFNlc3Npb25JZCwgeyB0ZXN0OiB0cnVlIH0sIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBTZXNzaW9uIHN0b3JlIHdyaXRlIHRlc3QgZmFpbGVkOicsIGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RvcmUuZ2V0KHRlc3RTZXNzaW9uSWQsIChnZXRFcnIsIHNlc3Npb24pID0+IHtcbiAgICAgICAgICAgIGlmIChnZXRFcnIpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc3RvcmUgcmVhZCB0ZXN0IGZhaWxlZDonLCBnZXRFcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+KchSBTZXNzaW9uIHN0b3JlIHJlYWQvd3JpdGUgdGVzdCBwYXNzZWQnKTtcbiAgICAgICAgICAgICAgLy8gQ2xlYW4gdXAgdGVzdCBzZXNzaW9uXG4gICAgICAgICAgICAgIHN0b3JlLmRlc3Ryb3kodGVzdFNlc3Npb25JZCwgKCkgPT4ge30pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHN0b3JlO1xuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc3RvcmUgY3JlYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICBjb25zb2xlLmxvZygn4pqg77iPIEZhbGxpbmcgYmFjayB0byBtZW1vcnkgc3RvcmUgKHNlc3Npb25zIHdpbGwgbm90IHBlcnNpc3QpJyk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDsgLy8gV2lsbCB1c2UgZGVmYXVsdCBtZW1vcnkgc3RvcmUgYXMgZmFsbGJhY2tcbiAgfVxufVxuXG4vLyBDcmVhdGUgc2Vzc2lvbiBzdG9yZSB3aXRoIGJldHRlciBkYXRhYmFzZSBkZXRlY3Rpb24gIFxubGV0IHNlc3Npb25TdG9yZTogYW55O1xudHJ5IHtcbiAgLy8gVHJ5IHRvIGNyZWF0ZSBzZXNzaW9uIHN0b3JlIHdpdGggYXV0b21hdGljIGRhdGFiYXNlIGRldGVjdGlvblxuICBzZXNzaW9uU3RvcmUgPSBjcmVhdGVTZXNzaW9uU3RvcmUoKTtcbn0gY2F0Y2ggKGVycm9yKSB7XG4gIGNvbnNvbGUuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gY3JlYXRlIGluaXRpYWwgc2Vzc2lvbiBzdG9yZTonLCBlcnJvcik7XG4gIHNlc3Npb25TdG9yZSA9IHVuZGVmaW5lZDsgLy8gV2lsbCBmYWxsIGJhY2sgdG8gbWVtb3J5IHN0b3JlXG59XG5cbmV4cG9ydCBjb25zdCBzZXNzaW9uQ29uZmlnID0gc2Vzc2lvbih7XG4gIHN0b3JlOiBzZXNzaW9uU3RvcmUsIC8vIFVzZSBQb3N0Z3JlU1FMIHNlc3Npb24gc3RvcmUgZm9yIHBlcnNpc3RlbmNlXG4gIHNlY3JldDogcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQgfHwgJ2ZhbGxiYWNrLXNlY3JldC1jaGFuZ2UtaW4tcHJvZHVjdGlvbicsXG4gIHJlc2F2ZTogZmFsc2UsIC8vIERvbid0IHNhdmUgdW5jaGFuZ2VkIHNlc3Npb25zXG4gIHNhdmVVbmluaXRpYWxpemVkOiBmYWxzZSxcbiAgcm9sbGluZzogdHJ1ZSwgLy8gUmVzZXQgZXhwaXJ5IG9uIGVhY2ggcmVxdWVzdFxuICBjb29raWU6IHtcbiAgICBzZWN1cmU6IGNvbmZpZy5zZXJ2ZXIuaXNQcm9kdWN0aW9uLCAvLyBVc2UgSFRUUFMgaW4gcHJvZHVjdGlvblxuICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgIG1heEFnZTogNyAqIDI0ICogNjAgKiA2MCAqIDEwMDAsIC8vIDcgZGF5cyAtIGxvbmdlciBzZXNzaW9uIGR1cmF0aW9uXG4gICAgc2FtZVNpdGU6IGNvbmZpZy5zZXJ2ZXIuaXNQcm9kdWN0aW9uID8gJ3N0cmljdCcgOiAnbGF4JywgLy8gU3RyaWN0ZXIgaW4gcHJvZHVjdGlvblxuICAgIHBhdGg6ICcvJywgLy8gRXhwbGljaXRseSBzZXQgcGF0aFxuICAgIGRvbWFpbjogY29uZmlnLnNlcnZlci5pc1Byb2R1Y3Rpb24gJiYgY29uZmlnLnNlcnZlci5kb21haW4uaW5jbHVkZXMoJ2tvdmVvLWdlc3Rpb24uY29tJykgXG4gICAgICA/ICcua292ZW8tZ2VzdGlvbi5jb20nIC8vIEFsbG93IHN1YmRvbWFpbiBzaGFyaW5nIGluIHByb2R1Y3Rpb25cbiAgICAgIDogdW5kZWZpbmVkLFxuICB9LFxuICBuYW1lOiAna292ZW8uc2lkJyxcbiAgcHJveHk6IGNvbmZpZy5zZXJ2ZXIuaXNQcm9kdWN0aW9uLCAvLyBFbmFibGUgcHJveHkgdHJ1c3QgaW4gcHJvZHVjdGlvblxufSk7XG5cbi8qKlxuICogRW5oYW5jZWQgcGFzc3dvcmQgaGFzaGluZyB1c2luZyBiY3J5cHQgd2l0aCBzYWx0IGZvciBRdWViZWMgTGF3IDI1IGNvbXBsaWFuY2UuXG4gKiBQcm92aWRlcyBzdHJvbmcgc2VjdXJpdHkgdXNpbmcgaW5kdXN0cnktc3RhbmRhcmQgYmNyeXB0IGFsZ29yaXRobVxuICogd2l0aCBjb25maWd1cmFibGUgc2FsdCByb3VuZHMgKGRlZmF1bHQ6IDEyKS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFzc3dvcmQgLSBQbGFpbiB0ZXh0IHBhc3N3b3JkIHRvIGhhc2guXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSBQcm9taXNlIHJlc29sdmluZyB0byBiY3J5cHQgaGFzaGVkIHBhc3N3b3JkLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGhhc2hQYXNzd29yZCgndXNlclBhc3N3b3JkMTIzJyk7XG4gKiAvLyBTdG9yZSBoYXNoZWQgcGFzc3dvcmQgc2VjdXJlbHkgaW4gZGF0YWJhc2VcbiAqIGF3YWl0IHN0b3JhZ2UuY3JlYXRlVXNlcih7IC4uLnVzZXJEYXRhLCBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQgfSk7XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBIYXNoUGFzc3dvcmQgZnVuY3Rpb24uXG4gKiBAcGFyYW0gcGFzc3dvcmRcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhc2hQYXNzd29yZChwYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3Qgc2FsdFJvdW5kcyA9IDEyOyAvLyBSZWNvbW1lbmRlZCBmb3IgcHJvZHVjdGlvblxuICByZXR1cm4gYXdhaXQgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIHNhbHRSb3VuZHMpO1xufVxuXG4vKipcbiAqIFZlcmlmaWVzIGEgcGFzc3dvcmQgYWdhaW5zdCBzdG9yZWQgYmNyeXB0IGhhc2ggdXNpbmcgY29uc3RhbnQtdGltZSBjb21wYXJpc29uLlxuICogVXNlcyBiY3J5cHQuY29tcGFyZSBmb3Igc2VjdXJlIHBhc3N3b3JkIHZlcmlmaWNhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFzc3dvcmQgLSBQbGFpbiB0ZXh0IHBhc3N3b3JkIHRvIHZlcmlmeS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoZWRQYXNzd29yZCAtIFN0b3JlZCBiY3J5cHQgaGFzaCBmcm9tIHVzZXIgcmVjb3JkLlxuICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFByb21pc2UgcmVzb2x2aW5nIHRvIHRydWUgaWYgcGFzc3dvcmQgbWF0Y2hlcywgZmFsc2Ugb3RoZXJ3aXNlLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBjb25zdCB1c2VyID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyQnlFbWFpbChlbWFpbCk7XG4gKiBjb25zdCBpc1ZhbGlkID0gYXdhaXQgdmVyaWZ5UGFzc3dvcmQoaW5wdXRQYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XG4gKiBpZiAoaXNWYWxpZCkge1xuICogICAvLyBHcmFudCBhY2Nlc3NcbiAqIH1cbiAqIGBgYFxuICovXG4vKipcbiAqIFZlcmlmeVBhc3N3b3JkIGZ1bmN0aW9uLlxuICogQHBhcmFtIHBhc3N3b3JkXG4gKiBAcGFyYW0gaGFzaGVkUGFzc3dvcmRcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkOiBzdHJpbmcsIGhhc2hlZFBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgcmV0dXJuIGF3YWl0IGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCBoYXNoZWRQYXNzd29yZCk7XG59XG5cbi8qKlxuICogQXV0aGVudGljYXRpb24gbWlkZGxld2FyZSB0byBwcm90ZWN0IHJvdXRlcyByZXF1aXJpbmcgdXNlciBsb2dpbi5cbiAqIFZhbGlkYXRlcyBzZXNzaW9uIGV4aXN0ZW5jZSwgcmV0cmlldmVzIHVzZXIgZGF0YSwgYW5kIGVuc3VyZXMgYWNjb3VudCBpcyBhY3RpdmUuXG4gKiBBdXRvbWF0aWNhbGx5IGRlc3Ryb3lzIGludmFsaWQgc2Vzc2lvbnMgZm9yIHNlY3VyaXR5LlxuICpcbiAqIEBwYXJhbSB7UmVxdWVzdH0gcmVxIC0gRXhwcmVzcyByZXF1ZXN0IG9iamVjdCB3aXRoIHNlc3Npb24gZGF0YS5cbiAqIEBwYXJhbSB7UmVzcG9uc2V9IHJlcyAtIEV4cHJlc3MgcmVzcG9uc2Ugb2JqZWN0IGZvciBzZW5kaW5nIGVycm9yIHJlc3BvbnNlcy5cbiAqIEBwYXJhbSB7TmV4dEZ1bmN0aW9ufSBuZXh0IC0gRXhwcmVzcyBuZXh0IGZ1bmN0aW9uIHRvIGNvbnRpbnVlIHRvIHByb3RlY3RlZCByb3V0ZS5cbiAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbiBhdXRoZW50aWNhdGlvbiBpcyB2ZXJpZmllZC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogYXBwLmdldCgnL2FwaS9wcm90ZWN0ZWQtcm91dGUnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gKiAgIC8vIHJlcS51c2VyIGlzIG5vdyBhdmFpbGFibGUgYW5kIHZlcmlmaWVkXG4gKiAgIHJlcy5qc29uKHsgdXNlcklkOiByZXEudXNlci5pZCB9KTtcbiAqIH0pO1xuICogYGBgXG4gKi9cbi8qKlxuICogUmVxdWlyZUF1dGggZnVuY3Rpb24uXG4gKiBAcGFyYW0gcmVxXG4gKiBAcGFyYW0gcmVzXG4gKiBAcGFyYW0gbmV4dFxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVxdWlyZUF1dGgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pIHtcbiAgaWYgKCFyZXEuc2Vzc2lvbj8udXNlcklkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIC8vIE1vcmUgYWdncmVzc2l2ZSBzZXNzaW9uIHRvdWNoIGZvciBiZXR0ZXIgVVggLSBleHRlbmQgc2Vzc2lvbiBvbiBlYWNoIGF1dGhlbnRpY2F0ZWQgcmVxdWVzdFxuICAgIGlmIChyZXEuc2Vzc2lvbiAmJiByZXEuc2Vzc2lvbi50b3VjaCAmJiByZXEuc2Vzc2lvbi5jb29raWUpIHtcbiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCBzZXNzaW9uQWdlID0gbm93IC0gKHJlcS5zZXNzaW9uLmNvb2tpZS5vcmlnaW5hbE1heEFnZSB8fCAwKSArIChyZXEuc2Vzc2lvbi5jb29raWUubWF4QWdlIHx8IDApO1xuICAgICAgY29uc3Qgc2Vzc2lvbkxpZmV0aW1lID0gcmVxLnNlc3Npb24uY29va2llLm9yaWdpbmFsTWF4QWdlIHx8ICg3ICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICBcbiAgICAgIC8vIFRvdWNoIHNlc3Npb24gaWYgbW9yZSB0aGFuIDEwJSBvZiBpdHMgbGlmZXRpbWUgaGFzIHBhc3NlZCAobW9yZSByZXNwb25zaXZlKVxuICAgICAgaWYgKHNlc3Npb25BZ2UgPiBzZXNzaW9uTGlmZXRpbWUgKiAwLjEpIHtcbiAgICAgICAgcmVxLnNlc3Npb24udG91Y2goKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBMb2FkaW5nIHVzZXIgc2Vzc2lvblxuXG4gICAgLy8gQ2xlYXIgYW55IGNhY2hlZCB1c2VyIGRhdGEgZm9yIHRoaXMgSUQgdG8gZW5zdXJlIGZyZXNoIGxvYWRcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ3VzZXJzJywgYHVzZXI6JHtyZXEuc2Vzc2lvbi51c2VySWR9YCk7XG4gICAgcXVlcnlDYWNoZS5pbnZhbGlkYXRlKCd1c2VycycsIGB1c2VyX2VtYWlsOipgKTtcblxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXIocmVxLnNlc3Npb24udXNlcklkKTtcbiAgICAvLyBVc2VyIGxvYWRlZCBmcm9tIHNlc3Npb25cbiAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgIHJlcS5zZXNzaW9uLmRlc3Ryb3koKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgLy8gU2Vzc2lvbiBkZXN0cnVjdGlvbiBlcnJvciBoYW5kbGVkXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBub3QgZm91bmQgb3IgaW5hY3RpdmUnLFxuICAgICAgICBjb2RlOiAnVVNFUl9JTkFDVElWRScsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTZXQgc2Vzc2lvbiByb2xlIChwZXJtaXNzaW9ucyBoYW5kbGVkIHZpYSBkYXRhYmFzZSlcbiAgICByZXEuc2Vzc2lvbi5yb2xlID0gdXNlci5yb2xlO1xuXG4gICAgLy8gQWRkIG9yZ2FuaXphdGlvbiBpbmZvcm1hdGlvbiB0byB0aGUgdXNlciBvYmplY3QgLSB3aXRoIGVycm9yIGhhbmRsaW5nIGZvciByZXNpbGllbmNlXG4gICAgbGV0IHVzZXJPcmdhbml6YXRpb25zOiBhbnlbXSA9IFtdO1xuICAgIHRyeSB7XG4gICAgICB1c2VyT3JnYW5pemF0aW9ucyA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3Qoe1xuICAgICAgICAgIG9yZ2FuaXphdGlvbklkOiBzY2hlbWEudXNlck9yZ2FuaXphdGlvbnMub3JnYW5pemF0aW9uSWQsXG4gICAgICAgICAgY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9uczogc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zLmNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnMsXG4gICAgICAgIH0pXG4gICAgICAgIC5mcm9tKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucylcbiAgICAgICAgLndoZXJlKFxuICAgICAgICAgIGFuZChcbiAgICAgICAgICAgIGVxKHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucy51c2VySWQsIHVzZXIuaWQpLFxuICAgICAgICAgICAgZXEoc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zLmlzQWN0aXZlLCB0cnVlKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9IGNhdGNoIChvcmdFcnJvcikge1xuICAgICAgLy8gT3JnYW5pemF0aW9uIGxvb2t1cCBlcnJvciBoYW5kbGVkIGdyYWNlZnVsbHlcbiAgICAgIC8vIENvbnRpbnVlIHdpdGggZW1wdHkgb3JnYW5pemF0aW9ucyAtIHVzZXIgY2FuIHN0aWxsIGF1dGhlbnRpY2F0ZVxuICAgICAgdXNlck9yZ2FuaXphdGlvbnMgPSBbXTtcbiAgICB9XG5cbiAgICAvLyBFbmhhbmNlZCB1c2VyIG9iamVjdCB3aXRoIG9yZ2FuaXphdGlvbiBhY2Nlc3MgaW5mb3JtYXRpb25cbiAgICByZXEudXNlciA9IHtcbiAgICAgIC4uLnVzZXIsXG4gICAgICBvcmdhbml6YXRpb25zOiB1c2VyT3JnYW5pemF0aW9ucy5tYXAoKHVvKSA9PiB1by5vcmdhbml6YXRpb25JZCksXG4gICAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zOiB1c2VyT3JnYW5pemF0aW9ucy5zb21lKCh1bykgPT4gdW8uY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyksXG4gICAgfSBhcyBhbnk7XG5cbiAgICAvLyBTcGVjaWFsIGhhbmRsaW5nIGZvciBoYXJkY29kZWQgZGVtbyB1c2VycyAtIGVuc3VyZSB0aGV5IGhhdmUgcHJvcGVyIG9yZ2FuaXphdGlvbiBhY2Nlc3NcbiAgICAvLyBDaGVjayBpZiB0aGUgdXNlciByZWNvcmQgaGFzIG9yZ2FuaXphdGlvbiBhY2Nlc3MgY29uZmlndXJlZFxuICAgIGlmIChcbiAgICAgIHVzZXIucm9sZT8uc3RhcnRzV2l0aCgnZGVtb18nKSAmJlxuICAgICAgKCFyZXEudXNlci5vcmdhbml6YXRpb25zIHx8IHJlcS51c2VyLm9yZ2FuaXphdGlvbnMubGVuZ3RoID09PSAwKVxuICAgICkge1xuICAgICAgLy8gRGVtbyB1c2VycyBzaG91bGQgZ2V0IGFjY2VzcyB0byBkZW1vIG9yZ2FuaXphdGlvbnNcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGRlbW9PcmdzID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgaWQ6IHNjaGVtYS5vcmdhbml6YXRpb25zLmlkIH0pXG4gICAgICAgICAgLmZyb20oc2NoZW1hLm9yZ2FuaXphdGlvbnMpXG4gICAgICAgICAgLndoZXJlKGVxKHNjaGVtYS5vcmdhbml6YXRpb25zLnR5cGUsICdkZW1vJykpXG4gICAgICAgICAgLmxpbWl0KDEpO1xuICAgICAgICBcbiAgICAgICAgaWYgKGRlbW9PcmdzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBBZGRpbmcgb3JnYW5pemF0aW9uIGFjY2VzcyBmb3IgZGVtbyB1c2VyXG4gICAgICAgICAgcmVxLnVzZXIub3JnYW5pemF0aW9ucyA9IFtkZW1vT3Jnc1swXS5pZF07XG4gICAgICAgICAgcmVxLnVzZXIuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChkZW1vT3JnRXJyb3IpIHtcbiAgICAgICAgLy8gRGVtbyBvcmdhbml6YXRpb24gbG9va3VwIGZhaWxlZCwgY29udGludWUgd2l0aG91dCBhY2Nlc3NcbiAgICAgIH1cbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAvLyBBdXRoZW50aWNhdGlvbiBlcnJvciBoYW5kbGVkXG4gICAgY29uc29sZS5lcnJvcign4p2MIEF1dGhlbnRpY2F0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGVycm9yJyxcbiAgICAgIGNvZGU6ICdBVVRIX0VSUk9SJyxcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIFJvbGUtYmFzZWQgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlIGZhY3RvcnkgZm9yIFF1ZWJlYyBwcm9wZXJ0eSBtYW5hZ2VtZW50IHJvbGVzLlxuICogQ3JlYXRlcyBtaWRkbGV3YXJlIHRoYXQgcmVzdHJpY3RzIGFjY2VzcyBiYXNlZCBvbiB1c2VyIHJvbGVzIHN1Y2ggYXMgYWRtaW4sIG1hbmFnZXIsIHRlbmFudC5cbiAqIE11c3QgYmUgdXNlZCBhZnRlciByZXF1aXJlQXV0aCBtaWRkbGV3YXJlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nW119IGFsbG93ZWRSb2xlcyAtIEFycmF5IG9mIHJvbGVzIHRoYXQgY2FuIGFjY2VzcyB0aGUgcm91dGUgKGUuZy4sIFsnYWRtaW4nLCAnbWFuYWdlciddKS5cbiAqIEByZXR1cm5zIHtGdW5jdGlvbn0gRXhwcmVzcyBtaWRkbGV3YXJlIGZ1bmN0aW9uIGZvciByb2xlIHZhbGlkYXRpb24uXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIC8vIE9ubHkgYWRtaW5zIGNhbiBhY2Nlc3MgdXNlciBtYW5hZ2VtZW50XG4gKiBhcHAuZ2V0KCcvYXBpL2FkbWluL3VzZXJzJywgcmVxdWlyZUF1dGgsIHJlcXVpcmVSb2xlKFsnYWRtaW4nXSksIGdldFVzZXJMaXN0KTtcbiAqXG4gKiAvLyBNYW5hZ2VycyBhbmQgYWRtaW5zIGNhbiBhY2Nlc3MgYnVpbGRpbmcgZGF0YVxuICogYXBwLmdldCgnL2FwaS9idWlsZGluZ3MnLCByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUoWydhZG1pbicsICdtYW5hZ2VyJ10pLCBnZXRCdWlsZGluZ3MpO1xuICogYGBgXG4gKi9cbi8qKlxuICogUmVxdWlyZVJvbGUgZnVuY3Rpb24uXG4gKiBAcGFyYW0gYWxsb3dlZFJvbGVzXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlUm9sZShhbGxvd2VkUm9sZXM6IHN0cmluZ1tdKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBpZiAoIXJlcS51c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoIWFsbG93ZWRSb2xlcy5pbmNsdWRlcyhyZXEudXNlci5yb2xlKSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycsXG4gICAgICAgIGNvZGU6ICdJTlNVRkZJQ0lFTlRfUEVSTUlTU0lPTlMnLFxuICAgICAgICByZXF1aXJlZDogYWxsb3dlZFJvbGVzLFxuICAgICAgICBjdXJyZW50OiByZXEudXNlci5yb2xlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vKipcbiAqIFBlcm1pc3Npb24tYmFzZWQgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlIGZhY3RvcnkgdXNpbmcgdGhlIGNvbXByZWhlbnNpdmUgUkJBQyBzeXN0ZW0uXG4gKiBWYWxpZGF0ZXMgdXNlciBwZXJtaXNzaW9ucyBiYXNlZCBvbiB0aGUgZGF0YWJhc2UgUkJBQyBzeXN0ZW0uXG4gKiBNdXN0IGJlIHVzZWQgYWZ0ZXIgcmVxdWlyZUF1dGggbWlkZGxld2FyZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGVybWlzc2lvbiAtIFNwZWNpZmljIHBlcm1pc3Npb24gcmVxdWlyZWQgdG8gYWNjZXNzIHRoZSByb3V0ZSAoZS5nLiwgJ3JlYWQ6YmlsbCcsICdjcmVhdGU6bWFpbnRlbmFuY2VfcmVxdWVzdCcpLlxuICogQHJldHVybnMge0Z1bmN0aW9ufSBFeHByZXNzIG1pZGRsZXdhcmUgZnVuY3Rpb24gZm9yIHBlcm1pc3Npb24gdmFsaWRhdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogLy8gT25seSB1c2VycyB3aXRoICdyZWFkOmJpbGwnIHBlcm1pc3Npb24gY2FuIGFjY2Vzc1xuICogYXBwLmdldCgnL2FwaS9iaWxscycsIHJlcXVpcmVBdXRoLCBhdXRob3JpemUoJ3JlYWQ6YmlsbCcpLCBnZXRCaWxscyk7XG4gKlxuICogLy8gT25seSB1c2VycyB3aXRoICdkZWxldGU6dXNlcicgcGVybWlzc2lvbiBjYW4gZGVsZXRlIHVzZXJzXG4gKiBhcHAuZGVsZXRlKCcvYXBpL3VzZXJzLzppZCcsIHJlcXVpcmVBdXRoLCBhdXRob3JpemUoJ2RlbGV0ZTp1c2VyJyksIGRlbGV0ZVVzZXIpO1xuICpcbiAqIC8vIE11bHRpcGxlIHJvdXRlIHByb3RlY3Rpb25cbiAqIHJvdXRlci51c2UoYXV0aG9yaXplKCdtYW5hZ2U6YnVpbGRpbmcnKSk7XG4gKiByb3V0ZXIucG9zdCgnL2J1aWxkaW5ncycsIGNyZWF0ZUJ1aWxkaW5nKTtcbiAqIHJvdXRlci5wYXRjaCgnL2J1aWxkaW5ncy86aWQnLCB1cGRhdGVCdWlsZGluZyk7XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBBdXRob3JpemUgZnVuY3Rpb24uXG4gKiBAcGFyYW0gcGVybWlzc2lvblxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gYXV0aG9yaXplKHBlcm1pc3Npb246IHN0cmluZykge1xuICByZXR1cm4gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgaWYgKCFyZXEudXNlcikge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSB1c2VyJ3Mgcm9sZSBoYXMgdGhlIHJlcXVpcmVkIHBlcm1pc3Npb24gdmlhIGRhdGFiYXNlXG4gICAgICBjb25zdCBoYXNQZXJtaXNzaW9uID0gYXdhaXQgY2hlY2tVc2VyUGVybWlzc2lvbihyZXEudXNlci5yb2xlIGFzIGFueSwgcGVybWlzc2lvbik7XG5cbiAgICAgIGlmICghaGFzUGVybWlzc2lvbikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMnLFxuICAgICAgICAgIGNvZGU6ICdQRVJNSVNTSU9OX0RFTklFRCcsXG4gICAgICAgICAgcmVxdWlyZWQ6IHBlcm1pc3Npb24sXG4gICAgICAgICAgdXNlclJvbGU6IHJlcS51c2VyLnJvbGUsXG4gICAgICAgICAgZGV0YWlsczogYFVzZXIgd2l0aCByb2xlICcke3JlcS51c2VyLnJvbGV9JyBkb2VzIG5vdCBoYXZlIHBlcm1pc3Npb24gJyR7cGVybWlzc2lvbn0nYCxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIG5leHQoKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAvLyBBdXRob3JpemF0aW9uIGVycm9yIGhhbmRsZWRcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBBdXRob3JpemF0aW9uIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdBdXRob3JpemF0aW9uIGNoZWNrIGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdBVVRIT1JJWkFUSU9OX0VSUk9SJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBTZXRzIHVwIGF1dGhlbnRpY2F0aW9uIHJvdXRlcyBmb3IgUXVlYmVjLWNvbXBsaWFudCB1c2VyIG1hbmFnZW1lbnQuXG4gKiBJbXBsZW1lbnRzIGxvZ2luLCBsb2dvdXQsIHJlZ2lzdHJhdGlvbiwgYW5kIGN1cnJlbnQgdXNlciBlbmRwb2ludHNcbiAqIHdpdGggcHJvcGVyIHNlc3Npb24gbWFuYWdlbWVudCBhbmQgTGF3IDI1IGNvbXBsaWFuY2UgY29uc2lkZXJhdGlvbnMuXG4gKlxuICogQHBhcmFtIHthbnl9IGFwcCAtIEV4cHJlc3MgYXBwbGljYXRpb24gaW5zdGFuY2UgdG8gcmVnaXN0ZXIgcm91dGVzIG9uLlxuICogQHJldHVybnMge3ZvaWR9IE5vIHJldHVybiB2YWx1ZSAtIHJvdXRlcyBhcmUgcmVnaXN0ZXJlZCBkaXJlY3RseSBvbiBhcHAuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbiAqIGFwcC51c2Uoc2Vzc2lvbkNvbmZpZyk7XG4gKiBzZXR1cEF1dGhSb3V0ZXMoYXBwKTtcbiAqIC8vIEF1dGhlbnRpY2F0aW9uIHJvdXRlcyBhcmUgbm93IGF2YWlsYWJsZTpcbiAqIC8vIFBPU1QgL2FwaS9hdXRoL2xvZ2luXG4gKiAvLyBQT1NUIC9hcGkvYXV0aC9sb2dvdXRcbiAqIC8vIEdFVCAvYXBpL2F1dGgvdXNlclxuICogLy8gUE9TVCAvYXBpL2F1dGgvcmVnaXN0ZXJcbiAqIGBgYFxuICovXG4vKipcbiAqIFNldHVwQXV0aFJvdXRlcyBmdW5jdGlvbi5cbiAqIEBwYXJhbSBhcHBcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldHVwQXV0aFJvdXRlcyhhcHA6IGFueSkge1xuICAvLyBMb2dpbiByb3V0ZVxuICBhcHAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG4gICAgICAvLyBMb2dpbiBhdHRlbXB0IGluaXRpYXRlZFxuXG4gICAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdFbWFpbCBhbmQgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnTUlTU0lOR19DUkVERU5USUFMUycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBSZXRyaWV2aW5nIHVzZXIgYnkgZW1haWxcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXJCeUVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBjcmVkZW50aWFscycsXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfQ1JFREVOVElBTFMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0FjY291bnQgaXMgaW5hY3RpdmUnLFxuICAgICAgICAgIGNvZGU6ICdBQ0NPVU5UX0lOQUNUSVZFJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBiY3J5cHQgZm9yIHBhc3N3b3JkIHZlcmlmaWNhdGlvblxuICAgICAgLy8gVmVyaWZ5aW5nIHBhc3N3b3JkIGZvciB1c2VyXG4gICAgICAvLyBQYXNzd29yZCB2ZXJpZmljYXRpb24gaW5pdGlhdGVkXG4gICAgICBjb25zdCBpc1ZhbGlkUGFzc3dvcmQgPSBhd2FpdCB2ZXJpZnlQYXNzd29yZChwYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XG4gICAgICAvLyBQYXNzd29yZCB2ZXJpZmljYXRpb24gY29tcGxldGVkXG5cbiAgICAgIGlmICghaXNWYWxpZFBhc3N3b3JkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgY3JlZGVudGlhbHMnLFxuICAgICAgICAgIGNvZGU6ICdJTlZBTElEX0NSRURFTlRJQUxTJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVwZGF0ZSBsYXN0IGxvZ2luXG4gICAgICBhd2FpdCBzdG9yYWdlLnVwZGF0ZVVzZXIodXNlci5pZCwgeyBsYXN0TG9naW5BdDogbmV3IERhdGUoKSB9KTtcblxuICAgICAgLy8gU2V0IHNlc3Npb24gd2l0aCB1c2VyIGRhdGFcbiAgICAgIHJlcS5zZXNzaW9uLnVzZXJJZCA9IHVzZXIuaWQ7XG4gICAgICByZXEuc2Vzc2lvbi51c2VyUm9sZSA9IHVzZXIucm9sZTtcbiAgICAgIHJlcS5zZXNzaW9uLnJvbGUgPSB1c2VyLnJvbGU7XG4gICAgICByZXEuc2Vzc2lvbi51c2VyID0gdXNlcjsgLy8gQWRkIGNvbXBsZXRlIHVzZXIgb2JqZWN0IGZvciBtaWRkbGV3YXJlIGNvbXBhdGliaWxpdHlcblxuICAgICAgLy8gU2F2ZSBzZXNzaW9uIGV4cGxpY2l0bHkgdG8gZW5zdXJlIGl0J3MgcGVyc2lzdGVkXG4gICAgICByZXEuc2Vzc2lvbi5zYXZlKChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBTZXNzaW9uIHNhdmUgZXJyb3I6JywgZXJyKTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ1Nlc3Npb24gc2F2ZSBmYWlsZWQnLFxuICAgICAgICAgICAgY29kZTogJ1NFU1NJT05fU0FWRV9FUlJPUicsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBcbiAgICAgICAgLy8gUmV0dXJuIHVzZXIgZGF0YSAod2l0aG91dCBwYXNzd29yZClcbiAgICAgICAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlckRhdGEgfSA9IHVzZXI7XG4gICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICB1c2VyOiB1c2VyRGF0YSxcbiAgICAgICAgICBtZXNzYWdlOiAnTG9naW4gc3VjY2Vzc2Z1bCcsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoX2Vycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0xvZ2luIGVycm9yOicsIHtcbiAgICAgICAgZXJyb3I6IF9lcnJvcixcbiAgICAgICAgZW1haWw6IHJlcS5ib2R5Py5lbWFpbCxcbiAgICAgICAgaGFzUGFzc3dvcmQ6ICEhcmVxLmJvZHk/LnBhc3N3b3JkLFxuICAgICAgICBkYXRhYmFzZVVybDogISFwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwsXG4gICAgICAgIHNlc3Npb25TZWNyZXQ6ICEhcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQsXG4gICAgICB9KTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0xvZ2luIGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdMT0dJTl9FUlJPUicsXG4gICAgICAgIC4uLihwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50JyAmJiB7IGRldGFpbHM6IF9lcnJvciB9KSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gTG9nb3V0IHJvdXRlXG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvbG9nb3V0JywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHJlcS5zZXNzaW9uLmRlc3Ryb3koKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdMb2dvdXQgZXJyb3I6JywgZXJyKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTG9nb3V0IGZhaWxlZCcsXG4gICAgICAgICAgY29kZTogJ0xPR09VVF9FUlJPUicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBjb29raWUgd2l0aCBwcm9wZXIgb3B0aW9ucyB0aGF0IG1hdGNoIHNlc3Npb24gY29uZmlnXG4gICAgICBjb25zdCBjb29raWVPcHRpb25zOiBhbnkgPSB7XG4gICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICBzZWN1cmU6IGNvbmZpZy5zZXJ2ZXIuaXNQcm9kdWN0aW9uLFxuICAgICAgICBzYW1lU2l0ZTogY29uZmlnLnNlcnZlci5pc1Byb2R1Y3Rpb24gPyAnc3RyaWN0JyA6ICdsYXgnLFxuICAgICAgICBwYXRoOiAnLycsXG4gICAgICB9O1xuXG4gICAgICAvLyBBbHNvIGNsZWFyIHdpdGggZG9tYWluIGlmIGluIHByb2R1Y3Rpb25cbiAgICAgIGlmIChjb25maWcuc2VydmVyLmlzUHJvZHVjdGlvbiAmJiBjb25maWcuc2VydmVyLmRvbWFpbi5pbmNsdWRlcygna292ZW8tZ2VzdGlvbi5jb20nKSkge1xuICAgICAgICBjb29raWVPcHRpb25zLmRvbWFpbiA9ICcua292ZW8tZ2VzdGlvbi5jb20nO1xuICAgICAgfVxuXG4gICAgICByZXMuY2xlYXJDb29raWUoJ2tvdmVvLnNpZCcsIGNvb2tpZU9wdGlvbnMpO1xuICAgICAgXG4gICAgICAvLyBBbHNvIHRyeSBjbGVhcmluZyB3aXRob3V0IGRvbWFpbiBhcyBmYWxsYmFja1xuICAgICAgcmVzLmNsZWFyQ29va2llKCdrb3Zlby5zaWQnLCB7XG4gICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICBzZWN1cmU6IGNvbmZpZy5zZXJ2ZXIuaXNQcm9kdWN0aW9uLFxuICAgICAgICBzYW1lU2l0ZTogY29uZmlnLnNlcnZlci5pc1Byb2R1Y3Rpb24gPyAnc3RyaWN0JyA6ICdsYXgnLFxuICAgICAgICBwYXRoOiAnLycsXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgcmVzLmpzb24oeyBtZXNzYWdlOiAnTG9nb3V0IHN1Y2Nlc3NmdWwnIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBHZXQgY3VycmVudCB1c2VyIHJvdXRlXG4gIGFwcC5nZXQoJy9hcGkvYXV0aC91c2VyJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayB1c2VyIHNlc3Npb25cblxuICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIHZhbGlkIHNlc3Npb24gd2l0aCB1c2VyIElEXG4gICAgICBpZiAoIXJlcS5zZXNzaW9uPy51c2VySWQpIHtcbiAgICAgICAgLy8gTm8gc2Vzc2lvbiBmb3VuZFxuICAgICAgICBjb25zb2xlLmxvZygn4p2MIE5vIHZhbGlkIHNlc3Npb24gZm91bmQnKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTm90IGF1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgIGNvZGU6ICdOT1RfQVVUSEVOVElDQVRFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBUcnkgdG8gZ2V0IHVzZXIgZnJvbSBkYXRhYmFzZVxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXEuc2Vzc2lvbi51c2VySWQpO1xuICAgICAgICAvLyBVc2VyIGxvb2t1cCBjb21wbGV0ZWRcblxuICAgICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgICAvLyBVc2VyIG5vdCBmb3VuZCBvciBpbmFjdGl2ZSwgZGVzdHJveWluZyBzZXNzaW9uXG4gICAgICAgICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1Nlc3Npb24gZGVzdHJ1Y3Rpb24gZXJyb3I6JywgZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBub3QgZm91bmQgb3IgaW5hY3RpdmUnLFxuICAgICAgICAgICAgY29kZTogJ1VTRVJfSU5BQ1RJVkUnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVG91Y2ggc2Vzc2lvbiBtb3JlIGZyZXF1ZW50bHkgZm9yIGJldHRlciBVWFxuICAgICAgICBpZiAocmVxLnNlc3Npb24gJiYgcmVxLnNlc3Npb24udG91Y2ggJiYgcmVxLnNlc3Npb24uY29va2llKSB7XG4gICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICBjb25zdCBzZXNzaW9uQWdlID0gbm93IC0gKHJlcS5zZXNzaW9uLmNvb2tpZS5vcmlnaW5hbE1heEFnZSB8fCAwKSArIChyZXEuc2Vzc2lvbi5jb29raWUubWF4QWdlIHx8IDApO1xuICAgICAgICAgIGNvbnN0IHNlc3Npb25MaWZldGltZSA9IHJlcS5zZXNzaW9uLmNvb2tpZS5vcmlnaW5hbE1heEFnZSB8fCAoNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIFRvdWNoIHNlc3Npb24gaWYgbW9yZSB0aGFuIDEwJSBvZiBpdHMgbGlmZXRpbWUgaGFzIHBhc3NlZFxuICAgICAgICAgIGlmIChzZXNzaW9uQWdlID4gc2Vzc2lvbkxpZmV0aW1lICogMC4xKSB7XG4gICAgICAgICAgICByZXEuc2Vzc2lvbi50b3VjaCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJldHVybiB1c2VyIGRhdGEgd2l0aG91dCBwYXNzd29yZFxuICAgICAgICBjb25zdCB7IHBhc3N3b3JkOiBfLCAuLi51c2VyRGF0YSB9ID0gdXNlcjtcbiAgICAgICAgLy8gU3VjY2Vzc2Z1bGx5IGF1dGhlbnRpY2F0ZWQgdXNlclxuICAgICAgICByZXMuanNvbih1c2VyRGF0YSk7XG5cbiAgICAgIH0gY2F0Y2ggKHVzZXJFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdEYXRhYmFzZSBlcnJvciBnZXR0aW5nIHVzZXI6JywgdXNlckVycm9yKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9DSEVDS19FUlJPUicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBBdXRoIGNoZWNrIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGNoZWNrIGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdBVVRIX0NIRUNLX0VSUk9SJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gRGVidWcgZW5kcG9pbnQgdG8gY2hlY2sgYXV0aCBjb25maWd1cmF0aW9uIChwcm9kdWN0aW9uIG9ubHksIHRlbXBvcmFyeSlcbiAgYXBwLmdldCgnL2FwaS9hdXRoL2RlYnVnJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIGNvbnN0IGRlYnVnSW5mbyA9IHtcbiAgICAgIGhhc1Nlc3Npb246ICEhcmVxLnNlc3Npb24sXG4gICAgICBzZXNzaW9uSWQ6IHJlcS5zZXNzaW9uSUQsXG4gICAgICB1c2VySWQ6IHJlcS5zZXNzaW9uPy51c2VySWQsXG4gICAgICB1c2VyUm9sZTogcmVxLnNlc3Npb24/LnVzZXJSb2xlLFxuICAgICAgbm9kZUVudjogcHJvY2Vzcy5lbnYuTk9ERV9FTlYsXG4gICAgICBoYXNEYXRhYmFzZVVybDogISFwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwsXG4gICAgICBoYXNTZXNzaW9uU2VjcmV0OiAhIXByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVULFxuICAgICAgY29va2llczogcmVxLmhlYWRlcnMuY29va2llID8gJ3ByZXNlbnQnIDogJ21pc3NpbmcnLFxuICAgICAgY29va2llSGVhZGVyOiByZXEuaGVhZGVycy5jb29raWUsXG4gICAgICBzZXNzaW9uU3RvcmU6IHJlcS5zZXNzaW9uPy5zdG9yZT8uY29uc3RydWN0b3I/Lm5hbWUgfHwgJ3Vua25vd24nLFxuICAgICAgdXNlckFnZW50OiByZXEuaGVhZGVyc1sndXNlci1hZ2VudCddLFxuICAgICAgaG9zdDogcmVxLmhlYWRlcnMuaG9zdCxcbiAgICAgIHByb3RvY29sOiByZXEucHJvdG9jb2wsXG4gICAgICBzZWN1cmU6IHJlcS5zZWN1cmUsXG4gICAgICB0cnVzdFByb3h5OiAhIXJlcS5hcHAuZ2V0KCd0cnVzdCBwcm94eScpLFxuICAgIH07XG5cbiAgICBjb25zb2xlLmxvZygnQXV0aCBkZWJ1ZyBpbmZvOicsIGRlYnVnSW5mbyk7XG4gICAgcmVzLmpzb24oZGVidWdJbmZvKTtcbiAgfSk7XG5cbiAgLy8gVGVzdCBjb29raWUgc2V0dGluZyBlbmRwb2ludFxuICBhcHAucG9zdCgnL2FwaS9hdXRoL3Rlc3QtY29va2llJywgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIC8vIFNldCBhIHRlc3Qgc2Vzc2lvbiB2YWx1ZVxuICAgIHJlcS5zZXNzaW9uLnRlc3RWYWx1ZSA9ICd0ZXN0LScgKyBEYXRlLm5vdygpO1xuXG4gICAgcmVxLnNlc3Npb24uc2F2ZSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRmFpbGVkIHRvIHNhdmUgc2Vzc2lvbicsIGRldGFpbHM6IGVyci5tZXNzYWdlIH0pO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdUZXN0IGNvb2tpZSBzZXQnLFxuICAgICAgICBzZXNzaW9uSWQ6IHJlcS5zZXNzaW9uSUQsXG4gICAgICAgIHRlc3RWYWx1ZTogcmVxLnNlc3Npb24udGVzdFZhbHVlLFxuICAgICAgICBjb29raWVTZXR0aW5nczoge1xuICAgICAgICAgIHNlY3VyZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyxcbiAgICAgICAgICBodHRwT25seTogdHJ1ZSxcbiAgICAgICAgICBzYW1lU2l0ZTogJ2xheCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgLy8gUmVnaXN0ZXIgcm91dGUgKGFkbWluIG9ubHkgZm9yIG5vdylcbiAgYXBwLnBvc3QoXG4gICAgJy9hcGkvYXV0aC9yZWdpc3RlcicsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgcmVxdWlyZVJvbGUoWydhZG1pbiddKSxcbiAgICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCwgZmlyc3ROYW1lLCBsYXN0TmFtZSwgcm9sZSA9ICd0ZW5hbnQnLCBsYW5ndWFnZSA9ICdmcicgfSA9IHJlcS5ib2R5O1xuXG4gICAgICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkIHx8ICFmaXJzdE5hbWUgfHwgIWxhc3ROYW1lKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdBbGwgZmllbGRzIGFyZSByZXF1aXJlZCcsXG4gICAgICAgICAgICBjb2RlOiAnTUlTU0lOR19GSUVMRFMnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgdXNlciBhbHJlYWR5IGV4aXN0c1xuICAgICAgICBjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXJCeUVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICBpZiAoZXhpc3RpbmdVc2VyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA5KS5qc29uKHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIGFscmVhZHkgZXhpc3RzJyxcbiAgICAgICAgICAgIGNvZGU6ICdVU0VSX0VYSVNUUycsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgdXNlciB3aXRoIGJjcnlwdCBoYXNoZWQgcGFzc3dvcmRcbiAgICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBoYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xuXG4gICAgICAgIGNvbnN0IG5ld1VzZXIgPSBhd2FpdCBzdG9yYWdlLmNyZWF0ZVVzZXIoe1xuICAgICAgICAgIGVtYWlsOiBlbWFpbC50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgICAgdXNlcm5hbWU6IGVtYWlsLnRvTG93ZXJDYXNlKCksIC8vIFVzZSBlbWFpbCBhcyB1c2VybmFtZVxuICAgICAgICAgIHJvbGUsXG4gICAgICAgICAgbGFuZ3VhZ2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHsgcGFzc3dvcmQ6IF8sIC4uLnVzZXJEYXRhIH0gPSBuZXdVc2VyO1xuICAgICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgICAgdXNlcjogdXNlckRhdGEsXG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgY3JlYXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFJlZ2lzdHJhdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnUmVnaXN0cmF0aW9uIGZhaWxlZCcsXG4gICAgICAgICAgY29kZTogJ1JFR0lTVFJBVElPTl9FUlJPUicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBQYXNzd29yZCBSZXNldCBSZXF1ZXN0IFJvdXRlXG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvZm9yZ290LXBhc3N3b3JkJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVtYWlsIH0gPSByZXEuYm9keTtcblxuICAgICAgaWYgKCFlbWFpbCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdFbWFpbCBpcyByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ01JU1NJTkdfRU1BSUwnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwudG9Mb3dlckNhc2UoKSk7XG4gICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgLy8gQWx3YXlzIHJlc3BvbmQgd2l0aCBzdWNjZXNzIGZvciBzZWN1cml0eSAoZG9uJ3QgcmV2ZWFsIGlmIGVtYWlsIGV4aXN0cylcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSWYgdGhpcyBlbWFpbCBleGlzdHMsIGEgcGFzc3dvcmQgcmVzZXQgbGluayBoYXMgYmVlbiBzZW50LicsXG4gICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdlbmVyYXRlIHNlY3VyZSByYW5kb20gdG9rZW5cbiAgICAgIGNvbnN0IHJlc2V0VG9rZW4gPSByYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuICAgICAgY29uc3QgdG9rZW5IYXNoID0gY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKHJlc2V0VG9rZW4pLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgICAgIC8vIENyZWF0ZSBwYXNzd29yZCByZXNldCB0b2tlbiAoZXhwaXJlcyBpbiAxIGhvdXIpXG4gICAgICBjb25zdCBleHBpcmVzQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgZXhwaXJlc0F0LnNldEhvdXJzKGV4cGlyZXNBdC5nZXRIb3VycygpICsgMSk7XG5cbiAgICAgIGF3YWl0IHN0b3JhZ2UuY3JlYXRlUGFzc3dvcmRSZXNldFRva2VuKHtcbiAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICB0b2tlbjogcmVzZXRUb2tlbixcbiAgICAgICAgdG9rZW5IYXNoOiB0b2tlbkhhc2gsXG4gICAgICAgIGV4cGlyZXNBdDogZXhwaXJlc0F0LFxuICAgICAgICBpcEFkZHJlc3M6IHJlcS5pcCB8fCByZXEuY29ubmVjdGlvbj8ucmVtb3RlQWRkcmVzcyB8fCAndW5rbm93bicsXG4gICAgICAgIHVzZXJBZ2VudDogcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSB8fCAndW5rbm93bicsXG4gICAgICB9IGFzIGFueSk7XG5cbiAgICAgIC8vIFNlbmQgcGFzc3dvcmQgcmVzZXQgZW1haWxcbiAgICAgIGNvbnN0IGhvc3QgPSByZXEuZ2V0KCdob3N0JykgfHwgJyc7XG5cbiAgICAgIC8vIFVzZSBkZXZlbG9wbWVudCBVUkwgZm9yIFJlcGxpdCBlbnZpcm9ubWVudHMsIHByb2R1Y3Rpb24gVVJMIG90aGVyd2lzZVxuICAgICAgbGV0IGZyb250ZW5kVXJsO1xuICAgICAgaWYgKFxuICAgICAgICBob3N0LmluY2x1ZGVzKCdyZXBsaXQuZGV2JykgfHxcbiAgICAgICAgaG9zdC5pbmNsdWRlcygncmVwbGl0LmNvbScpIHx8XG4gICAgICAgIGhvc3QuaW5jbHVkZXMoJ3JlcGxpdC5jbycpIHx8XG4gICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnXG4gICAgICApIHtcbiAgICAgICAgLy8gVXNlIHRoZSBhY3R1YWwgUmVwbGl0IGRldmVsb3BtZW50IFVSTFxuICAgICAgICBmcm9udGVuZFVybCA9IGAke3JlcS5wcm90b2NvbH06Ly8ke2hvc3R9YDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFVzZSBwcm9kdWN0aW9uIFVSTCAtIHByaW9yaXRpemUga292ZW8tZ2VzdGlvbi5jb20gZm9yIHByb2R1Y3Rpb25cbiAgICAgICAgaWYgKGhvc3QuaW5jbHVkZXMoJ2tvdmVvLWdlc3Rpb24uY29tJykpIHtcbiAgICAgICAgICBmcm9udGVuZFVybCA9IGBodHRwczovLyR7aG9zdH1gO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZyb250ZW5kVXJsID0gcHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMIHx8ICdodHRwczovL2tvdmVvLWdlc3Rpb24uY29tJztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBjbGVhblVybCA9IGZyb250ZW5kVXJsLmVuZHNXaXRoKCcvJykgPyBmcm9udGVuZFVybC5zbGljZSgwLCAtMSkgOiBmcm9udGVuZFVybDtcbiAgICAgIGNvbnN0IHJlc2V0VXJsID0gYCR7Y2xlYW5Vcmx9L3Jlc2V0LXBhc3N3b3JkP3Rva2VuPSR7cmVzZXRUb2tlbn1gO1xuXG5cbiAgICAgIGNvbnN0IGVtYWlsU2VudCA9IGF3YWl0IGVtYWlsU2VydmljZS5zZW5kUGFzc3dvcmRSZXNldEVtYWlsKFxuICAgICAgICBlbWFpbC50b0xvd2VyQ2FzZSgpLFxuICAgICAgICBgJHt1c2VyLmZpcnN0TmFtZX0gJHt1c2VyLmxhc3ROYW1lfWAsXG4gICAgICAgIHJlc2V0VXJsXG4gICAgICApO1xuXG4gICAgICBpZiAoIWVtYWlsU2VudCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBwYXNzd29yZCByZXNldCBlbWFpbCB0bzonLCBlbWFpbCk7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBzZW5kIHBhc3N3b3JkIHJlc2V0IGVtYWlsJyxcbiAgICAgICAgICBjb2RlOiAnRU1BSUxfU0VORF9GQUlMRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnSWYgdGhpcyBlbWFpbCBleGlzdHMsIGEgcGFzc3dvcmQgcmVzZXQgbGluayBoYXMgYmVlbiBzZW50LicsXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgUGFzc3dvcmQgcmVzZXQgcmVxdWVzdCBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCByZXF1ZXN0IGZhaWxlZCcsXG4gICAgICAgIGNvZGU6ICdQQVNTV09SRF9SRVNFVF9SRVFVRVNUX0VSUk9SJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gUGFzc3dvcmQgUmVzZXQgUm91dGVcbiAgYXBwLnBvc3QoJy9hcGkvYXV0aC9yZXNldC1wYXNzd29yZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB0b2tlbiwgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBpZiAoIXRva2VuIHx8ICFwYXNzd29yZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBhbmQgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnTUlTU0lOR19GSUVMRFMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgcGFzc3dvcmQgc3RyZW5ndGhcbiAgICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCA4KSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgOCBjaGFyYWN0ZXJzIGxvbmcnLFxuICAgICAgICAgIGNvZGU6ICdQQVNTV09SRF9UT09fU0hPUlQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgcGFzc3dvcmQgY29tcGxleGl0eSByZXF1aXJlbWVudHNcbiAgICAgIGNvbnN0IGhhc1VwcGVyQ2FzZSA9IC9bQS1aXS8udGVzdChwYXNzd29yZCk7XG4gICAgICBjb25zdCBoYXNMb3dlckNhc2UgPSAvW2Etel0vLnRlc3QocGFzc3dvcmQpO1xuICAgICAgY29uc3QgaGFzTnVtYmVycyA9IC9cXGQvLnRlc3QocGFzc3dvcmQpO1xuXG4gICAgICBpZiAoIWhhc1VwcGVyQ2FzZSB8fCAhaGFzTG93ZXJDYXNlIHx8ICFoYXNOdW1iZXJzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIHVwcGVyY2FzZSBsZXR0ZXIsIG9uZSBsb3dlcmNhc2UgbGV0dGVyLCBhbmQgb25lIG51bWJlcicsXG4gICAgICAgICAgY29kZTogJ1BBU1NXT1JEX1RPT19XRUFLJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEZpbmQgdGhlIHBhc3N3b3JkIHJlc2V0IHRva2VuXG4gICAgICBjb25zdCByZXNldFRva2VuID0gYXdhaXQgc3RvcmFnZS5nZXRQYXNzd29yZFJlc2V0VG9rZW4odG9rZW4pO1xuICAgICAgaWYgKCFyZXNldFRva2VuKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgb3IgZXhwaXJlZCBwYXNzd29yZCByZXNldCB0b2tlbicsXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfVE9LRU4nLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdG9rZW4gaXMgZXhwaXJlZFxuICAgICAgaWYgKG5ldyBEYXRlKCkgPiByZXNldFRva2VuLmV4cGlyZXNBdCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCB0b2tlbiBoYXMgZXhwaXJlZCcsXG4gICAgICAgICAgY29kZTogJ1RPS0VOX0VYUElSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdG9rZW4gaGFzIGFscmVhZHkgYmVlbiB1c2VkXG4gICAgICBpZiAocmVzZXRUb2tlbi5pc1VzZWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgdG9rZW4gaGFzIGFscmVhZHkgYmVlbiB1c2VkJyxcbiAgICAgICAgICBjb2RlOiAnVE9LRU5fQUxSRUFEWV9VU0VEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSB0b2tlbiBoYXNoIGZvciBhZGRpdGlvbmFsIHNlY3VyaXR5XG4gICAgICBjb25zdCB0b2tlbkhhc2ggPSBjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUodG9rZW4pLmRpZ2VzdCgnaGV4Jyk7XG4gICAgICBpZiAodG9rZW5IYXNoICE9PSByZXNldFRva2VuLnRva2VuSGFzaCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIHBhc3N3b3JkIHJlc2V0IHRva2VuJyxcbiAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9UT0tFTl9IQVNIJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCB0aGUgdXNlclxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXNldFRva2VuLnVzZXJJZCk7XG4gICAgICBpZiAoIXVzZXIgfHwgIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnVXNlciBhY2NvdW50IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScsXG4gICAgICAgICAgY29kZTogJ1VTRVJfTk9UX0ZPVU5EJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVwZGF0ZSB1c2VyIHBhc3N3b3JkIHdpdGggYmNyeXB0IGhhc2hlZCB2ZXJzaW9uXG4gICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGhhc2hQYXNzd29yZChwYXNzd29yZCk7XG5cbiAgICAgIGF3YWl0IHN0b3JhZ2UudXBkYXRlVXNlcih1c2VyLmlkLCB7XG4gICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIE1hcmsgdG9rZW4gYXMgdXNlZFxuICAgICAgYXdhaXQgc3RvcmFnZS5tYXJrUGFzc3dvcmRSZXNldFRva2VuQXNVc2VkKHJlc2V0VG9rZW4uaWQpO1xuXG4gICAgICAvLyBDbGVhbiB1cCBleHBpcmVkIHRva2Vuc1xuICAgICAgYXdhaXQgc3RvcmFnZS5jbGVhbnVwRXhwaXJlZFBhc3N3b3JkUmVzZXRUb2tlbnMoKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgaGFzIGJlZW4gcmVzZXQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBQYXNzd29yZCByZXNldCBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCBmYWlsZWQnLFxuICAgICAgICBjb2RlOiAnUEFTU1dPUkRfUkVTRVRfRVJST1InLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuLyoqXG4gKiBEb2N1bWVudCBSQkFDIEZ1bmN0aW9ucyAtIFJvbGUtQmFzZWQgQWNjZXNzIENvbnRyb2wgZm9yIERvY3VtZW50c1xuICogSW1wbGVtZW50cyB0aGUgZm91ci10aWVyIHBlcm1pc3Npb24gc3lzdGVtOiBBZG1pbiA+IE1hbmFnZXIgPiBSZXNpZGVudCA+IFRlbmFudFxuICovXG5cbi8qKlxuICogQ2hlY2sgaWYgdXNlciBjYW4gdmlldyBhIHNwZWNpZmljIGRvY3VtZW50IGJhc2VkIG9uIFJCQUMgcnVsZXNcbiAqIEBwYXJhbSB1c2VyIC0gVGhlIGF1dGhlbnRpY2F0ZWQgdXNlclxuICogQHBhcmFtIGRvY3VtZW50IC0gVGhlIGRvY3VtZW50IHRvIGNoZWNrIGFjY2VzcyBmb3JcbiAqIEBwYXJhbSB1c2VyUmVzaWRlbmNlcyAtIFVzZXIncyByZXNpZGVuY2UgYXNzb2NpYXRpb25zXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGNhbiB2aWV3IGRvY3VtZW50XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYW5WaWV3RG9jdW1lbnQoXG4gIHVzZXI6IEF1dGhlbnRpY2F0ZWRVc2VyLCBcbiAgZG9jdW1lbnQ6IGFueSwgXG4gIHVzZXJSZXNpZGVuY2VzPzogYW55W11cbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIC8vIEFkbWluOiBDYW4gdmlldyBhbGwgZG9jdW1lbnRzXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gTWFuYWdlcjogQ2FuIHZpZXcgYWxsIGRvY3VtZW50cyBpbiB0aGVpciBvcmdhbml6YXRpb25cbiAgICBpZiAodXNlci5yb2xlID09PSAnbWFuYWdlcicpIHtcbiAgICAgIC8vIENoZWNrIGlmIGRvY3VtZW50IGJlbG9uZ3MgdG8gbWFuYWdlcidzIG9yZ2FuaXphdGlvblxuICAgICAgaWYgKGRvY3VtZW50LmJ1aWxkaW5nSWQpIHtcbiAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1aWxkaW5nKGRvY3VtZW50LmJ1aWxkaW5nSWQpO1xuICAgICAgICByZXR1cm4gYnVpbGRpbmc/Lm9yZ2FuaXphdGlvbklkID09PSB1c2VyLm9yZ2FuaXphdGlvbklkO1xuICAgICAgfVxuICAgICAgaWYgKGRvY3VtZW50LnJlc2lkZW5jZUlkKSB7XG4gICAgICAgIGNvbnN0IHJlc2lkZW5jZSA9IGF3YWl0IHN0b3JhZ2UuZ2V0UmVzaWRlbmNlKGRvY3VtZW50LnJlc2lkZW5jZUlkKTtcbiAgICAgICAgaWYgKHJlc2lkZW5jZSkge1xuICAgICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgc3RvcmFnZS5nZXRCdWlsZGluZyhyZXNpZGVuY2UuYnVpbGRpbmdJZCk7XG4gICAgICAgICAgcmV0dXJuIGJ1aWxkaW5nPy5vcmdhbml6YXRpb25JZCA9PT0gdXNlci5vcmdhbml6YXRpb25JZDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7IC8vIE1hbmFnZXIgY2FuIHZpZXcgb3JnYW5pemF0aW9uLWxldmVsIGRvY3NcbiAgICB9XG5cbiAgICAvLyBSZXNpZGVudDogQ2FuIHZpZXcgZG9jdW1lbnRzIGluIHRoZWlyIHJlc2lkZW5jZS9idWlsZGluZ1xuICAgIGlmICh1c2VyLnJvbGUgPT09ICdyZXNpZGVudCcpIHtcbiAgICAgIGlmIChkb2N1bWVudC5yZXNpZGVuY2VJZCkge1xuICAgICAgICByZXR1cm4gdXNlclJlc2lkZW5jZXM/LnNvbWUodXIgPT4gdXIucmVzaWRlbmNlSWQgPT09IGRvY3VtZW50LnJlc2lkZW5jZUlkKSB8fCBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChkb2N1bWVudC5idWlsZGluZ0lkKSB7XG4gICAgICAgIC8vIENhbiB2aWV3IGJ1aWxkaW5nIGRvY3MgaWYgdGhleSBsaXZlIGluIHRoYXQgYnVpbGRpbmdcbiAgICAgICAgY29uc3QgdXNlckJ1aWxkaW5nSWRzID0gdXNlclJlc2lkZW5jZXM/Lm1hcChhc3luYyB1ciA9PiB7XG4gICAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgc3RvcmFnZS5nZXRSZXNpZGVuY2UodXIucmVzaWRlbmNlSWQpO1xuICAgICAgICAgIHJldHVybiByZXNpZGVuY2U/LmJ1aWxkaW5nSWQ7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBidWlsZGluZ0lkcyA9IGF3YWl0IFByb21pc2UuYWxsKHVzZXJCdWlsZGluZ0lkcyB8fCBbXSk7XG4gICAgICAgIHJldHVybiBidWlsZGluZ0lkcy5pbmNsdWRlcyhkb2N1bWVudC5idWlsZGluZ0lkKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBUZW5hbnQ6IENhbiBvbmx5IHZpZXcgZG9jdW1lbnRzIG1hcmtlZCBhcyB2aXNpYmxlIHRvIHRlbmFudHNcbiAgICBpZiAodXNlci5yb2xlID09PSAndGVuYW50Jykge1xuICAgICAgaWYgKCFkb2N1bWVudC5pc1Zpc2libGVUb1RlbmFudHMpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoZG9jdW1lbnQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgcmV0dXJuIHVzZXJSZXNpZGVuY2VzPy5zb21lKHVyID0+IHVyLnJlc2lkZW5jZUlkID09PSBkb2N1bWVudC5yZXNpZGVuY2VJZCkgfHwgZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoZG9jdW1lbnQuYnVpbGRpbmdJZCkge1xuICAgICAgICBjb25zdCB1c2VyQnVpbGRpbmdJZHMgPSB1c2VyUmVzaWRlbmNlcz8ubWFwKGFzeW5jIHVyID0+IHtcbiAgICAgICAgICBjb25zdCByZXNpZGVuY2UgPSBhd2FpdCBzdG9yYWdlLmdldFJlc2lkZW5jZSh1ci5yZXNpZGVuY2VJZCk7XG4gICAgICAgICAgcmV0dXJuIHJlc2lkZW5jZT8uYnVpbGRpbmdJZDtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nSWRzID0gYXdhaXQgUHJvbWlzZS5hbGwodXNlckJ1aWxkaW5nSWRzIHx8IFtdKTtcbiAgICAgICAgcmV0dXJuIGJ1aWxkaW5nSWRzLmluY2x1ZGVzKGRvY3VtZW50LmJ1aWxkaW5nSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdEb2N1bWVudCB2aWV3IHBlcm1pc3Npb24gY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBDaGVjayBpZiB1c2VyIGNhbiBlZGl0IGEgc3BlY2lmaWMgZG9jdW1lbnRcbiAqIEBwYXJhbSB1c2VyIC0gVGhlIGF1dGhlbnRpY2F0ZWQgdXNlclxuICogQHBhcmFtIGRvY3VtZW50IC0gVGhlIGRvY3VtZW50IHRvIGNoZWNrXG4gKiBAcGFyYW0gdXNlclJlc2lkZW5jZXMgLSBVc2VyJ3MgcmVzaWRlbmNlIGFzc29jaWF0aW9uc1xuICogQHJldHVybnMgUHJvbWlzZTxib29sZWFuPiAtIFRydWUgaWYgdXNlciBjYW4gZWRpdCBkb2N1bWVudFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FuRWRpdERvY3VtZW50KFxuICB1c2VyOiBBdXRoZW50aWNhdGVkVXNlciwgXG4gIGRvY3VtZW50OiBhbnksIFxuICB1c2VyUmVzaWRlbmNlcz86IGFueVtdXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICAvLyBBZG1pbjogQ2FuIGVkaXQgYWxsIGRvY3VtZW50c1xuICAgIGlmICh1c2VyLnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIE1hbmFnZXI6IENhbiBlZGl0IGFsbCBkb2N1bWVudHMgaW4gdGhlaXIgb3JnYW5pemF0aW9uXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ21hbmFnZXInKSB7XG4gICAgICBpZiAoZG9jdW1lbnQuYnVpbGRpbmdJZCkge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcoZG9jdW1lbnQuYnVpbGRpbmdJZCk7XG4gICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAoZG9jdW1lbnQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgc3RvcmFnZS5nZXRSZXNpZGVuY2UoZG9jdW1lbnQucmVzaWRlbmNlSWQpO1xuICAgICAgICBpZiAocmVzaWRlbmNlKSB7XG4gICAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1aWxkaW5nKHJlc2lkZW5jZS5idWlsZGluZ0lkKTtcbiAgICAgICAgICByZXR1cm4gYnVpbGRpbmc/Lm9yZ2FuaXphdGlvbklkID09PSB1c2VyLm9yZ2FuaXphdGlvbklkO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBSZXNpZGVudDogQ2FuIGVkaXQgZG9jdW1lbnRzIHRoZXkgY3JlYXRlZCBvciBpbiB0aGVpciByZXNpZGVuY2VcbiAgICBpZiAodXNlci5yb2xlID09PSAncmVzaWRlbnQnKSB7XG4gICAgICAvLyBDYW4gZWRpdCBvd24gZG9jdW1lbnRzXG4gICAgICBpZiAoZG9jdW1lbnQudXBsb2FkZWRCeSA9PT0gdXNlci5pZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gQ2FuIGVkaXQgcmVzaWRlbmNlIGRvY3VtZW50c1xuICAgICAgaWYgKGRvY3VtZW50LnJlc2lkZW5jZUlkKSB7XG4gICAgICAgIHJldHVybiB1c2VyUmVzaWRlbmNlcz8uc29tZSh1ciA9PiB1ci5yZXNpZGVuY2VJZCA9PT0gZG9jdW1lbnQucmVzaWRlbmNlSWQpIHx8IGZhbHNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFRlbmFudDogQ2Fubm90IGVkaXQgZG9jdW1lbnRzIChyZWFkLW9ubHkgYWNjZXNzKVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdEb2N1bWVudCBlZGl0IHBlcm1pc3Npb24gY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBDaGVjayBpZiB1c2VyIGNhbiBkZWxldGUgYSBzcGVjaWZpYyBkb2N1bWVudFxuICogQHBhcmFtIHVzZXIgLSBUaGUgYXV0aGVudGljYXRlZCB1c2VyXG4gKiBAcGFyYW0gZG9jdW1lbnQgLSBUaGUgZG9jdW1lbnQgdG8gY2hlY2tcbiAqIEBwYXJhbSB1c2VyUmVzaWRlbmNlcyAtIFVzZXIncyByZXNpZGVuY2UgYXNzb2NpYXRpb25zXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGNhbiBkZWxldGUgZG9jdW1lbnRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbkRlbGV0ZURvY3VtZW50KFxuICB1c2VyOiBBdXRoZW50aWNhdGVkVXNlciwgXG4gIGRvY3VtZW50OiBhbnksIFxuICB1c2VyUmVzaWRlbmNlcz86IGFueVtdXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICAvLyBBZG1pbjogQ2FuIGRlbGV0ZSBhbGwgZG9jdW1lbnRzXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gTWFuYWdlcjogQ2FuIGRlbGV0ZSBkb2N1bWVudHMgaW4gdGhlaXIgb3JnYW5pemF0aW9uXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ21hbmFnZXInKSB7XG4gICAgICBpZiAoZG9jdW1lbnQuYnVpbGRpbmdJZCkge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcoZG9jdW1lbnQuYnVpbGRpbmdJZCk7XG4gICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAoZG9jdW1lbnQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgc3RvcmFnZS5nZXRSZXNpZGVuY2UoZG9jdW1lbnQucmVzaWRlbmNlSWQpO1xuICAgICAgICBpZiAocmVzaWRlbmNlKSB7XG4gICAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1aWxkaW5nKHJlc2lkZW5jZS5idWlsZGluZ0lkKTtcbiAgICAgICAgICByZXR1cm4gYnVpbGRpbmc/Lm9yZ2FuaXphdGlvbklkID09PSB1c2VyLm9yZ2FuaXphdGlvbklkO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBSZXNpZGVudDogQ2FuIG9ubHkgZGVsZXRlIGRvY3VtZW50cyB0aGV5IHVwbG9hZGVkXG4gICAgaWYgKHVzZXIucm9sZSA9PT0gJ3Jlc2lkZW50Jykge1xuICAgICAgcmV0dXJuIGRvY3VtZW50LnVwbG9hZGVkQnkgPT09IHVzZXIuaWQ7XG4gICAgfVxuXG4gICAgLy8gVGVuYW50OiBDYW5ub3QgZGVsZXRlIGRvY3VtZW50c1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdEb2N1bWVudCBkZWxldGUgcGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrIGlmIHVzZXIgY2FuIGNyZWF0ZSBkb2N1bWVudHMgaW4gYSBzcGVjaWZpYyBjb250ZXh0XG4gKiBAcGFyYW0gdXNlciAtIFRoZSBhdXRoZW50aWNhdGVkIHVzZXJcbiAqIEBwYXJhbSBjb250ZXh0IC0gVGhlIGNvbnRleHQgKGJ1aWxkaW5nSWQsIHJlc2lkZW5jZUlkLCBvciBvcmdhbml6YXRpb24pXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGNhbiBjcmVhdGUgZG9jdW1lbnRzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYW5DcmVhdGVEb2N1bWVudChcbiAgdXNlcjogQXV0aGVudGljYXRlZFVzZXIsXG4gIGNvbnRleHQ6IHsgYnVpbGRpbmdJZD86IHN0cmluZzsgcmVzaWRlbmNlSWQ/OiBzdHJpbmc7IG9yZ2FuaXphdGlvbklkPzogc3RyaW5nIH1cbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIC8vIEFkbWluOiBDYW4gY3JlYXRlIGRvY3VtZW50cyBhbnl3aGVyZVxuICAgIGlmICh1c2VyLnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIE1hbmFnZXI6IENhbiBjcmVhdGUgZG9jdW1lbnRzIGluIHRoZWlyIG9yZ2FuaXphdGlvblxuICAgIGlmICh1c2VyLnJvbGUgPT09ICdtYW5hZ2VyJykge1xuICAgICAgaWYgKGNvbnRleHQub3JnYW5pemF0aW9uSWQpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHQub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAoY29udGV4dC5idWlsZGluZ0lkKSB7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYXdhaXQgc3RvcmFnZS5nZXRCdWlsZGluZyhjb250ZXh0LmJ1aWxkaW5nSWQpO1xuICAgICAgICByZXR1cm4gYnVpbGRpbmc/Lm9yZ2FuaXphdGlvbklkID09PSB1c2VyLm9yZ2FuaXphdGlvbklkO1xuICAgICAgfVxuICAgICAgaWYgKGNvbnRleHQucmVzaWRlbmNlSWQpIHtcbiAgICAgICAgY29uc3QgcmVzaWRlbmNlID0gYXdhaXQgc3RvcmFnZS5nZXRSZXNpZGVuY2UoY29udGV4dC5yZXNpZGVuY2VJZCk7XG4gICAgICAgIGlmIChyZXNpZGVuY2UpIHtcbiAgICAgICAgICBjb25zdCBidWlsZGluZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVpbGRpbmcocmVzaWRlbmNlLmJ1aWxkaW5nSWQpO1xuICAgICAgICAgIHJldHVybiBidWlsZGluZz8ub3JnYW5pemF0aW9uSWQgPT09IHVzZXIub3JnYW5pemF0aW9uSWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFJlc2lkZW50OiBDYW4gY3JlYXRlIGRvY3VtZW50cyBpbiB0aGVpciByZXNpZGVuY2VcbiAgICBpZiAodXNlci5yb2xlID09PSAncmVzaWRlbnQnKSB7XG4gICAgICBpZiAoY29udGV4dC5yZXNpZGVuY2VJZCkge1xuICAgICAgICAvLyBDaGVjayBpZiB1c2VyIGxpdmVzIGluIHRoaXMgcmVzaWRlbmNlXG4gICAgICAgIGNvbnN0IHVzZXJSZXNpZGVuY2VzID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyUmVzaWRlbmNlcyh1c2VyLmlkKTtcbiAgICAgICAgcmV0dXJuIHVzZXJSZXNpZGVuY2VzLnNvbWUodXIgPT4gdXIucmVzaWRlbmNlSWQgPT09IGNvbnRleHQucmVzaWRlbmNlSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFRlbmFudDogQ2Fubm90IGNyZWF0ZSBkb2N1bWVudHNcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRG9jdW1lbnQgY3JlYXRlIHBlcm1pc3Npb24gY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLy8gRXh0ZW5kZWQgdXNlciBpbnRlcmZhY2UgZm9yIGF1dGhlbnRpY2F0aW9uIGNvbnRleHRcbmludGVyZmFjZSBBdXRoZW50aWNhdGVkVXNlciBleHRlbmRzIFVzZXIge1xuICBvcmdhbml6YXRpb25zPzogc3RyaW5nW107XG4gIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM/OiBib29sZWFuO1xuICBvcmdhbml6YXRpb25JZD86IHN0cmluZztcbn1cblxuLy8gRXh0ZW5kIEV4cHJlc3MgUmVxdWVzdCBpbnRlcmZhY2UgdG8gaW5jbHVkZSBhdXRoZW50aWNhdGVkIHVzZXJcbmRlY2xhcmUgZ2xvYmFsIHtcbiAgbmFtZXNwYWNlIEV4cHJlc3Mge1xuICAgIGludGVyZmFjZSBSZXF1ZXN0IHtcbiAgICAgIHVzZXI/OiBBdXRoZW50aWNhdGVkVXNlcjtcbiAgICB9XG4gIH1cbn1cblxuLy8gRXh0ZW5kIGV4cHJlc3Mtc2Vzc2lvbiB0byBpbmNsdWRlIGN1c3RvbSBwcm9wZXJ0aWVzXG5kZWNsYXJlIG1vZHVsZSAnZXhwcmVzcy1zZXNzaW9uJyB7XG4gIGludGVyZmFjZSBTZXNzaW9uRGF0YSB7XG4gICAgdXNlcklkPzogc3RyaW5nO1xuICAgIHVzZXJSb2xlPzogc3RyaW5nO1xuICAgIHJvbGU/OiBzdHJpbmc7XG4gICAgdXNlcj86IEF1dGhlbnRpY2F0ZWRVc2VyO1xuICAgIHBlcm1pc3Npb25zPzogc3RyaW5nW107XG4gICAgc3RvcmU/OiBhbnk7XG4gICAgdGVzdFZhbHVlPzogYW55O1xuICAgIG9yZ2FuaXphdGlvbklkPzogc3RyaW5nO1xuICAgIG9yZ2FuaXphdGlvbnM/OiBzdHJpbmdbXTtcbiAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zPzogYm9vbGVhbjtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9