b3d132364f5bc8cdd2b48e5eec32f293
"use strict";
/**
 * Server-side performance monitoring for Quebec property management SaaS.
 * Tracks database query performance and provides optimization insights.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.dbPerformanceMonitor = void 0;
exports.trackPerformance = trackPerformance;
const perf_hooks_1 = require("perf_hooks");
/**
 * Query performance tracker.
 */
class DatabasePerformanceMonitor {
    queryTimes = [];
    slowQueries = [];
    SLOW_QUERY_THRESHOLD = 100; // ms
    /**
     * Tracks execution time of a database operation.
     * @param queryName
     * @param operation
     */
    trackQuery(queryName, operation) {
        const startTime = perf_hooks_1.performance.now();
        return operation()
            .then((result) => {
            const duration = perf_hooks_1.performance.now() - startTime;
            this.recordQueryTime(queryName, duration);
            return result;
        })
            .catch((error) => {
            const duration = perf_hooks_1.performance.now() - startTime;
            this.recordQueryTime(queryName, duration);
            throw error;
        });
    }
    /**
     * Records query execution time.
     * @param queryName
     * @param duration
     */
    recordQueryTime(queryName, duration) {
        this.queryTimes.push(duration);
        // Keep only last 1000 query times for memory efficiency
        if (this.queryTimes.length > 1000) {
            this.queryTimes.shift();
        }
        // Track slow queries
        if (duration > this.SLOW_QUERY_THRESHOLD) {
            this.slowQueries.push({
                query: queryName,
                duration,
                timestamp: new Date(),
            });
            // Keep only last 100 slow queries
            if (this.slowQueries.length > 100) {
                this.slowQueries.shift();
            }
        }
    }
    /**
     * Gets average query time.
     */
    getAverageQueryTime() {
        if (this.queryTimes.length === 0) {
            return 0;
        }
        return this.queryTimes.reduce((a, b) => a + b, 0) / this.queryTimes.length;
    }
    /**
     * Gets performance statistics.
     */
    getPerformanceStats() {
        const avg = this.getAverageQueryTime();
        const max = Math.max(...this.queryTimes);
        const min = Math.min(...this.queryTimes);
        return {
            averageQueryTime: `${avg.toFixed(2)}ms`,
            maxQueryTime: `${max.toFixed(2)}ms`,
            minQueryTime: `${min.toFixed(2)}ms`,
            totalQueries: this.queryTimes.length,
            slowQueries: this.slowQueries.length,
            recentSlowQueries: this.slowQueries.slice(-10),
        };
    }
    /**
     * Provides optimization recommendations.
     */
    getOptimizationRecommendations() {
        const avg = this.getAverageQueryTime();
        const recommendations = [];
        if (avg > 100) {
            recommendations.push('Average query time exceeds 100ms. Consider adding database indexes.');
        }
        if (this.slowQueries.length > 10) {
            recommendations.push('Multiple slow queries detected. Review and optimize frequent queries.');
        }
        const commonSlowQueries = this.getCommonSlowQueries();
        if (commonSlowQueries.length > 0) {
            recommendations.push(`Common slow queries: ${commonSlowQueries.join(', ')}`);
        }
        return recommendations;
    }
    /**
     * Identifies commonly slow queries.
     */
    getCommonSlowQueries() {
        const queryFrequency = {};
        this.slowQueries.forEach(({ query }) => {
            queryFrequency[query] = (queryFrequency[query] || 0) + 1;
        });
        return Object.entries(queryFrequency)
            .filter(([, count]) => count > 2)
            .map(([query]) => query);
    }
    /**
     * Resets performance tracking data.
     */
    reset() {
        this.queryTimes = [];
        this.slowQueries = [];
    }
}
/**
 * Global performance monitor instance.
 */
exports.dbPerformanceMonitor = new DatabasePerformanceMonitor();
/**
 * Decorator for tracking database operation performance.
 * @param queryName
 */
/**
 * TrackPerformance function.
 * @param queryName
 * @returns Function result.
 */
function trackPerformance(queryName) {
    return function (target, propertyName, descriptor) {
        const method = descriptor.value;
        descriptor.value = async function (...args) {
            return exports.dbPerformanceMonitor.trackQuery(queryName, () => method.apply(this, args));
        };
        return descriptor;
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvcGVyZm9ybWFuY2UtbW9uaXRvcmluZy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUF1SkgsNENBVUM7QUEvSkQsMkNBQXlDO0FBRXpDOztHQUVHO0FBQ0gsTUFBTSwwQkFBMEI7SUFDdEIsVUFBVSxHQUFhLEVBQUUsQ0FBQztJQUMxQixXQUFXLEdBQWdFLEVBQUUsQ0FBQztJQUNyRSxvQkFBb0IsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLO0lBRWxEOzs7O09BSUc7SUFDSCxVQUFVLENBQUksU0FBaUIsRUFBRSxTQUEyQjtRQUMxRCxNQUFNLFNBQVMsR0FBRyx3QkFBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRXBDLE9BQU8sU0FBUyxFQUFFO2FBQ2YsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDZixNQUFNLFFBQVEsR0FBRyx3QkFBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQztZQUMvQyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMxQyxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNmLE1BQU0sUUFBUSxHQUFHLHdCQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBQy9DLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLGVBQWUsQ0FBQyxTQUFpQixFQUFFLFFBQWdCO1FBQ3pELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRS9CLHdEQUF3RDtRQUN4RCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDO1lBQ2xDLElBQUks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Y2UtbW9uaXRvcmluZy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNlcnZlci1zaWRlIHBlcmZvcm1hbmNlIG1vbml0b3JpbmcgZm9yIFF1ZWJlYyBwcm9wZXJ0eSBtYW5hZ2VtZW50IFNhYVMuXG4gKiBUcmFja3MgZGF0YWJhc2UgcXVlcnkgcGVyZm9ybWFuY2UgYW5kIHByb3ZpZGVzIG9wdGltaXphdGlvbiBpbnNpZ2h0cy5cbiAqL1xuXG5pbXBvcnQgeyBwZXJmb3JtYW5jZSB9IGZyb20gJ3BlcmZfaG9va3MnO1xuXG4vKipcbiAqIFF1ZXJ5IHBlcmZvcm1hbmNlIHRyYWNrZXIuXG4gKi9cbmNsYXNzIERhdGFiYXNlUGVyZm9ybWFuY2VNb25pdG9yIHtcbiAgcHJpdmF0ZSBxdWVyeVRpbWVzOiBudW1iZXJbXSA9IFtdO1xuICBwcml2YXRlIHNsb3dRdWVyaWVzOiBBcnJheTx7IHF1ZXJ5OiBzdHJpbmc7IGR1cmF0aW9uOiBudW1iZXI7IHRpbWVzdGFtcDogRGF0ZSB9PiA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IFNMT1dfUVVFUllfVEhSRVNIT0xEID0gMTAwOyAvLyBtc1xuXG4gIC8qKlxuICAgKiBUcmFja3MgZXhlY3V0aW9uIHRpbWUgb2YgYSBkYXRhYmFzZSBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBxdWVyeU5hbWVcbiAgICogQHBhcmFtIG9wZXJhdGlvblxuICAgKi9cbiAgdHJhY2tRdWVyeTxUPihxdWVyeU5hbWU6IHN0cmluZywgb3BlcmF0aW9uOiAoKSA9PiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICByZXR1cm4gb3BlcmF0aW9uKClcbiAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgICAgdGhpcy5yZWNvcmRRdWVyeVRpbWUocXVlcnlOYW1lLCBkdXJhdGlvbik7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICB0aGlzLnJlY29yZFF1ZXJ5VGltZShxdWVyeU5hbWUsIGR1cmF0aW9uKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWNvcmRzIHF1ZXJ5IGV4ZWN1dGlvbiB0aW1lLlxuICAgKiBAcGFyYW0gcXVlcnlOYW1lXG4gICAqIEBwYXJhbSBkdXJhdGlvblxuICAgKi9cbiAgcHJpdmF0ZSByZWNvcmRRdWVyeVRpbWUocXVlcnlOYW1lOiBzdHJpbmcsIGR1cmF0aW9uOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnF1ZXJ5VGltZXMucHVzaChkdXJhdGlvbik7XG5cbiAgICAvLyBLZWVwIG9ubHkgbGFzdCAxMDAwIHF1ZXJ5IHRpbWVzIGZvciBtZW1vcnkgZWZmaWNpZW5jeVxuICAgIGlmICh0aGlzLnF1ZXJ5VGltZXMubGVuZ3RoID4gMTAwMCkge1xuICAgICAgdGhpcy5xdWVyeVRpbWVzLnNoaWZ0KCk7XG4gICAgfVxuXG4gICAgLy8gVHJhY2sgc2xvdyBxdWVyaWVzXG4gICAgaWYgKGR1cmF0aW9uID4gdGhpcy5TTE9XX1FVRVJZX1RIUkVTSE9MRCkge1xuICAgICAgdGhpcy5zbG93UXVlcmllcy5wdXNoKHtcbiAgICAgICAgcXVlcnk6IHF1ZXJ5TmFtZSxcbiAgICAgICAgZHVyYXRpb24sXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBLZWVwIG9ubHkgbGFzdCAxMDAgc2xvdyBxdWVyaWVzXG4gICAgICBpZiAodGhpcy5zbG93UXVlcmllcy5sZW5ndGggPiAxMDApIHtcbiAgICAgICAgdGhpcy5zbG93UXVlcmllcy5zaGlmdCgpO1xuICAgICAgfVxuXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYXZlcmFnZSBxdWVyeSB0aW1lLlxuICAgKi9cbiAgZ2V0QXZlcmFnZVF1ZXJ5VGltZSgpOiBudW1iZXIge1xuICAgIGlmICh0aGlzLnF1ZXJ5VGltZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucXVlcnlUaW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHRoaXMucXVlcnlUaW1lcy5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBwZXJmb3JtYW5jZSBzdGF0aXN0aWNzLlxuICAgKi9cbiAgZ2V0UGVyZm9ybWFuY2VTdGF0cygpOiBhbnkge1xuICAgIGNvbnN0IGF2ZyA9IHRoaXMuZ2V0QXZlcmFnZVF1ZXJ5VGltZSgpO1xuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLnRoaXMucXVlcnlUaW1lcyk7XG4gICAgY29uc3QgbWluID0gTWF0aC5taW4oLi4udGhpcy5xdWVyeVRpbWVzKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhdmVyYWdlUXVlcnlUaW1lOiBgJHthdmcudG9GaXhlZCgyKX1tc2AsXG4gICAgICBtYXhRdWVyeVRpbWU6IGAke21heC50b0ZpeGVkKDIpfW1zYCxcbiAgICAgIG1pblF1ZXJ5VGltZTogYCR7bWluLnRvRml4ZWQoMil9bXNgLFxuICAgICAgdG90YWxRdWVyaWVzOiB0aGlzLnF1ZXJ5VGltZXMubGVuZ3RoLFxuICAgICAgc2xvd1F1ZXJpZXM6IHRoaXMuc2xvd1F1ZXJpZXMubGVuZ3RoLFxuICAgICAgcmVjZW50U2xvd1F1ZXJpZXM6IHRoaXMuc2xvd1F1ZXJpZXMuc2xpY2UoLTEwKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFByb3ZpZGVzIG9wdGltaXphdGlvbiByZWNvbW1lbmRhdGlvbnMuXG4gICAqL1xuICBnZXRPcHRpbWl6YXRpb25SZWNvbW1lbmRhdGlvbnMoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGF2ZyA9IHRoaXMuZ2V0QXZlcmFnZVF1ZXJ5VGltZSgpO1xuICAgIGNvbnN0IHJlY29tbWVuZGF0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmIChhdmcgPiAxMDApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdBdmVyYWdlIHF1ZXJ5IHRpbWUgZXhjZWVkcyAxMDBtcy4gQ29uc2lkZXIgYWRkaW5nIGRhdGFiYXNlIGluZGV4ZXMuJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc2xvd1F1ZXJpZXMubGVuZ3RoID4gMTApIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdNdWx0aXBsZSBzbG93IHF1ZXJpZXMgZGV0ZWN0ZWQuIFJldmlldyBhbmQgb3B0aW1pemUgZnJlcXVlbnQgcXVlcmllcy4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tb25TbG93UXVlcmllcyA9IHRoaXMuZ2V0Q29tbW9uU2xvd1F1ZXJpZXMoKTtcbiAgICBpZiAoY29tbW9uU2xvd1F1ZXJpZXMubGVuZ3RoID4gMCkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goYENvbW1vbiBzbG93IHF1ZXJpZXM6ICR7Y29tbW9uU2xvd1F1ZXJpZXMuam9pbignLCAnKX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVjb21tZW5kYXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIElkZW50aWZpZXMgY29tbW9ubHkgc2xvdyBxdWVyaWVzLlxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDb21tb25TbG93UXVlcmllcygpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcXVlcnlGcmVxdWVuY3k6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcblxuICAgIHRoaXMuc2xvd1F1ZXJpZXMuZm9yRWFjaCgoeyBxdWVyeSB9KSA9PiB7XG4gICAgICBxdWVyeUZyZXF1ZW5jeVtxdWVyeV0gPSAocXVlcnlGcmVxdWVuY3lbcXVlcnldIHx8IDApICsgMTtcbiAgICB9KTtcblxuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhxdWVyeUZyZXF1ZW5jeSlcbiAgICAgIC5maWx0ZXIoKFssIGNvdW50XSkgPT4gY291bnQgPiAyKVxuICAgICAgLm1hcCgoW3F1ZXJ5XSkgPT4gcXVlcnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0cyBwZXJmb3JtYW5jZSB0cmFja2luZyBkYXRhLlxuICAgKi9cbiAgcmVzZXQoKTogdm9pZCB7XG4gICAgdGhpcy5xdWVyeVRpbWVzID0gW107XG4gICAgdGhpcy5zbG93UXVlcmllcyA9IFtdO1xuICB9XG59XG5cbi8qKlxuICogR2xvYmFsIHBlcmZvcm1hbmNlIG1vbml0b3IgaW5zdGFuY2UuXG4gKi9cbmV4cG9ydCBjb25zdCBkYlBlcmZvcm1hbmNlTW9uaXRvciA9IG5ldyBEYXRhYmFzZVBlcmZvcm1hbmNlTW9uaXRvcigpO1xuXG4vKipcbiAqIERlY29yYXRvciBmb3IgdHJhY2tpbmcgZGF0YWJhc2Ugb3BlcmF0aW9uIHBlcmZvcm1hbmNlLlxuICogQHBhcmFtIHF1ZXJ5TmFtZVxuICovXG4vKipcbiAqIFRyYWNrUGVyZm9ybWFuY2UgZnVuY3Rpb24uXG4gKiBAcGFyYW0gcXVlcnlOYW1lXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0cmFja1BlcmZvcm1hbmNlKHF1ZXJ5TmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBhbnksIHByb3BlcnR5TmFtZTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBtZXRob2QgPSBkZXNjcmlwdG9yLnZhbHVlO1xuXG4gICAgZGVzY3JpcHRvci52YWx1ZSA9IGFzeW5jIGZ1bmN0aW9uICguLi5hcmdzOiB1bmtub3duW10pIHtcbiAgICAgIHJldHVybiBkYlBlcmZvcm1hbmNlTW9uaXRvci50cmFja1F1ZXJ5KHF1ZXJ5TmFtZSwgKCkgPT4gbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59XG4iXSwidmVyc2lvbiI6M30=