23e53754a01a0cb48658816a00fe87c3
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.delayedUpdateService = void 0;
const money_flow_automation_1 = require("./money-flow-automation");
const monthly_budget_service_1 = require("./monthly-budget-service");
/**
 * Service to handle delayed updates to money_flow and budget tables.
 * Waits 15 minutes after a dependency update before triggering regeneration.
 */
class DelayedUpdateService {
    /**
     *
     */
    constructor() {
        this.DELAY_MINUTES = 15;
        this.DELAY_MS = this.DELAY_MINUTES * 60 * 1000; // 15 minutes in milliseconds
        // Track pending updates to avoid duplicates
        this.pendingBillUpdates = new Set();
        this.pendingResidenceUpdates = new Set();
        this.pendingBuildingBudgetUpdates = new Set();
    }
    /**
     *
     */
    static getInstance() {
        if (!DelayedUpdateService.instance) {
            DelayedUpdateService.instance = new DelayedUpdateService();
        }
        return DelayedUpdateService.instance;
    }
    /**
     * Schedule money flow update for a bill after 15-minute delay.
     * @param billId
     */
    scheduleBillUpdate(billId) {
        // Avoid duplicate updates for the same bill
        if (this.pendingBillUpdates.has(billId)) {
            return;
        }
        this.pendingBillUpdates.add(billId);
        console.log(`‚è∞ Scheduling money flow update for bill ${billId} in ${this.DELAY_MINUTES} minutes`);
        setTimeout(async () => {
            try {
                // Generate money flow entries for the bill
                const moneyFlowEntries = await money_flow_automation_1.moneyFlowAutomationService.generateForBill(billId);
                // Get the building ID from the bill to update budgets
                const buildingId = await this.getBuildingIdFromBill(billId);
                if (buildingId) {
                    await this.scheduleBudgetUpdate(buildingId);
                }
            }
            finally {
                this.pendingBillUpdates.delete(billId);
            }
        }, this.DELAY_MS);
    }
    /**
     * Schedule money flow update for a residence after 15-minute delay.
     * @param residenceId
     */
    scheduleResidenceUpdate(residenceId) {
        // Avoid duplicate updates for the same residence
        if (this.pendingResidenceUpdates.has(residenceId)) {
            return;
        }
        this.pendingResidenceUpdates.add(residenceId);
        console.log(`‚è∞ Scheduling money flow update for residence ${residenceId} in ${this.DELAY_MINUTES} minutes`);
        setTimeout(async () => {
            try {
                // Generate money flow entries for the residence
                const moneyFlowEntries = await money_flow_automation_1.moneyFlowAutomationService.generateForResidence(residenceId);
                console.log(`üí∞ Generated ${moneyFlowEntries} money flow entries for residence ${residenceId}`);
                // Get the building ID from the residence to update budgets
                const buildingId = await this.getBuildingIdFromResidence(residenceId);
                if (buildingId) {
                    await this.scheduleBudgetUpdate(buildingId);
                }
            }
            finally {
                this.pendingResidenceUpdates.delete(residenceId);
            }
        }, this.DELAY_MS);
    }
    /**
     * Schedule budget update for a building after money flow changes.
     * This is called internally after money flow updates complete.
     * @param buildingId
     */
    async scheduleBudgetUpdate(buildingId) {
        // Avoid duplicate updates for the same building
        if (this.pendingBuildingBudgetUpdates.has(buildingId)) {
            console.log(`üè¢ Building ${buildingId} already has a pending budget update, skipping duplicate`);
            return;
        }
        this.pendingBuildingBudgetUpdates.add(buildingId);
        console.log(`‚è∞ Scheduling budget update for building ${buildingId} in ${this.DELAY_MINUTES} minutes`);
        setTimeout(async () => {
            try {
                // Repopulate budget entries for the building
                const budgetEntries = await monthly_budget_service_1.monthlyBudgetService.repopulateBudgetsForBuilding(buildingId);
            }
            finally {
                this.pendingBuildingBudgetUpdates.delete(buildingId);
            }
        }, this.DELAY_MS);
    }
    /**
     * Get building ID from bill ID.
     * @param billId
     */
    async getBuildingIdFromBill(billId) {
        try {
            const { db } = await Promise.resolve().then(() => __importStar(require('../db')));
            const { bills } = await Promise.resolve().then(() => __importStar(require('@shared/schema')));
            const { eq } = await Promise.resolve().then(() => __importStar(require('drizzle-orm')));
            const result = await db
                .select({ buildingId: bills.buildingId })
                .from(bills)
                .where(eq(bills.id, billId))
                .limit(1);
            return result.length > 0 ? result[0].buildingId : null;
        }
        catch (error) {
            console.error('‚ùå Error getting building ID:', error);
            return null;
        }
    }
    /**
     * Get building ID from residence ID.
     * @param residenceId
     */
    async getBuildingIdFromResidence(residenceId) {
        try {
            const { db } = await Promise.resolve().then(() => __importStar(require('../db')));
            const { residences } = await Promise.resolve().then(() => __importStar(require('@shared/schema')));
            const { eq } = await Promise.resolve().then(() => __importStar(require('drizzle-orm')));
            const result = await db
                .select({ buildingId: residences.buildingId })
                .from(residences)
                .where(eq(residences.id, residenceId))
                .limit(1);
            return result.length > 0 ? result[0].buildingId : null;
        }
        catch (error) {
            console.error('‚ùå Error getting building ID:', error);
            return null;
        }
    }
    /**
     * Force immediate update (for testing or urgent updates).
     * @param billId
     */
    async forceImmediateBillUpdate(billId) {
        // Generate money flow entries for the bill
        const moneyFlowEntries = await money_flow_automation_1.moneyFlowAutomationService.generateForBill(billId);
        // Update budget immediately
        const buildingId = await this.getBuildingIdFromBill(billId);
        if (buildingId) {
            const budgetEntries = await monthly_budget_service_1.monthlyBudgetService.repopulateBudgetsForBuilding(buildingId);
        }
    }
    /**
     * Force immediate update (for testing or urgent updates).
     * @param residenceId
     */
    async forceImmediateResidenceUpdate(residenceId) {
        // Generate money flow entries for the residence
        const moneyFlowEntries = await money_flow_automation_1.moneyFlowAutomationService.generateForResidence(residenceId);
        console.log(`üí∞ Generated ${moneyFlowEntries} money flow entries for residence ${residenceId}`);
        // Update budget immediately
        const buildingId = await this.getBuildingIdFromResidence(residenceId);
        if (buildingId) {
            const budgetEntries = await monthly_budget_service_1.monthlyBudgetService.repopulateBudgetsForBuilding(buildingId);
        }
    }
    /**
     * Get current status of pending updates.
     */
    getStatus() {
        return {
            delayMinutes: this.DELAY_MINUTES,
            pendingBillUpdates: this.pendingBillUpdates.size,
            pendingResidenceUpdates: this.pendingResidenceUpdates.size,
            pendingBudgetUpdates: this.pendingBuildingBudgetUpdates.size,
        };
    }
}
// Export singleton instance
exports.delayedUpdateService = DelayedUpdateService.getInstance();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvZGVsYXllZC11cGRhdGUtc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtRUFBcUU7QUFDckUscUVBQWdFO0FBRWhFOzs7R0FHRztBQUNILE1BQU0sb0JBQW9CO0lBVXhCOztPQUVHO0lBQ0g7UUFYaUIsa0JBQWEsR0FBRyxFQUFFLENBQUM7UUFDbkIsYUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLDZCQUE2QjtRQUV6Riw0Q0FBNEM7UUFDcEMsdUJBQWtCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUN2Qyw0QkFBdUIsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQzVDLGlDQUE0QixHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFNekQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFdBQVc7UUFDaEIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25DLG9CQUFvQixDQUFDLFFBQVEsR0FBRyxJQUFJLG9CQUFvQixFQUFFLENBQUM7UUFDN0QsQ0FBQztRQUNELE9BQU8sb0JBQW9CLENBQUMsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxrQkFBa0IsQ0FBQyxNQUFjO1FBQy9CLDRDQUE0QztRQUM1QyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUN4QyxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FDVCwyQ0FBMkMsTUFBTSxPQUFPLElBQUksQ0FBQyxhQUFhLFVBQVUsQ0FDckYsQ0FBQztRQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNwQixJ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QkFBMEIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0RSxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ2YsTUFBTSxhQUFhLEdBQUcsTUFBTSw2Q0FBb0IsQ0FBQyw0QkFBNEIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM1RixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQU1QLE9BQU87WUFDTCxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWE7WUFDaEMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUk7WUFDaEQsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUk7WUFDMUQsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUk7U0FDN0QsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUVELDRCQUE0QjtBQUNmLFFBQUEsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUMsV0FBVyxFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvZGVsYXllZC11cGRhdGUtc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtb25leUZsb3dBdXRvbWF0aW9uU2VydmljZSB9IGZyb20gJy4vbW9uZXktZmxvdy1hdXRvbWF0aW9uJztcbmltcG9ydCB7IG1vbnRobHlCdWRnZXRTZXJ2aWNlIH0gZnJvbSAnLi9tb250aGx5LWJ1ZGdldC1zZXJ2aWNlJztcblxuLyoqXG4gKiBTZXJ2aWNlIHRvIGhhbmRsZSBkZWxheWVkIHVwZGF0ZXMgdG8gbW9uZXlfZmxvdyBhbmQgYnVkZ2V0IHRhYmxlcy5cbiAqIFdhaXRzIDE1IG1pbnV0ZXMgYWZ0ZXIgYSBkZXBlbmRlbmN5IHVwZGF0ZSBiZWZvcmUgdHJpZ2dlcmluZyByZWdlbmVyYXRpb24uXG4gKi9cbmNsYXNzIERlbGF5ZWRVcGRhdGVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IERlbGF5ZWRVcGRhdGVTZXJ2aWNlO1xuICBwcml2YXRlIHJlYWRvbmx5IERFTEFZX01JTlVURVMgPSAxNTtcbiAgcHJpdmF0ZSByZWFkb25seSBERUxBWV9NUyA9IHRoaXMuREVMQVlfTUlOVVRFUyAqIDYwICogMTAwMDsgLy8gMTUgbWludXRlcyBpbiBtaWxsaXNlY29uZHNcblxuICAvLyBUcmFjayBwZW5kaW5nIHVwZGF0ZXMgdG8gYXZvaWQgZHVwbGljYXRlc1xuICBwcml2YXRlIHBlbmRpbmdCaWxsVXBkYXRlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICBwcml2YXRlIHBlbmRpbmdSZXNpZGVuY2VVcGRhdGVzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIHByaXZhdGUgcGVuZGluZ0J1aWxkaW5nQnVkZ2V0VXBkYXRlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gIC8qKlxuICAgKlxuICAgKi9cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKi9cbiAgc3RhdGljIGdldEluc3RhbmNlKCk6IERlbGF5ZWRVcGRhdGVTZXJ2aWNlIHtcbiAgICBpZiAoIURlbGF5ZWRVcGRhdGVTZXJ2aWNlLmluc3RhbmNlKSB7XG4gICAgICBEZWxheWVkVXBkYXRlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBEZWxheWVkVXBkYXRlU2VydmljZSgpO1xuICAgIH1cbiAgICByZXR1cm4gRGVsYXllZFVwZGF0ZVNlcnZpY2UuaW5zdGFuY2U7XG4gIH1cblxuICAvKipcbiAgICogU2NoZWR1bGUgbW9uZXkgZmxvdyB1cGRhdGUgZm9yIGEgYmlsbCBhZnRlciAxNS1taW51dGUgZGVsYXkuXG4gICAqIEBwYXJhbSBiaWxsSWRcbiAgICovXG4gIHNjaGVkdWxlQmlsbFVwZGF0ZShiaWxsSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIC8vIEF2b2lkIGR1cGxpY2F0ZSB1cGRhdGVzIGZvciB0aGUgc2FtZSBiaWxsXG4gICAgaWYgKHRoaXMucGVuZGluZ0JpbGxVcGRhdGVzLmhhcyhiaWxsSWQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nQmlsbFVwZGF0ZXMuYWRkKGJpbGxJZCk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBg4o+wIFNjaGVkdWxpbmcgbW9uZXkgZmxvdyB1cGRhdGUgZm9yIGJpbGwgJHtiaWxsSWR9IGluICR7dGhpcy5ERUxBWV9NSU5VVEVTfSBtaW51dGVzYFxuICAgICk7XG5cbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG5cbiAgICAgICAgLy8gR2VuZXJhdGUgbW9uZXkgZmxvdyBlbnRyaWVzIGZvciB0aGUgYmlsbFxuICAgICAgICBjb25zdCBtb25leUZsb3dFbnRyaWVzID0gYXdhaXQgbW9uZXlGbG93QXV0b21hdGlvblNlcnZpY2UuZ2VuZXJhdGVGb3JCaWxsKGJpbGxJZCk7XG5cbiAgICAgICAgLy8gR2V0IHRoZSBidWlsZGluZyBJRCBmcm9tIHRoZSBiaWxsIHRvIHVwZGF0ZSBidWRnZXRzXG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSBhd2FpdCB0aGlzLmdldEJ1aWxkaW5nSWRGcm9tQmlsbChiaWxsSWQpO1xuICAgICAgICBpZiAoYnVpbGRpbmdJZCkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc2NoZWR1bGVCdWRnZXRVcGRhdGUoYnVpbGRpbmdJZCk7XG4gICAgICAgIH1cbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHRoaXMucGVuZGluZ0JpbGxVcGRhdGVzLmRlbGV0ZShiaWxsSWQpO1xuICAgICAgfVxuICAgIH0sIHRoaXMuREVMQVlfTVMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlIG1vbmV5IGZsb3cgdXBkYXRlIGZvciBhIHJlc2lkZW5jZSBhZnRlciAxNS1taW51dGUgZGVsYXkuXG4gICAqIEBwYXJhbSByZXNpZGVuY2VJZFxuICAgKi9cbiAgc2NoZWR1bGVSZXNpZGVuY2VVcGRhdGUocmVzaWRlbmNlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIC8vIEF2b2lkIGR1cGxpY2F0ZSB1cGRhdGVzIGZvciB0aGUgc2FtZSByZXNpZGVuY2VcbiAgICBpZiAodGhpcy5wZW5kaW5nUmVzaWRlbmNlVXBkYXRlcy5oYXMocmVzaWRlbmNlSWQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nUmVzaWRlbmNlVXBkYXRlcy5hZGQocmVzaWRlbmNlSWQpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYOKPsCBTY2hlZHVsaW5nIG1vbmV5IGZsb3cgdXBkYXRlIGZvciByZXNpZGVuY2UgJHtyZXNpZGVuY2VJZH0gaW4gJHt0aGlzLkRFTEFZX01JTlVURVN9IG1pbnV0ZXNgXG4gICAgKTtcblxuICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcblxuICAgICAgICAvLyBHZW5lcmF0ZSBtb25leSBmbG93IGVudHJpZXMgZm9yIHRoZSByZXNpZGVuY2VcbiAgICAgICAgY29uc3QgbW9uZXlGbG93RW50cmllcyA9IGF3YWl0IG1vbmV5Rmxvd0F1dG9tYXRpb25TZXJ2aWNlLmdlbmVyYXRlRm9yUmVzaWRlbmNlKHJlc2lkZW5jZUlkKTtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYPCfkrAgR2VuZXJhdGVkICR7bW9uZXlGbG93RW50cmllc30gbW9uZXkgZmxvdyBlbnRyaWVzIGZvciByZXNpZGVuY2UgJHtyZXNpZGVuY2VJZH1gXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gR2V0IHRoZSBidWlsZGluZyBJRCBmcm9tIHRoZSByZXNpZGVuY2UgdG8gdXBkYXRlIGJ1ZGdldHNcbiAgICAgICAgY29uc3QgYnVpbGRpbmdJZCA9IGF3YWl0IHRoaXMuZ2V0QnVpbGRpbmdJZEZyb21SZXNpZGVuY2UocmVzaWRlbmNlSWQpO1xuICAgICAgICBpZiAoYnVpbGRpbmdJZCkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc2NoZWR1bGVCdWRnZXRVcGRhdGUoYnVpbGRpbmdJZCk7XG4gICAgICAgIH1cbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHRoaXMucGVuZGluZ1Jlc2lkZW5jZVVwZGF0ZXMuZGVsZXRlKHJlc2lkZW5jZUlkKTtcbiAgICAgIH1cbiAgICB9LCB0aGlzLkRFTEFZX01TKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTY2hlZHVsZSBidWRnZXQgdXBkYXRlIGZvciBhIGJ1aWxkaW5nIGFmdGVyIG1vbmV5IGZsb3cgY2hhbmdlcy5cbiAgICogVGhpcyBpcyBjYWxsZWQgaW50ZXJuYWxseSBhZnRlciBtb25leSBmbG93IHVwZGF0ZXMgY29tcGxldGUuXG4gICAqIEBwYXJhbSBidWlsZGluZ0lkXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHNjaGVkdWxlQnVkZ2V0VXBkYXRlKGJ1aWxkaW5nSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEF2b2lkIGR1cGxpY2F0ZSB1cGRhdGVzIGZvciB0aGUgc2FtZSBidWlsZGluZ1xuICAgIGlmICh0aGlzLnBlbmRpbmdCdWlsZGluZ0J1ZGdldFVwZGF0ZXMuaGFzKGJ1aWxkaW5nSWQpKSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYPCfj6IgQnVpbGRpbmcgJHtidWlsZGluZ0lkfSBhbHJlYWR5IGhhcyBhIHBlbmRpbmcgYnVkZ2V0IHVwZGF0ZSwgc2tpcHBpbmcgZHVwbGljYXRlYFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnBlbmRpbmdCdWlsZGluZ0J1ZGdldFVwZGF0ZXMuYWRkKGJ1aWxkaW5nSWQpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYOKPsCBTY2hlZHVsaW5nIGJ1ZGdldCB1cGRhdGUgZm9yIGJ1aWxkaW5nICR7YnVpbGRpbmdJZH0gaW4gJHt0aGlzLkRFTEFZX01JTlVURVN9IG1pbnV0ZXNgXG4gICAgKTtcblxuICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcblxuICAgICAgICAvLyBSZXBvcHVsYXRlIGJ1ZGdldCBlbnRyaWVzIGZvciB0aGUgYnVpbGRpbmdcbiAgICAgICAgY29uc3QgYnVkZ2V0RW50cmllcyA9IGF3YWl0IG1vbnRobHlCdWRnZXRTZXJ2aWNlLnJlcG9wdWxhdGVCdWRnZXRzRm9yQnVpbGRpbmcoYnVpbGRpbmdJZCk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICB0aGlzLnBlbmRpbmdCdWlsZGluZ0J1ZGdldFVwZGF0ZXMuZGVsZXRlKGJ1aWxkaW5nSWQpO1xuICAgICAgfVxuICAgIH0sIHRoaXMuREVMQVlfTVMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBidWlsZGluZyBJRCBmcm9tIGJpbGwgSUQuXG4gICAqIEBwYXJhbSBiaWxsSWRcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0QnVpbGRpbmdJZEZyb21CaWxsKGJpbGxJZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGIgfSA9IGF3YWl0IGltcG9ydCgnLi4vZGInKTtcbiAgICAgIGNvbnN0IHsgYmlsbHMgfSA9IGF3YWl0IGltcG9ydCgnQHNoYXJlZC9zY2hlbWEnKTtcbiAgICAgIGNvbnN0IHsgZXEgfSA9IGF3YWl0IGltcG9ydCgnZHJpenpsZS1vcm0nKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGJ1aWxkaW5nSWQ6IGJpbGxzLmJ1aWxkaW5nSWQgfSlcbiAgICAgICAgLmZyb20oYmlsbHMpXG4gICAgICAgIC53aGVyZShlcShiaWxscy5pZCwgYmlsbElkKSlcbiAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDAgPyByZXN1bHRbMF0uYnVpbGRpbmdJZCA6IG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGdldHRpbmcgYnVpbGRpbmcgSUQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBidWlsZGluZyBJRCBmcm9tIHJlc2lkZW5jZSBJRC5cbiAgICogQHBhcmFtIHJlc2lkZW5jZUlkXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEJ1aWxkaW5nSWRGcm9tUmVzaWRlbmNlKHJlc2lkZW5jZUlkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYiB9ID0gYXdhaXQgaW1wb3J0KCcuLi9kYicpO1xuICAgICAgY29uc3QgeyByZXNpZGVuY2VzIH0gPSBhd2FpdCBpbXBvcnQoJ0BzaGFyZWQvc2NoZW1hJyk7XG4gICAgICBjb25zdCB7IGVxIH0gPSBhd2FpdCBpbXBvcnQoJ2RyaXp6bGUtb3JtJyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoeyBidWlsZGluZ0lkOiByZXNpZGVuY2VzLmJ1aWxkaW5nSWQgfSlcbiAgICAgICAgLmZyb20ocmVzaWRlbmNlcylcbiAgICAgICAgLndoZXJlKGVxKHJlc2lkZW5jZXMuaWQsIHJlc2lkZW5jZUlkKSlcbiAgICAgICAgLmxpbWl0KDEpO1xuXG4gICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDAgPyByZXN1bHRbMF0uYnVpbGRpbmdJZCA6IG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGdldHRpbmcgYnVpbGRpbmcgSUQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZvcmNlIGltbWVkaWF0ZSB1cGRhdGUgKGZvciB0ZXN0aW5nIG9yIHVyZ2VudCB1cGRhdGVzKS5cbiAgICogQHBhcmFtIGJpbGxJZFxuICAgKi9cbiAgYXN5bmMgZm9yY2VJbW1lZGlhdGVCaWxsVXBkYXRlKGJpbGxJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cbiAgICAvLyBHZW5lcmF0ZSBtb25leSBmbG93IGVudHJpZXMgZm9yIHRoZSBiaWxsXG4gICAgY29uc3QgbW9uZXlGbG93RW50cmllcyA9IGF3YWl0IG1vbmV5Rmxvd0F1dG9tYXRpb25TZXJ2aWNlLmdlbmVyYXRlRm9yQmlsbChiaWxsSWQpO1xuXG4gICAgLy8gVXBkYXRlIGJ1ZGdldCBpbW1lZGlhdGVseVxuICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSBhd2FpdCB0aGlzLmdldEJ1aWxkaW5nSWRGcm9tQmlsbChiaWxsSWQpO1xuICAgIGlmIChidWlsZGluZ0lkKSB7XG4gICAgICBjb25zdCBidWRnZXRFbnRyaWVzID0gYXdhaXQgbW9udGhseUJ1ZGdldFNlcnZpY2UucmVwb3B1bGF0ZUJ1ZGdldHNGb3JCdWlsZGluZyhidWlsZGluZ0lkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRm9yY2UgaW1tZWRpYXRlIHVwZGF0ZSAoZm9yIHRlc3Rpbmcgb3IgdXJnZW50IHVwZGF0ZXMpLlxuICAgKiBAcGFyYW0gcmVzaWRlbmNlSWRcbiAgICovXG4gIGFzeW5jIGZvcmNlSW1tZWRpYXRlUmVzaWRlbmNlVXBkYXRlKHJlc2lkZW5jZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcblxuICAgIC8vIEdlbmVyYXRlIG1vbmV5IGZsb3cgZW50cmllcyBmb3IgdGhlIHJlc2lkZW5jZVxuICAgIGNvbnN0IG1vbmV5Rmxvd0VudHJpZXMgPSBhd2FpdCBtb25leUZsb3dBdXRvbWF0aW9uU2VydmljZS5nZW5lcmF0ZUZvclJlc2lkZW5jZShyZXNpZGVuY2VJZCk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBg8J+SsCBHZW5lcmF0ZWQgJHttb25leUZsb3dFbnRyaWVzfSBtb25leSBmbG93IGVudHJpZXMgZm9yIHJlc2lkZW5jZSAke3Jlc2lkZW5jZUlkfWBcbiAgICApO1xuXG4gICAgLy8gVXBkYXRlIGJ1ZGdldCBpbW1lZGlhdGVseVxuICAgIGNvbnN0IGJ1aWxkaW5nSWQgPSBhd2FpdCB0aGlzLmdldEJ1aWxkaW5nSWRGcm9tUmVzaWRlbmNlKHJlc2lkZW5jZUlkKTtcbiAgICBpZiAoYnVpbGRpbmdJZCkge1xuICAgICAgY29uc3QgYnVkZ2V0RW50cmllcyA9IGF3YWl0IG1vbnRobHlCdWRnZXRTZXJ2aWNlLnJlcG9wdWxhdGVCdWRnZXRzRm9yQnVpbGRpbmcoYnVpbGRpbmdJZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IHN0YXR1cyBvZiBwZW5kaW5nIHVwZGF0ZXMuXG4gICAqL1xuICBnZXRTdGF0dXMoKToge1xuICAgIGRlbGF5TWludXRlczogbnVtYmVyO1xuICAgIHBlbmRpbmdCaWxsVXBkYXRlczogbnVtYmVyO1xuICAgIHBlbmRpbmdSZXNpZGVuY2VVcGRhdGVzOiBudW1iZXI7XG4gICAgcGVuZGluZ0J1ZGdldFVwZGF0ZXM6IG51bWJlcjtcbiAgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlbGF5TWludXRlczogdGhpcy5ERUxBWV9NSU5VVEVTLFxuICAgICAgcGVuZGluZ0JpbGxVcGRhdGVzOiB0aGlzLnBlbmRpbmdCaWxsVXBkYXRlcy5zaXplLFxuICAgICAgcGVuZGluZ1Jlc2lkZW5jZVVwZGF0ZXM6IHRoaXMucGVuZGluZ1Jlc2lkZW5jZVVwZGF0ZXMuc2l6ZSxcbiAgICAgIHBlbmRpbmdCdWRnZXRVcGRhdGVzOiB0aGlzLnBlbmRpbmdCdWlsZGluZ0J1ZGdldFVwZGF0ZXMuc2l6ZSxcbiAgICB9O1xuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBkZWxheWVkVXBkYXRlU2VydmljZSA9IERlbGF5ZWRVcGRhdGVTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4iXSwidmVyc2lvbiI6M30=