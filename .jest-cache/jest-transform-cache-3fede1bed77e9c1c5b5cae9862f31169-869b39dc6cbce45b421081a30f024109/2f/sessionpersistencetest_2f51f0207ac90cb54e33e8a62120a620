4b88f9e876b19542c889a90274a3e5c3
"use strict";
/**
 * Critical Session Persistence Tests
 *
 * Tests for session loss scenarios that affect both development and production environments.
 * Detects issues with session storage, cookie management, and auth state persistence.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const supertest_1 = __importDefault(require("supertest"));
const express_1 = __importDefault(require("express"));
require("../setup");
const storage_1 = require("../../server/storage");
const auth_1 = require("../../server/auth");
(0, globals_1.describe)('Session Persistence Critical Tests', () => {
    let app;
    let testUser;
    let sessionCookie;
    (0, globals_1.beforeEach)(async () => {
        // Create test Express app with session management
        app = (0, express_1.default)();
        app.use(express_1.default.json());
        app.use(auth_1.sessionConfig);
        (0, auth_1.setupAuthRoutes)(app);
        // Create test user
        testUser = {
            email: 'test-session@koveo-gestion.com',
            password: await (0, auth_1.hashPassword)('TestPassword123!'),
            firstName: 'Session',
            lastName: 'Test',
            username: 'sessiontest',
            role: 'admin',
            isActive: true,
        };
        const createdUser = await storage_1.storage.createUser(testUser);
        testUser.id = createdUser.id;
    });
    (0, globals_1.afterEach)(async () => {
        // Clean up test user
        if (testUser?.id) {
            try {
                await storage_1.storage.deleteUser(testUser.id);
            }
            catch (error) {
                // User might already be deleted
            }
        }
    });
    (0, globals_1.describe)('Session Loss Detection', () => {
        (0, globals_1.it)('should maintain session after login and user check', async () => {
            // Step 1: Login and capture session cookie
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            (0, globals_1.expect)(loginResponse.body.user).toBeDefined();
            (0, globals_1.expect)(loginResponse.body.user.id).toBe(testUser.id);
            // Extract session cookie
            const cookies = loginResponse.headers['set-cookie'];
            (0, globals_1.expect)(cookies).toBeDefined();
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            (0, globals_1.expect)(sessionCookie).toBeDefined();
            // Step 2: Use session cookie to check user auth (should work)
            const userCheckResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            (0, globals_1.expect)(userCheckResponse.body.id).toBe(testUser.id);
            (0, globals_1.expect)(userCheckResponse.body.email).toBe(testUser.email);
            (0, globals_1.expect)(userCheckResponse.body.firstName).toBe('Session');
            (0, globals_1.expect)(userCheckResponse.body.lastName).toBe('Test');
            // Step 3: Make another request to ensure session persists
            const secondCheckResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            (0, globals_1.expect)(secondCheckResponse.body.id).toBe(testUser.id);
            (0, globals_1.expect)(secondCheckResponse.body.email).toBe(testUser.email);
        });
        (0, globals_1.it)('should detect session loss after multiple requests', async () => {
            // Login first
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Make multiple requests to simulate session usage
            for (let i = 0; i < 5; i++) {
                const response = await (0, supertest_1.default)(app)
                    .get('/api/auth/user')
                    .set('Cookie', sessionCookie);
                // Should maintain auth across all requests
                (0, globals_1.expect)(response.status).toBe(200);
                (0, globals_1.expect)(response.body.id).toBe(testUser.id);
                (0, globals_1.expect)(response.body.firstName).toBe('Session');
                (0, globals_1.expect)(response.body.lastName).toBe('Test');
                // Session should return defined user data, not "undefined undefined"
                (0, globals_1.expect)(response.body.firstName).not.toBe('undefined');
                (0, globals_1.expect)(response.body.lastName).not.toBe('undefined');
                (0, globals_1.expect)(response.body.email).not.toBe('undefined');
            }
        });
        (0, globals_1.it)('should handle session store connection issues gracefully', async () => {
            // Login successfully
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Verify session works
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Test session persistence under load
            const requests = Array.from({ length: 10 }, (_, i) => (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie));
            const responses = await Promise.all(requests);
            // All requests should succeed
            responses.forEach((response, index) => {
                (0, globals_1.expect)(response.status).toBe(200);
                (0, globals_1.expect)(response.body.id).toBe(testUser.id);
                (0, globals_1.expect)(response.body.firstName).toBe('Session');
                (0, globals_1.expect)(response.body.lastName).toBe('Test');
            });
        });
        (0, globals_1.it)('should properly handle session refresh and extension', async () => {
            // Login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Simulate multiple API calls that should extend session
            const initialCheck = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Wait a moment and make another request (simulates user activity)
            await new Promise(resolve => setTimeout(resolve, 100));
            const extendedCheck = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Both should return valid user data
            (0, globals_1.expect)(initialCheck.body.id).toBe(testUser.id);
            (0, globals_1.expect)(extendedCheck.body.id).toBe(testUser.id);
            (0, globals_1.expect)(extendedCheck.body.firstName).toBe('Session');
            (0, globals_1.expect)(extendedCheck.body.lastName).toBe('Test');
        });
        (0, globals_1.it)('should detect undefined user data patterns', async () => {
            // Login
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Check user data structure
            const userResponse = await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            const user = userResponse.body;
            // Ensure no undefined values that cause "undefined undefined" display
            (0, globals_1.expect)(user.firstName).toBeDefined();
            (0, globals_1.expect)(user.firstName).not.toBe('undefined');
            (0, globals_1.expect)(user.firstName).not.toBe(null);
            (0, globals_1.expect)(typeof user.firstName).toBe('string');
            (0, globals_1.expect)(user.firstName.length).toBeGreaterThan(0);
            (0, globals_1.expect)(user.lastName).toBeDefined();
            (0, globals_1.expect)(user.lastName).not.toBe('undefined');
            (0, globals_1.expect)(user.lastName).not.toBe(null);
            (0, globals_1.expect)(typeof user.lastName).toBe('string');
            (0, globals_1.expect)(user.lastName.length).toBeGreaterThan(0);
            (0, globals_1.expect)(user.email).toBeDefined();
            (0, globals_1.expect)(user.email).not.toBe('undefined');
            (0, globals_1.expect)(user.email).toBe(testUser.email);
            (0, globals_1.expect)(user.role).toBeDefined();
            (0, globals_1.expect)(user.role).not.toBe('undefined');
            (0, globals_1.expect)(user.role).toBe('admin');
            // Verify the complete user object structure
            (0, globals_1.expect)(user).toMatchObject({
                id: globals_1.expect.any(String),
                firstName: globals_1.expect.any(String),
                lastName: globals_1.expect.any(String),
                email: globals_1.expect.any(String),
                role: globals_1.expect.any(String),
                isActive: globals_1.expect.any(Boolean),
            });
        });
    });
    (0, globals_1.describe)('Session Cookie Management', () => {
        (0, globals_1.it)('should set proper cookie attributes for session persistence', async () => {
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            const sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            (0, globals_1.expect)(sessionCookie).toBeDefined();
            // Check cookie attributes for proper session management
            (0, globals_1.expect)(sessionCookie).toMatch(/HttpOnly/i);
            (0, globals_1.expect)(sessionCookie).toMatch(/Path=\//);
            // Should have a reasonable max age (7 days = 604800 seconds)
            (0, globals_1.expect)(sessionCookie).toMatch(/Max-Age=\d+/);
        });
        (0, globals_1.it)('should handle logout and clear session properly', async () => {
            // Login first
            const loginResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send({
                email: testUser.email,
                password: 'TestPassword123!',
            })
                .expect(200);
            const cookies = loginResponse.headers['set-cookie'];
            sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
            // Verify session works
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Logout
            const logoutResponse = await (0, supertest_1.default)(app)
                .post('/api/auth/logout')
                .set('Cookie', sessionCookie)
                .expect(200);
            // Verify session is cleared
            await (0, supertest_1.default)(app)
                .get('/api/auth/user')
                .set('Cookie', sessionCookie)
                .expect(401);
        });
    });
    (0, globals_1.describe)('Production Environment Simulation', () => {
        (0, globals_1.it)('should work with production-like cookie settings', async () => {
            // This test simulates production environment cookie behavior
            const originalNodeEnv = process.env.NODE_ENV;
            process.env.NODE_ENV = 'production';
            try {
                const loginResponse = await (0, supertest_1.default)(app)
                    .post('/api/auth/login')
                    .send({
                    email: testUser.email,
                    password: 'TestPassword123!',
                })
                    .expect(200);
                const cookies = loginResponse.headers['set-cookie'];
                sessionCookie = cookies.find((cookie) => cookie.startsWith('koveo.sid='));
                // Should still work with production cookie settings
                const userResponse = await (0, supertest_1.default)(app)
                    .get('/api/auth/user')
                    .set('Cookie', sessionCookie)
                    .expect(200);
                (0, globals_1.expect)(userResponse.body.id).toBe(testUser.id);
                (0, globals_1.expect)(userResponse.body.firstName).toBe('Session');
                (0, globals_1.expect)(userResponse.body.lastName).toBe('Test');
            }
            finally {
                process.env.NODE_ENV = originalNodeEnv;
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9jcml0aWNhbC9zZXNzaW9uLXBlcnNpc3RlbmNlLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7OztBQUVILDJDQUE0RTtBQUM1RSwwREFBZ0M7QUFDaEMsc0RBQThCO0FBQzlCLG9CQUFrQjtBQUNsQixrREFBK0M7QUFDL0MsNENBQWlGO0FBRWpGLElBQUEsa0JBQVEsRUFBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7SUFDbEQsSUFBSSxHQUFRLENBQUM7SUFDYixJQUFJLFFBQWEsQ0FBQztJQUNsQixJQUFJLGFBQXFCLENBQUM7SUFFMUIsSUFBQSxvQkFBVSxFQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLGtEQUFrRDtRQUNsRCxHQUFHLEdBQUcsSUFBQSxpQkFBTyxHQUFFLENBQUM7UUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDeEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxvQkFBYSxDQUFDLENBQUM7UUFDdkIsSUFBQSxzQkFBZSxFQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXJCLG1CQUFtQjtRQUNuQixRQUFRLEdBQUc7WUFDVCxLQUFLLEVBQUUsZ0NBQWdDO1lBQ3ZDLFFBQVEsRUFBRSxNQUFNLElBQUEsbUJBQVksRUFBQyxrQkFBa0IsQ0FBQztZQUNoRCxTQUFTLEVBQUUsU0FBUztZQUNwQixRQUFRLEVBQUUsTUFBTTtZQUNoQixRQUFRLEVBQUUsYUFBYTtZQUN2QixJQUFJLEVBQUUsT0FBZ0I7WUFDdEIsUUFBUSxFQUFFLElBQUk7U0FDZixDQUFDO1FBRUYsTUFBTSxXQUFXLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2RCxRQUFRLENBQUMsRUFBRSxHQUFHLFdBQVcsQ0FBQyxFQUFFLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLG1CQUFTLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIs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QUM7Z0JBRWYsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDcEQsYUFBYSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFFbEYsb0RBQW9EO2dCQUNwRCxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUEsbUJBQU8sRUFBQyxHQUFHLENBQUM7cUJBQ3BDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztxQkFDckIsR0FBRyxDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUM7cUJBQzVCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFZixJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUMvQyxJQUFBLGdCQUFNLEVBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3BELElBQUEsZ0JBQU0sRUFBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsRCxDQUFDO29CQUFTLENBQUM7Z0JBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsZUFBZSxDQUFDO1lBQ3pDLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9jcml0aWNhbC9zZXNzaW9uLXBlcnNpc3RlbmNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcml0aWNhbCBTZXNzaW9uIFBlcnNpc3RlbmNlIFRlc3RzXG4gKiBcbiAqIFRlc3RzIGZvciBzZXNzaW9uIGxvc3Mgc2NlbmFyaW9zIHRoYXQgYWZmZWN0IGJvdGggZGV2ZWxvcG1lbnQgYW5kIHByb2R1Y3Rpb24gZW52aXJvbm1lbnRzLlxuICogRGV0ZWN0cyBpc3N1ZXMgd2l0aCBzZXNzaW9uIHN0b3JhZ2UsIGNvb2tpZSBtYW5hZ2VtZW50LCBhbmQgYXV0aCBzdGF0ZSBwZXJzaXN0ZW5jZS5cbiAqL1xuXG5pbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCwgYmVmb3JlRWFjaCwgYWZ0ZXJFYWNoIH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdzdXBlcnRlc3QnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgJy4uL3NldHVwJztcbmltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tICcuLi8uLi9zZXJ2ZXIvc3RvcmFnZSc7XG5pbXBvcnQgeyBoYXNoUGFzc3dvcmQsIHNlc3Npb25Db25maWcsIHNldHVwQXV0aFJvdXRlcyB9IGZyb20gJy4uLy4uL3NlcnZlci9hdXRoJztcblxuZGVzY3JpYmUoJ1Nlc3Npb24gUGVyc2lzdGVuY2UgQ3JpdGljYWwgVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBhcHA6IGFueTtcbiAgbGV0IHRlc3RVc2VyOiBhbnk7XG4gIGxldCBzZXNzaW9uQ29va2llOiBzdHJpbmc7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ3JlYXRlIHRlc3QgRXhwcmVzcyBhcHAgd2l0aCBzZXNzaW9uIG1hbmFnZW1lbnRcbiAgICBhcHAgPSBleHByZXNzKCk7XG4gICAgYXBwLnVzZShleHByZXNzLmpzb24oKSk7XG4gICAgYXBwLnVzZShzZXNzaW9uQ29uZmlnKTtcbiAgICBzZXR1cEF1dGhSb3V0ZXMoYXBwKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCB1c2VyXG4gICAgdGVzdFVzZXIgPSB7XG4gICAgICBlbWFpbDogJ3Rlc3Qtc2Vzc2lvbkBrb3Zlby1nZXN0aW9uLmNvbScsXG4gICAgICBwYXNzd29yZDogYXdhaXQgaGFzaFBhc3N3b3JkKCdUZXN0UGFzc3dvcmQxMjMhJyksXG4gICAgICBmaXJzdE5hbWU6ICdTZXNzaW9uJyxcbiAgICAgIGxhc3ROYW1lOiAnVGVzdCcsXG4gICAgICB1c2VybmFtZTogJ3Nlc3Npb250ZXN0JyxcbiAgICAgIHJvbGU6ICdhZG1pbicgYXMgY29uc3QsXG4gICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICB9O1xuXG4gICAgY29uc3QgY3JlYXRlZFVzZXIgPSBhd2FpdCBzdG9yYWdlLmNyZWF0ZVVzZXIodGVzdFVzZXIpO1xuICAgIHRlc3RVc2VyLmlkID0gY3JlYXRlZFVzZXIuaWQ7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ2xlYW4gdXAgdGVzdCB1c2VyXG4gICAgaWYgKHRlc3RVc2VyPy5pZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc3RvcmFnZS5kZWxldGVVc2VyKHRlc3RVc2VyLmlkKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIFVzZXIgbWlnaHQgYWxyZWFkeSBiZSBkZWxldGVkXG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICBkZXNjcmliZSgnU2Vzc2lvbiBMb3NzIERldGVjdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIG1haW50YWluIHNlc3Npb24gYWZ0ZXIgbG9naW4gYW5kIHVzZXIgY2hlY2snLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTdGVwIDE6IExvZ2luIGFuZCBjYXB0dXJlIHNlc3Npb24gY29va2llXG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6IHRlc3RVc2VyLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAnVGVzdFBhc3N3b3JkMTIzIScsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgZXhwZWN0KGxvZ2luUmVzcG9uc2UuYm9keS51c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGxvZ2luUmVzcG9uc2UuYm9keS51c2VyLmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcblxuICAgICAgLy8gRXh0cmFjdCBzZXNzaW9uIGNvb2tpZVxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgICAgZXhwZWN0KGNvb2tpZXMpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvb2tpZSkudG9CZURlZmluZWQoKTtcblxuICAgICAgLy8gU3RlcCAyOiBVc2Ugc2Vzc2lvbiBjb29raWUgdG8gY2hlY2sgdXNlciBhdXRoIChzaG91bGQgd29yaylcbiAgICAgIGNvbnN0IHVzZXJDaGVja1Jlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBleHBlY3QodXNlckNoZWNrUmVzcG9uc2UuYm9keS5pZCkudG9CZSh0ZXN0VXNlci5pZCk7XG4gICAgICBleHBlY3QodXNlckNoZWNrUmVzcG9uc2UuYm9keS5lbWFpbCkudG9CZSh0ZXN0VXNlci5lbWFpbCk7XG4gICAgICBleHBlY3QodXNlckNoZWNrUmVzcG9uc2UuYm9keS5maXJzdE5hbWUpLnRvQmUoJ1Nlc3Npb24nKTtcbiAgICAgIGV4cGVjdCh1c2VyQ2hlY2tSZXNwb25zZS5ib2R5Lmxhc3ROYW1lKS50b0JlKCdUZXN0Jyk7XG5cbiAgICAgIC8vIFN0ZXAgMzogTWFrZSBhbm90aGVyIHJlcXVlc3QgdG8gZW5zdXJlIHNlc3Npb24gcGVyc2lzdHNcbiAgICAgIGNvbnN0IHNlY29uZENoZWNrUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChzZWNvbmRDaGVja1Jlc3BvbnNlLmJvZHkuaWQpLnRvQmUodGVzdFVzZXIuaWQpO1xuICAgICAgZXhwZWN0KHNlY29uZENoZWNrUmVzcG9uc2UuYm9keS5lbWFpbCkudG9CZSh0ZXN0VXNlci5lbWFpbCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBzZXNzaW9uIGxvc3MgYWZ0ZXIgbXVsdGlwbGUgcmVxdWVzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBMb2dpbiBmaXJzdFxuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgLnNlbmQoe1xuICAgICAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgICBwYXNzd29yZDogJ1Rlc3RQYXNzd29yZDEyMyEnLFxuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGNvbnN0IGNvb2tpZXMgPSBsb2dpblJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICAgIHNlc3Npb25Db29raWUgPSBjb29raWVzLmZpbmQoKGNvb2tpZTogc3RyaW5nKSA9PiBjb29raWUuc3RhcnRzV2l0aCgna292ZW8uc2lkPScpKTtcblxuICAgICAgLy8gTWFrZSBtdWx0aXBsZSByZXF1ZXN0cyB0byBzaW11bGF0ZSBzZXNzaW9uIHVzYWdlXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKTtcblxuICAgICAgICAvLyBTaG91bGQgbWFpbnRhaW4gYXV0aCBhY3Jvc3MgYWxsIHJlcXVlc3RzXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuaWQpLnRvQmUodGVzdFVzZXIuaWQpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5maXJzdE5hbWUpLnRvQmUoJ1Nlc3Npb24nKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubGFzdE5hbWUpLnRvQmUoJ1Rlc3QnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFNlc3Npb24gc2hvdWxkIHJldHVybiBkZWZpbmVkIHVzZXIgZGF0YSwgbm90IFwidW5kZWZpbmVkIHVuZGVmaW5lZFwiXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmZpcnN0TmFtZSkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5sYXN0TmFtZSkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lbWFpbCkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc2Vzc2lvbiBzdG9yZSBjb25uZWN0aW9uIGlzc3VlcyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTG9naW4gc3VjY2Vzc2Z1bGx5XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6IHRlc3RVc2VyLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAnVGVzdFBhc3N3b3JkMTIzIScsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgICAgc2Vzc2lvbkNvb2tpZSA9IGNvb2tpZXMuZmluZCgoY29va2llOiBzdHJpbmcpID0+IGNvb2tpZS5zdGFydHNXaXRoKCdrb3Zlby5zaWQ9JykpO1xuXG4gICAgICAvLyBWZXJpZnkgc2Vzc2lvbiB3b3Jrc1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBUZXN0IHNlc3Npb24gcGVyc2lzdGVuY2UgdW5kZXIgbG9hZFxuICAgICAgY29uc3QgcmVxdWVzdHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiAxMCB9LCAoXywgaSkgPT5cbiAgICAgICAgcmVxdWVzdChhcHApXG4gICAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICApO1xuXG4gICAgICBjb25zdCByZXNwb25zZXMgPSBhd2FpdCBQcm9taXNlLmFsbChyZXF1ZXN0cyk7XG4gICAgICBcbiAgICAgIC8vIEFsbCByZXF1ZXN0cyBzaG91bGQgc3VjY2VlZFxuICAgICAgcmVzcG9uc2VzLmZvckVhY2goKHJlc3BvbnNlLCBpbmRleCkgPT4ge1xuICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZmlyc3ROYW1lKS50b0JlKCdTZXNzaW9uJyk7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lmxhc3ROYW1lKS50b0JlKCdUZXN0Jyk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJvcGVybHkgaGFuZGxlIHNlc3Npb24gcmVmcmVzaCBhbmQgZXh0ZW5zaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTG9naW5cbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG5cbiAgICAgIC8vIFNpbXVsYXRlIG11bHRpcGxlIEFQSSBjYWxscyB0aGF0IHNob3VsZCBleHRlbmQgc2Vzc2lvblxuICAgICAgY29uc3QgaW5pdGlhbENoZWNrID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBXYWl0IGEgbW9tZW50IGFuZCBtYWtlIGFub3RoZXIgcmVxdWVzdCAoc2ltdWxhdGVzIHVzZXIgYWN0aXZpdHkpXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGV4dGVuZGVkQ2hlY2sgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIC8vIEJvdGggc2hvdWxkIHJldHVybiB2YWxpZCB1c2VyIGRhdGFcbiAgICAgIGV4cGVjdChpbml0aWFsQ2hlY2suYm9keS5pZCkudG9CZSh0ZXN0VXNlci5pZCk7XG4gICAgICBleHBlY3QoZXh0ZW5kZWRDaGVjay5ib2R5LmlkKS50b0JlKHRlc3RVc2VyLmlkKTtcbiAgICAgIGV4cGVjdChleHRlbmRlZENoZWNrLmJvZHkuZmlyc3ROYW1lKS50b0JlKCdTZXNzaW9uJyk7XG4gICAgICBleHBlY3QoZXh0ZW5kZWRDaGVjay5ib2R5Lmxhc3ROYW1lKS50b0JlKCdUZXN0Jyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCB1bmRlZmluZWQgdXNlciBkYXRhIHBhdHRlcm5zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTG9naW5cbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG5cbiAgICAgIC8vIENoZWNrIHVzZXIgZGF0YSBzdHJ1Y3R1cmVcbiAgICAgIGNvbnN0IHVzZXJSZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAuZ2V0KCcvYXBpL2F1dGgvdXNlcicpXG4gICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgdXNlciA9IHVzZXJSZXNwb25zZS5ib2R5O1xuXG4gICAgICAvLyBFbnN1cmUgbm8gdW5kZWZpbmVkIHZhbHVlcyB0aGF0IGNhdXNlIFwidW5kZWZpbmVkIHVuZGVmaW5lZFwiIGRpc3BsYXlcbiAgICAgIGV4cGVjdCh1c2VyLmZpcnN0TmFtZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyLmZpcnN0TmFtZSkubm90LnRvQmUoJ3VuZGVmaW5lZCcpO1xuICAgICAgZXhwZWN0KHVzZXIuZmlyc3ROYW1lKS5ub3QudG9CZShudWxsKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgdXNlci5maXJzdE5hbWUpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KHVzZXIuZmlyc3ROYW1lLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuXG4gICAgICBleHBlY3QodXNlci5sYXN0TmFtZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyLmxhc3ROYW1lKS5ub3QudG9CZSgndW5kZWZpbmVkJyk7XG4gICAgICBleHBlY3QodXNlci5sYXN0TmFtZSkubm90LnRvQmUobnVsbCk7XG4gICAgICBleHBlY3QodHlwZW9mIHVzZXIubGFzdE5hbWUpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgZXhwZWN0KHVzZXIubGFzdE5hbWUubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAgIGV4cGVjdCh1c2VyLmVtYWlsKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVzZXIuZW1haWwpLm5vdC50b0JlKCd1bmRlZmluZWQnKTtcbiAgICAgIGV4cGVjdCh1c2VyLmVtYWlsKS50b0JlKHRlc3RVc2VyLmVtYWlsKTtcblxuICAgICAgZXhwZWN0KHVzZXIucm9sZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyLnJvbGUpLm5vdC50b0JlKCd1bmRlZmluZWQnKTtcbiAgICAgIGV4cGVjdCh1c2VyLnJvbGUpLnRvQmUoJ2FkbWluJyk7XG5cbiAgICAgIC8vIFZlcmlmeSB0aGUgY29tcGxldGUgdXNlciBvYmplY3Qgc3RydWN0dXJlXG4gICAgICBleHBlY3QodXNlcikudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIGlkOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIGZpcnN0TmFtZTogZXhwZWN0LmFueShTdHJpbmcpLFxuICAgICAgICBsYXN0TmFtZTogZXhwZWN0LmFueShTdHJpbmcpLFxuICAgICAgICBlbWFpbDogZXhwZWN0LmFueShTdHJpbmcpLFxuICAgICAgICByb2xlOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgIGlzQWN0aXZlOiBleHBlY3QuYW55KEJvb2xlYW4pLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTZXNzaW9uIENvb2tpZSBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2V0IHByb3BlciBjb29raWUgYXR0cmlidXRlcyBmb3Igc2Vzc2lvbiBwZXJzaXN0ZW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzc3dvcmQxMjMhJyxcbiAgICAgICAgfSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICBjb25zdCBjb29raWVzID0gbG9naW5SZXNwb25zZS5oZWFkZXJzWydzZXQtY29va2llJ107XG4gICAgICBjb25zdCBzZXNzaW9uQ29va2llID0gY29va2llcy5maW5kKChjb29raWU6IHN0cmluZykgPT4gY29va2llLnN0YXJ0c1dpdGgoJ2tvdmVvLnNpZD0nKSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzZXNzaW9uQ29va2llKS50b0JlRGVmaW5lZCgpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBjb29raWUgYXR0cmlidXRlcyBmb3IgcHJvcGVyIHNlc3Npb24gbWFuYWdlbWVudFxuICAgICAgZXhwZWN0KHNlc3Npb25Db29raWUpLnRvTWF0Y2goL0h0dHBPbmx5L2kpO1xuICAgICAgZXhwZWN0KHNlc3Npb25Db29raWUpLnRvTWF0Y2goL1BhdGg9XFwvLyk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBoYXZlIGEgcmVhc29uYWJsZSBtYXggYWdlICg3IGRheXMgPSA2MDQ4MDAgc2Vjb25kcylcbiAgICAgIGV4cGVjdChzZXNzaW9uQ29va2llKS50b01hdGNoKC9NYXgtQWdlPVxcZCsvKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGxvZ291dCBhbmQgY2xlYXIgc2Vzc2lvbiBwcm9wZXJseScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIExvZ2luIGZpcnN0XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgZW1haWw6IHRlc3RVc2VyLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAnVGVzdFBhc3N3b3JkMTIzIScsXG4gICAgICAgIH0pXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgY29uc3QgY29va2llcyA9IGxvZ2luUmVzcG9uc2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgICAgc2Vzc2lvbkNvb2tpZSA9IGNvb2tpZXMuZmluZCgoY29va2llOiBzdHJpbmcpID0+IGNvb2tpZS5zdGFydHNXaXRoKCdrb3Zlby5zaWQ9JykpO1xuXG4gICAgICAvLyBWZXJpZnkgc2Vzc2lvbiB3b3Jrc1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvYXV0aC91c2VyJylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBMb2dvdXRcbiAgICAgIGNvbnN0IGxvZ291dFJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL2F1dGgvbG9nb3V0JylcbiAgICAgICAgLnNldCgnQ29va2llJywgc2Vzc2lvbkNvb2tpZSlcbiAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAvLyBWZXJpZnkgc2Vzc2lvbiBpcyBjbGVhcmVkXG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAuc2V0KCdDb29raWUnLCBzZXNzaW9uQ29va2llKVxuICAgICAgICAuZXhwZWN0KDQwMSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQcm9kdWN0aW9uIEVudmlyb25tZW50IFNpbXVsYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggcHJvZHVjdGlvbi1saWtlIGNvb2tpZSBzZXR0aW5ncycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFRoaXMgdGVzdCBzaW11bGF0ZXMgcHJvZHVjdGlvbiBlbnZpcm9ubWVudCBjb29raWUgYmVoYXZpb3JcbiAgICAgIGNvbnN0IG9yaWdpbmFsTm9kZUVudiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WO1xuICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSAncHJvZHVjdGlvbic7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcbiAgICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgICBwYXNzd29yZDogJ1Rlc3RQYXNzd29yZDEyMyEnLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAgIGNvbnN0IGNvb2tpZXMgPSBsb2dpblJlc3BvbnNlLmhlYWRlcnNbJ3NldC1jb29raWUnXTtcbiAgICAgICAgc2Vzc2lvbkNvb2tpZSA9IGNvb2tpZXMuZmluZCgoY29va2llOiBzdHJpbmcpID0+IGNvb2tpZS5zdGFydHNXaXRoKCdrb3Zlby5zaWQ9JykpO1xuXG4gICAgICAgIC8vIFNob3VsZCBzdGlsbCB3b3JrIHdpdGggcHJvZHVjdGlvbiBjb29raWUgc2V0dGluZ3NcbiAgICAgICAgY29uc3QgdXNlclJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgICAgLmdldCgnL2FwaS9hdXRoL3VzZXInKVxuICAgICAgICAgIC5zZXQoJ0Nvb2tpZScsIHNlc3Npb25Db29raWUpXG4gICAgICAgICAgLmV4cGVjdCgyMDApO1xuXG4gICAgICAgIGV4cGVjdCh1c2VyUmVzcG9uc2UuYm9keS5pZCkudG9CZSh0ZXN0VXNlci5pZCk7XG4gICAgICAgIGV4cGVjdCh1c2VyUmVzcG9uc2UuYm9keS5maXJzdE5hbWUpLnRvQmUoJ1Nlc3Npb24nKTtcbiAgICAgICAgZXhwZWN0KHVzZXJSZXNwb25zZS5ib2R5Lmxhc3ROYW1lKS50b0JlKCdUZXN0Jyk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9IG9yaWdpbmFsTm9kZUVudjtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=