23a0e06381dc11ef89c96c050f029299
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sessionConfig = void 0;
exports.hashPassword = hashPassword;
exports.verifyPassword = verifyPassword;
exports.requireAuth = requireAuth;
exports.requireRole = requireRole;
exports.authorize = authorize;
exports.setupAuthRoutes = setupAuthRoutes;
const express_session_1 = __importDefault(require("express-session"));
const connect_pg_simple_1 = __importDefault(require("connect-pg-simple"));
const crypto_1 = require("crypto");
const bcrypt = __importStar(require("bcryptjs"));
const storage_1 = require("./storage");
// Database-based permission checking - no config files needed
const serverless_1 = require("@neondatabase/serverless");
const schema = __importStar(require("../shared/schema"));
const drizzle_orm_1 = require("drizzle-orm");
const email_service_1 = require("./services/email-service");
const query_cache_1 = require("./query-cache");
/**
 * Check if a user role has a specific permission via database lookup.
 * @param userRole - The user's role (admin, manager, tenant, resident).
 * @param permissionName - The permission name (e.g., 'read:user', 'create:building').
 * @returns Promise<boolean> - True if user has permission.
 */
async function checkUserPermission(userRole, permissionName) {
    try {
        // Debug logging removed for production security
        // First check if permission exists at all
        const permissionExists = await db_1.db
            .select()
            .from(schema.permissions)
            .where((0, drizzle_orm_1.eq)(schema.permissions.name, permissionName))
            .limit(1);
        // Permission exists check complete
        // Check role permissions
        const rolePermissions = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole));
        // Role permissions checked
        const result = await db_1.db
            .select()
            .from(schema.rolePermissions)
            .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
            .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.rolePermissions.role, userRole), (0, drizzle_orm_1.eq)(schema.permissions.name, permissionName)))
            .limit(1);
        // Permission check completed
        if (result.length === 0) {
            // Permission not found
            // Debug: list all admin permissions
            if (userRole === 'admin') {
                const adminPerms = await db_1.db
                    .select({ name: schema.permissions.name })
                    .from(schema.rolePermissions)
                    .leftJoin(schema.permissions, (0, drizzle_orm_1.eq)(schema.rolePermissions.permissionId, schema.permissions.id))
                    .where((0, drizzle_orm_1.eq)(schema.rolePermissions.role, 'admin'));
                // Admin permissions debug removed for security
            }
        }
        return result.length > 0;
    }
    catch (error) {
        console.error('❌ Permission check failed:', error);
        return false;
    }
}
// Initialize email service
const emailService = new email_service_1.EmailService();
// Use shared database connection from db.ts to avoid multiple pools
const db_1 = require("./db");
// Configure session store with PostgreSQL
const PostgreSqlStore = (0, connect_pg_simple_1.default)(express_session_1.default);
/**
 * Session configuration for Quebec-compliant user authentication.
 * Uses PostgreSQL session store for scalability and Law 25 compliance.
 * Includes fallback for database connection issues in production.
 */
function createSessionStore() {
    try {
        // Create a proper PostgreSQL pool for the session store
        // connect-pg-simple needs a real PostgreSQL pool, not the Neon HTTP client
        const sessionPool = new serverless_1.Pool({
            connectionString: process.env.DATABASE_URL,
            max: 2, // Small pool for sessions
            min: 1,
        });
        // Use PostgreSQL session store for persistent sessions
        const store = new PostgreSqlStore({
            pool: sessionPool,
            tableName: 'session',
            createTableIfMissing: false, // Table already exists
            errorLog: process.env.NODE_ENV === 'test' ? () => { } : console.error, // Suppress error logging in tests
            // Add explicit configuration for session retrieval
            pruneSessionInterval: process.env.NODE_ENV === 'test' ? false : 60 * 1000, // Disable pruning in tests
            schemaName: 'public', // Explicitly set schema
        });
        console.log('✅ Session store: PostgreSQL session store created with proper pool');
        // Test the store connection (skip in test environment)
        if (process.env.NODE_ENV !== 'test') {
            store.get('test-session-id', (err, session) => {
                if (err) {
                    console.error('❌ Session store connection test failed:', err);
                }
                else {
                    console.log('✅ Session store connection test passed');
                }
            });
        }
        return store;
    }
    catch (error) {
        console.error('❌ Session store creation failed:', error);
        console.log('⚠️ Falling back to memory store (sessions will not persist)');
        return undefined; // Will use default memory store as fallback
    }
}
exports.sessionConfig = (0, express_session_1.default)({
    store: createSessionStore(), // Use PostgreSQL session store for persistence
    secret: process.env.SESSION_SECRET || 'fallback-secret-change-in-production',
    resave: false, // Don't save unchanged sessions
    saveUninitialized: false,
    rolling: true, // Reset expiry on each request
    cookie: {
        secure: false, // Keep false for development to ensure cookies work
        httpOnly: true,
        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days - longer session duration
        sameSite: 'lax',
        path: '/', // Explicitly set path
    },
    name: 'koveo.sid',
    proxy: false,
});
/**
 * Enhanced password hashing using bcrypt with salt for Quebec Law 25 compliance.
 * Provides strong security using industry-standard bcrypt algorithm
 * with configurable salt rounds (default: 12).
 *
 * @param {string} password - Plain text password to hash.
 * @returns {Promise<string>} Promise resolving to bcrypt hashed password.
 *
 * @example
 * ```typescript
 * const hashedPassword = await hashPassword('userPassword123');
 * // Store hashed password securely in database
 * await storage.createUser({ ...userData, password: hashedPassword });
 * ```
 */
/**
 * HashPassword function.
 * @param password
 * @returns Function result.
 */
async function hashPassword(password) {
    const saltRounds = 12; // Recommended for production
    return await bcrypt.hash(password, saltRounds);
}
/**
 * Verifies a password against stored bcrypt hash using constant-time comparison.
 * Uses bcrypt.compare for secure password verification.
 *
 * @param {string} password - Plain text password to verify.
 * @param {string} hashedPassword - Stored bcrypt hash from user record.
 * @returns {Promise<boolean>} Promise resolving to true if password matches, false otherwise.
 *
 * @example
 * ```typescript
 * const user = await storage.getUserByEmail(email);
 * const isValid = await verifyPassword(inputPassword, user.password);
 * if (isValid) {
 *   // Grant access
 * }
 * ```
 */
/**
 * VerifyPassword function.
 * @param password
 * @param hashedPassword
 * @returns Function result.
 */
async function verifyPassword(password, hashedPassword) {
    return await bcrypt.compare(password, hashedPassword);
}
/**
 * Authentication middleware to protect routes requiring user login.
 * Validates session existence, retrieves user data, and ensures account is active.
 * Automatically destroys invalid sessions for security.
 *
 * @param {Request} req - Express request object with session data.
 * @param {Response} res - Express response object for sending error responses.
 * @param {NextFunction} next - Express next function to continue to protected route.
 * @returns {Promise<void>} Promise that resolves when authentication is verified.
 *
 * @example
 * ```typescript
 * app.get('/api/protected-route', requireAuth, async (req, res) => {
 *   // req.user is now available and verified
 *   res.json({ userId: req.user.id });
 * });
 * ```
 */
/**
 * RequireAuth function.
 * @param req
 * @param res
 * @param next
 * @returns Function result.
 */
async function requireAuth(req, res, next) {
    if (!req.session?.userId) {
        return res.status(401).json({
            message: 'Authentication required',
            code: 'AUTH_REQUIRED',
        });
    }
    try {
        // Optimized session touch - only touch when session is close to expiring
        if (req.session && req.session.touch && req.session.cookie) {
            const now = Date.now();
            const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
            const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
            // Only touch session if more than 25% of its lifetime has passed
            if (sessionAge > sessionLifetime * 0.25) {
                req.session.touch();
            }
        }
        // Loading user session
        // Clear any cached user data for this ID to ensure fresh load
        query_cache_1.queryCache.invalidate('users', `user:${req.session.userId}`);
        query_cache_1.queryCache.invalidate('users', `user_email:*`);
        const user = await storage_1.storage.getUser(req.session.userId);
        // User loaded from session
        if (!user || !user.isActive) {
            req.session.destroy((err) => {
                if (err) {
                    // Session destruction error handled
                }
            });
            return res.status(401).json({
                message: 'User account not found or inactive',
                code: 'USER_INACTIVE',
            });
        }
        // Set session role (permissions handled via database)
        req.session.role = user.role;
        // Add organization information to the user object - with error handling for resilience
        let userOrganizations = [];
        try {
            userOrganizations = await db_1.db
                .select({
                organizationId: schema.userOrganizations.organizationId,
                canAccessAllOrganizations: schema.userOrganizations.canAccessAllOrganizations,
            })
                .from(schema.userOrganizations)
                .where((0, drizzle_orm_1.and)((0, drizzle_orm_1.eq)(schema.userOrganizations.userId, user.id), (0, drizzle_orm_1.eq)(schema.userOrganizations.isActive, true)));
        }
        catch (orgError) {
            // Organization lookup error handled gracefully
            // Continue with empty organizations - user can still authenticate
            userOrganizations = [];
        }
        // Enhanced user object with organization access information
        req.user = {
            ...user,
            organizations: userOrganizations.map((uo) => uo.organizationId),
            canAccessAllOrganizations: userOrganizations.some((uo) => uo.canAccessAllOrganizations),
        };
        // Special handling for hardcoded demo users - ensure they have proper organization access
        // Check if the user record has organization access configured
        if (user.role?.startsWith('demo_') &&
            (!req.user.organizations || req.user.organizations.length === 0)) {
            // Demo users should get access to demo organizations
            try {
                const demoOrgs = await db_1.db
                    .select({ id: schema.organizations.id })
                    .from(schema.organizations)
                    .where((0, drizzle_orm_1.eq)(schema.organizations.type, 'demo'))
                    .limit(1);
                if (demoOrgs.length > 0) {
                    // Adding organization access for demo user
                    req.user.organizations = [demoOrgs[0].id];
                    req.user.canAccessAllOrganizations = false;
                }
            }
            catch (demoOrgError) {
                // Demo organization lookup failed, continue without access
            }
        }
        next();
    }
    catch (error) {
        // Authentication error handled
        console.error('❌ Authentication error:', error);
        return res.status(500).json({
            message: 'Authentication error',
            code: 'AUTH_ERROR',
        });
    }
}
/**
 * Role-based authorization middleware factory for Quebec property management roles.
 * Creates middleware that restricts access based on user roles such as admin, manager, tenant.
 * Must be used after requireAuth middleware.
 *
 * @param {string[]} allowedRoles - Array of roles that can access the route (e.g., ['admin', 'manager']).
 * @returns {Function} Express middleware function for role validation.
 *
 * @example
 * ```typescript
 * // Only admins can access user management
 * app.get('/api/admin/users', requireAuth, requireRole(['admin']), getUserList);
 *
 * // Managers and admins can access building data
 * app.get('/api/buildings', requireAuth, requireRole(['admin', 'manager']), getBuildings);
 * ```
 */
/**
 * RequireRole function.
 * @param allowedRoles
 * @returns Function result.
 */
function requireRole(allowedRoles) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        if (!allowedRoles.includes(req.user.role)) {
            return res.status(403).json({
                message: 'Insufficient permissions',
                code: 'INSUFFICIENT_PERMISSIONS',
                required: allowedRoles,
                current: req.user.role,
            });
        }
        next();
    };
}
/**
 * Permission-based authorization middleware factory using the comprehensive RBAC system.
 * Validates user permissions based on the database RBAC system.
 * Must be used after requireAuth middleware.
 *
 * @param {string} permission - Specific permission required to access the route (e.g., 'read:bill', 'create:maintenance_request').
 * @returns {Function} Express middleware function for permission validation.
 *
 * @example
 * ```typescript
 * // Only users with 'read:bill' permission can access
 * app.get('/api/bills', requireAuth, authorize('read:bill'), getBills);
 *
 * // Only users with 'delete:user' permission can delete users
 * app.delete('/api/users/:id', requireAuth, authorize('delete:user'), deleteUser);
 *
 * // Multiple route protection
 * router.use(authorize('manage:building'));
 * router.post('/buildings', createBuilding);
 * router.patch('/buildings/:id', updateBuilding);
 * ```
 */
/**
 * Authorize function.
 * @param permission
 * @returns Function result.
 */
function authorize(permission) {
    return async (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                message: 'Authentication required',
                code: 'AUTH_REQUIRED',
            });
        }
        try {
            // Check if the user's role has the required permission via database
            const hasPermission = await checkUserPermission(req.user.role, permission);
            if (!hasPermission) {
                return res.status(403).json({
                    message: 'Insufficient permissions',
                    code: 'PERMISSION_DENIED',
                    required: permission,
                    userRole: req.user.role,
                    details: `User with role '${req.user.role}' does not have permission '${permission}'`,
                });
            }
            next();
        }
        catch (error) {
            // Authorization error handled
            console.error('❌ Authorization error:', error);
            return res.status(500).json({
                message: 'Authorization check failed',
                code: 'AUTHORIZATION_ERROR',
            });
        }
    };
}
/**
 * Sets up authentication routes for Quebec-compliant user management.
 * Implements login, logout, registration, and current user endpoints
 * with proper session management and Law 25 compliance considerations.
 *
 * @param {any} app - Express application instance to register routes on.
 * @returns {void} No return value - routes are registered directly on app.
 *
 * @example
 * ```typescript
 * const app = express();
 * app.use(sessionConfig);
 * setupAuthRoutes(app);
 * // Authentication routes are now available:
 * // POST /api/auth/login
 * // POST /api/auth/logout
 * // GET /api/auth/user
 * // POST /api/auth/register
 * ```
 */
/**
 * SetupAuthRoutes function.
 * @param app
 * @returns Function result.
 */
function setupAuthRoutes(app) {
    // Login route
    app.post('/api/auth/login', async (req, res) => {
        try {
            const { email, password } = req.body;
            // Login attempt initiated
            if (!email || !password) {
                return res.status(400).json({
                    message: 'Email and password are required',
                    code: 'MISSING_CREDENTIALS',
                });
            }
            // Retrieving user by email
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            if (!user.isActive) {
                return res.status(401).json({
                    message: 'Account is inactive',
                    code: 'ACCOUNT_INACTIVE',
                });
            }
            // Use bcrypt for password verification
            // Verifying password for user
            // Password verification initiated
            const isValidPassword = await verifyPassword(password, user.password);
            // Password verification completed
            if (!isValidPassword) {
                return res.status(401).json({
                    message: 'Invalid credentials',
                    code: 'INVALID_CREDENTIALS',
                });
            }
            // Update last login
            await storage_1.storage.updateUser(user.id, { lastLoginAt: new Date() });
            // Set session with user data
            req.session.userId = user.id;
            req.session.userRole = user.role;
            req.session.role = user.role;
            req.session.user = user; // Add complete user object for middleware compatibility
            // Save session explicitly to ensure it's persisted
            req.session.save((err) => {
                if (err) {
                    console.error('❌ Session save error:', err);
                    return res.status(500).json({
                        message: 'Session save failed',
                        code: 'SESSION_SAVE_ERROR',
                    });
                }
                // Return user data (without password)
                const { password: _, ...userData } = user;
                res.json({
                    user: userData,
                    message: 'Login successful',
                });
            });
        }
        catch (_error) {
            console.error('Login error:', {
                error: _error,
                email: req.body?.email,
                hasPassword: !!req.body?.password,
                databaseUrl: !!process.env.DATABASE_URL,
                sessionSecret: !!process.env.SESSION_SECRET,
            });
            res.status(500).json({
                message: 'Login failed',
                code: 'LOGIN_ERROR',
                ...(process.env.NODE_ENV === 'development' && { details: _error }),
            });
        }
    });
    // Logout route
    app.post('/api/auth/logout', (req, res) => {
        req.session.destroy((err) => {
            if (err) {
                console.error('Logout _error:', err);
                return res.status(500).json({
                    message: 'Logout failed',
                    code: 'LOGOUT_ERROR',
                });
            }
            // Clear cookie with same settings as when it was set
            const cookieOptions = {
                httpOnly: true,
                secure: process.env.NODE_ENV === 'production',
                sameSite: 'lax',
            };
            res.clearCookie('koveo.sid', cookieOptions);
            res.json({ message: 'Logout successful' });
        });
    });
    // Get current user route
    app.get('/api/auth/user', async (req, res) => {
        try {
            // Check user session
            // Check if we have a valid session with user ID
            if (!req.session?.userId) {
                // No session found
                return res.status(401).json({
                    message: 'Not authenticated',
                    code: 'NOT_AUTHENTICATED',
                });
            }
            // Try to get user from database
            try {
                const user = await storage_1.storage.getUser(req.session.userId);
                // User lookup completed
                if (!user || !user.isActive) {
                    // User not found or inactive, destroying session
                    req.session.destroy((err) => {
                        if (err) {
                            console.error('Session destruction error:', err);
                        }
                    });
                    return res.status(401).json({
                        message: 'User account not found or inactive',
                        code: 'USER_INACTIVE',
                    });
                }
                // Optimized session touch - only when needed
                if (req.session && req.session.touch && req.session.cookie) {
                    const now = Date.now();
                    const sessionAge = now - (req.session.cookie.originalMaxAge || 0) + (req.session.cookie.maxAge || 0);
                    const sessionLifetime = req.session.cookie.originalMaxAge || (7 * 24 * 60 * 60 * 1000);
                    // Only touch session if more than 25% of its lifetime has passed
                    if (sessionAge > sessionLifetime * 0.25) {
                        req.session.touch();
                    }
                }
                // Return user data without password
                const { password: _, ...userData } = user;
                // Successfully authenticated user
                res.json(userData);
            }
            catch (userError) {
                console.error('Database error getting user:', userError);
                return res.status(500).json({
                    message: 'Authentication check failed',
                    code: 'AUTH_CHECK_ERROR',
                });
            }
        }
        catch (error) {
            console.error('❌ Auth check error:', error);
            res.status(500).json({
                message: 'Authentication check failed',
                code: 'AUTH_CHECK_ERROR',
            });
        }
    });
    // Debug endpoint to check auth configuration (production only, temporary)
    app.get('/api/auth/debug', async (req, res) => {
        const debugInfo = {
            hasSession: !!req.session,
            sessionId: req.sessionID,
            userId: req.session?.userId,
            userRole: req.session?.userRole,
            nodeEnv: process.env.NODE_ENV,
            hasDatabaseUrl: !!process.env.DATABASE_URL,
            hasSessionSecret: !!process.env.SESSION_SECRET,
            cookies: req.headers.cookie ? 'present' : 'missing',
            cookieHeader: req.headers.cookie,
            sessionStore: req.session?.store?.constructor?.name || 'unknown',
            userAgent: req.headers['user-agent'],
            host: req.headers.host,
            protocol: req.protocol,
            secure: req.secure,
            trustProxy: !!req.app.get('trust proxy'),
        };
        console.log('Auth debug info:', debugInfo);
        res.json(debugInfo);
    });
    // Test cookie setting endpoint
    app.post('/api/auth/test-cookie', (req, res) => {
        // Set a test session value
        req.session.testValue = 'test-' + Date.now();
        req.session.save((err) => {
            if (err) {
                return res.status(500).json({ error: 'Failed to save session', details: err.message });
            }
            res.json({
                message: 'Test cookie set',
                sessionId: req.sessionID,
                testValue: req.session.testValue,
                cookieSettings: {
                    secure: process.env.NODE_ENV === 'production',
                    httpOnly: true,
                    sameSite: 'lax',
                },
            });
        });
    });
    // Register route (admin only for now)
    app.post('/api/auth/register', requireAuth, requireRole(['admin']), async (req, res) => {
        try {
            const { email, password, firstName, lastName, role = 'tenant', language = 'fr' } = req.body;
            if (!email || !password || !firstName || !lastName) {
                return res.status(400).json({
                    message: 'All fields are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Check if user already exists
            const existingUser = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (existingUser) {
                return res.status(409).json({
                    message: 'User already exists',
                    code: 'USER_EXISTS',
                });
            }
            // Create user with bcrypt hashed password
            const hashedPassword = await hashPassword(password);
            const newUser = await storage_1.storage.createUser({
                email: email.toLowerCase(),
                password: hashedPassword,
                firstName,
                lastName,
                username: email.toLowerCase(), // Use email as username
                role,
                language,
            });
            const { password: _, ...userData } = newUser;
            res.status(201).json({
                user: userData,
                message: 'User created successfully',
            });
        }
        catch (error) {
            console.error('❌ Registration error:', error);
            res.status(500).json({
                message: 'Registration failed',
                code: 'REGISTRATION_ERROR',
            });
        }
    });
    // Password Reset Request Route
    app.post('/api/auth/forgot-password', async (req, res) => {
        try {
            const { email } = req.body;
            if (!email) {
                return res.status(400).json({
                    message: 'Email is required',
                    code: 'MISSING_EMAIL',
                });
            }
            const user = await storage_1.storage.getUserByEmail(email.toLowerCase());
            if (!user || !user.isActive) {
                // Always respond with success for security (don't reveal if email exists)
                return res.json({
                    message: 'If this email exists, a password reset link has been sent.',
                    success: true,
                });
            }
            // Generate secure random token
            const resetToken = (0, crypto_1.randomBytes)(32).toString('hex');
            const tokenHash = (0, crypto_1.createHash)('sha256').update(resetToken).digest('hex');
            // Create password reset token (expires in 1 hour)
            const expiresAt = new Date();
            expiresAt.setHours(expiresAt.getHours() + 1);
            await storage_1.storage.createPasswordResetToken({
                userId: user.id,
                token: resetToken,
                tokenHash: tokenHash,
                expiresAt: expiresAt,
                ipAddress: req.ip || req.connection?.remoteAddress || 'unknown',
                userAgent: req.headers['user-agent'] || 'unknown',
            });
            // Send password reset email
            const host = req.get('host') || '';
            // Use development URL for Replit environments, production URL otherwise
            let frontendUrl;
            if (host.includes('replit.dev') ||
                host.includes('replit.com') ||
                host.includes('replit.co') ||
                process.env.NODE_ENV === 'development') {
                // Use the actual Replit development URL
                frontendUrl = `${req.protocol}://${host}`;
            }
            else {
                // Use production URL - prioritize koveo-gestion.com for production
                if (host.includes('koveo-gestion.com')) {
                    frontendUrl = `https://${host}`;
                }
                else {
                    frontendUrl = process.env.FRONTEND_URL || 'https://koveo-gestion.com';
                }
            }
            const cleanUrl = frontendUrl.endsWith('/') ? frontendUrl.slice(0, -1) : frontendUrl;
            const resetUrl = `${cleanUrl}/reset-password?token=${resetToken}`;
            const emailSent = await emailService.sendPasswordResetEmail(email.toLowerCase(), `${user.firstName} ${user.lastName}`, resetUrl);
            if (!emailSent) {
                console.error('Failed to send password reset email to:', email);
                return res.status(500).json({
                    message: 'Failed to send password reset email',
                    code: 'EMAIL_SEND_FAILED',
                });
            }
            res.json({
                message: 'If this email exists, a password reset link has been sent.',
                success: true,
            });
        }
        catch (error) {
            console.error('❌ Password reset request error:', error);
            res.status(500).json({
                message: 'Password reset request failed',
                code: 'PASSWORD_RESET_REQUEST_ERROR',
            });
        }
    });
    // Password Reset Route
    app.post('/api/auth/reset-password', async (req, res) => {
        try {
            const { token, password } = req.body;
            if (!token || !password) {
                return res.status(400).json({
                    message: 'Token and password are required',
                    code: 'MISSING_FIELDS',
                });
            }
            // Validate password strength
            if (password.length < 8) {
                return res.status(400).json({
                    message: 'Password must be at least 8 characters long',
                    code: 'PASSWORD_TOO_SHORT',
                });
            }
            // Check password complexity requirements
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
                return res.status(400).json({
                    message: 'Password must contain at least one uppercase letter, one lowercase letter, and one number',
                    code: 'PASSWORD_TOO_WEAK',
                });
            }
            // Find the password reset token
            const resetToken = await storage_1.storage.getPasswordResetToken(token);
            if (!resetToken) {
                return res.status(400).json({
                    message: 'Invalid or expired password reset token',
                    code: 'INVALID_TOKEN',
                });
            }
            // Check if token is expired
            if (new Date() > resetToken.expiresAt) {
                return res.status(400).json({
                    message: 'Password reset token has expired',
                    code: 'TOKEN_EXPIRED',
                });
            }
            // Check if token has already been used
            if (resetToken.isUsed) {
                return res.status(400).json({
                    message: 'Password reset token has already been used',
                    code: 'TOKEN_ALREADY_USED',
                });
            }
            // Verify token hash for additional security
            const tokenHash = (0, crypto_1.createHash)('sha256').update(token).digest('hex');
            if (tokenHash !== resetToken.tokenHash) {
                return res.status(400).json({
                    message: 'Invalid password reset token',
                    code: 'INVALID_TOKEN_HASH',
                });
            }
            // Get the user
            const user = await storage_1.storage.getUser(resetToken.userId);
            if (!user || !user.isActive) {
                return res.status(400).json({
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                });
            }
            // Update user password with bcrypt hashed version
            const hashedPassword = await hashPassword(password);
            await storage_1.storage.updateUser(user.id, {
                password: hashedPassword,
                updatedAt: new Date(),
            });
            // Mark token as used
            await storage_1.storage.markPasswordResetTokenAsUsed(resetToken.id);
            // Clean up expired tokens
            await storage_1.storage.cleanupExpiredPasswordResetTokens();
            res.json({
                message: 'Password has been reset successfully',
                success: true,
            });
        }
        catch (error) {
            console.error('❌ Password reset error:', error);
            res.status(500).json({
                message: 'Password reset failed',
                code: 'PASSWORD_RESET_ERROR',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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O1lBRUQsa0RBQWtEO1lBQ2xELE1BQU0sY0FBYyxHQUFHLE1BQU0sWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXBELE1BQU0saUJBQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDaEMsUUFBUSxFQUFFLGNBQWM7Z0JBQ3hCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDLENBQUM7WUFFSCxxQkFBcUI7WUFDckIsTUFBTSxpQkFBTyxDQUFDLDRCQUE0QixDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUxRCwwQkFBMEI7WUFDMUIsTUFBTSxpQkFBTyxDQUFDLGlDQUFpQyxFQUFFLENBQUM7WUFFbEQsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsc0NBQXNDO2dCQUMvQyxPQUFPLEVBQUUsSUFBSTthQUNkLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSx1QkFBdUI7Z0JBQ2hDLElBQUksRUFBRSxzQkFBc0I7YUFDN0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hdXRoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgY29ubmVjdFBnIGZyb20gJ2Nvbm5lY3QtcGctc2ltcGxlJztcbmltcG9ydCB7IGNyZWF0ZUhhc2gsIHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XG5pbXBvcnQgeyBzdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlJztcbmltcG9ydCB7IHNxbCB9IGZyb20gJy4vZGInO1xuaW1wb3J0IHR5cGUgeyBVc2VyIH0gZnJvbSAnQHNoYXJlZC9zY2hlbWEnO1xuLy8gRGF0YWJhc2UtYmFzZWQgcGVybWlzc2lvbiBjaGVja2luZyAtIG5vIGNvbmZpZyBmaWxlcyBuZWVkZWRcbmltcG9ydCB7IFBvb2wgfSBmcm9tICdAbmVvbmRhdGFiYXNlL3NlcnZlcmxlc3MnO1xuaW1wb3J0IHsgZHJpenpsZSB9IGZyb20gJ2RyaXp6bGUtb3JtL25lb24tc2VydmVybGVzcyc7XG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnLi4vc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyBlcSwgYW5kIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xuaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9lbWFpbC1zZXJ2aWNlJztcbmltcG9ydCB7IHF1ZXJ5Q2FjaGUgfSBmcm9tICcuL3F1ZXJ5LWNhY2hlJztcblxuLyoqXG4gKiBDaGVjayBpZiBhIHVzZXIgcm9sZSBoYXMgYSBzcGVjaWZpYyBwZXJtaXNzaW9uIHZpYSBkYXRhYmFzZSBsb29rdXAuXG4gKiBAcGFyYW0gdXNlclJvbGUgLSBUaGUgdXNlcidzIHJvbGUgKGFkbWluLCBtYW5hZ2VyLCB0ZW5hbnQsIHJlc2lkZW50KS5cbiAqIEBwYXJhbSBwZXJtaXNzaW9uTmFtZSAtIFRoZSBwZXJtaXNzaW9uIG5hbWUgKGUuZy4sICdyZWFkOnVzZXInLCAnY3JlYXRlOmJ1aWxkaW5nJykuXG4gKiBAcmV0dXJucyBQcm9taXNlPGJvb2xlYW4+IC0gVHJ1ZSBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uLlxuICovXG5hc3luYyBmdW5jdGlvbiBjaGVja1VzZXJQZXJtaXNzaW9uKHVzZXJSb2xlOiBzdHJpbmcsIHBlcm1pc3Npb25OYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICAvLyBEZWJ1ZyBsb2dnaW5nIHJlbW92ZWQgZm9yIHByb2R1Y3Rpb24gc2VjdXJpdHlcblxuICAgIC8vIEZpcnN0IGNoZWNrIGlmIHBlcm1pc3Npb24gZXhpc3RzIGF0IGFsbFxuICAgIGNvbnN0IHBlcm1pc3Npb25FeGlzdHMgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShzY2hlbWEucGVybWlzc2lvbnMpXG4gICAgICAud2hlcmUoZXEoc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUsIHBlcm1pc3Npb25OYW1lKSlcbiAgICAgIC5saW1pdCgxKTtcblxuICAgIC8vIFBlcm1pc3Npb24gZXhpc3RzIGNoZWNrIGNvbXBsZXRlXG5cbiAgICAvLyBDaGVjayByb2xlIHBlcm1pc3Npb25zXG4gICAgY29uc3Qgcm9sZVBlcm1pc3Npb25zID0gYXdhaXQgZGJcbiAgICAgIC5zZWxlY3QoKVxuICAgICAgLmZyb20oc2NoZW1hLnJvbGVQZXJtaXNzaW9ucylcbiAgICAgIC53aGVyZShlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsIHVzZXJSb2xlIGFzIGFueSkpO1xuXG4gICAgLy8gUm9sZSBwZXJtaXNzaW9ucyBjaGVja2VkXG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYlxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuZnJvbShzY2hlbWEucm9sZVBlcm1pc3Npb25zKVxuICAgICAgLmxlZnRKb2luKHNjaGVtYS5wZXJtaXNzaW9ucywgZXEoc2NoZW1hLnJvbGVQZXJtaXNzaW9ucy5wZXJtaXNzaW9uSWQsIHNjaGVtYS5wZXJtaXNzaW9ucy5pZCkpXG4gICAgICAud2hlcmUoXG4gICAgICAgIGFuZChcbiAgICAgICAgICBlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsIHVzZXJSb2xlIGFzIGFueSksXG4gICAgICAgICAgZXEoc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUsIHBlcm1pc3Npb25OYW1lKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAubGltaXQoMSk7XG5cbiAgICAvLyBQZXJtaXNzaW9uIGNoZWNrIGNvbXBsZXRlZFxuXG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIFBlcm1pc3Npb24gbm90IGZvdW5kXG4gICAgICAvLyBEZWJ1ZzogbGlzdCBhbGwgYWRtaW4gcGVybWlzc2lvbnNcbiAgICAgIGlmICh1c2VyUm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgICBjb25zdCBhZG1pblBlcm1zID0gYXdhaXQgZGJcbiAgICAgICAgICAuc2VsZWN0KHsgbmFtZTogc2NoZW1hLnBlcm1pc3Npb25zLm5hbWUgfSlcbiAgICAgICAgICAuZnJvbShzY2hlbWEucm9sZVBlcm1pc3Npb25zKVxuICAgICAgICAgIC5sZWZ0Sm9pbihcbiAgICAgICAgICAgIHNjaGVtYS5wZXJtaXNzaW9ucyxcbiAgICAgICAgICAgIGVxKHNjaGVtYS5yb2xlUGVybWlzc2lvbnMucGVybWlzc2lvbklkLCBzY2hlbWEucGVybWlzc2lvbnMuaWQpXG4gICAgICAgICAgKVxuICAgICAgICAgIC53aGVyZShlcShzY2hlbWEucm9sZVBlcm1pc3Npb25zLnJvbGUsICdhZG1pbicpKTtcbiAgICAgICAgLy8gQWRtaW4gcGVybWlzc2lvbnMgZGVidWcgcmVtb3ZlZCBmb3Igc2VjdXJpdHlcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA+IDA7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgUGVybWlzc2lvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vLyBJbml0aWFsaXplIGVtYWlsIHNlcnZpY2VcbmNvbnN0IGVtYWlsU2VydmljZSA9IG5ldyBFbWFpbFNlcnZpY2UoKTtcblxuLy8gVXNlIHNoYXJlZCBkYXRhYmFzZSBjb25uZWN0aW9uIGZyb20gZGIudHMgdG8gYXZvaWQgbXVsdGlwbGUgcG9vbHNcbmltcG9ydCB7IGRiLCBwb29sIH0gZnJvbSAnLi9kYic7XG5cbi8vIENvbmZpZ3VyZSBzZXNzaW9uIHN0b3JlIHdpdGggUG9zdGdyZVNRTFxuY29uc3QgUG9zdGdyZVNxbFN0b3JlID0gY29ubmVjdFBnKHNlc3Npb24pO1xuXG4vKipcbiAqIFNlc3Npb24gY29uZmlndXJhdGlvbiBmb3IgUXVlYmVjLWNvbXBsaWFudCB1c2VyIGF1dGhlbnRpY2F0aW9uLlxuICogVXNlcyBQb3N0Z3JlU1FMIHNlc3Npb24gc3RvcmUgZm9yIHNjYWxhYmlsaXR5IGFuZCBMYXcgMjUgY29tcGxpYW5jZS5cbiAqIEluY2x1ZGVzIGZhbGxiYWNrIGZvciBkYXRhYmFzZSBjb25uZWN0aW9uIGlzc3VlcyBpbiBwcm9kdWN0aW9uLlxuICovXG5mdW5jdGlvbiBjcmVhdGVTZXNzaW9uU3RvcmUoKSB7XG4gIHRyeSB7XG4gICAgLy8gQ3JlYXRlIGEgcHJvcGVyIFBvc3RncmVTUUwgcG9vbCBmb3IgdGhlIHNlc3Npb24gc3RvcmVcbiAgICAvLyBjb25uZWN0LXBnLXNpbXBsZSBuZWVkcyBhIHJlYWwgUG9zdGdyZVNRTCBwb29sLCBub3QgdGhlIE5lb24gSFRUUCBjbGllbnRcbiAgICBjb25zdCBzZXNzaW9uUG9vbCA9IG5ldyBQb29sKHsgXG4gICAgICBjb25uZWN0aW9uU3RyaW5nOiBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwsXG4gICAgICBtYXg6IDIsIC8vIFNtYWxsIHBvb2wgZm9yIHNlc3Npb25zXG4gICAgICBtaW46IDEsXG4gICAgfSk7XG4gICAgXG4gICAgLy8gVXNlIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3IgcGVyc2lzdGVudCBzZXNzaW9uc1xuICAgIGNvbnN0IHN0b3JlID0gbmV3IFBvc3RncmVTcWxTdG9yZSh7XG4gICAgICBwb29sOiBzZXNzaW9uUG9vbCxcbiAgICAgIHRhYmxlTmFtZTogJ3Nlc3Npb24nLFxuICAgICAgY3JlYXRlVGFibGVJZk1pc3Npbmc6IGZhbHNlLCAvLyBUYWJsZSBhbHJlYWR5IGV4aXN0c1xuICAgICAgZXJyb3JMb2c6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAndGVzdCcgPyAoKSA9PiB7fSA6IGNvbnNvbGUuZXJyb3IsIC8vIFN1cHByZXNzIGVycm9yIGxvZ2dpbmcgaW4gdGVzdHNcbiAgICAgIFxuICAgICAgLy8gQWRkIGV4cGxpY2l0IGNvbmZpZ3VyYXRpb24gZm9yIHNlc3Npb24gcmV0cmlldmFsXG4gICAgICBwcnVuZVNlc3Npb25JbnRlcnZhbDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyA/IGZhbHNlIDogNjAgKiAxMDAwLCAvLyBEaXNhYmxlIHBydW5pbmcgaW4gdGVzdHNcbiAgICAgIHNjaGVtYU5hbWU6ICdwdWJsaWMnLCAvLyBFeHBsaWNpdGx5IHNldCBzY2hlbWFcbiAgICB9KTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygn4pyFIFNlc3Npb24gc3RvcmU6IFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBjcmVhdGVkIHdpdGggcHJvcGVyIHBvb2wnKTtcbiAgICBcbiAgICAvLyBUZXN0IHRoZSBzdG9yZSBjb25uZWN0aW9uIChza2lwIGluIHRlc3QgZW52aXJvbm1lbnQpXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcpIHtcbiAgICAgIHN0b3JlLmdldCgndGVzdC1zZXNzaW9uLWlkJywgKGVyciwgc2Vzc2lvbikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc3RvcmUgY29ubmVjdGlvbiB0ZXN0IGZhaWxlZDonLCBlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCfinIUgU2Vzc2lvbiBzdG9yZSBjb25uZWN0aW9uIHRlc3QgcGFzc2VkJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gc3RvcmU7XG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgU2Vzc2lvbiBzdG9yZSBjcmVhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIGNvbnNvbGUubG9nKCfimqDvuI8gRmFsbGluZyBiYWNrIHRvIG1lbW9yeSBzdG9yZSAoc2Vzc2lvbnMgd2lsbCBub3QgcGVyc2lzdCknKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkOyAvLyBXaWxsIHVzZSBkZWZhdWx0IG1lbW9yeSBzdG9yZSBhcyBmYWxsYmFja1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBzZXNzaW9uQ29uZmlnID0gc2Vzc2lvbih7XG4gIHN0b3JlOiBjcmVhdGVTZXNzaW9uU3RvcmUoKSwgLy8gVXNlIFBvc3RncmVTUUwgc2Vzc2lvbiBzdG9yZSBmb3IgcGVyc2lzdGVuY2VcbiAgc2VjcmV0OiBwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCB8fCAnZmFsbGJhY2stc2VjcmV0LWNoYW5nZS1pbi1wcm9kdWN0aW9uJyxcbiAgcmVzYXZlOiBmYWxzZSwgLy8gRG9uJ3Qgc2F2ZSB1bmNoYW5nZWQgc2Vzc2lvbnNcbiAgc2F2ZVVuaW5pdGlhbGl6ZWQ6IGZhbHNlLFxuICByb2xsaW5nOiB0cnVlLCAvLyBSZXNldCBleHBpcnkgb24gZWFjaCByZXF1ZXN0XG4gIGNvb2tpZToge1xuICAgIHNlY3VyZTogZmFsc2UsIC8vIEtlZXAgZmFsc2UgZm9yIGRldmVsb3BtZW50IHRvIGVuc3VyZSBjb29raWVzIHdvcmtcbiAgICBodHRwT25seTogdHJ1ZSxcbiAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLCAvLyA3IGRheXMgLSBsb25nZXIgc2Vzc2lvbiBkdXJhdGlvblxuICAgIHNhbWVTaXRlOiAnbGF4JyxcbiAgICBwYXRoOiAnLycsIC8vIEV4cGxpY2l0bHkgc2V0IHBhdGhcbiAgfSxcbiAgbmFtZTogJ2tvdmVvLnNpZCcsXG4gIHByb3h5OiBmYWxzZSxcbn0pO1xuXG4vKipcbiAqIEVuaGFuY2VkIHBhc3N3b3JkIGhhc2hpbmcgdXNpbmcgYmNyeXB0IHdpdGggc2FsdCBmb3IgUXVlYmVjIExhdyAyNSBjb21wbGlhbmNlLlxuICogUHJvdmlkZXMgc3Ryb25nIHNlY3VyaXR5IHVzaW5nIGluZHVzdHJ5LXN0YW5kYXJkIGJjcnlwdCBhbGdvcml0aG1cbiAqIHdpdGggY29uZmlndXJhYmxlIHNhbHQgcm91bmRzIChkZWZhdWx0OiAxMikuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhc3N3b3JkIC0gUGxhaW4gdGV4dCBwYXNzd29yZCB0byBoYXNoLlxuICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gUHJvbWlzZSByZXNvbHZpbmcgdG8gYmNyeXB0IGhhc2hlZCBwYXNzd29yZC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBoYXNoUGFzc3dvcmQoJ3VzZXJQYXNzd29yZDEyMycpO1xuICogLy8gU3RvcmUgaGFzaGVkIHBhc3N3b3JkIHNlY3VyZWx5IGluIGRhdGFiYXNlXG4gKiBhd2FpdCBzdG9yYWdlLmNyZWF0ZVVzZXIoeyAuLi51c2VyRGF0YSwgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkIH0pO1xuICogYGBgXG4gKi9cbi8qKlxuICogSGFzaFBhc3N3b3JkIGZ1bmN0aW9uLlxuICogQHBhcmFtIHBhc3N3b3JkXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYXNoUGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHNhbHRSb3VuZHMgPSAxMjsgLy8gUmVjb21tZW5kZWQgZm9yIHByb2R1Y3Rpb25cbiAgcmV0dXJuIGF3YWl0IGJjcnlwdC5oYXNoKHBhc3N3b3JkLCBzYWx0Um91bmRzKTtcbn1cblxuLyoqXG4gKiBWZXJpZmllcyBhIHBhc3N3b3JkIGFnYWluc3Qgc3RvcmVkIGJjcnlwdCBoYXNoIHVzaW5nIGNvbnN0YW50LXRpbWUgY29tcGFyaXNvbi5cbiAqIFVzZXMgYmNyeXB0LmNvbXBhcmUgZm9yIHNlY3VyZSBwYXNzd29yZCB2ZXJpZmljYXRpb24uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhc3N3b3JkIC0gUGxhaW4gdGV4dCBwYXNzd29yZCB0byB2ZXJpZnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gaGFzaGVkUGFzc3dvcmQgLSBTdG9yZWQgYmNyeXB0IGhhc2ggZnJvbSB1c2VyIHJlY29yZC5cbiAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBQcm9taXNlIHJlc29sdmluZyB0byB0cnVlIGlmIHBhc3N3b3JkIG1hdGNoZXMsIGZhbHNlIG90aGVyd2lzZS5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICogY29uc3QgaXNWYWxpZCA9IGF3YWl0IHZlcmlmeVBhc3N3b3JkKGlucHV0UGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xuICogaWYgKGlzVmFsaWQpIHtcbiAqICAgLy8gR3JhbnQgYWNjZXNzXG4gKiB9XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBWZXJpZnlQYXNzd29yZCBmdW5jdGlvbi5cbiAqIEBwYXJhbSBwYXNzd29yZFxuICogQHBhcmFtIGhhc2hlZFBhc3N3b3JkXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlQYXNzd29yZChwYXNzd29yZDogc3RyaW5nLCBoYXNoZWRQYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHJldHVybiBhd2FpdCBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgaGFzaGVkUGFzc3dvcmQpO1xufVxuXG4vKipcbiAqIEF1dGhlbnRpY2F0aW9uIG1pZGRsZXdhcmUgdG8gcHJvdGVjdCByb3V0ZXMgcmVxdWlyaW5nIHVzZXIgbG9naW4uXG4gKiBWYWxpZGF0ZXMgc2Vzc2lvbiBleGlzdGVuY2UsIHJldHJpZXZlcyB1c2VyIGRhdGEsIGFuZCBlbnN1cmVzIGFjY291bnQgaXMgYWN0aXZlLlxuICogQXV0b21hdGljYWxseSBkZXN0cm95cyBpbnZhbGlkIHNlc3Npb25zIGZvciBzZWN1cml0eS5cbiAqXG4gKiBAcGFyYW0ge1JlcXVlc3R9IHJlcSAtIEV4cHJlc3MgcmVxdWVzdCBvYmplY3Qgd2l0aCBzZXNzaW9uIGRhdGEuXG4gKiBAcGFyYW0ge1Jlc3BvbnNlfSByZXMgLSBFeHByZXNzIHJlc3BvbnNlIG9iamVjdCBmb3Igc2VuZGluZyBlcnJvciByZXNwb25zZXMuXG4gKiBAcGFyYW0ge05leHRGdW5jdGlvbn0gbmV4dCAtIEV4cHJlc3MgbmV4dCBmdW5jdGlvbiB0byBjb250aW51ZSB0byBwcm90ZWN0ZWQgcm91dGUuXG4gKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gUHJvbWlzZSB0aGF0IHJlc29sdmVzIHdoZW4gYXV0aGVudGljYXRpb24gaXMgdmVyaWZpZWQuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIGFwcC5nZXQoJy9hcGkvcHJvdGVjdGVkLXJvdXRlJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICogICAvLyByZXEudXNlciBpcyBub3cgYXZhaWxhYmxlIGFuZCB2ZXJpZmllZFxuICogICByZXMuanNvbih7IHVzZXJJZDogcmVxLnVzZXIuaWQgfSk7XG4gKiB9KTtcbiAqIGBgYFxuICovXG4vKipcbiAqIFJlcXVpcmVBdXRoIGZ1bmN0aW9uLlxuICogQHBhcmFtIHJlcVxuICogQHBhcmFtIHJlc1xuICogQHBhcmFtIG5leHRcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVBdXRoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gIGlmICghcmVxLnNlc3Npb24/LnVzZXJJZCkge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBPcHRpbWl6ZWQgc2Vzc2lvbiB0b3VjaCAtIG9ubHkgdG91Y2ggd2hlbiBzZXNzaW9uIGlzIGNsb3NlIHRvIGV4cGlyaW5nXG4gICAgaWYgKHJlcS5zZXNzaW9uICYmIHJlcS5zZXNzaW9uLnRvdWNoICYmIHJlcS5zZXNzaW9uLmNvb2tpZSkge1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIGNvbnN0IHNlc3Npb25BZ2UgPSBub3cgLSAocmVxLnNlc3Npb24uY29va2llLm9yaWdpbmFsTWF4QWdlIHx8IDApICsgKHJlcS5zZXNzaW9uLmNvb2tpZS5tYXhBZ2UgfHwgMCk7XG4gICAgICBjb25zdCBzZXNzaW9uTGlmZXRpbWUgPSByZXEuc2Vzc2lvbi5jb29raWUub3JpZ2luYWxNYXhBZ2UgfHwgKDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgIFxuICAgICAgLy8gT25seSB0b3VjaCBzZXNzaW9uIGlmIG1vcmUgdGhhbiAyNSUgb2YgaXRzIGxpZmV0aW1lIGhhcyBwYXNzZWRcbiAgICAgIGlmIChzZXNzaW9uQWdlID4gc2Vzc2lvbkxpZmV0aW1lICogMC4yNSkge1xuICAgICAgICByZXEuc2Vzc2lvbi50b3VjaCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIExvYWRpbmcgdXNlciBzZXNzaW9uXG5cbiAgICAvLyBDbGVhciBhbnkgY2FjaGVkIHVzZXIgZGF0YSBmb3IgdGhpcyBJRCB0byBlbnN1cmUgZnJlc2ggbG9hZFxuICAgIHF1ZXJ5Q2FjaGUuaW52YWxpZGF0ZSgndXNlcnMnLCBgdXNlcjoke3JlcS5zZXNzaW9uLnVzZXJJZH1gKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ3VzZXJzJywgYHVzZXJfZW1haWw6KmApO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlcihyZXEuc2Vzc2lvbi51c2VySWQpO1xuICAgIC8vIFVzZXIgbG9hZGVkIGZyb20gc2Vzc2lvblxuICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAvLyBTZXNzaW9uIGRlc3RydWN0aW9uIGVycm9yIGhhbmRsZWRcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnVXNlciBhY2NvdW50IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScsXG4gICAgICAgIGNvZGU6ICdVU0VSX0lOQUNUSVZFJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFNldCBzZXNzaW9uIHJvbGUgKHBlcm1pc3Npb25zIGhhbmRsZWQgdmlhIGRhdGFiYXNlKVxuICAgIHJlcS5zZXNzaW9uLnJvbGUgPSB1c2VyLnJvbGU7XG5cbiAgICAvLyBBZGQgb3JnYW5pemF0aW9uIGluZm9ybWF0aW9uIHRvIHRoZSB1c2VyIG9iamVjdCAtIHdpdGggZXJyb3IgaGFuZGxpbmcgZm9yIHJlc2lsaWVuY2VcbiAgICBsZXQgdXNlck9yZ2FuaXphdGlvbnM6IGFueVtdID0gW107XG4gICAgdHJ5IHtcbiAgICAgIHVzZXJPcmdhbml6YXRpb25zID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7XG4gICAgICAgICAgb3JnYW5pemF0aW9uSWQ6IHNjaGVtYS51c2VyT3JnYW5pemF0aW9ucy5vcmdhbml6YXRpb25JZCxcbiAgICAgICAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zOiBzY2hlbWEudXNlck9yZ2FuaXphdGlvbnMuY2FuQWNjZXNzQWxsT3JnYW5pemF0aW9ucyxcbiAgICAgICAgfSlcbiAgICAgICAgLmZyb20oc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zKVxuICAgICAgICAud2hlcmUoXG4gICAgICAgICAgYW5kKFxuICAgICAgICAgICAgZXEoc2NoZW1hLnVzZXJPcmdhbml6YXRpb25zLnVzZXJJZCwgdXNlci5pZCksXG4gICAgICAgICAgICBlcShzY2hlbWEudXNlck9yZ2FuaXphdGlvbnMuaXNBY3RpdmUsIHRydWUpXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH0gY2F0Y2ggKG9yZ0Vycm9yKSB7XG4gICAgICAvLyBPcmdhbml6YXRpb24gbG9va3VwIGVycm9yIGhhbmRsZWQgZ3JhY2VmdWxseVxuICAgICAgLy8gQ29udGludWUgd2l0aCBlbXB0eSBvcmdhbml6YXRpb25zIC0gdXNlciBjYW4gc3RpbGwgYXV0aGVudGljYXRlXG4gICAgICB1c2VyT3JnYW5pemF0aW9ucyA9IFtdO1xuICAgIH1cblxuICAgIC8vIEVuaGFuY2VkIHVzZXIgb2JqZWN0IHdpdGggb3JnYW5pemF0aW9uIGFjY2VzcyBpbmZvcm1hdGlvblxuICAgIHJlcS51c2VyID0ge1xuICAgICAgLi4udXNlcixcbiAgICAgIG9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLm1hcCgodW8pID0+IHVvLm9yZ2FuaXphdGlvbklkKSxcbiAgICAgIGNhbkFjY2Vzc0FsbE9yZ2FuaXphdGlvbnM6IHVzZXJPcmdhbml6YXRpb25zLnNvbWUoKHVvKSA9PiB1by5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zKSxcbiAgICB9IGFzIGFueTtcblxuICAgIC8vIFNwZWNpYWwgaGFuZGxpbmcgZm9yIGhhcmRjb2RlZCBkZW1vIHVzZXJzIC0gZW5zdXJlIHRoZXkgaGF2ZSBwcm9wZXIgb3JnYW5pemF0aW9uIGFjY2Vzc1xuICAgIC8vIENoZWNrIGlmIHRoZSB1c2VyIHJlY29yZCBoYXMgb3JnYW5pemF0aW9uIGFjY2VzcyBjb25maWd1cmVkXG4gICAgaWYgKFxuICAgICAgdXNlci5yb2xlPy5zdGFydHNXaXRoKCdkZW1vXycpICYmXG4gICAgICAoIXJlcS51c2VyLm9yZ2FuaXphdGlvbnMgfHwgcmVxLnVzZXIub3JnYW5pemF0aW9ucy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICAvLyBEZW1vIHVzZXJzIHNob3VsZCBnZXQgYWNjZXNzIHRvIGRlbW8gb3JnYW5pemF0aW9uc1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGVtb09yZ3MgPSBhd2FpdCBkYlxuICAgICAgICAgIC5zZWxlY3QoeyBpZDogc2NoZW1hLm9yZ2FuaXphdGlvbnMuaWQgfSlcbiAgICAgICAgICAuZnJvbShzY2hlbWEub3JnYW5pemF0aW9ucylcbiAgICAgICAgICAud2hlcmUoZXEoc2NoZW1hLm9yZ2FuaXphdGlvbnMudHlwZSwgJ2RlbW8nKSlcbiAgICAgICAgICAubGltaXQoMSk7XG4gICAgICAgIFxuICAgICAgICBpZiAoZGVtb09yZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgIC8vIEFkZGluZyBvcmdhbml6YXRpb24gYWNjZXNzIGZvciBkZW1vIHVzZXJcbiAgICAgICAgICByZXEudXNlci5vcmdhbml6YXRpb25zID0gW2RlbW9PcmdzWzBdLmlkXTtcbiAgICAgICAgICByZXEudXNlci5jYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGRlbW9PcmdFcnJvcikge1xuICAgICAgICAvLyBEZW1vIG9yZ2FuaXphdGlvbiBsb29rdXAgZmFpbGVkLCBjb250aW51ZSB3aXRob3V0IGFjY2Vzc1xuICAgICAgfVxuICAgIH1cblxuICAgIG5leHQoKTtcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIC8vIEF1dGhlbnRpY2F0aW9uIGVycm9yIGhhbmRsZWRcbiAgICBjb25zb2xlLmVycm9yKCfinYwgQXV0aGVudGljYXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gZXJyb3InLFxuICAgICAgY29kZTogJ0FVVEhfRVJST1InLFxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogUm9sZS1iYXNlZCBhdXRob3JpemF0aW9uIG1pZGRsZXdhcmUgZmFjdG9yeSBmb3IgUXVlYmVjIHByb3BlcnR5IG1hbmFnZW1lbnQgcm9sZXMuXG4gKiBDcmVhdGVzIG1pZGRsZXdhcmUgdGhhdCByZXN0cmljdHMgYWNjZXNzIGJhc2VkIG9uIHVzZXIgcm9sZXMgc3VjaCBhcyBhZG1pbiwgbWFuYWdlciwgdGVuYW50LlxuICogTXVzdCBiZSB1c2VkIGFmdGVyIHJlcXVpcmVBdXRoIG1pZGRsZXdhcmUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmdbXX0gYWxsb3dlZFJvbGVzIC0gQXJyYXkgb2Ygcm9sZXMgdGhhdCBjYW4gYWNjZXNzIHRoZSByb3V0ZSAoZS5nLiwgWydhZG1pbicsICdtYW5hZ2VyJ10pLlxuICogQHJldHVybnMge0Z1bmN0aW9ufSBFeHByZXNzIG1pZGRsZXdhcmUgZnVuY3Rpb24gZm9yIHJvbGUgdmFsaWRhdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogLy8gT25seSBhZG1pbnMgY2FuIGFjY2VzcyB1c2VyIG1hbmFnZW1lbnRcbiAqIGFwcC5nZXQoJy9hcGkvYWRtaW4vdXNlcnMnLCByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUoWydhZG1pbiddKSwgZ2V0VXNlckxpc3QpO1xuICpcbiAqIC8vIE1hbmFnZXJzIGFuZCBhZG1pbnMgY2FuIGFjY2VzcyBidWlsZGluZyBkYXRhXG4gKiBhcHAuZ2V0KCcvYXBpL2J1aWxkaW5ncycsIHJlcXVpcmVBdXRoLCByZXF1aXJlUm9sZShbJ2FkbWluJywgJ21hbmFnZXInXSksIGdldEJ1aWxkaW5ncyk7XG4gKiBgYGBcbiAqL1xuLyoqXG4gKiBSZXF1aXJlUm9sZSBmdW5jdGlvbi5cbiAqIEBwYXJhbSBhbGxvd2VkUm9sZXNcbiAqIEByZXR1cm5zIEZ1bmN0aW9uIHJlc3VsdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVSb2xlKGFsbG93ZWRSb2xlczogc3RyaW5nW10pIHtcbiAgcmV0dXJuIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghYWxsb3dlZFJvbGVzLmluY2x1ZGVzKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnSW5zdWZmaWNpZW50IHBlcm1pc3Npb25zJyxcbiAgICAgICAgY29kZTogJ0lOU1VGRklDSUVOVF9QRVJNSVNTSU9OUycsXG4gICAgICAgIHJlcXVpcmVkOiBhbGxvd2VkUm9sZXMsXG4gICAgICAgIGN1cnJlbnQ6IHJlcS51c2VyLnJvbGUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8qKlxuICogUGVybWlzc2lvbi1iYXNlZCBhdXRob3JpemF0aW9uIG1pZGRsZXdhcmUgZmFjdG9yeSB1c2luZyB0aGUgY29tcHJlaGVuc2l2ZSBSQkFDIHN5c3RlbS5cbiAqIFZhbGlkYXRlcyB1c2VyIHBlcm1pc3Npb25zIGJhc2VkIG9uIHRoZSBkYXRhYmFzZSBSQkFDIHN5c3RlbS5cbiAqIE11c3QgYmUgdXNlZCBhZnRlciByZXF1aXJlQXV0aCBtaWRkbGV3YXJlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZXJtaXNzaW9uIC0gU3BlY2lmaWMgcGVybWlzc2lvbiByZXF1aXJlZCB0byBhY2Nlc3MgdGhlIHJvdXRlIChlLmcuLCAncmVhZDpiaWxsJywgJ2NyZWF0ZTptYWludGVuYW5jZV9yZXF1ZXN0JykuXG4gKiBAcmV0dXJucyB7RnVuY3Rpb259IEV4cHJlc3MgbWlkZGxld2FyZSBmdW5jdGlvbiBmb3IgcGVybWlzc2lvbiB2YWxpZGF0aW9uLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiAvLyBPbmx5IHVzZXJzIHdpdGggJ3JlYWQ6YmlsbCcgcGVybWlzc2lvbiBjYW4gYWNjZXNzXG4gKiBhcHAuZ2V0KCcvYXBpL2JpbGxzJywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgncmVhZDpiaWxsJyksIGdldEJpbGxzKTtcbiAqXG4gKiAvLyBPbmx5IHVzZXJzIHdpdGggJ2RlbGV0ZTp1c2VyJyBwZXJtaXNzaW9uIGNhbiBkZWxldGUgdXNlcnNcbiAqIGFwcC5kZWxldGUoJy9hcGkvdXNlcnMvOmlkJywgcmVxdWlyZUF1dGgsIGF1dGhvcml6ZSgnZGVsZXRlOnVzZXInKSwgZGVsZXRlVXNlcik7XG4gKlxuICogLy8gTXVsdGlwbGUgcm91dGUgcHJvdGVjdGlvblxuICogcm91dGVyLnVzZShhdXRob3JpemUoJ21hbmFnZTpidWlsZGluZycpKTtcbiAqIHJvdXRlci5wb3N0KCcvYnVpbGRpbmdzJywgY3JlYXRlQnVpbGRpbmcpO1xuICogcm91dGVyLnBhdGNoKCcvYnVpbGRpbmdzLzppZCcsIHVwZGF0ZUJ1aWxkaW5nKTtcbiAqIGBgYFxuICovXG4vKipcbiAqIEF1dGhvcml6ZSBmdW5jdGlvbi5cbiAqIEBwYXJhbSBwZXJtaXNzaW9uXG4gKiBAcmV0dXJucyBGdW5jdGlvbiByZXN1bHQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdXRob3JpemUocGVybWlzc2lvbjogc3RyaW5nKSB7XG4gIHJldHVybiBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBpZiAoIXJlcS51c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgdGhlIHVzZXIncyByb2xlIGhhcyB0aGUgcmVxdWlyZWQgcGVybWlzc2lvbiB2aWEgZGF0YWJhc2VcbiAgICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBhd2FpdCBjaGVja1VzZXJQZXJtaXNzaW9uKHJlcS51c2VyLnJvbGUgYXMgYW55LCBwZXJtaXNzaW9uKTtcblxuICAgICAgaWYgKCFoYXNQZXJtaXNzaW9uKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycsXG4gICAgICAgICAgY29kZTogJ1BFUk1JU1NJT05fREVOSUVEJyxcbiAgICAgICAgICByZXF1aXJlZDogcGVybWlzc2lvbixcbiAgICAgICAgICB1c2VyUm9sZTogcmVxLnVzZXIucm9sZSxcbiAgICAgICAgICBkZXRhaWxzOiBgVXNlciB3aXRoIHJvbGUgJyR7cmVxLnVzZXIucm9sZX0nIGRvZXMgbm90IGhhdmUgcGVybWlzc2lvbiAnJHtwZXJtaXNzaW9ufSdgLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIC8vIEF1dGhvcml6YXRpb24gZXJyb3IgaGFuZGxlZFxuICAgICAgY29uc29sZS5lcnJvcign4p2MIEF1dGhvcml6YXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhvcml6YXRpb24gY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ0FVVEhPUklaQVRJT05fRVJST1InLFxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFNldHMgdXAgYXV0aGVudGljYXRpb24gcm91dGVzIGZvciBRdWViZWMtY29tcGxpYW50IHVzZXIgbWFuYWdlbWVudC5cbiAqIEltcGxlbWVudHMgbG9naW4sIGxvZ291dCwgcmVnaXN0cmF0aW9uLCBhbmQgY3VycmVudCB1c2VyIGVuZHBvaW50c1xuICogd2l0aCBwcm9wZXIgc2Vzc2lvbiBtYW5hZ2VtZW50IGFuZCBMYXcgMjUgY29tcGxpYW5jZSBjb25zaWRlcmF0aW9ucy5cbiAqXG4gKiBAcGFyYW0ge2FueX0gYXBwIC0gRXhwcmVzcyBhcHBsaWNhdGlvbiBpbnN0YW5jZSB0byByZWdpc3RlciByb3V0ZXMgb24uXG4gKiBAcmV0dXJucyB7dm9pZH0gTm8gcmV0dXJuIHZhbHVlIC0gcm91dGVzIGFyZSByZWdpc3RlcmVkIGRpcmVjdGx5IG9uIGFwcC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgYXBwID0gZXhwcmVzcygpO1xuICogYXBwLnVzZShzZXNzaW9uQ29uZmlnKTtcbiAqIHNldHVwQXV0aFJvdXRlcyhhcHApO1xuICogLy8gQXV0aGVudGljYXRpb24gcm91dGVzIGFyZSBub3cgYXZhaWxhYmxlOlxuICogLy8gUE9TVCAvYXBpL2F1dGgvbG9naW5cbiAqIC8vIFBPU1QgL2FwaS9hdXRoL2xvZ291dFxuICogLy8gR0VUIC9hcGkvYXV0aC91c2VyXG4gKiAvLyBQT1NUIC9hcGkvYXV0aC9yZWdpc3RlclxuICogYGBgXG4gKi9cbi8qKlxuICogU2V0dXBBdXRoUm91dGVzIGZ1bmN0aW9uLlxuICogQHBhcmFtIGFwcFxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBBdXRoUm91dGVzKGFwcDogYW55KSB7XG4gIC8vIExvZ2luIHJvdXRlXG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcbiAgICAgIC8vIExvZ2luIGF0dGVtcHQgaW5pdGlhdGVkXG5cbiAgICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0VtYWlsIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdNSVNTSU5HX0NSRURFTlRJQUxTJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHJpZXZpbmcgdXNlciBieSBlbWFpbFxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHN0b3JhZ2UuZ2V0VXNlckJ5RW1haWwoZW1haWwudG9Mb3dlckNhc2UoKSk7XG5cbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIGNyZWRlbnRpYWxzJyxcbiAgICAgICAgICBjb2RlOiAnSU5WQUxJRF9DUkVERU5USUFMUycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQWNjb3VudCBpcyBpbmFjdGl2ZScsXG4gICAgICAgICAgY29kZTogJ0FDQ09VTlRfSU5BQ1RJVkUnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVXNlIGJjcnlwdCBmb3IgcGFzc3dvcmQgdmVyaWZpY2F0aW9uXG4gICAgICAvLyBWZXJpZnlpbmcgcGFzc3dvcmQgZm9yIHVzZXJcbiAgICAgIC8vIFBhc3N3b3JkIHZlcmlmaWNhdGlvbiBpbml0aWF0ZWRcbiAgICAgIGNvbnN0IGlzVmFsaWRQYXNzd29yZCA9IGF3YWl0IHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcbiAgICAgIC8vIFBhc3N3b3JkIHZlcmlmaWNhdGlvbiBjb21wbGV0ZWRcblxuICAgICAgaWYgKCFpc1ZhbGlkUGFzc3dvcmQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBjcmVkZW50aWFscycsXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfQ1JFREVOVElBTFMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVXBkYXRlIGxhc3QgbG9naW5cbiAgICAgIGF3YWl0IHN0b3JhZ2UudXBkYXRlVXNlcih1c2VyLmlkLCB7IGxhc3RMb2dpbkF0OiBuZXcgRGF0ZSgpIH0pO1xuXG4gICAgICAvLyBTZXQgc2Vzc2lvbiB3aXRoIHVzZXIgZGF0YVxuICAgICAgcmVxLnNlc3Npb24udXNlcklkID0gdXNlci5pZDtcbiAgICAgIHJlcS5zZXNzaW9uLnVzZXJSb2xlID0gdXNlci5yb2xlO1xuICAgICAgcmVxLnNlc3Npb24ucm9sZSA9IHVzZXIucm9sZTtcbiAgICAgIHJlcS5zZXNzaW9uLnVzZXIgPSB1c2VyOyAvLyBBZGQgY29tcGxldGUgdXNlciBvYmplY3QgZm9yIG1pZGRsZXdhcmUgY29tcGF0aWJpbGl0eVxuXG4gICAgICAvLyBTYXZlIHNlc3Npb24gZXhwbGljaXRseSB0byBlbnN1cmUgaXQncyBwZXJzaXN0ZWRcbiAgICAgIHJlcS5zZXNzaW9uLnNhdmUoKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIFNlc3Npb24gc2F2ZSBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU2Vzc2lvbiBzYXZlIGZhaWxlZCcsXG4gICAgICAgICAgICBjb2RlOiAnU0VTU0lPTl9TQVZFX0VSUk9SJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIFxuICAgICAgICAvLyBSZXR1cm4gdXNlciBkYXRhICh3aXRob3V0IHBhc3N3b3JkKVxuICAgICAgICBjb25zdCB7IHBhc3N3b3JkOiBfLCAuLi51c2VyRGF0YSB9ID0gdXNlcjtcbiAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgIHVzZXI6IHVzZXJEYXRhLFxuICAgICAgICAgIG1lc3NhZ2U6ICdMb2dpbiBzdWNjZXNzZnVsJyxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChfZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcignTG9naW4gZXJyb3I6Jywge1xuICAgICAgICBlcnJvcjogX2Vycm9yLFxuICAgICAgICBlbWFpbDogcmVxLmJvZHk/LmVtYWlsLFxuICAgICAgICBoYXNQYXNzd29yZDogISFyZXEuYm9keT8ucGFzc3dvcmQsXG4gICAgICAgIGRhdGFiYXNlVXJsOiAhIXByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCxcbiAgICAgICAgc2Vzc2lvblNlY3JldDogISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCxcbiAgICAgIH0pO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnTG9naW4gZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ0xPR0lOX0VSUk9SJyxcbiAgICAgICAgLi4uKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnICYmIHsgZGV0YWlsczogX2Vycm9yIH0pLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBMb2dvdXQgcm91dGVcbiAgYXBwLnBvc3QoJy9hcGkvYXV0aC9sb2dvdXQnLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgcmVxLnNlc3Npb24uZGVzdHJveSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0xvZ291dCBfZXJyb3I6JywgZXJyKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTG9nb3V0IGZhaWxlZCcsXG4gICAgICAgICAgY29kZTogJ0xPR09VVF9FUlJPUicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBjb29raWUgd2l0aCBzYW1lIHNldHRpbmdzIGFzIHdoZW4gaXQgd2FzIHNldFxuICAgICAgY29uc3QgY29va2llT3B0aW9uczogYW55ID0ge1xuICAgICAgICBodHRwT25seTogdHJ1ZSxcbiAgICAgICAgc2VjdXJlOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nLFxuICAgICAgICBzYW1lU2l0ZTogJ2xheCcsXG4gICAgICB9O1xuXG4gICAgICByZXMuY2xlYXJDb29raWUoJ2tvdmVvLnNpZCcsIGNvb2tpZU9wdGlvbnMpO1xuICAgICAgcmVzLmpzb24oeyBtZXNzYWdlOiAnTG9nb3V0IHN1Y2Nlc3NmdWwnIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICAvLyBHZXQgY3VycmVudCB1c2VyIHJvdXRlXG4gIGFwcC5nZXQoJy9hcGkvYXV0aC91c2VyJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayB1c2VyIHNlc3Npb25cblxuICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIHZhbGlkIHNlc3Npb24gd2l0aCB1c2VyIElEXG4gICAgICBpZiAoIXJlcS5zZXNzaW9uPy51c2VySWQpIHtcbiAgICAgICAgLy8gTm8gc2Vzc2lvbiBmb3VuZFxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdOb3QgYXV0aGVudGljYXRlZCcsXG4gICAgICAgICAgY29kZTogJ05PVF9BVVRIRU5USUNBVEVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFRyeSB0byBnZXQgdXNlciBmcm9tIGRhdGFiYXNlXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyKHJlcS5zZXNzaW9uLnVzZXJJZCk7XG4gICAgICAgIC8vIFVzZXIgbG9va3VwIGNvbXBsZXRlZFxuXG4gICAgICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgICAgIC8vIFVzZXIgbm90IGZvdW5kIG9yIGluYWN0aXZlLCBkZXN0cm95aW5nIHNlc3Npb25cbiAgICAgICAgICByZXEuc2Vzc2lvbi5kZXN0cm95KChlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignU2Vzc2lvbiBkZXN0cnVjdGlvbiBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnVXNlciBhY2NvdW50IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScsXG4gICAgICAgICAgICBjb2RlOiAnVVNFUl9JTkFDVElWRScsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBPcHRpbWl6ZWQgc2Vzc2lvbiB0b3VjaCAtIG9ubHkgd2hlbiBuZWVkZWRcbiAgICAgICAgaWYgKHJlcS5zZXNzaW9uICYmIHJlcS5zZXNzaW9uLnRvdWNoICYmIHJlcS5zZXNzaW9uLmNvb2tpZSkge1xuICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgY29uc3Qgc2Vzc2lvbkFnZSA9IG5vdyAtIChyZXEuc2Vzc2lvbi5jb29raWUub3JpZ2luYWxNYXhBZ2UgfHwgMCkgKyAocmVxLnNlc3Npb24uY29va2llLm1heEFnZSB8fCAwKTtcbiAgICAgICAgICBjb25zdCBzZXNzaW9uTGlmZXRpbWUgPSByZXEuc2Vzc2lvbi5jb29raWUub3JpZ2luYWxNYXhBZ2UgfHwgKDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBPbmx5IHRvdWNoIHNlc3Npb24gaWYgbW9yZSB0aGFuIDI1JSBvZiBpdHMgbGlmZXRpbWUgaGFzIHBhc3NlZFxuICAgICAgICAgIGlmIChzZXNzaW9uQWdlID4gc2Vzc2lvbkxpZmV0aW1lICogMC4yNSkge1xuICAgICAgICAgICAgcmVxLnNlc3Npb24udG91Y2goKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZXR1cm4gdXNlciBkYXRhIHdpdGhvdXQgcGFzc3dvcmRcbiAgICAgICAgY29uc3QgeyBwYXNzd29yZDogXywgLi4udXNlckRhdGEgfSA9IHVzZXI7XG4gICAgICAgIC8vIFN1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkIHVzZXJcbiAgICAgICAgcmVzLmpzb24odXNlckRhdGEpO1xuXG4gICAgICB9IGNhdGNoICh1c2VyRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRGF0YWJhc2UgZXJyb3IgZ2V0dGluZyB1c2VyOicsIHVzZXJFcnJvcik7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGNoZWNrIGZhaWxlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfQ0hFQ0tfRVJST1InLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgQXV0aCBjaGVjayBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBjaGVjayBmYWlsZWQnLFxuICAgICAgICBjb2RlOiAnQVVUSF9DSEVDS19FUlJPUicsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIERlYnVnIGVuZHBvaW50IHRvIGNoZWNrIGF1dGggY29uZmlndXJhdGlvbiAocHJvZHVjdGlvbiBvbmx5LCB0ZW1wb3JhcnkpXG4gIGFwcC5nZXQoJy9hcGkvYXV0aC9kZWJ1ZycsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICBjb25zdCBkZWJ1Z0luZm8gPSB7XG4gICAgICBoYXNTZXNzaW9uOiAhIXJlcS5zZXNzaW9uLFxuICAgICAgc2Vzc2lvbklkOiByZXEuc2Vzc2lvbklELFxuICAgICAgdXNlcklkOiByZXEuc2Vzc2lvbj8udXNlcklkLFxuICAgICAgdXNlclJvbGU6IHJlcS5zZXNzaW9uPy51c2VyUm9sZSxcbiAgICAgIG5vZGVFbnY6IHByb2Nlc3MuZW52Lk5PREVfRU5WLFxuICAgICAgaGFzRGF0YWJhc2VVcmw6ICEhcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMLFxuICAgICAgaGFzU2Vzc2lvblNlY3JldDogISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVCxcbiAgICAgIGNvb2tpZXM6IHJlcS5oZWFkZXJzLmNvb2tpZSA/ICdwcmVzZW50JyA6ICdtaXNzaW5nJyxcbiAgICAgIGNvb2tpZUhlYWRlcjogcmVxLmhlYWRlcnMuY29va2llLFxuICAgICAgc2Vzc2lvblN0b3JlOiByZXEuc2Vzc2lvbj8uc3RvcmU/LmNvbnN0cnVjdG9yPy5uYW1lIHx8ICd1bmtub3duJyxcbiAgICAgIHVzZXJBZ2VudDogcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSxcbiAgICAgIGhvc3Q6IHJlcS5oZWFkZXJzLmhvc3QsXG4gICAgICBwcm90b2NvbDogcmVxLnByb3RvY29sLFxuICAgICAgc2VjdXJlOiByZXEuc2VjdXJlLFxuICAgICAgdHJ1c3RQcm94eTogISFyZXEuYXBwLmdldCgndHJ1c3QgcHJveHknKSxcbiAgICB9O1xuXG4gICAgY29uc29sZS5sb2coJ0F1dGggZGVidWcgaW5mbzonLCBkZWJ1Z0luZm8pO1xuICAgIHJlcy5qc29uKGRlYnVnSW5mbyk7XG4gIH0pO1xuXG4gIC8vIFRlc3QgY29va2llIHNldHRpbmcgZW5kcG9pbnRcbiAgYXBwLnBvc3QoJy9hcGkvYXV0aC90ZXN0LWNvb2tpZScsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICAvLyBTZXQgYSB0ZXN0IHNlc3Npb24gdmFsdWVcbiAgICByZXEuc2Vzc2lvbi50ZXN0VmFsdWUgPSAndGVzdC0nICsgRGF0ZS5ub3coKTtcblxuICAgIHJlcS5zZXNzaW9uLnNhdmUoKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBzYXZlIHNlc3Npb24nLCBkZXRhaWxzOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgIH1cblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnVGVzdCBjb29raWUgc2V0JyxcbiAgICAgICAgc2Vzc2lvbklkOiByZXEuc2Vzc2lvbklELFxuICAgICAgICB0ZXN0VmFsdWU6IHJlcS5zZXNzaW9uLnRlc3RWYWx1ZSxcbiAgICAgICAgY29va2llU2V0dGluZ3M6IHtcbiAgICAgICAgICBzZWN1cmU6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicsXG4gICAgICAgICAgaHR0cE9ubHk6IHRydWUsXG4gICAgICAgICAgc2FtZVNpdGU6ICdsYXgnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIFJlZ2lzdGVyIHJvdXRlIChhZG1pbiBvbmx5IGZvciBub3cpXG4gIGFwcC5wb3N0KFxuICAgICcvYXBpL2F1dGgvcmVnaXN0ZXInLFxuICAgIHJlcXVpcmVBdXRoLFxuICAgIHJlcXVpcmVSb2xlKFsnYWRtaW4nXSksXG4gICAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIGZpcnN0TmFtZSwgbGFzdE5hbWUsIHJvbGUgPSAndGVuYW50JywgbGFuZ3VhZ2UgPSAnZnInIH0gPSByZXEuYm9keTtcblxuICAgICAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCB8fCAhZmlyc3ROYW1lIHx8ICFsYXN0TmFtZSkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnQWxsIGZpZWxkcyBhcmUgcmVxdWlyZWQnLFxuICAgICAgICAgICAgY29kZTogJ01JU1NJTkdfRklFTERTJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGlmIHVzZXIgYWxyZWFkeSBleGlzdHNcbiAgICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgc3RvcmFnZS5nZXRVc2VyQnlFbWFpbChlbWFpbC50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwOSkuanNvbih7XG4gICAgICAgICAgICBtZXNzYWdlOiAnVXNlciBhbHJlYWR5IGV4aXN0cycsXG4gICAgICAgICAgICBjb2RlOiAnVVNFUl9FWElTVFMnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ3JlYXRlIHVzZXIgd2l0aCBiY3J5cHQgaGFzaGVkIHBhc3N3b3JkXG4gICAgICAgIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgaGFzaFBhc3N3b3JkKHBhc3N3b3JkKTtcblxuICAgICAgICBjb25zdCBuZXdVc2VyID0gYXdhaXQgc3RvcmFnZS5jcmVhdGVVc2VyKHtcbiAgICAgICAgICBlbWFpbDogZW1haWwudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICAgICAgZmlyc3ROYW1lLFxuICAgICAgICAgIGxhc3ROYW1lLFxuICAgICAgICAgIHVzZXJuYW1lOiBlbWFpbC50b0xvd2VyQ2FzZSgpLCAvLyBVc2UgZW1haWwgYXMgdXNlcm5hbWVcbiAgICAgICAgICByb2xlLFxuICAgICAgICAgIGxhbmd1YWdlLFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCB7IHBhc3N3b3JkOiBfLCAuLi51c2VyRGF0YSB9ID0gbmV3VXNlcjtcbiAgICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgICAgIHVzZXI6IHVzZXJEYXRhLFxuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBSZWdpc3RyYXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1JlZ2lzdHJhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgIGNvZGU6ICdSRUdJU1RSQVRJT05fRVJST1InLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgLy8gUGFzc3dvcmQgUmVzZXQgUmVxdWVzdCBSb3V0ZVxuICBhcHAucG9zdCgnL2FwaS9hdXRoL2ZvcmdvdC1wYXNzd29yZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cbiAgICAgIGlmICghZW1haWwpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnRW1haWwgaXMgcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdNSVNTSU5HX0VNQUlMJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXJCeUVtYWlsKGVtYWlsLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICAgIC8vIEFsd2F5cyByZXNwb25kIHdpdGggc3VjY2VzcyBmb3Igc2VjdXJpdHkgKGRvbid0IHJldmVhbCBpZiBlbWFpbCBleGlzdHMpXG4gICAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0lmIHRoaXMgZW1haWwgZXhpc3RzLCBhIHBhc3N3b3JkIHJlc2V0IGxpbmsgaGFzIGJlZW4gc2VudC4nLFxuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBHZW5lcmF0ZSBzZWN1cmUgcmFuZG9tIHRva2VuXG4gICAgICBjb25zdCByZXNldFRva2VuID0gcmFuZG9tQnl0ZXMoMzIpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgIGNvbnN0IHRva2VuSGFzaCA9IGNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZShyZXNldFRva2VuKS5kaWdlc3QoJ2hleCcpO1xuXG4gICAgICAvLyBDcmVhdGUgcGFzc3dvcmQgcmVzZXQgdG9rZW4gKGV4cGlyZXMgaW4gMSBob3VyKVxuICAgICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoKTtcbiAgICAgIGV4cGlyZXNBdC5zZXRIb3VycyhleHBpcmVzQXQuZ2V0SG91cnMoKSArIDEpO1xuXG4gICAgICBhd2FpdCBzdG9yYWdlLmNyZWF0ZVBhc3N3b3JkUmVzZXRUb2tlbih7XG4gICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgdG9rZW46IHJlc2V0VG9rZW4sXG4gICAgICAgIHRva2VuSGFzaDogdG9rZW5IYXNoLFxuICAgICAgICBleHBpcmVzQXQ6IGV4cGlyZXNBdCxcbiAgICAgICAgaXBBZGRyZXNzOiByZXEuaXAgfHwgcmVxLmNvbm5lY3Rpb24/LnJlbW90ZUFkZHJlc3MgfHwgJ3Vua25vd24nLFxuICAgICAgICB1c2VyQWdlbnQ6IHJlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10gfHwgJ3Vua25vd24nLFxuICAgICAgfSBhcyBhbnkpO1xuXG4gICAgICAvLyBTZW5kIHBhc3N3b3JkIHJlc2V0IGVtYWlsXG4gICAgICBjb25zdCBob3N0ID0gcmVxLmdldCgnaG9zdCcpIHx8ICcnO1xuXG4gICAgICAvLyBVc2UgZGV2ZWxvcG1lbnQgVVJMIGZvciBSZXBsaXQgZW52aXJvbm1lbnRzLCBwcm9kdWN0aW9uIFVSTCBvdGhlcndpc2VcbiAgICAgIGxldCBmcm9udGVuZFVybDtcbiAgICAgIGlmIChcbiAgICAgICAgaG9zdC5pbmNsdWRlcygncmVwbGl0LmRldicpIHx8XG4gICAgICAgIGhvc3QuaW5jbHVkZXMoJ3JlcGxpdC5jb20nKSB8fFxuICAgICAgICBob3N0LmluY2x1ZGVzKCdyZXBsaXQuY28nKSB8fFxuICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50J1xuICAgICAgKSB7XG4gICAgICAgIC8vIFVzZSB0aGUgYWN0dWFsIFJlcGxpdCBkZXZlbG9wbWVudCBVUkxcbiAgICAgICAgZnJvbnRlbmRVcmwgPSBgJHtyZXEucHJvdG9jb2x9Oi8vJHtob3N0fWA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBVc2UgcHJvZHVjdGlvbiBVUkwgLSBwcmlvcml0aXplIGtvdmVvLWdlc3Rpb24uY29tIGZvciBwcm9kdWN0aW9uXG4gICAgICAgIGlmIChob3N0LmluY2x1ZGVzKCdrb3Zlby1nZXN0aW9uLmNvbScpKSB7XG4gICAgICAgICAgZnJvbnRlbmRVcmwgPSBgaHR0cHM6Ly8ke2hvc3R9YDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmcm9udGVuZFVybCA9IHByb2Nlc3MuZW52LkZST05URU5EX1VSTCB8fCAnaHR0cHM6Ly9rb3Zlby1nZXN0aW9uLmNvbSc7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgY2xlYW5VcmwgPSBmcm9udGVuZFVybC5lbmRzV2l0aCgnLycpID8gZnJvbnRlbmRVcmwuc2xpY2UoMCwgLTEpIDogZnJvbnRlbmRVcmw7XG4gICAgICBjb25zdCByZXNldFVybCA9IGAke2NsZWFuVXJsfS9yZXNldC1wYXNzd29yZD90b2tlbj0ke3Jlc2V0VG9rZW59YDtcblxuXG4gICAgICBjb25zdCBlbWFpbFNlbnQgPSBhd2FpdCBlbWFpbFNlcnZpY2Uuc2VuZFBhc3N3b3JkUmVzZXRFbWFpbChcbiAgICAgICAgZW1haWwudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgYCR7dXNlci5maXJzdE5hbWV9ICR7dXNlci5sYXN0TmFtZX1gLFxuICAgICAgICByZXNldFVybFxuICAgICAgKTtcblxuICAgICAgaWYgKCFlbWFpbFNlbnQpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgZW1haWwgdG86JywgZW1haWwpO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gc2VuZCBwYXNzd29yZCByZXNldCBlbWFpbCcsXG4gICAgICAgICAgY29kZTogJ0VNQUlMX1NFTkRfRkFJTEVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ0lmIHRoaXMgZW1haWwgZXhpc3RzLCBhIHBhc3N3b3JkIHJlc2V0IGxpbmsgaGFzIGJlZW4gc2VudC4nLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIFBhc3N3b3JkIHJlc2V0IHJlcXVlc3QgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgcmVxdWVzdCBmYWlsZWQnLFxuICAgICAgICBjb2RlOiAnUEFTU1dPUkRfUkVTRVRfUkVRVUVTVF9FUlJPUicsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFBhc3N3b3JkIFJlc2V0IFJvdXRlXG4gIGFwcC5wb3N0KCcvYXBpL2F1dGgvcmVzZXQtcGFzc3dvcmQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdG9rZW4sIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcblxuICAgICAgaWYgKCF0b2tlbiB8fCAhcGFzc3dvcmQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnVG9rZW4gYW5kIHBhc3N3b3JkIGFyZSByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ01JU1NJTkdfRklFTERTJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIHBhc3N3b3JkIHN0cmVuZ3RoXG4gICAgICBpZiAocGFzc3dvcmQubGVuZ3RoIDwgOCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0IDggY2hhcmFjdGVycyBsb25nJyxcbiAgICAgICAgICBjb2RlOiAnUEFTU1dPUkRfVE9PX1NIT1JUJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHBhc3N3b3JkIGNvbXBsZXhpdHkgcmVxdWlyZW1lbnRzXG4gICAgICBjb25zdCBoYXNVcHBlckNhc2UgPSAvW0EtWl0vLnRlc3QocGFzc3dvcmQpO1xuICAgICAgY29uc3QgaGFzTG93ZXJDYXNlID0gL1thLXpdLy50ZXN0KHBhc3N3b3JkKTtcbiAgICAgIGNvbnN0IGhhc051bWJlcnMgPSAvXFxkLy50ZXN0KHBhc3N3b3JkKTtcblxuICAgICAgaWYgKCFoYXNVcHBlckNhc2UgfHwgIWhhc0xvd2VyQ2FzZSB8fCAhaGFzTnVtYmVycykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSB1cHBlcmNhc2UgbGV0dGVyLCBvbmUgbG93ZXJjYXNlIGxldHRlciwgYW5kIG9uZSBudW1iZXInLFxuICAgICAgICAgIGNvZGU6ICdQQVNTV09SRF9UT09fV0VBSycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBGaW5kIHRoZSBwYXNzd29yZCByZXNldCB0b2tlblxuICAgICAgY29uc3QgcmVzZXRUb2tlbiA9IGF3YWl0IHN0b3JhZ2UuZ2V0UGFzc3dvcmRSZXNldFRva2VuKHRva2VuKTtcbiAgICAgIGlmICghcmVzZXRUb2tlbikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIG9yIGV4cGlyZWQgcGFzc3dvcmQgcmVzZXQgdG9rZW4nLFxuICAgICAgICAgIGNvZGU6ICdJTlZBTElEX1RPS0VOJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIHRva2VuIGlzIGV4cGlyZWRcbiAgICAgIGlmIChuZXcgRGF0ZSgpID4gcmVzZXRUb2tlbi5leHBpcmVzQXQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgdG9rZW4gaGFzIGV4cGlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdUT0tFTl9FWFBJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIHRva2VuIGhhcyBhbHJlYWR5IGJlZW4gdXNlZFxuICAgICAgaWYgKHJlc2V0VG9rZW4uaXNVc2VkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIHJlc2V0IHRva2VuIGhhcyBhbHJlYWR5IGJlZW4gdXNlZCcsXG4gICAgICAgICAgY29kZTogJ1RPS0VOX0FMUkVBRFlfVVNFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZnkgdG9rZW4gaGFzaCBmb3IgYWRkaXRpb25hbCBzZWN1cml0eVxuICAgICAgY29uc3QgdG9rZW5IYXNoID0gY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKHRva2VuKS5kaWdlc3QoJ2hleCcpO1xuICAgICAgaWYgKHRva2VuSGFzaCAhPT0gcmVzZXRUb2tlbi50b2tlbkhhc2gpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBwYXNzd29yZCByZXNldCB0b2tlbicsXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfVE9LRU5fSEFTSCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdGhlIHVzZXJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBzdG9yYWdlLmdldFVzZXIocmVzZXRUb2tlbi51c2VySWQpO1xuICAgICAgaWYgKCF1c2VyIHx8ICF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBub3QgZm91bmQgb3IgaW5hY3RpdmUnLFxuICAgICAgICAgIGNvZGU6ICdVU0VSX05PVF9GT1VORCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdXNlciBwYXNzd29yZCB3aXRoIGJjcnlwdCBoYXNoZWQgdmVyc2lvblxuICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBoYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xuXG4gICAgICBhd2FpdCBzdG9yYWdlLnVwZGF0ZVVzZXIodXNlci5pZCwge1xuICAgICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBNYXJrIHRva2VuIGFzIHVzZWRcbiAgICAgIGF3YWl0IHN0b3JhZ2UubWFya1Bhc3N3b3JkUmVzZXRUb2tlbkFzVXNlZChyZXNldFRva2VuLmlkKTtcblxuICAgICAgLy8gQ2xlYW4gdXAgZXhwaXJlZCB0b2tlbnNcbiAgICAgIGF3YWl0IHN0b3JhZ2UuY2xlYW51cEV4cGlyZWRQYXNzd29yZFJlc2V0VG9rZW5zKCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgbWVzc2FnZTogJ1Bhc3N3b3JkIGhhcyBiZWVuIHJlc2V0IHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgUGFzc3dvcmQgcmVzZXQgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgZmFpbGVkJyxcbiAgICAgICAgY29kZTogJ1BBU1NXT1JEX1JFU0VUX0VSUk9SJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vIEV4dGVuZGVkIHVzZXIgaW50ZXJmYWNlIGZvciBhdXRoZW50aWNhdGlvbiBjb250ZXh0XG5pbnRlcmZhY2UgQXV0aGVudGljYXRlZFVzZXIgZXh0ZW5kcyBVc2VyIHtcbiAgb3JnYW5pemF0aW9ucz86IHN0cmluZ1tdO1xuICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zPzogYm9vbGVhbjtcbiAgb3JnYW5pemF0aW9uSWQ/OiBzdHJpbmc7XG59XG5cbi8vIEV4dGVuZCBFeHByZXNzIFJlcXVlc3QgaW50ZXJmYWNlIHRvIGluY2x1ZGUgYXV0aGVudGljYXRlZCB1c2VyXG5kZWNsYXJlIGdsb2JhbCB7XG4gIG5hbWVzcGFjZSBFeHByZXNzIHtcbiAgICBpbnRlcmZhY2UgUmVxdWVzdCB7XG4gICAgICB1c2VyPzogQXV0aGVudGljYXRlZFVzZXI7XG4gICAgfVxuICB9XG59XG5cbi8vIEV4dGVuZCBleHByZXNzLXNlc3Npb24gdG8gaW5jbHVkZSBjdXN0b20gcHJvcGVydGllc1xuZGVjbGFyZSBtb2R1bGUgJ2V4cHJlc3Mtc2Vzc2lvbicge1xuICBpbnRlcmZhY2UgU2Vzc2lvbkRhdGEge1xuICAgIHVzZXJJZD86IHN0cmluZztcbiAgICB1c2VyUm9sZT86IHN0cmluZztcbiAgICByb2xlPzogc3RyaW5nO1xuICAgIHBlcm1pc3Npb25zPzogc3RyaW5nW107XG4gICAgc3RvcmU/OiBhbnk7XG4gICAgdGVzdFZhbHVlPzogYW55O1xuICAgIG9yZ2FuaXphdGlvbklkPzogc3RyaW5nO1xuICAgIG9yZ2FuaXphdGlvbnM/OiBzdHJpbmdbXTtcbiAgICBjYW5BY2Nlc3NBbGxPcmdhbml6YXRpb25zPzogYm9vbGVhbjtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9