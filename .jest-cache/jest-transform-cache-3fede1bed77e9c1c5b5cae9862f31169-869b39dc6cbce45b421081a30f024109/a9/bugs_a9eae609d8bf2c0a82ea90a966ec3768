3afe9e74ec6c03dd0ba1060731f54939
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerBugRoutes = registerBugRoutes;
const storage_1 = require("../storage");
const schema_1 = require("@shared/schema");
const zod_1 = require("zod");
const auth_1 = require("../auth");
const multer_1 = __importDefault(require("multer"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const uuid_1 = require("uuid");
// Configure multer for file uploads
const storage_config = multer_1.default.diskStorage({
    destination: (req, file, cb) => {
        const uploadDir = path_1.default.join(process.cwd(), 'uploads', 'general');
        if (!fs_1.default.existsSync(uploadDir)) {
            fs_1.default.mkdirSync(uploadDir, { recursive: true });
        }
        cb(null, uploadDir);
    },
    filename: (req, file, cb) => {
        const uniqueId = (0, uuid_1.v4)();
        const originalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
        const fileName = `${uniqueId}-${originalName}`;
        cb(null, fileName);
    },
});
const upload = (0, multer_1.default)({ storage: storage_config });
/**
 * Registers all bug-related API endpoints.
 *
 * @param app - Express application instance.
 */
function registerBugRoutes(app) {
    /**
     * GET /api/bugs - Retrieves bugs based on current user's role and access.
     */
    app.get('/api/bugs', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            console.log(`📋 Fetching bugs for user ${currentUser.id} with role ${currentUser.role}`);
            const bugs = await storage_1.storage.getBugsForUser(currentUser.id, currentUser.role, currentUser.organizationId);
            console.log(`✅ Found ${bugs.length} bugs for user ${currentUser.id}`);
            res.json(bugs);
        }
        catch (error) {
            console.error('❌ Error fetching bugs:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch bugs',
            });
        }
    });
    /**
     * GET /api/bugs/:id - Retrieves a specific bug by ID.
     */
    app.get('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            const bug = await storage_1.storage.getBug(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!bug) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            res.json(bug);
        }
        catch (error) {
            console.error('❌ Error fetching bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch bug',
            });
        }
    });
    /**
     * POST /api/bugs - Creates a new bug report with optional file attachments.
     */
    app.post('/api/bugs', auth_1.requireAuth, upload.array('attachments', 10), async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Validate the request body
            const validation = schema_1.insertBugSchema.safeParse({
                ...req.body,
                createdBy: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid bug data',
                    details: validation.error.issues,
                });
            }
            const bugData = validation.data;
            const bug = await storage_1.storage.createBug(bugData);
            // Handle file attachments if present
            if (req.files && req.files.length > 0) {
                console.log(`📎 Processing ${req.files.length} attachments for bug ${bug.id}`);
                for (const file of req.files) {
                    // Create document record for each attachment
                    const documentData = {
                        name: file.originalname,
                        description: `Attachment for bug: ${bug.title}`,
                        documentType: 'attachment',
                        filePath: `general/${file.filename}`,
                        fileName: file.originalname,
                        fileSize: file.size.toString(),
                        attachedToType: 'bug',
                        attachedToId: bug.id,
                        uploadedById: currentUser.id,
                    };
                    await storage_1.storage.createDocument({
                        ...documentData,
                        isVisibleToTenants: false
                    });
                    console.log(`📄 Created attachment document for bug ${bug.id}: ${file.originalname}`);
                }
            }
            console.log(`🐛 Created new bug ${bug.id} by user ${currentUser.id}`);
            res.status(201).json(bug);
        }
        catch (error) {
            console.error('❌ Error creating bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to create bug',
            });
        }
    });
    /**
     * PATCH /api/bugs/:id - Updates an existing bug.
     * Users can edit their own bugs, admins and managers can edit any bug.
     */
    app.patch('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            // Validate the request body
            const updateSchema = zod_1.z.object({
                title: zod_1.z
                    .string()
                    .min(1, 'Title is required')
                    .max(200, 'Title must not exceed 200 characters')
                    .optional(),
                description: zod_1.z
                    .string()
                    .min(10, 'Description must be at least 10 characters')
                    .max(2000, 'Description must not exceed 2000 characters')
                    .optional(),
                category: zod_1.z
                    .enum([
                    'ui_ux',
                    'functionality',
                    'performance',
                    'data',
                    'security',
                    'integration',
                    'other',
                ])
                    .optional(),
                page: zod_1.z.string().min(1, 'Page is required').optional(),
                priority: zod_1.z.enum(['low', 'medium', 'high', 'critical']).optional(),
                reproductionSteps: zod_1.z.string().optional(),
                environment: zod_1.z.string().optional(),
                status: zod_1.z.enum(['new', 'acknowledged', 'in_progress', 'resolved', 'closed']).optional(),
                assignedTo: zod_1.z.string().uuid().nullable().optional(),
                notes: zod_1.z.string().optional(),
                resolvedBy: zod_1.z.string().uuid().nullable().optional(),
                resolvedAt: zod_1.z.date().nullable().optional(),
            });
            const validation = updateSchema.safeParse(req.body);
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid update data',
                    details: validation.error.issues,
                });
            }
            const updates = validation.data;
            const bug = await storage_1.storage.updateBug(id, updates, currentUser.id, currentUser.role);
            if (!bug) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            console.log(`📝 Updated bug ${id} by user ${currentUser.id}`);
            res.json(bug);
        }
        catch (error) {
            console.error('❌ Error updating bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to update bug',
            });
        }
    });
    /**
     * DELETE /api/bugs/:id - Deletes a bug.
     * Only admins can delete bugs.
     */
    app.delete('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            const deleted = await storage_1.storage.deleteBug(id, currentUser.id, currentUser.role);
            if (!deleted) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            console.log(`🗑️ Deleted bug ${id} by user ${currentUser.id}`);
            res.status(204).send();
        }
        catch (error) {
            console.error('❌ Error deleting bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to delete bug',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUM7b0JBQzFCLEtBQUssRUFBRSxhQUFhO29CQUNwQixPQUFPLEVBQUUsb0JBQW9CO2lCQUM5QixDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxpQkFBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLEVBQUUsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFOUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNiLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzFCLEtBQUssRUFBRSxXQUFXO29CQUNsQixPQUFPLEVBQUUsZ0NBQWdDO2lCQUMxQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxZQUFZLFdBQVcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekIsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM5QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsS0FBSyxFQUFFLHVCQUF1QjtnQkFDOUIsT0FBTyxFQUFFLHNCQUFzQjthQUNoQyxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2FwaS9idWdzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgRXhwcmVzcyB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gJy4uL3N0b3JhZ2UnO1xuaW1wb3J0IHsgaW5zZXJ0QnVnU2NoZW1hLCB0eXBlIEJ1ZywgdHlwZSBJbnNlcnRCdWcgfSBmcm9tICdAc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vYXV0aCc7XG5pbXBvcnQgbXVsdGVyIGZyb20gJ211bHRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuLy8gQ29uZmlndXJlIG11bHRlciBmb3IgZmlsZSB1cGxvYWRzXG5jb25zdCBzdG9yYWdlX2NvbmZpZyA9IG11bHRlci5kaXNrU3RvcmFnZSh7XG4gIGRlc3RpbmF0aW9uOiAocmVxLCBmaWxlLCBjYikgPT4ge1xuICAgIGNvbnN0IHVwbG9hZERpciA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAndXBsb2FkcycsICdnZW5lcmFsJyk7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHVwbG9hZERpcikpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh1cGxvYWREaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cbiAgICBjYihudWxsLCB1cGxvYWREaXIpO1xuICB9LFxuICBmaWxlbmFtZTogKHJlcSwgZmlsZSwgY2IpID0+IHtcbiAgICBjb25zdCB1bmlxdWVJZCA9IHV1aWR2NCgpO1xuICAgIGNvbnN0IG9yaWdpbmFsTmFtZSA9IGZpbGUub3JpZ2luYWxuYW1lLnJlcGxhY2UoL1teYS16QS1aMC05Li1dL2csICdfJyk7XG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHt1bmlxdWVJZH0tJHtvcmlnaW5hbE5hbWV9YDtcbiAgICBjYihudWxsLCBmaWxlTmFtZSk7XG4gIH0sXG59KTtcblxuY29uc3QgdXBsb2FkID0gbXVsdGVyKHsgc3RvcmFnZTogc3RvcmFnZV9jb25maWcgfSk7XG5cbi8qKlxuICogUmVnaXN0ZXJzIGFsbCBidWctcmVsYXRlZCBBUEkgZW5kcG9pbnRzLlxuICpcbiAqIEBwYXJhbSBhcHAgLSBFeHByZXNzIGFwcGxpY2F0aW9uIGluc3RhbmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJCdWdSb3V0ZXMoYXBwOiBFeHByZXNzKTogdm9pZCB7XG4gIC8qKlxuICAgKiBHRVQgL2FwaS9idWdzIC0gUmV0cmlldmVzIGJ1Z3MgYmFzZWQgb24gY3VycmVudCB1c2VyJ3Mgcm9sZSBhbmQgYWNjZXNzLlxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9idWdzJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+TiyBGZXRjaGluZyBidWdzIGZvciB1c2VyICR7Y3VycmVudFVzZXIuaWR9IHdpdGggcm9sZSAke2N1cnJlbnRVc2VyLnJvbGV9YCk7XG5cbiAgICAgIGNvbnN0IGJ1Z3MgPSBhd2FpdCBzdG9yYWdlLmdldEJ1Z3NGb3JVc2VyKFxuICAgICAgICBjdXJyZW50VXNlci5pZCxcbiAgICAgICAgY3VycmVudFVzZXIucm9sZSxcbiAgICAgICAgY3VycmVudFVzZXIub3JnYW5pemF0aW9uSWRcbiAgICAgICk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDinIUgRm91bmQgJHtidWdzLmxlbmd0aH0gYnVncyBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLmpzb24oYnVncyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGJ1Z3M6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggYnVncycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBHRVQgL2FwaS9idWdzLzppZCAtIFJldHJpZXZlcyBhIHNwZWNpZmljIGJ1ZyBieSBJRC5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvYnVncy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0JhZCByZXF1ZXN0JyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIElEIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1ZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVnKFxuICAgICAgICBpZCxcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUsXG4gICAgICAgIGN1cnJlbnRVc2VyLm9yZ2FuaXphdGlvbklkXG4gICAgICApO1xuXG4gICAgICBpZiAoIWJ1Zykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBidWcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogUE9TVCAvYXBpL2J1Z3MgLSBDcmVhdGVzIGEgbmV3IGJ1ZyByZXBvcnQgd2l0aCBvcHRpb25hbCBmaWxlIGF0dGFjaG1lbnRzLlxuICAgKi9cbiAgYXBwLnBvc3QoJy9hcGkvYnVncycsIHJlcXVpcmVBdXRoLCB1cGxvYWQuYXJyYXkoJ2F0dGFjaG1lbnRzJywgMTApLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHJlcXVlc3QgYm9keVxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGluc2VydEJ1Z1NjaGVtYS5zYWZlUGFyc2Uoe1xuICAgICAgICAuLi5yZXEuYm9keSxcbiAgICAgICAgY3JlYXRlZEJ5OiBjdXJyZW50VXNlci5pZCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXZhbGlkYXRpb24uc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIGJ1ZyBkYXRhJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1Z0RhdGEgPSB2YWxpZGF0aW9uLmRhdGE7XG4gICAgICBjb25zdCBidWcgPSBhd2FpdCBzdG9yYWdlLmNyZWF0ZUJ1ZyhidWdEYXRhKTtcblxuICAgICAgLy8gSGFuZGxlIGZpbGUgYXR0YWNobWVudHMgaWYgcHJlc2VudFxuICAgICAgaWYgKHJlcS5maWxlcyAmJiByZXEuZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zb2xlLmxvZyhg8J+TjiBQcm9jZXNzaW5nICR7cmVxLmZpbGVzLmxlbmd0aH0gYXR0YWNobWVudHMgZm9yIGJ1ZyAke2J1Zy5pZH1gKTtcblxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgcmVxLmZpbGVzKSB7XG4gICAgICAgICAgLy8gQ3JlYXRlIGRvY3VtZW50IHJlY29yZCBmb3IgZWFjaCBhdHRhY2htZW50XG4gICAgICAgICAgY29uc3QgZG9jdW1lbnREYXRhID0ge1xuICAgICAgICAgICAgbmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYEF0dGFjaG1lbnQgZm9yIGJ1ZzogJHtidWcudGl0bGV9YCxcbiAgICAgICAgICAgIGRvY3VtZW50VHlwZTogJ2F0dGFjaG1lbnQnLFxuICAgICAgICAgICAgZmlsZVBhdGg6IGBnZW5lcmFsLyR7ZmlsZS5maWxlbmFtZX1gLFxuICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGUub3JpZ2luYWxuYW1lLFxuICAgICAgICAgICAgZmlsZVNpemU6IGZpbGUuc2l6ZS50b1N0cmluZygpLFxuICAgICAgICAgICAgYXR0YWNoZWRUb1R5cGU6ICdidWcnIGFzIGNvbnN0LFxuICAgICAgICAgICAgYXR0YWNoZWRUb0lkOiBidWcuaWQsXG4gICAgICAgICAgICB1cGxvYWRlZEJ5SWQ6IGN1cnJlbnRVc2VyLmlkLFxuICAgICAgICAgIH07XG5cblxuICAgICAgICAgIGF3YWl0IHN0b3JhZ2UuY3JlYXRlRG9jdW1lbnQoe1xuICAgICAgICAgICAgLi4uZG9jdW1lbnREYXRhLFxuICAgICAgICAgICAgaXNWaXNpYmxlVG9UZW5hbnRzOiBmYWxzZVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5OEIENyZWF0ZWQgYXR0YWNobWVudCBkb2N1bWVudCBmb3IgYnVnICR7YnVnLmlkfTogJHtmaWxlLm9yaWdpbmFsbmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+QmyBDcmVhdGVkIG5ldyBidWcgJHtidWcuaWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGNyZWF0aW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgYnVnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBBVENIIC9hcGkvYnVncy86aWQgLSBVcGRhdGVzIGFuIGV4aXN0aW5nIGJ1Zy5cbiAgICogVXNlcnMgY2FuIGVkaXQgdGhlaXIgb3duIGJ1Z3MsIGFkbWlucyBhbmQgbWFuYWdlcnMgY2FuIGVkaXQgYW55IGJ1Zy5cbiAgICovXG4gIGFwcC5wYXRjaCgnL2FwaS9idWdzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWcgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHJlcXVlc3QgYm9keVxuICAgICAgY29uc3QgdXBkYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgICB0aXRsZTogelxuICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgIC5taW4oMSwgJ1RpdGxlIGlzIHJlcXVpcmVkJylcbiAgICAgICAgICAubWF4KDIwMCwgJ1RpdGxlIG11c3Qgbm90IGV4Y2VlZCAyMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiB6XG4gICAgICAgICAgLnN0cmluZygpXG4gICAgICAgICAgLm1pbigxMCwgJ0Rlc2NyaXB0aW9uIG11c3QgYmUgYXQgbGVhc3QgMTAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm1heCgyMDAwLCAnRGVzY3JpcHRpb24gbXVzdCBub3QgZXhjZWVkIDIwMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIGNhdGVnb3J5OiB6XG4gICAgICAgICAgLmVudW0oW1xuICAgICAgICAgICAgJ3VpX3V4JyxcbiAgICAgICAgICAgICdmdW5jdGlvbmFsaXR5JyxcbiAgICAgICAgICAgICdwZXJmb3JtYW5jZScsXG4gICAgICAgICAgICAnZGF0YScsXG4gICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgJ2ludGVncmF0aW9uJyxcbiAgICAgICAgICAgICdvdGhlcicsXG4gICAgICAgICAgXSlcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgcGFnZTogei5zdHJpbmcoKS5taW4oMSwgJ1BhZ2UgaXMgcmVxdWlyZWQnKS5vcHRpb25hbCgpLFxuICAgICAgICBwcmlvcml0eTogei5lbnVtKFsnbG93JywgJ21lZGl1bScsICdoaWdoJywgJ2NyaXRpY2FsJ10pLm9wdGlvbmFsKCksXG4gICAgICAgIHJlcHJvZHVjdGlvblN0ZXBzOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICAgIGVudmlyb25tZW50OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICAgIHN0YXR1czogei5lbnVtKFsnbmV3JywgJ2Fja25vd2xlZGdlZCcsICdpbl9wcm9ncmVzcycsICdyZXNvbHZlZCcsICdjbG9zZWQnXSkub3B0aW9uYWwoKSxcbiAgICAgICAgYXNzaWduZWRUbzogei5zdHJpbmcoKS51dWlkKCkubnVsbGFibGUoKS5vcHRpb25hbCgpLFxuICAgICAgICBub3Rlczogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgICAgICByZXNvbHZlZEJ5OiB6LnN0cmluZygpLnV1aWQoKS5udWxsYWJsZSgpLm9wdGlvbmFsKCksXG4gICAgICAgIHJlc29sdmVkQXQ6IHouZGF0ZSgpLm51bGxhYmxlKCkub3B0aW9uYWwoKSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdXBkYXRlU2NoZW1hLnNhZmVQYXJzZShyZXEuYm9keSk7XG4gICAgICBpZiAoIXZhbGlkYXRpb24uc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIHVwZGF0ZSBkYXRhJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVwZGF0ZXMgPSB2YWxpZGF0aW9uLmRhdGE7XG4gICAgICBjb25zdCBidWcgPSBhd2FpdCBzdG9yYWdlLnVwZGF0ZUJ1ZyhpZCwgdXBkYXRlcywgY3VycmVudFVzZXIuaWQsIGN1cnJlbnRVc2VyLnJvbGUpO1xuXG4gICAgICBpZiAoIWJ1Zykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5OdIFVwZGF0ZWQgYnVnICR7aWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwZGF0aW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgYnVnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIERFTEVURSAvYXBpL2J1Z3MvOmlkIC0gRGVsZXRlcyBhIGJ1Zy5cbiAgICogT25seSBhZG1pbnMgY2FuIGRlbGV0ZSBidWdzLlxuICAgKi9cbiAgYXBwLmRlbGV0ZSgnL2FwaS9idWdzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWcgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IHN0b3JhZ2UuZGVsZXRlQnVnKGlkLCBjdXJyZW50VXNlci5pZCwgY3VycmVudFVzZXIucm9sZSk7XG5cbiAgICAgIGlmICghZGVsZXRlZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5eR77iPIERlbGV0ZWQgYnVnICR7aWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5zdGF0dXMoMjA0KS5zZW5kKCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGRlbGV0aW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBkZWxldGUgYnVnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG4iXSwidmVyc2lvbiI6M30=