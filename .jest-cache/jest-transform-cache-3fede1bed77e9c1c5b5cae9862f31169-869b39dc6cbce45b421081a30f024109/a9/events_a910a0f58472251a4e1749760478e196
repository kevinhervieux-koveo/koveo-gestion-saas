df72cafc0f1ff657fefd4328dbaaedbc
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.createEvent = createEvent;
exports.fireEvent = fireEvent;
var _config = require("./config");
var _helpers = require("./helpers");
var _eventMap = require("./event-map");
function fireEvent(element, event) {
    return (0, _config.getConfig)().eventWrapper(() => {
        if (!event) {
            throw new Error(`Unable to fire an event - please provide an event object.`);
        }
        if (!element) {
            throw new Error(`Unable to fire a "${event.type}" event - please provide a DOM element.`);
        }
        return element.dispatchEvent(event);
    });
}
function createEvent(eventName, node, init, { EventType = 'Event', defaultInit = {} } = {}) {
    if (!node) {
        throw new Error(`Unable to fire a "${eventName}" event - please provide a DOM element.`);
    }
    const eventInit = {
        ...defaultInit,
        ...init
    };
    const { target: { value, files, ...targetProperties } = {} } = eventInit;
    if (value !== undefined) {
        setNativeValue(node, value);
    }
    if (files !== undefined) {
        // input.files is a read-only property so this is not allowed:
        // input.files = [file]
        // so we have to use this workaround to set the property
        Object.defineProperty(node, 'files', {
            configurable: true,
            enumerable: true,
            writable: true,
            value: files
        });
    }
    Object.assign(node, targetProperties);
    const window = (0, _helpers.getWindowFromNode)(node);
    const EventConstructor = window[EventType] || window.Event;
    let event;
    /* istanbul ignore else  */
    if (typeof EventConstructor === 'function') {
        event = new EventConstructor(eventName, eventInit);
    }
    else {
        // IE11 polyfill from https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Polyfill
        event = window.document.createEvent(EventType);
        const { bubbles, cancelable, detail, ...otherInit } = eventInit;
        event.initEvent(eventName, bubbles, cancelable, detail);
        Object.keys(otherInit).forEach(eventKey => {
            event[eventKey] = otherInit[eventKey];
        });
    }
    // DataTransfer is not supported in jsdom: https://github.com/jsdom/jsdom/issues/1568
    const dataTransferProperties = ['dataTransfer', 'clipboardData'];
    dataTransferProperties.forEach(dataTransferKey => {
        const dataTransferValue = eventInit[dataTransferKey];
        if (typeof dataTransferValue === 'object') {
            /* istanbul ignore if  */
            if (typeof window.DataTransfer === 'function') {
                Object.defineProperty(event, dataTransferKey, {
                    value: Object.getOwnPropertyNames(dataTransferValue).reduce((acc, propName) => {
                        Object.defineProperty(acc, propName, {
                            value: dataTransferValue[propName]
                        });
                        return acc;
                    }, new window.DataTransfer())
                });
            }
            else {
                Object.defineProperty(event, dataTransferKey, {
                    value: dataTransferValue
                });
            }
        }
    });
    return event;
}
Object.keys(_eventMap.eventMap).forEach(key => {
    const { EventType, defaultInit } = _eventMap.eventMap[key];
    const eventName = key.toLowerCase();
    createEvent[key] = (node, init) => createEvent(eventName, node, init, {
        EventType,
        defaultInit
    });
    fireEvent[key] = (node, init) => fireEvent(node, createEvent[key](node, init));
});
// function written after some investigation here:
// https://github.com/facebook/react/issues/10135#issuecomment-401496776
function setNativeValue(element, value) {
    const { set: valueSetter } = Object.getOwnPropertyDescriptor(element, 'value') || {};
    const prototype = Object.getPrototypeOf(element);
    const { set: prototypeValueSetter } = Object.getOwnPropertyDescriptor(prototype, 'value') || {};
    if (prototypeValueSetter && valueSetter !== prototypeValueSetter) {
        prototypeValueSetter.call(element, value);
    }
    else {
        /* istanbul ignore if */
        // eslint-disable-next-line no-lonely-if -- Can't be ignored by istanbul otherwise
        if (valueSetter) {
            valueSetter.call(element, value);
        }
        else {
            throw new Error('The given element does not have a value setter');
        }
    }
}
Object.keys(_eventMap.eventAliasMap).forEach(aliasKey => {
    const key = _eventMap.eventAliasMap[aliasKey];
    fireEvent[aliasKey] = (...args) => fireEvent[key](...args);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS9kb20vZGlzdC9ldmVudHMuanMiLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFO0lBQzNDLEtBQUssRUFBRSxJQUFJO0NBQ1osQ0FBQyxDQUFDO0FBQ0gsT0FBTyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7QUFDbEMsT0FBTyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFDOUIsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2xDLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwQyxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDdkMsU0FBUyxTQUFTLENBQUMsT0FBTyxFQUFFLEtBQUs7SUFDL0IsT0FBTyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFO1FBQ2hELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsMkRBQTJELENBQUMsQ0FBQztRQUMvRSxDQUFDO1FBQ0QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsS0FBSyxDQUFDLElBQUkseUNBQXlDLENBQUMsQ0FBQztRQUM1RixDQUFDO1FBQ0QsT0FBTyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUNELFNBQVMsV0FBVyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQzFDLFNBQVMsR0FBRyxPQUFPLEVBQ25CLFdBQVcsR0FBRyxFQUFFLEVBQ2pCLEdBQUcsRUFBRTtJQUNKLElBQUksQ0FBQyxJ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QUFFLENBQUM7SUFDNUQsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqRCxNQUFNLEVBQ0osR0FBRyxFQUFFLG9CQUFvQixFQUMxQixHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzlELElBQUksb0JBQW9CLElBQUksV0FBVyxLQUFLLG9CQUFvQixFQUFFLENBQUM7UUFDakUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM1QyxDQUFDO1NBQU0sQ0FBQztRQUNOLHdCQUF3QjtRQUN4QixrRkFBa0Y7UUFDbEYsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNuQyxDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0RBQWdELENBQUMsQ0FBQztRQUNwRSxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7SUFDdEQsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5QyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDN0QsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS9kb20vZGlzdC9ldmVudHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmNyZWF0ZUV2ZW50ID0gY3JlYXRlRXZlbnQ7XG5leHBvcnRzLmZpcmVFdmVudCA9IGZpcmVFdmVudDtcbnZhciBfY29uZmlnID0gcmVxdWlyZShcIi4vY29uZmlnXCIpO1xudmFyIF9oZWxwZXJzID0gcmVxdWlyZShcIi4vaGVscGVyc1wiKTtcbnZhciBfZXZlbnRNYXAgPSByZXF1aXJlKFwiLi9ldmVudC1tYXBcIik7XG5mdW5jdGlvbiBmaXJlRXZlbnQoZWxlbWVudCwgZXZlbnQpIHtcbiAgcmV0dXJuICgwLCBfY29uZmlnLmdldENvbmZpZykoKS5ldmVudFdyYXBwZXIoKCkgPT4ge1xuICAgIGlmICghZXZlbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpcmUgYW4gZXZlbnQgLSBwbGVhc2UgcHJvdmlkZSBhbiBldmVudCBvYmplY3QuYCk7XG4gICAgfVxuICAgIGlmICghZWxlbWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmlyZSBhIFwiJHtldmVudC50eXBlfVwiIGV2ZW50IC0gcGxlYXNlIHByb3ZpZGUgYSBET00gZWxlbWVudC5gKTtcbiAgICB9XG4gICAgcmV0dXJuIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gIH0pO1xufVxuZnVuY3Rpb24gY3JlYXRlRXZlbnQoZXZlbnROYW1lLCBub2RlLCBpbml0LCB7XG4gIEV2ZW50VHlwZSA9ICdFdmVudCcsXG4gIGRlZmF1bHRJbml0ID0ge31cbn0gPSB7fSkge1xuICBpZiAoIW5vZGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaXJlIGEgXCIke2V2ZW50TmFtZX1cIiBldmVudCAtIHBsZWFzZSBwcm92aWRlIGEgRE9NIGVsZW1lbnQuYCk7XG4gIH1cbiAgY29uc3QgZXZlbnRJbml0ID0ge1xuICAgIC4uLmRlZmF1bHRJbml0LFxuICAgIC4uLmluaXRcbiAgfTtcbiAgY29uc3Qge1xuICAgIHRhcmdldDoge1xuICAgICAgdmFsdWUsXG4gICAgICBmaWxlcyxcbiAgICAgIC4uLnRhcmdldFByb3BlcnRpZXNcbiAgICB9ID0ge31cbiAgfSA9IGV2ZW50SW5pdDtcbiAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICBzZXROYXRpdmVWYWx1ZShub2RlLCB2YWx1ZSk7XG4gIH1cbiAgaWYgKGZpbGVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyBpbnB1dC5maWxlcyBpcyBhIHJlYWQtb25seSBwcm9wZXJ0eSBzbyB0aGlzIGlzIG5vdCBhbGxvd2VkOlxuICAgIC8vIGlucHV0LmZpbGVzID0gW2ZpbGVdXG4gICAgLy8gc28gd2UgaGF2ZSB0byB1c2UgdGhpcyB3b3JrYXJvdW5kIHRvIHNldCB0aGUgcHJvcGVydHlcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgJ2ZpbGVzJywge1xuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgdmFsdWU6IGZpbGVzXG4gICAgfSk7XG4gIH1cbiAgT2JqZWN0LmFzc2lnbihub2RlLCB0YXJnZXRQcm9wZXJ0aWVzKTtcbiAgY29uc3Qgd2luZG93ID0gKDAsIF9oZWxwZXJzLmdldFdpbmRvd0Zyb21Ob2RlKShub2RlKTtcbiAgY29uc3QgRXZlbnRDb25zdHJ1Y3RvciA9IHdpbmRvd1tFdmVudFR5cGVdIHx8IHdpbmRvdy5FdmVudDtcbiAgbGV0IGV2ZW50O1xuICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAgKi9cbiAgaWYgKHR5cGVvZiBFdmVudENvbnN0cnVjdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgZXZlbnQgPSBuZXcgRXZlbnRDb25zdHJ1Y3RvcihldmVudE5hbWUsIGV2ZW50SW5pdCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gSUUxMSBwb2x5ZmlsbCBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9DdXN0b21FdmVudC9DdXN0b21FdmVudCNQb2x5ZmlsbFxuICAgIGV2ZW50ID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUV2ZW50KEV2ZW50VHlwZSk7XG4gICAgY29uc3Qge1xuICAgICAgYnViYmxlcyxcbiAgICAgIGNhbmNlbGFibGUsXG4gICAgICBkZXRhaWwsXG4gICAgICAuLi5vdGhlckluaXRcbiAgICB9ID0gZXZlbnRJbml0O1xuICAgIGV2ZW50LmluaXRFdmVudChldmVudE5hbWUsIGJ1YmJsZXMsIGNhbmNlbGFibGUsIGRldGFpbCk7XG4gICAgT2JqZWN0LmtleXMob3RoZXJJbml0KS5mb3JFYWNoKGV2ZW50S2V5ID0+IHtcbiAgICAgIGV2ZW50W2V2ZW50S2V5XSA9IG90aGVySW5pdFtldmVudEtleV07XG4gICAgfSk7XG4gIH1cblxuICAvLyBEYXRhVHJhbnNmZXIgaXMgbm90IHN1cHBvcnRlZCBpbiBqc2RvbTogaHR0cHM6Ly9naXRodWIuY29tL2pzZG9tL2pzZG9tL2lzc3Vlcy8xNTY4XG4gIGNvbnN0IGRhdGFUcmFuc2ZlclByb3BlcnRpZXMgPSBbJ2RhdGFUcmFuc2ZlcicsICdjbGlwYm9hcmREYXRhJ107XG4gIGRhdGFUcmFuc2ZlclByb3BlcnRpZXMuZm9yRWFjaChkYXRhVHJhbnNmZXJLZXkgPT4ge1xuICAgIGNvbnN0IGRhdGFUcmFuc2ZlclZhbHVlID0gZXZlbnRJbml0W2RhdGFUcmFuc2ZlcktleV07XG4gICAgaWYgKHR5cGVvZiBkYXRhVHJhbnNmZXJWYWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAgKi9cbiAgICAgIGlmICh0eXBlb2Ygd2luZG93LkRhdGFUcmFuc2ZlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXZlbnQsIGRhdGFUcmFuc2ZlcktleSwge1xuICAgICAgICAgIHZhbHVlOiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhkYXRhVHJhbnNmZXJWYWx1ZSkucmVkdWNlKChhY2MsIHByb3BOYW1lKSA9PiB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYWNjLCBwcm9wTmFtZSwge1xuICAgICAgICAgICAgICB2YWx1ZTogZGF0YVRyYW5zZmVyVmFsdWVbcHJvcE5hbWVdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgICAgfSwgbmV3IHdpbmRvdy5EYXRhVHJhbnNmZXIoKSlcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXZlbnQsIGRhdGFUcmFuc2ZlcktleSwge1xuICAgICAgICAgIHZhbHVlOiBkYXRhVHJhbnNmZXJWYWx1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICByZXR1cm4gZXZlbnQ7XG59XG5PYmplY3Qua2V5cyhfZXZlbnRNYXAuZXZlbnRNYXApLmZvckVhY2goa2V5ID0+IHtcbiAgY29uc3Qge1xuICAgIEV2ZW50VHlwZSxcbiAgICBkZWZhdWx0SW5pdFxuICB9ID0gX2V2ZW50TWFwLmV2ZW50TWFwW2tleV07XG4gIGNvbnN0IGV2ZW50TmFtZSA9IGtleS50b0xvd2VyQ2FzZSgpO1xuICBjcmVhdGVFdmVudFtrZXldID0gKG5vZGUsIGluaXQpID0+IGNyZWF0ZUV2ZW50KGV2ZW50TmFtZSwgbm9kZSwgaW5pdCwge1xuICAgIEV2ZW50VHlwZSxcbiAgICBkZWZhdWx0SW5pdFxuICB9KTtcbiAgZmlyZUV2ZW50W2tleV0gPSAobm9kZSwgaW5pdCkgPT4gZmlyZUV2ZW50KG5vZGUsIGNyZWF0ZUV2ZW50W2tleV0obm9kZSwgaW5pdCkpO1xufSk7XG5cbi8vIGZ1bmN0aW9uIHdyaXR0ZW4gYWZ0ZXIgc29tZSBpbnZlc3RpZ2F0aW9uIGhlcmU6XG4vLyBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzEwMTM1I2lzc3VlY29tbWVudC00MDE0OTY3NzZcbmZ1bmN0aW9uIHNldE5hdGl2ZVZhbHVlKGVsZW1lbnQsIHZhbHVlKSB7XG4gIGNvbnN0IHtcbiAgICBzZXQ6IHZhbHVlU2V0dGVyXG4gIH0gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGVsZW1lbnQsICd2YWx1ZScpIHx8IHt9O1xuICBjb25zdCBwcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoZWxlbWVudCk7XG4gIGNvbnN0IHtcbiAgICBzZXQ6IHByb3RvdHlwZVZhbHVlU2V0dGVyXG4gIH0gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvdHlwZSwgJ3ZhbHVlJykgfHwge307XG4gIGlmIChwcm90b3R5cGVWYWx1ZVNldHRlciAmJiB2YWx1ZVNldHRlciAhPT0gcHJvdG90eXBlVmFsdWVTZXR0ZXIpIHtcbiAgICBwcm90b3R5cGVWYWx1ZVNldHRlci5jYWxsKGVsZW1lbnQsIHZhbHVlKTtcbiAgfSBlbHNlIHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbG9uZWx5LWlmIC0tIENhbid0IGJlIGlnbm9yZWQgYnkgaXN0YW5idWwgb3RoZXJ3aXNlXG4gICAgaWYgKHZhbHVlU2V0dGVyKSB7XG4gICAgICB2YWx1ZVNldHRlci5jYWxsKGVsZW1lbnQsIHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgZ2l2ZW4gZWxlbWVudCBkb2VzIG5vdCBoYXZlIGEgdmFsdWUgc2V0dGVyJyk7XG4gICAgfVxuICB9XG59XG5PYmplY3Qua2V5cyhfZXZlbnRNYXAuZXZlbnRBbGlhc01hcCkuZm9yRWFjaChhbGlhc0tleSA9PiB7XG4gIGNvbnN0IGtleSA9IF9ldmVudE1hcC5ldmVudEFsaWFzTWFwW2FsaWFzS2V5XTtcbiAgZmlyZUV2ZW50W2FsaWFzS2V5XSA9ICguLi5hcmdzKSA9PiBmaXJlRXZlbnRba2V5XSguLi5hcmdzKTtcbn0pO1xuXG4vKiBlc2xpbnQgY29tcGxleGl0eTpbXCJlcnJvclwiLCA5XSAqLyJdLCJ2ZXJzaW9uIjozfQ==