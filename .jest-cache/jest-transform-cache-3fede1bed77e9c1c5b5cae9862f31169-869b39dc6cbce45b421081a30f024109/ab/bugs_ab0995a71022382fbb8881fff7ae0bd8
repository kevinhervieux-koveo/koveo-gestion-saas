4ad8b23fea123fa5503a50c430e5babc
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerBugRoutes = registerBugRoutes;
const storage_1 = require("../storage");
const schema_1 = require("@shared/schema");
const zod_1 = require("zod");
const auth_1 = require("../auth");
const multer_1 = __importDefault(require("multer"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const uuid_1 = require("uuid");
// Configure multer for file uploads
const storage_config = multer_1.default.diskStorage({
    destination: (req, file, cb) => {
        const uploadDir = path_1.default.join(process.cwd(), 'uploads', 'general');
        if (!fs_1.default.existsSync(uploadDir)) {
            fs_1.default.mkdirSync(uploadDir, { recursive: true });
        }
        cb(null, uploadDir);
    },
    filename: (req, file, cb) => {
        const uniqueId = (0, uuid_1.v4)();
        const originalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
        const fileName = `${uniqueId}-${originalName}`;
        cb(null, fileName);
    },
});
const upload = (0, multer_1.default)({ storage: storage_config });
/**
 * Registers all bug-related API endpoints.
 *
 * @param app - Express application instance.
 */
function registerBugRoutes(app) {
    /**
     * GET /api/bugs - Retrieves bugs based on current user's role and access.
     */
    app.get('/api/bugs', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            console.log(`üìã Fetching bugs for user ${currentUser.id} with role ${currentUser.role}`);
            const bugs = await storage_1.storage.getBugsForUser(currentUser.id, currentUser.role, currentUser.organizationId);
            console.log(`‚úÖ Found ${bugs.length} bugs for user ${currentUser.id}`);
            // Debug: Log file attachment info for each bug
            bugs.forEach(bug => {
                if (bug.file_path) {
                    console.log(`üîó Bug ${bug.id} has file: ${bug.file_name} at ${bug.file_path}`);
                }
            });
            res.json(bugs);
        }
        catch (error) {
            console.error('‚ùå Error fetching bugs:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch bugs',
            });
        }
    });
    /**
     * GET /api/bugs/:id - Retrieves a specific bug by ID.
     */
    app.get('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            const bug = await storage_1.storage.getBug(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!bug) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            res.json(bug);
        }
        catch (error) {
            console.error('‚ùå Error fetching bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch bug',
            });
        }
    });
    /**
     * POST /api/bugs - Creates a new bug report with optional single file attachment.
     */
    app.post('/api/bugs', auth_1.requireAuth, upload.single('attachment'), async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Validate the request body
            const validation = schema_1.insertBugSchema.safeParse({
                ...req.body,
                createdBy: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid bug data',
                    details: validation.error.issues,
                });
            }
            let bugData = validation.data;
            // Handle single file attachment if present
            if (req.file) {
                // Fix filename encoding issues
                const originalname = Buffer.from(req.file.originalname, 'latin1').toString('utf8');
                console.log(`üìé Processing attachment for new bug:`, {
                    originalname: originalname,
                    filename: req.file.filename,
                    size: req.file.size,
                    mimetype: req.file.mimetype
                });
                bugData = {
                    ...bugData,
                    filePath: `general/${req.file.filename}`,
                    fileName: originalname,
                    fileSize: req.file.size,
                };
            }
            // Log the final bugData before saving
            console.log(`üêõ Creating bug with data:`, {
                title: bugData.title,
                hasFile: !!bugData.filePath,
                filePath: bugData.filePath,
                fileName: bugData.fileName,
                fileSize: bugData.fileSize
            });
            const bug = await storage_1.storage.createBug(bugData);
            console.log(`‚úÖ Created new bug ${bug.id} by user ${currentUser.id}`);
            res.status(201).json(bug);
        }
        catch (error) {
            console.error('‚ùå Error creating bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to create bug',
            });
        }
    });
    /**
     * PATCH /api/bugs/:id - Updates an existing bug.
     * Users can edit their own bugs, admins and managers can edit any bug.
     */
    app.patch('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            // Validate the request body
            const updateSchema = zod_1.z.object({
                title: zod_1.z
                    .string()
                    .min(1, 'Title is required')
                    .max(200, 'Title must not exceed 200 characters')
                    .optional(),
                description: zod_1.z
                    .string()
                    .min(10, 'Description must be at least 10 characters')
                    .max(2000, 'Description must not exceed 2000 characters')
                    .optional(),
                category: zod_1.z
                    .enum([
                    'ui_ux',
                    'functionality',
                    'performance',
                    'data',
                    'security',
                    'integration',
                    'other',
                ])
                    .optional(),
                page: zod_1.z.string().min(1, 'Page is required').optional(),
                priority: zod_1.z.enum(['low', 'medium', 'high', 'critical']).optional(),
                reproductionSteps: zod_1.z.string().optional(),
                environment: zod_1.z.string().optional(),
                status: zod_1.z.enum(['new', 'acknowledged', 'in_progress', 'resolved', 'closed']).optional(),
                assignedTo: zod_1.z.string().uuid().nullable().optional(),
                notes: zod_1.z.string().optional(),
                resolvedBy: zod_1.z.string().uuid().nullable().optional(),
                resolvedAt: zod_1.z.date().nullable().optional(),
            });
            const validation = updateSchema.safeParse(req.body);
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid update data',
                    details: validation.error.issues,
                });
            }
            const updates = validation.data;
            const bug = await storage_1.storage.updateBug(id, updates, currentUser.id, currentUser.role);
            if (!bug) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            console.log(`üìù Updated bug ${id} by user ${currentUser.id}`);
            res.json(bug);
        }
        catch (error) {
            console.error('‚ùå Error updating bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to update bug',
            });
        }
    });
    /**
     * GET /api/bugs/:id/file - Serves the file attachment for a bug.
     */
    app.get('/api/bugs/:id/file', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const { download } = req.query;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Get the bug with file info
            const bug = await storage_1.storage.getBug(id, currentUser.id, currentUser.role, currentUser.organizationId);
            console.log('üêõ getBug result:', bug ? { id: bug.id, filePath: bug.filePath, fileName: bug.fileName } : 'undefined');
            if (!bug) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found',
                });
            }
            // Check both camelCase and snake_case field names for compatibility
            const filePath = bug.filePath || bug.file_path;
            const fileName = bug.fileName || bug.file_name;
            if (!filePath) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'No file attached to this bug',
                });
            }
            // Handle different path formats (absolute vs relative)
            const fullPath = path_1.default.isAbsolute(filePath)
                ? filePath
                : path_1.default.join(process.cwd(), 'uploads', filePath);
            // Check if file exists
            if (!fs_1.default.existsSync(fullPath)) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'File not found on server',
                });
            }
            // Detect MIME type based on file extension
            const getContentType = (filename) => {
                const ext = filename.toLowerCase().split('.').pop();
                switch (ext) {
                    case 'pdf': return 'application/pdf';
                    case 'jpg':
                    case 'jpeg': return 'image/jpeg';
                    case 'png': return 'image/png';
                    case 'gif': return 'image/gif';
                    case 'doc': return 'application/msword';
                    case 'docx': return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                    case 'txt': return 'text/plain';
                    default: return 'application/octet-stream';
                }
            };
            // Set proper content type for viewing
            const contentType = getContentType(fileName || 'attachment');
            res.setHeader('Content-Type', contentType);
            // Properly encode filename for French characters and other special characters
            const encodedFilename = Buffer.from(fileName || 'attachment', 'utf8').toString('binary');
            // Set appropriate headers
            if (download === 'true') {
                res.setHeader('Content-Disposition', `attachment; filename="${encodedFilename}"; filename*=UTF-8''${encodeURIComponent(fileName || 'attachment')}`);
            }
            else {
                res.setHeader('Content-Disposition', `inline; filename="${encodedFilename}"; filename*=UTF-8''${encodeURIComponent(fileName || 'attachment')}`);
            }
            // Stream the file
            const fileStream = fs_1.default.createReadStream(fullPath);
            fileStream.pipe(res);
            fileStream.on('error', (error) => {
                console.error(`‚ùå Error streaming file for bug ${id}:`, error);
                if (!res.headersSent) {
                    res.status(500).json({ error: 'Failed to stream file' });
                }
            });
        }
        catch (error) {
            console.error('‚ùå Error serving bug file:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to serve file',
            });
        }
    });
    /**
     * DELETE /api/bugs/:id - Deletes a bug.
     * Only admins can delete bugs.
     */
    app.delete('/api/bugs/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Bug ID is required',
                });
            }
            const deleted = await storage_1.storage.deleteBug(id, currentUser.id, currentUser.role);
            if (!deleted) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Bug not found or access denied',
                });
            }
            console.log(`üóëÔ∏è Deleted bug ${id} by user ${currentUser.id}`);
            res.status(204).send();
        }
        catch (error) {
            console.error('‚ùå Error deleting bug:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to delete bug',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LE1BQU0saUJBQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTlFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDYixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixLQUFLLEVBQUUsV0FBVztvQkFDbEIsT0FBTyxFQUFFLGdDQUFnQztpQkFDMUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsWUFBWSxXQUFXLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMvRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pCLENBQUM7UUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLEtBQUssRUFBRSx1QkFBdUI7Z0JBQzlCLE9BQU8sRUFBRSxzQkFBc0I7YUFDaEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9hcGkvYnVncy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEV4cHJlc3MgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tICcuLi9zdG9yYWdlJztcbmltcG9ydCB7IGluc2VydEJ1Z1NjaGVtYSwgdHlwZSBCdWcsIHR5cGUgSW5zZXJ0QnVnIH0gZnJvbSAnQHNoYXJlZC9zY2hlbWEnO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyByZXF1aXJlQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IG11bHRlciBmcm9tICdtdWx0ZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbi8vIENvbmZpZ3VyZSBtdWx0ZXIgZm9yIGZpbGUgdXBsb2Fkc1xuY29uc3Qgc3RvcmFnZV9jb25maWcgPSBtdWx0ZXIuZGlza1N0b3JhZ2Uoe1xuICBkZXN0aW5hdGlvbjogKHJlcSwgZmlsZSwgY2IpID0+IHtcbiAgICBjb25zdCB1cGxvYWREaXIgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3VwbG9hZHMnLCAnZ2VuZXJhbCcpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyh1cGxvYWREaXIpKSB7XG4gICAgICBmcy5ta2RpclN5bmModXBsb2FkRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG4gICAgY2IobnVsbCwgdXBsb2FkRGlyKTtcbiAgfSxcbiAgZmlsZW5hbWU6IChyZXEsIGZpbGUsIGNiKSA9PiB7XG4gICAgY29uc3QgdW5pcXVlSWQgPSB1dWlkdjQoKTtcbiAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSBmaWxlLm9yaWdpbmFsbmFtZS5yZXBsYWNlKC9bXmEtekEtWjAtOS4tXS9nLCAnXycpO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7dW5pcXVlSWR9LSR7b3JpZ2luYWxOYW1lfWA7XG4gICAgY2IobnVsbCwgZmlsZU5hbWUpO1xuICB9LFxufSk7XG5cbmNvbnN0IHVwbG9hZCA9IG11bHRlcih7IHN0b3JhZ2U6IHN0b3JhZ2VfY29uZmlnIH0pO1xuXG4vKipcbiAqIFJlZ2lzdGVycyBhbGwgYnVnLXJlbGF0ZWQgQVBJIGVuZHBvaW50cy5cbiAqXG4gKiBAcGFyYW0gYXBwIC0gRXhwcmVzcyBhcHBsaWNhdGlvbiBpbnN0YW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVyQnVnUm91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICAvKipcbiAgICogR0VUIC9hcGkvYnVncyAtIFJldHJpZXZlcyBidWdzIGJhc2VkIG9uIGN1cnJlbnQgdXNlcidzIHJvbGUgYW5kIGFjY2Vzcy5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvYnVncycsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfk4sgRmV0Y2hpbmcgYnVncyBmb3IgdXNlciAke2N1cnJlbnRVc2VyLmlkfSB3aXRoIHJvbGUgJHtjdXJyZW50VXNlci5yb2xlfWApO1xuXG4gICAgICBjb25zdCBidWdzID0gYXdhaXQgc3RvcmFnZS5nZXRCdWdzRm9yVXNlcihcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUsXG4gICAgICAgIGN1cnJlbnRVc2VyLm9yZ2FuaXphdGlvbklkXG4gICAgICApO1xuXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIEZvdW5kICR7YnVncy5sZW5ndGh9IGJ1Z3MgZm9yIHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIFxuICAgICAgLy8gRGVidWc6IExvZyBmaWxlIGF0dGFjaG1lbnQgaW5mbyBmb3IgZWFjaCBidWdcbiAgICAgIGJ1Z3MuZm9yRWFjaChidWcgPT4ge1xuICAgICAgICBpZiAoYnVnLmZpbGVfcGF0aCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5SXIEJ1ZyAke2J1Zy5pZH0gaGFzIGZpbGU6ICR7YnVnLmZpbGVfbmFtZX0gYXQgJHtidWcuZmlsZV9wYXRofWApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgcmVzLmpzb24oYnVncyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGJ1Z3M6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZmV0Y2ggYnVncycsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBHRVQgL2FwaS9idWdzLzppZCAtIFJldHJpZXZlcyBhIHNwZWNpZmljIGJ1ZyBieSBJRC5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvYnVncy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0JhZCByZXF1ZXN0JyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIElEIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1ZyA9IGF3YWl0IHN0b3JhZ2UuZ2V0QnVnKFxuICAgICAgICBpZCxcbiAgICAgICAgY3VycmVudFVzZXIuaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLnJvbGUsXG4gICAgICAgIGN1cnJlbnRVc2VyLm9yZ2FuaXphdGlvbklkXG4gICAgICApO1xuXG4gICAgICBpZiAoIWJ1Zykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBidWcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogUE9TVCAvYXBpL2J1Z3MgLSBDcmVhdGVzIGEgbmV3IGJ1ZyByZXBvcnQgd2l0aCBvcHRpb25hbCBzaW5nbGUgZmlsZSBhdHRhY2htZW50LlxuICAgKi9cbiAgYXBwLnBvc3QoJy9hcGkvYnVncycsIHJlcXVpcmVBdXRoLCB1cGxvYWQuc2luZ2xlKCdhdHRhY2htZW50JyksIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSB0aGUgcmVxdWVzdCBib2R5XG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gaW5zZXJ0QnVnU2NoZW1hLnNhZmVQYXJzZSh7XG4gICAgICAgIC4uLnJlcS5ib2R5LFxuICAgICAgICBjcmVhdGVkQnk6IGN1cnJlbnRVc2VyLmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgYnVnIGRhdGEnLFxuICAgICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3IuaXNzdWVzLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgbGV0IGJ1Z0RhdGEgPSB2YWxpZGF0aW9uLmRhdGE7XG5cbiAgICAgIC8vIEhhbmRsZSBzaW5nbGUgZmlsZSBhdHRhY2htZW50IGlmIHByZXNlbnRcbiAgICAgIGlmIChyZXEuZmlsZSkge1xuICAgICAgICAvLyBGaXggZmlsZW5hbWUgZW5jb2RpbmcgaXNzdWVzXG4gICAgICAgIGNvbnN0IG9yaWdpbmFsbmFtZSA9IEJ1ZmZlci5mcm9tKHJlcS5maWxlLm9yaWdpbmFsbmFtZSwgJ2xhdGluMScpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gICAgICAgIGNvbnNvbGUubG9nKGDwn5OOIFByb2Nlc3NpbmcgYXR0YWNobWVudCBmb3IgbmV3IGJ1ZzpgLCB7XG4gICAgICAgICAgb3JpZ2luYWxuYW1lOiBvcmlnaW5hbG5hbWUsXG4gICAgICAgICAgZmlsZW5hbWU6IHJlcS5maWxlLmZpbGVuYW1lLFxuICAgICAgICAgIHNpemU6IHJlcS5maWxlLnNpemUsXG4gICAgICAgICAgbWltZXR5cGU6IHJlcS5maWxlLm1pbWV0eXBlXG4gICAgICAgIH0pO1xuICAgICAgICBidWdEYXRhID0ge1xuICAgICAgICAgIC4uLmJ1Z0RhdGEsXG4gICAgICAgICAgZmlsZVBhdGg6IGBnZW5lcmFsLyR7cmVxLmZpbGUuZmlsZW5hbWV9YCxcbiAgICAgICAgICBmaWxlTmFtZTogb3JpZ2luYWxuYW1lLFxuICAgICAgICAgIGZpbGVTaXplOiByZXEuZmlsZS5zaXplLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBMb2cgdGhlIGZpbmFsIGJ1Z0RhdGEgYmVmb3JlIHNhdmluZ1xuICAgICAgY29uc29sZS5sb2coYPCfkJsgQ3JlYXRpbmcgYnVnIHdpdGggZGF0YTpgLCB7XG4gICAgICAgIHRpdGxlOiBidWdEYXRhLnRpdGxlLFxuICAgICAgICBoYXNGaWxlOiAhIWJ1Z0RhdGEuZmlsZVBhdGgsXG4gICAgICAgIGZpbGVQYXRoOiBidWdEYXRhLmZpbGVQYXRoLFxuICAgICAgICBmaWxlTmFtZTogYnVnRGF0YS5maWxlTmFtZSxcbiAgICAgICAgZmlsZVNpemU6IGJ1Z0RhdGEuZmlsZVNpemVcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBidWcgPSBhd2FpdCBzdG9yYWdlLmNyZWF0ZUJ1ZyhidWdEYXRhKTtcblxuICAgICAgY29uc29sZS5sb2coYOKchSBDcmVhdGVkIG5ldyBidWcgJHtidWcuaWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGNyZWF0aW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBjcmVhdGUgYnVnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBBVENIIC9hcGkvYnVncy86aWQgLSBVcGRhdGVzIGFuIGV4aXN0aW5nIGJ1Zy5cbiAgICogVXNlcnMgY2FuIGVkaXQgdGhlaXIgb3duIGJ1Z3MsIGFkbWlucyBhbmQgbWFuYWdlcnMgY2FuIGVkaXQgYW55IGJ1Zy5cbiAgICovXG4gIGFwcC5wYXRjaCgnL2FwaS9idWdzLzppZCcsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWcgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHJlcXVlc3QgYm9keVxuICAgICAgY29uc3QgdXBkYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgICB0aXRsZTogelxuICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgIC5taW4oMSwgJ1RpdGxlIGlzIHJlcXVpcmVkJylcbiAgICAgICAgICAubWF4KDIwMCwgJ1RpdGxlIG11c3Qgbm90IGV4Y2VlZCAyMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiB6XG4gICAgICAgICAgLnN0cmluZygpXG4gICAgICAgICAgLm1pbigxMCwgJ0Rlc2NyaXB0aW9uIG11c3QgYmUgYXQgbGVhc3QgMTAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm1heCgyMDAwLCAnRGVzY3JpcHRpb24gbXVzdCBub3QgZXhjZWVkIDIwMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIGNhdGVnb3J5OiB6XG4gICAgICAgICAgLmVudW0oW1xuICAgICAgICAgICAgJ3VpX3V4JyxcbiAgICAgICAgICAgICdmdW5jdGlvbmFsaXR5JyxcbiAgICAgICAgICAgICdwZXJmb3JtYW5jZScsXG4gICAgICAgICAgICAnZGF0YScsXG4gICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgJ2ludGVncmF0aW9uJyxcbiAgICAgICAgICAgICdvdGhlcicsXG4gICAgICAgICAgXSlcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgcGFnZTogei5zdHJpbmcoKS5taW4oMSwgJ1BhZ2UgaXMgcmVxdWlyZWQnKS5vcHRpb25hbCgpLFxuICAgICAgICBwcmlvcml0eTogei5lbnVtKFsnbG93JywgJ21lZGl1bScsICdoaWdoJywgJ2NyaXRpY2FsJ10pLm9wdGlvbmFsKCksXG4gICAgICAgIHJlcHJvZHVjdGlvblN0ZXBzOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICAgIGVudmlyb25tZW50OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICAgIHN0YXR1czogei5lbnVtKFsnbmV3JywgJ2Fja25vd2xlZGdlZCcsICdpbl9wcm9ncmVzcycsICdyZXNvbHZlZCcsICdjbG9zZWQnXSkub3B0aW9uYWwoKSxcbiAgICAgICAgYXNzaWduZWRUbzogei5zdHJpbmcoKS51dWlkKCkubnVsbGFibGUoKS5vcHRpb25hbCgpLFxuICAgICAgICBub3Rlczogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgICAgICByZXNvbHZlZEJ5OiB6LnN0cmluZygpLnV1aWQoKS5udWxsYWJsZSgpLm9wdGlvbmFsKCksXG4gICAgICAgIHJlc29sdmVkQXQ6IHouZGF0ZSgpLm51bGxhYmxlKCkub3B0aW9uYWwoKSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdXBkYXRlU2NoZW1hLnNhZmVQYXJzZShyZXEuYm9keSk7XG4gICAgICBpZiAoIXZhbGlkYXRpb24uc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIHVwZGF0ZSBkYXRhJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVwZGF0ZXMgPSB2YWxpZGF0aW9uLmRhdGE7XG4gICAgICBjb25zdCBidWcgPSBhd2FpdCBzdG9yYWdlLnVwZGF0ZUJ1ZyhpZCwgdXBkYXRlcywgY3VycmVudFVzZXIuaWQsIGN1cnJlbnRVc2VyLnJvbGUpO1xuXG4gICAgICBpZiAoIWJ1Zykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQnVnIG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5OdIFVwZGF0ZWQgYnVnICR7aWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5qc29uKGJ1Zyk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHVwZGF0aW5nIGJ1ZzonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgYnVnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEdFVCAvYXBpL2J1Z3MvOmlkL2ZpbGUgLSBTZXJ2ZXMgdGhlIGZpbGUgYXR0YWNobWVudCBmb3IgYSBidWcuXG4gICAqL1xuICBhcHAuZ2V0KCcvYXBpL2J1Z3MvOmlkL2ZpbGUnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHsgZG93bmxvYWQgfSA9IHJlcS5xdWVyeTtcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCB0aGUgYnVnIHdpdGggZmlsZSBpbmZvXG4gICAgICBjb25zdCBidWcgPSBhd2FpdCBzdG9yYWdlLmdldEJ1ZyhcbiAgICAgICAgaWQsXG4gICAgICAgIGN1cnJlbnRVc2VyLmlkLFxuICAgICAgICBjdXJyZW50VXNlci5yb2xlLFxuICAgICAgICBjdXJyZW50VXNlci5vcmdhbml6YXRpb25JZFxuICAgICAgKTtcblxuICAgICAgY29uc29sZS5sb2coJ/CfkJsgZ2V0QnVnIHJlc3VsdDonLCBidWcgPyB7IGlkOiBidWcuaWQsIGZpbGVQYXRoOiBidWcuZmlsZVBhdGgsIGZpbGVOYW1lOiBidWcuZmlsZU5hbWUgfSA6ICd1bmRlZmluZWQnKTtcblxuICAgICAgaWYgKCFidWcpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0J1ZyBub3QgZm91bmQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgYm90aCBjYW1lbENhc2UgYW5kIHNuYWtlX2Nhc2UgZmllbGQgbmFtZXMgZm9yIGNvbXBhdGliaWxpdHlcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gYnVnLmZpbGVQYXRoIHx8IChidWcgYXMgYW55KS5maWxlX3BhdGg7XG4gICAgICBjb25zdCBmaWxlTmFtZSA9IGJ1Zy5maWxlTmFtZSB8fCAoYnVnIGFzIGFueSkuZmlsZV9uYW1lO1xuICAgICAgXG4gICAgICBpZiAoIWZpbGVQYXRoKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdObyBmaWxlIGF0dGFjaGVkIHRvIHRoaXMgYnVnJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEhhbmRsZSBkaWZmZXJlbnQgcGF0aCBmb3JtYXRzIChhYnNvbHV0ZSB2cyByZWxhdGl2ZSlcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5pc0Fic29sdXRlKGZpbGVQYXRoKSBcbiAgICAgICAgPyBmaWxlUGF0aCBcbiAgICAgICAgOiBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3VwbG9hZHMnLCBmaWxlUGF0aCk7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIGZpbGUgZXhpc3RzXG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZnVsbFBhdGgpKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGaWxlIG5vdCBmb3VuZCBvbiBzZXJ2ZXInLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gRGV0ZWN0IE1JTUUgdHlwZSBiYXNlZCBvbiBmaWxlIGV4dGVuc2lvblxuICAgICAgY29uc3QgZ2V0Q29udGVudFR5cGUgPSAoZmlsZW5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBleHQgPSBmaWxlbmFtZS50b0xvd2VyQ2FzZSgpLnNwbGl0KCcuJykucG9wKCk7XG4gICAgICAgIHN3aXRjaCAoZXh0KSB7XG4gICAgICAgICAgY2FzZSAncGRmJzogcmV0dXJuICdhcHBsaWNhdGlvbi9wZGYnO1xuICAgICAgICAgIGNhc2UgJ2pwZyc6IGNhc2UgJ2pwZWcnOiByZXR1cm4gJ2ltYWdlL2pwZWcnO1xuICAgICAgICAgIGNhc2UgJ3BuZyc6IHJldHVybiAnaW1hZ2UvcG5nJztcbiAgICAgICAgICBjYXNlICdnaWYnOiByZXR1cm4gJ2ltYWdlL2dpZic7XG4gICAgICAgICAgY2FzZSAnZG9jJzogcmV0dXJuICdhcHBsaWNhdGlvbi9tc3dvcmQnO1xuICAgICAgICAgIGNhc2UgJ2RvY3gnOiByZXR1cm4gJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50JztcbiAgICAgICAgICBjYXNlICd0eHQnOiByZXR1cm4gJ3RleHQvcGxhaW4nO1xuICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJztcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgLy8gU2V0IHByb3BlciBjb250ZW50IHR5cGUgZm9yIHZpZXdpbmdcbiAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZ2V0Q29udGVudFR5cGUoZmlsZU5hbWUgfHwgJ2F0dGFjaG1lbnQnKTtcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGNvbnRlbnRUeXBlKTtcbiAgICAgIFxuICAgICAgLy8gUHJvcGVybHkgZW5jb2RlIGZpbGVuYW1lIGZvciBGcmVuY2ggY2hhcmFjdGVycyBhbmQgb3RoZXIgc3BlY2lhbCBjaGFyYWN0ZXJzXG4gICAgICBjb25zdCBlbmNvZGVkRmlsZW5hbWUgPSBCdWZmZXIuZnJvbShmaWxlTmFtZSB8fCAnYXR0YWNobWVudCcsICd1dGY4JykudG9TdHJpbmcoJ2JpbmFyeScpO1xuXG4gICAgICAvLyBTZXQgYXBwcm9wcmlhdGUgaGVhZGVyc1xuICAgICAgaWYgKGRvd25sb2FkID09PSAndHJ1ZScpIHtcbiAgICAgICAgcmVzLnNldEhlYWRlcignQ29udGVudC1EaXNwb3NpdGlvbicsIGBhdHRhY2htZW50OyBmaWxlbmFtZT1cIiR7ZW5jb2RlZEZpbGVuYW1lfVwiOyBmaWxlbmFtZSo9VVRGLTgnJyR7ZW5jb2RlVVJJQ29tcG9uZW50KGZpbGVOYW1lIHx8ICdhdHRhY2htZW50Jyl9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgYGlubGluZTsgZmlsZW5hbWU9XCIke2VuY29kZWRGaWxlbmFtZX1cIjsgZmlsZW5hbWUqPVVURi04Jycke2VuY29kZVVSSUNvbXBvbmVudChmaWxlTmFtZSB8fCAnYXR0YWNobWVudCcpfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBTdHJlYW0gdGhlIGZpbGVcbiAgICAgIGNvbnN0IGZpbGVTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGZ1bGxQYXRoKTtcbiAgICAgIGZpbGVTdHJlYW0ucGlwZShyZXMpO1xuICAgICAgXG4gICAgICBmaWxlU3RyZWFtLm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJyb3Igc3RyZWFtaW5nIGZpbGUgZm9yIGJ1ZyAke2lkfTpgLCBlcnJvcik7XG4gICAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ZhaWxlZCB0byBzdHJlYW0gZmlsZScgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBzZXJ2aW5nIGJ1ZyBmaWxlOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHNlcnZlIGZpbGUnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogREVMRVRFIC9hcGkvYnVncy86aWQgLSBEZWxldGVzIGEgYnVnLlxuICAgKiBPbmx5IGFkbWlucyBjYW4gZGVsZXRlIGJ1Z3MuXG4gICAqL1xuICBhcHAuZGVsZXRlKCcvYXBpL2J1Z3MvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuXG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdCYWQgcmVxdWVzdCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0J1ZyBJRCBpcyByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgc3RvcmFnZS5kZWxldGVCdWcoaWQsIGN1cnJlbnRVc2VyLmlkLCBjdXJyZW50VXNlci5yb2xlKTtcblxuICAgICAgaWYgKCFkZWxldGVkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdCdWcgbm90IGZvdW5kIG9yIGFjY2VzcyBkZW5pZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfl5HvuI8gRGVsZXRlZCBidWcgJHtpZH0gYnkgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZGVsZXRpbmcgYnVnOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGRlbGV0ZSBidWcnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==