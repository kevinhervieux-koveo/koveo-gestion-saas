80530c682e661ac09a0fd7e0c24e4a89
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.geminiBillAnalyzer = exports.GeminiBillAnalyzer = void 0;
const fs = __importStar(require("fs"));
const genai_1 = require("@google/genai");
// DON'T DELETE THIS COMMENT
// Follow these instructions when using this blueprint:
// - Note that the newest Gemini model series is "gemini-2.5-flash" or gemini-2.5-pro"
//   - do not change this unless explicitly requested by the user
// This API key is from Gemini Developer API Key, not vertex AI API Key
const ai = new genai_1.GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || '' });
/**
 *
 */
class GeminiBillAnalyzer {
    /**
     * Analyze a bill document using Gemini 2.5 Pro.
     * @param imagePath
     */
    async analyzeBillDocument(imagePath) {
        try {
            const imageBytes = fs.readFileSync(imagePath);
            const systemPrompt = `You are an expert bill analysis AI. Analyze this bill/invoice document and extract key information.
      
      Extract the following information and respond with JSON in this exact format:
      {
        "title": "Brief descriptive title for this bill",
        "vendor": "Company or service provider name",
        "totalAmount": "Total amount as decimal string (e.g., '1234.56')",
        "category": "One of: insurance, maintenance, salary, utilities, cleaning, security, landscaping, professional_services, administration, repairs, supplies, taxes, technology, reserves, other",
        "description": "Brief description of services/products",
        "dueDate": "Due date in YYYY-MM-DD format if found",
        "issueDate": "Issue date in YYYY-MM-DD format if found", 
        "billNumber": "Bill/invoice number if found",
        "confidence": 0.85
      }
      
      Guidelines:
      - Use clear, concise titles (e.g., "Hydro-Québec Electricity Bill", "Property Insurance Premium")
      - Map categories intelligently (electricity = utilities, legal fees = professional_services, etc.)
      - Extract exact amounts without currency symbols
      - Confidence should reflect how clear the document is (0.0-1.0)
      - If information is unclear, use best guess but lower confidence
      `;
            const contents = [
                {
                    inlineData: {
                        _data: imageBytes.toString('base64'),
                        mimeType: 'image/jpeg',
                    },
                },
                `Analyze this bill/invoice document and extract the key information as specified.`,
            ];
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-pro',
                config: {
                    systemInstruction: systemPrompt,
                    responseMimeType: 'application/json',
                    responseSchema: {
                        type: 'object',
                        properties: {
                            title: { type: 'string' },
                            vendor: { type: 'string' },
                            totalAmount: { type: 'string' },
                            category: {
                                type: 'string',
                                enum: [
                                    'insurance',
                                    'maintenance',
                                    'salary',
                                    'utilities',
                                    'cleaning',
                                    'security',
                                    'landscaping',
                                    'professional_services',
                                    'administration',
                                    'repairs',
                                    'supplies',
                                    'taxes',
                                    'technology',
                                    'reserves',
                                    'other',
                                ],
                            },
                            description: { type: 'string' },
                            dueDate: { type: 'string' },
                            issueDate: { type: 'string' },
                            billNumber: { type: 'string' },
                            confidence: { type: 'number' },
                        },
                        required: ['title', 'vendor', 'totalAmount', 'category', 'confidence'],
                    },
                },
                contents: contents,
            });
            const rawJson = response.text;
            if (rawJson) {
                const analysis = JSON.parse(rawJson);
                // Validate and sanitize the results
                analysis.confidence = Math.max(0, Math.min(1, analysis.confidence));
                analysis.totalAmount = this.sanitizeAmount(analysis.totalAmount);
                return analysis;
            }
            else {
                throw new Error('Empty response from Gemini');
            }
        }
        catch (error) {
            console.error('❌ Error analyzing bill document:', error);
            throw new Error(`Failed to analyze bill document: ${error}`);
        }
    }
    /**
     * Sanitize and validate amount string.
     * @param amount
     */
    sanitizeAmount(amount) {
        // Remove currency symbols and spaces
        const cleaned = amount.replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        if (isNaN(parsed)) {
            return '0.00';
        }
        return parsed.toFixed(2);
    }
    /**
     * Get suggested payment schedule based on bill type and amount.
     * @param category
     * @param amount
     */
    async suggestPaymentSchedule(category, amount) {
        try {
            const prompt = `Based on this bill category "${category}" and amount $${amount}, suggest the most appropriate payment schedule.
      
      Common patterns:
      - Utilities: Usually monthly recurring
      - Insurance: Usually yearly recurring  
      - Maintenance: Usually unique payments
      - Professional services: Usually unique payments
      - Supplies: Usually unique payments
      - Taxes: Usually yearly recurring
      
      Respond with JSON:
      {
        "paymentType": "unique" or "recurrent",
        "schedulePayment": "monthly", "quarterly", or "yearly" (only if recurrent),
        "reasoning": "Brief explanation of the recommendation"
      }`;
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                config: {
                    responseMimeType: 'application/json',
                    responseSchema: {
                        type: 'object',
                        properties: {
                            paymentType: { type: 'string', enum: ['unique', 'recurrent'] },
                            schedulePayment: { type: 'string', enum: ['monthly', 'quarterly', 'yearly'] },
                            reasoning: { type: 'string' },
                        },
                        required: ['paymentType', 'reasoning'],
                    },
                },
                contents: prompt,
            });
            const result = JSON.parse(response.text || '{}');
            return result;
        }
        catch (error) {
            console.error('❌ Error suggesting payment schedule:', error);
            return {
                paymentType: 'unique',
                reasoning: 'Default to unique payment due to analysis error',
            };
        }
    }
}
exports.GeminiBillAnalyzer = GeminiBillAnalyzer;
exports.geminiBillAnalyzer = new GeminiBillAnalyzer();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvZ2VtaW5pLWJpbGwtYW5hbHl6ZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLHlDQUE0QztBQUU1Qyw0QkFBNEI7QUFDNUIsdURBQXVEO0FBQ3ZELHNGQUFzRjtBQUN0RixpRUFBaUU7QUFFakUsdUVBQXVFO0FBQ3ZFLE1BQU0sRUFBRSxHQUFHLElBQUksbUJBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBaUJ6RTs7R0FFRztBQUNILE1BQWEsa0JBQWtCO0lBQzdCOzs7T0FHRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxTQUFpQjtRQUN6QyxJQUFJLENBQUM7WUFDSCxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRTlDLE1BQU0sWUFBWSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0FxQnBCLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRztnQkFDZjtvQkFDRSxVQUFVLEVBQUU7d0JBQ1YsS0FBSyxFQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO3dCQUNwQyxRQUFRLEVBQUUsWUFBWTtxQkFDdkI7aUJBQ0Y7Z0JBQ0Qsa0ZBQWtGO2FBQ25GLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO2dCQUMvQyxLQUFLLEVBQUUsZ0JBQWdCO2dCQUN2QixNQUFNLEVBQUU7b0JBQ04saUJBQWlCLEVBQUUsWUFBWTtvQkFDL0IsZ0JBQWdCLEVBQUUsa0JBQWtCO29CQUNwQyxjQUFjLEVBQUU7d0JBQ2QsSUFBSSxFQUFFLFFBQVE7d0JBQ2QsVUFBVSxFQUFFOzRCQUNWLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7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Y0FBYyxFQUFFO3dCQUNkLElBQUksRUFBRSxRQUFRO3dCQUNkLFVBQVUsRUFBRTs0QkFDVixXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsRUFBRTs0QkFDOUQsZUFBZSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxFQUFFOzRCQUM3RSxTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO3lCQUM5Qjt3QkFDRCxRQUFRLEVBQUUsQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDO3FCQUN2QztpQkFDRjtnQkFDRCxRQUFRLEVBQUUsTUFBTTthQUNqQixDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUM7WUFDakQsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxPQUFPO2dCQUNMLFdBQVcsRUFBRSxRQUFRO2dCQUNyQixTQUFTLEVBQUUsaURBQWlEO2FBQzdELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBbExELGdEQWtMQztBQUVZLFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL3NlcnZpY2VzL2dlbWluaS1iaWxsLWFuYWx5emVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEdvb2dsZUdlbkFJIH0gZnJvbSAnQGdvb2dsZS9nZW5haSc7XG5cbi8vIERPTidUIERFTEVURSBUSElTIENPTU1FTlRcbi8vIEZvbGxvdyB0aGVzZSBpbnN0cnVjdGlvbnMgd2hlbiB1c2luZyB0aGlzIGJsdWVwcmludDpcbi8vIC0gTm90ZSB0aGF0IHRoZSBuZXdlc3QgR2VtaW5pIG1vZGVsIHNlcmllcyBpcyBcImdlbWluaS0yLjUtZmxhc2hcIiBvciBnZW1pbmktMi41LXByb1wiXG4vLyAgIC0gZG8gbm90IGNoYW5nZSB0aGlzIHVubGVzcyBleHBsaWNpdGx5IHJlcXVlc3RlZCBieSB0aGUgdXNlclxuXG4vLyBUaGlzIEFQSSBrZXkgaXMgZnJvbSBHZW1pbmkgRGV2ZWxvcGVyIEFQSSBLZXksIG5vdCB2ZXJ0ZXggQUkgQVBJIEtleVxuY29uc3QgYWkgPSBuZXcgR29vZ2xlR2VuQUkoeyBhcGlLZXk6IHByb2Nlc3MuZW52LkdFTUlOSV9BUElfS0VZIHx8ICcnIH0pO1xuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmlsbEFuYWx5c2lzUmVzdWx0IHtcbiAgdGl0bGU6IHN0cmluZztcbiAgdmVuZG9yOiBzdHJpbmc7XG4gIHRvdGFsQW1vdW50OiBzdHJpbmc7XG4gIGNhdGVnb3J5OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBkdWVEYXRlPzogc3RyaW5nO1xuICBpc3N1ZURhdGU/OiBzdHJpbmc7XG4gIGJpbGxOdW1iZXI/OiBzdHJpbmc7XG4gIGNvbmZpZGVuY2U6IG51bWJlcjtcbn1cblxuLyoqXG4gKlxuICovXG5leHBvcnQgY2xhc3MgR2VtaW5pQmlsbEFuYWx5emVyIHtcbiAgLyoqXG4gICAqIEFuYWx5emUgYSBiaWxsIGRvY3VtZW50IHVzaW5nIEdlbWluaSAyLjUgUHJvLlxuICAgKiBAcGFyYW0gaW1hZ2VQYXRoXG4gICAqL1xuICBhc3luYyBhbmFseXplQmlsbERvY3VtZW50KGltYWdlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxCaWxsQW5hbHlzaXNSZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaW1hZ2VCeXRlcyA9IGZzLnJlYWRGaWxlU3luYyhpbWFnZVBhdGgpO1xuXG4gICAgICBjb25zdCBzeXN0ZW1Qcm9tcHQgPSBgWW91IGFyZSBhbiBleHBlcnQgYmlsbCBhbmFseXNpcyBBSS4gQW5hbHl6ZSB0aGlzIGJpbGwvaW52b2ljZSBkb2N1bWVudCBhbmQgZXh0cmFjdCBrZXkgaW5mb3JtYXRpb24uXG4gICAgICBcbiAgICAgIEV4dHJhY3QgdGhlIGZvbGxvd2luZyBpbmZvcm1hdGlvbiBhbmQgcmVzcG9uZCB3aXRoIEpTT04gaW4gdGhpcyBleGFjdCBmb3JtYXQ6XG4gICAgICB7XG4gICAgICAgIFwidGl0bGVcIjogXCJCcmllZiBkZXNjcmlwdGl2ZSB0aXRsZSBmb3IgdGhpcyBiaWxsXCIsXG4gICAgICAgIFwidmVuZG9yXCI6IFwiQ29tcGFueSBvciBzZXJ2aWNlIHByb3ZpZGVyIG5hbWVcIixcbiAgICAgICAgXCJ0b3RhbEFtb3VudFwiOiBcIlRvdGFsIGFtb3VudCBhcyBkZWNpbWFsIHN0cmluZyAoZS5nLiwgJzEyMzQuNTYnKVwiLFxuICAgICAgICBcImNhdGVnb3J5XCI6IFwiT25lIG9mOiBpbnN1cmFuY2UsIG1haW50ZW5hbmNlLCBzYWxhcnksIHV0aWxpdGllcywgY2xlYW5pbmcsIHNlY3VyaXR5LCBsYW5kc2NhcGluZywgcHJvZmVzc2lvbmFsX3NlcnZpY2VzLCBhZG1pbmlzdHJhdGlvbiwgcmVwYWlycywgc3VwcGxpZXMsIHRheGVzLCB0ZWNobm9sb2d5LCByZXNlcnZlcywgb3RoZXJcIixcbiAgICAgICAgXCJkZXNjcmlwdGlvblwiOiBcIkJyaWVmIGRlc2NyaXB0aW9uIG9mIHNlcnZpY2VzL3Byb2R1Y3RzXCIsXG4gICAgICAgIFwiZHVlRGF0ZVwiOiBcIkR1ZSBkYXRlIGluIFlZWVktTU0tREQgZm9ybWF0IGlmIGZvdW5kXCIsXG4gICAgICAgIFwiaXNzdWVEYXRlXCI6IFwiSXNzdWUgZGF0ZSBpbiBZWVlZLU1NLUREIGZvcm1hdCBpZiBmb3VuZFwiLCBcbiAgICAgICAgXCJiaWxsTnVtYmVyXCI6IFwiQmlsbC9pbnZvaWNlIG51bWJlciBpZiBmb3VuZFwiLFxuICAgICAgICBcImNvbmZpZGVuY2VcIjogMC44NVxuICAgICAgfVxuICAgICAgXG4gICAgICBHdWlkZWxpbmVzOlxuICAgICAgLSBVc2UgY2xlYXIsIGNvbmNpc2UgdGl0bGVzIChlLmcuLCBcIkh5ZHJvLVF1w6liZWMgRWxlY3RyaWNpdHkgQmlsbFwiLCBcIlByb3BlcnR5IEluc3VyYW5jZSBQcmVtaXVtXCIpXG4gICAgICAtIE1hcCBjYXRlZ29yaWVzIGludGVsbGlnZW50bHkgKGVsZWN0cmljaXR5ID0gdXRpbGl0aWVzLCBsZWdhbCBmZWVzID0gcHJvZmVzc2lvbmFsX3NlcnZpY2VzLCBldGMuKVxuICAgICAgLSBFeHRyYWN0IGV4YWN0IGFtb3VudHMgd2l0aG91dCBjdXJyZW5jeSBzeW1ib2xzXG4gICAgICAtIENvbmZpZGVuY2Ugc2hvdWxkIHJlZmxlY3QgaG93IGNsZWFyIHRoZSBkb2N1bWVudCBpcyAoMC4wLTEuMClcbiAgICAgIC0gSWYgaW5mb3JtYXRpb24gaXMgdW5jbGVhciwgdXNlIGJlc3QgZ3Vlc3MgYnV0IGxvd2VyIGNvbmZpZGVuY2VcbiAgICAgIGA7XG5cbiAgICAgIGNvbnN0IGNvbnRlbnRzID0gW1xuICAgICAgICB7XG4gICAgICAgICAgaW5saW5lRGF0YToge1xuICAgICAgICAgICAgX2RhdGE6IGltYWdlQnl0ZXMudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgICAgICAgbWltZVR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBgQW5hbHl6ZSB0aGlzIGJpbGwvaW52b2ljZSBkb2N1bWVudCBhbmQgZXh0cmFjdCB0aGUga2V5IGluZm9ybWF0aW9uIGFzIHNwZWNpZmllZC5gLFxuICAgICAgXTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhaS5tb2RlbHMuZ2VuZXJhdGVDb250ZW50KHtcbiAgICAgICAgbW9kZWw6ICdnZW1pbmktMi41LXBybycsXG4gICAgICAgIGNvbmZpZzoge1xuICAgICAgICAgIHN5c3RlbUluc3RydWN0aW9uOiBzeXN0ZW1Qcm9tcHQsXG4gICAgICAgICAgcmVzcG9uc2VNaW1lVHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIHJlc3BvbnNlU2NoZW1hOiB7XG4gICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgICAgdGl0bGU6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgICAgICAgICAgdmVuZG9yOiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgICAgICAgICAgIHRvdGFsQW1vdW50OiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgICAgICAgICAgIGNhdGVnb3J5OiB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgICAgICAgZW51bTogW1xuICAgICAgICAgICAgICAgICAgJ2luc3VyYW5jZScsXG4gICAgICAgICAgICAgICAgICAnbWFpbnRlbmFuY2UnLFxuICAgICAgICAgICAgICAgICAgJ3NhbGFyeScsXG4gICAgICAgICAgICAgICAgICAndXRpbGl0aWVzJyxcbiAgICAgICAgICAgICAgICAgICdjbGVhbmluZycsXG4gICAgICAgICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgICAgICAgJ2xhbmRzY2FwaW5nJyxcbiAgICAgICAgICAgICAgICAgICdwcm9mZXNzaW9uYWxfc2VydmljZXMnLFxuICAgICAgICAgICAgICAgICAgJ2FkbWluaXN0cmF0aW9uJyxcbiAgICAgICAgICAgICAgICAgICdyZXBhaXJzJyxcbiAgICAgICAgICAgICAgICAgICdzdXBwbGllcycsXG4gICAgICAgICAgICAgICAgICAndGF4ZXMnLFxuICAgICAgICAgICAgICAgICAgJ3RlY2hub2xvZ3knLFxuICAgICAgICAgICAgICAgICAgJ3Jlc2VydmVzJyxcbiAgICAgICAgICAgICAgICAgICdvdGhlcicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgICAgICAgICAgZHVlRGF0ZTogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgICAgICAgICBpc3N1ZURhdGU6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgICAgICAgICAgYmlsbE51bWJlcjogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgICAgICAgICBjb25maWRlbmNlOiB7IHR5cGU6ICdudW1iZXInIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVxdWlyZWQ6IFsndGl0bGUnLCAndmVuZG9yJywgJ3RvdGFsQW1vdW50JywgJ2NhdGVnb3J5JywgJ2NvbmZpZGVuY2UnXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjb250ZW50czogY29udGVudHMsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmF3SnNvbiA9IHJlc3BvbnNlLnRleHQ7XG5cbiAgICAgIGlmIChyYXdKc29uKSB7XG4gICAgICAgIGNvbnN0IGFuYWx5c2lzOiBCaWxsQW5hbHlzaXNSZXN1bHQgPSBKU09OLnBhcnNlKHJhd0pzb24pO1xuXG4gICAgICAgIC8vIFZhbGlkYXRlIGFuZCBzYW5pdGl6ZSB0aGUgcmVzdWx0c1xuICAgICAgICBhbmFseXNpcy5jb25maWRlbmNlID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgYW5hbHlzaXMuY29uZmlkZW5jZSkpO1xuICAgICAgICBhbmFseXNpcy50b3RhbEFtb3VudCA9IHRoaXMuc2FuaXRpemVBbW91bnQoYW5hbHlzaXMudG90YWxBbW91bnQpO1xuXG4gICAgICAgIHJldHVybiBhbmFseXNpcztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgcmVzcG9uc2UgZnJvbSBHZW1pbmknKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgYW5hbHl6aW5nIGJpbGwgZG9jdW1lbnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gYW5hbHl6ZSBiaWxsIGRvY3VtZW50OiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTYW5pdGl6ZSBhbmQgdmFsaWRhdGUgYW1vdW50IHN0cmluZy5cbiAgICogQHBhcmFtIGFtb3VudFxuICAgKi9cbiAgcHJpdmF0ZSBzYW5pdGl6ZUFtb3VudChhbW91bnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gUmVtb3ZlIGN1cnJlbmN5IHN5bWJvbHMgYW5kIHNwYWNlc1xuICAgIGNvbnN0IGNsZWFuZWQgPSBhbW91bnQucmVwbGFjZSgvW14wLTkuLV0vZywgJycpO1xuICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlRmxvYXQoY2xlYW5lZCk7XG5cbiAgICBpZiAoaXNOYU4ocGFyc2VkKSkge1xuICAgICAgcmV0dXJuICcwLjAwJztcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyc2VkLnRvRml4ZWQoMik7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN1Z2dlc3RlZCBwYXltZW50IHNjaGVkdWxlIGJhc2VkIG9uIGJpbGwgdHlwZSBhbmQgYW1vdW50LlxuICAgKiBAcGFyYW0gY2F0ZWdvcnlcbiAgICogQHBhcmFtIGFtb3VudFxuICAgKi9cbiAgYXN5bmMgc3VnZ2VzdFBheW1lbnRTY2hlZHVsZShcbiAgICBjYXRlZ29yeTogc3RyaW5nLFxuICAgIGFtb3VudDogbnVtYmVyXG4gICk6IFByb21pc2U8e1xuICAgIHBheW1lbnRUeXBlOiAndW5pcXVlJyB8ICdyZWN1cnJlbnQnO1xuICAgIHNjaGVkdWxlUGF5bWVudD86ICdtb250aGx5JyB8ICdxdWFydGVybHknIHwgJ3llYXJseSc7XG4gICAgcmVhc29uaW5nOiBzdHJpbmc7XG4gIH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJvbXB0ID0gYEJhc2VkIG9uIHRoaXMgYmlsbCBjYXRlZ29yeSBcIiR7Y2F0ZWdvcnl9XCIgYW5kIGFtb3VudCAkJHthbW91bnR9LCBzdWdnZXN0IHRoZSBtb3N0IGFwcHJvcHJpYXRlIHBheW1lbnQgc2NoZWR1bGUuXG4gICAgICBcbiAgICAgIENvbW1vbiBwYXR0ZXJuczpcbiAgICAgIC0gVXRpbGl0aWVzOiBVc3VhbGx5IG1vbnRobHkgcmVjdXJyaW5nXG4gICAgICAtIEluc3VyYW5jZTogVXN1YWxseSB5ZWFybHkgcmVjdXJyaW5nICBcbiAgICAgIC0gTWFpbnRlbmFuY2U6IFVzdWFsbHkgdW5pcXVlIHBheW1lbnRzXG4gICAgICAtIFByb2Zlc3Npb25hbCBzZXJ2aWNlczogVXN1YWxseSB1bmlxdWUgcGF5bWVudHNcbiAgICAgIC0gU3VwcGxpZXM6IFVzdWFsbHkgdW5pcXVlIHBheW1lbnRzXG4gICAgICAtIFRheGVzOiBVc3VhbGx5IHllYXJseSByZWN1cnJpbmdcbiAgICAgIFxuICAgICAgUmVzcG9uZCB3aXRoIEpTT046XG4gICAgICB7XG4gICAgICAgIFwicGF5bWVudFR5cGVcIjogXCJ1bmlxdWVcIiBvciBcInJlY3VycmVudFwiLFxuICAgICAgICBcInNjaGVkdWxlUGF5bWVudFwiOiBcIm1vbnRobHlcIiwgXCJxdWFydGVybHlcIiwgb3IgXCJ5ZWFybHlcIiAob25seSBpZiByZWN1cnJlbnQpLFxuICAgICAgICBcInJlYXNvbmluZ1wiOiBcIkJyaWVmIGV4cGxhbmF0aW9uIG9mIHRoZSByZWNvbW1lbmRhdGlvblwiXG4gICAgICB9YDtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhaS5tb2RlbHMuZ2VuZXJhdGVDb250ZW50KHtcbiAgICAgICAgbW9kZWw6ICdnZW1pbmktMi41LWZsYXNoJyxcbiAgICAgICAgY29uZmlnOiB7XG4gICAgICAgICAgcmVzcG9uc2VNaW1lVHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIHJlc3BvbnNlU2NoZW1hOiB7XG4gICAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgICAgcGF5bWVudFR5cGU6IHsgdHlwZTogJ3N0cmluZycsIGVudW06IFsndW5pcXVlJywgJ3JlY3VycmVudCddIH0sXG4gICAgICAgICAgICAgIHNjaGVkdWxlUGF5bWVudDogeyB0eXBlOiAnc3RyaW5nJywgZW51bTogWydtb250aGx5JywgJ3F1YXJ0ZXJseScsICd5ZWFybHknXSB9LFxuICAgICAgICAgICAgICByZWFzb25pbmc6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZXF1aXJlZDogWydwYXltZW50VHlwZScsICdyZWFzb25pbmcnXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjb250ZW50czogcHJvbXB0LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UocmVzcG9uc2UudGV4dCB8fCAne30nKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHN1Z2dlc3RpbmcgcGF5bWVudCBzY2hlZHVsZTonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXltZW50VHlwZTogJ3VuaXF1ZScsXG4gICAgICAgIHJlYXNvbmluZzogJ0RlZmF1bHQgdG8gdW5pcXVlIHBheW1lbnQgZHVlIHRvIGFuYWx5c2lzIGVycm9yJyxcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBnZW1pbmlCaWxsQW5hbHl6ZXIgPSBuZXcgR2VtaW5pQmlsbEFuYWx5emVyKCk7XG4iXSwidmVyc2lvbiI6M30=