295af696efc328772b16465dce68e08a
'use strict';
var UI = require('../document/UI.js');
var isElementType = require('../utils/misc/isElementType.js');
require('../utils/dataTransfer/Clipboard.js');
var timeValue = require('../utils/edit/timeValue.js');
var maxLength = require('../utils/edit/maxLength.js');
var cursor = require('../utils/focus/cursor.js');
var trackValue = require('../document/trackValue.js');
var getInputRange = require('./selection/getInputRange.js');
var setSelection = require('./selection/setSelection.js');
function isDateOrTime(element) {
    return isElementType.isElementType(element, 'input') && [
        'date',
        'time'
    ].includes(element.type);
}
function input(instance, element, data, inputType = 'insertText') {
    const inputRange = getInputRange.getInputRange(element);
    /* istanbul ignore if */ if (!inputRange) {
        return;
    }
    // There is no `beforeinput` event on `date` and `time` input
    if (!isDateOrTime(element)) {
        const unprevented = instance.dispatchUIEvent(element, 'beforeinput', {
            inputType,
            data
        });
        if (!unprevented) {
            return;
        }
    }
    if ('startContainer' in inputRange) {
        editContenteditable(instance, element, inputRange, data, inputType);
    }
    else {
        editInputElement(instance, element, inputRange, data, inputType);
    }
}
function editContenteditable(instance, element, inputRange, data, inputType) {
    let del = false;
    if (!inputRange.collapsed) {
        del = true;
        inputRange.deleteContents();
    }
    else if ([
        'deleteContentBackward',
        'deleteContentForward'
    ].includes(inputType)) {
        const nextPosition = cursor.getNextCursorPosition(inputRange.startContainer, inputRange.startOffset, inputType === 'deleteContentBackward' ? -1 : 1, inputType);
        if (nextPosition) {
            del = true;
            const delRange = inputRange.cloneRange();
            if (delRange.comparePoint(nextPosition.node, nextPosition.offset) < 0) {
                delRange.setStart(nextPosition.node, nextPosition.offset);
            }
            else {
                delRange.setEnd(nextPosition.node, nextPosition.offset);
            }
            delRange.deleteContents();
        }
    }
    if (data) {
        if (inputRange.endContainer.nodeType === 3) {
            const offset = inputRange.endOffset;
            inputRange.endContainer.insertData(offset, data);
            inputRange.setStart(inputRange.endContainer, offset + data.length);
            inputRange.setEnd(inputRange.endContainer, offset + data.length);
        }
        else {
            const text = element.ownerDocument.createTextNode(data);
            inputRange.insertNode(text);
            inputRange.setStart(text, data.length);
            inputRange.setEnd(text, data.length);
        }
    }
    if (del || data) {
        instance.dispatchUIEvent(element, 'input', {
            inputType
        });
    }
}
function editInputElement(instance, element, inputRange, data, inputType) {
    let dataToInsert = data;
    if (maxLength.supportsMaxLength(element)) {
        const maxLength$1 = maxLength.getMaxLength(element);
        if (maxLength$1 !== undefined && data.length > 0) {
            const spaceUntilMaxLength = maxLength$1 - element.value.length;
            if (spaceUntilMaxLength > 0) {
                dataToInsert = data.substring(0, spaceUntilMaxLength);
            }
            else {
                return;
            }
        }
    }
    const { newValue, newOffset, oldValue } = calculateNewValue(dataToInsert, element, inputRange, inputType);
    if (newValue === oldValue && newOffset === inputRange.startOffset && newOffset === inputRange.endOffset) {
        return;
    }
    if (isElementType.isElementType(element, 'input', {
        type: 'number'
    }) && !isValidNumberInput(newValue)) {
        return;
    }
    UI.setUIValue(element, newValue);
    setSelection.setSelection({
        focusNode: element,
        anchorOffset: newOffset,
        focusOffset: newOffset
    });
    if (isDateOrTime(element)) {
        if (timeValue.isValidDateOrTimeValue(element, newValue)) {
            commitInput(instance, element, newOffset, {});
            instance.dispatchUIEvent(element, 'change');
            UI.clearInitialValue(element);
        }
    }
    else {
        commitInput(instance, element, newOffset, {
            data,
            inputType
        });
    }
}
function calculateNewValue(inputData, node, { startOffset, endOffset }, inputType) {
    const value = UI.getUIValue(node);
    const prologEnd = Math.max(0, startOffset === endOffset && inputType === 'deleteContentBackward' ? startOffset - 1 : startOffset);
    const prolog = value.substring(0, prologEnd);
    const epilogStart = Math.min(value.length, startOffset === endOffset && inputType === 'deleteContentForward' ? startOffset + 1 : endOffset);
    const epilog = value.substring(epilogStart, value.length);
    let newValue = `${prolog}${inputData}${epilog}`;
    let newOffset = prologEnd + inputData.length;
    if (isElementType.isElementType(node, 'input', {
        type: 'time'
    })) {
        const builtValue = timeValue.buildTimeValue(newValue);
        if (builtValue !== '' && timeValue.isValidDateOrTimeValue(node, builtValue)) {
            newValue = builtValue;
            newOffset = builtValue.length;
        }
    }
    return {
        oldValue: value,
        newValue,
        newOffset
    };
}
function commitInput(instance, element, newOffset, inputInit) {
    instance.dispatchUIEvent(element, 'input', inputInit);
    trackValue.commitValueAfterInput(element, newOffset);
}
function isValidNumberInput(value) {
    var _value_match, _value_match1;
    // the browser allows some invalid input but not others
    // it allows up to two '-' at any place before any 'e' or one directly following 'e'
    // it allows one '.' at any place before e
    const valueParts = value.split('e', 2);
    return !(/[^\d.\-e]/.test(value) || Number((_value_match = value.match(/-/g)) === null || _value_match === undefined ? undefined : _value_match.length) > 2 || Number((_value_match1 = value.match(/\./g)) === null || _value_match1 === undefined ? undefined : _value_match1.length) > 1 || valueParts[1] && !/^-?\d*$/.test(valueParts[1]));
}
exports.input = input;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL2V2ZW50L2lucHV0LmpzIiwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ3RDLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQzlELE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQzlDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RELElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ2pELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3RELElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQzVELElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBRTFELFNBQVMsWUFBWSxDQUFDLE9BQU87SUFDekIsT0FBTyxhQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSTtRQUNwRCxNQUFNO1FBQ04sTUFBTTtLQUNULENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBQ0QsU0FBUyxLQUFLLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxHQUFHLFlBQVk7SUFDNUQsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN4RCx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdkMsT0FBTztJQUNYLENBQUM7SUFDRCw2REFBNkQ7SUFD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ZXIvd29ya3NwYWNlL25vZGVfbW9kdWxlcy9AdGVzdGluZy1saWJyYXJ5L3VzZXItZXZlbnQvZGlzdC9janMvZXZlbnQvaW5wdXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgVUkgPSByZXF1aXJlKCcuLi9kb2N1bWVudC9VSS5qcycpO1xudmFyIGlzRWxlbWVudFR5cGUgPSByZXF1aXJlKCcuLi91dGlscy9taXNjL2lzRWxlbWVudFR5cGUuanMnKTtcbnJlcXVpcmUoJy4uL3V0aWxzL2RhdGFUcmFuc2Zlci9DbGlwYm9hcmQuanMnKTtcbnZhciB0aW1lVmFsdWUgPSByZXF1aXJlKCcuLi91dGlscy9lZGl0L3RpbWVWYWx1ZS5qcycpO1xudmFyIG1heExlbmd0aCA9IHJlcXVpcmUoJy4uL3V0aWxzL2VkaXQvbWF4TGVuZ3RoLmpzJyk7XG52YXIgY3Vyc29yID0gcmVxdWlyZSgnLi4vdXRpbHMvZm9jdXMvY3Vyc29yLmpzJyk7XG52YXIgdHJhY2tWYWx1ZSA9IHJlcXVpcmUoJy4uL2RvY3VtZW50L3RyYWNrVmFsdWUuanMnKTtcbnZhciBnZXRJbnB1dFJhbmdlID0gcmVxdWlyZSgnLi9zZWxlY3Rpb24vZ2V0SW5wdXRSYW5nZS5qcycpO1xudmFyIHNldFNlbGVjdGlvbiA9IHJlcXVpcmUoJy4vc2VsZWN0aW9uL3NldFNlbGVjdGlvbi5qcycpO1xuXG5mdW5jdGlvbiBpc0RhdGVPclRpbWUoZWxlbWVudCkge1xuICAgIHJldHVybiBpc0VsZW1lbnRUeXBlLmlzRWxlbWVudFR5cGUoZWxlbWVudCwgJ2lucHV0JykgJiYgW1xuICAgICAgICAnZGF0ZScsXG4gICAgICAgICd0aW1lJ1xuICAgIF0uaW5jbHVkZXMoZWxlbWVudC50eXBlKTtcbn1cbmZ1bmN0aW9uIGlucHV0KGluc3RhbmNlLCBlbGVtZW50LCBkYXRhLCBpbnB1dFR5cGUgPSAnaW5zZXJ0VGV4dCcpIHtcbiAgICBjb25zdCBpbnB1dFJhbmdlID0gZ2V0SW5wdXRSYW5nZS5nZXRJbnB1dFJhbmdlKGVsZW1lbnQpO1xuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLyBpZiAoIWlucHV0UmFuZ2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBUaGVyZSBpcyBubyBgYmVmb3JlaW5wdXRgIGV2ZW50IG9uIGBkYXRlYCBhbmQgYHRpbWVgIGlucHV0XG4gICAgaWYgKCFpc0RhdGVPclRpbWUoZWxlbWVudCkpIHtcbiAgICAgICAgY29uc3QgdW5wcmV2ZW50ZWQgPSBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQoZWxlbWVudCwgJ2JlZm9yZWlucHV0Jywge1xuICAgICAgICAgICAgaW5wdXRUeXBlLFxuICAgICAgICAgICAgZGF0YVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCF1bnByZXZlbnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICgnc3RhcnRDb250YWluZXInIGluIGlucHV0UmFuZ2UpIHtcbiAgICAgICAgZWRpdENvbnRlbnRlZGl0YWJsZShpbnN0YW5jZSwgZWxlbWVudCwgaW5wdXRSYW5nZSwgZGF0YSwgaW5wdXRUeXBlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBlZGl0SW5wdXRFbGVtZW50KGluc3RhbmNlLCBlbGVtZW50LCBpbnB1dFJhbmdlLCBkYXRhLCBpbnB1dFR5cGUpO1xuICAgIH1cbn1cbmZ1bmN0aW9uIGVkaXRDb250ZW50ZWRpdGFibGUoaW5zdGFuY2UsIGVsZW1lbnQsIGlucHV0UmFuZ2UsIGRhdGEsIGlucHV0VHlwZSkge1xuICAgIGxldCBkZWwgPSBmYWxzZTtcbiAgICBpZiAoIWlucHV0UmFuZ2UuY29sbGFwc2VkKSB7XG4gICAgICAgIGRlbCA9IHRydWU7XG4gICAgICAgIGlucHV0UmFuZ2UuZGVsZXRlQ29udGVudHMoKTtcbiAgICB9IGVsc2UgaWYgKFtcbiAgICAgICAgJ2RlbGV0ZUNvbnRlbnRCYWNrd2FyZCcsXG4gICAgICAgICdkZWxldGVDb250ZW50Rm9yd2FyZCdcbiAgICBdLmluY2x1ZGVzKGlucHV0VHlwZSkpIHtcbiAgICAgICAgY29uc3QgbmV4dFBvc2l0aW9uID0gY3Vyc29yLmdldE5leHRDdXJzb3JQb3NpdGlvbihpbnB1dFJhbmdlLnN0YXJ0Q29udGFpbmVyLCBpbnB1dFJhbmdlLnN0YXJ0T2Zmc2V0LCBpbnB1dFR5cGUgPT09ICdkZWxldGVDb250ZW50QmFja3dhcmQnID8gLTEgOiAxLCBpbnB1dFR5cGUpO1xuICAgICAgICBpZiAobmV4dFBvc2l0aW9uKSB7XG4gICAgICAgICAgICBkZWwgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgZGVsUmFuZ2UgPSBpbnB1dFJhbmdlLmNsb25lUmFuZ2UoKTtcbiAgICAgICAgICAgIGlmIChkZWxSYW5nZS5jb21wYXJlUG9pbnQobmV4dFBvc2l0aW9uLm5vZGUsIG5leHRQb3NpdGlvbi5vZmZzZXQpIDwgMCkge1xuICAgICAgICAgICAgICAgIGRlbFJhbmdlLnNldFN0YXJ0KG5leHRQb3NpdGlvbi5ub2RlLCBuZXh0UG9zaXRpb24ub2Zmc2V0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGVsUmFuZ2Uuc2V0RW5kKG5leHRQb3NpdGlvbi5ub2RlLCBuZXh0UG9zaXRpb24ub2Zmc2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbFJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgICAgaWYgKGlucHV0UmFuZ2UuZW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBpbnB1dFJhbmdlLmVuZE9mZnNldDtcbiAgICAgICAgICAgIGlucHV0UmFuZ2UuZW5kQ29udGFpbmVyLmluc2VydERhdGEob2Zmc2V0LCBkYXRhKTtcbiAgICAgICAgICAgIGlucHV0UmFuZ2Uuc2V0U3RhcnQoaW5wdXRSYW5nZS5lbmRDb250YWluZXIsIG9mZnNldCArIGRhdGEubGVuZ3RoKTtcbiAgICAgICAgICAgIGlucHV0UmFuZ2Uuc2V0RW5kKGlucHV0UmFuZ2UuZW5kQ29udGFpbmVyLCBvZmZzZXQgKyBkYXRhLmxlbmd0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0ID0gZWxlbWVudC5vd25lckRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGRhdGEpO1xuICAgICAgICAgICAgaW5wdXRSYW5nZS5pbnNlcnROb2RlKHRleHQpO1xuICAgICAgICAgICAgaW5wdXRSYW5nZS5zZXRTdGFydCh0ZXh0LCBkYXRhLmxlbmd0aCk7XG4gICAgICAgICAgICBpbnB1dFJhbmdlLnNldEVuZCh0ZXh0LCBkYXRhLmxlbmd0aCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGRlbCB8fCBkYXRhKSB7XG4gICAgICAgIGluc3RhbmNlLmRpc3BhdGNoVUlFdmVudChlbGVtZW50LCAnaW5wdXQnLCB7XG4gICAgICAgICAgICBpbnB1dFR5cGVcbiAgICAgICAgfSk7XG4gICAgfVxufVxuZnVuY3Rpb24gZWRpdElucHV0RWxlbWVudChpbnN0YW5jZSwgZWxlbWVudCwgaW5wdXRSYW5nZSwgZGF0YSwgaW5wdXRUeXBlKSB7XG4gICAgbGV0IGRhdGFUb0luc2VydCA9IGRhdGE7XG4gICAgaWYgKG1heExlbmd0aC5zdXBwb3J0c01heExlbmd0aChlbGVtZW50KSkge1xuICAgICAgICBjb25zdCBtYXhMZW5ndGgkMSA9IG1heExlbmd0aC5nZXRNYXhMZW5ndGgoZWxlbWVudCk7XG4gICAgICAgIGlmIChtYXhMZW5ndGgkMSAhPT0gdW5kZWZpbmVkICYmIGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgc3BhY2VVbnRpbE1heExlbmd0aCA9IG1heExlbmd0aCQxIC0gZWxlbWVudC52YWx1ZS5sZW5ndGg7XG4gICAgICAgICAgICBpZiAoc3BhY2VVbnRpbE1heExlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBkYXRhVG9JbnNlcnQgPSBkYXRhLnN1YnN0cmluZygwLCBzcGFjZVVudGlsTWF4TGVuZ3RoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHsgbmV3VmFsdWUsIG5ld09mZnNldCwgb2xkVmFsdWUgfSA9IGNhbGN1bGF0ZU5ld1ZhbHVlKGRhdGFUb0luc2VydCwgZWxlbWVudCwgaW5wdXRSYW5nZSwgaW5wdXRUeXBlKTtcbiAgICBpZiAobmV3VmFsdWUgPT09IG9sZFZhbHVlICYmIG5ld09mZnNldCA9PT0gaW5wdXRSYW5nZS5zdGFydE9mZnNldCAmJiBuZXdPZmZzZXQgPT09IGlucHV0UmFuZ2UuZW5kT2Zmc2V0KSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGlzRWxlbWVudFR5cGUuaXNFbGVtZW50VHlwZShlbGVtZW50LCAnaW5wdXQnLCB7XG4gICAgICAgIHR5cGU6ICdudW1iZXInXG4gICAgfSkgJiYgIWlzVmFsaWROdW1iZXJJbnB1dChuZXdWYWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBVSS5zZXRVSVZhbHVlKGVsZW1lbnQsIG5ld1ZhbHVlKTtcbiAgICBzZXRTZWxlY3Rpb24uc2V0U2VsZWN0aW9uKHtcbiAgICAgICAgZm9jdXNOb2RlOiBlbGVtZW50LFxuICAgICAgICBhbmNob3JPZmZzZXQ6IG5ld09mZnNldCxcbiAgICAgICAgZm9jdXNPZmZzZXQ6IG5ld09mZnNldFxuICAgIH0pO1xuICAgIGlmIChpc0RhdGVPclRpbWUoZWxlbWVudCkpIHtcbiAgICAgICAgaWYgKHRpbWVWYWx1ZS5pc1ZhbGlkRGF0ZU9yVGltZVZhbHVlKGVsZW1lbnQsIG5ld1ZhbHVlKSkge1xuICAgICAgICAgICAgY29tbWl0SW5wdXQoaW5zdGFuY2UsIGVsZW1lbnQsIG5ld09mZnNldCwge30pO1xuICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGVsZW1lbnQsICdjaGFuZ2UnKTtcbiAgICAgICAgICAgIFVJLmNsZWFySW5pdGlhbFZhbHVlKGVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29tbWl0SW5wdXQoaW5zdGFuY2UsIGVsZW1lbnQsIG5ld09mZnNldCwge1xuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIGlucHV0VHlwZVxuICAgICAgICB9KTtcbiAgICB9XG59XG5mdW5jdGlvbiBjYWxjdWxhdGVOZXdWYWx1ZShpbnB1dERhdGEsIG5vZGUsIHsgc3RhcnRPZmZzZXQsIGVuZE9mZnNldCB9LCBpbnB1dFR5cGUpIHtcbiAgICBjb25zdCB2YWx1ZSA9IFVJLmdldFVJVmFsdWUobm9kZSk7XG4gICAgY29uc3QgcHJvbG9nRW5kID0gTWF0aC5tYXgoMCwgc3RhcnRPZmZzZXQgPT09IGVuZE9mZnNldCAmJiBpbnB1dFR5cGUgPT09ICdkZWxldGVDb250ZW50QmFja3dhcmQnID8gc3RhcnRPZmZzZXQgLSAxIDogc3RhcnRPZmZzZXQpO1xuICAgIGNvbnN0IHByb2xvZyA9IHZhbHVlLnN1YnN0cmluZygwLCBwcm9sb2dFbmQpO1xuICAgIGNvbnN0IGVwaWxvZ1N0YXJ0ID0gTWF0aC5taW4odmFsdWUubGVuZ3RoLCBzdGFydE9mZnNldCA9PT0gZW5kT2Zmc2V0ICYmIGlucHV0VHlwZSA9PT0gJ2RlbGV0ZUNvbnRlbnRGb3J3YXJkJyA/IHN0YXJ0T2Zmc2V0ICsgMSA6IGVuZE9mZnNldCk7XG4gICAgY29uc3QgZXBpbG9nID0gdmFsdWUuc3Vic3RyaW5nKGVwaWxvZ1N0YXJ0LCB2YWx1ZS5sZW5ndGgpO1xuICAgIGxldCBuZXdWYWx1ZSA9IGAke3Byb2xvZ30ke2lucHV0RGF0YX0ke2VwaWxvZ31gO1xuICAgIGxldCBuZXdPZmZzZXQgPSBwcm9sb2dFbmQgKyBpbnB1dERhdGEubGVuZ3RoO1xuICAgIGlmIChpc0VsZW1lbnRUeXBlLmlzRWxlbWVudFR5cGUobm9kZSwgJ2lucHV0Jywge1xuICAgICAgICB0eXBlOiAndGltZSdcbiAgICB9KSkge1xuICAgICAgICBjb25zdCBidWlsdFZhbHVlID0gdGltZVZhbHVlLmJ1aWxkVGltZVZhbHVlKG5ld1ZhbHVlKTtcbiAgICAgICAgaWYgKGJ1aWx0VmFsdWUgIT09ICcnICYmIHRpbWVWYWx1ZS5pc1ZhbGlkRGF0ZU9yVGltZVZhbHVlKG5vZGUsIGJ1aWx0VmFsdWUpKSB7XG4gICAgICAgICAgICBuZXdWYWx1ZSA9IGJ1aWx0VmFsdWU7XG4gICAgICAgICAgICBuZXdPZmZzZXQgPSBidWlsdFZhbHVlLmxlbmd0aDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBvbGRWYWx1ZTogdmFsdWUsXG4gICAgICAgIG5ld1ZhbHVlLFxuICAgICAgICBuZXdPZmZzZXRcbiAgICB9O1xufVxuZnVuY3Rpb24gY29tbWl0SW5wdXQoaW5zdGFuY2UsIGVsZW1lbnQsIG5ld09mZnNldCwgaW5wdXRJbml0KSB7XG4gICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGVsZW1lbnQsICdpbnB1dCcsIGlucHV0SW5pdCk7XG4gICAgdHJhY2tWYWx1ZS5jb21taXRWYWx1ZUFmdGVySW5wdXQoZWxlbWVudCwgbmV3T2Zmc2V0KTtcbn1cbmZ1bmN0aW9uIGlzVmFsaWROdW1iZXJJbnB1dCh2YWx1ZSkge1xuICAgIHZhciBfdmFsdWVfbWF0Y2gsIF92YWx1ZV9tYXRjaDE7XG4gICAgLy8gdGhlIGJyb3dzZXIgYWxsb3dzIHNvbWUgaW52YWxpZCBpbnB1dCBidXQgbm90IG90aGVyc1xuICAgIC8vIGl0IGFsbG93cyB1cCB0byB0d28gJy0nIGF0IGFueSBwbGFjZSBiZWZvcmUgYW55ICdlJyBvciBvbmUgZGlyZWN0bHkgZm9sbG93aW5nICdlJ1xuICAgIC8vIGl0IGFsbG93cyBvbmUgJy4nIGF0IGFueSBwbGFjZSBiZWZvcmUgZVxuICAgIGNvbnN0IHZhbHVlUGFydHMgPSB2YWx1ZS5zcGxpdCgnZScsIDIpO1xuICAgIHJldHVybiAhKC9bXlxcZC5cXC1lXS8udGVzdCh2YWx1ZSkgfHwgTnVtYmVyKChfdmFsdWVfbWF0Y2ggPSB2YWx1ZS5tYXRjaCgvLS9nKSkgPT09IG51bGwgfHwgX3ZhbHVlX21hdGNoID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfdmFsdWVfbWF0Y2gubGVuZ3RoKSA+IDIgfHwgTnVtYmVyKChfdmFsdWVfbWF0Y2gxID0gdmFsdWUubWF0Y2goL1xcLi9nKSkgPT09IG51bGwgfHwgX3ZhbHVlX21hdGNoMSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogX3ZhbHVlX21hdGNoMS5sZW5ndGgpID4gMSB8fCB2YWx1ZVBhcnRzWzFdICYmICEvXi0/XFxkKiQvLnRlc3QodmFsdWVQYXJ0c1sxXSkpO1xufVxuXG5leHBvcnRzLmlucHV0ID0gaW5wdXQ7XG4iXSwidmVyc2lvbiI6M30=