{"file":"/home/runner/workspace/server/api/demands.ts","mappings":"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","names":[],"sources":["/home/runner/workspace/server/api/demands.ts"],"sourcesContent":["import { Express } from 'express';\nimport { db } from '../db';\nimport {\n  demands,\n  demandComments,\n  residences,\n  buildings,\n  users,\n  userResidences,\n  userOrganizations,\n  organizations,\n} from '../../shared/schema';\nimport { eq, and, or, inArray, desc, asc } from 'drizzle-orm';\nimport { requireAuth } from '../auth/index';\nimport { insertDemandSchema, insertDemandCommentSchema } from '../../shared/schemas/operations';\nimport { z } from 'zod';\n\n/**\n * Register demand routes for managing resident demands and complaints.\n *\n * @param app - Express application instance.\n */\n/**\n * RegisterDemandRoutes function.\n * @param app\n * @returns Function result.\n */\nexport function registerDemandRoutes(app: Express) {\n  // Get demands for a user (residents and managers)\n  app.get('/api/demands', requireAuth, async (req: any, res: any) => {\n    try {\n      const user = req.user;\n      const { buildingId, residenceId, type, status, search } = req.query;\n\n      // Base query with joins\n      let query = db\n        .select({\n          id: demands.id,\n          submitterId: demands.submitterId,\n          type: demands.type,\n          assignationResidenceId: demands.assignationResidenceId,\n          assignationBuildingId: demands.assignationBuildingId,\n          description: demands.description,\n          filePath: demands.filePath,\n          fileName: demands.fileName,\n          fileSize: demands.fileSize,\n          residenceId: demands.residenceId,\n          buildingId: demands.buildingId,\n          status: demands.status,\n          reviewedBy: demands.reviewedBy,\n          reviewedAt: demands.reviewedAt,\n          reviewNotes: demands.reviewNotes,\n          createdAt: demands.createdAt,\n          updatedAt: demands.updatedAt,\n          submitter: {\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n          },\n          residence: {\n            id: residences.id,\n            unitNumber: residences.unitNumber,\n            buildingId: residences.buildingId,\n          },\n          building: {\n            id: buildings.id,\n            name: buildings.name,\n            address: buildings.address,\n          },\n        })\n        .from(demands)\n        .innerJoin(users, eq(demands.submitterId, users.id))\n        .innerJoin(residences, eq(demands.residenceId, residences.id))\n        .innerJoin(buildings, eq(demands.buildingId, buildings.id));\n\n      // Apply role-based access control\n      const conditions = [];\n      \n      if (user.role === 'admin') {\n        // Admins can see all demands - no additional conditions needed\n      } else if (user.role === 'manager') {\n        // Managers can see demands from their organization's buildings\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Get buildings belonging to the manager's organization\n          const organizationBuildings = await db\n            .select({ buildingId: buildings.id })\n            .from(buildings)\n            .where(eq(buildings.organizationId, organizationId));\n            \n          if (organizationBuildings.length > 0) {\n            const buildingIds = organizationBuildings.map(b => b.buildingId);\n            conditions.push(inArray(demands.buildingId, buildingIds));\n          } else {\n            // Manager has no buildings - return empty results\n            conditions.push(eq(demands.id, 'never-match'));\n          }\n        } else {\n          // Manager not assigned to any organization - return empty results\n          conditions.push(eq(demands.id, 'never-match'));\n        }\n      } else {\n        // Residents and tenants can only see demands they created\n        conditions.push(eq(demands.submitterId, user.id));\n      }\n\n      // Add filter conditions\n      if (buildingId) {\n        conditions.push(eq(demands.buildingId, buildingId));\n      }\n      if (residenceId) {\n        conditions.push(eq(demands.residenceId, residenceId));\n      }\n      if (type) {\n        conditions.push(eq(demands.type, type));\n      }\n      if (status) {\n        conditions.push(eq(demands.status, status));\n      }\n\n      // Apply conditions to query if any exist\n      let finalQuery;\n      if (conditions.length > 0) {\n        finalQuery = query.where(and(...conditions));\n      } else {\n        finalQuery = query;\n      }\n\n      const results = await finalQuery.orderBy(desc(demands.createdAt));\n\n      // Filter by search term if provided\n      let filteredResults = results;\n      if (search) {\n        const searchTerm = search.toLowerCase();\n        filteredResults = results.filter(\n          (demand) =>\n            demand.description.toLowerCase().includes(searchTerm) ||\n            demand.submitter.firstName?.toLowerCase().includes(searchTerm) ||\n            demand.submitter.lastName?.toLowerCase().includes(searchTerm) ||\n            demand.residence.unitNumber.toLowerCase().includes(searchTerm) ||\n            demand.building.name.toLowerCase().includes(searchTerm)\n        );\n      }\n\n      res.json(filteredResults);\n    } catch (error: any) {\n      res.status(500).json({ message: 'Failed to fetch demands' });\n    }\n  });\n\n  // Get a specific demand\n  app.get('/api/demands/:id', requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const user = req.user;\n\n      const demand = await db\n        .select({\n          id: demands.id,\n          submitterId: demands.submitterId,\n          type: demands.type,\n          assignationResidenceId: demands.assignationResidenceId,\n          assignationBuildingId: demands.assignationBuildingId,\n          description: demands.description,\n          filePath: demands.filePath,\n          fileName: demands.fileName,\n          fileSize: demands.fileSize,\n          residenceId: demands.residenceId,\n          buildingId: demands.buildingId,\n          status: demands.status,\n          reviewedBy: demands.reviewedBy,\n          reviewedAt: demands.reviewedAt,\n          reviewNotes: demands.reviewNotes,\n          createdAt: demands.createdAt,\n          updatedAt: demands.updatedAt,\n          submitter: {\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n          },\n          residence: {\n            id: residences.id,\n            unitNumber: residences.unitNumber,\n            buildingId: residences.buildingId,\n          },\n          building: {\n            id: buildings.id,\n            name: buildings.name,\n            address: buildings.address,\n          },\n        })\n        .from(demands)\n        .innerJoin(users, eq(demands.submitterId, users.id))\n        .innerJoin(residences, eq(demands.residenceId, residences.id))\n        .innerJoin(buildings, eq(demands.buildingId, buildings.id))\n        .where(eq(demands.id, id))\n        .limit(1);\n\n      if (demand.length === 0) {\n        return res.status(404).json({ message: 'Demand not found' });\n      }\n\n      const demandData = demand[0];\n\n      // Check access permissions based on user role\n      let hasAccess = false;\n      \n      if (user.role === 'admin') {\n        // Admins can view all demands\n        hasAccess = true;\n      } else if (user.role === 'manager') {\n        // Managers can view demands from their organization's buildings\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Check if the demand's building belongs to the manager's organization\n          const buildingOrganization = await db\n            .select({ organizationId: buildings.organizationId })\n            .from(buildings)\n            .where(eq(buildings.id, demandData.buildingId))\n            .limit(1);\n            \n          if (buildingOrganization.length > 0 && buildingOrganization[0].organizationId === organizationId) {\n            hasAccess = true;\n          }\n        }\n      } else {\n        // Residents and tenants can only view their own demands\n        hasAccess = demandData.submitterId === user.id;\n      }\n      \n      if (!hasAccess) {\n        return res.status(403).json({ message: 'Access denied' });\n      }\n\n      res.json(demandData);\n    } catch (error: any) {\n      res.status(500).json({ message: 'Failed to fetch demand' });\n    }\n  });\n\n  // Create a new demand\n  app.post('/api/demands', requireAuth, async (req: any, res: any) => {\n    try {\n      const user = req.user;\n      const demandData = req.body;\n      \n\n      // Validate input using the corrected schema that already has optional fields\n      const demandInputSchema = insertDemandSchema.omit({ submitterId: true });\n      \n      // Validate input\n      const validatedData = demandInputSchema.parse(demandData);\n      \n      console.log('✅ Demand validation passed:', validatedData);\n\n      // Auto-populate residence and building from user's primary residence if not provided\n      if (!validatedData.residenceId || !validatedData.buildingId) {\n        const userResidenceData = await db\n          .select({\n            residenceId: userResidences.residenceId,\n            buildingId: residences.buildingId,\n          })\n          .from(userResidences)\n          .innerJoin(residences, eq(userResidences.residenceId, residences.id))\n          .where(eq(userResidences.userId, user.id))\n          .limit(1);\n\n        if (userResidenceData.length === 0) {\n          return res\n            .status(400)\n            .json({ message: 'User must be assigned to a residence to create demands' });\n        }\n\n        validatedData.residenceId = validatedData.residenceId || userResidenceData[0].residenceId;\n        validatedData.buildingId = validatedData.buildingId || userResidenceData[0].buildingId;\n      }\n\n      // Ensure required fields are present after auto-population\n      if (!validatedData.buildingId || !validatedData.residenceId) {\n        return res.status(400).json({ \n          message: 'Building and residence are required to create a demand' \n        });\n      }\n      \n      console.log('✅ Final demand data before insertion:', {\n        buildingId: validatedData.buildingId,\n        residenceId: validatedData.residenceId,\n        type: validatedData.type,\n        description: validatedData.description\n      });\n\n      const demandInsertData = {\n        ...validatedData,\n        buildingId: validatedData.buildingId,\n        residenceId: validatedData.residenceId,\n        submitterId: user.id,\n        status: (validatedData.status as 'submitted' | 'under_review' | 'approved' | 'rejected' | 'in_progress' | 'completed' | 'cancelled') || 'submitted',\n      };\n\n      const newDemand = await db.insert(demands).values([demandInsertData]).returning();\n\n      res.status(201).json(newDemand[0]);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: 'Invalid demand data', errors: error.errors });\n      }\n      res.status(500).json({ message: 'Failed to create demand' });\n    }\n  });\n\n  // Update a demand\n  app.put('/api/demands/:id', requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const user = req.user;\n      const updates = req.body;\n\n      // Get the current demand\n      const currentDemand = await db.select().from(demands).where(eq(demands.id, id)).limit(1);\n\n      if (currentDemand.length === 0) {\n        return res.status(404).json({ message: 'Demand not found' });\n      }\n\n      const demand = currentDemand[0];\n\n      // Check permissions based on user role and update type\n      let canUpdate = false;\n      let allowedFields = [];\n      \n      if (user.role === 'admin') {\n        // Admins can update any demand and any field\n        canUpdate = true;\n        allowedFields = ['status', 'reviewNotes', 'reviewedBy', 'reviewedAt', 'description', 'type'];\n      } else if (user.role === 'manager') {\n        // Managers can update demands from their organization's buildings (status/review fields only)\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Check if the demand's building belongs to the manager's organization\n          const buildingOrganization = await db\n            .select({ organizationId: buildings.organizationId })\n            .from(buildings)\n            .where(eq(buildings.id, demand.buildingId))\n            .limit(1);\n            \n          if (buildingOrganization.length > 0 && buildingOrganization[0].organizationId === organizationId) {\n            canUpdate = true;\n            allowedFields = ['status', 'reviewNotes', 'reviewedBy', 'reviewedAt'];\n          }\n        }\n      } else if (demand.submitterId === user.id) {\n        // Residents and tenants can only update their own demands (limited fields)\n        canUpdate = true;\n        allowedFields = ['description', 'type'];\n      }\n      \n      if (!canUpdate) {\n        return res.status(403).json({ message: 'Access denied' });\n      }\n      \n      // Filter updates to only allowed fields\n      const filteredUpdates = {};\n      for (const [key, value] of Object.entries(updates)) {\n        if (allowedFields.includes(key)) {\n          filteredUpdates[key] = value;\n        }\n      }\n      \n      // Add metadata for manager/admin updates\n      if (user.role === 'admin' || user.role === 'manager') {\n        if (updates.status && updates.status !== demand.status) {\n          filteredUpdates['reviewedBy'] = user.id;\n          filteredUpdates['reviewedAt'] = new Date();\n        }\n      }\n\n      const updatedDemand = await db\n        .update(demands)\n        .set({ ...filteredUpdates, updatedAt: new Date() })\n        .where(eq(demands.id, id))\n        .returning();\n\n      res.json(updatedDemand[0]);\n    } catch (error: any) {\n      res.status(500).json({ message: 'Failed to update demand' });\n    }\n  });\n\n  // Delete a demand\n  app.delete('/api/demands/:id', requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const user = req.user;\n\n      // Get the current demand\n      const currentDemand = await db.select().from(demands).where(eq(demands.id, id)).limit(1);\n\n      if (currentDemand.length === 0) {\n        return res.status(404).json({ message: 'Demand not found' });\n      }\n\n      const demand = currentDemand[0];\n\n      // Check permissions based on user role\n      let canDelete = false;\n      \n      if (user.role === 'admin') {\n        // Admins can delete any demand\n        canDelete = true;\n      } else if (user.role === 'manager') {\n        // Managers can delete demands from their organization's buildings\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Check if the demand's building belongs to the manager's organization\n          const buildingOrganization = await db\n            .select({ organizationId: buildings.organizationId })\n            .from(buildings)\n            .where(eq(buildings.id, demand.buildingId))\n            .limit(1);\n            \n          if (buildingOrganization.length > 0 && buildingOrganization[0].organizationId === organizationId) {\n            canDelete = true;\n          }\n        }\n      } else if (demand.submitterId === user.id) {\n        // Users can delete their own demands\n        canDelete = true;\n      }\n      \n      if (!canDelete) {\n        return res.status(403).json({ message: 'Access denied' });\n      }\n\n      // Delete associated comments first (cascade delete)\n      await db.delete(demandComments).where(eq(demandComments.demandId, id));\n      \n      // Then delete the demand\n      await db.delete(demands).where(eq(demands.id, id));\n\n      res.json({ message: 'Demand deleted successfully' });\n    } catch (error: any) {\n      res.status(500).json({ message: 'Failed to delete demand' });\n    }\n  });\n\n  // Get comments for a demand\n  app.get('/api/demands/:id/comments', requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const user = req.user;\n\n      // First check if user has access to the demand\n      const demand = await db.select().from(demands).where(eq(demands.id, id)).limit(1);\n\n      if (demand.length === 0) {\n        return res.status(404).json({ message: 'Demand not found' });\n      }\n\n      const demandData = demand[0];\n\n      // Check access permissions based on user role\n      let hasAccess = false;\n      \n      if (user.role === 'admin') {\n        // Admins can view all demands\n        hasAccess = true;\n      } else if (user.role === 'manager') {\n        // Managers can view demands from their organization's buildings\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Check if the demand's building belongs to the manager's organization\n          const buildingOrganization = await db\n            .select({ organizationId: buildings.organizationId })\n            .from(buildings)\n            .where(eq(buildings.id, demandData.buildingId))\n            .limit(1);\n            \n          if (buildingOrganization.length > 0 && buildingOrganization[0].organizationId === organizationId) {\n            hasAccess = true;\n          }\n        }\n      } else {\n        // Residents and tenants can only view their own demands\n        hasAccess = demandData.submitterId === user.id;\n      }\n      \n      if (!hasAccess) {\n        return res.status(403).json({ message: 'Access denied' });\n      }\n\n      const comments = await db\n        .select({\n          id: demandComments.id,\n          demandId: demandComments.demandId,\n          commentText: demandComments.commentText,\n          commentType: demandComments.commentType,\n          isInternal: demandComments.isInternal,\n          commenterId: demandComments.commenterId,\n          createdAt: demandComments.createdAt,\n          author: {\n            id: users.id,\n            firstName: users.firstName,\n            lastName: users.lastName,\n            email: users.email,\n          },\n        })\n        .from(demandComments)\n        .innerJoin(users, eq(demandComments.commenterId, users.id))\n        .where(eq(demandComments.demandId, id))\n        .orderBy(asc(demandComments.createdAt));\n\n      res.json(comments);\n    } catch (error: any) {\n      res.status(500).json({ message: 'Failed to fetch demand comments' });\n    }\n  });\n\n  // Create a comment on a demand\n  app.post('/api/demands/:id/comments', requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const user = req.user;\n      const commentData = req.body;\n\n      // Validate input\n      const validatedData = insertDemandCommentSchema.parse({\n        ...commentData,\n        demandId: id,\n        commenterId: user.id,\n      });\n\n      // Check if user has access to the demand (same permission logic as GET comments)\n      const demand = await db.select().from(demands).where(eq(demands.id, id)).limit(1);\n\n      if (demand.length === 0) {\n        return res.status(404).json({ message: 'Demand not found' });\n      }\n\n      const demandData = demand[0];\n\n      // Check access permissions based on user role\n      let hasAccess = false;\n      \n      if (user.role === 'admin') {\n        // Admins can view all demands\n        hasAccess = true;\n      } else if (user.role === 'manager') {\n        // Managers can view demands from their organization's buildings\n        const userOrganizationData = await db\n          .select({ organizationId: userOrganizations.organizationId })\n          .from(userOrganizations)\n          .where(eq(userOrganizations.userId, user.id));\n          \n        if (userOrganizationData.length > 0) {\n          const organizationId = userOrganizationData[0].organizationId;\n          \n          // Check if the demand's building belongs to the manager's organization\n          const buildingOrganization = await db\n            .select({ organizationId: buildings.organizationId })\n            .from(buildings)\n            .where(eq(buildings.id, demandData.buildingId))\n            .limit(1);\n            \n          if (buildingOrganization.length > 0 && buildingOrganization[0].organizationId === organizationId) {\n            hasAccess = true;\n          }\n        }\n      } else {\n        // Residents and tenants can only view their own demands\n        hasAccess = demandData.submitterId === user.id;\n      }\n      \n      if (!hasAccess) {\n        return res.status(403).json({ message: 'Access denied' });\n      }\n\n      const newComment = await db.insert(demandComments).values(validatedData).returning();\n\n      res.status(201).json(newComment[0]);\n    } catch (error: any) {\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: 'Invalid comment data', errors: error.errors });\n      }\n      res.status(500).json({ message: 'Failed to create comment' });\n    }\n  });\n}\n"],"version":3}