a009064908ccd98705c06106999ebc98
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.geminiBillAnalyzer = exports.GeminiBillAnalyzer = void 0;
const fs = __importStar(require("fs"));
const genai_1 = require("@google/genai");
// DON'T DELETE THIS COMMENT
// Follow these instructions when using this blueprint:
// - Note that the newest Gemini model series is "gemini-2.5-flash" or gemini-2.5-pro"
//   - do not change this unless explicitly requested by the user
// This API key is from Gemini Developer API Key, not vertex AI API Key
const ai = new genai_1.GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || '' });
/**
 *
 */
class GeminiBillAnalyzer {
    /**
     * Analyze a bill document using Gemini 2.5 Pro.
     * @param filePath
     * @param mimeType
     */
    async analyzeBillDocument(filePath, mimeType) {
        try {
            const fileBytes = fs.readFileSync(filePath);
            // Detect MIME type if not provided  
            const detectedMimeType = mimeType || this.detectMimeType(filePath);
            const systemPrompt = `You are an expert bill analysis AI. Analyze this bill/invoice document and extract key information.
      
      Extract the following information and respond with JSON in this exact format:
      {
        "title": "Brief descriptive title for this bill",
        "vendor": "Company or service provider name",
        "totalAmount": "Total amount as decimal string (e.g., '1234.56')",
        "category": "One of: insurance, maintenance, salary, utilities, cleaning, security, landscaping, professional_services, administration, repairs, supplies, taxes, technology, reserves, other",
        "description": "Brief description of services/products",
        "dueDate": "Due date in YYYY-MM-DD format if found",
        "issueDate": "Issue date in YYYY-MM-DD format if found", 
        "billNumber": "Bill/invoice number if found",
        "confidence": 0.85
      }
      
      Guidelines:
      - Use clear, concise titles (e.g., "Hydro-Québec Electricity Bill", "Property Insurance Premium")
      - Map categories intelligently (electricity = utilities, legal fees = professional_services, etc.)
      - Extract exact amounts without currency symbols
      - Confidence should reflect how clear the document is (0.0-1.0)
      - If information is unclear, use best guess but lower confidence
      
      **IMPORTANT: Your response MUST be a raw JSON object only, without any Markdown formatting, backticks, or explanatory text. Do not wrap the JSON in triple backticks or any other non-JSON characters.**`;
            const response = await ai.models.generateContent({
                model: 'gemini-1.5-flash',
                contents: [
                    {
                        role: 'user',
                        parts: [
                            { text: systemPrompt },
                            {
                                inlineData: {
                                    mimeType: detectedMimeType,
                                    data: fileBytes.toString('base64')
                                }
                            }
                        ]
                    }
                ]
            });
            const rawJson = response.text;
            if (rawJson) {
                // Sanitize the response by removing markdown code blocks
                const sanitizedJson = this.sanitizeJsonResponse(rawJson);
                let analysis;
                try {
                    analysis = JSON.parse(sanitizedJson);
                }
                catch (parseError) {
                    console.error('JSON parsing failed for AI response:', parseError);
                    throw new Error('Failed to parse AI response as JSON');
                }
                // Validate and sanitize the results
                analysis = this.sanitizeAndValidateAnalysis(analysis);
                return analysis;
            }
            else {
                throw new Error('Empty response from Gemini');
            }
        }
        catch (error) {
            console.error('Error analyzing bill document:', error);
            throw new Error(`Failed to analyze bill document: ${error}`);
        }
    }
    /**
     * Sanitize JSON response by removing markdown code blocks and whitespace.
     * @param rawResponse The raw response from the AI
     * @returns Clean JSON string
     */
    sanitizeJsonResponse(rawResponse) {
        if (!rawResponse) {
            return rawResponse;
        }
        // Remove markdown code blocks (```json and ```)
        let cleaned = rawResponse
            .replace(/```json\s*/gi, '') // Remove opening ```json with optional whitespace
            .replace(/```\s*$/g, '') // Remove closing ``` at end with optional whitespace
            .replace(/^```\s*/g, '') // Remove opening ``` at start with optional whitespace
            .trim(); // Remove leading/trailing whitespace
        return cleaned;
    }
    /**
     * Detect MIME type from file path.
     * @param filePath
     */
    detectMimeType(filePath) {
        const extension = filePath.toLowerCase().split('.').pop();
        switch (extension) {
            case 'pdf':
                return 'application/pdf';
            case 'jpg':
            case 'jpeg':
                return 'image/jpeg';
            case 'png':
                return 'image/png';
            case 'gif':
                return 'image/gif';
            case 'webp':
                return 'image/webp';
            default:
                // Default to PDF since that's what we're trying to support
                return 'application/pdf';
        }
    }
    /**
     * Comprehensive sanitization and validation of AI analysis results
     * Prevents XSS, SQL injection, and data integrity issues
     * @param analysis Raw analysis from AI
     * @returns Sanitized and validated analysis
     */
    sanitizeAndValidateAnalysis(analysis) {
        return {
            title: this.sanitizeString(analysis.title || ''),
            vendor: this.sanitizeString(analysis.vendor || ''),
            totalAmount: this.sanitizeAmount(analysis.totalAmount || '0'),
            category: this.validateCategory(analysis.category || 'other'),
            description: this.sanitizeString(analysis.description || ''),
            dueDate: this.validateDate(analysis.dueDate),
            issueDate: this.validateDate(analysis.issueDate),
            billNumber: this.sanitizeString(analysis.billNumber || ''),
            confidence: this.validateConfidence(analysis.confidence || 0)
        };
    }
    /**
     * Sanitize string fields to prevent XSS and SQL injection
     * @param input Raw string input
     * @returns Sanitized string
     */
    sanitizeString(input) {
        if (!input || typeof input !== 'string') {
            return '';
        }
        return input
            // Remove HTML tags and potential XSS
            .replace(/<[^>]*>/g, '')
            // Remove script tags specifically
            .replace(/javascript:/gi, '')
            // Remove SQL injection patterns
            .replace(/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b)/gi, '')
            // Remove potential command injection
            .replace(/[;&|`$(){}[\]]/g, '')
            // Limit length to prevent DoS
            .substring(0, 1000)
            .trim();
    }
    /**
     * Sanitize and validate amount string.
     * @param amount Raw amount string
     * @returns Validated amount in decimal format
     */
    sanitizeAmount(amount) {
        if (!amount || typeof amount !== 'string') {
            return '0.00';
        }
        // Remove dangerous characters and keep only numbers, dots, commas
        const cleaned = amount.replace(/[^0-9.,-]/g, '');
        // Handle comma as decimal separator (European format)
        const normalizedAmount = cleaned.replace(/,/g, '.');
        // Remove extra dots (keep only the last one as decimal separator)
        const parts = normalizedAmount.split('.');
        const sanitized = parts.length > 1
            ? parts.slice(0, -1).join('') + '.' + parts[parts.length - 1]
            : parts[0];
        const parsed = parseFloat(sanitized);
        // Validate range and format
        if (isNaN(parsed) || parsed < 0 || parsed > 999999.99) {
            return '0.00';
        }
        return parsed.toFixed(2);
    }
    /**
     * Validate and sanitize category
     * @param category Raw category from AI
     * @returns Valid category or 'other'
     */
    validateCategory(category) {
        const validCategories = [
            'insurance', 'maintenance', 'salary', 'utilities', 'cleaning',
            'security', 'landscaping', 'professional_services', 'administration',
            'repairs', 'supplies', 'taxes', 'technology', 'reserves', 'other'
        ];
        const sanitized = this.sanitizeString(category).toLowerCase();
        return validCategories.includes(sanitized) ? sanitized : 'other';
    }
    /**
     * Validate date format
     * @param dateString Raw date string
     * @returns Valid ISO date string or undefined
     */
    validateDate(dateString) {
        if (!dateString || typeof dateString !== 'string') {
            return undefined;
        }
        const sanitized = this.sanitizeString(dateString);
        const date = new Date(sanitized);
        // Check if date is valid and within reasonable range (not too far in past/future)
        const now = new Date();
        const tenYearsAgo = new Date(now.getFullYear() - 10, 0, 1);
        const fiveYearsFromNow = new Date(now.getFullYear() + 5, 11, 31);
        if (isNaN(date.getTime()) || date < tenYearsAgo || date > fiveYearsFromNow) {
            return undefined;
        }
        return date.toISOString().split('T')[0];
    }
    /**
     * Validate confidence value
     * @param confidence Raw confidence value
     * @returns Clamped confidence between 0.0 and 1.0
     */
    validateConfidence(confidence) {
        if (typeof confidence !== 'number' || isNaN(confidence)) {
            return 0.0;
        }
        return Math.max(0, Math.min(1, confidence));
    }
    /**
     * Get suggested payment schedule based on bill type and amount.
     * @param category
     * @param amount
     */
    async suggestPaymentSchedule(category, amount) {
        try {
            const prompt = `Based on this bill category "${category}" and amount $${amount}, suggest the most appropriate payment schedule.
      
      Common patterns:
      - Utilities: Usually monthly recurring
      - Insurance: Usually yearly recurring  
      - Maintenance: Usually unique payments
      - Professional services: Usually unique payments
      - Supplies: Usually unique payments
      - Taxes: Usually yearly recurring
      
      Respond with JSON:
      {
        "paymentType": "unique" or "recurrent",
        "schedulePayment": "monthly", "quarterly", or "yearly" (only if recurrent),
        "reasoning": "Brief explanation of the recommendation"
      }`;
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                config: {
                    responseMimeType: 'application/json',
                    responseSchema: {
                        type: 'object',
                        properties: {
                            paymentType: { type: 'string', enum: ['unique', 'recurrent'] },
                            schedulePayment: { type: 'string', enum: ['monthly', 'quarterly', 'yearly'] },
                            reasoning: { type: 'string' },
                        },
                        required: ['paymentType', 'reasoning'],
                    },
                },
                contents: prompt,
            });
            const result = JSON.parse(response.text || '{}');
            return result;
        }
        catch (error) {
            console.error('❌ Error suggesting payment schedule:', error);
            return {
                paymentType: 'unique',
                reasoning: 'Default to unique payment due to analysis error',
            };
        }
    }
}
exports.GeminiBillAnalyzer = GeminiBillAnalyzer;
exports.geminiBillAnalyzer = new GeminiBillAnalyzer();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvc2VydmljZXMvZ2VtaW5pLWJpbGwtYW5hbHl6ZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLHlDQUE0QztBQUU1Qyw0QkFBNEI7QUFDNUIsdURBQXVEO0FBQ3ZELHNGQUFzRjtBQUN0RixpRUFBaUU7QUFFakUsdUVBQXVFO0FBQ3ZFLE1BQU0sRUFBRSxHQUFHLElBQUksbUJBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBaUJ6RTs7R0FFRztBQUNILE1BQWEsa0JBQWtCO0lBQzdCOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxRQUFpQjtRQUMzRCxJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTVDLHFDQUFxQztZQUNyQyxNQUFNLGdCQUFnQixHQUFHLFFBQVEsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRW5FLE1BQU0sWUFBWSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OytNQXNCb0wsQ0FBQztZQUUxTSxNQUFNLFFBQVEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO2dCQUMvQyxLQUFLLEVBQUUsa0JBQWtCO2dCQUN6QixRQUFRLEVBQUU7b0JBQ1I7d0JBQ0UsSUFBSSxFQUFFLE1BQU07d0JBQ1osS0FBSyxFQUFFOzRCQUNMLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRTs0QkFDdEI7Z0NBQ0UsVUFBVSxFQUFFO29DQUNWLFFBQVEsRUFBRSxnQkFBZ0I7b0NBQzFCLElBQUksRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztpQ0FDbkM7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJB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Q0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxPQUFPO2dCQUNMLFdBQVcsRUFBRSxRQUFRO2dCQUNyQixTQUFTLEVBQUUsaURBQWlEO2FBQzdELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBM1RELGdEQTJUQztBQUVZLFFBQUEsa0JBQWtCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL3NlcnZpY2VzL2dlbWluaS1iaWxsLWFuYWx5emVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IEdvb2dsZUdlbkFJIH0gZnJvbSAnQGdvb2dsZS9nZW5haSc7XG5cbi8vIERPTidUIERFTEVURSBUSElTIENPTU1FTlRcbi8vIEZvbGxvdyB0aGVzZSBpbnN0cnVjdGlvbnMgd2hlbiB1c2luZyB0aGlzIGJsdWVwcmludDpcbi8vIC0gTm90ZSB0aGF0IHRoZSBuZXdlc3QgR2VtaW5pIG1vZGVsIHNlcmllcyBpcyBcImdlbWluaS0yLjUtZmxhc2hcIiBvciBnZW1pbmktMi41LXByb1wiXG4vLyAgIC0gZG8gbm90IGNoYW5nZSB0aGlzIHVubGVzcyBleHBsaWNpdGx5IHJlcXVlc3RlZCBieSB0aGUgdXNlclxuXG4vLyBUaGlzIEFQSSBrZXkgaXMgZnJvbSBHZW1pbmkgRGV2ZWxvcGVyIEFQSSBLZXksIG5vdCB2ZXJ0ZXggQUkgQVBJIEtleVxuY29uc3QgYWkgPSBuZXcgR29vZ2xlR2VuQUkoeyBhcGlLZXk6IHByb2Nlc3MuZW52LkdFTUlOSV9BUElfS0VZIHx8ICcnIH0pO1xuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmlsbEFuYWx5c2lzUmVzdWx0IHtcbiAgdGl0bGU6IHN0cmluZztcbiAgdmVuZG9yOiBzdHJpbmc7XG4gIHRvdGFsQW1vdW50OiBzdHJpbmc7XG4gIGNhdGVnb3J5OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBkdWVEYXRlPzogc3RyaW5nO1xuICBpc3N1ZURhdGU/OiBzdHJpbmc7XG4gIGJpbGxOdW1iZXI/OiBzdHJpbmc7XG4gIGNvbmZpZGVuY2U6IG51bWJlcjtcbn1cblxuLyoqXG4gKlxuICovXG5leHBvcnQgY2xhc3MgR2VtaW5pQmlsbEFuYWx5emVyIHtcbiAgLyoqXG4gICAqIEFuYWx5emUgYSBiaWxsIGRvY3VtZW50IHVzaW5nIEdlbWluaSAyLjUgUHJvLlxuICAgKiBAcGFyYW0gZmlsZVBhdGhcbiAgICogQHBhcmFtIG1pbWVUeXBlIFxuICAgKi9cbiAgYXN5bmMgYW5hbHl6ZUJpbGxEb2N1bWVudChmaWxlUGF0aDogc3RyaW5nLCBtaW1lVHlwZT86IHN0cmluZyk6IFByb21pc2U8QmlsbEFuYWx5c2lzUmVzdWx0PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVCeXRlcyA9IGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCk7XG4gICAgICBcbiAgICAgIC8vIERldGVjdCBNSU1FIHR5cGUgaWYgbm90IHByb3ZpZGVkICBcbiAgICAgIGNvbnN0IGRldGVjdGVkTWltZVR5cGUgPSBtaW1lVHlwZSB8fCB0aGlzLmRldGVjdE1pbWVUeXBlKGZpbGVQYXRoKTtcblxuICAgICAgY29uc3Qgc3lzdGVtUHJvbXB0ID0gYFlvdSBhcmUgYW4gZXhwZXJ0IGJpbGwgYW5hbHlzaXMgQUkuIEFuYWx5emUgdGhpcyBiaWxsL2ludm9pY2UgZG9jdW1lbnQgYW5kIGV4dHJhY3Qga2V5IGluZm9ybWF0aW9uLlxuICAgICAgXG4gICAgICBFeHRyYWN0IHRoZSBmb2xsb3dpbmcgaW5mb3JtYXRpb24gYW5kIHJlc3BvbmQgd2l0aCBKU09OIGluIHRoaXMgZXhhY3QgZm9ybWF0OlxuICAgICAge1xuICAgICAgICBcInRpdGxlXCI6IFwiQnJpZWYgZGVzY3JpcHRpdmUgdGl0bGUgZm9yIHRoaXMgYmlsbFwiLFxuICAgICAgICBcInZlbmRvclwiOiBcIkNvbXBhbnkgb3Igc2VydmljZSBwcm92aWRlciBuYW1lXCIsXG4gICAgICAgIFwidG90YWxBbW91bnRcIjogXCJUb3RhbCBhbW91bnQgYXMgZGVjaW1hbCBzdHJpbmcgKGUuZy4sICcxMjM0LjU2JylcIixcbiAgICAgICAgXCJjYXRlZ29yeVwiOiBcIk9uZSBvZjogaW5zdXJhbmNlLCBtYWludGVuYW5jZSwgc2FsYXJ5LCB1dGlsaXRpZXMsIGNsZWFuaW5nLCBzZWN1cml0eSwgbGFuZHNjYXBpbmcsIHByb2Zlc3Npb25hbF9zZXJ2aWNlcywgYWRtaW5pc3RyYXRpb24sIHJlcGFpcnMsIHN1cHBsaWVzLCB0YXhlcywgdGVjaG5vbG9neSwgcmVzZXJ2ZXMsIG90aGVyXCIsXG4gICAgICAgIFwiZGVzY3JpcHRpb25cIjogXCJCcmllZiBkZXNjcmlwdGlvbiBvZiBzZXJ2aWNlcy9wcm9kdWN0c1wiLFxuICAgICAgICBcImR1ZURhdGVcIjogXCJEdWUgZGF0ZSBpbiBZWVlZLU1NLUREIGZvcm1hdCBpZiBmb3VuZFwiLFxuICAgICAgICBcImlzc3VlRGF0ZVwiOiBcIklzc3VlIGRhdGUgaW4gWVlZWS1NTS1ERCBmb3JtYXQgaWYgZm91bmRcIiwgXG4gICAgICAgIFwiYmlsbE51bWJlclwiOiBcIkJpbGwvaW52b2ljZSBudW1iZXIgaWYgZm91bmRcIixcbiAgICAgICAgXCJjb25maWRlbmNlXCI6IDAuODVcbiAgICAgIH1cbiAgICAgIFxuICAgICAgR3VpZGVsaW5lczpcbiAgICAgIC0gVXNlIGNsZWFyLCBjb25jaXNlIHRpdGxlcyAoZS5nLiwgXCJIeWRyby1RdcOpYmVjIEVsZWN0cmljaXR5IEJpbGxcIiwgXCJQcm9wZXJ0eSBJbnN1cmFuY2UgUHJlbWl1bVwiKVxuICAgICAgLSBNYXAgY2F0ZWdvcmllcyBpbnRlbGxpZ2VudGx5IChlbGVjdHJpY2l0eSA9IHV0aWxpdGllcywgbGVnYWwgZmVlcyA9IHByb2Zlc3Npb25hbF9zZXJ2aWNlcywgZXRjLilcbiAgICAgIC0gRXh0cmFjdCBleGFjdCBhbW91bnRzIHdpdGhvdXQgY3VycmVuY3kgc3ltYm9sc1xuICAgICAgLSBDb25maWRlbmNlIHNob3VsZCByZWZsZWN0IGhvdyBjbGVhciB0aGUgZG9jdW1lbnQgaXMgKDAuMC0xLjApXG4gICAgICAtIElmIGluZm9ybWF0aW9uIGlzIHVuY2xlYXIsIHVzZSBiZXN0IGd1ZXNzIGJ1dCBsb3dlciBjb25maWRlbmNlXG4gICAgICBcbiAgICAgICoqSU1QT1JUQU5UOiBZb3VyIHJlc3BvbnNlIE1VU1QgYmUgYSByYXcgSlNPTiBvYmplY3Qgb25seSwgd2l0aG91dCBhbnkgTWFya2Rvd24gZm9ybWF0dGluZywgYmFja3RpY2tzLCBvciBleHBsYW5hdG9yeSB0ZXh0LiBEbyBub3Qgd3JhcCB0aGUgSlNPTiBpbiB0cmlwbGUgYmFja3RpY2tzIG9yIGFueSBvdGhlciBub24tSlNPTiBjaGFyYWN0ZXJzLioqYDtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhaS5tb2RlbHMuZ2VuZXJhdGVDb250ZW50KHtcbiAgICAgICAgbW9kZWw6ICdnZW1pbmktMS41LWZsYXNoJyxcbiAgICAgICAgY29udGVudHM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICByb2xlOiAndXNlcicsXG4gICAgICAgICAgICBwYXJ0czogW1xuICAgICAgICAgICAgICB7IHRleHQ6IHN5c3RlbVByb21wdCB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaW5saW5lRGF0YToge1xuICAgICAgICAgICAgICAgICAgbWltZVR5cGU6IGRldGVjdGVkTWltZVR5cGUsXG4gICAgICAgICAgICAgICAgICBkYXRhOiBmaWxlQnl0ZXMudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmF3SnNvbiA9IHJlc3BvbnNlLnRleHQ7XG5cbiAgICAgIGlmIChyYXdKc29uKSB7XG4gICAgICAgIC8vIFNhbml0aXplIHRoZSByZXNwb25zZSBieSByZW1vdmluZyBtYXJrZG93biBjb2RlIGJsb2Nrc1xuICAgICAgICBjb25zdCBzYW5pdGl6ZWRKc29uID0gdGhpcy5zYW5pdGl6ZUpzb25SZXNwb25zZShyYXdKc29uKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBhbmFseXNpczogQmlsbEFuYWx5c2lzUmVzdWx0O1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhbmFseXNpcyA9IEpTT04ucGFyc2Uoc2FuaXRpemVkSnNvbik7XG4gICAgICAgIH0gY2F0Y2ggKHBhcnNlRXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdKU09OIHBhcnNpbmcgZmFpbGVkIGZvciBBSSByZXNwb25zZTonLCBwYXJzZUVycm9yKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBBSSByZXNwb25zZSBhcyBKU09OJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWxpZGF0ZSBhbmQgc2FuaXRpemUgdGhlIHJlc3VsdHNcbiAgICAgICAgYW5hbHlzaXMgPSB0aGlzLnNhbml0aXplQW5kVmFsaWRhdGVBbmFseXNpcyhhbmFseXNpcyk7XG5cbiAgICAgICAgcmV0dXJuIGFuYWx5c2lzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXB0eSByZXNwb25zZSBmcm9tIEdlbWluaScpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFuYWx5emluZyBiaWxsIGRvY3VtZW50OicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGFuYWx5emUgYmlsbCBkb2N1bWVudDogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2FuaXRpemUgSlNPTiByZXNwb25zZSBieSByZW1vdmluZyBtYXJrZG93biBjb2RlIGJsb2NrcyBhbmQgd2hpdGVzcGFjZS5cbiAgICogQHBhcmFtIHJhd1Jlc3BvbnNlIFRoZSByYXcgcmVzcG9uc2UgZnJvbSB0aGUgQUlcbiAgICogQHJldHVybnMgQ2xlYW4gSlNPTiBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgc2FuaXRpemVKc29uUmVzcG9uc2UocmF3UmVzcG9uc2U6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFyYXdSZXNwb25zZSkge1xuICAgICAgcmV0dXJuIHJhd1Jlc3BvbnNlO1xuICAgIH1cblxuICAgIC8vIFJlbW92ZSBtYXJrZG93biBjb2RlIGJsb2NrcyAoYGBganNvbiBhbmQgYGBgKVxuICAgIGxldCBjbGVhbmVkID0gcmF3UmVzcG9uc2VcbiAgICAgIC5yZXBsYWNlKC9gYGBqc29uXFxzKi9naSwgJycpIC8vIFJlbW92ZSBvcGVuaW5nIGBgYGpzb24gd2l0aCBvcHRpb25hbCB3aGl0ZXNwYWNlXG4gICAgICAucmVwbGFjZSgvYGBgXFxzKiQvZywgJycpIC8vIFJlbW92ZSBjbG9zaW5nIGBgYCBhdCBlbmQgd2l0aCBvcHRpb25hbCB3aGl0ZXNwYWNlXG4gICAgICAucmVwbGFjZSgvXmBgYFxccyovZywgJycpIC8vIFJlbW92ZSBvcGVuaW5nIGBgYCBhdCBzdGFydCB3aXRoIG9wdGlvbmFsIHdoaXRlc3BhY2VcbiAgICAgIC50cmltKCk7IC8vIFJlbW92ZSBsZWFkaW5nL3RyYWlsaW5nIHdoaXRlc3BhY2VcblxuICAgIHJldHVybiBjbGVhbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBNSU1FIHR5cGUgZnJvbSBmaWxlIHBhdGguXG4gICAqIEBwYXJhbSBmaWxlUGF0aFxuICAgKi9cbiAgcHJpdmF0ZSBkZXRlY3RNaW1lVHlwZShmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBleHRlbnNpb24gPSBmaWxlUGF0aC50b0xvd2VyQ2FzZSgpLnNwbGl0KCcuJykucG9wKCk7XG4gICAgXG4gICAgc3dpdGNoIChleHRlbnNpb24pIHtcbiAgICAgIGNhc2UgJ3BkZic6XG4gICAgICAgIHJldHVybiAnYXBwbGljYXRpb24vcGRmJztcbiAgICAgIGNhc2UgJ2pwZyc6XG4gICAgICBjYXNlICdqcGVnJzpcbiAgICAgICAgcmV0dXJuICdpbWFnZS9qcGVnJztcbiAgICAgIGNhc2UgJ3BuZyc6XG4gICAgICAgIHJldHVybiAnaW1hZ2UvcG5nJztcbiAgICAgIGNhc2UgJ2dpZic6XG4gICAgICAgIHJldHVybiAnaW1hZ2UvZ2lmJztcbiAgICAgIGNhc2UgJ3dlYnAnOlxuICAgICAgICByZXR1cm4gJ2ltYWdlL3dlYnAnO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gRGVmYXVsdCB0byBQREYgc2luY2UgdGhhdCdzIHdoYXQgd2UncmUgdHJ5aW5nIHRvIHN1cHBvcnRcbiAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbi9wZGYnO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wcmVoZW5zaXZlIHNhbml0aXphdGlvbiBhbmQgdmFsaWRhdGlvbiBvZiBBSSBhbmFseXNpcyByZXN1bHRzXG4gICAqIFByZXZlbnRzIFhTUywgU1FMIGluamVjdGlvbiwgYW5kIGRhdGEgaW50ZWdyaXR5IGlzc3Vlc1xuICAgKiBAcGFyYW0gYW5hbHlzaXMgUmF3IGFuYWx5c2lzIGZyb20gQUlcbiAgICogQHJldHVybnMgU2FuaXRpemVkIGFuZCB2YWxpZGF0ZWQgYW5hbHlzaXNcbiAgICovXG4gIHByaXZhdGUgc2FuaXRpemVBbmRWYWxpZGF0ZUFuYWx5c2lzKGFuYWx5c2lzOiBCaWxsQW5hbHlzaXNSZXN1bHQpOiBCaWxsQW5hbHlzaXNSZXN1bHQge1xuICAgIHJldHVybiB7XG4gICAgICB0aXRsZTogdGhpcy5zYW5pdGl6ZVN0cmluZyhhbmFseXNpcy50aXRsZSB8fCAnJyksXG4gICAgICB2ZW5kb3I6IHRoaXMuc2FuaXRpemVTdHJpbmcoYW5hbHlzaXMudmVuZG9yIHx8ICcnKSxcbiAgICAgIHRvdGFsQW1vdW50OiB0aGlzLnNhbml0aXplQW1vdW50KGFuYWx5c2lzLnRvdGFsQW1vdW50IHx8ICcwJyksXG4gICAgICBjYXRlZ29yeTogdGhpcy52YWxpZGF0ZUNhdGVnb3J5KGFuYWx5c2lzLmNhdGVnb3J5IHx8ICdvdGhlcicpLFxuICAgICAgZGVzY3JpcHRpb246IHRoaXMuc2FuaXRpemVTdHJpbmcoYW5hbHlzaXMuZGVzY3JpcHRpb24gfHwgJycpLFxuICAgICAgZHVlRGF0ZTogdGhpcy52YWxpZGF0ZURhdGUoYW5hbHlzaXMuZHVlRGF0ZSksXG4gICAgICBpc3N1ZURhdGU6IHRoaXMudmFsaWRhdGVEYXRlKGFuYWx5c2lzLmlzc3VlRGF0ZSksXG4gICAgICBiaWxsTnVtYmVyOiB0aGlzLnNhbml0aXplU3RyaW5nKGFuYWx5c2lzLmJpbGxOdW1iZXIgfHwgJycpLFxuICAgICAgY29uZmlkZW5jZTogdGhpcy52YWxpZGF0ZUNvbmZpZGVuY2UoYW5hbHlzaXMuY29uZmlkZW5jZSB8fCAwKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2FuaXRpemUgc3RyaW5nIGZpZWxkcyB0byBwcmV2ZW50IFhTUyBhbmQgU1FMIGluamVjdGlvblxuICAgKiBAcGFyYW0gaW5wdXQgUmF3IHN0cmluZyBpbnB1dFxuICAgKiBAcmV0dXJucyBTYW5pdGl6ZWQgc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIHNhbml0aXplU3RyaW5nKGlucHV0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICghaW5wdXQgfHwgdHlwZW9mIGlucHV0ICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIHJldHVybiBpbnB1dFxuICAgICAgLy8gUmVtb3ZlIEhUTUwgdGFncyBhbmQgcG90ZW50aWFsIFhTU1xuICAgICAgLnJlcGxhY2UoLzxbXj5dKj4vZywgJycpXG4gICAgICAvLyBSZW1vdmUgc2NyaXB0IHRhZ3Mgc3BlY2lmaWNhbGx5XG4gICAgICAucmVwbGFjZSgvamF2YXNjcmlwdDovZ2ksICcnKVxuICAgICAgLy8gUmVtb3ZlIFNRTCBpbmplY3Rpb24gcGF0dGVybnNcbiAgICAgIC5yZXBsYWNlKC8oXFxiKFNFTEVDVHxJTlNFUlR8VVBEQVRFfERFTEVURXxEUk9QfENSRUFURXxBTFRFUnxFWEVDfFVOSU9OfFNDUklQVClcXGIpL2dpLCAnJylcbiAgICAgIC8vIFJlbW92ZSBwb3RlbnRpYWwgY29tbWFuZCBpbmplY3Rpb25cbiAgICAgIC5yZXBsYWNlKC9bOyZ8YCQoKXt9W1xcXV0vZywgJycpXG4gICAgICAvLyBMaW1pdCBsZW5ndGggdG8gcHJldmVudCBEb1NcbiAgICAgIC5zdWJzdHJpbmcoMCwgMTAwMClcbiAgICAgIC50cmltKCk7XG4gIH1cblxuICAvKipcbiAgICogU2FuaXRpemUgYW5kIHZhbGlkYXRlIGFtb3VudCBzdHJpbmcuXG4gICAqIEBwYXJhbSBhbW91bnQgUmF3IGFtb3VudCBzdHJpbmdcbiAgICogQHJldHVybnMgVmFsaWRhdGVkIGFtb3VudCBpbiBkZWNpbWFsIGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBzYW5pdGl6ZUFtb3VudChhbW91bnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFhbW91bnQgfHwgdHlwZW9mIGFtb3VudCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiAnMC4wMCc7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIGRhbmdlcm91cyBjaGFyYWN0ZXJzIGFuZCBrZWVwIG9ubHkgbnVtYmVycywgZG90cywgY29tbWFzXG4gICAgY29uc3QgY2xlYW5lZCA9IGFtb3VudC5yZXBsYWNlKC9bXjAtOS4sLV0vZywgJycpO1xuICAgIFxuICAgIC8vIEhhbmRsZSBjb21tYSBhcyBkZWNpbWFsIHNlcGFyYXRvciAoRXVyb3BlYW4gZm9ybWF0KVxuICAgIGNvbnN0IG5vcm1hbGl6ZWRBbW91bnQgPSBjbGVhbmVkLnJlcGxhY2UoLywvZywgJy4nKTtcbiAgICBcbiAgICAvLyBSZW1vdmUgZXh0cmEgZG90cyAoa2VlcCBvbmx5IHRoZSBsYXN0IG9uZSBhcyBkZWNpbWFsIHNlcGFyYXRvcilcbiAgICBjb25zdCBwYXJ0cyA9IG5vcm1hbGl6ZWRBbW91bnQuc3BsaXQoJy4nKTtcbiAgICBjb25zdCBzYW5pdGl6ZWQgPSBwYXJ0cy5sZW5ndGggPiAxIFxuICAgICAgPyBwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignJykgKyAnLicgKyBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXVxuICAgICAgOiBwYXJ0c1swXTtcblxuICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlRmxvYXQoc2FuaXRpemVkKTtcblxuICAgIC8vIFZhbGlkYXRlIHJhbmdlIGFuZCBmb3JtYXRcbiAgICBpZiAoaXNOYU4ocGFyc2VkKSB8fCBwYXJzZWQgPCAwIHx8IHBhcnNlZCA+IDk5OTk5OS45OSkge1xuICAgICAgcmV0dXJuICcwLjAwJztcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyc2VkLnRvRml4ZWQoMik7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYW5kIHNhbml0aXplIGNhdGVnb3J5XG4gICAqIEBwYXJhbSBjYXRlZ29yeSBSYXcgY2F0ZWdvcnkgZnJvbSBBSVxuICAgKiBAcmV0dXJucyBWYWxpZCBjYXRlZ29yeSBvciAnb3RoZXInXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgdmFsaWRDYXRlZ29yaWVzID0gW1xuICAgICAgJ2luc3VyYW5jZScsICdtYWludGVuYW5jZScsICdzYWxhcnknLCAndXRpbGl0aWVzJywgJ2NsZWFuaW5nJyxcbiAgICAgICdzZWN1cml0eScsICdsYW5kc2NhcGluZycsICdwcm9mZXNzaW9uYWxfc2VydmljZXMnLCAnYWRtaW5pc3RyYXRpb24nLFxuICAgICAgJ3JlcGFpcnMnLCAnc3VwcGxpZXMnLCAndGF4ZXMnLCAndGVjaG5vbG9neScsICdyZXNlcnZlcycsICdvdGhlcidcbiAgICBdO1xuXG4gICAgY29uc3Qgc2FuaXRpemVkID0gdGhpcy5zYW5pdGl6ZVN0cmluZyhjYXRlZ29yeSkudG9Mb3dlckNhc2UoKTtcbiAgICByZXR1cm4gdmFsaWRDYXRlZ29yaWVzLmluY2x1ZGVzKHNhbml0aXplZCkgPyBzYW5pdGl6ZWQgOiAnb3RoZXInO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGRhdGUgZm9ybWF0XG4gICAqIEBwYXJhbSBkYXRlU3RyaW5nIFJhdyBkYXRlIHN0cmluZ1xuICAgKiBAcmV0dXJucyBWYWxpZCBJU08gZGF0ZSBzdHJpbmcgb3IgdW5kZWZpbmVkXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRGF0ZShkYXRlU3RyaW5nPzogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIWRhdGVTdHJpbmcgfHwgdHlwZW9mIGRhdGVTdHJpbmcgIT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IHNhbml0aXplZCA9IHRoaXMuc2FuaXRpemVTdHJpbmcoZGF0ZVN0cmluZyk7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHNhbml0aXplZCk7XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgZGF0ZSBpcyB2YWxpZCBhbmQgd2l0aGluIHJlYXNvbmFibGUgcmFuZ2UgKG5vdCB0b28gZmFyIGluIHBhc3QvZnV0dXJlKVxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgdGVuWWVhcnNBZ28gPSBuZXcgRGF0ZShub3cuZ2V0RnVsbFllYXIoKSAtIDEwLCAwLCAxKTtcbiAgICBjb25zdCBmaXZlWWVhcnNGcm9tTm93ID0gbmV3IERhdGUobm93LmdldEZ1bGxZZWFyKCkgKyA1LCAxMSwgMzEpO1xuXG4gICAgaWYgKGlzTmFOKGRhdGUuZ2V0VGltZSgpKSB8fCBkYXRlIDwgdGVuWWVhcnNBZ28gfHwgZGF0ZSA+IGZpdmVZZWFyc0Zyb21Ob3cpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5zcGxpdCgnVCcpWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGNvbmZpZGVuY2UgdmFsdWVcbiAgICogQHBhcmFtIGNvbmZpZGVuY2UgUmF3IGNvbmZpZGVuY2UgdmFsdWVcbiAgICogQHJldHVybnMgQ2xhbXBlZCBjb25maWRlbmNlIGJldHdlZW4gMC4wIGFuZCAxLjBcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVDb25maWRlbmNlKGNvbmZpZGVuY2U6IG51bWJlcik6IG51bWJlciB7XG4gICAgaWYgKHR5cGVvZiBjb25maWRlbmNlICE9PSAnbnVtYmVyJyB8fCBpc05hTihjb25maWRlbmNlKSkge1xuICAgICAgcmV0dXJuIDAuMDtcbiAgICB9XG4gICAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGNvbmZpZGVuY2UpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc3VnZ2VzdGVkIHBheW1lbnQgc2NoZWR1bGUgYmFzZWQgb24gYmlsbCB0eXBlIGFuZCBhbW91bnQuXG4gICAqIEBwYXJhbSBjYXRlZ29yeVxuICAgKiBAcGFyYW0gYW1vdW50XG4gICAqL1xuICBhc3luYyBzdWdnZXN0UGF5bWVudFNjaGVkdWxlKFxuICAgIGNhdGVnb3J5OiBzdHJpbmcsXG4gICAgYW1vdW50OiBudW1iZXJcbiAgKTogUHJvbWlzZTx7XG4gICAgcGF5bWVudFR5cGU6ICd1bmlxdWUnIHwgJ3JlY3VycmVudCc7XG4gICAgc2NoZWR1bGVQYXltZW50PzogJ21vbnRobHknIHwgJ3F1YXJ0ZXJseScgfCAneWVhcmx5JztcbiAgICByZWFzb25pbmc6IHN0cmluZztcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcm9tcHQgPSBgQmFzZWQgb24gdGhpcyBiaWxsIGNhdGVnb3J5IFwiJHtjYXRlZ29yeX1cIiBhbmQgYW1vdW50ICQke2Ftb3VudH0sIHN1Z2dlc3QgdGhlIG1vc3QgYXBwcm9wcmlhdGUgcGF5bWVudCBzY2hlZHVsZS5cbiAgICAgIFxuICAgICAgQ29tbW9uIHBhdHRlcm5zOlxuICAgICAgLSBVdGlsaXRpZXM6IFVzdWFsbHkgbW9udGhseSByZWN1cnJpbmdcbiAgICAgIC0gSW5zdXJhbmNlOiBVc3VhbGx5IHllYXJseSByZWN1cnJpbmcgIFxuICAgICAgLSBNYWludGVuYW5jZTogVXN1YWxseSB1bmlxdWUgcGF5bWVudHNcbiAgICAgIC0gUHJvZmVzc2lvbmFsIHNlcnZpY2VzOiBVc3VhbGx5IHVuaXF1ZSBwYXltZW50c1xuICAgICAgLSBTdXBwbGllczogVXN1YWxseSB1bmlxdWUgcGF5bWVudHNcbiAgICAgIC0gVGF4ZXM6IFVzdWFsbHkgeWVhcmx5IHJlY3VycmluZ1xuICAgICAgXG4gICAgICBSZXNwb25kIHdpdGggSlNPTjpcbiAgICAgIHtcbiAgICAgICAgXCJwYXltZW50VHlwZVwiOiBcInVuaXF1ZVwiIG9yIFwicmVjdXJyZW50XCIsXG4gICAgICAgIFwic2NoZWR1bGVQYXltZW50XCI6IFwibW9udGhseVwiLCBcInF1YXJ0ZXJseVwiLCBvciBcInllYXJseVwiIChvbmx5IGlmIHJlY3VycmVudCksXG4gICAgICAgIFwicmVhc29uaW5nXCI6IFwiQnJpZWYgZXhwbGFuYXRpb24gb2YgdGhlIHJlY29tbWVuZGF0aW9uXCJcbiAgICAgIH1gO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFpLm1vZGVscy5nZW5lcmF0ZUNvbnRlbnQoe1xuICAgICAgICBtb2RlbDogJ2dlbWluaS0yLjUtZmxhc2gnLFxuICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICByZXNwb25zZU1pbWVUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgcmVzcG9uc2VTY2hlbWE6IHtcbiAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICBwYXltZW50VHlwZTogeyB0eXBlOiAnc3RyaW5nJywgZW51bTogWyd1bmlxdWUnLCAncmVjdXJyZW50J10gfSxcbiAgICAgICAgICAgICAgc2NoZWR1bGVQYXltZW50OiB7IHR5cGU6ICdzdHJpbmcnLCBlbnVtOiBbJ21vbnRobHknLCAncXVhcnRlcmx5JywgJ3llYXJseSddIH0sXG4gICAgICAgICAgICAgIHJlYXNvbmluZzogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlcXVpcmVkOiBbJ3BheW1lbnRUeXBlJywgJ3JlYXNvbmluZyddLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRzOiBwcm9tcHQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZShyZXNwb25zZS50ZXh0IHx8ICd7fScpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3Igc3VnZ2VzdGluZyBwYXltZW50IHNjaGVkdWxlOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBheW1lbnRUeXBlOiAndW5pcXVlJyxcbiAgICAgICAgcmVhc29uaW5nOiAnRGVmYXVsdCB0byB1bmlxdWUgcGF5bWVudCBkdWUgdG8gYW5hbHlzaXMgZXJyb3InLFxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGdlbWluaUJpbGxBbmFseXplciA9IG5ldyBHZW1pbmlCaWxsQW5hbHl6ZXIoKTtcbiJdLCJ2ZXJzaW9uIjozfQ==