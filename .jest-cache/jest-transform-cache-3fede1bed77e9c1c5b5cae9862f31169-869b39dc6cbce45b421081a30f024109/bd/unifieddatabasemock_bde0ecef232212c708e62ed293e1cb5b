609f6fabb0ace5abaf35a21b0cb45789
"use strict";
/**
 * Unified Database Mock for Jest Tests
 * This provides a consistent mock interface that works across all test types
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.testUtils = exports.mockSchema = exports.mockDb = exports.clearMockData = exports.generateMockId = void 0;
const globals_1 = require("@jest/globals");
// Global state management for test isolation
let mockIdCounter = 1;
const mockDataStore = new Map();
const generateMockId = () => {
    return `mock-${mockIdCounter++}-${Date.now().toString(36)}`;
};
exports.generateMockId = generateMockId;
const clearMockData = () => {
    mockDataStore.clear();
    mockIdCounter = 1;
};
exports.clearMockData = clearMockData;
// Create a chainable query builder that handles all Drizzle operations
const createQueryBuilder = (defaultResult = []) => {
    const builder = {};
    // All chainable methods return the builder itself
    const chainableMethods = [
        'from', 'where', 'leftJoin', 'innerJoin', 'rightJoin',
        'select', 'set', 'values', 'returning', 'orderBy', 'limit',
        'offset', 'groupBy', 'having', 'onConflictDoUpdate', 'onConflictDoNothing'
    ];
    chainableMethods.forEach(method => {
        builder[method] = globals_1.jest.fn().mockImplementation((...args) => {
            // Special handling for values method to return proper data
            if (method === 'values') {
                const data = args[0];
                builder._insertData = data;
            }
            return builder;
        });
    });
    // Make the builder thenable (promise-like)
    builder.then = globals_1.jest.fn().mockImplementation((resolve) => {
        let result = defaultResult;
        // If this is an insert operation with data, return mock records
        if (builder._insertData) {
            const data = builder._insertData;
            const now = new Date();
            if (Array.isArray(data)) {
                result = data.map(item => ({
                    id: (0, exports.generateMockId)(),
                    ...item,
                    createdAt: now,
                    updatedAt: now
                }));
            }
            else {
                result = [{
                        id: (0, exports.generateMockId)(),
                        ...data,
                        createdAt: now,
                        updatedAt: now
                    }];
            }
        }
        return Promise.resolve(result).then(resolve);
    });
    builder.catch = globals_1.jest.fn().mockImplementation((reject) => {
        return Promise.resolve(defaultResult).catch(reject);
    });
    builder.finally = globals_1.jest.fn().mockImplementation((finallyFn) => {
        return Promise.resolve(defaultResult).finally(finallyFn);
    });
    return builder;
};
// Main mock database object
exports.mockDb = {
    // Core database operations
    query: globals_1.jest.fn().mockImplementation(async (sql) => {
        if (sql.includes('SELECT version()')) {
            return [{ version: 'PostgreSQL 15.0 (Mock)' }];
        }
        return [];
    }),
    // Insert operations
    insert: globals_1.jest.fn().mockImplementation((table) => {
        return createQueryBuilder([{ id: (0, exports.generateMockId)() }]);
    }),
    // Select operations
    select: globals_1.jest.fn().mockImplementation((fields) => {
        return createQueryBuilder([]);
    }),
    // Update operations
    update: globals_1.jest.fn().mockImplementation((table) => {
        return createQueryBuilder({ affectedRows: 1 });
    }),
    // Delete operations
    delete: globals_1.jest.fn().mockImplementation((table) => {
        return createQueryBuilder({ affectedRows: 1 });
    }),
    // Transaction support
    transaction: globals_1.jest.fn().mockImplementation(async (callback) => {
        return await callback(exports.mockDb);
    }),
    // Batch operations
    batch: globals_1.jest.fn().mockImplementation(async (queries) => {
        return queries.map(() => ({ affectedRows: 1 }));
    }),
    // With clause support
    $with: globals_1.jest.fn().mockImplementation(() => createQueryBuilder([])),
    // Raw SQL support
    execute: globals_1.jest.fn().mockImplementation(async () => ({ rows: [] })),
    // Connection management (for integration tests)
    end: globals_1.jest.fn().mockResolvedValue(void 0),
    connect: globals_1.jest.fn().mockResolvedValue(void 0)
};
// Mock schema tables for type safety
const createMockTable = (tableName) => ({
    _: {
        name: tableName,
        schema: undefined,
        columns: {},
        baseName: tableName
    },
    // Common column mocks
    id: { name: 'id' },
    email: { name: 'email' },
    name: { name: 'name' },
    role: { name: 'role' },
    userId: { name: 'userId' },
    organizationId: { name: 'organizationId' },
    buildingId: { name: 'buildingId' },
    residenceId: { name: 'residenceId' },
    status: { name: 'status' },
    createdAt: { name: 'createdAt' },
    updatedAt: { name: 'updatedAt' }
});
// Export mock schema for tests to import
exports.mockSchema = {
    // Core tables
    users: createMockTable('users'),
    organizations: createMockTable('organizations'),
    userOrganizations: createMockTable('userOrganizations'),
    invitations: createMockTable('invitations'),
    passwordResetTokens: createMockTable('passwordResetTokens'),
    // Property tables  
    buildings: createMockTable('buildings'),
    residences: createMockTable('residences'),
    userResidences: createMockTable('userResidences'),
    // Document tables
    documents: createMockTable('documents'),
    // Financial tables
    bills: createMockTable('bills'),
    budgets: createMockTable('budgets'),
    monthlyBudgets: createMockTable('monthlyBudgets'),
    // Operations tables
    maintenanceRequests: createMockTable('maintenanceRequests'),
    commonSpaces: createMockTable('commonSpaces'),
    // System tables
    permissions: createMockTable('permissions'),
    userPermissions: createMockTable('userPermissions'),
    rolePermissions: createMockTable('rolePermissions'),
    demands: createMockTable('demands')
};
// Export test utilities
exports.testUtils = {
    clearMockData: exports.clearMockData,
    generateMockId: exports.generateMockId,
    getMockData: () => mockDataStore,
    resetMocks: () => {
        (0, exports.clearMockData)();
        globals_1.jest.clearAllMocks();
    }
};
// Default export for convenience
exports.default = exports.mockDb;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9tb2Nrcy91bmlmaWVkLWRhdGFiYXNlLW1vY2sudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsMkNBQXFDO0FBRXJDLDZDQUE2QztBQUM3QyxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUM7QUFDdEIsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUV6QixNQUFNLGNBQWMsR0FBRyxHQUFHLEVBQUU7SUFDakMsT0FBTyxRQUFRLGFBQWEsRUFBRSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztBQUM5RCxDQUFDLENBQUM7QUFGVyxRQUFBLGNBQWMsa0JBRXpCO0FBRUssTUFBTSxhQUFhLEdBQUcsR0FBRyxFQUFFO0lBQ2hDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN0QixhQUFhLEdBQUcsQ0FBQyxDQUFDO0FBQ3BCLENBQUMsQ0FBQztBQUhXLFFBQUEsYUFBYSxpQkFHeEI7QUFFRix1RUFBdUU7QUFDdkUsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLGdCQUFxQixFQUFFLEVBQUUsRUFBRTtJQUNyRCxNQUFNLE9BQU8sR0FBUSxFQUFFLENBQUM7SUFFeEIsa0RBQWtEO0lBQ2xELE1BQU0sZ0JBQWdCLEdBQUc7UUFDdkIsTUFBTSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFdBQVc7UUFDckQsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxPQUFPO1FBQzFELFFBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFLHFCQUFxQjtLQUMzRSxDQUFDO0lBRUYsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ2hDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxjQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFH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LHNCQUFjO0lBQ2QsV0FBVyxFQUFFLEdBQUcsRUFBRSxDQUFDLGFBQWE7SUFDaEMsVUFBVSxFQUFFLEdBQUcsRUFBRTtRQUNmLElBQUEscUJBQWEsR0FBRSxDQUFDO1FBQ2hCLGNBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0NBQ0YsQ0FBQztBQUVGLGlDQUFpQztBQUNqQyxrQkFBZSxjQUFNLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9tb2Nrcy91bmlmaWVkLWRhdGFiYXNlLW1vY2sudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVbmlmaWVkIERhdGFiYXNlIE1vY2sgZm9yIEplc3QgVGVzdHNcbiAqIFRoaXMgcHJvdmlkZXMgYSBjb25zaXN0ZW50IG1vY2sgaW50ZXJmYWNlIHRoYXQgd29ya3MgYWNyb3NzIGFsbCB0ZXN0IHR5cGVzXG4gKi9cblxuaW1wb3J0IHsgamVzdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuXG4vLyBHbG9iYWwgc3RhdGUgbWFuYWdlbWVudCBmb3IgdGVzdCBpc29sYXRpb25cbmxldCBtb2NrSWRDb3VudGVyID0gMTtcbmNvbnN0IG1vY2tEYXRhU3RvcmUgPSBuZXcgTWFwKCk7XG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZU1vY2tJZCA9ICgpID0+IHtcbiAgcmV0dXJuIGBtb2NrLSR7bW9ja0lkQ291bnRlcisrfS0ke0RhdGUubm93KCkudG9TdHJpbmcoMzYpfWA7XG59O1xuXG5leHBvcnQgY29uc3QgY2xlYXJNb2NrRGF0YSA9ICgpID0+IHtcbiAgbW9ja0RhdGFTdG9yZS5jbGVhcigpO1xuICBtb2NrSWRDb3VudGVyID0gMTtcbn07XG5cbi8vIENyZWF0ZSBhIGNoYWluYWJsZSBxdWVyeSBidWlsZGVyIHRoYXQgaGFuZGxlcyBhbGwgRHJpenpsZSBvcGVyYXRpb25zXG5jb25zdCBjcmVhdGVRdWVyeUJ1aWxkZXIgPSAoZGVmYXVsdFJlc3VsdDogYW55ID0gW10pID0+IHtcbiAgY29uc3QgYnVpbGRlcjogYW55ID0ge307XG4gIFxuICAvLyBBbGwgY2hhaW5hYmxlIG1ldGhvZHMgcmV0dXJuIHRoZSBidWlsZGVyIGl0c2VsZlxuICBjb25zdCBjaGFpbmFibGVNZXRob2RzID0gW1xuICAgICdmcm9tJywgJ3doZXJlJywgJ2xlZnRKb2luJywgJ2lubmVySm9pbicsICdyaWdodEpvaW4nLFxuICAgICdzZWxlY3QnLCAnc2V0JywgJ3ZhbHVlcycsICdyZXR1cm5pbmcnLCAnb3JkZXJCeScsICdsaW1pdCcsXG4gICAgJ29mZnNldCcsICdncm91cEJ5JywgJ2hhdmluZycsICdvbkNvbmZsaWN0RG9VcGRhdGUnLCAnb25Db25mbGljdERvTm90aGluZydcbiAgXTtcbiAgXG4gIGNoYWluYWJsZU1ldGhvZHMuZm9yRWFjaChtZXRob2QgPT4ge1xuICAgIGJ1aWxkZXJbbWV0aG9kXSA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKC4uLmFyZ3MpID0+IHtcbiAgICAgIC8vIFNwZWNpYWwgaGFuZGxpbmcgZm9yIHZhbHVlcyBtZXRob2QgdG8gcmV0dXJuIHByb3BlciBkYXRhXG4gICAgICBpZiAobWV0aG9kID09PSAndmFsdWVzJykge1xuICAgICAgICBjb25zdCBkYXRhID0gYXJnc1swXTtcbiAgICAgICAgYnVpbGRlci5faW5zZXJ0RGF0YSA9IGRhdGE7XG4gICAgICB9XG4gICAgICByZXR1cm4gYnVpbGRlcjtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICAvLyBNYWtlIHRoZSBidWlsZGVyIHRoZW5hYmxlIChwcm9taXNlLWxpa2UpXG4gIGJ1aWxkZXIudGhlbiA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHJlc29sdmU6IGFueSkgPT4ge1xuICAgIGxldCByZXN1bHQgPSBkZWZhdWx0UmVzdWx0O1xuICAgIFxuICAgIC8vIElmIHRoaXMgaXMgYW4gaW5zZXJ0IG9wZXJhdGlvbiB3aXRoIGRhdGEsIHJldHVybiBtb2NrIHJlY29yZHNcbiAgICBpZiAoYnVpbGRlci5faW5zZXJ0RGF0YSkge1xuICAgICAgY29uc3QgZGF0YSA9IGJ1aWxkZXIuX2luc2VydERhdGE7XG4gICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICByZXN1bHQgPSBkYXRhLm1hcChpdGVtID0+ICh7XG4gICAgICAgICAgaWQ6IGdlbmVyYXRlTW9ja0lkKCksXG4gICAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5vd1xuICAgICAgICB9KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQgPSBbe1xuICAgICAgICAgIGlkOiBnZW5lcmF0ZU1vY2tJZCgpLFxuICAgICAgICAgIC4uLmRhdGEsXG4gICAgICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICAgICAgdXBkYXRlZEF0OiBub3dcbiAgICAgICAgfV07XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KS50aGVuKHJlc29sdmUpO1xuICB9KTtcbiAgXG4gIGJ1aWxkZXIuY2F0Y2ggPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChyZWplY3Q6IGFueSkgPT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdFJlc3VsdCkuY2F0Y2gocmVqZWN0KTtcbiAgfSk7XG4gIFxuICBidWlsZGVyLmZpbmFsbHkgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChmaW5hbGx5Rm46IGFueSkgPT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZGVmYXVsdFJlc3VsdCkuZmluYWxseShmaW5hbGx5Rm4pO1xuICB9KTtcblxuICByZXR1cm4gYnVpbGRlcjtcbn07XG5cbi8vIE1haW4gbW9jayBkYXRhYmFzZSBvYmplY3RcbmV4cG9ydCBjb25zdCBtb2NrRGIgPSB7XG4gIC8vIENvcmUgZGF0YWJhc2Ugb3BlcmF0aW9uc1xuICBxdWVyeTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoc3FsOiBzdHJpbmcpID0+IHtcbiAgICBpZiAoc3FsLmluY2x1ZGVzKCdTRUxFQ1QgdmVyc2lvbigpJykpIHtcbiAgICAgIHJldHVybiBbeyB2ZXJzaW9uOiAnUG9zdGdyZVNRTCAxNS4wIChNb2NrKScgfV07XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfSksXG4gIFxuICAvLyBJbnNlcnQgb3BlcmF0aW9uc1xuICBpbnNlcnQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRhYmxlOiBhbnkpID0+IHtcbiAgICByZXR1cm4gY3JlYXRlUXVlcnlCdWlsZGVyKFt7IGlkOiBnZW5lcmF0ZU1vY2tJZCgpIH1dKTtcbiAgfSksXG4gIFxuICAvLyBTZWxlY3Qgb3BlcmF0aW9uc1xuICBzZWxlY3Q6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGZpZWxkcz86IGFueSkgPT4ge1xuICAgIHJldHVybiBjcmVhdGVRdWVyeUJ1aWxkZXIoW10pO1xuICB9KSxcbiAgXG4gIC8vIFVwZGF0ZSBvcGVyYXRpb25zXG4gIHVwZGF0ZTogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigodGFibGU6IGFueSkgPT4ge1xuICAgIHJldHVybiBjcmVhdGVRdWVyeUJ1aWxkZXIoeyBhZmZlY3RlZFJvd3M6IDEgfSk7XG4gIH0pLFxuICBcbiAgLy8gRGVsZXRlIG9wZXJhdGlvbnNcbiAgZGVsZXRlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCh0YWJsZTogYW55KSA9PiB7XG4gICAgcmV0dXJuIGNyZWF0ZVF1ZXJ5QnVpbGRlcih7IGFmZmVjdGVkUm93czogMSB9KTtcbiAgfSksXG4gIFxuICAvLyBUcmFuc2FjdGlvbiBzdXBwb3J0XG4gIHRyYW5zYWN0aW9uOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChjYWxsYmFjazogYW55KSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IGNhbGxiYWNrKG1vY2tEYik7XG4gIH0pLFxuICBcbiAgLy8gQmF0Y2ggb3BlcmF0aW9uc1xuICBiYXRjaDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAocXVlcmllczogYW55W10pID0+IHtcbiAgICByZXR1cm4gcXVlcmllcy5tYXAoKCkgPT4gKHsgYWZmZWN0ZWRSb3dzOiAxIH0pKTtcbiAgfSksXG4gIFxuICAvLyBXaXRoIGNsYXVzZSBzdXBwb3J0XG4gICR3aXRoOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IGNyZWF0ZVF1ZXJ5QnVpbGRlcihbXSkpLFxuICBcbiAgLy8gUmF3IFNRTCBzdXBwb3J0XG4gIGV4ZWN1dGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gKHsgcm93czogW10gfSkpLFxuICBcbiAgLy8gQ29ubmVjdGlvbiBtYW5hZ2VtZW50IChmb3IgaW50ZWdyYXRpb24gdGVzdHMpXG4gIGVuZDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHZvaWQgMCksXG4gIGNvbm5lY3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh2b2lkIDApXG59O1xuXG4vLyBNb2NrIHNjaGVtYSB0YWJsZXMgZm9yIHR5cGUgc2FmZXR5XG5jb25zdCBjcmVhdGVNb2NrVGFibGUgPSAodGFibGVOYW1lOiBzdHJpbmcpID0+ICh7XG4gIF86IHtcbiAgICBuYW1lOiB0YWJsZU5hbWUsXG4gICAgc2NoZW1hOiB1bmRlZmluZWQsXG4gICAgY29sdW1uczoge30sXG4gICAgYmFzZU5hbWU6IHRhYmxlTmFtZVxuICB9LFxuICAvLyBDb21tb24gY29sdW1uIG1vY2tzXG4gIGlkOiB7IG5hbWU6ICdpZCcgfSxcbiAgZW1haWw6IHsgbmFtZTogJ2VtYWlsJyB9LFxuICBuYW1lOiB7IG5hbWU6ICduYW1lJyB9LFxuICByb2xlOiB7IG5hbWU6ICdyb2xlJyB9LFxuICB1c2VySWQ6IHsgbmFtZTogJ3VzZXJJZCcgfSxcbiAgb3JnYW5pemF0aW9uSWQ6IHsgbmFtZTogJ29yZ2FuaXphdGlvbklkJyB9LFxuICBidWlsZGluZ0lkOiB7IG5hbWU6ICdidWlsZGluZ0lkJyB9LFxuICByZXNpZGVuY2VJZDogeyBuYW1lOiAncmVzaWRlbmNlSWQnIH0sXG4gIHN0YXR1czogeyBuYW1lOiAnc3RhdHVzJyB9LFxuICBjcmVhdGVkQXQ6IHsgbmFtZTogJ2NyZWF0ZWRBdCcgfSxcbiAgdXBkYXRlZEF0OiB7IG5hbWU6ICd1cGRhdGVkQXQnIH1cbn0pO1xuXG4vLyBFeHBvcnQgbW9jayBzY2hlbWEgZm9yIHRlc3RzIHRvIGltcG9ydFxuZXhwb3J0IGNvbnN0IG1vY2tTY2hlbWEgPSB7XG4gIC8vIENvcmUgdGFibGVzXG4gIHVzZXJzOiBjcmVhdGVNb2NrVGFibGUoJ3VzZXJzJyksXG4gIG9yZ2FuaXphdGlvbnM6IGNyZWF0ZU1vY2tUYWJsZSgnb3JnYW5pemF0aW9ucycpLFxuICB1c2VyT3JnYW5pemF0aW9uczogY3JlYXRlTW9ja1RhYmxlKCd1c2VyT3JnYW5pemF0aW9ucycpLFxuICBpbnZpdGF0aW9uczogY3JlYXRlTW9ja1RhYmxlKCdpbnZpdGF0aW9ucycpLFxuICBwYXNzd29yZFJlc2V0VG9rZW5zOiBjcmVhdGVNb2NrVGFibGUoJ3Bhc3N3b3JkUmVzZXRUb2tlbnMnKSxcbiAgXG4gIC8vIFByb3BlcnR5IHRhYmxlcyAgXG4gIGJ1aWxkaW5nczogY3JlYXRlTW9ja1RhYmxlKCdidWlsZGluZ3MnKSxcbiAgcmVzaWRlbmNlczogY3JlYXRlTW9ja1RhYmxlKCdyZXNpZGVuY2VzJyksXG4gIHVzZXJSZXNpZGVuY2VzOiBjcmVhdGVNb2NrVGFibGUoJ3VzZXJSZXNpZGVuY2VzJyksXG4gIFxuICAvLyBEb2N1bWVudCB0YWJsZXNcbiAgZG9jdW1lbnRzOiBjcmVhdGVNb2NrVGFibGUoJ2RvY3VtZW50cycpLFxuICBcbiAgLy8gRmluYW5jaWFsIHRhYmxlc1xuICBiaWxsczogY3JlYXRlTW9ja1RhYmxlKCdiaWxscycpLFxuICBidWRnZXRzOiBjcmVhdGVNb2NrVGFibGUoJ2J1ZGdldHMnKSxcbiAgbW9udGhseUJ1ZGdldHM6IGNyZWF0ZU1vY2tUYWJsZSgnbW9udGhseUJ1ZGdldHMnKSxcbiAgXG4gIC8vIE9wZXJhdGlvbnMgdGFibGVzXG4gIG1haW50ZW5hbmNlUmVxdWVzdHM6IGNyZWF0ZU1vY2tUYWJsZSgnbWFpbnRlbmFuY2VSZXF1ZXN0cycpLFxuICBjb21tb25TcGFjZXM6IGNyZWF0ZU1vY2tUYWJsZSgnY29tbW9uU3BhY2VzJyksXG4gIFxuICAvLyBTeXN0ZW0gdGFibGVzXG4gIHBlcm1pc3Npb25zOiBjcmVhdGVNb2NrVGFibGUoJ3Blcm1pc3Npb25zJyksXG4gIHVzZXJQZXJtaXNzaW9uczogY3JlYXRlTW9ja1RhYmxlKCd1c2VyUGVybWlzc2lvbnMnKSxcbiAgcm9sZVBlcm1pc3Npb25zOiBjcmVhdGVNb2NrVGFibGUoJ3JvbGVQZXJtaXNzaW9ucycpLFxuICBkZW1hbmRzOiBjcmVhdGVNb2NrVGFibGUoJ2RlbWFuZHMnKVxufTtcblxuLy8gRXhwb3J0IHRlc3QgdXRpbGl0aWVzXG5leHBvcnQgY29uc3QgdGVzdFV0aWxzID0ge1xuICBjbGVhck1vY2tEYXRhLFxuICBnZW5lcmF0ZU1vY2tJZCxcbiAgZ2V0TW9ja0RhdGE6ICgpID0+IG1vY2tEYXRhU3RvcmUsXG4gIHJlc2V0TW9ja3M6ICgpID0+IHtcbiAgICBjbGVhck1vY2tEYXRhKCk7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH1cbn07XG5cbi8vIERlZmF1bHQgZXhwb3J0IGZvciBjb252ZW5pZW5jZVxuZXhwb3J0IGRlZmF1bHQgbW9ja0RiOyJdLCJ2ZXJzaW9uIjozfQ==