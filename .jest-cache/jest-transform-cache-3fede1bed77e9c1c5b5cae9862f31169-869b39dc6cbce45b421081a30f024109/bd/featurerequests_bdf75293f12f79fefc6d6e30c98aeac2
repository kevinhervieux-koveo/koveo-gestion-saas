6d609f0a7fbaf1f6cd7208b1a319dfe2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerFeatureRequestRoutes = registerFeatureRequestRoutes;
const storage_1 = require("../storage");
const schema_1 = require("@shared/schema");
const zod_1 = require("zod");
const auth_1 = require("../auth");
/**
 * Registers all feature request related API endpoints.
 *
 * @param app - Express application instance.
 */
function registerFeatureRequestRoutes(app) {
    /**
     * GET /api/feature-requests - Retrieves feature requests based on current user's role and access.
     */
    app.get('/api/feature-requests', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            console.log(`📋 Fetching feature requests for user ${currentUser.id} with role ${currentUser.role}`);
            const featureRequests = await storage_1.storage.getFeatureRequestsForUser(currentUser.id, currentUser.role, currentUser.organizationId);
            console.log(`✅ Found ${featureRequests.length} feature requests for user ${currentUser.id}`);
            res.json(featureRequests);
        }
        catch (error) {
            console.error('❌ Error fetching feature requests:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch feature requests',
            });
        }
    });
    /**
     * GET /api/feature-requests/:id - Retrieves a specific feature request by ID.
     */
    app.get('/api/feature-requests/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const featureRequest = await storage_1.storage.getFeatureRequest(id, currentUser.id, currentUser.role, currentUser.organizationId);
            if (!featureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            res.json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error fetching feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to fetch feature request',
            });
        }
    });
    /**
     * POST /api/feature-requests - Creates a new feature request.
     */
    app.post('/api/feature-requests', auth_1.requireAuth, async (req, res) => {
        try {
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Validate the request body
            const validation = schema_1.insertFeatureRequestSchema.safeParse({
                ...req.body,
                createdBy: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid feature request data',
                    details: validation.error.issues,
                });
            }
            const featureRequestData = validation.data;
            const featureRequest = await storage_1.storage.createFeatureRequest(featureRequestData);
            console.log(`💡 Created new feature request ${featureRequest.id} by user ${currentUser.id}`);
            res.status(201).json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error creating feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to create feature request',
            });
        }
    });
    /**
     * PATCH /api/feature-requests/:id - Updates an existing feature request.
     * Only admins can edit feature requests.
     */
    app.patch('/api/feature-requests/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Only admins can edit feature requests
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    error: 'Forbidden',
                    message: 'Only administrators can edit feature requests',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            // Validate the request body
            const updateSchema = zod_1.z.object({
                title: zod_1.z
                    .string()
                    .min(1, 'Title is required')
                    .max(200, 'Title must not exceed 200 characters')
                    .optional(),
                description: zod_1.z
                    .string()
                    .min(10, 'Description must be at least 10 characters')
                    .max(2000, 'Description must not exceed 2000 characters')
                    .optional(),
                need: zod_1.z
                    .string()
                    .min(5, 'Need must be at least 5 characters')
                    .max(500, 'Need must not exceed 500 characters')
                    .optional(),
                category: zod_1.z
                    .enum([
                    'dashboard',
                    'property_management',
                    'resident_management',
                    'financial_management',
                    'maintenance',
                    'document_management',
                    'communication',
                    'reports',
                    'mobile_app',
                    'integrations',
                    'security',
                    'performance',
                    'other',
                ])
                    .optional(),
                page: zod_1.z.string().min(1, 'Page is required').optional(),
                status: zod_1.z
                    .enum(['submitted', 'under_review', 'planned', 'in_progress', 'completed', 'rejected'])
                    .optional(),
                assignedTo: zod_1.z.string().uuid().nullable().optional(),
                adminNotes: zod_1.z.string().optional(),
                mergedIntoId: zod_1.z.string().uuid().nullable().optional(),
            });
            const validation = updateSchema.safeParse(req.body);
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid update data',
                    details: validation.error.issues,
                });
            }
            const updates = validation.data;
            const featureRequest = await storage_1.storage.updateFeatureRequest(id, updates, currentUser.id, currentUser.role);
            if (!featureRequest) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            console.log(`📝 Updated feature request ${id} by user ${currentUser.id}`);
            res.json(featureRequest);
        }
        catch (error) {
            console.error('❌ Error updating feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to update feature request',
            });
        }
    });
    /**
     * DELETE /api/feature-requests/:id - Deletes a feature request.
     * Only admins can delete feature requests.
     */
    app.delete('/api/feature-requests/:id', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            // Only admins can delete feature requests
            if (currentUser.role !== 'admin') {
                return res.status(403).json({
                    error: 'Forbidden',
                    message: 'Only administrators can delete feature requests',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const deleted = await storage_1.storage.deleteFeatureRequest(id, currentUser.id, currentUser.role);
            if (!deleted) {
                return res.status(404).json({
                    error: 'Not found',
                    message: 'Feature request not found or access denied',
                });
            }
            console.log(`🗑️ Deleted feature request ${id} by user ${currentUser.id}`);
            res.status(204).send();
        }
        catch (error) {
            console.error('❌ Error deleting feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to delete feature request',
            });
        }
    });
    /**
     * POST /api/feature-requests/:id/upvote - Upvotes a feature request.
     * Users can upvote any feature request (only once per user).
     */
    app.post('/api/feature-requests/:id/upvote', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            // Validate the upvote data
            const validation = schema_1.insertFeatureRequestUpvoteSchema.safeParse({
                featureRequestId: id,
                userId: currentUser.id,
            });
            if (!validation.success) {
                return res.status(400).json({
                    error: 'Validation failed',
                    message: 'Invalid upvote data',
                    details: validation.error.issues,
                });
            }
            const upvoteData = validation.data;
            const result = await storage_1.storage.upvoteFeatureRequest(upvoteData);
            if (!result.success) {
                return res.status(400).json({
                    error: 'Upvote failed',
                    message: result.message,
                });
            }
            console.log(`👍 User ${currentUser.id} upvoted feature request ${id}`);
            res.json(result.data);
        }
        catch (error) {
            console.error('❌ Error upvoting feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to upvote feature request',
            });
        }
    });
    /**
     * DELETE /api/feature-requests/:id/upvote - Removes an upvote from a feature request.
     * Users can remove their own upvote.
     */
    app.delete('/api/feature-requests/:id/upvote', auth_1.requireAuth, async (req, res) => {
        try {
            const { id } = req.params;
            const currentUser = req.user || req.session?.user;
            if (!currentUser) {
                return res.status(401).json({
                    message: 'Authentication required',
                    code: 'AUTH_REQUIRED',
                });
            }
            if (!id) {
                return res.status(400).json({
                    error: 'Bad request',
                    message: 'Feature request ID is required',
                });
            }
            const result = await storage_1.storage.removeFeatureRequestUpvote(id, currentUser.id);
            if (!result.success) {
                return res.status(400).json({
                    error: 'Remove upvote failed',
                    message: result.message,
                });
            }
            console.log(`👎 User ${currentUser.id} removed upvote from feature request ${id}`);
            res.json(result.data);
        }
        catch (error) {
            console.error('❌ Error removing upvote from feature request:', error);
            res.status(500).json({
                error: 'Internal server error',
                message: 'Failed to remove upvote from feature request',
            });
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXBpL2ZlYXR1cmUtcmVxdWVzdHMudHMiLCJtYXBwaW5ncyI6Ijs7QUFrQkEsb0VBOFhDO0FBL1lELHdDQUFxQztBQUNyQywyQ0FPd0I7QUFDeEIsNkJBQXdCO0FBQ3hCLGtDQUFzQztBQUV0Qzs7OztHQUlHO0FBQ0gsU0FBZ0IsNEJBQTRCLENBQUMsR0FBWTtJQUN2RDs7T0FFRztJQUNILEdBQUcsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsa0JBQVcsRUFBRSxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ3BFLElBQUksQ0FBQztZQUNILE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNqQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUMxQixPQUFPLEVBQUUseUJBQXlCO29CQUNsQyxJQUFJLEVBQUUsZUFBZTtpQkFDdEIsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQ1QseUNBQXlDLFdBQVcsQ0FBQyxFQUFFLGNBQWMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUN4RixDQUFDO1lBRUYsTUFBTSxlQUFlLEdBQUcsTUFBTSxpQkFBTyxDQUFDLHlCQUF5QixDQUM3RCxXQUFXLENBQUMsRUFBRSxFQUNkLFdBQVcsQ0FBQyxJQUFJLEVBQ2hCLFdBQVcsQ0FBQyxjQUFjLENBQzNCLENBQUM7WUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsZUFBZSxDQUFDLE1BQU0sOEJBQThCLFdBQVcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzdGLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDNUIsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFD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LFdBQVcsV0FBVyxDQUFDLEVBQUUsd0NBQXdDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDbkYsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQywrQ0FBK0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN0RSxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsS0FBSyxFQUFFLHVCQUF1QjtnQkFDOUIsT0FBTyxFQUFFLDhDQUE4QzthQUN4RCxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2FwaS9mZWF0dXJlLXJlcXVlc3RzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgRXhwcmVzcyB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgc3RvcmFnZSB9IGZyb20gJy4uL3N0b3JhZ2UnO1xuaW1wb3J0IHtcbiAgaW5zZXJ0RmVhdHVyZVJlcXVlc3RTY2hlbWEsXG4gIGluc2VydEZlYXR1cmVSZXF1ZXN0VXB2b3RlU2NoZW1hLFxuICB0eXBlIEZlYXR1cmVSZXF1ZXN0LFxuICB0eXBlIEluc2VydEZlYXR1cmVSZXF1ZXN0LFxuICB0eXBlIEZlYXR1cmVSZXF1ZXN0VXB2b3RlLFxuICB0eXBlIEluc2VydEZlYXR1cmVSZXF1ZXN0VXB2b3RlLFxufSBmcm9tICdAc2hhcmVkL3NjaGVtYSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcbmltcG9ydCB7IHJlcXVpcmVBdXRoIH0gZnJvbSAnLi4vYXV0aCc7XG5cbi8qKlxuICogUmVnaXN0ZXJzIGFsbCBmZWF0dXJlIHJlcXVlc3QgcmVsYXRlZCBBUEkgZW5kcG9pbnRzLlxuICpcbiAqIEBwYXJhbSBhcHAgLSBFeHByZXNzIGFwcGxpY2F0aW9uIGluc3RhbmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJGZWF0dXJlUmVxdWVzdFJvdXRlcyhhcHA6IEV4cHJlc3MpOiB2b2lkIHtcbiAgLyoqXG4gICAqIEdFVCAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMgLSBSZXRyaWV2ZXMgZmVhdHVyZSByZXF1ZXN0cyBiYXNlZCBvbiBjdXJyZW50IHVzZXIncyByb2xlIGFuZCBhY2Nlc3MuXG4gICAqL1xuICBhcHAuZ2V0KCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg8J+TiyBGZXRjaGluZyBmZWF0dXJlIHJlcXVlc3RzIGZvciB1c2VyICR7Y3VycmVudFVzZXIuaWR9IHdpdGggcm9sZSAke2N1cnJlbnRVc2VyLnJvbGV9YFxuICAgICAgKTtcblxuICAgICAgY29uc3QgZmVhdHVyZVJlcXVlc3RzID0gYXdhaXQgc3RvcmFnZS5nZXRGZWF0dXJlUmVxdWVzdHNGb3JVc2VyKFxuICAgICAgICBjdXJyZW50VXNlci5pZCxcbiAgICAgICAgY3VycmVudFVzZXIucm9sZSxcbiAgICAgICAgY3VycmVudFVzZXIub3JnYW5pemF0aW9uSWRcbiAgICAgICk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGDinIUgRm91bmQgJHtmZWF0dXJlUmVxdWVzdHMubGVuZ3RofSBmZWF0dXJlIHJlcXVlc3RzIGZvciB1c2VyICR7Y3VycmVudFVzZXIuaWR9YCk7XG4gICAgICByZXMuanNvbihmZWF0dXJlUmVxdWVzdHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBmZXRjaGluZyBmZWF0dXJlIHJlcXVlc3RzOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGZldGNoIGZlYXR1cmUgcmVxdWVzdHMnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogR0VUIC9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQgLSBSZXRyaWV2ZXMgYSBzcGVjaWZpYyBmZWF0dXJlIHJlcXVlc3QgYnkgSUQuXG4gICAqL1xuICBhcHAuZ2V0KCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkJywgcmVxdWlyZUF1dGgsIGFzeW5jIChyZXE6IGFueSwgcmVzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBjdXJyZW50VXNlciA9IHJlcS51c2VyIHx8IHJlcS5zZXNzaW9uPy51c2VyO1xuXG4gICAgICBpZiAoIWN1cnJlbnRVc2VyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlkKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdCYWQgcmVxdWVzdCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBJRCBpcyByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmZWF0dXJlUmVxdWVzdCA9IGF3YWl0IHN0b3JhZ2UuZ2V0RmVhdHVyZVJlcXVlc3QoXG4gICAgICAgIGlkLFxuICAgICAgICBjdXJyZW50VXNlci5pZCxcbiAgICAgICAgY3VycmVudFVzZXIucm9sZSxcbiAgICAgICAgY3VycmVudFVzZXIub3JnYW5pemF0aW9uSWRcbiAgICAgICk7XG5cbiAgICAgIGlmICghZmVhdHVyZVJlcXVlc3QpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ05vdCBmb3VuZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ZlYXR1cmUgcmVxdWVzdCBub3QgZm91bmQgb3IgYWNjZXNzIGRlbmllZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbihmZWF0dXJlUmVxdWVzdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBmZWF0dXJlIHJlcXVlc3QnLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogUE9TVCAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMgLSBDcmVhdGVzIGEgbmV3IGZlYXR1cmUgcmVxdWVzdC5cbiAgICovXG4gIGFwcC5wb3N0KCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIHRoZSByZXF1ZXN0IGJvZHlcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBpbnNlcnRGZWF0dXJlUmVxdWVzdFNjaGVtYS5zYWZlUGFyc2Uoe1xuICAgICAgICAuLi5yZXEuYm9keSxcbiAgICAgICAgY3JlYXRlZEJ5OiBjdXJyZW50VXNlci5pZCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXZhbGlkYXRpb24uc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnVmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIGZlYXR1cmUgcmVxdWVzdCBkYXRhJyxcbiAgICAgICAgICBkZXRhaWxzOiB2YWxpZGF0aW9uLmVycm9yLmlzc3VlcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZlYXR1cmVSZXF1ZXN0RGF0YSA9IHZhbGlkYXRpb24uZGF0YTtcbiAgICAgIGNvbnN0IGZlYXR1cmVSZXF1ZXN0ID0gYXdhaXQgc3RvcmFnZS5jcmVhdGVGZWF0dXJlUmVxdWVzdChmZWF0dXJlUmVxdWVzdERhdGEpO1xuXG4gICAgICBjb25zb2xlLmxvZyhg8J+SoSBDcmVhdGVkIG5ldyBmZWF0dXJlIHJlcXVlc3QgJHtmZWF0dXJlUmVxdWVzdC5pZH0gYnkgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oZmVhdHVyZVJlcXVlc3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciBjcmVhdGluZyBmZWF0dXJlIHJlcXVlc3Q6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gY3JlYXRlIGZlYXR1cmUgcmVxdWVzdCcsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBQQVRDSCAvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkIC0gVXBkYXRlcyBhbiBleGlzdGluZyBmZWF0dXJlIHJlcXVlc3QuXG4gICAqIE9ubHkgYWRtaW5zIGNhbiBlZGl0IGZlYXR1cmUgcmVxdWVzdHMuXG4gICAqL1xuICBhcHAucGF0Y2goJy9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE9ubHkgYWRtaW5zIGNhbiBlZGl0IGZlYXR1cmUgcmVxdWVzdHNcbiAgICAgIGlmIChjdXJyZW50VXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdGb3JiaWRkZW4nLFxuICAgICAgICAgIG1lc3NhZ2U6ICdPbmx5IGFkbWluaXN0cmF0b3JzIGNhbiBlZGl0IGZlYXR1cmUgcmVxdWVzdHMnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHJlcXVlc3QgYm9keVxuICAgICAgY29uc3QgdXBkYXRlU2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgICB0aXRsZTogelxuICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgIC5taW4oMSwgJ1RpdGxlIGlzIHJlcXVpcmVkJylcbiAgICAgICAgICAubWF4KDIwMCwgJ1RpdGxlIG11c3Qgbm90IGV4Y2VlZCAyMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIGRlc2NyaXB0aW9uOiB6XG4gICAgICAgICAgLnN0cmluZygpXG4gICAgICAgICAgLm1pbigxMCwgJ0Rlc2NyaXB0aW9uIG11c3QgYmUgYXQgbGVhc3QgMTAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm1heCgyMDAwLCAnRGVzY3JpcHRpb24gbXVzdCBub3QgZXhjZWVkIDIwMDAgY2hhcmFjdGVycycpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIG5lZWQ6IHpcbiAgICAgICAgICAuc3RyaW5nKClcbiAgICAgICAgICAubWluKDUsICdOZWVkIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFyYWN0ZXJzJylcbiAgICAgICAgICAubWF4KDUwMCwgJ05lZWQgbXVzdCBub3QgZXhjZWVkIDUwMCBjaGFyYWN0ZXJzJylcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgY2F0ZWdvcnk6IHpcbiAgICAgICAgICAuZW51bShbXG4gICAgICAgICAgICAnZGFzaGJvYXJkJyxcbiAgICAgICAgICAgICdwcm9wZXJ0eV9tYW5hZ2VtZW50JyxcbiAgICAgICAgICAgICdyZXNpZGVudF9tYW5hZ2VtZW50JyxcbiAgICAgICAgICAgICdmaW5hbmNpYWxfbWFuYWdlbWVudCcsXG4gICAgICAgICAgICAnbWFpbnRlbmFuY2UnLFxuICAgICAgICAgICAgJ2RvY3VtZW50X21hbmFnZW1lbnQnLFxuICAgICAgICAgICAgJ2NvbW11bmljYXRpb24nLFxuICAgICAgICAgICAgJ3JlcG9ydHMnLFxuICAgICAgICAgICAgJ21vYmlsZV9hcHAnLFxuICAgICAgICAgICAgJ2ludGVncmF0aW9ucycsXG4gICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgJ3BlcmZvcm1hbmNlJyxcbiAgICAgICAgICAgICdvdGhlcicsXG4gICAgICAgICAgXSlcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgcGFnZTogei5zdHJpbmcoKS5taW4oMSwgJ1BhZ2UgaXMgcmVxdWlyZWQnKS5vcHRpb25hbCgpLFxuICAgICAgICBzdGF0dXM6IHpcbiAgICAgICAgICAuZW51bShbJ3N1Ym1pdHRlZCcsICd1bmRlcl9yZXZpZXcnLCAncGxhbm5lZCcsICdpbl9wcm9ncmVzcycsICdjb21wbGV0ZWQnLCAncmVqZWN0ZWQnXSlcbiAgICAgICAgICAub3B0aW9uYWwoKSxcbiAgICAgICAgYXNzaWduZWRUbzogei5zdHJpbmcoKS51dWlkKCkubnVsbGFibGUoKS5vcHRpb25hbCgpLFxuICAgICAgICBhZG1pbk5vdGVzOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICAgIG1lcmdlZEludG9JZDogei5zdHJpbmcoKS51dWlkKCkubnVsbGFibGUoKS5vcHRpb25hbCgpLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB1cGRhdGVTY2hlbWEuc2FmZVBhcnNlKHJlcS5ib2R5KTtcbiAgICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgdXBkYXRlIGRhdGEnLFxuICAgICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3IuaXNzdWVzLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXBkYXRlcyA9IHZhbGlkYXRpb24uZGF0YTtcbiAgICAgIGNvbnN0IGZlYXR1cmVSZXF1ZXN0ID0gYXdhaXQgc3RvcmFnZS51cGRhdGVGZWF0dXJlUmVxdWVzdChcbiAgICAgICAgaWQsXG4gICAgICAgIHVwZGF0ZXMsXG4gICAgICAgIGN1cnJlbnRVc2VyLmlkLFxuICAgICAgICBjdXJyZW50VXNlci5yb2xlXG4gICAgICApO1xuXG4gICAgICBpZiAoIWZlYXR1cmVSZXF1ZXN0KSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3Qgbm90IGZvdW5kIG9yIGFjY2VzcyBkZW5pZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfk50gVXBkYXRlZCBmZWF0dXJlIHJlcXVlc3QgJHtpZH0gYnkgdXNlciAke2N1cnJlbnRVc2VyLmlkfWApO1xuICAgICAgcmVzLmpzb24oZmVhdHVyZVJlcXVlc3QpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyBmZWF0dXJlIHJlcXVlc3Q6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gdXBkYXRlIGZlYXR1cmUgcmVxdWVzdCcsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBERUxFVEUgL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZCAtIERlbGV0ZXMgYSBmZWF0dXJlIHJlcXVlc3QuXG4gICAqIE9ubHkgYWRtaW5zIGNhbiBkZWxldGUgZmVhdHVyZSByZXF1ZXN0cy5cbiAgICovXG4gIGFwcC5kZWxldGUoJy9hcGkvZmVhdHVyZS1yZXF1ZXN0cy86aWQnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIE9ubHkgYWRtaW5zIGNhbiBkZWxldGUgZmVhdHVyZSByZXF1ZXN0c1xuICAgICAgaWYgKGN1cnJlbnRVc2VyLnJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0ZvcmJpZGRlbicsXG4gICAgICAgICAgbWVzc2FnZTogJ09ubHkgYWRtaW5pc3RyYXRvcnMgY2FuIGRlbGV0ZSBmZWF0dXJlIHJlcXVlc3RzJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0JhZCByZXF1ZXN0JyxcbiAgICAgICAgICBtZXNzYWdlOiAnRmVhdHVyZSByZXF1ZXN0IElEIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGRlbGV0ZWQgPSBhd2FpdCBzdG9yYWdlLmRlbGV0ZUZlYXR1cmVSZXF1ZXN0KGlkLCBjdXJyZW50VXNlci5pZCwgY3VycmVudFVzZXIucm9sZSk7XG5cbiAgICAgIGlmICghZGVsZXRlZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgICAgICBtZXNzYWdlOiAnRmVhdHVyZSByZXF1ZXN0IG5vdCBmb3VuZCBvciBhY2Nlc3MgZGVuaWVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGDwn5eR77iPIERlbGV0ZWQgZmVhdHVyZSByZXF1ZXN0ICR7aWR9IGJ5IHVzZXIgJHtjdXJyZW50VXNlci5pZH1gKTtcbiAgICAgIHJlcy5zdGF0dXMoMjA0KS5zZW5kKCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGRlbGV0aW5nIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBkZWxldGUgZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBPU1QgL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZC91cHZvdGUgLSBVcHZvdGVzIGEgZmVhdHVyZSByZXF1ZXN0LlxuICAgKiBVc2VycyBjYW4gdXB2b3RlIGFueSBmZWF0dXJlIHJlcXVlc3QgKG9ubHkgb25jZSBwZXIgdXNlcikuXG4gICAqL1xuICBhcHAucG9zdCgnL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZC91cHZvdGUnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogYW55LCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gcmVxLnVzZXIgfHwgcmVxLnNlc3Npb24/LnVzZXI7XG5cbiAgICAgIGlmICghY3VycmVudFVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gcmVxdWlyZWQnLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICghaWQpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ0JhZCByZXF1ZXN0JyxcbiAgICAgICAgICBtZXNzYWdlOiAnRmVhdHVyZSByZXF1ZXN0IElEIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIHRoZSB1cHZvdGUgZGF0YVxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGluc2VydEZlYXR1cmVSZXF1ZXN0VXB2b3RlU2NoZW1hLnNhZmVQYXJzZSh7XG4gICAgICAgIGZlYXR1cmVSZXF1ZXN0SWQ6IGlkLFxuICAgICAgICB1c2VySWQ6IGN1cnJlbnRVc2VyLmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdmFsaWRhdGlvbi5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgdXB2b3RlIGRhdGEnLFxuICAgICAgICAgIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3IuaXNzdWVzLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXB2b3RlRGF0YSA9IHZhbGlkYXRpb24uZGF0YTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0b3JhZ2UudXB2b3RlRmVhdHVyZVJlcXVlc3QodXB2b3RlRGF0YSk7XG5cbiAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ1Vwdm90ZSBmYWlsZWQnLFxuICAgICAgICAgIG1lc3NhZ2U6IHJlc3VsdC5tZXNzYWdlLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coYPCfkY0gVXNlciAke2N1cnJlbnRVc2VyLmlkfSB1cHZvdGVkIGZlYXR1cmUgcmVxdWVzdCAke2lkfWApO1xuICAgICAgcmVzLmpzb24ocmVzdWx0LmRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBFcnJvciB1cHZvdGluZyBmZWF0dXJlIHJlcXVlc3Q6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gdXB2b3RlIGZlYXR1cmUgcmVxdWVzdCcsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBERUxFVEUgL2FwaS9mZWF0dXJlLXJlcXVlc3RzLzppZC91cHZvdGUgLSBSZW1vdmVzIGFuIHVwdm90ZSBmcm9tIGEgZmVhdHVyZSByZXF1ZXN0LlxuICAgKiBVc2VycyBjYW4gcmVtb3ZlIHRoZWlyIG93biB1cHZvdGUuXG4gICAqL1xuICBhcHAuZGVsZXRlKCcvYXBpL2ZlYXR1cmUtcmVxdWVzdHMvOmlkL3Vwdm90ZScsIHJlcXVpcmVBdXRoLCBhc3luYyAocmVxOiBhbnksIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgY29uc3QgY3VycmVudFVzZXIgPSByZXEudXNlciB8fCByZXEuc2Vzc2lvbj8udXNlcjtcblxuICAgICAgaWYgKCFjdXJyZW50VXNlcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcsXG4gICAgICAgICAgY29kZTogJ0FVVEhfUkVRVUlSRUQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnQmFkIHJlcXVlc3QnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGZWF0dXJlIHJlcXVlc3QgSUQgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3RvcmFnZS5yZW1vdmVGZWF0dXJlUmVxdWVzdFVwdm90ZShpZCwgY3VycmVudFVzZXIuaWQpO1xuXG4gICAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdSZW1vdmUgdXB2b3RlIGZhaWxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogcmVzdWx0Lm1lc3NhZ2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyhg8J+RjiBVc2VyICR7Y3VycmVudFVzZXIuaWR9IHJlbW92ZWQgdXB2b3RlIGZyb20gZmVhdHVyZSByZXF1ZXN0ICR7aWR9YCk7XG4gICAgICByZXMuanNvbihyZXN1bHQuZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIHJlbW92aW5nIHVwdm90ZSBmcm9tIGZlYXR1cmUgcmVxdWVzdDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byByZW1vdmUgdXB2b3RlIGZyb20gZmVhdHVyZSByZXF1ZXN0JyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG4iXSwidmVyc2lvbiI6M30=