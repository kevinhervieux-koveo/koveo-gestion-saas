723869a5b3c2c2bacd2eb388741ddd81
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerDemoManagementRoutes = registerDemoManagementRoutes;
const demo_management_service_1 = __importDefault(require("../services/demo-management-service"));
const auth_1 = require("../auth");
/**
 * Demo Management API Routes.
 *
 * Provides API endpoints for managing demo organizations in production.
 * These endpoints allow for health checks, initialization, and maintenance.
 */
/**
 * Register demo management routes.
 * @param app
 */
function registerDemoManagementRoutes(app) {
    /**
     * GET /api/demo/health
     * Check the health status of demo organizations.
     * Public endpoint for monitoring.
     */
    app.get('/api/demo/health', async (req, res) => {
        try {
            const health = await demo_management_service_1.default.checkDemoHealth();
            res.status(health.healthy ? 200 : 503).json({
                success: true,
                data: health,
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                message: 'Demo health check failed',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    /**
     * GET /api/demo/users
     * Get demo users for login page.
     * Public endpoint for demo mode.
     */
    app.get('/api/demo/users', async (req, res) => {
        try {
            // Import database connection
            const { db } = await Promise.resolve().then(() => __importStar(require('../db')));
            const { eq, and, inArray } = await Promise.resolve().then(() => __importStar(require('drizzle-orm')));
            const schema = await Promise.resolve().then(() => __importStar(require('../../shared/schema')));
            // Get demo organizations (by type instead of name)
            const demoOrgs = await db.query.organizations.findMany({
                where: eq(schema.organizations.type, 'demo'),
            });
            if (demoOrgs.length === 0) {
                return res.status(404).json({
                    success: false,
                    message: 'No demo organizations found',
                });
            }
            // Get demo users with demo roles
            const demoUsers = await db.query.users.findMany({
                where: and(eq(schema.users.isActive, true), inArray(schema.users.role, ['demo_manager', 'demo_tenant', 'demo_resident'])),
                columns: {
                    id: true,
                    email: true,
                    firstName: true,
                    lastName: true,
                    role: true,
                },
            });
            // Group users by role for frontend consumption
            const usersByRole = {
                demo_manager: demoUsers.filter(user => user.role === 'demo_manager'),
                demo_tenant: demoUsers.filter(user => user.role === 'demo_tenant'),
                demo_resident: demoUsers.filter(user => user.role === 'demo_resident'),
            };
            res.json({
                success: true,
                data: usersByRole,
            });
        }
        catch (error) {
            console.error('❌ Error fetching demo users:', error);
            res.status(500).json({
                success: false,
                message: 'Failed to fetch demo users',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    /**
     * GET /api/demo/status
     * Get detailed status and information about demo organizations.
     * Requires authentication.
     */
    app.get('/api/demo/status', auth_1.requireAuth, async (req, res) => {
        try {
            const info = await demo_management_service_1.default.getDemoOrganizationInfo();
            res.json({
                success: true,
                data: info,
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                message: 'Failed to get demo status',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    /**
     * POST /api/demo/ensure
     * Ensure demo organizations exist and are properly configured.
     * Requires admin role.
     */
    app.post('/api/demo/ensure', auth_1.requireAuth, (0, auth_1.requireRole)(['admin']), async (req, res) => {
        try {
            const result = await demo_management_service_1.default.ensureDemoOrganizations();
            res.status(result.success ? 200 : 500).json({
                success: result.success,
                message: result.message,
                data: {
                    demoOrgId: result.demoOrgId,
                    openDemoOrgId: result.openDemoOrgId,
                },
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                message: 'Failed to ensure demo organizations',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    /**
     * POST /api/demo/recreate
     * Force recreation of demo organizations with fresh data.
     * Requires admin role. This is a destructive operation.
     */
    app.post('/api/demo/recreate', auth_1.requireAuth, (0, auth_1.requireRole)(['admin']), async (req, res) => {
        try {
            const result = await demo_management_service_1.default.recreateDemoOrganizations();
            res.status(result.success ? 200 : 500).json({
                success: result.success,
                message: result.message,
                data: {
                    demoOrgId: result.demoOrgId,
                    openDemoOrgId: result.openDemoOrgId,
                },
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                message: 'Failed to recreate demo organizations',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    /**
     * POST /api/demo/maintenance
     * Run scheduled maintenance on demo organizations.
     * Requires admin role.
     */
    app.post('/api/demo/maintenance', auth_1.requireAuth, (0, auth_1.requireRole)(['admin']), async (req, res) => {
        try {
            const result = await demo_management_service_1.default.scheduledMaintenance();
            res.status(result.success ? 200 : 500).json({
                success: result.success,
                message: result.message,
                data: {
                    actions: result.actions,
                },
            });
        }
        catch (error) {
            res.status(500).json({
                success: false,
                message: 'Failed to run demo maintenance',
                error: error instanceof Error ? error.message : 'Unknown error',
            });
        }
    });
    console.log('✅ Demo management API routes registered');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXJ2ZXIvYXBpL2RlbW8tbWFuYWdlbWVudC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWVBLG9FQXNNQztBQXBORCxrR0FBd0U7QUFDeEUsa0NBQW1EO0FBRW5EOzs7OztHQUtHO0FBRUg7OztHQUdHO0FBQ0gsU0FBZ0IsNEJBQTRCLENBQUMsR0FBWTtJQUN2RDs7OztPQUlHO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQ2hFLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0saUNBQXFCLENBQUMsZUFBZSxFQUFFLENBQUM7WUFFN0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUMsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsSUFBSSxFQUFFLE1BQU07YUFDYixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxPQUFPLEVBQUUsMEJBQTBCO2dCQUNuQyxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZTthQUNoRSxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSDs7OztPQUlHO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxFQUFFO1FBQy9ELElBQUksQ0FBQztZQUNILDZCQUE2QjtZQUM3QixNQUFN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QixFQUN2QixrQkFBVyxFQUNYLElBQUEsa0JBQVcsRUFBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQ3RCLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDcEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSxpQ0FBcUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBRWxFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTztnQkFDdkIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO2dCQUN2QixJQUFJLEVBQUU7b0JBQ0osT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO2lCQUN4QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxLQUFLO2dCQUNkLE9BQU8sRUFBRSxnQ0FBZ0M7Z0JBQ3pDLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO2FBQ2hFLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDLENBQ0YsQ0FBQztJQUVGLE9BQU8sQ0FBQyxHQUFHLENBQUMseUNBQXlDLENBQUMsQ0FBQztBQUN6RCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvc2VydmVyL2FwaS9kZW1vLW1hbmFnZW1lbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBFeHByZXNzLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IERlbW9NYW5hZ2VtZW50U2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9kZW1vLW1hbmFnZW1lbnQtc2VydmljZSc7XG5pbXBvcnQgeyByZXF1aXJlQXV0aCwgcmVxdWlyZVJvbGUgfSBmcm9tICcuLi9hdXRoJztcblxuLyoqXG4gKiBEZW1vIE1hbmFnZW1lbnQgQVBJIFJvdXRlcy5cbiAqXG4gKiBQcm92aWRlcyBBUEkgZW5kcG9pbnRzIGZvciBtYW5hZ2luZyBkZW1vIG9yZ2FuaXphdGlvbnMgaW4gcHJvZHVjdGlvbi5cbiAqIFRoZXNlIGVuZHBvaW50cyBhbGxvdyBmb3IgaGVhbHRoIGNoZWNrcywgaW5pdGlhbGl6YXRpb24sIGFuZCBtYWludGVuYW5jZS5cbiAqL1xuXG4vKipcbiAqIFJlZ2lzdGVyIGRlbW8gbWFuYWdlbWVudCByb3V0ZXMuXG4gKiBAcGFyYW0gYXBwXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckRlbW9NYW5hZ2VtZW50Um91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICAvKipcbiAgICogR0VUIC9hcGkvZGVtby9oZWFsdGhcbiAgICogQ2hlY2sgdGhlIGhlYWx0aCBzdGF0dXMgb2YgZGVtbyBvcmdhbml6YXRpb25zLlxuICAgKiBQdWJsaWMgZW5kcG9pbnQgZm9yIG1vbml0b3JpbmcuXG4gICAqL1xuICBhcHAuZ2V0KCcvYXBpL2RlbW8vaGVhbHRoJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBEZW1vTWFuYWdlbWVudFNlcnZpY2UuY2hlY2tEZW1vSGVhbHRoKCk7XG5cbiAgICAgIHJlcy5zdGF0dXMoaGVhbHRoLmhlYWx0aHkgPyAyMDAgOiA1MDMpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBoZWFsdGgsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ0RlbW8gaGVhbHRoIGNoZWNrIGZhaWxlZCcsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEdFVCAvYXBpL2RlbW8vdXNlcnNcbiAgICogR2V0IGRlbW8gdXNlcnMgZm9yIGxvZ2luIHBhZ2UuXG4gICAqIFB1YmxpYyBlbmRwb2ludCBmb3IgZGVtbyBtb2RlLlxuICAgKi9cbiAgYXBwLmdldCgnL2FwaS9kZW1vL3VzZXJzJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBJbXBvcnQgZGF0YWJhc2UgY29ubmVjdGlvblxuICAgICAgY29uc3QgeyBkYiB9ID0gYXdhaXQgaW1wb3J0KCcuLi9kYicpO1xuICAgICAgY29uc3QgeyBlcSwgYW5kLCBpbkFycmF5IH0gPSBhd2FpdCBpbXBvcnQoJ2RyaXp6bGUtb3JtJyk7XG4gICAgICBjb25zdCBzY2hlbWEgPSBhd2FpdCBpbXBvcnQoJy4uLy4uL3NoYXJlZC9zY2hlbWEnKTtcblxuICAgICAgLy8gR2V0IGRlbW8gb3JnYW5pemF0aW9ucyAoYnkgdHlwZSBpbnN0ZWFkIG9mIG5hbWUpXG4gICAgICBjb25zdCBkZW1vT3JncyA9IGF3YWl0IGRiLnF1ZXJ5Lm9yZ2FuaXphdGlvbnMuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogZXEoc2NoZW1hLm9yZ2FuaXphdGlvbnMudHlwZSwgJ2RlbW8nKSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZGVtb09yZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZTogJ05vIGRlbW8gb3JnYW5pemF0aW9ucyBmb3VuZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgZGVtbyB1c2VycyB3aXRoIGRlbW8gcm9sZXNcbiAgICAgIGNvbnN0IGRlbW9Vc2VycyA9IGF3YWl0IGRiLnF1ZXJ5LnVzZXJzLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IGFuZChcbiAgICAgICAgICBlcShzY2hlbWEudXNlcnMuaXNBY3RpdmUsIHRydWUpLFxuICAgICAgICAgIGluQXJyYXkoc2NoZW1hLnVzZXJzLnJvbGUsIFsnZGVtb19tYW5hZ2VyJywgJ2RlbW9fdGVuYW50JywgJ2RlbW9fcmVzaWRlbnQnXSlcbiAgICAgICAgKSxcbiAgICAgICAgY29sdW1uczoge1xuICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICByb2xlOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEdyb3VwIHVzZXJzIGJ5IHJvbGUgZm9yIGZyb250ZW5kIGNvbnN1bXB0aW9uXG4gICAgICBjb25zdCB1c2Vyc0J5Um9sZSA9IHtcbiAgICAgICAgZGVtb19tYW5hZ2VyOiBkZW1vVXNlcnMuZmlsdGVyKHVzZXIgPT4gdXNlci5yb2xlID09PSAnZGVtb19tYW5hZ2VyJyksXG4gICAgICAgIGRlbW9fdGVuYW50OiBkZW1vVXNlcnMuZmlsdGVyKHVzZXIgPT4gdXNlci5yb2xlID09PSAnZGVtb190ZW5hbnQnKSxcbiAgICAgICAgZGVtb19yZXNpZGVudDogZGVtb1VzZXJzLmZpbHRlcih1c2VyID0+IHVzZXIucm9sZSA9PT0gJ2RlbW9fcmVzaWRlbnQnKSxcbiAgICAgIH07XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogdXNlcnNCeVJvbGUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIEVycm9yIGZldGNoaW5nIGRlbW8gdXNlcnM6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBmZXRjaCBkZW1vIHVzZXJzJyxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogR0VUIC9hcGkvZGVtby9zdGF0dXNcbiAgICogR2V0IGRldGFpbGVkIHN0YXR1cyBhbmQgaW5mb3JtYXRpb24gYWJvdXQgZGVtbyBvcmdhbml6YXRpb25zLlxuICAgKiBSZXF1aXJlcyBhdXRoZW50aWNhdGlvbi5cbiAgICovXG4gIGFwcC5nZXQoJy9hcGkvZGVtby9zdGF0dXMnLCByZXF1aXJlQXV0aCwgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbmZvID0gYXdhaXQgRGVtb01hbmFnZW1lbnRTZXJ2aWNlLmdldERlbW9Pcmdhbml6YXRpb25JbmZvKCk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogaW5mbyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGdldCBkZW1vIHN0YXR1cycsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIFBPU1QgL2FwaS9kZW1vL2Vuc3VyZVxuICAgKiBFbnN1cmUgZGVtbyBvcmdhbml6YXRpb25zIGV4aXN0IGFuZCBhcmUgcHJvcGVybHkgY29uZmlndXJlZC5cbiAgICogUmVxdWlyZXMgYWRtaW4gcm9sZS5cbiAgICovXG4gIGFwcC5wb3N0KFxuICAgICcvYXBpL2RlbW8vZW5zdXJlJyxcbiAgICByZXF1aXJlQXV0aCxcbiAgICByZXF1aXJlUm9sZShbJ2FkbWluJ10pLFxuICAgIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERlbW9NYW5hZ2VtZW50U2VydmljZS5lbnN1cmVEZW1vT3JnYW5pemF0aW9ucygpO1xuXG4gICAgICAgIHJlcy5zdGF0dXMocmVzdWx0LnN1Y2Nlc3MgPyAyMDAgOiA1MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzLFxuICAgICAgICAgIG1lc3NhZ2U6IHJlc3VsdC5tZXNzYWdlLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGRlbW9PcmdJZDogcmVzdWx0LmRlbW9PcmdJZCxcbiAgICAgICAgICAgIG9wZW5EZW1vT3JnSWQ6IHJlc3VsdC5vcGVuRGVtb09yZ0lkLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gZW5zdXJlIGRlbW8gb3JnYW5pemF0aW9ucycsXG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgLyoqXG4gICAqIFBPU1QgL2FwaS9kZW1vL3JlY3JlYXRlXG4gICAqIEZvcmNlIHJlY3JlYXRpb24gb2YgZGVtbyBvcmdhbml6YXRpb25zIHdpdGggZnJlc2ggZGF0YS5cbiAgICogUmVxdWlyZXMgYWRtaW4gcm9sZS4gVGhpcyBpcyBhIGRlc3RydWN0aXZlIG9wZXJhdGlvbi5cbiAgICovXG4gIGFwcC5wb3N0KFxuICAgICcvYXBpL2RlbW8vcmVjcmVhdGUnLFxuICAgIHJlcXVpcmVBdXRoLFxuICAgIHJlcXVpcmVSb2xlKFsnYWRtaW4nXSksXG4gICAgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgRGVtb01hbmFnZW1lbnRTZXJ2aWNlLnJlY3JlYXRlRGVtb09yZ2FuaXphdGlvbnMoKTtcblxuICAgICAgICByZXMuc3RhdHVzKHJlc3VsdC5zdWNjZXNzID8gMjAwIDogNTAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiByZXN1bHQuc3VjY2VzcyxcbiAgICAgICAgICBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBkZW1vT3JnSWQ6IHJlc3VsdC5kZW1vT3JnSWQsXG4gICAgICAgICAgICBvcGVuRGVtb09yZ0lkOiByZXN1bHQub3BlbkRlbW9PcmdJZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHJlY3JlYXRlIGRlbW8gb3JnYW5pemF0aW9ucycsXG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbiAgLyoqXG4gICAqIFBPU1QgL2FwaS9kZW1vL21haW50ZW5hbmNlXG4gICAqIFJ1biBzY2hlZHVsZWQgbWFpbnRlbmFuY2Ugb24gZGVtbyBvcmdhbml6YXRpb25zLlxuICAgKiBSZXF1aXJlcyBhZG1pbiByb2xlLlxuICAgKi9cbiAgYXBwLnBvc3QoXG4gICAgJy9hcGkvZGVtby9tYWludGVuYW5jZScsXG4gICAgcmVxdWlyZUF1dGgsXG4gICAgcmVxdWlyZVJvbGUoWydhZG1pbiddKSxcbiAgICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBEZW1vTWFuYWdlbWVudFNlcnZpY2Uuc2NoZWR1bGVkTWFpbnRlbmFuY2UoKTtcblxuICAgICAgICByZXMuc3RhdHVzKHJlc3VsdC5zdWNjZXNzID8gMjAwIDogNTAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiByZXN1bHQuc3VjY2VzcyxcbiAgICAgICAgICBtZXNzYWdlOiByZXN1bHQubWVzc2FnZSxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBhY3Rpb25zOiByZXN1bHQuYWN0aW9ucyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHJ1biBkZW1vIG1haW50ZW5hbmNlJyxcbiAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICBjb25zb2xlLmxvZygn4pyFIERlbW8gbWFuYWdlbWVudCBBUEkgcm91dGVzIHJlZ2lzdGVyZWQnKTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==