306162ad8c79eb2b80b929207b77dcfe
'use strict';
require('../utils/dataTransfer/Clipboard.js');
var level = require('../utils/misc/level.js');
var wait = require('../utils/misc/wait.js');
var parseKeyDef = require('./parseKeyDef.js');
async function pointer(input) {
    const { pointerMap } = this.config;
    const actions = [];
    (Array.isArray(input) ? input : [
        input
    ]).forEach((actionInput) => {
        if (typeof actionInput === 'string') {
            actions.push(...parseKeyDef.parseKeyDef(pointerMap, actionInput));
        }
        else if ('keys' in actionInput) {
            actions.push(...parseKeyDef.parseKeyDef(pointerMap, actionInput.keys).map((i) => ({
                ...actionInput,
                ...i
            })));
        }
        else {
            actions.push(actionInput);
        }
    });
    for (let i = 0; i < actions.length; i++) {
        await wait.wait(this.config);
        await pointerAction(this, actions[i]);
    }
    this.system.pointer.resetClickCount();
}
async function pointerAction(instance, action) {
    var _previousPosition_caret, _previousPosition_caret1;
    const pointerName = 'pointerName' in action && action.pointerName ? action.pointerName : 'keyDef' in action ? instance.system.pointer.getPointerName(action.keyDef) : 'mouse';
    const previousPosition = instance.system.pointer.getPreviousPosition(pointerName);
    var _action_target, _action_coords, _action_node, _action_offset;
    const position = {
        target: (_action_target = action.target) !== null && _action_target !== undefined ? _action_target : getPrevTarget(instance, previousPosition),
        coords: (_action_coords = action.coords) !== null && _action_coords !== undefined ? _action_coords : previousPosition === null || previousPosition === undefined ? undefined : previousPosition.coords,
        caret: {
            node: (_action_node = action.node) !== null && _action_node !== undefined ? _action_node : hasCaretPosition(action) ? undefined : previousPosition === null || previousPosition === undefined ? undefined : (_previousPosition_caret = previousPosition.caret) === null || _previousPosition_caret === undefined ? undefined : _previousPosition_caret.node,
            offset: (_action_offset = action.offset) !== null && _action_offset !== undefined ? _action_offset : hasCaretPosition(action) ? undefined : previousPosition === null || previousPosition === undefined ? undefined : (_previousPosition_caret1 = previousPosition.caret) === null || _previousPosition_caret1 === undefined ? undefined : _previousPosition_caret1.offset
        }
    };
    if ('keyDef' in action) {
        if (instance.system.pointer.isKeyPressed(action.keyDef)) {
            level.setLevelRef(instance, level.ApiLevel.Trigger);
            await instance.system.pointer.release(instance, action.keyDef, position);
        }
        if (!action.releasePrevious) {
            level.setLevelRef(instance, level.ApiLevel.Trigger);
            await instance.system.pointer.press(instance, action.keyDef, position);
            if (action.releaseSelf) {
                level.setLevelRef(instance, level.ApiLevel.Trigger);
                await instance.system.pointer.release(instance, action.keyDef, position);
            }
        }
    }
    else {
        level.setLevelRef(instance, level.ApiLevel.Trigger);
        await instance.system.pointer.move(instance, pointerName, position);
    }
}
function hasCaretPosition(action) {
    var _action_target, _ref;
    return !!((_ref = (_action_target = action.target) !== null && _action_target !== undefined ? _action_target : action.node) !== null && _ref !== undefined ? _ref : action.offset !== undefined);
}
function getPrevTarget(instance, position) {
    if (!position) {
        throw new Error('This pointer has no previous position. Provide a target property!');
    }
    var _position_target;
    return (_position_target = position.target) !== null && _position_target !== undefined ? _position_target : instance.config.document.body;
}
exports.pointer = pointer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3BvaW50ZXIvaW5kZXguanMiLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFDOUMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDOUMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDNUMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFFOUMsS0FBSyxVQUFVLE9BQU8sQ0FBQyxLQUFLO0lBQ3hCLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ25DLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUNuQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDNUIsS0FBSztLQUNSLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUMsRUFBRTtRQUN0QixJQUFJLE9BQU8sV0FBVyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ2xDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7YUFBTSxJQUFJLE1BQU0sSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUMvQixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLENBQUEsQ0FBQztnQkFDeEUsR0FBRyxXQUFXO2dCQUNkLEdBQUcsQ0FBQzthQUNQLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDYixDQUFDO2FBQU0sQ0FBQztZQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUIsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0gsS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUMsQ0FBQztRQUNwQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLE1BQU0sYUFBYSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7QUFDMUMsQ0FBQztBQUNELEtBQUssVUFBVSxhQUFhLENBQUMsUUFBUSxFQUFFLE1BQU07SUFDekMsSUFBSSx1QkFBdUIsRUFBRSx3QkFBd0IsQ0FBQztJQUN0RCxNQUFNLFdBQVcsR0FBRyxhQUFhLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUM5SyxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2xGLElBQUksY0FBYyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsY0FBYyxDQUFDO0lBQ2pFLE1BQU0sUUFBUSxHQUFHO1FBQ2IsTUFBTSxFQUFFLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLElBQUksY0FBYyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLGdCQUFnQixDQUFDO1FBQzlJLE1BQU0sRUFBRSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxJQUFJLGNBQWMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLEtBQUssSUFBSSxJQUFJLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNO1FBQ3RNLEtBQUssRUFBRTtZQUNILElBQUksRUFBRSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLFlBQVksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLEtBQUssSUFBSSxJQUFJLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksSUFBSSx1QkFBdUIsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUMsSUFBSTtZQUMzVixNQUFNLEVBQUUsQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxjQUFjLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixLQUFLLElBQUksSUFBSSxnQkFBZ0IsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyx3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bGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3BvaW50ZXIvaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5yZXF1aXJlKCcuLi91dGlscy9kYXRhVHJhbnNmZXIvQ2xpcGJvYXJkLmpzJyk7XG52YXIgbGV2ZWwgPSByZXF1aXJlKCcuLi91dGlscy9taXNjL2xldmVsLmpzJyk7XG52YXIgd2FpdCA9IHJlcXVpcmUoJy4uL3V0aWxzL21pc2Mvd2FpdC5qcycpO1xudmFyIHBhcnNlS2V5RGVmID0gcmVxdWlyZSgnLi9wYXJzZUtleURlZi5qcycpO1xuXG5hc3luYyBmdW5jdGlvbiBwb2ludGVyKGlucHV0KSB7XG4gICAgY29uc3QgeyBwb2ludGVyTWFwIH0gPSB0aGlzLmNvbmZpZztcbiAgICBjb25zdCBhY3Rpb25zID0gW107XG4gICAgKEFycmF5LmlzQXJyYXkoaW5wdXQpID8gaW5wdXQgOiBbXG4gICAgICAgIGlucHV0XG4gICAgXSkuZm9yRWFjaCgoYWN0aW9uSW5wdXQpPT57XG4gICAgICAgIGlmICh0eXBlb2YgYWN0aW9uSW5wdXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBhY3Rpb25zLnB1c2goLi4ucGFyc2VLZXlEZWYucGFyc2VLZXlEZWYocG9pbnRlck1hcCwgYWN0aW9uSW5wdXQpKTtcbiAgICAgICAgfSBlbHNlIGlmICgna2V5cycgaW4gYWN0aW9uSW5wdXQpIHtcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaCguLi5wYXJzZUtleURlZi5wYXJzZUtleURlZihwb2ludGVyTWFwLCBhY3Rpb25JbnB1dC5rZXlzKS5tYXAoKGkpPT4oe1xuICAgICAgICAgICAgICAgICAgICAuLi5hY3Rpb25JbnB1dCxcbiAgICAgICAgICAgICAgICAgICAgLi4uaVxuICAgICAgICAgICAgICAgIH0pKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb25zLnB1c2goYWN0aW9uSW5wdXQpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZm9yKGxldCBpID0gMDsgaSA8IGFjdGlvbnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBhd2FpdCB3YWl0LndhaXQodGhpcy5jb25maWcpO1xuICAgICAgICBhd2FpdCBwb2ludGVyQWN0aW9uKHRoaXMsIGFjdGlvbnNbaV0pO1xuICAgIH1cbiAgICB0aGlzLnN5c3RlbS5wb2ludGVyLnJlc2V0Q2xpY2tDb3VudCgpO1xufVxuYXN5bmMgZnVuY3Rpb24gcG9pbnRlckFjdGlvbihpbnN0YW5jZSwgYWN0aW9uKSB7XG4gICAgdmFyIF9wcmV2aW91c1Bvc2l0aW9uX2NhcmV0LCBfcHJldmlvdXNQb3NpdGlvbl9jYXJldDE7XG4gICAgY29uc3QgcG9pbnRlck5hbWUgPSAncG9pbnRlck5hbWUnIGluIGFjdGlvbiAmJiBhY3Rpb24ucG9pbnRlck5hbWUgPyBhY3Rpb24ucG9pbnRlck5hbWUgOiAna2V5RGVmJyBpbiBhY3Rpb24gPyBpbnN0YW5jZS5zeXN0ZW0ucG9pbnRlci5nZXRQb2ludGVyTmFtZShhY3Rpb24ua2V5RGVmKSA6ICdtb3VzZSc7XG4gICAgY29uc3QgcHJldmlvdXNQb3NpdGlvbiA9IGluc3RhbmNlLnN5c3RlbS5wb2ludGVyLmdldFByZXZpb3VzUG9zaXRpb24ocG9pbnRlck5hbWUpO1xuICAgIHZhciBfYWN0aW9uX3RhcmdldCwgX2FjdGlvbl9jb29yZHMsIF9hY3Rpb25fbm9kZSwgX2FjdGlvbl9vZmZzZXQ7XG4gICAgY29uc3QgcG9zaXRpb24gPSB7XG4gICAgICAgIHRhcmdldDogKF9hY3Rpb25fdGFyZ2V0ID0gYWN0aW9uLnRhcmdldCkgIT09IG51bGwgJiYgX2FjdGlvbl90YXJnZXQgIT09IHVuZGVmaW5lZCA/IF9hY3Rpb25fdGFyZ2V0IDogZ2V0UHJldlRhcmdldChpbnN0YW5jZSwgcHJldmlvdXNQb3NpdGlvbiksXG4gICAgICAgIGNvb3JkczogKF9hY3Rpb25fY29vcmRzID0gYWN0aW9uLmNvb3JkcykgIT09IG51bGwgJiYgX2FjdGlvbl9jb29yZHMgIT09IHVuZGVmaW5lZCA/IF9hY3Rpb25fY29vcmRzIDogcHJldmlvdXNQb3NpdGlvbiA9PT0gbnVsbCB8fCBwcmV2aW91c1Bvc2l0aW9uID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBwcmV2aW91c1Bvc2l0aW9uLmNvb3JkcyxcbiAgICAgICAgY2FyZXQ6IHtcbiAgICAgICAgICAgIG5vZGU6IChfYWN0aW9uX25vZGUgPSBhY3Rpb24ubm9kZSkgIT09IG51bGwgJiYgX2FjdGlvbl9ub2RlICE9PSB1bmRlZmluZWQgPyBfYWN0aW9uX25vZGUgOiBoYXNDYXJldFBvc2l0aW9uKGFjdGlvbikgPyB1bmRlZmluZWQgOiBwcmV2aW91c1Bvc2l0aW9uID09PSBudWxsIHx8IHByZXZpb3VzUG9zaXRpb24gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IChfcHJldmlvdXNQb3NpdGlvbl9jYXJldCA9IHByZXZpb3VzUG9zaXRpb24uY2FyZXQpID09PSBudWxsIHx8IF9wcmV2aW91c1Bvc2l0aW9uX2NhcmV0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfcHJldmlvdXNQb3NpdGlvbl9jYXJldC5ub2RlLFxuICAgICAgICAgICAgb2Zmc2V0OiAoX2FjdGlvbl9vZmZzZXQgPSBhY3Rpb24ub2Zmc2V0KSAhPT0gbnVsbCAmJiBfYWN0aW9uX29mZnNldCAhPT0gdW5kZWZpbmVkID8gX2FjdGlvbl9vZmZzZXQgOiBoYXNDYXJldFBvc2l0aW9uKGFjdGlvbikgPyB1bmRlZmluZWQgOiBwcmV2aW91c1Bvc2l0aW9uID09PSBudWxsIHx8IHByZXZpb3VzUG9zaXRpb24gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IChfcHJldmlvdXNQb3NpdGlvbl9jYXJldDEgPSBwcmV2aW91c1Bvc2l0aW9uLmNhcmV0KSA9PT0gbnVsbCB8fCBfcHJldmlvdXNQb3NpdGlvbl9jYXJldDEgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IF9wcmV2aW91c1Bvc2l0aW9uX2NhcmV0MS5vZmZzZXRcbiAgICAgICAgfVxuICAgIH07XG4gICAgaWYgKCdrZXlEZWYnIGluIGFjdGlvbikge1xuICAgICAgICBpZiAoaW5zdGFuY2Uuc3lzdGVtLnBvaW50ZXIuaXNLZXlQcmVzc2VkKGFjdGlvbi5rZXlEZWYpKSB7XG4gICAgICAgICAgICBsZXZlbC5zZXRMZXZlbFJlZihpbnN0YW5jZSwgbGV2ZWwuQXBpTGV2ZWwuVHJpZ2dlcik7XG4gICAgICAgICAgICBhd2FpdCBpbnN0YW5jZS5zeXN0ZW0ucG9pbnRlci5yZWxlYXNlKGluc3RhbmNlLCBhY3Rpb24ua2V5RGVmLCBwb3NpdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFhY3Rpb24ucmVsZWFzZVByZXZpb3VzKSB7XG4gICAgICAgICAgICBsZXZlbC5zZXRMZXZlbFJlZihpbnN0YW5jZSwgbGV2ZWwuQXBpTGV2ZWwuVHJpZ2dlcik7XG4gICAgICAgICAgICBhd2FpdCBpbnN0YW5jZS5zeXN0ZW0ucG9pbnRlci5wcmVzcyhpbnN0YW5jZSwgYWN0aW9uLmtleURlZiwgcG9zaXRpb24pO1xuICAgICAgICAgICAgaWYgKGFjdGlvbi5yZWxlYXNlU2VsZikge1xuICAgICAgICAgICAgICAgIGxldmVsLnNldExldmVsUmVmKGluc3RhbmNlLCBsZXZlbC5BcGlMZXZlbC5UcmlnZ2VyKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBpbnN0YW5jZS5zeXN0ZW0ucG9pbnRlci5yZWxlYXNlKGluc3RhbmNlLCBhY3Rpb24ua2V5RGVmLCBwb3NpdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBsZXZlbC5zZXRMZXZlbFJlZihpbnN0YW5jZSwgbGV2ZWwuQXBpTGV2ZWwuVHJpZ2dlcik7XG4gICAgICAgIGF3YWl0IGluc3RhbmNlLnN5c3RlbS5wb2ludGVyLm1vdmUoaW5zdGFuY2UsIHBvaW50ZXJOYW1lLCBwb3NpdGlvbik7XG4gICAgfVxufVxuZnVuY3Rpb24gaGFzQ2FyZXRQb3NpdGlvbihhY3Rpb24pIHtcbiAgICB2YXIgX2FjdGlvbl90YXJnZXQsIF9yZWY7XG4gICAgcmV0dXJuICEhKChfcmVmID0gKF9hY3Rpb25fdGFyZ2V0ID0gYWN0aW9uLnRhcmdldCkgIT09IG51bGwgJiYgX2FjdGlvbl90YXJnZXQgIT09IHVuZGVmaW5lZCA/IF9hY3Rpb25fdGFyZ2V0IDogYWN0aW9uLm5vZGUpICE9PSBudWxsICYmIF9yZWYgIT09IHVuZGVmaW5lZCA/IF9yZWYgOiBhY3Rpb24ub2Zmc2V0ICE9PSB1bmRlZmluZWQpO1xufVxuZnVuY3Rpb24gZ2V0UHJldlRhcmdldChpbnN0YW5jZSwgcG9zaXRpb24pIHtcbiAgICBpZiAoIXBvc2l0aW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVGhpcyBwb2ludGVyIGhhcyBubyBwcmV2aW91cyBwb3NpdGlvbi4gUHJvdmlkZSBhIHRhcmdldCBwcm9wZXJ0eSEnKTtcbiAgICB9XG4gICAgdmFyIF9wb3NpdGlvbl90YXJnZXQ7XG4gICAgcmV0dXJuIChfcG9zaXRpb25fdGFyZ2V0ID0gcG9zaXRpb24udGFyZ2V0KSAhPT0gbnVsbCAmJiBfcG9zaXRpb25fdGFyZ2V0ICE9PSB1bmRlZmluZWQgPyBfcG9zaXRpb25fdGFyZ2V0IDogaW5zdGFuY2UuY29uZmlnLmRvY3VtZW50LmJvZHk7XG59XG5cbmV4cG9ydHMucG9pbnRlciA9IHBvaW50ZXI7XG4iXSwidmVyc2lvbiI6M30=