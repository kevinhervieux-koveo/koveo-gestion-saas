335b7d1b20e09e5bfe2b81ff111b18d2
'use strict';
require('../../event/behavior/click.js');
require('../../event/behavior/cut.js');
require('../../event/behavior/keydown.js');
require('../../event/behavior/keypress.js');
require('../../event/behavior/keyup.js');
require('../../event/behavior/paste.js');
require('@testing-library/dom');
require('../../utils/dataTransfer/Clipboard.js');
var isDisabled = require('../../utils/misc/isDisabled.js');
var getTreeDiff = require('../../utils/misc/getTreeDiff.js');
var focus = require('../../event/focus.js');
var setSelectionPerMouse = require('../../event/selection/setSelectionPerMouse.js');
var modifySelectionPerMouse = require('../../event/selection/modifySelectionPerMouse.js');
var buttons = require('./buttons.js');
var shared = require('./shared.js');
function _define_property(obj, key, value) {
    if (key in obj) {
        Object.defineProperty(obj, key, {
            value: value,
            enumerable: true,
            configurable: true,
            writable: true
        });
    }
    else {
        obj[key] = value;
    }
    return obj;
}
/**
 * This object is the single "virtual" mouse that might be controlled by multiple different pointer devices.
 */ class Mouse {
    move(instance, position, /** Whether `preventDefault()` has been called on the `pointerdown` event */ isPrevented) {
        const prevPosition = this.position;
        const prevTarget = this.getTarget(instance);
        this.position = position;
        if (!shared.isDifferentPointerPosition(prevPosition, position)) {
            return;
        }
        const nextTarget = this.getTarget(instance);
        const init = this.getEventInit('mousemove');
        const [leave, enter] = getTreeDiff.getTreeDiff(prevTarget, nextTarget);
        return {
            leave: () => {
                if (prevTarget !== nextTarget) {
                    instance.dispatchUIEvent(prevTarget, 'mouseout', init);
                    leave.forEach((el) => instance.dispatchUIEvent(el, 'mouseleave', init));
                }
            },
            enter: () => {
                if (prevTarget !== nextTarget) {
                    instance.dispatchUIEvent(nextTarget, 'mouseover', init);
                    enter.forEach((el) => instance.dispatchUIEvent(el, 'mouseenter', init));
                }
            },
            move: () => {
                if (isPrevented) {
                    return;
                }
                instance.dispatchUIEvent(nextTarget, 'mousemove', init);
                this.modifySelecting(instance);
            }
        };
    }
    down(instance, keyDef, /** Whether `preventDefault()` has been called on the `pointerdown` event */ isPrevented) {
        const button = this.buttons.down(keyDef);
        if (button === undefined) {
            return;
        }
        const target = this.getTarget(instance);
        this.buttonDownTarget[button] = target;
        const init = this.getEventInit('mousedown', keyDef.button);
        const disabled = isDisabled.isDisabled(target);
        if (!isPrevented && (disabled || instance.dispatchUIEvent(target, 'mousedown', init))) {
            this.startSelecting(instance, init.detail);
            focus.focusElement(target);
        }
        if (!disabled && buttons.getMouseEventButton(keyDef.button) === 2) {
            instance.dispatchUIEvent(target, 'contextmenu', this.getEventInit('contextmenu', keyDef.button));
        }
    }
    up(instance, keyDef, /** Whether `preventDefault()` has been called on the `pointerdown` event */ isPrevented) {
        const button = this.buttons.up(keyDef);
        if (button === undefined) {
            return;
        }
        const target = this.getTarget(instance);
        if (!isDisabled.isDisabled(target)) {
            if (!isPrevented) {
                const mouseUpInit = this.getEventInit('mouseup', keyDef.button);
                instance.dispatchUIEvent(target, 'mouseup', mouseUpInit);
                this.endSelecting();
            }
            const clickTarget = getTreeDiff.getTreeDiff(this.buttonDownTarget[button], target)[2][0];
            if (clickTarget) {
                const init = this.getEventInit('click', keyDef.button);
                if (init.detail) {
                    instance.dispatchUIEvent(clickTarget, init.button === 0 ? 'click' : 'auxclick', init);
                    if (init.button === 0 && init.detail === 2) {
                        instance.dispatchUIEvent(clickTarget, 'dblclick', {
                            ...this.getEventInit('dblclick', keyDef.button),
                            detail: init.detail
                        });
                    }
                }
            }
        }
    }
    resetClickCount() {
        this.clickCount.reset();
    }
    getEventInit(type, button) {
        const init = {
            ...this.position.coords
        };
        init.button = buttons.getMouseEventButton(button);
        init.buttons = this.buttons.getButtons();
        if (type === 'mousedown') {
            init.detail = this.clickCount.getOnDown(init.button);
        }
        else if (type === 'mouseup') {
            init.detail = this.clickCount.getOnUp(init.button);
        }
        else if (type === 'click' || type === 'auxclick') {
            init.detail = this.clickCount.incOnClick(init.button);
        }
        return init;
    }
    getTarget(instance) {
        var _this_position_target;
        return (_this_position_target = this.position.target) !== null && _this_position_target !== undefined ? _this_position_target : instance.config.document.body;
    }
    startSelecting(instance, clickCount) {
        var _this_position_caret, _this_position_caret1;
        // TODO: support extending range (shift)
        this.selecting = setSelectionPerMouse.setSelectionPerMouseDown({
            document: instance.config.document,
            target: this.getTarget(instance),
            node: (_this_position_caret = this.position.caret) === null || _this_position_caret === undefined ? undefined : _this_position_caret.node,
            offset: (_this_position_caret1 = this.position.caret) === null || _this_position_caret1 === undefined ? undefined : _this_position_caret1.offset,
            clickCount
        });
    }
    modifySelecting(instance) {
        var _this_position_caret, _this_position_caret1;
        if (!this.selecting) {
            return;
        }
        modifySelectionPerMouse.modifySelectionPerMouseMove(this.selecting, {
            document: instance.config.document,
            target: this.getTarget(instance),
            node: (_this_position_caret = this.position.caret) === null || _this_position_caret === undefined ? undefined : _this_position_caret.node,
            offset: (_this_position_caret1 = this.position.caret) === null || _this_position_caret1 === undefined ? undefined : _this_position_caret1.offset
        });
    }
    endSelecting() {
        this.selecting = undefined;
    }
    constructor() {
        _define_property(this, "position", {});
        _define_property(this, "buttons", new buttons.Buttons());
        _define_property(this, "selecting", undefined);
        _define_property(this, "buttonDownTarget", {});
        // According to spec the `detail` on click events should be the number
        // of *consecutive* clicks with a specific button.
        // On `mousedown` and `mouseup` it should be this number increased by one.
        // But the browsers don't implement it this way.
        // If another button is pressed,
        //   in Webkit: the `mouseup` on the previously pressed button has `detail: 0` and no `click`/`auxclick`.
        //   in Gecko: the `mouseup` and click events have the same detail as the `mousedown`.
        // If there is a delay while a button is pressed,
        // the `mouseup` and `click` are normal, but a following `mousedown` starts a new click count.
        // We'll follow the minimal implementation of Webkit.
        _define_property(this, "clickCount", new class {
            incOnClick(button) {
                const current = this.down[button] === undefined ? undefined : Number(this.down[button]) + 1;
                this.count = this.count[button] === undefined ? {} : {
                    [button]: Number(this.count[button]) + 1
                };
                return current;
            }
            getOnDown(button) {
                var _this_count_button;
                this.down = {
                    [button]: (_this_count_button = this.count[button]) !== null && _this_count_button !== undefined ? _this_count_button : 0
                };
                var _this_count_button1;
                this.count = {
                    [button]: (_this_count_button1 = this.count[button]) !== null && _this_count_button1 !== undefined ? _this_count_button1 : 0
                };
                return Number(this.count[button]) + 1;
            }
            getOnUp(button) {
                return this.down[button] === undefined ? undefined : Number(this.down[button]) + 1;
            }
            reset() {
                this.count = {};
            }
            constructor() {
                _define_property(this, "down", {});
                _define_property(this, "count", {});
            }
        }());
    }
}
exports.Mouse = Mouse;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9wb2ludGVyL21vdXNlLmpzIiwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ3pDLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3ZDLE9BQU8sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQzNDLE9BQU8sQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0FBQzVDLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ3pDLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ3pDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2hDLE9BQU8sQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0FBQ2pELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQzNELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQzdELElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQzVDLElBQUksb0JBQW9CLEdBQUcsT0FBTyxDQUFDLCtDQUErQyxDQUFDLENBQUM7QUFDcEYsSUFBSSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsa0RBQWtELENBQUMsQ0FBQztBQUMxRixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBRXBDLFNBQVMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLO0lBQ3JDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO1lBQzVCLEtBQUssRUFBRSxLQUFLO1lBQ1osVUFBVSxFQUFFLElB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LENBQUM7WUFDeEMsQ0FBQztTQUNKLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsQ0FBQztDQUNKO0FBRUQsT0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL3N5c3RlbS9wb2ludGVyL21vdXNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxucmVxdWlyZSgnLi4vLi4vZXZlbnQvYmVoYXZpb3IvY2xpY2suanMnKTtcbnJlcXVpcmUoJy4uLy4uL2V2ZW50L2JlaGF2aW9yL2N1dC5qcycpO1xucmVxdWlyZSgnLi4vLi4vZXZlbnQvYmVoYXZpb3Iva2V5ZG93bi5qcycpO1xucmVxdWlyZSgnLi4vLi4vZXZlbnQvYmVoYXZpb3Iva2V5cHJlc3MuanMnKTtcbnJlcXVpcmUoJy4uLy4uL2V2ZW50L2JlaGF2aW9yL2tleXVwLmpzJyk7XG5yZXF1aXJlKCcuLi8uLi9ldmVudC9iZWhhdmlvci9wYXN0ZS5qcycpO1xucmVxdWlyZSgnQHRlc3RpbmctbGlicmFyeS9kb20nKTtcbnJlcXVpcmUoJy4uLy4uL3V0aWxzL2RhdGFUcmFuc2Zlci9DbGlwYm9hcmQuanMnKTtcbnZhciBpc0Rpc2FibGVkID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbWlzYy9pc0Rpc2FibGVkLmpzJyk7XG52YXIgZ2V0VHJlZURpZmYgPSByZXF1aXJlKCcuLi8uLi91dGlscy9taXNjL2dldFRyZWVEaWZmLmpzJyk7XG52YXIgZm9jdXMgPSByZXF1aXJlKCcuLi8uLi9ldmVudC9mb2N1cy5qcycpO1xudmFyIHNldFNlbGVjdGlvblBlck1vdXNlID0gcmVxdWlyZSgnLi4vLi4vZXZlbnQvc2VsZWN0aW9uL3NldFNlbGVjdGlvblBlck1vdXNlLmpzJyk7XG52YXIgbW9kaWZ5U2VsZWN0aW9uUGVyTW91c2UgPSByZXF1aXJlKCcuLi8uLi9ldmVudC9zZWxlY3Rpb24vbW9kaWZ5U2VsZWN0aW9uUGVyTW91c2UuanMnKTtcbnZhciBidXR0b25zID0gcmVxdWlyZSgnLi9idXR0b25zLmpzJyk7XG52YXIgc2hhcmVkID0gcmVxdWlyZSgnLi9zaGFyZWQuanMnKTtcblxuZnVuY3Rpb24gX2RlZmluZV9wcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5IGluIG9iaikge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHtcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBvYmpba2V5XSA9IHZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuLyoqXG4gKiBUaGlzIG9iamVjdCBpcyB0aGUgc2luZ2xlIFwidmlydHVhbFwiIG1vdXNlIHRoYXQgbWlnaHQgYmUgY29udHJvbGxlZCBieSBtdWx0aXBsZSBkaWZmZXJlbnQgcG9pbnRlciBkZXZpY2VzLlxuICovIGNsYXNzIE1vdXNlIHtcbiAgICBtb3ZlKGluc3RhbmNlLCBwb3NpdGlvbiwgLyoqIFdoZXRoZXIgYHByZXZlbnREZWZhdWx0KClgIGhhcyBiZWVuIGNhbGxlZCBvbiB0aGUgYHBvaW50ZXJkb3duYCBldmVudCAqLyBpc1ByZXZlbnRlZCkge1xuICAgICAgICBjb25zdCBwcmV2UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uO1xuICAgICAgICBjb25zdCBwcmV2VGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoaW5zdGFuY2UpO1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgIGlmICghc2hhcmVkLmlzRGlmZmVyZW50UG9pbnRlclBvc2l0aW9uKHByZXZQb3NpdGlvbiwgcG9zaXRpb24pKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbmV4dFRhcmdldCA9IHRoaXMuZ2V0VGFyZ2V0KGluc3RhbmNlKTtcbiAgICAgICAgY29uc3QgaW5pdCA9IHRoaXMuZ2V0RXZlbnRJbml0KCdtb3VzZW1vdmUnKTtcbiAgICAgICAgY29uc3QgW2xlYXZlLCBlbnRlcl0gPSBnZXRUcmVlRGlmZi5nZXRUcmVlRGlmZihwcmV2VGFyZ2V0LCBuZXh0VGFyZ2V0KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGxlYXZlOiAoKT0+e1xuICAgICAgICAgICAgICAgIGlmIChwcmV2VGFyZ2V0ICE9PSBuZXh0VGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmRpc3BhdGNoVUlFdmVudChwcmV2VGFyZ2V0LCAnbW91c2VvdXQnLCBpbml0KTtcbiAgICAgICAgICAgICAgICAgICAgbGVhdmUuZm9yRWFjaCgoZWwpPT5pbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQoZWwsICdtb3VzZWxlYXZlJywgaW5pdCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbnRlcjogKCk9PntcbiAgICAgICAgICAgICAgICBpZiAocHJldlRhcmdldCAhPT0gbmV4dFRhcmdldCkge1xuICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQobmV4dFRhcmdldCwgJ21vdXNlb3ZlcicsIGluaXQpO1xuICAgICAgICAgICAgICAgICAgICBlbnRlci5mb3JFYWNoKChlbCk9Pmluc3RhbmNlLmRpc3BhdGNoVUlFdmVudChlbCwgJ21vdXNlZW50ZXInLCBpbml0KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1vdmU6ICgpPT57XG4gICAgICAgICAgICAgICAgaWYgKGlzUHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KG5leHRUYXJnZXQsICdtb3VzZW1vdmUnLCBpbml0KTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGlmeVNlbGVjdGluZyhpbnN0YW5jZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuICAgIGRvd24oaW5zdGFuY2UsIGtleURlZiwgLyoqIFdoZXRoZXIgYHByZXZlbnREZWZhdWx0KClgIGhhcyBiZWVuIGNhbGxlZCBvbiB0aGUgYHBvaW50ZXJkb3duYCBldmVudCAqLyBpc1ByZXZlbnRlZCkge1xuICAgICAgICBjb25zdCBidXR0b24gPSB0aGlzLmJ1dHRvbnMuZG93bihrZXlEZWYpO1xuICAgICAgICBpZiAoYnV0dG9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdldFRhcmdldChpbnN0YW5jZSk7XG4gICAgICAgIHRoaXMuYnV0dG9uRG93blRhcmdldFtidXR0b25dID0gdGFyZ2V0O1xuICAgICAgICBjb25zdCBpbml0ID0gdGhpcy5nZXRFdmVudEluaXQoJ21vdXNlZG93bicsIGtleURlZi5idXR0b24pO1xuICAgICAgICBjb25zdCBkaXNhYmxlZCA9IGlzRGlzYWJsZWQuaXNEaXNhYmxlZCh0YXJnZXQpO1xuICAgICAgICBpZiAoIWlzUHJldmVudGVkICYmIChkaXNhYmxlZCB8fCBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQodGFyZ2V0LCAnbW91c2Vkb3duJywgaW5pdCkpKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0U2VsZWN0aW5nKGluc3RhbmNlLCBpbml0LmRldGFpbCk7XG4gICAgICAgICAgICBmb2N1cy5mb2N1c0VsZW1lbnQodGFyZ2V0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWRpc2FibGVkICYmIGJ1dHRvbnMuZ2V0TW91c2VFdmVudEJ1dHRvbihrZXlEZWYuYnV0dG9uKSA9PT0gMikge1xuICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KHRhcmdldCwgJ2NvbnRleHRtZW51JywgdGhpcy5nZXRFdmVudEluaXQoJ2NvbnRleHRtZW51Jywga2V5RGVmLmJ1dHRvbikpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHVwKGluc3RhbmNlLCBrZXlEZWYsIC8qKiBXaGV0aGVyIGBwcmV2ZW50RGVmYXVsdCgpYCBoYXMgYmVlbiBjYWxsZWQgb24gdGhlIGBwb2ludGVyZG93bmAgZXZlbnQgKi8gaXNQcmV2ZW50ZWQpIHtcbiAgICAgICAgY29uc3QgYnV0dG9uID0gdGhpcy5idXR0b25zLnVwKGtleURlZik7XG4gICAgICAgIGlmIChidXR0b24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZ2V0VGFyZ2V0KGluc3RhbmNlKTtcbiAgICAgICAgaWYgKCFpc0Rpc2FibGVkLmlzRGlzYWJsZWQodGFyZ2V0KSkge1xuICAgICAgICAgICAgaWYgKCFpc1ByZXZlbnRlZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vdXNlVXBJbml0ID0gdGhpcy5nZXRFdmVudEluaXQoJ21vdXNldXAnLCBrZXlEZWYuYnV0dG9uKTtcbiAgICAgICAgICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQodGFyZ2V0LCAnbW91c2V1cCcsIG1vdXNlVXBJbml0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmVuZFNlbGVjdGluZygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgY2xpY2tUYXJnZXQgPSBnZXRUcmVlRGlmZi5nZXRUcmVlRGlmZih0aGlzLmJ1dHRvbkRvd25UYXJnZXRbYnV0dG9uXSwgdGFyZ2V0KVsyXVswXTtcbiAgICAgICAgICAgIGlmIChjbGlja1RhcmdldCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluaXQgPSB0aGlzLmdldEV2ZW50SW5pdCgnY2xpY2snLCBrZXlEZWYuYnV0dG9uKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5pdC5kZXRhaWwpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuZGlzcGF0Y2hVSUV2ZW50KGNsaWNrVGFyZ2V0LCBpbml0LmJ1dHRvbiA9PT0gMCA/ICdjbGljaycgOiAnYXV4Y2xpY2snLCBpbml0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXQuYnV0dG9uID09PSAwICYmIGluaXQuZGV0YWlsID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5kaXNwYXRjaFVJRXZlbnQoY2xpY2tUYXJnZXQsICdkYmxjbGljaycsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmdldEV2ZW50SW5pdCgnZGJsY2xpY2snLCBrZXlEZWYuYnV0dG9uKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWw6IGluaXQuZGV0YWlsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXNldENsaWNrQ291bnQoKSB7XG4gICAgICAgIHRoaXMuY2xpY2tDb3VudC5yZXNldCgpO1xuICAgIH1cbiAgICBnZXRFdmVudEluaXQodHlwZSwgYnV0dG9uKSB7XG4gICAgICAgIGNvbnN0IGluaXQgPSB7XG4gICAgICAgICAgICAuLi50aGlzLnBvc2l0aW9uLmNvb3Jkc1xuICAgICAgICB9O1xuICAgICAgICBpbml0LmJ1dHRvbiA9IGJ1dHRvbnMuZ2V0TW91c2VFdmVudEJ1dHRvbihidXR0b24pO1xuICAgICAgICBpbml0LmJ1dHRvbnMgPSB0aGlzLmJ1dHRvbnMuZ2V0QnV0dG9ucygpO1xuICAgICAgICBpZiAodHlwZSA9PT0gJ21vdXNlZG93bicpIHtcbiAgICAgICAgICAgIGluaXQuZGV0YWlsID0gdGhpcy5jbGlja0NvdW50LmdldE9uRG93bihpbml0LmJ1dHRvbik7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ21vdXNldXAnKSB7XG4gICAgICAgICAgICBpbml0LmRldGFpbCA9IHRoaXMuY2xpY2tDb3VudC5nZXRPblVwKGluaXQuYnV0dG9uKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY2xpY2snIHx8IHR5cGUgPT09ICdhdXhjbGljaycpIHtcbiAgICAgICAgICAgIGluaXQuZGV0YWlsID0gdGhpcy5jbGlja0NvdW50LmluY09uQ2xpY2soaW5pdC5idXR0b24pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbml0O1xuICAgIH1cbiAgICBnZXRUYXJnZXQoaW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIF90aGlzX3Bvc2l0aW9uX3RhcmdldDtcbiAgICAgICAgcmV0dXJuIChfdGhpc19wb3NpdGlvbl90YXJnZXQgPSB0aGlzLnBvc2l0aW9uLnRhcmdldCkgIT09IG51bGwgJiYgX3RoaXNfcG9zaXRpb25fdGFyZ2V0ICE9PSB1bmRlZmluZWQgPyBfdGhpc19wb3NpdGlvbl90YXJnZXQgOiBpbnN0YW5jZS5jb25maWcuZG9jdW1lbnQuYm9keTtcbiAgICB9XG4gICAgc3RhcnRTZWxlY3RpbmcoaW5zdGFuY2UsIGNsaWNrQ291bnQpIHtcbiAgICAgICAgdmFyIF90aGlzX3Bvc2l0aW9uX2NhcmV0LCBfdGhpc19wb3NpdGlvbl9jYXJldDE7XG4gICAgICAgIC8vIFRPRE86IHN1cHBvcnQgZXh0ZW5kaW5nIHJhbmdlIChzaGlmdClcbiAgICAgICAgdGhpcy5zZWxlY3RpbmcgPSBzZXRTZWxlY3Rpb25QZXJNb3VzZS5zZXRTZWxlY3Rpb25QZXJNb3VzZURvd24oe1xuICAgICAgICAgICAgZG9jdW1lbnQ6IGluc3RhbmNlLmNvbmZpZy5kb2N1bWVudCxcbiAgICAgICAgICAgIHRhcmdldDogdGhpcy5nZXRUYXJnZXQoaW5zdGFuY2UpLFxuICAgICAgICAgICAgbm9kZTogKF90aGlzX3Bvc2l0aW9uX2NhcmV0ID0gdGhpcy5wb3NpdGlvbi5jYXJldCkgPT09IG51bGwgfHwgX3RoaXNfcG9zaXRpb25fY2FyZXQgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IF90aGlzX3Bvc2l0aW9uX2NhcmV0Lm5vZGUsXG4gICAgICAgICAgICBvZmZzZXQ6IChfdGhpc19wb3NpdGlvbl9jYXJldDEgPSB0aGlzLnBvc2l0aW9uLmNhcmV0KSA9PT0gbnVsbCB8fCBfdGhpc19wb3NpdGlvbl9jYXJldDEgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IF90aGlzX3Bvc2l0aW9uX2NhcmV0MS5vZmZzZXQsXG4gICAgICAgICAgICBjbGlja0NvdW50XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBtb2RpZnlTZWxlY3RpbmcoaW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIF90aGlzX3Bvc2l0aW9uX2NhcmV0LCBfdGhpc19wb3NpdGlvbl9jYXJldDE7XG4gICAgICAgIGlmICghdGhpcy5zZWxlY3RpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBtb2RpZnlTZWxlY3Rpb25QZXJNb3VzZS5tb2RpZnlTZWxlY3Rpb25QZXJNb3VzZU1vdmUodGhpcy5zZWxlY3RpbmcsIHtcbiAgICAgICAgICAgIGRvY3VtZW50OiBpbnN0YW5jZS5jb25maWcuZG9jdW1lbnQsXG4gICAgICAgICAgICB0YXJnZXQ6IHRoaXMuZ2V0VGFyZ2V0KGluc3RhbmNlKSxcbiAgICAgICAgICAgIG5vZGU6IChfdGhpc19wb3NpdGlvbl9jYXJldCA9IHRoaXMucG9zaXRpb24uY2FyZXQpID09PSBudWxsIHx8IF90aGlzX3Bvc2l0aW9uX2NhcmV0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfdGhpc19wb3NpdGlvbl9jYXJldC5ub2RlLFxuICAgICAgICAgICAgb2Zmc2V0OiAoX3RoaXNfcG9zaXRpb25fY2FyZXQxID0gdGhpcy5wb3NpdGlvbi5jYXJldCkgPT09IG51bGwgfHwgX3RoaXNfcG9zaXRpb25fY2FyZXQxID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfdGhpc19wb3NpdGlvbl9jYXJldDEub2Zmc2V0XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbmRTZWxlY3RpbmcoKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0aW5nID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdHJ1Y3Rvcigpe1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwicG9zaXRpb25cIiwge30pO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiYnV0dG9uc1wiLCBuZXcgYnV0dG9ucy5CdXR0b25zKCkpO1xuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwic2VsZWN0aW5nXCIsIHVuZGVmaW5lZCk7XG4gICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJidXR0b25Eb3duVGFyZ2V0XCIsIHt9KTtcbiAgICAgICAgLy8gQWNjb3JkaW5nIHRvIHNwZWMgdGhlIGBkZXRhaWxgIG9uIGNsaWNrIGV2ZW50cyBzaG91bGQgYmUgdGhlIG51bWJlclxuICAgICAgICAvLyBvZiAqY29uc2VjdXRpdmUqIGNsaWNrcyB3aXRoIGEgc3BlY2lmaWMgYnV0dG9uLlxuICAgICAgICAvLyBPbiBgbW91c2Vkb3duYCBhbmQgYG1vdXNldXBgIGl0IHNob3VsZCBiZSB0aGlzIG51bWJlciBpbmNyZWFzZWQgYnkgb25lLlxuICAgICAgICAvLyBCdXQgdGhlIGJyb3dzZXJzIGRvbid0IGltcGxlbWVudCBpdCB0aGlzIHdheS5cbiAgICAgICAgLy8gSWYgYW5vdGhlciBidXR0b24gaXMgcHJlc3NlZCxcbiAgICAgICAgLy8gICBpbiBXZWJraXQ6IHRoZSBgbW91c2V1cGAgb24gdGhlIHByZXZpb3VzbHkgcHJlc3NlZCBidXR0b24gaGFzIGBkZXRhaWw6IDBgIGFuZCBubyBgY2xpY2tgL2BhdXhjbGlja2AuXG4gICAgICAgIC8vICAgaW4gR2Vja286IHRoZSBgbW91c2V1cGAgYW5kIGNsaWNrIGV2ZW50cyBoYXZlIHRoZSBzYW1lIGRldGFpbCBhcyB0aGUgYG1vdXNlZG93bmAuXG4gICAgICAgIC8vIElmIHRoZXJlIGlzIGEgZGVsYXkgd2hpbGUgYSBidXR0b24gaXMgcHJlc3NlZCxcbiAgICAgICAgLy8gdGhlIGBtb3VzZXVwYCBhbmQgYGNsaWNrYCBhcmUgbm9ybWFsLCBidXQgYSBmb2xsb3dpbmcgYG1vdXNlZG93bmAgc3RhcnRzIGEgbmV3IGNsaWNrIGNvdW50LlxuICAgICAgICAvLyBXZSdsbCBmb2xsb3cgdGhlIG1pbmltYWwgaW1wbGVtZW50YXRpb24gb2YgV2Via2l0LlxuICAgICAgICBfZGVmaW5lX3Byb3BlcnR5KHRoaXMsIFwiY2xpY2tDb3VudFwiLCBuZXcgY2xhc3Mge1xuICAgICAgICAgICAgaW5jT25DbGljayhidXR0b24pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5kb3duW2J1dHRvbl0gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IE51bWJlcih0aGlzLmRvd25bYnV0dG9uXSkgKyAxO1xuICAgICAgICAgICAgICAgIHRoaXMuY291bnQgPSB0aGlzLmNvdW50W2J1dHRvbl0gPT09IHVuZGVmaW5lZCA/IHt9IDoge1xuICAgICAgICAgICAgICAgICAgICBbYnV0dG9uXTogTnVtYmVyKHRoaXMuY291bnRbYnV0dG9uXSkgKyAxXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldE9uRG93bihidXR0b24pIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXNfY291bnRfYnV0dG9uO1xuICAgICAgICAgICAgICAgIHRoaXMuZG93biA9IHtcbiAgICAgICAgICAgICAgICAgICAgW2J1dHRvbl06IChfdGhpc19jb3VudF9idXR0b24gPSB0aGlzLmNvdW50W2J1dHRvbl0pICE9PSBudWxsICYmIF90aGlzX2NvdW50X2J1dHRvbiAhPT0gdW5kZWZpbmVkID8gX3RoaXNfY291bnRfYnV0dG9uIDogMFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdmFyIF90aGlzX2NvdW50X2J1dHRvbjE7XG4gICAgICAgICAgICAgICAgdGhpcy5jb3VudCA9IHtcbiAgICAgICAgICAgICAgICAgICAgW2J1dHRvbl06IChfdGhpc19jb3VudF9idXR0b24xID0gdGhpcy5jb3VudFtidXR0b25dKSAhPT0gbnVsbCAmJiBfdGhpc19jb3VudF9idXR0b24xICE9PSB1bmRlZmluZWQgPyBfdGhpc19jb3VudF9idXR0b24xIDogMFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLmNvdW50W2J1dHRvbl0pICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldE9uVXAoYnV0dG9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG93bltidXR0b25dID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBOdW1iZXIodGhpcy5kb3duW2J1dHRvbl0pICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc2V0KCkge1xuICAgICAgICAgICAgICAgIHRoaXMuY291bnQgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0cnVjdG9yKCl7XG4gICAgICAgICAgICAgICAgX2RlZmluZV9wcm9wZXJ0eSh0aGlzLCBcImRvd25cIiwge30pO1xuICAgICAgICAgICAgICAgIF9kZWZpbmVfcHJvcGVydHkodGhpcywgXCJjb3VudFwiLCB7fSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0oKSk7XG4gICAgfVxufVxuXG5leHBvcnRzLk1vdXNlID0gTW91c2U7XG4iXSwidmVyc2lvbiI6M30=