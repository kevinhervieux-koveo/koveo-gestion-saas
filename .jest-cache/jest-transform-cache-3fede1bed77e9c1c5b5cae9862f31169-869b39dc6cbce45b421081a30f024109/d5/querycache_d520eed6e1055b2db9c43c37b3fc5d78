599d2ce9e850d46ef87b7121930447c9
"use strict";
/**
 * Query caching system for Quebec property management SaaS.
 * Implements intelligent caching to reduce 132ms average query time.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CACHE_CONFIGS = exports.QueryCacheManager = exports.default = exports.CacheWarmer = exports.CacheMonitor = exports.CacheInvalidator = exports.queryCache = void 0;
exports.withCache = withCache;
const lru_cache_1 = require("lru-cache");
/**
 * Cache configurations optimized for property management workloads.
 */
const CACHE_CONFIGS = {
    // User data - frequently accessed, moderate changes
    users: { maxSize: 1000, ttl: 5 * 60 * 1000 }, // 5 minutes
    // Organization data - stable, infrequent changes
    organizations: { maxSize: 100, ttl: 30 * 60 * 1000 }, // 30 minutes
    // Building data - relatively stable
    buildings: { maxSize: 500, ttl: 15 * 60 * 1000 }, // 15 minutes
    // Residence data - stable structure, occasional updates
    residences: { maxSize: 2000, ttl: 10 * 60 * 1000 }, // 10 minutes
    // Bills - time-sensitive, frequent updates
    bills: { maxSize: 1000, ttl: 2 * 60 * 1000 }, // 2 minutes
    // Maintenance requests - dynamic, frequent status changes
    maintenance: { maxSize: 500, ttl: 1 * 60 * 1000 }, // 1 minute
    // Notifications - real-time, short cache
    notifications: { maxSize: 500, ttl: 30 * 1000 }, // 30 seconds
    // Quality metrics - stable for periods
    metrics: { maxSize: 200, ttl: 5 * 60 * 1000 }, // 5 minutes
    // Features and roadmap - moderately stable
    features: { maxSize: 300, ttl: 3 * 60 * 1000 }, // 3 minutes
    // Framework configuration - very stable
    config: { maxSize: 100, ttl: 60 * 60 * 1000 }, // 1 hour
    // Bug reports - moderate changes, user-specific
    bugs: { maxSize: 500, ttl: 2 * 60 * 1000 }, // 2 minutes
};
exports.CACHE_CONFIGS = CACHE_CONFIGS;
/**
 * Cache instances for different data types.
 */
class QueryCacheManager {
    caches = new Map();
    hitCounts = new Map();
    missCounts = new Map();
    /**
     *
     */
    constructor() {
        // Initialize caches for each data type
        Object.entries(CACHE_CONFIGS).forEach(([type, config]) => {
            this.caches.set(type, new lru_cache_1.LRUCache({
                max: config.maxSize,
                ttl: config.ttl,
                updateAgeOnGet: true,
                updateAgeOnHas: true,
            }));
            this.hitCounts.set(type, 0);
            this.missCounts.set(type, 0);
        });
    }
    /**
     * Gets cached data if available.
     * @param cacheType Type of cache (users, buildings, etc.).
     * @param key Cache key.
     * @param _key
     * @returns Cached data or undefined.
     */
    get(cacheType, _key) {
        const cache = this.caches.get(cacheType);
        if (!cache) {
            return undefined;
        }
        const result = cache.get(_key);
        if (result !== undefined) {
            this.hitCounts.set(cacheType, (this.hitCounts.get(cacheType) || 0) + 1);
            return result;
        }
        this.missCounts.set(cacheType, (this.missCounts.get(cacheType) || 0) + 1);
        return undefined;
    }
    /**
     * Stores data in cache.
     * @param cacheType Type of cache.
     * @param key Cache key.
     * @param data Data to cache.
     * @param _key
     * @param _data
     */
    set(cacheType, _key, _data) {
        const cache = this.caches.get(cacheType);
        if (!cache) {
            return;
        }
        cache.set(_key, _data);
    }
    /**
     * Invalidates cache entries by pattern.
     * @param cacheType Type of cache.
     * @param pattern Key pattern to invalidate (supports wildcards).
     */
    invalidate(cacheType, pattern) {
        const cache = this.caches.get(cacheType);
        if (!cache) {
            return;
        }
        if (pattern) {
            // Remove entries matching pattern
            for (const key of cache.keys()) {
                if (this.matchesPattern(key, pattern)) {
                    cache.delete(key);
                }
            }
        }
        else {
            // Clear entire cache
            cache.clear();
        }
    }
    /**
     * Gets cache performance statistics.
     */
    getStats() {
        const stats = {};
        for (const [_type, cache] of this.caches) {
            const hits = this.hitCounts.get(_type) || 0;
            const misses = this.missCounts.get(_type) || 0;
            const total = hits + misses;
            const hitRate = total > 0 ? ((hits / total) * 100).toFixed(2) : '0.00';
            stats[_type] = {
                size: cache.size,
                maxSize: cache.max,
                hits,
                misses,
                hitRate: `${hitRate}%`,
                memoryUsage: this.estimateMemoryUsage(cache),
            };
        }
        return stats;
    }
    /**
     * Clears all caches.
     */
    clearAll() {
        for (const [_type, cache] of this.caches) {
            cache.clear();
            this.hitCounts.set(_type, 0);
            this.missCounts.set(_type, 0);
        }
    }
    /**
     * Pattern matching for cache key invalidation.
     * @param key
     * @param _key
     * @param pattern
     */
    matchesPattern(_key, pattern) {
        const regex = new RegExp(pattern.replace(/\*/g, '.*'));
        return regex.test(_key);
    }
    /**
     * Estimates memory usage of a cache.
     * @param cache
     */
    estimateMemoryUsage(cache) {
        let totalSize = 0;
        for (const value of cache.values()) {
            totalSize += JSON.stringify(value).length * 2; // Rough estimate
        }
        return `${(totalSize / 1024).toFixed(2)} KB`;
    }
}
exports.QueryCacheManager = QueryCacheManager;
/**
 * Global cache manager instance.
 */
exports.queryCache = new QueryCacheManager();
exports.default = exports.queryCache;
/**
 * Cached query helper function for database operations.
 * Replaces decorator approach for better compatibility.
 * @param cacheType
 * @param cacheKey
 * @param operation
 */
/**
 * WithCache function.
 * @param cacheType
 * @param cacheKey
 * @param operation
 * @returns Function result.
 */
function withCache(cacheType, cacheKey, operation) {
    return new Promise(async (resolve, reject) => {
        try {
            // Try to get from cache first
            const cached = exports.queryCache.get(cacheType, cacheKey);
            if (cached !== undefined) {
                resolve(cached);
                return;
            }
            // Execute operation
            const result = await operation();
            // Cache the result
            exports.queryCache.set(cacheType, cacheKey, result);
            resolve(result);
        }
        catch (error) {
            reject(error);
        }
    });
}
/**
 * Cache invalidation utilities for specific operations.
 */
class CacheInvalidator {
    /**
     * Invalidates user-related caches when user data changes.
     * @param userId
     */
    static invalidateUserCaches(userId) {
        exports.queryCache.invalidate('users', `user:${userId}*`);
        exports.queryCache.invalidate('residences', `user_residences:${userId}*`);
        exports.queryCache.invalidate('notifications', `user_notifications:${userId}*`);
    }
    /**
     * Invalidates building-related caches when building data changes.
     * @param buildingId
     */
    static invalidateBuildingCaches(buildingId) {
        exports.queryCache.invalidate('buildings', `building:${buildingId}*`);
        exports.queryCache.invalidate('residences', `building_residences:${buildingId}*`);
        exports.queryCache.invalidate('budgets', `building_budgets:${buildingId}*`);
    }
    /**
     * Invalidates residence-related caches when residence data changes.
     * @param residenceId
     */
    static invalidateResidenceCaches(residenceId) {
        exports.queryCache.invalidate('residences', `residence:${residenceId}*`);
        exports.queryCache.invalidate('bills', `residence_bills:${residenceId}*`);
        exports.queryCache.invalidate('maintenance', `residence_maintenance:${residenceId}*`);
    }
    /**
     * Invalidates all caches (use sparingly).
     */
    static invalidateAll() {
        exports.queryCache.clearAll();
    }
}
exports.CacheInvalidator = CacheInvalidator;
/**
 * Performance monitoring for cache effectiveness.
 */
class CacheMonitor {
    /**
     * Logs cache performance statistics.
     */
    static logPerformanceStats() {
        const stats = exports.queryCache.getStats();
        console.table(stats);
    }
    /**
     * Monitors cache hit rates and suggests optimizations.
     */
    static analyzePerformance() {
        const stats = exports.queryCache.getStats();
        const suggestions = [];
        Object.entries(stats).forEach(([cacheType, stat]) => {
            const hitRate = parseFloat(stat.hitRate.replace('%', ''));
            if (hitRate < 50) {
                suggestions.push(`Low hit rate for ${cacheType} cache (${stat.hitRate}). Consider increasing TTL or cache size.`);
            }
            if (stat.size === stat.maxSize) {
                suggestions.push(`${cacheType} cache is at maximum capacity. Consider increasing max size.`);
            }
        });
        return suggestions;
    }
    /**
     * Gets memory usage summary for all caches.
     */
    static getMemoryUsage() {
        const stats = exports.queryCache.getStats();
        let totalMemory = 0;
        Object.values(stats).forEach((stat) => {
            totalMemory += parseFloat(stat.memoryUsage.replace(' KB', ''));
        });
        return `${totalMemory.toFixed(2)} KB`;
    }
}
exports.CacheMonitor = CacheMonitor;
/**
 * Automatic cache warming for frequently accessed data.
 */
class CacheWarmer {
    /**
     * Warms up caches with frequently accessed data.
     */
    static async warmCaches() {
        try {
            // This would be implemented with actual database calls
            // Example: Pre-load active users, organizations, etc.
        }
        catch (error) {
            console.error('❌ Error warming caches:', error);
        }
    }
}
exports.CacheWarmer = CacheWarmer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0FBQyxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUN4QyxDQUFDO0NBQ0Y7QUFoREQsb0NBZ0RDO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFdBQVc7SUFDdEI7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVU7UUFFckIsSUFBSSxDQUFDO1lBQ0gsdURBQXVEO1lBQ3ZELHNEQUFzRDtRQUN4RCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xELENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFiRCxrQ0FhQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NlcnZlci9xdWVyeS1jYWNoZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFF1ZXJ5IGNhY2hpbmcgc3lzdGVtIGZvciBRdWViZWMgcHJvcGVydHkgbWFuYWdlbWVudCBTYWFTLlxuICogSW1wbGVtZW50cyBpbnRlbGxpZ2VudCBjYWNoaW5nIHRvIHJlZHVjZSAxMzJtcyBhdmVyYWdlIHF1ZXJ5IHRpbWUuXG4gKi9cblxuaW1wb3J0IHsgTFJVQ2FjaGUgfSBmcm9tICdscnUtY2FjaGUnO1xuXG4vKipcbiAqIENhY2hlIGNvbmZpZ3VyYXRpb24gZm9yIGRpZmZlcmVudCB0eXBlcyBvZiBxdWVyaWVzLlxuICovXG5pbnRlcmZhY2UgQ2FjaGVDb25maWcge1xuICBtYXhTaXplOiBudW1iZXI7XG4gIHR0bDogbnVtYmVyOyAvLyBUaW1lIHRvIGxpdmUgaW4gbWlsbGlzZWNvbmRzXG59XG5cbi8qKlxuICogQ2FjaGUgY29uZmlndXJhdGlvbnMgb3B0aW1pemVkIGZvciBwcm9wZXJ0eSBtYW5hZ2VtZW50IHdvcmtsb2Fkcy5cbiAqL1xuY29uc3QgQ0FDSEVfQ09ORklHUzogUmVjb3JkPHN0cmluZywgQ2FjaGVDb25maWc+ID0ge1xuICAvLyBVc2VyIGRhdGEgLSBmcmVxdWVudGx5IGFjY2Vzc2VkLCBtb2RlcmF0ZSBjaGFuZ2VzXG4gIHVzZXJzOiB7IG1heFNpemU6IDEwMDAsIHR0bDogNSAqIDYwICogMTAwMCB9LCAvLyA1IG1pbnV0ZXNcblxuICAvLyBPcmdhbml6YXRpb24gZGF0YSAtIHN0YWJsZSwgaW5mcmVxdWVudCBjaGFuZ2VzXG4gIG9yZ2FuaXphdGlvbnM6IHsgbWF4U2l6ZTogMTAwLCB0dGw6IDMwICogNjAgKiAxMDAwIH0sIC8vIDMwIG1pbnV0ZXNcblxuICAvLyBCdWlsZGluZyBkYXRhIC0gcmVsYXRpdmVseSBzdGFibGVcbiAgYnVpbGRpbmdzOiB7IG1heFNpemU6IDUwMCwgdHRsOiAxNSAqIDYwICogMTAwMCB9LCAvLyAxNSBtaW51dGVzXG5cbiAgLy8gUmVzaWRlbmNlIGRhdGEgLSBzdGFibGUgc3RydWN0dXJlLCBvY2Nhc2lvbmFsIHVwZGF0ZXNcbiAgcmVzaWRlbmNlczogeyBtYXhTaXplOiAyMDAwLCB0dGw6IDEwICogNjAgKiAxMDAwIH0sIC8vIDEwIG1pbnV0ZXNcblxuICAvLyBCaWxscyAtIHRpbWUtc2Vuc2l0aXZlLCBmcmVxdWVudCB1cGRhdGVzXG4gIGJpbGxzOiB7IG1heFNpemU6IDEwMDAsIHR0bDogMiAqIDYwICogMTAwMCB9LCAvLyAyIG1pbnV0ZXNcblxuICAvLyBNYWludGVuYW5jZSByZXF1ZXN0cyAtIGR5bmFtaWMsIGZyZXF1ZW50IHN0YXR1cyBjaGFuZ2VzXG4gIG1haW50ZW5hbmNlOiB7IG1heFNpemU6IDUwMCwgdHRsOiAxICogNjAgKiAxMDAwIH0sIC8vIDEgbWludXRlXG5cbiAgLy8gTm90aWZpY2F0aW9ucyAtIHJlYWwtdGltZSwgc2hvcnQgY2FjaGVcbiAgbm90aWZpY2F0aW9uczogeyBtYXhTaXplOiA1MDAsIHR0bDogMzAgKiAxMDAwIH0sIC8vIDMwIHNlY29uZHNcblxuICAvLyBRdWFsaXR5IG1ldHJpY3MgLSBzdGFibGUgZm9yIHBlcmlvZHNcbiAgbWV0cmljczogeyBtYXhTaXplOiAyMDAsIHR0bDogNSAqIDYwICogMTAwMCB9LCAvLyA1IG1pbnV0ZXNcblxuICAvLyBGZWF0dXJlcyBhbmQgcm9hZG1hcCAtIG1vZGVyYXRlbHkgc3RhYmxlXG4gIGZlYXR1cmVzOiB7IG1heFNpemU6IDMwMCwgdHRsOiAzICogNjAgKiAxMDAwIH0sIC8vIDMgbWludXRlc1xuXG4gIC8vIEZyYW1ld29yayBjb25maWd1cmF0aW9uIC0gdmVyeSBzdGFibGVcbiAgY29uZmlnOiB7IG1heFNpemU6IDEwMCwgdHRsOiA2MCAqIDYwICogMTAwMCB9LCAvLyAxIGhvdXJcblxuICAvLyBCdWcgcmVwb3J0cyAtIG1vZGVyYXRlIGNoYW5nZXMsIHVzZXItc3BlY2lmaWNcbiAgYnVnczogeyBtYXhTaXplOiA1MDAsIHR0bDogMiAqIDYwICogMTAwMCB9LCAvLyAyIG1pbnV0ZXNcbn07XG5cbi8qKlxuICogQ2FjaGUgaW5zdGFuY2VzIGZvciBkaWZmZXJlbnQgZGF0YSB0eXBlcy5cbiAqL1xuY2xhc3MgUXVlcnlDYWNoZU1hbmFnZXIge1xuICBwcml2YXRlIGNhY2hlczogTWFwPHN0cmluZywgTFJVQ2FjaGU8c3RyaW5nLCBhbnk+PiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBoaXRDb3VudHM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgbWlzc0NvdW50czogTWFwPHN0cmluZywgbnVtYmVyPiA9IG5ldyBNYXAoKTtcblxuICAvKipcbiAgICpcbiAgICovXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIEluaXRpYWxpemUgY2FjaGVzIGZvciBlYWNoIGRhdGEgdHlwZVxuICAgIE9iamVjdC5lbnRyaWVzKENBQ0hFX0NPTkZJR1MpLmZvckVhY2goKFt0eXBlLCBjb25maWddKSA9PiB7XG4gICAgICB0aGlzLmNhY2hlcy5zZXQoXG4gICAgICAgIHR5cGUsXG4gICAgICAgIG5ldyBMUlVDYWNoZSh7XG4gICAgICAgICAgbWF4OiBjb25maWcubWF4U2l6ZSxcbiAgICAgICAgICB0dGw6IGNvbmZpZy50dGwsXG4gICAgICAgICAgdXBkYXRlQWdlT25HZXQ6IHRydWUsXG4gICAgICAgICAgdXBkYXRlQWdlT25IYXM6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgICAgdGhpcy5oaXRDb3VudHMuc2V0KHR5cGUsIDApO1xuICAgICAgdGhpcy5taXNzQ291bnRzLnNldCh0eXBlLCAwKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGNhY2hlZCBkYXRhIGlmIGF2YWlsYWJsZS5cbiAgICogQHBhcmFtIGNhY2hlVHlwZSBUeXBlIG9mIGNhY2hlICh1c2VycywgYnVpbGRpbmdzLCBldGMuKS5cbiAgICogQHBhcmFtIGtleSBDYWNoZSBrZXkuXG4gICAqIEBwYXJhbSBfa2V5XG4gICAqIEByZXR1cm5zIENhY2hlZCBkYXRhIG9yIHVuZGVmaW5lZC5cbiAgICovXG4gIGdldDxUPihjYWNoZVR5cGU6IHN0cmluZywgX2tleTogc3RyaW5nKTogVCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlcy5nZXQoY2FjaGVUeXBlKTtcbiAgICBpZiAoIWNhY2hlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGNhY2hlLmdldChfa2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuaGl0Q291bnRzLnNldChjYWNoZVR5cGUsICh0aGlzLmhpdENvdW50cy5nZXQoY2FjaGVUeXBlKSB8fCAwKSArIDEpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICB0aGlzLm1pc3NDb3VudHMuc2V0KGNhY2hlVHlwZSwgKHRoaXMubWlzc0NvdW50cy5nZXQoY2FjaGVUeXBlKSB8fCAwKSArIDEpO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICAvKipcbiAgICogU3RvcmVzIGRhdGEgaW4gY2FjaGUuXG4gICAqIEBwYXJhbSBjYWNoZVR5cGUgVHlwZSBvZiBjYWNoZS5cbiAgICogQHBhcmFtIGtleSBDYWNoZSBrZXkuXG4gICAqIEBwYXJhbSBkYXRhIERhdGEgdG8gY2FjaGUuXG4gICAqIEBwYXJhbSBfa2V5XG4gICAqIEBwYXJhbSBfZGF0YVxuICAgKi9cbiAgc2V0PFQ+KGNhY2hlVHlwZTogc3RyaW5nLCBfa2V5OiBzdHJpbmcsIF9kYXRhOiBUKTogdm9pZCB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlcy5nZXQoY2FjaGVUeXBlKTtcbiAgICBpZiAoIWNhY2hlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY2FjaGUuc2V0KF9rZXksIF9kYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlcyBjYWNoZSBlbnRyaWVzIGJ5IHBhdHRlcm4uXG4gICAqIEBwYXJhbSBjYWNoZVR5cGUgVHlwZSBvZiBjYWNoZS5cbiAgICogQHBhcmFtIHBhdHRlcm4gS2V5IHBhdHRlcm4gdG8gaW52YWxpZGF0ZSAoc3VwcG9ydHMgd2lsZGNhcmRzKS5cbiAgICovXG4gIGludmFsaWRhdGUoY2FjaGVUeXBlOiBzdHJpbmcsIHBhdHRlcm4/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVzLmdldChjYWNoZVR5cGUpO1xuICAgIGlmICghY2FjaGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAocGF0dGVybikge1xuICAgICAgLy8gUmVtb3ZlIGVudHJpZXMgbWF0Y2hpbmcgcGF0dGVyblxuICAgICAgZm9yIChjb25zdCBrZXkgb2YgY2FjaGUua2V5cygpKSB7XG4gICAgICAgIGlmICh0aGlzLm1hdGNoZXNQYXR0ZXJuKGtleSwgcGF0dGVybikpIHtcbiAgICAgICAgICBjYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDbGVhciBlbnRpcmUgY2FjaGVcbiAgICAgIGNhY2hlLmNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgY2FjaGUgcGVyZm9ybWFuY2Ugc3RhdGlzdGljcy5cbiAgICovXG4gIGdldFN0YXRzKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IHN0YXRzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IFtfdHlwZSwgY2FjaGVdIG9mIHRoaXMuY2FjaGVzKSB7XG4gICAgICBjb25zdCBoaXRzID0gdGhpcy5oaXRDb3VudHMuZ2V0KF90eXBlKSB8fCAwO1xuICAgICAgY29uc3QgbWlzc2VzID0gdGhpcy5taXNzQ291bnRzLmdldChfdHlwZSkgfHwgMDtcbiAgICAgIGNvbnN0IHRvdGFsID0gaGl0cyArIG1pc3NlcztcbiAgICAgIGNvbnN0IGhpdFJhdGUgPSB0b3RhbCA+IDAgPyAoKGhpdHMgLyB0b3RhbCkgKiAxMDApLnRvRml4ZWQoMikgOiAnMC4wMCc7XG5cbiAgICAgIHN0YXRzW190eXBlXSA9IHtcbiAgICAgICAgc2l6ZTogY2FjaGUuc2l6ZSxcbiAgICAgICAgbWF4U2l6ZTogY2FjaGUubWF4LFxuICAgICAgICBoaXRzLFxuICAgICAgICBtaXNzZXMsXG4gICAgICAgIGhpdFJhdGU6IGAke2hpdFJhdGV9JWAsXG4gICAgICAgIG1lbW9yeVVzYWdlOiB0aGlzLmVzdGltYXRlTWVtb3J5VXNhZ2UoY2FjaGUpLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdHM7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIGFsbCBjYWNoZXMuXG4gICAqL1xuICBjbGVhckFsbCgpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IFtfdHlwZSwgY2FjaGVdIG9mIHRoaXMuY2FjaGVzKSB7XG4gICAgICBjYWNoZS5jbGVhcigpO1xuICAgICAgdGhpcy5oaXRDb3VudHMuc2V0KF90eXBlLCAwKTtcbiAgICAgIHRoaXMubWlzc0NvdW50cy5zZXQoX3R5cGUsIDApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQYXR0ZXJuIG1hdGNoaW5nIGZvciBjYWNoZSBrZXkgaW52YWxpZGF0aW9uLlxuICAgKiBAcGFyYW0ga2V5XG4gICAqIEBwYXJhbSBfa2V5XG4gICAqIEBwYXJhbSBwYXR0ZXJuXG4gICAqL1xuICBwcml2YXRlIG1hdGNoZXNQYXR0ZXJuKF9rZXk6IHN0cmluZywgcGF0dGVybjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHBhdHRlcm4ucmVwbGFjZSgvXFwqL2csICcuKicpKTtcbiAgICByZXR1cm4gcmVnZXgudGVzdChfa2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFc3RpbWF0ZXMgbWVtb3J5IHVzYWdlIG9mIGEgY2FjaGUuXG4gICAqIEBwYXJhbSBjYWNoZVxuICAgKi9cbiAgcHJpdmF0ZSBlc3RpbWF0ZU1lbW9yeVVzYWdlKGNhY2hlOiBMUlVDYWNoZTxzdHJpbmcsIGFueT4pOiBzdHJpbmcge1xuICAgIGxldCB0b3RhbFNpemUgPSAwO1xuICAgIGZvciAoY29uc3QgdmFsdWUgb2YgY2FjaGUudmFsdWVzKCkpIHtcbiAgICAgIHRvdGFsU2l6ZSArPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSkubGVuZ3RoICogMjsgLy8gUm91Z2ggZXN0aW1hdGVcbiAgICB9XG4gICAgcmV0dXJuIGAkeyh0b3RhbFNpemUgLyAxMDI0KS50b0ZpeGVkKDIpfSBLQmA7XG4gIH1cbn1cblxuLyoqXG4gKiBHbG9iYWwgY2FjaGUgbWFuYWdlciBpbnN0YW5jZS5cbiAqL1xuZXhwb3J0IGNvbnN0IHF1ZXJ5Q2FjaGUgPSBuZXcgUXVlcnlDYWNoZU1hbmFnZXIoKTtcblxuLyoqXG4gKiBDYWNoZWQgcXVlcnkgaGVscGVyIGZ1bmN0aW9uIGZvciBkYXRhYmFzZSBvcGVyYXRpb25zLlxuICogUmVwbGFjZXMgZGVjb3JhdG9yIGFwcHJvYWNoIGZvciBiZXR0ZXIgY29tcGF0aWJpbGl0eS5cbiAqIEBwYXJhbSBjYWNoZVR5cGVcbiAqIEBwYXJhbSBjYWNoZUtleVxuICogQHBhcmFtIG9wZXJhdGlvblxuICovXG4vKipcbiAqIFdpdGhDYWNoZSBmdW5jdGlvbi5cbiAqIEBwYXJhbSBjYWNoZVR5cGVcbiAqIEBwYXJhbSBjYWNoZUtleVxuICogQHBhcmFtIG9wZXJhdGlvblxuICogQHJldHVybnMgRnVuY3Rpb24gcmVzdWx0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gd2l0aENhY2hlPFQ+KFxuICBjYWNoZVR5cGU6IHN0cmluZyxcbiAgY2FjaGVLZXk6IHN0cmluZyxcbiAgb3BlcmF0aW9uOiAoKSA9PiBQcm9taXNlPFQ+XG4pOiBQcm9taXNlPFQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVHJ5IHRvIGdldCBmcm9tIGNhY2hlIGZpcnN0XG4gICAgICBjb25zdCBjYWNoZWQgPSBxdWVyeUNhY2hlLmdldDxUPihjYWNoZVR5cGUsIGNhY2hlS2V5KTtcbiAgICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXNvbHZlKGNhY2hlZCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gRXhlY3V0ZSBvcGVyYXRpb25cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9wZXJhdGlvbigpO1xuXG4gICAgICAvLyBDYWNoZSB0aGUgcmVzdWx0XG4gICAgICBxdWVyeUNhY2hlLnNldChjYWNoZVR5cGUsIGNhY2hlS2V5LCByZXN1bHQpO1xuXG4gICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIENhY2hlIGludmFsaWRhdGlvbiB1dGlsaXRpZXMgZm9yIHNwZWNpZmljIG9wZXJhdGlvbnMuXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZUludmFsaWRhdG9yIHtcbiAgLyoqXG4gICAqIEludmFsaWRhdGVzIHVzZXItcmVsYXRlZCBjYWNoZXMgd2hlbiB1c2VyIGRhdGEgY2hhbmdlcy5cbiAgICogQHBhcmFtIHVzZXJJZFxuICAgKi9cbiAgc3RhdGljIGludmFsaWRhdGVVc2VyQ2FjaGVzKHVzZXJJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgcXVlcnlDYWNoZS5pbnZhbGlkYXRlKCd1c2VycycsIGB1c2VyOiR7dXNlcklkfSpgKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ3Jlc2lkZW5jZXMnLCBgdXNlcl9yZXNpZGVuY2VzOiR7dXNlcklkfSpgKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ25vdGlmaWNhdGlvbnMnLCBgdXNlcl9ub3RpZmljYXRpb25zOiR7dXNlcklkfSpgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlcyBidWlsZGluZy1yZWxhdGVkIGNhY2hlcyB3aGVuIGJ1aWxkaW5nIGRhdGEgY2hhbmdlcy5cbiAgICogQHBhcmFtIGJ1aWxkaW5nSWRcbiAgICovXG4gIHN0YXRpYyBpbnZhbGlkYXRlQnVpbGRpbmdDYWNoZXMoYnVpbGRpbmdJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgcXVlcnlDYWNoZS5pbnZhbGlkYXRlKCdidWlsZGluZ3MnLCBgYnVpbGRpbmc6JHtidWlsZGluZ0lkfSpgKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ3Jlc2lkZW5jZXMnLCBgYnVpbGRpbmdfcmVzaWRlbmNlczoke2J1aWxkaW5nSWR9KmApO1xuICAgIHF1ZXJ5Q2FjaGUuaW52YWxpZGF0ZSgnYnVkZ2V0cycsIGBidWlsZGluZ19idWRnZXRzOiR7YnVpbGRpbmdJZH0qYCk7XG4gIH1cblxuICAvKipcbiAgICogSW52YWxpZGF0ZXMgcmVzaWRlbmNlLXJlbGF0ZWQgY2FjaGVzIHdoZW4gcmVzaWRlbmNlIGRhdGEgY2hhbmdlcy5cbiAgICogQHBhcmFtIHJlc2lkZW5jZUlkXG4gICAqL1xuICBzdGF0aWMgaW52YWxpZGF0ZVJlc2lkZW5jZUNhY2hlcyhyZXNpZGVuY2VJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgcXVlcnlDYWNoZS5pbnZhbGlkYXRlKCdyZXNpZGVuY2VzJywgYHJlc2lkZW5jZToke3Jlc2lkZW5jZUlkfSpgKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ2JpbGxzJywgYHJlc2lkZW5jZV9iaWxsczoke3Jlc2lkZW5jZUlkfSpgKTtcbiAgICBxdWVyeUNhY2hlLmludmFsaWRhdGUoJ21haW50ZW5hbmNlJywgYHJlc2lkZW5jZV9tYWludGVuYW5jZToke3Jlc2lkZW5jZUlkfSpgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlcyBhbGwgY2FjaGVzICh1c2Ugc3BhcmluZ2x5KS5cbiAgICovXG4gIHN0YXRpYyBpbnZhbGlkYXRlQWxsKCk6IHZvaWQge1xuICAgIHF1ZXJ5Q2FjaGUuY2xlYXJBbGwoKTtcbiAgfVxufVxuXG4vKipcbiAqIFBlcmZvcm1hbmNlIG1vbml0b3JpbmcgZm9yIGNhY2hlIGVmZmVjdGl2ZW5lc3MuXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZU1vbml0b3Ige1xuICAvKipcbiAgICogTG9ncyBjYWNoZSBwZXJmb3JtYW5jZSBzdGF0aXN0aWNzLlxuICAgKi9cbiAgc3RhdGljIGxvZ1BlcmZvcm1hbmNlU3RhdHMoKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdHMgPSBxdWVyeUNhY2hlLmdldFN0YXRzKCk7XG4gICAgY29uc29sZS50YWJsZShzdGF0cyk7XG4gIH1cblxuICAvKipcbiAgICogTW9uaXRvcnMgY2FjaGUgaGl0IHJhdGVzIGFuZCBzdWdnZXN0cyBvcHRpbWl6YXRpb25zLlxuICAgKi9cbiAgc3RhdGljIGFuYWx5emVQZXJmb3JtYW5jZSgpOiBzdHJpbmdbXSB7XG4gICAgY29uc3Qgc3RhdHMgPSBxdWVyeUNhY2hlLmdldFN0YXRzKCk7XG4gICAgY29uc3Qgc3VnZ2VzdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBPYmplY3QuZW50cmllcyhzdGF0cykuZm9yRWFjaCgoW2NhY2hlVHlwZSwgc3RhdF0pID0+IHtcbiAgICAgIGNvbnN0IGhpdFJhdGUgPSBwYXJzZUZsb2F0KHN0YXQuaGl0UmF0ZS5yZXBsYWNlKCclJywgJycpKTtcblxuICAgICAgaWYgKGhpdFJhdGUgPCA1MCkge1xuICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKFxuICAgICAgICAgIGBMb3cgaGl0IHJhdGUgZm9yICR7Y2FjaGVUeXBlfSBjYWNoZSAoJHtzdGF0LmhpdFJhdGV9KS4gQ29uc2lkZXIgaW5jcmVhc2luZyBUVEwgb3IgY2FjaGUgc2l6ZS5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChzdGF0LnNpemUgPT09IHN0YXQubWF4U2l6ZSkge1xuICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKFxuICAgICAgICAgIGAke2NhY2hlVHlwZX0gY2FjaGUgaXMgYXQgbWF4aW11bSBjYXBhY2l0eS4gQ29uc2lkZXIgaW5jcmVhc2luZyBtYXggc2l6ZS5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gc3VnZ2VzdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBtZW1vcnkgdXNhZ2Ugc3VtbWFyeSBmb3IgYWxsIGNhY2hlcy5cbiAgICovXG4gIHN0YXRpYyBnZXRNZW1vcnlVc2FnZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHN0YXRzID0gcXVlcnlDYWNoZS5nZXRTdGF0cygpO1xuICAgIGxldCB0b3RhbE1lbW9yeSA9IDA7XG5cbiAgICBPYmplY3QudmFsdWVzKHN0YXRzKS5mb3JFYWNoKChzdGF0OiBhbnkpID0+IHtcbiAgICAgIHRvdGFsTWVtb3J5ICs9IHBhcnNlRmxvYXQoc3RhdC5tZW1vcnlVc2FnZS5yZXBsYWNlKCcgS0InLCAnJykpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGAke3RvdGFsTWVtb3J5LnRvRml4ZWQoMil9IEtCYDtcbiAgfVxufVxuXG4vKipcbiAqIEF1dG9tYXRpYyBjYWNoZSB3YXJtaW5nIGZvciBmcmVxdWVudGx5IGFjY2Vzc2VkIGRhdGEuXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZVdhcm1lciB7XG4gIC8qKlxuICAgKiBXYXJtcyB1cCBjYWNoZXMgd2l0aCBmcmVxdWVudGx5IGFjY2Vzc2VkIGRhdGEuXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgd2FybUNhY2hlcygpOiBQcm9taXNlPHZvaWQ+IHtcblxuICAgIHRyeSB7XG4gICAgICAvLyBUaGlzIHdvdWxkIGJlIGltcGxlbWVudGVkIHdpdGggYWN0dWFsIGRhdGFiYXNlIGNhbGxzXG4gICAgICAvLyBFeGFtcGxlOiBQcmUtbG9hZCBhY3RpdmUgdXNlcnMsIG9yZ2FuaXphdGlvbnMsIGV0Yy5cbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3Igd2FybWluZyBjYWNoZXM6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEV4cG9ydCBjYWNoZSB1dGlsaXRpZXMgZm9yIGVhc3kgYWNjZXNzLlxuICovXG5leHBvcnQgeyBxdWVyeUNhY2hlIGFzIGRlZmF1bHQsIFF1ZXJ5Q2FjaGVNYW5hZ2VyLCBDQUNIRV9DT05GSUdTIH07XG4iXSwidmVyc2lvbiI6M30=