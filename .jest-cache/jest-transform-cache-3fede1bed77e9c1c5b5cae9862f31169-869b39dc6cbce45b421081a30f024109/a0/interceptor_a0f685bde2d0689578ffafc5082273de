d731083b1f1eccdef5acba0630339696
'use strict';
var isElementType = require('../utils/misc/isElementType.js');
require('../utils/dataTransfer/Clipboard.js');
var trackValue = require('./trackValue.js');
var UI = require('./UI.js');
const Interceptor = Symbol('Interceptor for programmatical calls');
function prepareInterceptor(element, propName, interceptorImpl) {
    const prototypeDescriptor = Object.getOwnPropertyDescriptor(element.constructor.prototype, propName);
    const objectDescriptor = Object.getOwnPropertyDescriptor(element, propName);
    const target = (prototypeDescriptor === null || prototypeDescriptor === undefined ? undefined : prototypeDescriptor.set) ? 'set' : 'value';
    /* istanbul ignore if */ if (typeof (prototypeDescriptor === null || prototypeDescriptor === undefined ? undefined : prototypeDescriptor[target]) !== 'function' || prototypeDescriptor[target][Interceptor]) {
        throw new Error(`Element ${element.tagName} does not implement "${String(propName)}".`);
    }
    function intercept(...args) {
        const { applyNative = false, realArgs, then } = interceptorImpl.call(this, ...args);
        const realFunc = (!applyNative && objectDescriptor || prototypeDescriptor)[target];
        if (target === 'set') {
            realFunc.call(this, realArgs);
        }
        else {
            realFunc.call(this, ...realArgs);
        }
        then === null || then === undefined ? undefined : then();
    }
    intercept[Interceptor] = Interceptor;
    Object.defineProperty(element, propName, {
        ...objectDescriptor !== null && objectDescriptor !== undefined ? objectDescriptor : prototypeDescriptor,
        [target]: intercept
    });
}
function prepareValueInterceptor(element) {
    prepareInterceptor(element, 'value', function interceptorImpl(v) {
        const isUI = UI.isUIValue(v);
        if (isUI) {
            trackValue.startTrackValue(this);
        }
        return {
            applyNative: !!isUI,
            realArgs: sanitizeValue(this, v),
            then: isUI ? undefined : () => trackValue.trackOrSetValue(this, String(v))
        };
    });
}
function sanitizeValue(element, v) {
    // Workaround for JSDOM
    if (isElementType.isElementType(element, 'input', {
        type: 'number'
    }) && String(v) !== '' && !Number.isNaN(Number(v))) {
        // Setting value to "1." results in `null` in JSDOM
        return String(Number(v));
    }
    return String(v);
}
function prepareSelectionInterceptor(element) {
    prepareInterceptor(element, 'setSelectionRange', function interceptorImpl(start, ...others) {
        const isUI = UI.isUISelectionStart(start);
        return {
            applyNative: !!isUI,
            realArgs: [
                Number(start),
                ...others
            ],
            then: () => isUI ? undefined : UI.setUISelectionClean(element)
        };
    });
    prepareInterceptor(element, 'selectionStart', function interceptorImpl(v) {
        return {
            realArgs: v,
            then: () => UI.setUISelectionClean(element)
        };
    });
    prepareInterceptor(element, 'selectionEnd', function interceptorImpl(v) {
        return {
            realArgs: v,
            then: () => UI.setUISelectionClean(element)
        };
    });
    prepareInterceptor(element, 'select', function interceptorImpl() {
        return {
            realArgs: [],
            then: () => UI.setUISelectionRaw(element, {
                anchorOffset: 0,
                focusOffset: UI.getUIValue(element).length
            })
        };
    });
}
function prepareRangeTextInterceptor(element) {
    prepareInterceptor(element, 'setRangeText', function interceptorImpl(...realArgs) {
        return {
            realArgs,
            then: () => {
                UI.setUIValueClean(element);
                UI.setUISelectionClean(element);
            }
        };
    });
}
exports.prepareInterceptor = prepareInterceptor;
exports.prepareRangeTextInterceptor = prepareRangeTextInterceptor;
exports.prepareSelectionInterceptor = prepareSelectionInterceptor;
exports.prepareValueInterceptor = prepareValueInterceptor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9ub2RlX21vZHVsZXMvQHRlc3RpbmctbGlicmFyeS91c2VyLWV2ZW50L2Rpc3QvY2pzL2RvY3VtZW50L2ludGVyY2VwdG9yLmpzIiwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQzlELE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQzlDLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUU1QixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsc0NBQXNDLENBQUMsQ0FBQztBQUNuRSxTQUFTLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsZUFBZTtJQUMxRCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNyRyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUUsTUFBTSxNQUFNLEdBQUcsQ0FBQyxtQkFBbUIsS0FBSyxJQUFJLElBQUksbUJBQW1CLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUMzSSx3QkFBd0IsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsS0FBSyxJQUFJLElBQUksbUJBQW1CLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssVUFBVSxJQUFJLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7UUFDM00sTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sQ0FBQyxPQUFPLHdCQUF3QixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVGLENBQUM7SUFDRCxTQUFTLFNBQVMsQ0FBQyxHQUFHLElBQUk7UUFDdEIsTUFBTSxFQUFFLFdBQVcsR0FBRyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDcEYsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLFdBQVcsSUFBSSxnQkFBZ0IsSUFBSSxtQkFBbUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25GLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRSxDQUFDO1lBQ25CLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xDLENBQUM7YUFBTSxDQUFDO1lBQ0osUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQztRQUNyQyxDQUFDO1FBQ0QsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzdELENBQUM7SUFDRCxTQUFTLENBQUMsV0FBVyxDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQ3JDLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRTtRQUNyQyxHQUFHLGdCQUFnQixLQUFLLElBQUksSUFBSSxnQkFBZ0IsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxtQkFBbUI7UUFDdkcsQ0FBQyxNQUFNLENBQUMsRUFBRSxTQUFTO0tBQ3RCLENBQUMsQ0FBQztBQUNQLENBQUM7QUFDRCxTQUFTLHVCQUF1QixDQUFDLE9BQU87SUFDcEMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLGVBQWUsQ0FBQyxDQUFDO1FBQzNELE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0IsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNQLFVBQVUsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsQ0FBQztRQUNELE9BQU87WUFDSCxXQUFXLEVBQUUsQ0FBQyxDQUFDLElBQUk7WUFDbkIsUUFBUSxFQUFFLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRSxFQUFFLENBQUEsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNFLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFDRCxTQUFTLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM3Qix1QkFBdUI7SUFDdkIsSUFBSSxhQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUU7UUFDOUMsSUFBSSxFQUFFLFFBQVE7S0FDakIsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDakQsbURBQW1EO1FBQ25ELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQixDQUFDO0FBQ0QsU0FBUywyQkFBMkIsQ0FBQyxPQUFPO0lBQ3hDLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxTQUFTLGVBQWUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxNQUFNO1FBQ3RGLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQyxPQUFPO1lBQ0gsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJO1lBQ25CLFFBQVEsRUFBRTtnQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUNiLEdBQUcsTUFBTTthQUNaO1lBQ0QsSUFBSSxFQUFFLEdBQUUsRUFBRSxDQUFBLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDO1NBQy9ELENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztJQUNILGtCQUFrQixDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLGVBQWUsQ0FBQyxDQUFDO1FBQ3BFLE9BQU87WUFDSCxRQUFRLEVBQUUsQ0FBQztZQUNYLElBQUksRUFBRSxHQUFFLEVBQUUsQ0FBQSxFQUFFLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDO1NBQzVDLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztJQUNILGtCQUFrQixDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsU0FBUyxlQUFlLENBQUMsQ0FBQztRQUNsRSxPQUFPO1lBQ0gsUUFBUSxFQUFFLENBQUM7WUFDWCxJQUFJLEVBQUUsR0FBRSxFQUFFLENBQUEsRUFBRSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQztTQUM1QyxDQUFDO0lBQ04sQ0FBQyxDQUFDLENBQUM7SUFDSCxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsZUFBZTtRQUMxRCxPQUFPO1lBQ0gsUUFBUSxFQUFFLEVBQUU7WUFDWixJQUFJLEVBQUUsR0FBRSxFQUFFLENBQUEsRUFBRSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sRUFBRTtnQkFDaEMsWUFBWSxFQUFFLENBQUM7Z0JBQ2YsV0FBVyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTTthQUM3QyxDQUFDO1NBQ1QsQ0FBQztJQUNOLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUNELFNBQVMsMkJBQTJCLENBQUMsT0FBTztJQUN4QyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsY0FBYyxFQUFFLFNBQVMsZUFBZSxDQUFDLEdBQUcsUUFBUTtRQUM1RSxPQUFPO1lBQ0gsUUFBUTtZQUNSLElBQUksRUFBRSxHQUFFLEVBQUU7Z0JBQ04sRUFBRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDNUIsRUFBRSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3BDLENBQUM7U0FDSixDQUFDO0lBQ04sQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsT0FBTyxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDO0FBQ2hELE9BQU8sQ0FBQywyQkFBMkIsR0FBRywyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLENBQUMsMkJBQTJCLEdBQUcsMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxDQUFDLHVCQUF1QixHQUFHLHVCQUF1QixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2Uvbm9kZV9tb2R1bGVzL0B0ZXN0aW5nLWxpYnJhcnkvdXNlci1ldmVudC9kaXN0L2Nqcy9kb2N1bWVudC9pbnRlcmNlcHRvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBpc0VsZW1lbnRUeXBlID0gcmVxdWlyZSgnLi4vdXRpbHMvbWlzYy9pc0VsZW1lbnRUeXBlLmpzJyk7XG5yZXF1aXJlKCcuLi91dGlscy9kYXRhVHJhbnNmZXIvQ2xpcGJvYXJkLmpzJyk7XG52YXIgdHJhY2tWYWx1ZSA9IHJlcXVpcmUoJy4vdHJhY2tWYWx1ZS5qcycpO1xudmFyIFVJID0gcmVxdWlyZSgnLi9VSS5qcycpO1xuXG5jb25zdCBJbnRlcmNlcHRvciA9IFN5bWJvbCgnSW50ZXJjZXB0b3IgZm9yIHByb2dyYW1tYXRpY2FsIGNhbGxzJyk7XG5mdW5jdGlvbiBwcmVwYXJlSW50ZXJjZXB0b3IoZWxlbWVudCwgcHJvcE5hbWUsIGludGVyY2VwdG9ySW1wbCkge1xuICAgIGNvbnN0IHByb3RvdHlwZURlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGVsZW1lbnQuY29uc3RydWN0b3IucHJvdG90eXBlLCBwcm9wTmFtZSk7XG4gICAgY29uc3Qgb2JqZWN0RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZWxlbWVudCwgcHJvcE5hbWUpO1xuICAgIGNvbnN0IHRhcmdldCA9IChwcm90b3R5cGVEZXNjcmlwdG9yID09PSBudWxsIHx8IHByb3RvdHlwZURlc2NyaXB0b3IgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHByb3RvdHlwZURlc2NyaXB0b3Iuc2V0KSA/ICdzZXQnIDogJ3ZhbHVlJztcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8gaWYgKHR5cGVvZiAocHJvdG90eXBlRGVzY3JpcHRvciA9PT0gbnVsbCB8fCBwcm90b3R5cGVEZXNjcmlwdG9yID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBwcm90b3R5cGVEZXNjcmlwdG9yW3RhcmdldF0pICE9PSAnZnVuY3Rpb24nIHx8IHByb3RvdHlwZURlc2NyaXB0b3JbdGFyZ2V0XVtJbnRlcmNlcHRvcl0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFbGVtZW50ICR7ZWxlbWVudC50YWdOYW1lfSBkb2VzIG5vdCBpbXBsZW1lbnQgXCIke1N0cmluZyhwcm9wTmFtZSl9XCIuYCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGludGVyY2VwdCguLi5hcmdzKSB7XG4gICAgICAgIGNvbnN0IHsgYXBwbHlOYXRpdmUgPSBmYWxzZSwgcmVhbEFyZ3MsIHRoZW4gfSA9IGludGVyY2VwdG9ySW1wbC5jYWxsKHRoaXMsIC4uLmFyZ3MpO1xuICAgICAgICBjb25zdCByZWFsRnVuYyA9ICghYXBwbHlOYXRpdmUgJiYgb2JqZWN0RGVzY3JpcHRvciB8fCBwcm90b3R5cGVEZXNjcmlwdG9yKVt0YXJnZXRdO1xuICAgICAgICBpZiAodGFyZ2V0ID09PSAnc2V0Jykge1xuICAgICAgICAgICAgcmVhbEZ1bmMuY2FsbCh0aGlzLCByZWFsQXJncyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWFsRnVuYy5jYWxsKHRoaXMsIC4uLnJlYWxBcmdzKTtcbiAgICAgICAgfVxuICAgICAgICB0aGVuID09PSBudWxsIHx8IHRoZW4gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHRoZW4oKTtcbiAgICB9XG4gICAgaW50ZXJjZXB0W0ludGVyY2VwdG9yXSA9IEludGVyY2VwdG9yO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCBwcm9wTmFtZSwge1xuICAgICAgICAuLi5vYmplY3REZXNjcmlwdG9yICE9PSBudWxsICYmIG9iamVjdERlc2NyaXB0b3IgIT09IHVuZGVmaW5lZCA/IG9iamVjdERlc2NyaXB0b3IgOiBwcm90b3R5cGVEZXNjcmlwdG9yLFxuICAgICAgICBbdGFyZ2V0XTogaW50ZXJjZXB0XG4gICAgfSk7XG59XG5mdW5jdGlvbiBwcmVwYXJlVmFsdWVJbnRlcmNlcHRvcihlbGVtZW50KSB7XG4gICAgcHJlcGFyZUludGVyY2VwdG9yKGVsZW1lbnQsICd2YWx1ZScsIGZ1bmN0aW9uIGludGVyY2VwdG9ySW1wbCh2KSB7XG4gICAgICAgIGNvbnN0IGlzVUkgPSBVSS5pc1VJVmFsdWUodik7XG4gICAgICAgIGlmIChpc1VJKSB7XG4gICAgICAgICAgICB0cmFja1ZhbHVlLnN0YXJ0VHJhY2tWYWx1ZSh0aGlzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYXBwbHlOYXRpdmU6ICEhaXNVSSxcbiAgICAgICAgICAgIHJlYWxBcmdzOiBzYW5pdGl6ZVZhbHVlKHRoaXMsIHYpLFxuICAgICAgICAgICAgdGhlbjogaXNVSSA/IHVuZGVmaW5lZCA6ICgpPT50cmFja1ZhbHVlLnRyYWNrT3JTZXRWYWx1ZSh0aGlzLCBTdHJpbmcodikpXG4gICAgICAgIH07XG4gICAgfSk7XG59XG5mdW5jdGlvbiBzYW5pdGl6ZVZhbHVlKGVsZW1lbnQsIHYpIHtcbiAgICAvLyBXb3JrYXJvdW5kIGZvciBKU0RPTVxuICAgIGlmIChpc0VsZW1lbnRUeXBlLmlzRWxlbWVudFR5cGUoZWxlbWVudCwgJ2lucHV0Jywge1xuICAgICAgICB0eXBlOiAnbnVtYmVyJ1xuICAgIH0pICYmIFN0cmluZyh2KSAhPT0gJycgJiYgIU51bWJlci5pc05hTihOdW1iZXIodikpKSB7XG4gICAgICAgIC8vIFNldHRpbmcgdmFsdWUgdG8gXCIxLlwiIHJlc3VsdHMgaW4gYG51bGxgIGluIEpTRE9NXG4gICAgICAgIHJldHVybiBTdHJpbmcoTnVtYmVyKHYpKTtcbiAgICB9XG4gICAgcmV0dXJuIFN0cmluZyh2KTtcbn1cbmZ1bmN0aW9uIHByZXBhcmVTZWxlY3Rpb25JbnRlcmNlcHRvcihlbGVtZW50KSB7XG4gICAgcHJlcGFyZUludGVyY2VwdG9yKGVsZW1lbnQsICdzZXRTZWxlY3Rpb25SYW5nZScsIGZ1bmN0aW9uIGludGVyY2VwdG9ySW1wbChzdGFydCwgLi4ub3RoZXJzKSB7XG4gICAgICAgIGNvbnN0IGlzVUkgPSBVSS5pc1VJU2VsZWN0aW9uU3RhcnQoc3RhcnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYXBwbHlOYXRpdmU6ICEhaXNVSSxcbiAgICAgICAgICAgIHJlYWxBcmdzOiBbXG4gICAgICAgICAgICAgICAgTnVtYmVyKHN0YXJ0KSxcbiAgICAgICAgICAgICAgICAuLi5vdGhlcnNcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB0aGVuOiAoKT0+aXNVSSA/IHVuZGVmaW5lZCA6IFVJLnNldFVJU2VsZWN0aW9uQ2xlYW4oZWxlbWVudClcbiAgICAgICAgfTtcbiAgICB9KTtcbiAgICBwcmVwYXJlSW50ZXJjZXB0b3IoZWxlbWVudCwgJ3NlbGVjdGlvblN0YXJ0JywgZnVuY3Rpb24gaW50ZXJjZXB0b3JJbXBsKHYpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJlYWxBcmdzOiB2LFxuICAgICAgICAgICAgdGhlbjogKCk9PlVJLnNldFVJU2VsZWN0aW9uQ2xlYW4oZWxlbWVudClcbiAgICAgICAgfTtcbiAgICB9KTtcbiAgICBwcmVwYXJlSW50ZXJjZXB0b3IoZWxlbWVudCwgJ3NlbGVjdGlvbkVuZCcsIGZ1bmN0aW9uIGludGVyY2VwdG9ySW1wbCh2KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZWFsQXJnczogdixcbiAgICAgICAgICAgIHRoZW46ICgpPT5VSS5zZXRVSVNlbGVjdGlvbkNsZWFuKGVsZW1lbnQpXG4gICAgICAgIH07XG4gICAgfSk7XG4gICAgcHJlcGFyZUludGVyY2VwdG9yKGVsZW1lbnQsICdzZWxlY3QnLCBmdW5jdGlvbiBpbnRlcmNlcHRvckltcGwoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZWFsQXJnczogW10sXG4gICAgICAgICAgICB0aGVuOiAoKT0+VUkuc2V0VUlTZWxlY3Rpb25SYXcoZWxlbWVudCwge1xuICAgICAgICAgICAgICAgICAgICBhbmNob3JPZmZzZXQ6IDAsXG4gICAgICAgICAgICAgICAgICAgIGZvY3VzT2Zmc2V0OiBVSS5nZXRVSVZhbHVlKGVsZW1lbnQpLmxlbmd0aFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIH07XG4gICAgfSk7XG59XG5mdW5jdGlvbiBwcmVwYXJlUmFuZ2VUZXh0SW50ZXJjZXB0b3IoZWxlbWVudCkge1xuICAgIHByZXBhcmVJbnRlcmNlcHRvcihlbGVtZW50LCAnc2V0UmFuZ2VUZXh0JywgZnVuY3Rpb24gaW50ZXJjZXB0b3JJbXBsKC4uLnJlYWxBcmdzKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZWFsQXJncyxcbiAgICAgICAgICAgIHRoZW46ICgpPT57XG4gICAgICAgICAgICAgICAgVUkuc2V0VUlWYWx1ZUNsZWFuKGVsZW1lbnQpO1xuICAgICAgICAgICAgICAgIFVJLnNldFVJU2VsZWN0aW9uQ2xlYW4oZWxlbWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSk7XG59XG5cbmV4cG9ydHMucHJlcGFyZUludGVyY2VwdG9yID0gcHJlcGFyZUludGVyY2VwdG9yO1xuZXhwb3J0cy5wcmVwYXJlUmFuZ2VUZXh0SW50ZXJjZXB0b3IgPSBwcmVwYXJlUmFuZ2VUZXh0SW50ZXJjZXB0b3I7XG5leHBvcnRzLnByZXBhcmVTZWxlY3Rpb25JbnRlcmNlcHRvciA9IHByZXBhcmVTZWxlY3Rpb25JbnRlcmNlcHRvcjtcbmV4cG9ydHMucHJlcGFyZVZhbHVlSW50ZXJjZXB0b3IgPSBwcmVwYXJlVmFsdWVJbnRlcmNlcHRvcjtcbiJdLCJ2ZXJzaW9uIjozfQ==