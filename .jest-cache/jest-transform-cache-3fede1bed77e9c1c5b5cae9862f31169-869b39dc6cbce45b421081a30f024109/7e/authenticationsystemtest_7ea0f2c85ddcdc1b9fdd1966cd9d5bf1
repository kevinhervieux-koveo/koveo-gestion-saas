6f144d62119fad7b9b1f32a5b378de9a
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const db_1 = require("../../server/db");
const schema_1 = require("../../shared/schema");
const drizzle_orm_1 = require("drizzle-orm");
const bcrypt = __importStar(require("bcryptjs"));
/**
 * Authentication System Integration Test
 *
 * This test ensures the authentication system works end-to-end and catches
 * critical issues like:
 * - Missing users in database
 * - Login endpoint failures
 * - Session management problems
 * - Demo user accessibility issues
 */
(0, globals_1.describe)('Authentication System', () => {
    const testUser = {
        username: 'isolated-auth-test',
        email: 'isolated-auth-test@test-only.com',
        password: 'test123',
        firstName: 'Isolated',
        lastName: 'AuthTest',
        role: 'manager',
        language: 'en',
        isActive: true
    };
    (0, globals_1.beforeAll)(async () => {
        // Clean up any existing test user
        await db_1.db.delete(schema_1.users).where((0, drizzle_orm_1.eq)(schema_1.users.email, testUser.email));
        // Create test user with proper bcrypt hash
        const hashedPassword = await bcrypt.hash(testUser.password, 10);
        await db_1.db.insert(schema_1.users).values({
            username: testUser.username,
            email: testUser.email,
            password: hashedPassword,
            firstName: testUser.firstName,
            lastName: testUser.lastName,
            role: testUser.role,
            language: testUser.language,
            isActive: testUser.isActive
        });
    });
    (0, globals_1.afterAll)(async () => {
        // Clean up test user
        await db_1.db.delete(schema_1.users).where((0, drizzle_orm_1.eq)(schema_1.users.email, testUser.email));
    });
    (0, globals_1.describe)('Database User Existence', () => {
        (0, globals_1.it)('should have at least one active user in the database', async () => {
            const userCount = await db_1.db
                .select({ count: (0, drizzle_orm_1.count)() })
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.isActive, true))
                .then(result => result[0]?.count || 0);
            (0, globals_1.expect)(userCount).toBeGreaterThan(0);
        });
        (0, globals_1.it)('should find created test user in database', async () => {
            const user = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.email, testUser.email))
                .then(results => results[0]);
            (0, globals_1.expect)(user).toBeDefined();
            (0, globals_1.expect)(user.email).toBe(testUser.email);
            (0, globals_1.expect)(user.isActive).toBe(true);
            (0, globals_1.expect)(user.role).toBe(testUser.role);
        });
    });
    (0, globals_1.describe)('Authentication Endpoints', () => {
        (0, globals_1.it)('should reject login with invalid credentials', async () => {
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: testUser.email,
                    password: 'wrongpassword'
                })
            });
            (0, globals_1.expect)(response.status).toBe(401);
            const data = await response.json();
            (0, globals_1.expect)(data.code).toBe('INVALID_CREDENTIALS');
        });
        (0, globals_1.it)('should accept login with valid credentials', async () => {
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: testUser.email,
                    password: testUser.password
                })
            });
            (0, globals_1.expect)(response.status).toBe(200);
            const data = await response.json();
            (0, globals_1.expect)(data.message).toBe('Login successful');
            (0, globals_1.expect)(data.user).toBeDefined();
            (0, globals_1.expect)(data.user.email).toBe(testUser.email);
            (0, globals_1.expect)(data.user.password).toBeUndefined(); // Password should not be returned
        });
        (0, globals_1.it)('should handle missing credentials', async () => {
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: testUser.email
                    // Missing password
                })
            });
            (0, globals_1.expect)(response.status).toBe(400);
            const data = await response.json();
            (0, globals_1.expect)(data.code).toBe('MISSING_CREDENTIALS');
        });
        (0, globals_1.it)('should return 401 for user endpoint without authentication', async () => {
            const response = await fetch('http://localhost:5000/api/auth/user');
            (0, globals_1.expect)(response.status).toBe(401);
            const data = await response.json();
            (0, globals_1.expect)(data.code).toBe('NOT_AUTHENTICATED');
        });
    });
    (0, globals_1.describe)('Demo User Issues', () => {
        (0, globals_1.it)('should not have any demo users in database', async () => {
            const demoUsers = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.email, 'demo@koveo.com'));
            (0, globals_1.expect)(demoUsers).toHaveLength(0);
        });
        (0, globals_1.it)('should fail login for non-existent demo users', async () => {
            const demoEmails = [
                'demo@koveo.com',
                'marc.gauthier@demo.com',
                'sophie.tremblay@demo.com'
            ];
            for (const email of demoEmails) {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: 'demo123'
                    })
                });
                (0, globals_1.expect)(response.status).toBe(401);
                const data = await response.json();
                (0, globals_1.expect)(data.code).toBe('INVALID_CREDENTIALS');
            }
        });
    });
    (0, globals_1.describe)('Password Security', () => {
        (0, globals_1.it)('should properly hash passwords', async () => {
            const user = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.email, testUser.email))
                .then(results => results[0]);
            (0, globals_1.expect)(user.password).toBeDefined();
            (0, globals_1.expect)(user.password).not.toBe(testUser.password); // Should be hashed
            (0, globals_1.expect)(user.password.startsWith('$2')).toBe(true); // bcrypt hash format
        });
        (0, globals_1.it)('should verify password correctly', async () => {
            const user = await db_1.db
                .select()
                .from(schema_1.users)
                .where((0, drizzle_orm_1.eq)(schema_1.users.email, testUser.email))
                .then(results => results[0]);
            const isValid = await bcrypt.compare(testUser.password, user.password);
            (0, globals_1.expect)(isValid).toBe(true);
            const isInvalid = await bcrypt.compare('wrongpassword', user.password);
            (0, globals_1.expect)(isInvalid).toBe(false);
        });
    });
    (0, globals_1.describe)('Critical Authentication Issues', () => {
        (0, globals_1.it)('should detect if no users exist in system', async () => {
            const totalUsers = await db_1.db
                .select({ count: (0, drizzle_orm_1.count)() })
                .from(schema_1.users)
                .then(result => result[0]?.count || 0);
            // This test will fail if the database has no users, alerting us to the issue
            (0, globals_1.expect)(totalUsers).toBeGreaterThan(0);
            if (totalUsers === 0) {
                throw new Error('CRITICAL: No users found in database. Authentication system unusable.');
            }
        });
        (0, globals_1.it)('should ensure authentication endpoints are accessible', async () => {
            // Test that endpoints exist and respond (not 404)
            const endpoints = [
                'http://localhost:5000/api/auth/login',
                'http://localhost:5000/api/auth/user'
            ];
            for (const endpoint of endpoints) {
                const response = await fetch(endpoint, {
                    method: endpoint.includes('login') ? 'POST' : 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...(endpoint.includes('login') && {
                        body: JSON.stringify({ email: 'test', password: 'test' })
                    })
                });
                // Should not return 404 (endpoint exists)
                (0, globals_1.expect)(response.status).not.toBe(404);
                // Should return JSON response (API working)
                const contentType = response.headers.get('content-type');
                (0, globals_1.expect)(contentType).toContain('application/json');
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9pbnRlZ3JhdGlvbi9hdXRoZW50aWNhdGlvbi1zeXN0ZW0udGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUEwRTtBQUMxRSx3Q0FBcUM7QUFDckMsZ0RBQTRDO0FBQzVDLDZDQUF3QztBQUN4QyxpREFBbUM7QUFFbkM7Ozs7Ozs7OztHQVNHO0FBRUgsSUFBQSxrQkFBUSxFQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxNQUFNLFFBQVEsR0FBRztRQUNmLFFBQVEsRUFBRSxvQkFBb0I7UUFDOUIsS0FBSyxFQUFFLGtDQUFrQztRQUN6QyxRQUFRLEVBQUUsU0FBUztRQUNuQixTQUFTLEVBQUUsVUFBVTtRQUNyQixRQUFRLEVBQUUsVUFBVTtRQUNwQixJQUFJLEVBQUUsU0FBa0I7UUFDeEIsUUFBUSxFQUFFLElBQUk7UUFDZCxRQUFRLEVBQUUsSUFBSTtLQUNmLENBQUM7SUFFRixJQUFBLG1CQUFTLEVBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsa0NBQWtDO1FBQ2xDLE1BQU0sT0FBRSxDQUFDLE1BQU0sQ0FBQyxjQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBQSxnQkFBRSxFQUFDLGNBQUssQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFOUQsMkNBQTJDO1FBQzNDLE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sT0FBRSxDQUFDLE1BQU0sQ0FBQyxjQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDNUIsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRO1lBQzNCLEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSztZQUNyQixRQUFRLEVBQUUsY0FBYztZQUN4QixTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVM7WUFDN0IsUUFB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Q2pDLE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLFFBQVEsRUFBRTtvQkFDckMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSztvQkFDbkQsT0FBTyxFQUFFO3dCQUNQLGNBQWMsRUFBRSxrQkFBa0I7cUJBQ25DO29CQUNELEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJO3dCQUNoQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDO3FCQUMxRCxDQUFDO2lCQUNILENBQUMsQ0FBQztnQkFFSCwwQ0FBMEM7Z0JBQzFDLElBQUEsZ0JBQU0sRUFBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFdEMsNENBQTRDO2dCQUM1QyxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDekQsSUFBQSxnQkFBTSxFQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ3BELENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS90ZXN0cy9pbnRlZ3JhdGlvbi9hdXRoZW50aWNhdGlvbi1zeXN0ZW0udGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCwgYmVmb3JlQWxsLCBhZnRlckFsbCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHsgZGIgfSBmcm9tICcuLi8uLi9zZXJ2ZXIvZGInO1xuaW1wb3J0IHsgdXNlcnMgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2NoZW1hJztcbmltcG9ydCB7IGVxLCBjb3VudCB9IGZyb20gJ2RyaXp6bGUtb3JtJztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XG5cbi8qKlxuICogQXV0aGVudGljYXRpb24gU3lzdGVtIEludGVncmF0aW9uIFRlc3RcbiAqIFxuICogVGhpcyB0ZXN0IGVuc3VyZXMgdGhlIGF1dGhlbnRpY2F0aW9uIHN5c3RlbSB3b3JrcyBlbmQtdG8tZW5kIGFuZCBjYXRjaGVzXG4gKiBjcml0aWNhbCBpc3N1ZXMgbGlrZTpcbiAqIC0gTWlzc2luZyB1c2VycyBpbiBkYXRhYmFzZSAgXG4gKiAtIExvZ2luIGVuZHBvaW50IGZhaWx1cmVzXG4gKiAtIFNlc3Npb24gbWFuYWdlbWVudCBwcm9ibGVtc1xuICogLSBEZW1vIHVzZXIgYWNjZXNzaWJpbGl0eSBpc3N1ZXNcbiAqL1xuXG5kZXNjcmliZSgnQXV0aGVudGljYXRpb24gU3lzdGVtJywgKCkgPT4ge1xuICBjb25zdCB0ZXN0VXNlciA9IHtcbiAgICB1c2VybmFtZTogJ2lzb2xhdGVkLWF1dGgtdGVzdCcsXG4gICAgZW1haWw6ICdpc29sYXRlZC1hdXRoLXRlc3RAdGVzdC1vbmx5LmNvbScsXG4gICAgcGFzc3dvcmQ6ICd0ZXN0MTIzJyxcbiAgICBmaXJzdE5hbWU6ICdJc29sYXRlZCcsXG4gICAgbGFzdE5hbWU6ICdBdXRoVGVzdCcsXG4gICAgcm9sZTogJ21hbmFnZXInIGFzIGNvbnN0LFxuICAgIGxhbmd1YWdlOiAnZW4nLFxuICAgIGlzQWN0aXZlOiB0cnVlXG4gIH07XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhbiB1cCBhbnkgZXhpc3RpbmcgdGVzdCB1c2VyXG4gICAgYXdhaXQgZGIuZGVsZXRlKHVzZXJzKS53aGVyZShlcSh1c2Vycy5lbWFpbCwgdGVzdFVzZXIuZW1haWwpKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCB1c2VyIHdpdGggcHJvcGVyIGJjcnlwdCBoYXNoXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaCh0ZXN0VXNlci5wYXNzd29yZCwgMTApO1xuICAgIFxuICAgIGF3YWl0IGRiLmluc2VydCh1c2VycykudmFsdWVzKHtcbiAgICAgIHVzZXJuYW1lOiB0ZXN0VXNlci51c2VybmFtZSxcbiAgICAgIGVtYWlsOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgIGZpcnN0TmFtZTogdGVzdFVzZXIuZmlyc3ROYW1lLFxuICAgICAgbGFzdE5hbWU6IHRlc3RVc2VyLmxhc3ROYW1lLFxuICAgICAgcm9sZTogdGVzdFVzZXIucm9sZSxcbiAgICAgIGxhbmd1YWdlOiB0ZXN0VXNlci5sYW5ndWFnZSxcbiAgICAgIGlzQWN0aXZlOiB0ZXN0VXNlci5pc0FjdGl2ZVxuICAgIH0pO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ2xlYW4gdXAgdGVzdCB1c2VyXG4gICAgYXdhaXQgZGIuZGVsZXRlKHVzZXJzKS53aGVyZShlcSh1c2Vycy5lbWFpbCwgdGVzdFVzZXIuZW1haWwpKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0RhdGFiYXNlIFVzZXIgRXhpc3RlbmNlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGF2ZSBhdCBsZWFzdCBvbmUgYWN0aXZlIHVzZXIgaW4gdGhlIGRhdGFiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlckNvdW50ID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCh7IGNvdW50OiBjb3VudCgpIH0pXG4gICAgICAgIC5mcm9tKHVzZXJzKVxuICAgICAgICAud2hlcmUoZXEodXNlcnMuaXNBY3RpdmUsIHRydWUpKVxuICAgICAgICAudGhlbihyZXN1bHQgPT4gcmVzdWx0WzBdPy5jb3VudCB8fCAwKTtcblxuICAgICAgZXhwZWN0KHVzZXJDb3VudCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmaW5kIGNyZWF0ZWQgdGVzdCB1c2VyIGluIGRhdGFiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbSh1c2VycylcbiAgICAgICAgLndoZXJlKGVxKHVzZXJzLmVtYWlsLCB0ZXN0VXNlci5lbWFpbCkpXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4gcmVzdWx0c1swXSk7XG5cbiAgICAgIGV4cGVjdCh1c2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVzZXIuZW1haWwpLnRvQmUodGVzdFVzZXIuZW1haWwpO1xuICAgICAgZXhwZWN0KHVzZXIuaXNBY3RpdmUpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QodXNlci5yb2xlKS50b0JlKHRlc3RVc2VyLnJvbGUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQXV0aGVudGljYXRpb24gRW5kcG9pbnRzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVqZWN0IGxvZ2luIHdpdGggaW52YWxpZCBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJ2h0dHA6Ly9sb2NhbGhvc3Q6NTAwMC9hcGkvYXV0aC9sb2dpbicsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZW1haWw6IHRlc3RVc2VyLmVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiAnd3JvbmdwYXNzd29yZCdcbiAgICAgICAgfSlcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICBleHBlY3QoZGF0YS5jb2RlKS50b0JlKCdJTlZBTElEX0NSRURFTlRJQUxTJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFjY2VwdCBsb2dpbiB3aXRoIHZhbGlkIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS9hdXRoL2xvZ2luJywge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6IHRlc3RVc2VyLnBhc3N3b3JkXG4gICAgICAgIH0pXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgZXhwZWN0KGRhdGEubWVzc2FnZSkudG9CZSgnTG9naW4gc3VjY2Vzc2Z1bCcpO1xuICAgICAgZXhwZWN0KGRhdGEudXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChkYXRhLnVzZXIuZW1haWwpLnRvQmUodGVzdFVzZXIuZW1haWwpO1xuICAgICAgZXhwZWN0KGRhdGEudXNlci5wYXNzd29yZCkudG9CZVVuZGVmaW5lZCgpOyAvLyBQYXNzd29yZCBzaG91bGQgbm90IGJlIHJldHVybmVkXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS9hdXRoL2xvZ2luJywge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBlbWFpbDogdGVzdFVzZXIuZW1haWxcbiAgICAgICAgICAvLyBNaXNzaW5nIHBhc3N3b3JkXG4gICAgICAgIH0pXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSg0MDApO1xuICAgICAgXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgZXhwZWN0KGRhdGEuY29kZSkudG9CZSgnTUlTU0lOR19DUkVERU5USUFMUycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIGZvciB1c2VyIGVuZHBvaW50IHdpdGhvdXQgYXV0aGVudGljYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL2F1dGgvdXNlcicpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICBleHBlY3QoZGF0YS5jb2RlKS50b0JlKCdOT1RfQVVUSEVOVElDQVRFRCcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGVtbyBVc2VyIElzc3VlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIG5vdCBoYXZlIGFueSBkZW1vIHVzZXJzIGluIGRhdGFiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGVtb1VzZXJzID0gYXdhaXQgZGJcbiAgICAgICAgLnNlbGVjdCgpXG4gICAgICAgIC5mcm9tKHVzZXJzKVxuICAgICAgICAud2hlcmUoZXEodXNlcnMuZW1haWwsICdkZW1vQGtvdmVvLmNvbScpKTtcblxuICAgICAgZXhwZWN0KGRlbW9Vc2VycykudG9IYXZlTGVuZ3RoKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWlsIGxvZ2luIGZvciBub24tZXhpc3RlbnQgZGVtbyB1c2VycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRlbW9FbWFpbHMgPSBbXG4gICAgICAgICdkZW1vQGtvdmVvLmNvbScsXG4gICAgICAgICdtYXJjLmdhdXRoaWVyQGRlbW8uY29tJywgXG4gICAgICAgICdzb3BoaWUudHJlbWJsYXlAZGVtby5jb20nXG4gICAgICBdO1xuXG4gICAgICBmb3IgKGNvbnN0IGVtYWlsIG9mIGRlbW9FbWFpbHMpIHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS9hdXRoL2xvZ2luJywge1xuICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBlbWFpbDogZW1haWwsXG4gICAgICAgICAgICBwYXNzd29yZDogJ2RlbW8xMjMnXG4gICAgICAgICAgfSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9CZSg0MDEpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgZXhwZWN0KGRhdGEuY29kZSkudG9CZSgnSU5WQUxJRF9DUkVERU5USUFMUycpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUGFzc3dvcmQgU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBwcm9wZXJseSBoYXNoIHBhc3N3b3JkcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KClcbiAgICAgICAgLmZyb20odXNlcnMpXG4gICAgICAgIC53aGVyZShlcSh1c2Vycy5lbWFpbCwgdGVzdFVzZXIuZW1haWwpKVxuICAgICAgICAudGhlbihyZXN1bHRzID0+IHJlc3VsdHNbMF0pO1xuXG4gICAgICBleHBlY3QodXNlci5wYXNzd29yZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyLnBhc3N3b3JkKS5ub3QudG9CZSh0ZXN0VXNlci5wYXNzd29yZCk7IC8vIFNob3VsZCBiZSBoYXNoZWRcbiAgICAgIGV4cGVjdCh1c2VyLnBhc3N3b3JkLnN0YXJ0c1dpdGgoJyQyJykpLnRvQmUodHJ1ZSk7IC8vIGJjcnlwdCBoYXNoIGZvcm1hdFxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2ZXJpZnkgcGFzc3dvcmQgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGRiXG4gICAgICAgIC5zZWxlY3QoKVxuICAgICAgICAuZnJvbSh1c2VycylcbiAgICAgICAgLndoZXJlKGVxKHVzZXJzLmVtYWlsLCB0ZXN0VXNlci5lbWFpbCkpXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4gcmVzdWx0c1swXSk7XG5cbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZSh0ZXN0VXNlci5wYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XG4gICAgICBleHBlY3QoaXNWYWxpZCkudG9CZSh0cnVlKTtcblxuICAgICAgY29uc3QgaXNJbnZhbGlkID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUoJ3dyb25ncGFzc3dvcmQnLCB1c2VyLnBhc3N3b3JkKTtcbiAgICAgIGV4cGVjdChpc0ludmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ3JpdGljYWwgQXV0aGVudGljYXRpb24gSXNzdWVzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGV0ZWN0IGlmIG5vIHVzZXJzIGV4aXN0IGluIHN5c3RlbScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRvdGFsVXNlcnMgPSBhd2FpdCBkYlxuICAgICAgICAuc2VsZWN0KHsgY291bnQ6IGNvdW50KCkgfSlcbiAgICAgICAgLmZyb20odXNlcnMpXG4gICAgICAgIC50aGVuKHJlc3VsdCA9PiByZXN1bHRbMF0/LmNvdW50IHx8IDApO1xuXG4gICAgICAvLyBUaGlzIHRlc3Qgd2lsbCBmYWlsIGlmIHRoZSBkYXRhYmFzZSBoYXMgbm8gdXNlcnMsIGFsZXJ0aW5nIHVzIHRvIHRoZSBpc3N1ZVxuICAgICAgZXhwZWN0KHRvdGFsVXNlcnMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIFxuICAgICAgaWYgKHRvdGFsVXNlcnMgPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDUklUSUNBTDogTm8gdXNlcnMgZm91bmQgaW4gZGF0YWJhc2UuIEF1dGhlbnRpY2F0aW9uIHN5c3RlbSB1bnVzYWJsZS4nKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZW5zdXJlIGF1dGhlbnRpY2F0aW9uIGVuZHBvaW50cyBhcmUgYWNjZXNzaWJsZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFRlc3QgdGhhdCBlbmRwb2ludHMgZXhpc3QgYW5kIHJlc3BvbmQgKG5vdCA0MDQpXG4gICAgICBjb25zdCBlbmRwb2ludHMgPSBbXG4gICAgICAgICdodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL2F1dGgvbG9naW4nLFxuICAgICAgICAnaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS9hdXRoL3VzZXInXG4gICAgICBdO1xuXG4gICAgICBmb3IgKGNvbnN0IGVuZHBvaW50IG9mIGVuZHBvaW50cykge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGVuZHBvaW50LCB7XG4gICAgICAgICAgbWV0aG9kOiBlbmRwb2ludC5pbmNsdWRlcygnbG9naW4nKSA/ICdQT1NUJyA6ICdHRVQnLFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICAuLi4oZW5kcG9pbnQuaW5jbHVkZXMoJ2xvZ2luJykgJiYge1xuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlbWFpbDogJ3Rlc3QnLCBwYXNzd29yZDogJ3Rlc3QnIH0pXG4gICAgICAgICAgfSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2hvdWxkIG5vdCByZXR1cm4gNDA0IChlbmRwb2ludCBleGlzdHMpXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLm5vdC50b0JlKDQwNCk7XG4gICAgICAgIFxuICAgICAgICAvLyBTaG91bGQgcmV0dXJuIEpTT04gcmVzcG9uc2UgKEFQSSB3b3JraW5nKVxuICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKTtcbiAgICAgICAgZXhwZWN0KGNvbnRlbnRUeXBlKS50b0NvbnRhaW4oJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=